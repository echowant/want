<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Camel</title>
    <url>/want/2021/04/28/Camel/</url>
    <content><![CDATA[<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>【功能】Camel框架的核心是一个<strong>路由引擎构建器</strong>，允许用户定义自己的路由规则，决定从哪个源接收消息，并确定如何处理这些消息并将其发送到其他目标。</p>
<ol>
<li><p>分发到多个目的地</p>
</li>
<li><p>对消息包装</p>
</li>
<li><p>消息去重</p>
</li>
</ol>
<p>【使用建议】Beans是Camel世界的一等公民，用户最好使用Beans，这样用户可以继承Camel内建的功能并自定义。<br>【语法支持】支持Java、XML、Scala、Groovy。<br>【消息格式】Camel没有规定消息格式，不管系统使用的协议或数据类型如何，都可以使用相同的API与各种系统进行交互；Camel内置了很多类型转换器，并且可以自动转换，Camel支持80多种协议和数据类型。<br>【扩展组件】Camel的架构设计就采用了模块化和组件化的思想，因此添加第三方扩展组件以及自定义组件都很容易，此外Camel的组件库也很丰富。</p>
<p><strong>什么是路由？</strong></p>
<p>路由就是将消息从输入队列中取出，并根据一组预设的条件，发送到多个输出队列中的过程。</p>
<p>由于路由的存在，输入和输出队列并不知道消息传递的条件，是故，输入消息传递的逻辑与消息的生产者和消费者之间是解耦的。</p>
<pre class="mermaid">graph LR

A(输入队列) --> B[消息路由] --> C(输出队列1)
B --> C1(输出队列2)
B --> C2(输出队列3)
B --> Cn(输出队列n)

style B fill:greenyellow</pre>

<p><strong>什么是JMS？</strong></p>
<h3 id="功能示例"><a href="#功能示例" class="headerlink" title="功能示例"></a>功能示例</h3><p>端点URI：可以标识出①想要使用的组件，比如file组件，和②对该组件的相关配置，③可以决定将该组件作为消息生产者，还是作为消息消费者。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from(&quot;file://inputdir/?delete=true&quot;).to(&quot;file://outputdir&quot;)</span><br></pre></td></tr></table></figure>
<h4 id="file端点：监听目录"><a href="#file端点：监听目录" class="headerlink" title="file端点：监听目录"></a>file端点：监听目录</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileCopierWithCamel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// create CamelContext</span></span><br><span class="line">        CamelContext context = <span class="keyword">new</span> DefaultCamelContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add our route to the CamelContext</span></span><br><span class="line">        context.addRoutes(<span class="keyword">new</span> RouteBuilder() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                  file: 表示使用文件Component</span></span><br><span class="line"><span class="comment">                  from 表示从哪里获取数据，进行消费</span></span><br><span class="line"><span class="comment">                  to  表示将数据生产到哪里</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                from(<span class="string">"file:data/inbox?noop=true"</span>).to(<span class="string">"file:data/outbox"</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果有文件删除，就复制一份到目标目录</span></span><br><span class="line">                from(<span class="string">"file://inputdir/?delete=true"</span>).to(<span class="string">"file://outputdir"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start the route and let it do its work</span></span><br><span class="line">        context.start();</span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// stop the CamelContext</span></span><br><span class="line">        context.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="FTP组件"><a href="#FTP组件" class="headerlink" title="FTP组件"></a>FTP组件</h4><p>FTP组件并不在camel-core模块内，所以添加一个额外的依赖。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.camel&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;camel-ftp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>从FTP上下载数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from(&quot;ftp://rider.com/orders?username=rider&amp;password=secret&quot;)</span><br></pre></td></tr></table></figure>
<p>发送到JMS：</p>
<h4 id="队列消息转发"><a href="#队列消息转发" class="headerlink" title="队列消息转发"></a>队列消息转发</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 从一个消息队列分发到另外三个消息队列</span></span><br><span class="line">from(<span class="string">"jms:queue:"</span> + Destination.TASK_FINISH_PUBLISH)</span><br><span class="line">    .to(</span><br><span class="line">        <span class="string">"jms:queue:"</span> + Destination.CONSUMER_TASK_TASK_FINISH,</span><br><span class="line">        <span class="string">"jms:queue:"</span> + Destination.CONSUMER_GROWTH_TASK_FINISH,</span><br><span class="line">        <span class="string">"jms:queue:"</span> + Destination.CONSUMER_APPINFO_TASK_FINISH</span><br><span class="line">    );</span><br></pre></td></tr></table></figure>
<h3 id="消息去重"><a href="#消息去重" class="headerlink" title="消息去重"></a>消息去重</h3><h4 id="幂等消息消费者"><a href="#幂等消息消费者" class="headerlink" title="幂等消息消费者"></a>幂等消息消费者</h4><p>服务器 =&gt; 客户端, 发送了重复的消息<br>客户端针对同一消息，不论收到几次，都只处理一次。</p>
<p>那么这个客户端就是<strong>幂等消息消费者</strong>。</p>
<p>幂等消息消费者（Idempotent Consumer）对于重复消息的处理应该有幂等的结果。</p>
<h4 id="IdempotentConsumer类"><a href="#IdempotentConsumer类" class="headerlink" title="IdempotentConsumer类"></a>IdempotentConsumer类</h4><p>针对幂等消费者的问题，Apache Camel提供了IdempotentConsumer类作为解决方案。</p>
<p>IdempotentConsumer类的构造方法包括：</p>
<ol>
<li>messageIdExpression：一个消息ID表达式。唯一，用来标识消息身份。</li>
<li>idempotentRepository：一个用来存储消息ID的存储方式（redis,jpa等）。指定如何存储这些消息ID。<ul>
<li>MemoryIdempotentRepository 基于内存</li>
<li>RedisStringIdempotentRepository 基于Redis</li>
<li>JpaMessageIdRepository 基于Jpa</li>
<li>JdbcMessageIdRepository 基于Jdbc</li>
</ul>
</li>
</ol>
<p>工作原理：</p>
<ol>
<li>如果消息ID在存储IdempotentRepository中不存在，则把消息存储到IdempotentRepository中，并且处理消息。如果消息处理失败，再从IdempotentRepository移除。</li>
<li>如果消息ID已经存在，则默认IdempotentCusumer会丢弃重复消息，当然Camel也允许我们自定义如何处理重复消息。</li>
</ol>
<p>IdempotentConsumer类的构造方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IdempotentConsumerDefinition <span class="title">idempotentConsumer</span><span class="params">(Expression messageIdExpression, IdempotentRepository&lt;?&gt; idempotentRepository)</span> </span>&#123;</span><br><span class="line">        IdempotentConsumerDefinition answer = <span class="keyword">new</span> IdempotentConsumerDefinition(messageIdExpression, idempotentRepository);</span><br><span class="line">        addOutput(answer);</span><br><span class="line">        <span class="keyword">return</span> answer;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>RedisStringIdempotentRepository去重示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Camel路由配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CamelConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">RouteBuilder <span class="title">myRouter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RouteBuilder() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 使用idempotent和camel-redis组件进行去重</span></span><br><span class="line">                <span class="comment">// 设置处理进程名为camel-idem</span></span><br><span class="line">                RedisStringIdempotentRepository idempotentRepo = <span class="keyword">new</span> RedisStringIdempotentRepository(redisTemplate, <span class="string">"camel-idem"</span>);</span><br><span class="line">                <span class="comment">// 设置超时为20秒</span></span><br><span class="line">                idempotentRepo.setExpiry(<span class="number">20</span>);</span><br><span class="line">                <span class="comment">// 根据taskId和tdrId去重</span></span><br><span class="line">                <span class="comment">// 将unique头设置为FINISH+taskId的值+tdrId的值</span></span><br><span class="line">                <span class="comment">// 将unique头作为Message ID进行去重</span></span><br><span class="line">                from(<span class="string">"jms:queue:"</span> + Destination.TASK_FINISH_PUBLISH)</span><br><span class="line">                        .setHeader(<span class="string">"unique"</span>)</span><br><span class="line">                        .simple(<span class="string">"FINISH$&#123;body[taskId]&#125;$&#123;body[tdrId]&#125;"</span>)</span><br><span class="line">                        .idempotentConsumer(header(<span class="string">"unique"</span>), idempotentRepo)</span><br><span class="line">                        .to(</span><br><span class="line">                                <span class="string">"jms:queue:"</span> + Destination.CONSUMER_TASK_TASK_FINISH,</span><br><span class="line">                                <span class="string">"jms:queue:"</span> + Destination.CONSUMER_GROWTH_TASK_FINISH,</span><br><span class="line">                                <span class="string">"jms:queue:"</span> + Destination.CONSUMER_APPINFO_TASK_FINISH</span><br><span class="line">                        );</span><br><span class="line">                <span class="comment">// 根据taskId去重</span></span><br><span class="line">                from(<span class="string">"jms:queue:"</span> + Destination.TASK_UNDELIVER_PUBLISH)</span><br><span class="line">                        .setHeader(<span class="string">"unique"</span>)</span><br><span class="line">                        .simple(<span class="string">"UNDELIVER$&#123;body[taskId]&#125;"</span>)</span><br><span class="line">                        .idempotentConsumer(header(<span class="string">"unique"</span>), idempotentRepo)</span><br><span class="line">                        .to(</span><br><span class="line">                                <span class="string">"jms:queue:"</span> + Destination.CONSUMER_TASK_TASK_UNDELIVER,</span><br><span class="line">                                <span class="string">"jms:queue:"</span> + Destination.CONSUMER_GROWTH_TASK_UNDELIVER</span><br><span class="line">                        );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>DNS</title>
    <url>/want/2021/07/30/DNS/</url>
    <content><![CDATA[<p>### </p>
<table>
<thead>
<tr>
<th>适用</th>
<th>服务</th>
<th>特点</th>
<th>语言</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>Dnsmasq</td>
<td>经常<a href="https://xz.aliyun.com/t/9107" target="_blank" rel="noopener">安全漏洞</a>。轻量级、易于配置的 DNS 转发器，旨在为小型网络提供 DNS。It can serve the names of <strong>local machines</strong> which are not in the <strong>global DNS</strong>。</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>CoreDNS</td>
<td>很方便地给它编写插件以提供新功能。CoreDNS 是 Kubernetes 推荐的 DNS 服务器。</td>
<td>go</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Powerdns</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>开源</td>
<td>BIND</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>BIG-IP DNS</td>
<td>F5公司，Authoritative、Recursive、security / support DNS and application acceleration</td>
<td></td>
<td></td>
</tr>
<tr>
<td>商用</td>
<td>CNR（Cisco Network Registrar）</td>
<td>a commercial DNS server from Cisco Systems / supports high rates of dynamic update.</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ol>
<li>权威服务器<strong>Authoritative server</strong>：<ul>
<li>Authoritative name servers can be master servers, contain the original set of data</li>
<li>can be <em>secondary</em> or <em>slave name servers</em>, containing data copies usually obtained from synchronization directly with the master server</li>
</ul>
</li>
<li>递归服务器<strong>Recursive server</strong>：<ul>
<li>sometimes called “DNS caches”, “caching-only name servers”</li>
<li>cache the result to answer potential future queries within a certain expiration (<a href="https://en.wikipedia.org/wiki/Time_to_live" target="_blank" rel="noopener">time-to-live</a>) </li>
<li>every request that you do, passes through a DNS query.</li>
<li>It first goes to your internet provider’s recursive DNS server. If it can’t find in the cache, the information needed, it will continue to other recursive servers until it gets to an authoritative DNS server who can give the IP address of the required domain.</li>
<li>Basically, it is a name server, that is a <strong>middle-man</strong> between the user, and the authoritative DNS server.</li>
</ul>
</li>
</ol>
<p><img src="https://ns1.com/writable/articles/authoritativednstransaction.png" alt="查看源图像"></p>
<p>架构：</p>
<p>一台powerdns作为主dns。 多台CoreDNS作为辅助dns</p>
<p><a href="https://en.wikipedia.org/wiki/Comparison_of_DNS_server_software" target="_blank" rel="noopener">Comparison of DNS server software - Wikipedia</a></p>
]]></content>
  </entry>
  <entry>
    <title>DOM监听</title>
    <url>/want/2019/08/02/DOM%E7%9B%91%E5%90%AC/</url>
    <content><![CDATA[<p>resize事件只能加在window对象上，并不能监听具体某个DOM元素。</p>
<h3 id="MutationObserver"><a href="#MutationObserver" class="headerlink" title="MutationObserver"></a>MutationObserver</h3><p>监听DOM变动<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observeCHeader</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> url = <span class="built_in">window</span>.location.href;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> MutationObserver = <span class="built_in">window</span>.MutationObserver || <span class="built_in">window</span>.WebKitMutationObserver || <span class="built_in">window</span>.MozMutationObserver;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cheaderId = url.split(<span class="string">'cheaderId='</span>)[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (cheaderId) &#123;</span><br><span class="line">  		<span class="keyword">const</span> id =  cheaderId.split(<span class="string">'#'</span>)[<span class="number">0</span>];</span><br><span class="line">  		<span class="keyword">const</span> dom = <span class="built_in">document</span>.getElementById(id);</span><br><span class="line">  		<span class="keyword">if</span>(dom) &#123;</span><br><span class="line">    		dom.classList.add(<span class="string">'active'</span>);</span><br><span class="line">  		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  observer.observe(<span class="built_in">document</span>.querySelector(<span class="string">'#header_nav'</span>), &#123;</span><br><span class="line">    childList: <span class="literal">true</span>,</span><br><span class="line">    attributes: <span class="literal">true</span>,</span><br><span class="line">	characterData: <span class="literal">true</span>,</span><br><span class="line">	subtree: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="借助window-与-getBoundingClientRect"><a href="#借助window-与-getBoundingClientRect" class="headerlink" title="借助window 与 getBoundingClientRect"></a>借助window 与 getBoundingClientRect</h3><p>监听点击事件,点击之后打开。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 点击出现弹出框，此处最好使用mousedown而非click</span></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'mousedown'</span>, <span class="keyword">this</span>.close);</span><br></pre></td></tr></table></figure>
<p>监听鼠标离开DOM</p>
<img src="/want/2019/08/02/DOM监听/siderbar.gif" title="siderbar">
<ol>
<li>点击按钮，出现SiderBar(一个div)</li>
<li>鼠标在SiderBar（div）做操作。</li>
<li>当鼠标离开SiderBar(div)时，SiderBar应该消失。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class SideBar extends React.Component &#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    window.addEventListener(&apos;mousemove&apos;, this.close);</span><br><span class="line">  &#125;</span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    window.removeEventListener(&apos;mousemove&apos;, this.close);</span><br><span class="line">  &#125;</span><br><span class="line">  close = (e) =&gt; &#123;</span><br><span class="line">    if (this.props.isOpen) &#123;</span><br><span class="line">      const box = this.panel;</span><br><span class="line">      if (box) &#123;</span><br><span class="line">        const boxBoundary = box.getBoundingClientRect();</span><br><span class="line">        const x = e.pageX;</span><br><span class="line">        const y = e.pageY;</span><br><span class="line">        const &#123;</span><br><span class="line">          left, right, top, bottom,</span><br><span class="line">        &#125; = boxBoundary;</span><br><span class="line">        const inBox = (</span><br><span class="line">          x &gt; left &amp;&amp;</span><br><span class="line">          x &lt;= right &amp;&amp;</span><br><span class="line">          y &gt;= top &amp;&amp;</span><br><span class="line">          y &lt;= bottom</span><br><span class="line">        );</span><br><span class="line">        if (!inBox) &#123;</span><br><span class="line">          this.props.onLeave();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; isOpen &#125; = this.props;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div</span><br><span class="line">        ref=&#123;(div) =&gt; &#123; this.panel = div; &#125;&#125;</span><br><span class="line">        className=&#123;`side-bar $&#123;isOpen ? &apos;show&apos; : &apos;hide&apos;&#125;`&#125;</span><br><span class="line">      &gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">export default SideBar;</span><br></pre></td></tr></table></figure>
<h3 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://libin1991.github.io/2019/01/01/JS%E7%9B%91%E5%90%ACdiv%E5%85%83%E7%B4%A0%E7%9A%84resize/" target="_blank" rel="noopener">JS监听div元素的resize</a></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>ElasticStack</title>
    <url>/want/2021/04/28/ElasticStack/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>随着系统产生的日志数量不断增加，大量的日志不再适合人工阅读或查看，因此，往往采用一些技术对已有日志进行分析整理，以图表或者其他易于阅读的方式将日志信息展示出来。</p>
<p>Elastic Stack是Elastic公司的一套开源项目，这套技术栈也被广泛的称为ELK。包括elasicsearch，logstash，kibana。其主要功能就是对数据进行收集，格式化，索引，分析和可视化。具有搭建简单，配置容易等优点。</p>
<p>ELK：对于分析日志而言，一般分为三个步骤；日志收集Logstash，日志整理存储Elasticsearch，数据展示Kibana。</p>
<p>E、L、K三者都可以单独使用。</p>
<pre class="mermaid">graph TB
    L(Logstash日志收集)-->E[Elasticsearch日志整理存储] --> K(Kibana数据展示)</pre>



<h3 id="Logstash日志收集"><a href="#Logstash日志收集" class="headerlink" title="Logstash日志收集"></a>Logstash日志收集</h3><p>Logstash是一个插件化的日志收集系统，现已包含200+plugin可用，并且可以轻松自定义插件。</p>
<p>input、output、filter是最常用的三个插件，用来配置输入输出目标与过滤处理。</p>
<p>用过Linux的人应该对管道操作符‘|’很熟悉，Logstash就像是一个管道操作符，他对事件、消息、或者任何感兴趣的东西进行收集、处理、分发。就像管道中的水流入流出。</p>
<p>先是使用一层多个Logstash实例进行收集并汇总到消息队列，再使用一层Logstash实例从消息队列中获取、处理然后存储到分布式的Elasticsearch中。</p>
<h3 id="Elasticsearch-ES-日志整理存储"><a href="#Elasticsearch-ES-日志整理存储" class="headerlink" title="Elasticsearch(ES)日志整理存储"></a>Elasticsearch(ES)日志整理存储</h3><p>Elasticsearch是一个基于Apache Lucene的开源搜索引擎。Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p>
<p>同时，ES具有与生俱来的分布式支持。</p>
<blockquote>
<p>• 分布式的实时文件存储，每个字段都被索引并可被搜索<br>• 分布式的实时分析搜索引擎<br>• 可以扩展到上百台服务器，处理PB级结构化或非结构化数据<br>——《Elasticsearch权威指南》</p>
</blockquote>
<p>在ELK中，ES的角色就是存储并提供搜索功能以便更好的进行日志分析。</p>
<h3 id="Kibana数据展示"><a href="#Kibana数据展示" class="headerlink" title="Kibana数据展示"></a>Kibana数据展示</h3><p>Logstash收集后的数据都已经存放到了ES中，作为日志分析一条龙服务，现在就差数据展示（可视化）了。Kibana的前身就是专门设计用来查看ES中数据的，因此Kibana与ES的配合十分简单流畅。Kibana不要求与ES部署在同一台机器上，可以通过ES的Restful API查询数据。可以通过配置文件将一个ES集群配置给Kibana进行查询，并且Kibana支持常用图表的生成，可以通过自定义查询、横纵坐标含义等方式展示信息，拥有良好的数据展示能力与自定义能力。</p>
<p><a href="http://kibana.logstash.es/content/" target="_blank" rel="noopener">http://kibana.logstash.es/content/</a></p>
]]></content>
  </entry>
  <entry>
    <title>IDE</title>
    <url>/want/2019/04/24/IDE/</url>
    <content><![CDATA[<h3 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h3><p>Ctrl + Shift + F<br>Ctrl + `<br>Ctrl + T<br>Ctrl + Backspace    删除一个单词</p>
<p>Shift + Alt + 箭头<br>Alt + 箭头<br>Ctrl + Alt +箭头<br>Ctrl + Shift +箭头</p>
<p>Ctrl + Home<br>Ctrl + X<br>Ctrl + Shift + K<br>Ctrl + F2    批量替换当前文件中所有匹配的文本</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAxODE2MjM1MA==&amp;mid=2651556825&amp;idx=2&amp;sn=35bfd269f4726997b0ac9e272279cf93&amp;chksm=80255c18b752d50ea50462816e8041fba43462107ccb61d526d6108aa9ff96bed87d6fba97d0&amp;scene=0&amp;xtrack=1&amp;key=5e7b3122d30105cbfde06017e1521c23639c28e41a1bd4d19cbea060c806009df93842d2b5f22479ece6635ca83888e51da6dd0caa46b8242251c327c124205b0ecfc566425d5fa7859098f31a8751a8&amp;ascene=1&amp;uin=Mjk4MDg1NTEwMQ%3D%3D&amp;devicetype=Windows+10&amp;version=62060834&amp;lang=zh_CN&amp;pass_ticket=Gy1%2BHUsMjKzWq2zooUV408%2FFI9mydLuVi31BwxfKqE5Q3uCgYPByH1YHrgsKw0jj&amp;winzoom=1" target="_blank" rel="noopener">21 个VSCode 快捷键，让代码更快，更有趣</a></p>
<h3 id="IntelliJ-IDEA"><a href="#IntelliJ-IDEA" class="headerlink" title="IntelliJ IDEA"></a>IntelliJ IDEA</h3><h4 id="IDEA-排除某文件夹让其不构建索引-index"><a href="#IDEA-排除某文件夹让其不构建索引-index" class="headerlink" title="IDEA 排除某文件夹让其不构建索引 index"></a>IDEA 排除某文件夹让其不构建索引 index</h4><p>idea只要有文件变动，都会构建索引，在前后端不分离的项目中，static前端静态包改变，也会引起index。排除index的方法：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">文件夹 右键 Mark Directory as -&gt; Excluded</span><br><span class="line"></span><br><span class="line">注意：运行 springboot debug ，此文件夹的文件会 404</span><br></pre></td></tr></table></figure></p>
]]></content>
  </entry>
  <entry>
    <title>React前端开发前的规划图</title>
    <url>/want/2018/09/29/React%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E5%89%8D%E7%9A%84%E8%A7%84%E5%88%92/</url>
    <content><![CDATA[<h3 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h3><p><strong>目的</strong>： 梳理思路，指导coding<br><strong>工具</strong>： 思维导图，如XMind<br><strong>元素</strong>：</p>
<ol>
<li>功能模块： 按页面划分模块，区分个性和公用。</li>
<li>操作事件： 按功能模块归纳事件</li>
<li>方法：操作事件触发的方法，主要指接口调用方法，如ajax，fetch等</li>
<li>数据：包括state和props两种<ul>
<li>state：源自于前端的数据，通常用做接口方法的参数，可前端自用</li>
<li>props：源自于后端的数据，回显到前端</li>
</ul>
</li>
<li>映射表：一个常量，通常指枚举类映射表，根据需求前端自定义<strong>或</strong>后端获取</li>
</ol>
<p><strong>关联</strong>：</p>
<ol>
<li>根据页面划分功能模块</li>
<li>根据功能模块归纳事件</li>
<li>事件触发接口方法的调用</li>
<li>接口方法的参数源于state，接口方法获取后端数据提供给props</li>
<li>数据与映射表息息相关</li>
</ol>
<p><strong>流程</strong><br>view–&gt;事件–&gt;方法（state）{return props}–&gt;view–&gt;</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><img src="/want/2018/09/29/React前端开发前的规划/消息模块.png" title="消息模块">
]]></content>
      <tags>
        <tag>React</tag>
        <tag>图</tag>
      </tags>
  </entry>
  <entry>
    <title>bug前端</title>
    <url>/want/2018/10/31/bug%E5%89%8D%E7%AB%AF/</url>
    <content><![CDATA[<h3 id="一、数据统一"><a href="#一、数据统一" class="headerlink" title="一、数据统一"></a>一、数据统一</h3><p>数据，流入要统一入口；流出要统一出口；</p>
<h4 id="示例1：时间格式"><a href="#示例1：时间格式" class="headerlink" title="示例1：时间格式"></a>示例1：时间格式</h4><p>后端可能给时间戳，可能给字符串。</p>
<p>前端一定不要被后端的<strong>混乱</strong>所影响。</p>
<ol>
<li><p>前端取得后端数据后，马上统一格式F。</p>
</li>
<li><p>前端在传递给后端的最后一刻，将自己的统一格式F转换为后端所需。</p>
</li>
</ol>
<h4 id="示例2：id和name"><a href="#示例2：id和name" class="headerlink" title="示例2：id和name"></a>示例2：id和name</h4><p>后端可能只给name/后端可能根本没有唯一逻辑主键id而只是是给了两个字段作为联合主键。</p>
<p>前端一定不要被后端的<strong>混乱</strong>所影响。</p>
<ol>
<li>前端取得后端数据后，马上统一增加id，利用该id进行前端操作。</li>
<li>前端在传递给后端的最后一刻，将自己的id转换为后端所需字段。</li>
</ol>
<hr>
<h3 id="二、总有一个负责好看，总有一个负责真实"><a href="#二、总有一个负责好看，总有一个负责真实" class="headerlink" title="二、总有一个负责好看，总有一个负责真实"></a>二、总有一个负责好看，总有一个负责真实</h3><p>前端数据总喜欢保留两位小数。</p>
<p>但前端必须的有个地方让用户看到真实的数据。</p>
<ol>
<li><p>使用ToolTip！</p>
</li>
<li><p>根据数量级转换相应单位，比如，数据小于1024*1024，则单位保持MB；大于1024*1024，则转换为GB；再大可转换为TB。该做法可避免只采用一种单位，导致出现一堆小数（0.000111）、或很大数位挤占空间（12345678901）。</p>
</li>
</ol>
<hr>
<h3 id="三、字体"><a href="#三、字体" class="headerlink" title="三、字体"></a>三、字体</h3><p>思源字体是个很好看的字体，然而出现了如下怪异的文字。虽然很有艺术性，但很多人接受不了。</p>
<img src="/want/2018/10/31/bug前端/思源字体.png" title="特殊的思源字体">
<p>用NotoSansHans-Regular.otf 替代 SourceHanSans-Normal.otf即可。</p>
<hr>
<h3 id="四、url特殊字符"><a href="#四、url特殊字符" class="headerlink" title="四、url特殊字符"></a>四、url特殊字符</h3><p>一般来说，URL只能使用”英文字母[0-9a-zA-Z]”、”阿拉伯数字”和某些”标点符号[$-_.+!*’(),]”。</p>
<p>url传参时，经常会传递一些中文名（或含有特殊字符）的参数或URL地址，在后台处理时会发生转换错误。</p>
<p>url中的需要转换的特殊字符部分示例如下：</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>URL编码值</th>
</tr>
</thead>
<tbody>
<tr>
<td>空格</td>
<td>%20</td>
</tr>
<tr>
<td>“</td>
<td>%22</td>
</tr>
<tr>
<td>#</td>
<td>%23</td>
</tr>
<tr>
<td>%</td>
<td>%25</td>
</tr>
<tr>
<td>&amp;</td>
<td>%26</td>
</tr>
<tr>
<td>(</td>
<td>%28</td>
</tr>
<tr>
<td>)</td>
<td>%29</td>
</tr>
<tr>
<td>+</td>
<td>%2B</td>
</tr>
<tr>
<td>,</td>
<td>%2C</td>
</tr>
<tr>
<td>/</td>
<td>%2F</td>
</tr>
<tr>
<td>:</td>
<td>%3A</td>
</tr>
<tr>
<td>;</td>
<td>%3B</td>
</tr>
<tr>
<td>&lt;</td>
<td>%3C</td>
</tr>
<tr>
<td>=</td>
<td>%3D</td>
</tr>
<tr>
<td>&gt;</td>
<td>%3E</td>
</tr>
<tr>
<td>?</td>
<td>%3F</td>
</tr>
<tr>
<td>@</td>
<td>%40</td>
</tr>
<tr>
<td>\</td>
<td>%5C</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>%7C</td>
</tr>
</tbody>
</table>
<h4 id="方法1：-对url进行编码"><a href="#方法1：-对url进行编码" class="headerlink" title="方法1： 对url进行编码"></a>方法1： 对url进行编码</h4><table>
<thead>
<tr>
<th>方法</th>
<th>特性</th>
<th>安全字符</th>
</tr>
</thead>
<tbody>
<tr>
<td>escape()  /  unescape()</td>
<td>除ASCII 字母、数字和特定的符号外，对字符串<strong>全部</strong>转义编码。因此如果想对URL编码，最好<strong>不要</strong>使用此方法</td>
<td>*/@+-._0-9a-zA-Z</td>
</tr>
<tr>
<td>encodeURI()  / decodeURI()</td>
<td>编码整个URI，因为URI中的<strong>合法字符都不会被编码转换</strong></td>
<td>!#$&amp;’()*+,/:;=?@-._~0-9a-zA-Z</td>
</tr>
<tr>
<td>encodeURIComponent()  /  decodeURIComponent()</td>
<td>编码<strong>请求参数</strong>时最常用，可以将参数中的中文、特殊字符进行转义，而不会影响整个URL</td>
<td>!’()*-._~0-9a-zA-Z</td>
</tr>
</tbody>
</table>
<h4 id="方法2：参数不允许是特殊字符"><a href="#方法2：参数不允许是特殊字符" class="headerlink" title="方法2：参数不允许是特殊字符"></a>方法2：参数不允许是特殊字符</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">控制输入参数（只能输入中文、英文、数字、下划线）:</span><br><span class="line"></span><br><span class="line">/^[a-zA-Z0<span class="number">-9</span>_\u4e00-\u9fa5]*$/</span><br></pre></td></tr></table></figure>
<h4 id="方法3：采用POST而非GET传参"><a href="#方法3：采用POST而非GET传参" class="headerlink" title="方法3：采用POST而非GET传参"></a>方法3：采用POST而非GET传参</h4><h3 id="五、奇怪问题"><a href="#五、奇怪问题" class="headerlink" title="五、奇怪问题"></a>五、奇怪问题</h3><p>面对不知原因的奇怪问题时，可以从依赖环境/部署环境等入手。</p>
<h4 id="CanvasRenderingContext2D"><a href="#CanvasRenderingContext2D" class="headerlink" title="CanvasRenderingContext2D"></a>CanvasRenderingContext2D</h4><p>错误： 在echarts或其他基于canvas绘图工具中，出现如下问题：</p>
<blockquote>
<p>Uncaught TypeError: Failed to execute ‘createRadialGradient/createLinearGradient’ on ‘CanvasRenderingContext2D’: The provided double value is non-finite.</p>
</blockquote>
<p>根本原因： <a href="http://www.w3school.com.cn/tags/canvas_createlineargradient.asp" target="_blank" rel="noopener">HTML5 canvas createLinearGradient() 方法</a>，其参数应为<strong>有限实数</strong>。 但实际传入了undefined或null等值。</p>
<img src="/want/2018/10/31/bug前端/non-finite.png" title="接受参数不合法">
<p>单纯针对上述问题的解决：①调试找到非法参数；②利用Math.floor() Math.Fixed() parseFloat() 等将参数变成有限实数。</p>
<p>然而，在echarts封装图库中，并没有找到非法参数的来源（echarts内部渲染）。在官网调试相同option参数，发现官网正常运行。<strong>升级echarts版本（3.7–&gt;4.2）后运行正常</strong>。</p>
<h4 id="webpack-import"><a href="#webpack-import" class="headerlink" title="webpack import"></a>webpack import</h4><p>报错如下：<br><img src="/want/2018/10/31/bug前端/webpack_import_error.png" title="无法import路径"></p>
<p>在package.json中发现npm install时没有将react-loadable引入。改用淘宝镜像重新安装。</p>
<img src="/want/2018/10/31/bug前端/react-loadable.png" title="丢失依赖包">
]]></content>
      <tags>
        <tag>bug</tag>
      </tags>
  </entry>
  <entry>
    <title>bug后端</title>
    <url>/want/2018/11/02/bug%E5%90%8E%E7%AB%AF/</url>
    <content><![CDATA[<h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><h4 id="单引号问题"><a href="#单引号问题" class="headerlink" title="单引号问题"></a>单引号问题</h4><p>输入内容含单引号导致sql错误。此单引号可能是用户特意输入，也可能是微软输入法拼汉字过程产物。如下图：</p>
<img src="/want/2018/11/02/bug后端/单引号输入示例.jpg" title="单引号输入">
<p><strong>原因</strong></p>
<p>在sql语句中，单引号是特殊字符，字符串参数会被单引号包裹。</p>
<p>如果采用字符串拼接sql语句，那么在拼接过程中，内容中的单引号也会被特殊解析。</p>
<p><strong>解决</strong></p>
<ol>
<li><p><strong>replace</strong>转义。因为sql中，用两个单引号,表示一个不是字符边界的单引号，因此传入字符串的时候，将单引号用<strong>replace</strong>方法替换成两个单引号，结果不变，报错取消。</p>
</li>
<li><p><strong>占位符</strong>代替变量。如java中的<code>？</code>，c#中的<code>@</code>，mybatis中<code>#{ }</code> 被解析为一个参数占位符 <code>?</code>，<code>${ }</code> 仅仅为一个纯碎的 string 替换。</p>
</li>
</ol>
<p><strong>参考</strong></p>
<ol>
<li><a href="https://segmentfault.com/a/1190000004617028" target="_blank" rel="noopener">mybatis的#{}和${}</a></li>
</ol>
<h4 id="MySql默认查询不区分大小"><a href="#MySql默认查询不区分大小" class="headerlink" title="MySql默认查询不区分大小"></a>MySql默认查询不区分大小</h4><ol>
<li>BINARY 表示敏感</li>
</ol>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">NAME</span>(</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">10</span>) <span class="built_in">BINARY</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLE</span> <span class="keyword">NAME</span> <span class="keyword">WHERE</span> <span class="built_in">BINARY</span> <span class="keyword">name</span>=<span class="string">'Clip'</span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>设置字符集</li>
</ol>
<p>utf8_general_ci –不区分大小写</p>
<p>utf8_bin–区分大小写</p>
]]></content>
      <tags>
        <tag>bug</tag>
      </tags>
  </entry>
  <entry>
    <title>csv</title>
    <url>/want/2020/06/11/csv/</url>
    <content><![CDATA[<h3 id="CSV文件流操作"><a href="#CSV文件流操作" class="headerlink" title="CSV文件流操作"></a>CSV文件流操作</h3><p>csv内容格式就是纯文本的字符拼接，本质上是获取特殊字符串分割的<strong>字符串</strong>，将字符串<strong>转换为文件流</strong>。</p>
<h4 id="分隔符"><a href="#分隔符" class="headerlink" title="分隔符"></a>分隔符</h4><ol>
<li>列分隔符，如|等</li>
<li>行分隔符，需要根据操作系统区分<ol>
<li>Unix系统里，每行结尾只有“&lt;换行&gt;”，即“\n”；</li>
<li>Windows系统里面，每行结尾是“&lt;回车&gt;&lt;换行&gt;”，即“\r\n”；</li>
<li>Mac系统里，每行结尾是“&lt;回车&gt;”,即“\r”。</li>
</ol>
</li>
</ol>
<h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;List&lt;String&gt;&gt; dataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">dataList.add(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"z"</span>););</span><br><span class="line">dataList.add(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"z"</span>););</span><br><span class="line">dataList.add(Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>, <span class="string">"f"</span>, <span class="string">"z"</span>););</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼接成字符串</span></span><br><span class="line">List&lt;String&gt; rowList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (List&lt;String&gt; row : dataList) &#123;</span><br><span class="line">		String rowStr = String.join(<span class="string">"|"</span>, row);</span><br><span class="line">		rowList.add(rowStr);</span><br><span class="line">&#125;</span><br><span class="line">String rowsStr = String.join(<span class="string">"\n"</span>, rowList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将字符串转换为文件流</span></span><br><span class="line"><span class="keyword">byte</span>[] bytes = rowsStr.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">InputStream file = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line"><span class="comment">// bytes.length可以获得文件的字节大小。</span></span><br><span class="line"><span class="comment">// InputStream文件流可以和File进行转换。</span></span><br></pre></td></tr></table></figure>
<h4 id="文件流API详解"><a href="#文件流API详解" class="headerlink" title="文件流API详解"></a>文件流API详解</h4><ol>
<li>所有的 io操作都保存在 java.io包中</li>
<li>在整个 io包中，唯一表示与文件本身有关的类就是<code>File</code>类</li>
<li>所有程序数据都是<code>流</code>的方式传输或保存。【流中保存的全都是字节文件】<ul>
<li>程序需要数据时，使用输入流读取数据</li>
<li>程序需要将数据保存起来的时候，使用输出流</li>
</ul>
</li>
</ol>
<h5 id="文件流分类"><a href="#文件流分类" class="headerlink" title="文件流分类"></a>文件流分类</h5><pre class="mermaid">graph LR
A(IO) --> B(字节流)
A-->C(字符流)

B --> B1(输入)
B1 -.- InputStream(InputStream)
B --> B2(输出)
B2 -.- OutputStream(OutputStream)

C --> C1(输入)
C1 -.- Reader(Reader)
C--> C2(输出)
C2 -.- Writer(Writer)</pre>

<h5 id="文件流区分"><a href="#文件流区分" class="headerlink" title="文件流区分"></a>文件流区分</h5><ol>
<li>字节流：直接操作文件。不会用到缓冲区（内存）。<ul>
<li>在①硬盘上保存文件，或是②传输时，都以字节方式进行。图片也是按字节完成。【使用最多】</li>
<li>字节流操作 <code>byte</code>类型数据，几乎所有数据都可以直接使用 <code>byte数组</code>表示。</li>
</ul>
</li>
<li>字符流：不能直接操作文件，需要用到缓存。先将数据放到缓存中，再从缓存写入文件。<ul>
<li>字符是只有在内存中才会形成。</li>
</ul>
</li>
</ol>
<pre class="mermaid">graph LR
A(程序) --> B(字节流)
B--> C>文件]

A1(程序) --> B1(字符流)
B1 --> C1(缓存)
C1--> D1>文件]</pre>





<h5 id="字节流InputStream"><a href="#字节流InputStream" class="headerlink" title="字节流InputStream"></a>字节流InputStream</h5><ol>
<li>通过 InputStream可以从文件中把内容读取进来</li>
<li>InputStream本身也是一个抽象类，必须依靠其子类，如果现在是从文件中读取，子类是 FileInputStream</li>
<li>获取文件大小：直接使用 File类即可：<strong>public long length()</strong></li>
</ol>
<pre class="mermaid">graph LR
InputStream --> I1(ByteArrayInputStream)
InputStream --> I2(FileInputStream)
InputStream --> I3(ObjectInputStream)
InputStream --> I4(PipedInputStream)
InputStream --> FilterInputStream(FilterInputStream)
InputStream --> I6(SequenceInputStream)

FilterInputStream --> DataInputStream(DataInputStream)
FilterInputStream --> BufferedInputStream(BufferedInputStream)
FilterInputStream --> PushbackInputStream(PushbackInputStream)</pre>

<h5 id="字节流OutputStream"><a href="#字节流OutputStream" class="headerlink" title="字节流OutputStream"></a>字节流OutputStream</h5><ol>
<li>OutputStream是一个抽象类，如果要想使用此类的话，则首先必须子类实例化对象，那么如果现在要操作的是一个文件，则可以使用：FileOutputStream类，通过向上转型之后，可以为 OutputStream实例化</li>
<li>Closeable：表示可以关闭的操作，因为程序运行到最后肯定要关闭</li>
<li>Flushable：表示刷新，清空内存中的数据</li>
</ol>
<pre class="mermaid">graph LR
OutputStream --> O1(ByteArrayOutputStream)
OutputStream --> O2(FileOutputStream)
OutputStream --> O3(ObjectOutputStream)

OutputStream --> FilterOutputStream(FilterOutputStream)
OutputStream --> O5(PipedOutputStream)

FilterOutputStream --> DataOutputStream(DataOutputStream)
FilterOutputStream --> BufferedOutputStream(BufferedOutputStream)
FilterOutputStream --> PrintOutputStream(PrintOutputStream)</pre>



<h5 id="字符流"><a href="#字符流" class="headerlink" title="字符流"></a>字符流</h5><p>在程序中一个字符等于2个字节，JAVA提供了Reader、Writer两个专门操作字符流的类</p>
<p><strong>Writer</strong></p>
<ol>
<li>Writer抽象类，如果是向文件中写入内容，所以应该使用 FileWriter的子类</li>
<li>字符流的操作比字节流操作的优点：可以直接输出字符串，不用进行转换</li>
</ol>
<p><strong>Reader</strong></p>
<ol>
<li>Reader抽象类，使用字符的方式从文件取出数据，如果现在要从文件中读取内容，则可以直接使用 FileReader子类</li>
</ol>
<img src="/want/2020/06/11/csv/字符流.png" title="字符流">
<h3 id="CSV文件编码"><a href="#CSV文件编码" class="headerlink" title="CSV文件编码"></a>CSV文件编码</h3><p>在JAVA下输出文件流，保存成CSV（用UTF-8）文件。用EXCEL打开是乱码，用记事本等其他软件正常且显示是UTF-8的编码。</p>
<p>这是EXCEL本身的问题，不是CSV文件的问题。</p>
<p>1、EXCEL只能打开ANSI的编码，而ANSI需要当前操作系统是什么编码，就用什么编码。如中文系统下，则只能认识GBK的编码，不认识UTF-8的编码，唯一的解决办法就是将文件流输出成GBK等当前操作系统认识的编码。</p>
<p>可以通过Properties properties = System.getProperties();<br>               String encodingStr = properties.getProperty(“file.encoding”);<br>来查看当前的服务器下的编码是什么，如果服/客编码不一致，如服务器是UTF-8，而客户端是GBK，则想要CSV不乱码，唯一的解决办法是将输出的内容通过outTmp.toString().getBytes(“GBK”)强制转化成客户端支持的GBK。</p>
]]></content>
  </entry>
  <entry>
    <title>doc</title>
    <url>/want/2020/07/05/doc/</url>
    <content><![CDATA[<h3 id="打开CMD"><a href="#打开CMD" class="headerlink" title="打开CMD"></a>打开CMD</h3><h4 id="普通身份打开CMD"><a href="#普通身份打开CMD" class="headerlink" title="普通身份打开CMD"></a>普通身份打开CMD</h4><ol>
<li>Win + R，然后输入cmd</li>
<li>资源管理器的地址栏，输入cmd （或cmd  路径）</li>
<li>任意文件夹，shift + 鼠标右键</li>
<li>开始菜单——windows系统——命令提示符</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200705181722735.png" alt="image-20200705181722735"></p>
<h4 id="以管理员身份打开CMD"><a href="#以管理员身份打开CMD" class="headerlink" title="以管理员身份打开CMD"></a>以管理员身份打开CMD</h4><p>开始菜单——windows系统——命令提示符——右键——以管理员身份运行</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200705182135707.png" alt="image-20200705182135707"></p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">#新建目录 <span class="built_in">md</span> 目录</span><br><span class="line"><span class="built_in">md</span> test</span><br><span class="line"></span><br><span class="line">#删除目录 <span class="built_in">rd</span> 目录</span><br><span class="line"><span class="built_in">rd</span> test</span><br><span class="line"></span><br><span class="line">#新建文件 <span class="built_in">cd</span>&gt;文件</span><br><span class="line"><span class="function">F:\<span class="title">test</span>&gt;<span class="title">cd</span>&gt;<span class="title">a.txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#删除文件 <span class="title">del</span> 文件</span></span><br><span class="line"><span class="function"><span class="title">F</span>:\<span class="title">test</span>&gt;<span class="title">del</span> <span class="title">a.txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#查看目录列表	<span class="title">dir</span></span></span><br><span class="line"><span class="function"><span class="title">E</span>:\&gt;<span class="title">dir</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#切换盘符，直接输入	<span class="title">E</span>:</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">lux</span>&gt;<span class="title">E</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#切换目录	<span class="title">cd</span></span></span><br><span class="line"><span class="function"><span class="title">F</span>:\&gt;<span class="title">cd</span> /<span class="title">d</span> <span class="title">E</span>:			#切换盘符</span></span><br><span class="line"><span class="function"><span class="title">F</span>:\&gt;<span class="title">cd</span> /<span class="title">d</span> <span class="title">E</span>:/<span class="title">vue</span>	#切换到盘符下目录</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">E</span>:\&gt;<span class="title">cd</span> <span class="title">vue</span>				#切换到当前目录下的<span class="title">vue</span>目录</span></span><br><span class="line"><span class="function"><span class="title">E</span>:\&gt;<span class="title">cd</span> ..					#切换到上一级目录</span></span><br></pre></td></tr></table></figure>
<h4 id="网络操作"><a href="#网络操作" class="headerlink" title="网络操作"></a>网络操作</h4><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">#查看ip地址</span><br><span class="line"><span class="built_in">ipconfig</span></span><br><span class="line"></span><br><span class="line">#<span class="built_in">ping</span>检查是否能够访问某网络地址</span><br><span class="line"><span class="built_in">ping</span> www.baidu.com</span><br></pre></td></tr></table></figure>
<h4 id="打开应用程序"><a href="#打开应用程序" class="headerlink" title="打开应用程序"></a>打开应用程序</h4><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">#打开程序</span><br><span class="line">calc							#打开计算器程序</span><br><span class="line">mspaint 					#打开画图工具</span><br><span class="line">notepad						#打开记事本</span><br></pre></td></tr></table></figure>
<h4 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h4><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">#清屏幕(clear screen)</span><br><span class="line"><span class="built_in">cls</span></span><br><span class="line"></span><br><span class="line">#退出终端(关闭当前doc窗口)</span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>echarts地图自定义</title>
    <url>/want/2020/12/08/echarts%E5%9C%B0%E5%9B%BE%E8%87%AA%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<h3 id="一、目标"><a href="#一、目标" class="headerlink" title="一、目标"></a>一、目标</h3><p>现有echarts地图不能满足特殊需要。以上海为例：</p>
<h4 id="1-现有echarts地图"><a href="#1-现有echarts地图" class="headerlink" title="1. 现有echarts地图"></a>1. 现有echarts地图</h4><p>按照真实行政区域进行区域划分</p>
<p> <img src="https://ecloud.10086.cn/portals/api/file/6cbceab75da845e9.png" alt="Description"></p>
<h4 id="2-特殊需要"><a href="#2-特殊需要" class="headerlink" title="2.特殊需要"></a>2.特殊需要</h4><ol>
<li>将若干小行政区域合并为大区</li>
<li>将面积较大的行政区域拆分为小区</li>
</ol>
<p>例如，</p>
<ol>
<li>将浦东新区拆分为浦东1，浦东2</li>
<li>将虹口、杨浦合并为北区</li>
</ol>
<p><img src="https://ecloud.10086.cn/portals/api/file/fc530f7456234931.png" alt="Description"></p>
<h3 id="二、思路"><a href="#二、思路" class="headerlink" title="二、思路"></a>二、思路</h3><h4 id="首先，自定义地图数据"><a href="#首先，自定义地图数据" class="headerlink" title="首先，自定义地图数据"></a>首先，自定义地图数据</h4><ol>
<li>获取地图数据</li>
<li>编辑地图数据</li>
</ol>
<h4 id="其次，融入echarts"><a href="#其次，融入echarts" class="headerlink" title="其次，融入echarts"></a>其次，融入echarts</h4><ol>
<li>geojson与echarts地图数据格式融合</li>
</ol>
<h4 id="最后，得到可持续使用的自定义地图"><a href="#最后，得到可持续使用的自定义地图" class="headerlink" title="最后，得到可持续使用的自定义地图"></a>最后，得到可持续使用的自定义地图</h4><h3 id="三、实现"><a href="#三、实现" class="headerlink" title="三、实现"></a>三、实现</h3><h4 id="1-获取地图数据"><a href="#1-获取地图数据" class="headerlink" title="1. 获取地图数据"></a>1. 获取地图数据</h4><p><strong>方式1</strong>： 直接搜索引擎搜索地图数据。如下示例：</p>
<ol>
<li>中国省/县地图文件 <a href="https://github.com/longwosion/geojson-map-china" target="_blank" rel="noopener">https://github.com/longwosion/geojson-map-china</a></li>
</ol>
<p><strong>方式2</strong>： 购买地图图层，如“国家基础地理信息中心”</p>
<p><strong>方式3</strong>： 自定义地图数据（如MapInfo格式）。如下：</p>
<p><img src="https://ecloud.10086.cn/portals/api/file/2ac0e1ac359e4be9.png" alt="Description"></p>
<h4 id="2-编辑地图数据"><a href="#2-编辑地图数据" class="headerlink" title="2. 编辑地图数据"></a>2. 编辑地图数据</h4><p>已有地图数据，有时并不符合我们的需求，则可以通过如下工具进行编辑——</p>
<ol>
<li>格式转换（将MapInfo格式转换为GeoJSON格式） <a href="https://mygeodata.cloud/converter/mapinfo-to-geojson" target="_blank" rel="noopener">https://mygeodata.cloud/converter/mapinfo-to-geojson</a> （在线 ）</li>
<li>查看并编辑（轻量级GeoJSON格式查看并编辑工具） <a href="http://geojson.io" target="_blank" rel="noopener">http://geojson.io</a> （在线 ）</li>
<li>查看并编辑（专业级Mapinfo格式地图编辑工具）mapinfo软件（下载） </li>
</ol>
<blockquote>
<p>推荐 <strong>轻量级地图编辑工具 <a href="http://geojson.io" target="_blank" rel="noopener">http://geojson.io</a></strong> ，可对地图图层进行增删改存操作。</p>
</blockquote>
<h5 id="geojosn编辑示例"><a href="#geojosn编辑示例" class="headerlink" title="geojosn编辑示例"></a>geojosn编辑示例</h5><p>1.源文件</p>
<p><img src="https://ecloud.10086.cn/portals/api/file/8be70b5cb5fb4f8f.png" alt="Description"></p>
<p>2.编辑得到两个文件</p>
<p>一区</p>
<p><img src="https://ecloud.10086.cn/portals/api/file/3a814cdd1d524a05.png" alt="Description"></p>
<p>二区</p>
<p><img src="https://ecloud.10086.cn/portals/api/file/88f82ab2d5e64a10.png" alt="Description"></p>
<p>3.保存已编辑的geojson格式数据即可。</p>
<h4 id="3-融入echarts"><a href="#3-融入echarts" class="headerlink" title="3. 融入echarts"></a>3. 融入echarts</h4><p>由于echarts对自己的地图数据进行了额外的编码，因此上述得到的geojson格式，并不能直接嫁接到echarts的地图json/js文件中。</p>
<h5 id="echarts地图数据格式示例"><a href="#echarts地图数据格式示例" class="headerlink" title="echarts地图数据格式示例:"></a>echarts地图数据格式示例:</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;type&quot;: &quot;FeatureCollection&quot;,</span><br><span class="line"> &quot;features&quot;: [</span><br><span class="line">   &#123;</span><br><span class="line">     &quot;id&quot;: &quot;310112&quot;,</span><br><span class="line">     &quot;type&quot;: &quot;Feature&quot;,</span><br><span class="line">     &quot;geometry&quot;: &#123;</span><br><span class="line">       &quot;type&quot;: &quot;Polygon&quot;,</span><br><span class="line">       &quot;coordinates&quot;: [</span><br><span class="line">         &quot;@@@EBAD@@A@E_GCB@A@AG@BGCABGEAHQPFRiFKNQ^DFSEMFAFBHFBCFDDACCFGA@</span><br><span class="line">@AG@@AC@@AD@BAD@@AB@BED@B@F@B@FBBNDFLCDBCBFB@DFG@CBBABDB@CDBAFCB@DABD@B@DB@</span><br><span class="line">BD@@B@BB@B@@FJ@DKLFB@DMDBBABBCFDB@@HB@BBABBDCBGNBDAB@@BP],// 非全部</span><br><span class="line">       &quot;encodeOffsets&quot;: [</span><br><span class="line">         [</span><br><span class="line">           124327,</span><br><span class="line">           31940</span><br><span class="line">         ]</span><br><span class="line">       ]</span><br><span class="line">     &#125;,</span><br><span class="line">   &#125;,</span><br><span class="line"> ],</span><br><span class="line"> &quot;UTF8Encoding&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="geojson数据格式示例"><a href="#geojson数据格式示例" class="headerlink" title="geojson数据格式示例:"></a>geojson数据格式示例:</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;type&quot;: &quot;FeatureCollection&quot;,</span><br><span class="line"> &quot;features&quot;: [</span><br><span class="line">   &#123;</span><br><span class="line">     &quot;type&quot;: &quot;Feature&quot;,</span><br><span class="line">     &quot;properties&quot;: &#123;</span><br><span class="line">       &quot;daiwei_fenqu&quot;: &quot;&quot;</span><br><span class="line">     &#125;,</span><br><span class="line">     &quot;geometry&quot;: &#123;</span><br><span class="line">       &quot;type&quot;: &quot;Polygon&quot;,</span><br><span class="line">       &quot;coordinates&quot;: [[</span><br><span class="line">           [</span><br><span class="line">             121.93519592285156,</span><br><span class="line">             31.015278981711266</span><br><span class="line">           ],</span><br><span class="line">           [</span><br><span class="line">             121.90223693847656,</span><br><span class="line">             31.06058083870329</span><br><span class="line">           ],</span><br><span class="line">       ]],</span><br><span class="line">       &#125;,</span><br><span class="line">   &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，echarts对geojson主要对如下字段编码：</p>
<ol>
<li><p>coordinates</p>
</li>
<li><p>encodeOffsets</p>
</li>
<li><p>UTF8Encoding: true</p>
</li>
</ol>
<p>另外，如果进行手动编辑json文件（如直接在json文件中，进行行政区的合并/拆分操作），也主要操作如字段：</p>
<ol>
<li><p>coordinates</p>
</li>
<li><p>encodeOffsets</p>
</li>
</ol>
<h5 id="处理方案如下："><a href="#处理方案如下：" class="headerlink" title="处理方案如下："></a>处理方案如下：</h5><ul>
<li>方式1：echarts地图数据文件内容全部更改为geojson格式。</li>
<li>方式2：echarts地图数据文件内容全部保留为echarts编码后格式。</li>
</ul>
<p>以上两种格式不能混杂在一个地图数据文件中——</p>
<p>1.如果全部更改为geojson，则需要自己另行编辑其他未更改区域。</p>
<p>2.如果对geojson进行编码，则只需把更改部分编码后融入echarts现有数据文件，编码工具如下：</p>
<ul>
<li>工具：将geojson编码为echarts地图数据格式</li>
<li>链接：<a href="http://blog.giscafer.com/mapshaper-plus/" target="_blank" rel="noopener">http://blog.giscafer.com/mapshaper-plus/</a></li>
<li><p>使用示意图：</p>
<p><img src="https://ecloud.10086.cn/portals/api/file/fa29c9655f58486e.png" alt="Description"></p>
</li>
</ul>
<h3 id="四、注意"><a href="#四、注意" class="headerlink" title="四、注意"></a>四、注意</h3><p>自己编辑得到的地图形状与原本echarts地图融合时候，可能会存在些许偏差（区域之间存在间隙），如果精度要求不太严格，则可以控制地图最大缩放级别，忽略小空隙。</p>
<p>如果精度要求极其严格，则最好抛弃echarts本身的地图数据。直接采用一套完整的地图。</p>
<h4 id="处理后地图"><a href="#处理后地图" class="headerlink" title="处理后地图:"></a>处理后地图:</h4><p><img src="https://ecloud.10086.cn/portals/api/file/538348ca9e96498e.png" alt="Description"></p>
<h4 id="调用"><a href="#调用" class="headerlink" title="调用:"></a>调用:</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import SHUrl from &apos;./shanghai-origin.json&apos;; // 引入</span><br><span class="line">ECharts.registerMap(&apos;上海片区&apos;, SHUrl); // 注册</span><br><span class="line">&#123;</span><br><span class="line"> type: &apos;map&apos;,</span><br><span class="line"> map: &apos;上海片区&apos;, // 调用</span><br><span class="line"> roam: true,</span><br><span class="line"> zoom: 1.2,</span><br><span class="line"> scaleLimit: &#123;</span><br><span class="line">   min: 1,max: 1.3, // 限制缩放级别</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>echarts调用zrender实现自定义需求</title>
    <url>/want/2019/01/03/echarts%E8%B0%83%E7%94%A8zrender%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9C%80%E6%B1%82/</url>
    <content><![CDATA[<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>zrender可对Echarts添加额外图形或进行深度定制。</p>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ol>
<li>获取zrender实例： myChart.getZr()</li>
<li>zrender实例相关操作参见zrenderAPI</li>
</ol>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><h4 id="1-折线图鼠标点击事件"><a href="#1-折线图鼠标点击事件" class="headerlink" title="1. 折线图鼠标点击事件"></a>1. 折线图鼠标点击事件</h4><p><strong>echarts现状</strong>：当鼠标移动到某一条折线的<strong>结点</strong>上，鼠标样式才会改变，才能触发点击事件（即某一时刻，某一条折线的数据）<br><img src="/want/2019/01/03/echarts调用zrender实现自定义需求/折线图默认点击事件.gif" title="折线图默认点击事件"><br><strong>用户需求</strong>：只要鼠标移动出现悬浮线，就可以点击，并获取悬浮线<strong>所经过的x轴数据/所有图例数据</strong>（即某一时刻，所有折线的数据）<br><img src="/want/2019/01/03/echarts调用zrender实现自定义需求/折线图自定义点击事件.gif" title="折线图自定义点击事件"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> zr = myChart.getZr(); <span class="comment">// 获取zrender实例</span></span><br><span class="line">zr.on(<span class="string">'mousemove'</span>, (params) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> point = [params.offsetX, params.offsetY];</span><br><span class="line">    <span class="keyword">if</span> (myChart.containPixel(&#123; <span class="attr">gridIndex</span>: <span class="number">0</span> &#125;, point)) &#123;</span><br><span class="line">        <span class="comment">// 判断鼠标是否在grid图形内部</span></span><br><span class="line">        zr.setCursorStyle(<span class="string">'pointer'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    zr.setCursorStyle(<span class="string">'default'</span>); <span class="comment">// 更改鼠标样式</span></span><br><span class="line">&#125;);</span><br><span class="line">zr.on(<span class="string">'mouseout'</span>, () =&gt; &#123;</span><br><span class="line">    zr.setCursorStyle(<span class="string">'default'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">zr.off(<span class="string">'click'</span>);</span><br><span class="line">zr.on(<span class="string">'click'</span>, (params) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> point = [params.offsetX, params.offsetY];</span><br><span class="line">    <span class="keyword">if</span> (myChart.containPixel(&#123; <span class="attr">gridIndex</span>: <span class="number">0</span> &#125;, point)) &#123;</span><br><span class="line">        <span class="comment">// 获取鼠标当前所在x轴位置</span></span><br><span class="line">        <span class="keyword">const</span> xIndex = myChart.convertFromPixel(&#123; <span class="attr">seriesIndex</span>: <span class="number">0</span> &#125;, point)[<span class="number">0</span>];</span><br><span class="line">        click(xIndex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="2-自定义图案"><a href="#2-自定义图案" class="headerlink" title="2. 自定义图案"></a>2. 自定义图案</h4><p>增加一个矩形图案<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> zr = myChart.getZr();</span><br><span class="line"><span class="keyword">var</span> rect = <span class="keyword">new</span> echarts.graphic.Rect(&#123;</span><br><span class="line">	position:[<span class="built_in">Math</span>.random() * <span class="number">200</span>, <span class="built_in">Math</span>.random() * <span class="number">200</span>],</span><br><span class="line">	scale: [<span class="number">1</span>,<span class="number">1</span>],</span><br><span class="line">	shape:&#123;</span><br><span class="line">		x:<span class="number">10</span>,</span><br><span class="line">		y:<span class="number">20</span>,</span><br><span class="line">		width:<span class="number">100</span>,</span><br><span class="line">		height:<span class="number">50</span></span><br><span class="line">	&#125;,</span><br><span class="line">	style:&#123;</span><br><span class="line">		fill:<span class="string">'red'</span>,</span><br><span class="line">		text: <span class="string">'zRender Rect'</span></span><br><span class="line">	&#125;,</span><br><span class="line">	zlevel:<span class="number">3</span></span><br><span class="line">&#125;);</span><br><span class="line">zr.add(rect);</span><br></pre></td></tr></table></figure></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://segmentfault.com/a/1190000010313745" target="_blank" rel="noopener">使用echarts 与zrender 制作攻击效果</a></li>
<li><a href="https://ecomfe.github.io/zrender-doc/public/" target="_blank" rel="noopener">ZRender官网</a></li>
</ol>
]]></content>
      <tags>
        <tag>echarts</tag>
        <tag>zrender</tag>
      </tags>
  </entry>
  <entry>
    <title>gerrit</title>
    <url>/want/2021/02/05/gerrit/</url>
    <content><![CDATA[<h4 id="pull代码"><a href="#pull代码" class="headerlink" title="pull代码"></a>pull代码</h4><p>场景：</p>
<p>提交到远程后，本地进行了reset操作。此时远程仓库代码比本地仓库代码更新。导致本地无法提交代码（会报错，因为会覆盖远程）</p>
<p><code>To github.com:echowant/want-source.git                                          
! [rejected]        master -&gt; master (non-fast-forward)                        
error: failed to push some refs to &#39;git@github.com:echowant/want-source.git&#39;    
hint: Updates were rejected because the tip of your current branch is behind    
hint: its remote counterpart. Integrate the remote changes (e.g.                
hint: &#39;git pull ...&#39;) before pushing again.                                     
hint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.</code></p>
<p>办法：</p>
<p>不能git pull同步代码到本地，需要执行git pull –rebase，该参数的含义是：</p>
<p>1.把本地working copy从上次 pull 之后的变更暂存起來</p>
<p>2.恢复到上次 pull 时的状态</p>
<p>3.合并远端的变更到本地</p>
<p>4.最后再合并刚刚暂存下來的本地变更</p>
<p>如果遇到了冲突，解决对应的冲突即可。</p>
<p>git pull的默认行为是git fetch + git merge</p>
<p>git pull –rebase则是git fetch + git rebase.</p>
<p>因此，使用git fetch，然后在merge或者rebase来解决冲突，会比直接使用git pull更好，这样更容易解决出现的冲突。</p>
<p>#### </p>
<p>git pull –rebase</p>
<p>本地同步到远程最新，</p>
<p>然后本地修改并提交记录，</p>
<p>他人有推送并合入到远程仓库，</p>
<p>在没有冲突的情况下，当拉取远程提交记录到本地并变基时，会将本地提交记录节点移动到更新的远程记录之后。常用于同步最新代码。如果无法处理好解冲突操作，请使用后面的cherrypick方式来同步。</p>
]]></content>
  </entry>
  <entry>
    <title>git</title>
    <url>/want/2019/01/14/git/</url>
    <content><![CDATA[<h3 id="下载安装GIT"><a href="#下载安装GIT" class="headerlink" title="下载安装GIT"></a>下载安装<a href="https://git-scm.com/" target="_blank" rel="noopener">GIT</a></h3><h3 id="查看用户名和邮箱"><a href="#查看用户名和邮箱" class="headerlink" title="查看用户名和邮箱"></a>查看用户名和邮箱</h3><p>用户名和邮箱地址是本地git客户端的一个变量，不随git库而改变。每次commit都会用用户名和邮箱纪录。github的contributions统计就是按邮箱来统计的。</p>
<ul>
<li>git config user.name</li>
<li>git config user.email</li>
</ul>
<h3 id="配置用户名和邮箱"><a href="#配置用户名和邮箱" class="headerlink" title="配置用户名和邮箱"></a>配置用户名和邮箱</h3><ul>
<li><p>git config –global user.name “username”</p>
</li>
<li><p>git config –global user.email “<a href="mailto:username@example.com" target="_blank" rel="noopener">username@example.com</a>“</p>
</li>
</ul>
<p>如果不想让别人知道自己的邮箱地址，可以如下配置：</p>
<ul>
<li>github - 个人头像 - settings - emails -Keep my email address private</li>
<li>git config –global user.email “<a href="mailto:username@users.noreply.github.com" target="_blank" rel="noopener">username@users.noreply.github.com</a>“</li>
</ul>
<h3 id="配置SSH-KEY"><a href="#配置SSH-KEY" class="headerlink" title="配置SSH KEY"></a>配置SSH KEY</h3><h4 id="id-rsa-pub"><a href="#id-rsa-pub" class="headerlink" title="id_rsa.pub"></a>id_rsa.pub</h4><p>作用：建立本地和服务器的连接</p>
<p>步骤：</p>
<ol>
<li>是否既存：ls -al ~/.ssh</li>
<li>生成新KEY：ssh-keygen -t rsa -C “<a href="mailto:your_email@example.com" target="_blank" rel="noopener">your_email@example.com</a>“</li>
<li><p>配置：</p>
<ul>
<li>打开用户目录，找到.ssh\id_rsa.pub文件。复制内容</li>
<li>打开github主页，进入个人设置 -&gt; SSH and GPG keys -&gt; New SSH key。 粘贴内容</li>
</ul>
</li>
<li><p>校验是否成功：ssh -T <a href="mailto:git@github.com" target="_blank" rel="noopener">git@github.com</a></p>
</li>
</ol>
<h4 id="known-hosts"><a href="#known-hosts" class="headerlink" title="known_hosts"></a>known_hosts</h4><p>当客户端通过SSH连接服务器时，会将服务器信息保存在.ssh/known_hosts文件中。</p>
<p>如果服务器被重装/被替换 等，导致服务器端信息改变（IP或域名），与之前known_hosts文所保存的信息不一致，则导致密钥认证失败。</p>
<p>解决：</p>
<ol>
<li><p>命令行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -R hostname</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动删除<br> 文本编辑器打开～/.ssh/known_hosts，删掉hostname对应的行（行首）</p>
</li>
</ol>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://www.jianshu.com/p/7b5702d3f072" target="_blank" rel="noopener">GitHub+Hexo（NexT主题）搭建博客</a></li>
<li><a href="https://www.cnblogs.com/lfr0123/p/13477001.html" target="_blank" rel="noopener">同一台电脑同时使用gitHub和gitLab - 给你一页白纸 - 博客园 (cnblogs.com)</a></li>
</ol>
]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>https</title>
    <url>/want/2019/06/06/https/</url>
    <content><![CDATA[<h3 id="keytool-创建证书"><a href="#keytool-创建证书" class="headerlink" title="keytool 创建证书"></a>keytool 创建证书</h3><ol>
<li><p>keytool 是jdk自带的可执行文件，路径Program Files\Java\jdk1.8.0_201\bin\keytool.exe</p>
</li>
<li><p><code>keytool -genkey -alias tomcat -keyalg RSA -keystore D:\learn.keystore</code></p>
<ul>
<li><p>需在keytool.exe所在路径执行</p>
</li>
<li><p>-keystore, 指定生成位置。如果C盘可能没有权限。</p>
</li>
</ul>
</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">PS Program Files\Java\jdk1.<span class="number">8.0</span>_201\bin&gt; keytool <span class="literal">-genkey</span> <span class="literal">-alias</span> tomcat <span class="literal">-keyalg</span> RSA <span class="literal">-keystore</span> D:\learn.keystore</span><br><span class="line">输入密钥库口令:<span class="number">123456</span></span><br><span class="line">再次输入新口令:<span class="number">123456</span></span><br><span class="line">您的名字与姓氏是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">您的组织单位名称是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">您的组织名称是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">您所在的城市或区域名称是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">您所在的省/市/自治区名称是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">该单位的双字母国家/地区代码是什么?</span><br><span class="line">  [<span class="type">Unknown</span>]:</span><br><span class="line">CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown是否正确?</span><br><span class="line">  [否]:  y</span><br><span class="line"></span><br><span class="line">输入 &lt;tomcat&gt; 的密钥口令</span><br><span class="line">        (如果和密钥库口令相同, 按回车):</span><br><span class="line"></span><br><span class="line">Warning:</span><br><span class="line">JKS 密钥库使用专用格式。建议使用 <span class="string">"keytool -importkeystore -srckeystore D:\learn.keystore -destkeystore D:\learn.keystore -deststoretype pkcs12"</span> 迁移到行业标准格式 PKCS12。</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>在指定位置(D:\learn.keystore)找到证书文件</li>
</ol>
<h3 id="SpringBoot引入证书"><a href="#SpringBoot引入证书" class="headerlink" title="SpringBoot引入证书"></a>SpringBoot引入证书</h3><ol>
<li>复制证书到config文件夹</li>
<li>编辑config文件夹下的application.properties<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server.ssl.key-store=./config/learn.keystore</span><br><span class="line">server.ssl.key-store-password=123456</span><br><span class="line">server.ssl.key-store-type=JKS</span><br><span class="line"></span><br><span class="line">server.ssl.key-alias=tomcat</span><br><span class="line">server.ssl.enabled=true</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="SpringBoot使用证书"><a href="#SpringBoot使用证书" class="headerlink" title="SpringBoot使用证书"></a>SpringBoot使用证书</h3><p>在<strong>启动类</strong>进行配置：</p>
<h4 id="1-springboot2-X写法"><a href="#1-springboot2-X写法" class="headerlink" title="1. springboot2.X写法"></a>1. springboot2.X写法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpsApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">servletContainer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        TomcatServletWebServerFactory tomcat=<span class="keyword">new</span> TomcatServletWebServerFactory()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                SecurityConstraint securityConstraint=<span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">                securityConstraint.setUserConstraint(<span class="string">"CONFIDENTIAL"</span>);</span><br><span class="line">                SecurityCollection collection=<span class="keyword">new</span> SecurityCollection();</span><br><span class="line">                collection.addPattern(<span class="string">"/*"</span>);</span><br><span class="line">                securityConstraint.addCollection(collection);</span><br><span class="line">                context.addConstraint(securityConstraint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> tomcat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HttpsApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你想输入http的url地址，然后<strong>自动跳转</strong>到https的url地址，可以增加如下代码：</p>
<p>输入 <a href="http://localhost:9999/user，浏览器会自动跳转到" target="_blank" rel="noopener">http://localhost:9999/user，浏览器会自动跳转到</a> <a href="https://localhost/user" target="_blank" rel="noopener">https://localhost/user</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpsApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connector <span class="title">connector</span><span class="params">()</span></span>&#123; <span class="comment">// 自动跳转配置</span></span><br><span class="line">        Connector connector=<span class="keyword">new</span> Connector(<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</span><br><span class="line">        connector.setScheme(<span class="string">"http"</span>);	<span class="comment">// 输入http地址</span></span><br><span class="line">        connector.setPort(<span class="number">9999</span>);		<span class="comment">// http地址的端口号</span></span><br><span class="line">        connector.setSecure(<span class="keyword">false</span>);		</span><br><span class="line">        connector.setRedirectPort(<span class="number">443</span>);	<span class="comment">// 自动跳转到https地址的端口号</span></span><br><span class="line">        <span class="keyword">return</span> connector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">servletContainer</span><span class="params">(Connector connector)</span></span>&#123;</span><br><span class="line">        TomcatServletWebServerFactory tomcat=<span class="keyword">new</span> TomcatServletWebServerFactory()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">                SecurityConstraint securityConstraint=<span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">                securityConstraint.setUserConstraint(<span class="string">"CONFIDENTIAL"</span>);</span><br><span class="line">                SecurityCollection collection=<span class="keyword">new</span> SecurityCollection();</span><br><span class="line">                collection.addPattern(<span class="string">"/*"</span>);</span><br><span class="line">                securityConstraint.addCollection(collection);</span><br><span class="line">                context.addConstraint(securityConstraint);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        tomcat.addAdditionalTomcatConnectors(connector); <span class="comment">// 自动跳转引用</span></span><br><span class="line">        <span class="keyword">return</span> tomcat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HttpsApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-低于springboot2-X版本写法"><a href="#2-低于springboot2-X版本写法" class="headerlink" title="2. 低于springboot2.X版本写法"></a>2. 低于springboot2.X版本写法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EmbeddedServletContainerFactory <span class="title">servletContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    TomcatEmbeddedServletContainerFactory tomcat = <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">            SecurityConstraint securityConstraint = <span class="keyword">new</span> SecurityConstraint();</span><br><span class="line">            securityConstraint.setUserConstraint(<span class="string">"CONFIDENTIAL"</span>);<span class="comment">//confidential</span></span><br><span class="line">            SecurityCollection collection = <span class="keyword">new</span> SecurityCollection();</span><br><span class="line">            collection.addPattern(<span class="string">"/*"</span>);</span><br><span class="line">            securityConstraint.addCollection(collection);</span><br><span class="line">            context.addConstraint(securityConstraint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> tomcat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Https访问"><a href="#Https访问" class="headerlink" title="Https访问"></a>Https访问</h3><p>此时采用http访问<a href="http://localhost:9999/user" target="_blank" rel="noopener">http://localhost:9999/user</a><br>会出现错误提示：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Bad Request</span><br><span class="line">This combination of host and port requires TLS.</span><br></pre></td></tr></table></figure></p>
<p>采用<strong>https</strong>访问<a href="https://localhost:9999/user" target="_blank" rel="noopener">https://localhost:9999/user</a></p>
<p>如果会出现不安全等提示，点击继续前往即可。</p>
]]></content>
  </entry>
  <entry>
    <title>kafka</title>
    <url>/want/2020/08/16/kafka/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>kafka是分布式的、基于发布/订阅模式（消费者主动拉取消息）的、消息队列（Message Queue）。</p>
<p>kafka由scala编写。</p>
<h4 id="消息队列的特点"><a href="#消息队列的特点" class="headerlink" title="消息队列的特点"></a>消息队列的特点</h4><p><strong>解耦</strong></p>
<p>生产者消息 –&gt; 消息队列 –&gt; 消费者自取</p>
<p><strong>可恢复性</strong></p>
<p>即使一个处理消息进程挂掉，【加入队列中的消息】仍然可以在系统恢复后被处理。</p>
<p><strong>缓冲</strong></p>
<p>解决生产消息和消费消息处理速度不一致的情况。</p>
<p><strong>异步通信</strong></p>
<p>提供异步处理机制，可以任意向队列放入消息，当需要的时候再处理。</p>
<p><strong>动态灵活</strong></p>
<p>任意增减机器，避免资源浪费，也可以临时应对突发压力。</p>
<h4 id="消息队列的类别"><a href="#消息队列的类别" class="headerlink" title="消息队列的类别"></a><strong>消息队列的类别</strong></h4><h5 id="一对一点对点模式"><a href="#一对一点对点模式" class="headerlink" title="一对一点对点模式"></a><strong>一对一点对点模式</strong></h5><p>【消息使用后消失】消费者主动拉取数据，获取数据后，清除消息。也就是一个消息，被消费者消费后就消失。</p>
<ol>
<li>生产者生产消息发送到队列</li>
<li>消费者从队列拉取消息</li>
<li>消息被消费了，队列不再存储而是被删除。</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200816222629229.png" alt="image-20200816222629229"></p>
<h5 id="一对多发布-订阅模式"><a href="#一对多发布-订阅模式" class="headerlink" title="一对多发布/订阅模式"></a><strong>一对多发布/订阅模式</strong></h5><p>【消息使用后不会消失】</p>
<ol>
<li>生产者生产消息发送到topic中</li>
<li>消费者订阅（消费）消息</li>
<li>发布到topic的消息会被所有订阅者消费</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200816222613621.png" alt="image-20200816222613621"></p>
<p>发布订阅模式的类型：</p>
<ol>
<li>消费者主动拉取数据（如kafka）：消费者要不断去监听（轮询）队列信息。消费者资源浪费。</li>
<li>生产者主动推送数据：消费者能力处理不足</li>
</ol>
<h4 id="kafka简介"><a href="#kafka简介" class="headerlink" title="kafka简介"></a>kafka简介</h4><h5 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h5><p>高吞吐</p>
<p><strong>生产者</strong></p>
<p><strong>消费者</strong></p>
<ol>
<li>消费者组，提高消费能力</li>
<li>同一个消费者组里面的，不能同时（只能派一个）消费某一个分区里的数据</li>
</ol>
<p><strong>kafka集群管理消息</strong></p>
<ol>
<li>broker：服务器，可以容纳多个topic。</li>
<li>topic：一类消息队列，生产者和消费者面向的都是一个topic。</li>
<li>partition分区：一个topic可以分为多个partition，使一个topic可以分到多个服务器。每个partition是一个有序队列。</li>
<li>replica：副本，为了保证集群中某个节点故障时，节点上的partition数据不丢。topic的每个分区都有若干副本。一个leader都有若干follower。</li>
<li>follower备，leader主（leader坏掉之后，某一个follower启用成为新的leader）</li>
</ol>
<p><strong>zookeeper注册消息</strong></p>
<ol>
<li>帮助<strong>kafka集群</strong>存储信息</li>
<li>帮助<strong>消费者</strong>存储信息</li>
<li>kafka依赖zookeeper</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200816224938047.png" alt="image-20200816224938047"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h4><p>kafka依赖zookeeper。前提是zookeeper启动。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zk.sh start</span><br></pre></td></tr></table></figure>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p>wget <a href="https://mirrors.bfsu.edu.cn/apache/kafka/2.6.0/kafka_2.13-2.6.0.tgz" target="_blank" rel="noopener">https://mirrors.bfsu.edu.cn/apache/kafka/2.6.0/kafka_2.13-2.6.0.tgz</a></p>
<p>寻找下载路径的过程：</p>
<ol>
<li><a href="http://kafka.apache.org/downloads" target="_blank" rel="noopener">http://kafka.apache.org/downloads</a></li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200816225928155.png" alt="image-20200816225928155"></p>
<ol start="2">
<li><a href="https://www.apache.org/dyn/closer.cgi?path=/kafka/2.6.0/kafka_2.13-2.6.0.tgz" target="_blank" rel="noopener">https://www.apache.org/dyn/closer.cgi?path=/kafka/2.6.0/kafka_2.13-2.6.0.tgz</a></li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200816231813471.png" alt="image-20200816231813471"></p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span> 解压</span><br><span class="line">tar -zxvf kafka_2.13-2.6.0.tgz</span><br><span class="line"></span><br><span class="line">cd opt/modules/kafka_2.13-2.6.0/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 重点关注config目录中的server.properties</span><br><span class="line"><span class="meta">#</span> 一般使用自己安装的单独的zookeeper，不会关注kafka自带的zookeeper.properties</span><br></pre></td></tr></table></figure>
<h5 id="server-properties"><a href="#server-properties" class="headerlink" title="server.properties"></a>server.properties</h5><p>以下为节选的重点内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim server.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> --------------------------------------------------------</span><br><span class="line"><span class="meta">#</span> 一个broker就是一台服务器，broker.id全局唯一、整数。The id of the broker. This must be set to a unique integer for each broker.</span><br><span class="line"><span class="meta">#</span> 给每个机器，设置不同的broker.id</span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>允许删除topic</span><br><span class="line">delete.topic.enable=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 是kafka暂存【数据】和日志的目录（数据和日志都存在这里）。A comma separated list of directories under which to store log files</span><br><span class="line">log.dirs=/tmp/kafka-logs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 上述kafka暂存数据（7天）168小时。The minimum age of a log file to be eligible for deletion due to age</span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置连接zookeeper集群地址，可以逗号分隔多个地址</span><br><span class="line"><span class="meta">#</span> Zookeeper connection string (see zookeeper docs for details).</span><br><span class="line"><span class="meta">#</span> This is a comma separated host:port pairs, each corresponding to a zk</span><br><span class="line"><span class="meta">#</span> server. e.g. "127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002".逗号分隔多个服务器。</span><br><span class="line"><span class="meta">#</span> You can also append an optional chroot string to the urls to specify the</span><br><span class="line"><span class="meta">#</span> root directory for all kafka znodes.</span><br><span class="line">zookeeper.connect=localhost:2181</span><br></pre></td></tr></table></figure>
<h5 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h5><p>可以方便全局使用命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">export KAFKA_HOME=/opt/module/kafka</span><br><span class="line">export PATH = $PATH:$KAFKA_HOME/bin</span><br></pre></td></tr></table></figure>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><h5 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h5><p>cd opt/modules/kafka_2.13-2.6.0/bin</p>
<ol>
<li><p>kafka-server-start.sh  启动服务</p>
</li>
<li><p>kafka-server-stop.sh  停止服务</p>
</li>
</ol>
<ol start="3">
<li><p>kafka-console-consumer.sh  仅控制台打印，用于测试环境</p>
</li>
<li><p>kafka-console-producer.sh</p>
</li>
</ol>
<ol start="5">
<li><p>kafka-consumer-perf-test.sh  消费者压力测试</p>
</li>
<li><p>kafka-producer-perf-test.sh  生产者压力测试，测试整个集群的负载能力。</p>
</li>
</ol>
<ol start="7">
<li>kafka-topics.sh  主题topic的增删改查</li>
</ol>
<h5 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h5><h6 id="依次每个机器，单节点启动"><a href="#依次每个机器，单节点启动" class="headerlink" title="依次每个机器，单节点启动"></a>依次每个机器，单节点启动</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span>直接启动，非常驻进程</span><br><span class="line">./kafka-server-start.sh ../config/server.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>守护进程，常驻启动</span><br><span class="line">./kafka-server-start.sh -daemon ../config/server.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>查看进程</span><br><span class="line">jps</span><br><span class="line">结果中会有kafka</span><br></pre></td></tr></table></figure>
<p>查看/tmp/kafka-logs/server.log日志。</p>
<h6 id="批量管理"><a href="#批量管理" class="headerlink" title="批量管理"></a>批量管理</h6><p>vim kafkaManage.sh</p>
<p>chmod 777 kafkaManage.sh</p>
<p>kafkaManage.sh stop</p>
<p>xcall.sh jps【注意xcall是Hadoop管理虚拟机脚本，批量查看各个虚拟机的jps】</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">case $1 in </span><br><span class="line">"start")&#123;</span><br><span class="line">    for i in 机器1,机器2,机器3 </span><br><span class="line">    do</span><br><span class="line">        echo "------$i--------"</span><br><span class="line">            ssh $i "/opt/modules/kafka_2.13-2.6.0/bin/kafka-server-start.sh --daemon /opt/modules/kafka_2.13-2.6.0/config/server.properties"</span><br><span class="line">    </span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line"></span><br><span class="line">"stop")&#123;</span><br><span class="line">    for i in 机器1,机器2,机器3 </span><br><span class="line">    do</span><br><span class="line">        echo "------$i--------"</span><br><span class="line">            ssh $i "/opt/modules/kafka_2.13-2.6.0/bin/kafka-server-stop.sh /opt/modules/kafka_2.13-2.6.0/config/server.properties"</span><br><span class="line">    </span><br><span class="line">    done</span><br><span class="line">&#125;;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>"status")&#123;</span><br><span class="line"><span class="meta">#</span>    for i in 机器1,机器2,机器3 </span><br><span class="line"><span class="meta">#</span>    do</span><br><span class="line"><span class="meta">#</span>        echo "------$i--------"</span><br><span class="line"><span class="meta">#</span>            ssh $i "opt/modules/zookeeper-3.4.10/bin/zkServer.sh status"</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span>    done</span><br><span class="line"><span class="meta">#</span>&#125;;;</span><br><span class="line"></span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<h4 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h4><p>topics管理</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span>查看主题列表</span><br><span class="line">kafka-topics.sh --list --zookeeper 机器1:2181</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>创建主题</span><br><span class="line">kafka-topics.sh --create --zookeeper 机器1:2181 --topic first【这个是自定义的主题名]】--partition 2【2个分区】 --replication-factor 2【2个副本】</span><br><span class="line"><span class="meta">#</span>##kafka-topics.sh --create --zookeeper 机器1:2181 --topic first【这个是自定义的主题名]】--partition 2【3个分区】 --replication-factor 2【1个副本】</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>删除主题</span><br><span class="line">kafka-topics.sh --delete --zookeeper 机器1:2181 --topic first</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>获取主题详情信息</span><br><span class="line">kafka-topics.sh --describe --zookeeper 机器1:2181 --topic first</span><br></pre></td></tr></table></figure>
<p>此时查看各个机器的日志</p>
<p>cd logs</p>
<p>可以看到各个机器的副本加起来，总共有两套</p>
<ol>
<li>first-0</li>
<li>first-1</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>lamda</title>
    <url>/want/2020/10/24/lamda/</url>
    <content><![CDATA[<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><strong>Java8 lamda（λ）表达式</strong>：使用lamda表达式可以简略去【函数式接口实现、新建内部类、实例化】这些过程，直接实现了接口抽象方法的重写和使用。</p>
<ol>
<li>替代匿名内部类。</li>
<li>避免匿名内部类定义过多</li>
<li>函数式编程。</li>
</ol>
<p><strong>适用前提</strong>：函数式接口。</p>
<blockquote>
<p>函数式接口Functional Interface：一种接口，只包含【唯一一个】抽象方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Runnable接口属于函数式接口</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>语法简化内容</strong>：</p>
<ol>
<li>省略参数类型（多个参数的数据类型，要么都去掉，要么都保留）</li>
<li>省略参数小括号（仅一个参数适用）。</li>
<li>省略方法体（仅一句代码适用，JS箭头函数要求仅一句且作为返回值时省略，lamda表达式不考虑返回值）。</li>
</ol>
<h3 id="用途示例"><a href="#用途示例" class="headerlink" title="用途示例"></a>用途示例</h3><p>JS箭头函数，是方法的简写，省略了function、作用域挂在直属父类对象，方法匿不匿名均可。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add = <span class="function">(<span class="params">x, y</span>) =&gt;</span> x + y</span><br></pre></td></tr></table></figure>
<p>lamda表达式，是对【实现implement 函数式接口的类A，实例化类A，调用A实例方法】这整个过程的简写，是对匿名类实例化方法调用的简写。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LamdaTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 原生写法，非匿名类</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">PersonLove</span> <span class="keyword">implements</span> <span class="title">ILove</span> </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">heart</span><span class="params">()</span></span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"人类的爱，加入了心的元素"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> PersonLove().heart();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 原生写法，new ILove 是个匿名类（直接函数式接口实现、实例化）</span></span><br><span class="line">        ILove love = <span class="keyword">new</span> ILove() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">heart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"心动，动心"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        love.heart();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// lamda表达式，简略去了【函数式接口实现、新建内部类、实例化】这些过程，表面上实现了接口抽象方法的直接实现和使用</span></span><br><span class="line">        ILove loveLamda = () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"爱，动心，让心活、让心死"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        loveLamda.heart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILove</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heart</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="语法示例"><a href="#语法示例" class="headerlink" title="语法示例"></a>语法示例</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 语法示例</span></span><br><span class="line"><span class="comment"> * 省略参数类型</span></span><br><span class="line"><span class="comment"> * 省略参数小括号（仅一个参数适用）</span></span><br><span class="line"><span class="comment"> * 省略方法体（仅一句代码适用，当箭头函数时，仅有一句且作为返回值时省略，lamda表达式不考虑返回值）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LamdaTestProgram</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 省略参数类型,省略方法体</span></span><br><span class="line">        IPoeam poeam = (author, title) -&gt; System.out.println(author + <span class="string">"写了诗："</span> + title);</span><br><span class="line">        poeam.write(<span class="string">"李白"</span>, <span class="string">"燕歌行"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 不省略</span></span><br><span class="line">        IPoeam poeam1 = (String author, String title) -&gt; &#123;</span><br><span class="line">            System.out.println(author + <span class="string">"写了诗："</span> + title);</span><br><span class="line">            System.out.println(author + <span class="string">"诗里的命运是国家的命运"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        poeam1.write(<span class="string">"杜甫"</span>, <span class="string">"望岳"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 省略参数小括号</span></span><br><span class="line">        IBook book = title -&gt; System.out.println(<span class="string">"最近读了一本书："</span> + title);</span><br><span class="line">        book.read(<span class="string">"大宋帝国三百年"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPoeam</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(String author, String title)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBook</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(String title)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>markdown</title>
    <url>/want/2018/11/02/markdown/</url>
    <content><![CDATA[<p><a href="https://hexo.io/docs/" target="_blank" rel="noopener">hexo官网</a></p>
<p><a href="https://www.liuyude.com/How_to_make_your_HEXO_blog_support_handwriting_flowchart.html" target="_blank" rel="noopener">如何让你的HEXO博客支持手写流程图？</a></p>
<p><a href="https://mermaidjs.github.io/" target="_blank" rel="noopener">绘图工具mermaid</a></p>
<p><a href="https://www.jianshu.com/p/af48cc77b57a" target="_blank" rel="noopener">Typora中使用流程图mermaid</a></p>
<p><a href="https://www.jianshu.com/p/56d99a3049a5" target="_blank" rel="noopener">Hexo 和 Markdown 的使用规则</a></p>
<p><a href="http://www.namidame.tech/2017/04/01/Hexo+GitHub%E6%9E%84%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" target="_blank" rel="noopener">Hexo+GitHub构建个人博客</a></p>
]]></content>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>加密</title>
    <url>/want/2019/08/21/%E5%8A%A0%E5%AF%86/</url>
    <content><![CDATA[<h3 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h3><h4 id="前端crypto-js"><a href="#前端crypto-js" class="headerlink" title="前端crypto-js"></a>前端crypto-js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> CryptoJS <span class="keyword">from</span> <span class="string">'crypto-js'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> AES = &#123;</span><br><span class="line">  key: <span class="string">'1234567890123456'</span>, <span class="comment">// 必须16个字符</span></span><br><span class="line">  iv: <span class="string">'1234567890123456'</span>, <span class="comment">// 必须16个字符</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">  encrypt(str) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!str) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> key = CryptoJS.enc.Utf8.parse(AES.key);</span><br><span class="line">    <span class="keyword">const</span> iv = CryptoJS.enc.Utf8.parse(AES.iv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> encryptStr = CryptoJS.enc.Utf8.parse(str);</span><br><span class="line">    <span class="keyword">const</span> encrypted = CryptoJS.AES.encrypt(encryptStr, key, &#123;</span><br><span class="line">      iv,</span><br><span class="line">      mode: CryptoJS.mode.CBC,</span><br><span class="line">      padding: CryptoJS.pad.Pkcs7,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> CryptoJS.enc.Base64.stringify(encrypted.ciphertext);</span><br><span class="line">  &#125;,</span><br><span class="line">  decrypt(str) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!str) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> key = CryptoJS.enc.Utf8.parse(AES.key);</span><br><span class="line">    <span class="keyword">const</span> iv = CryptoJS.enc.Utf8.parse(AES.iv);</span><br><span class="line">    <span class="keyword">const</span> bytes = CryptoJS.AES.decrypt(str, key, &#123;</span><br><span class="line">      iv,</span><br><span class="line">      mode: CryptoJS.mode.CBC,</span><br><span class="line">      padding: CryptoJS.pad.Pkcs7,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CryptoJS.enc.Utf8.stringify(bytes);</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">PTUtil.decrypt(phoneNumber),</span><br><span class="line">PTUtil.encrypt(<span class="string">'18896713000'</span>),</span><br></pre></td></tr></table></figure>
<h4 id="后端Cipher"><a href="#后端Cipher" class="headerlink" title="后端Cipher"></a>后端Cipher</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.IvParameterSpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncryptUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY = <span class="string">"1234567890123456"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IV = <span class="string">"1234567890123456"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCRY_ALGORITHM = <span class="string">"AES"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CIPHER_MODE = <span class="string">"AES/CBC/PKCS5Padding"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHARACTER = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] clearTextBytes) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1 获取加密密钥</span></span><br><span class="line">            SecretKeySpec keySpec = <span class="keyword">new</span> SecretKeySpec(KEY.getBytes(), ENCRY_ALGORITHM);</span><br><span class="line">            IvParameterSpec ivSpec = <span class="keyword">new</span> IvParameterSpec(IV.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2 获取Cipher实例</span></span><br><span class="line">            Cipher cipher = Cipher.getInstance(CIPHER_MODE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3 初始化Cipher实例。设置执行模式以及加密密钥</span></span><br><span class="line">            cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> cipher.doFinal(clearTextBytes);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">encryptBase64</span><span class="params">(String clearText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1 获取加密密文字节数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] cipherTextBytes = encrypt(clearText.getBytes(CHARACTER));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2 对密文字节数组进行BASE64 encoder 得到 BASE6输出的密文</span></span><br><span class="line">            BASE64Encoder base64Encoder = <span class="keyword">new</span> BASE64Encoder();</span><br><span class="line">            String cipherText = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (cipherTextBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cipherText = base64Encoder.encode(cipherTextBytes);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3 返回BASE64输出的密文</span></span><br><span class="line">            <span class="keyword">return</span> cipherText;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] cipherTextBytes) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1 获取解密密钥</span></span><br><span class="line">            SecretKeySpec keySpec = <span class="keyword">new</span> SecretKeySpec(KEY.getBytes(), ENCRY_ALGORITHM);</span><br><span class="line">            IvParameterSpec ivSpec = <span class="keyword">new</span> IvParameterSpec(IV.getBytes());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2 获取Cipher实例</span></span><br><span class="line">            Cipher cipher = Cipher.getInstance(CIPHER_MODE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3 初始化Cipher实例。设置执行模式以及加密密钥</span></span><br><span class="line">            cipher.init(Cipher.DECRYPT_MODE, keySpec, ivSpec);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4 执行</span></span><br><span class="line">            <span class="keyword">return</span> cipher.doFinal(cipherTextBytes);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decryptBase64</span><span class="params">(String cipherText)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1 对 BASE64输出的密文进行BASE64 decodebuffer 得到密文字节数组</span></span><br><span class="line">            BASE64Decoder base64Decoder = <span class="keyword">new</span> BASE64Decoder();</span><br><span class="line">            <span class="keyword">byte</span>[] cipherTextBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (cipherText != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cipherTextBytes = base64Decoder.decodeBuffer(cipherText);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2 对密文字节数组进行解密 得到明文字节数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] clearTextBytes = decrypt(cipherTextBytes);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3 根据 CHARACTER 转码，返回明文字符串</span></span><br><span class="line">            <span class="keyword">if</span> (clearTextBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> String(clearTextBytes, CHARACTER);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br></pre></td></tr></table></figure>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">EncryptUtil.decryptBase64(user.getPhoneNumber()));</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>小诗</title>
    <url>/want/2018/09/28/%E5%8D%97%E4%BA%AC%E9%87%8D%E6%B8%B8/</url>
    <content><![CDATA[<h3 id="南京重逢"><a href="#南京重逢" class="headerlink" title="南京重逢"></a>南京重逢</h3><p>粉丝汤包作故旧，<br>梧桐叶里过春秋。<br>多少年小友，<br>多少年少游，<br>无恩怨，不留情。</p>
<p>——2018</p>
<h3 id="异"><a href="#异" class="headerlink" title="异"></a>异</h3><p>若干少年，习于课堂。<br>异族袭来，同化众人。<br>有少年2人，以残布，以木板，使灵力，得飞天。<br>摆脱大数，立于孤塔，暂得喘息。</p>
<p>大难暂歇<br>后有追兵，前有迷途<br>天下星尘覆灭<br>得孤塔立锥。</p>
<p>有一异人独追至。<br>心中大骇，<br>有何缘由<br>竟穷追至此。</p>
<p>仓皇而逃，<br>途遇一人，引入城镇<br>大街小巷鳞次栉比<br>东躲西藏，至穷途末路。</p>
<p>静默数时<br>不发一言<br>异，自断而亡。</p>
<p>返回见众人，还复清明。<br>唏嘘寒暄，皆曰安好。<br>问及一子，<br>答曰：她说她爱我。</p>
<p>少年心中一恸，<br>想异自断时，<br>亦眉眼温和。</p>
<p>——2020</p>
]]></content>
      <tags>
        <tag>问情</tag>
      </tags>
  </entry>
  <entry>
    <title>地图外边框</title>
    <url>/want/2019/01/03/%E5%9C%B0%E5%9B%BE%E5%A4%96%E8%BE%B9%E6%A1%86/</url>
    <content><![CDATA[<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>UI设计师出于视觉效果等考虑，会设计一些<strong>“地图外框与内框样式不同”</strong>的原型。如下图所示：<br><img src="/want/2019/01/03/地图外边框/地图红色外框.png" title="内置地图红色外框（借用参考链接1）"></p>
<p>经调研，基本没有GIS工具库可直接实现此效果。<br>Echarts间接实现的替代方案如下：</p>
<ol>
<li><p>方案1：利用“Echarts内置矢量地图”作为底图</p>
<ul>
<li>思路：两层地图叠加，底层地图（geo）设置外框效果，顶层地图设置内框效果，且顶层地图略小于底层地图</li>
<li>优点：没有多余地图信息，贴合UI视觉效果(样式如上图所示)</li>
<li>缺点：①地图不能自由缩放（必须roam = false保证两层地图同步大小）②额外渲染了一层地图③地理位置信息不精确，见如下<a href="http://ecomfe.github.io/echarts-map-tool/" target="_blank" rel="noopener">官网</a>通告:<blockquote>
<p>ECharts 之前提供下载的矢量地图数据来自第三方，由于部分数据不符合国家《测绘法》规定，目前暂时停止下载服务。<br>建议大家使用以百度地图为底图的形式，参考实例：<a href="http://echarts.baidu.com/demo.html#map-polygon" target="_blank" rel="noopener">http://echarts.baidu.com/demo.html#map-polygon</a></p>
</blockquote>
</li>
</ul>
</li>
<li><p>方案2：利用“百度地图Bmap”作为底图</p>
<ul>
<li>思路：将百度地图bmap融入Echarts</li>
<li>优点：可自由设置边界，可缩放，位置精确</li>
<li>缺点：①有多余的地图信息（可通过设置百度地图样式尽量精简）②选中内部区域块困难</li>
<li>样式：<img src="/want/2019/01/03/地图外边框/地图蓝色外框动图.gif" title="百度地图蓝色外框">
</li>
</ul>
</li>
</ol>
<h3 id="方案1：-利用“Echarts内置矢量地图”作为底图"><a href="#方案1：-利用“Echarts内置矢量地图”作为底图" class="headerlink" title="方案1： 利用“Echarts内置矢量地图”作为底图"></a>方案1： 利用“Echarts内置矢量地图”作为底图</h3><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>两层地图叠加，底层地图（geo）设置外框效果，上层地图设置内框效果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">option = &#123;</span><br><span class="line">    <span class="comment">//底层图</span></span><br><span class="line">    geo: &#123;</span><br><span class="line">        map: <span class="string">'china'</span>,</span><br><span class="line">        roam: <span class="literal">false</span>,</span><br><span class="line">        itemStyle: &#123;</span><br><span class="line">            normal: &#123;&#125;，</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    series: [</span><br><span class="line">    <span class="comment">// 上层图</span></span><br><span class="line">    	&#123;</span><br><span class="line">            type: <span class="string">'map'</span>,</span><br><span class="line">            map: <span class="string">'china'</span>,</span><br><span class="line">            geoIndex: <span class="number">1</span>, <span class="comment">//关联底层图</span></span><br><span class="line">            aspectScale: <span class="number">0.75</span>, <span class="comment">//长宽比</span></span><br><span class="line"></span><br><span class="line">            roam: <span class="literal">false</span>,</span><br><span class="line">            itemStyle: &#123;</span><br><span class="line">                normal: &#123;&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">    	&#125;，</span><br><span class="line">    ]，</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><ol>
<li><a href="http://gallery.echartsjs.com/editor.html?c=xSyQLFiTrf" target="_blank" rel="noopener">中国地图边境加阴影</a></li>
<li><a href="https://segmentfault.com/a/1190000016522234" target="_blank" rel="noopener">echartsmap地图设置外边框或者阴影</a></li>
<li><a href="https://blog.csdn.net/super_DuoLa/article/details/83026115" target="_blank" rel="noopener">给地图的外边框加阴影(给地图的外边框设置与内边框不同的颜色)</a></li>
</ol>
<h3 id="方案2：利用“百度地图Bmap”作为底图"><a href="#方案2：利用“百度地图Bmap”作为底图" class="headerlink" title="方案2：利用“百度地图Bmap”作为底图"></a>方案2：利用“百度地图Bmap”作为底图</h3><h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><h5 id="百度底图绘制行政边界的核心方法"><a href="#百度底图绘制行政边界的核心方法" class="headerlink" title="百度底图绘制行政边界的核心方法"></a>百度底图绘制行政边界的核心方法</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">drawBoundary() &#123;</span><br><span class="line">  <span class="comment">// name:行政区域（省/直辖市/地级市/县）中文名，eg.北京，黑龙江，南京，高淳</span></span><br><span class="line">  <span class="keyword">const</span> &#123; map, name &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">const</span> bounds = <span class="keyword">new</span> BMap.Boundary();</span><br><span class="line">  bounds.get(name, (rs) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> count = rs.boundaries.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> ply = <span class="keyword">new</span> BMap.Polygon(rs.boundaries[i], BOUNDARY_STYLE);</span><br><span class="line">      map.addOverlay(ply);</span><br><span class="line">      map.setViewport(ply.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="使用bmap-js实现Echarts融合百度地图"><a href="#使用bmap-js实现Echarts融合百度地图" class="headerlink" title="使用bmap.js实现Echarts融合百度地图"></a>使用bmap.js实现Echarts融合百度地图</h5><p>bmap.js 是一个基于echart3的百度地图扩展文件，使用过程如下：</p>
<ol>
<li>下载引用bmap.js</li>
<li>在echarts option中配置bmap<ul>
<li>bmap提供四项基本配置：center、zoom、roam、mapStyle</li>
<li>bmap高级配置与百度地图API一致：<ul>
<li>var map = myChart.getModel().getComponent(‘bmap’).getBMap(); // 获取地图实例</li>
<li>map.addControl(new BMap.NavigationControl()); // 使用百度API</li>
</ul>
</li>
</ul>
</li>
<li>将bmap作为底图引入： coordinateSystem: ‘bmap’<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html style=<span class="string">"height: 100%"</span>&gt;</span><br><span class="line">&lt;body style=<span class="string">"height: 100%; margin: 0"</span>&gt;</span><br><span class="line">    &lt;div id=<span class="string">"container"</span> style=<span class="string">"height: 100%"</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script type="text/</span>javascript<span class="string">" src="</span>http:<span class="comment">//echarts.baidu.com/gallery/vendors/echarts/echarts.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"https://api.map.baidu.com/api?v=2.0&amp;ak=ZUONbpqGBsYGXNIYHicvbAbM"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script type="text/</span>javascript<span class="string">" src="</span>http:<span class="comment">//echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        <span class="keyword">var</span> dom = <span class="built_in">document</span>.getElementById(<span class="string">"container"</span>);</span><br><span class="line">        <span class="keyword">var</span> myChart = echarts.init(dom);</span><br><span class="line">        <span class="keyword">const</span> MAP_STYLE = &#123;<span class="attr">styleJson</span>: [],&#125;;</span><br><span class="line">        <span class="keyword">const</span> MAP_BOUNDARY_STYLE = &#123;</span><br><span class="line">            strokeWeight: <span class="number">2</span>,</span><br><span class="line">            strokeColor: <span class="string">'#30A0FF'</span>,</span><br><span class="line">            fillOpacity: <span class="number">0.1</span>,</span><br><span class="line">            fillColor: <span class="string">'none'</span>,</span><br><span class="line">            enableMassClear: <span class="literal">false</span>,</span><br><span class="line">            enableClicking: <span class="literal">false</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">renderItem</span>(<span class="params">params, api</span>) </span>&#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> option = &#123;</span><br><span class="line">            bmap: &#123; <span class="comment">// 百度地图</span></span><br><span class="line">                center: [<span class="number">116.404</span>, <span class="number">39.915</span>],</span><br><span class="line">                zoom: <span class="number">8</span>,</span><br><span class="line">                roam: <span class="literal">true</span>,</span><br><span class="line">                mapStyle: MAP_STYLE,</span><br><span class="line">            &#125;,</span><br><span class="line">            series: [</span><br><span class="line">                &#123;</span><br><span class="line">                    type: <span class="string">'custom'</span>,</span><br><span class="line">                    coordinateSystem: <span class="string">'bmap'</span>, <span class="comment">// 关联百度地图</span></span><br><span class="line">                    renderItem: renderItem,</span><br><span class="line">                    data: [<span class="number">0</span>],</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line">        myChart.setOption(option, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 百度地图实例</span></span><br><span class="line">        <span class="keyword">var</span> map = myChart.getModel().getComponent(<span class="string">'bmap'</span>).getBMap(); </span><br><span class="line">        <span class="keyword">const</span> bounds = <span class="keyword">new</span> BMap.Boundary();</span><br><span class="line">        bounds.get(<span class="string">'北京'</span>, (rs) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> count = rs.boundaries.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> ply = <span class="keyword">new</span> BMap.Polygon(rs.boundaries[i], MAP_BOUNDARY_STYLE);</span><br><span class="line">                map.addOverlay(ply);</span><br><span class="line">                map.setViewport(ply.getPath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h4><ol>
<li><a href="https://ecomfe.github.io/echarts-examples/public/editor.html?c=map-polygon" target="_blank" rel="noopener">echarts使用bmap官网示例</a></li>
<li><a href="http://echarts.baidu.com/blog/2016/06/13/echarts-map-tutorial.html" target="_blank" rel="noopener">ECharts实现地图散点图</a></li>
<li><a href="https://www.cnblogs.com/milkmap/archive/2012/04/11/2442430.html" target="_blank" rel="noopener">如何获取行政区域的边界？</a></li>
</ol>
]]></content>
      <tags>
        <tag>echarts</tag>
        <tag>地图</tag>
      </tags>
  </entry>
  <entry>
    <title>地图栅格</title>
    <url>/want/2018/10/10/%E5%9C%B0%E5%9B%BE%E6%A0%85%E6%A0%BC/</url>
    <content><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.hhlink.com/%E7%BB%8F%E7%BA%AC%E5%BA%A6/" target="_blank" rel="noopener">经纬度距离计算工具</a></p>
]]></content>
      <tags>
        <tag>图</tag>
      </tags>
  </entry>
  <entry>
    <title>IndexedDB</title>
    <url>/want/2019/01/16/IndexedDB/</url>
    <content><![CDATA[<h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>一个基于浏览器的<strong>key-value</strong> 数据库。</p>
<p><strong>使用情景</strong>：</p>
<ol>
<li>需存储大量数据</li>
<li>需额外“加工”数据</li>
</ol>
<p><strong>特点</strong>：</p>
<ol>
<li>支持事务</li>
<li>异步API——注意使用 promise / generator / async 等封装<ul>
<li>虽然提供了同步API，但浏览器支持不好（最好和webworkers结合使用）。 </li>
</ul>
</li>
</ol>
<p><strong>基本使用过程</strong>：</p>
<ol>
<li>打开数据库。</li>
<li>创建对象仓库（object store）。</li>
<li>创建事务，执行一些数据库操作(增删改查)。</li>
<li>监听事件，等待数据库操作完成。</li>
<li>拿到操作结果。</li>
</ol>
<p><strong>存储概念模型</strong>：</p>
<pre class="mermaid">graph TD
A(database /数据库/) --- B(object stores /表/)
B --- C(object store /行/)
C --- E(keyPath 或 autoIncrement /主键/)
C --- D(index /索引/)
C --- F(值)
D -.源自.- F

F --- F1(string)
F --- F4(array)
F --- F6(blob)
F --- F7(file)
F --- F5(date)
F --- F2(number)
F --- F3(object)</pre>

<h3 id="基本方法-属性"><a href="#基本方法-属性" class="headerlink" title="基本方法/属性"></a>基本方法/属性</h3><pre class="mermaid">graph TD
A1(IDBFactory) ==> B1(open)
   B1 ==> A2(IDBRequest)

   A2 -.- B21(onerror)
   A2 -.- B22(onsuccess)
   A2 -.- B23(onupgradeneeded)

   B22 ==> B2(success & event.target.result)
   B23 ==> B2
   B2 ==> A3(IDBDatabase)

   A3 ==> B3(createObjectStore)
   B3 ==> A4(IDBObjectStore)

   A3 ==> B4(transaction)
   B4 ==> A5(IDBTransaction)

   A5 ==> B5(objectStore)
   B5 ==> A4

   A4 ==> B6(index)
   B6 ==> A6(IDBIndex)

   A4 ==> B7(openCursor)
   B7 ==> A7(IDBCursor)

   style A1 fill: orange
   style A2 fill: orange
   style A3 fill: orange
   style A4 fill: orange
   style A5 fill: orange
   style A6 fill: orange
   style A7 fill: orange</pre>

<h3 id="objectStore"><a href="#objectStore" class="headerlink" title="objectStore"></a>objectStore</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>主键</p>
<table>
<thead>
<tr>
<th>键类型</th>
<th>存储数据</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>不使用</td>
<td>任意类型的值。但每添加一条数据，都需额外指定“键”</td>
<td>db.createObjectStore(‘students’)</td>
</tr>
<tr>
<td>keyPath</td>
<td>Javascript对象，且对象必须有一属性与keyPath同名。</td>
<td>db.createObjectStore(‘students’,{keyPath:”id”});</td>
</tr>
<tr>
<td>keyGenerator</td>
<td>任意类型的值。会自动生成键。</td>
<td>db.createObjectStore(‘students’,{autoIncrement: true});</td>
</tr>
<tr>
<td>都使用</td>
<td>Javascript对象。如果对象中有keyPath指定的属性则不生成新的键值。</td>
<td>db.createObjectStore(‘students’,{keyPath:”id”, autoIncrement: true});</td>
</tr>
</tbody>
</table>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>方法应和事务结合使用。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>add(data)</td>
<td>增加数据。</td>
</tr>
<tr>
<td>put(data, key?)</td>
<td>增加 / 修改数据</td>
</tr>
<tr>
<td>get(key)</td>
<td>获取数据。</td>
</tr>
<tr>
<td>getAll()</td>
<td></td>
</tr>
<tr>
<td>getAll(query)</td>
<td>A key or <a href="https://developer.mozilla.org/en-US/docs/Web/API/IDBKeyRange" target="_blank" rel="noopener"><code>IDBKeyRange</code></a> to be queried</td>
</tr>
<tr>
<td>getAll(query, count)</td>
<td></td>
</tr>
<tr>
<td>getAllKeys() 参数同上</td>
<td></td>
</tr>
<tr>
<td>count(key?)</td>
<td>match the provided key or IDBKeyRange</td>
</tr>
<tr>
<td>delete(key)</td>
<td>删除数据。</td>
</tr>
<tr>
<td>clear()</td>
<td>清空全部objectStore数据。</td>
</tr>
</tbody>
</table>
<p>add 和 put 的作用类似，区别在于 put 保存数据时，如果该数据的主键在数据库中已经有相同主键的时候，则会修改数据库中对应主键的对象，而使用 add 保存数据，如果该主键已经存在，则保存失败。</p>
<h3 id="游标-Cursor"><a href="#游标-Cursor" class="headerlink" title="游标-Cursor"></a>游标-Cursor</h3><p>游标，可获取区间数据。</p>
<ul>
<li>openCursor(range, next)    获取符合条件的整个对象</li>
<li>openKeyCursor(range, next)    获取符合条件的记录的那个keyPath值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">不传参，则获取object store所有记录</span><br></pre></td></tr></table></figure>
<p>其中range的取值如下：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">range值可为<span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三个参数为true，则不包含最小键值；第四参数为true，则不包含最大键值。默认都为false</span></span><br><span class="line"><span class="keyword">var</span> boundRange = IDBKeyRange.bound(<span class="string">'bill'</span>, <span class="string">'donna'</span>, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> onlyRange = IDBKeyRange.only(<span class="string">'donna'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个参数可选，为true则表示不包含最小主键，默认为false</span></span><br><span class="line"><span class="keyword">var</span> lowerRange = IDBKeyRange.lowerBound(<span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个参数可选，为true则表示不包含最大主键，默认为false</span></span><br><span class="line"><span class="keyword">var</span> upperRange = IDBKeyRange.upperBound(<span class="number">10</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>next的取值如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">next : 主键值升序，主键值相等的数据都被读取</span><br><span class="line">nextunique : 主键值升序，主键值相等只读取第一条数据</span><br><span class="line">prev : 主键值降序，主键值相等的数据都被读取</span><br><span class="line">prevunique : 主键值降序，主键值相等只读取第一条数据</span><br></pre></td></tr></table></figure></p>
<p>拿到cursor数据后，可进行如下操作：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line">cursor.update(&#123;</span><br><span class="line">    userId : cursor.key,</span><br><span class="line">    userName : <span class="string">'Hello'</span>,</span><br><span class="line">    age : <span class="number">18</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line">cursor.delete();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继续读取下一条</span></span><br><span class="line">cursor.continue();</span><br><span class="line"></span><br><span class="line">cursor.value</span><br><span class="line">cursor.primaryKey</span><br></pre></td></tr></table></figure></p>
<h3 id="索引-Index"><a href="#索引-Index" class="headerlink" title="索引-Index"></a>索引-Index</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">createIndex(indexName, property, &#123;unique: false &#125;)</span><br><span class="line">var index = store.index(indexName);</span><br><span class="line">var data = index.get(indexNameValue)</span><br></pre></td></tr></table></figure>
<p>多个store，游标和索引示例：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> request = <span class="built_in">window</span>.indexedDB.open(<span class="string">"database"</span>, <span class="number">1</span>);</span><br><span class="line">request.onsuccess = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> db = request.result;</span><br><span class="line">    <span class="keyword">const</span> transaction = db.transaction(</span><br><span class="line">        [<span class="string">'invoices'</span>, <span class="string">'invoice-items'</span>],</span><br><span class="line">        <span class="string">'readwrite'</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> invStore = transaction.objectStore(<span class="string">'invoices'</span>);</span><br><span class="line">    <span class="keyword">const</span> invItemStore = transaction.objectStore(<span class="string">'invoice-items'</span>);</span><br><span class="line">    <span class="comment">// Get invoice cursor</span></span><br><span class="line">    <span class="keyword">const</span> invoiceCursorRequest = invStore.index(<span class="string">'VendorIndex'</span>)</span><br><span class="line">        .openCursor(IDBKeyRange.only(<span class="string">'Frigidaire'</span>));</span><br><span class="line">    </span><br><span class="line">    invoiceCursorRequest.onsuccess = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> invCursor = e.target.result;</span><br><span class="line">        <span class="keyword">if</span> (invCursor) &#123;</span><br><span class="line">            <span class="comment">// Get invoice item cursor</span></span><br><span class="line">            <span class="keyword">const</span> invItemCursorRequest = invItemStore</span><br><span class="line">                .index(<span class="string">'InvoiceIndex'</span>)</span><br><span class="line">                .openCursor(</span><br><span class="line">                    IDBKeyRange.only(invCursor.value.invoiceId)</span><br><span class="line">                );</span><br><span class="line">            invItemCursorRequest.onsuccess = <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> invItemCursor = e.target.result;</span><br><span class="line">                <span class="keyword">if</span> (invItemCursor) &#123;</span><br><span class="line">                    invItemCursor.delete();</span><br><span class="line">                    invItemCursor.continue();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            invCursor.delete();</span><br><span class="line">            invCursor.continue();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>进行数据操作都需要事务。</p>
<p>事务定义：db.transaction(arg1, arg2)</p>
<ul>
<li>arg1：objectStoreName的字符串 或 objectStoreName字符串数组。</li>
<li>arg2 :  readonly，readwrite，verionchange</li>
</ul>
<p>事务的三种操作模式：</p>
<ol>
<li>只读：readonly，可并发执行</li>
<li>读写：readwrite</li>
<li>版本变更：verionchange</li>
</ol>
<p>事务的返回结果：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> transaction=db.transaction([<span class="string">'students'</span>,<span class="string">'teacher'</span>], <span class="string">'readwrite'</span>);</span><br><span class="line"><span class="keyword">var</span> objectStore=transaction.objectStore(<span class="string">'students'</span>); <span class="comment">//获取students数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对数据进行操作</span></span><br><span class="line"></span><br><span class="line">transaction.oncomplete(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br><span class="line">transaction.onerror(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br><span class="line">transaction.onabort(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="版本更新"><a href="#版本更新" class="headerlink" title="版本更新"></a>版本更新</h3><p>版本更新原理</p>
<pre class="mermaid">graph LR
A[Open request] --> B{Version higher?}
 B -->|Yes| C[Upgrade] 
 B -->|No| D[Open]</pre>

<h3 id="查询慢的解决方案"><a href="#查询慢的解决方案" class="headerlink" title="查询慢的解决方案"></a>查询慢的解决方案</h3><p>如果数据量过大，indexedDB查询很慢，可在indexedDB之上， 再建索引——将key存储在localStorage中。</p>
<p>注意：需要做好key的同步增删工作。</p>
<pre class="mermaid">graph LR
A(查询) --Key--- B(localStorage/只存keys/)
    B --- C{存在Key?}
    C --- | yes | D(查询indexedDB)
    C --- | no| E(结束)</pre>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>遵循“同源策略same-origin”（不能跨域）。即存储的数据只能在当前域名或其子域下使用</li>
<li>浏览器“隐私模式/无痕浏览”下不可用。</li>
<li>用户手动清除浏览器缓存时，会清除IndexedDB相关数据。</li>
<li>储存空间：</li>
</ol>
<table>
<thead>
<tr>
<th>浏览器</th>
<th>限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chrome</td>
<td>可用空间 &lt;20%</td>
</tr>
<tr>
<td>Firebox</td>
<td>没有限制。会针对超过50MB（可在 dom.indexedDB.warningQuota 首选项自定义）的Blob请求权限</td>
</tr>
<tr>
<td>Safari</td>
<td>&lt; 50MB</td>
</tr>
<tr>
<td>IE10</td>
<td>&lt; 250MB</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>浏览器</th>
<th>自动逐出政策</th>
</tr>
</thead>
<tbody>
<tr>
<td>Chrome</td>
<td>在 Chrome 耗尽空间后采用 LRU 策略</td>
</tr>
<tr>
<td>Firebox</td>
<td>在整个磁盘已装满时采用 LRU 策略</td>
</tr>
<tr>
<td>Safari</td>
<td>无逐出</td>
</tr>
<tr>
<td>Edge</td>
<td>无逐出</td>
</tr>
</tbody>
</table>
<blockquote>
<p>LRU策略：</p>
<ul>
<li>当可用磁盘填满，磁盘容量管理器将会根据 LRU 策略清理数据 。</li>
<li>LRU（Least Recently Used）: 在内存中，最近最少使用的数据块将会被优先删除，直到浏览器不再超过限额。</li>
</ul>
</blockquote>
<h3 id="npm封装插件"><a href="#npm封装插件" class="headerlink" title="npm封装插件"></a>npm封装插件</h3><p><a href="https://www.npmjs.com/package/idb" target="_blank" rel="noopener">idb: IndexedDB Promised</a></p>
<h3 id="其他存储类型"><a href="#其他存储类型" class="headerlink" title="其他存储类型"></a>其他存储类型</h3><h4 id="内存数据"><a href="#内存数据" class="headerlink" title="内存数据"></a>内存数据</h4><p>变量存储在内存中，是常见的内存数据。</p>
<p>在react+ redux框架中，常见变量存储机制有props， state。当全局变量（reducer props）较多时，导致内存占用过多、系统变慢。这就要求前端开发人员<strong>合理分配props和state</strong>。</p>
<h4 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h4><p>cookie属性： key , value, domain, path, expires,  secure 和 httpOnly。</p>
<ul>
<li>httpOnly :  默认false。若改成true，则只能服务端读取，前端无法读取。</li>
<li>secure :  默认false。若改成true，请求服务端时除非是https，否则服务端无法读取。</li>
</ul>
<p>在cookie中查看有效期expires较为困难：</p>
<ul>
<li>调试时，通过调试工具可查看</li>
<li>代码中获取时，需在cookie值（key, value）中保存过期时间，或另建cookie，专门保存。</li>
</ul>
<p>能存储数据极少，大小4KB。</p>
<p>每次发送HTTP请求，相应域下的Cookie都会在header里传动到服务端，Cookie多了会增加数据传输的量，对性能造成影响。注意：fetch默认不携带cookie。</p>
<h4 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h4><p>只在前端读取。</p>
<p>localStorage提高性能的常见用法（节省网络传送数据、提升首屏性能）：</p>
<ol>
<li>网站首次加载时从服务端下发样式和脚本代码。</li>
<li>将样式和脚本代码缓存到localStoage里。</li>
<li>下次再渲染时，直接从localStorage里读取。</li>
</ol>
<p>通常，每个域名的localStorage使用量在2~10Mb之间。（不同浏览器不同）</p>
<p>localStorage只要不手工清除，就会一直存在。</p>
<p>在无痕浏览/隐私模式下localStorage不可用。</p>
<p>各个tab页直接可通讯。</p>
<h4 id="sessionStorage"><a href="#sessionStorage" class="headerlink" title="sessionStorage"></a>sessionStorage</h4><p>当前会话(session)关闭后，sessionStorage会默认被清除。<br>其他同localStorage。</p>
<h4 id="Web-SQL"><a href="#Web-SQL" class="headerlink" title="Web SQL"></a>Web SQL</h4><p>废弃</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IndexedDB_API/Using_IndexedDB" target="_blank" rel="noopener">MDN说明文档</a></p>
<p><a href="https://itnext.io/indexeddb-your-second-step-towards-progressive-web-apps-pwa-dcbcd6cc2076" target="_blank" rel="noopener">How to use IndexedDB to build Progressive Web Apps</a></p>
<p><a href="https://itnext.io/searching-in-your-indexeddb-database-d7cbf202a17gg" target="_blank" rel="noopener">Searching in Your IndexedDB Database</a></p>
<p><a href="https://flaviocopes.com/indexeddb/#introduction-to-indexeddb" target="_blank" rel="noopener">idb使用：DIVE INTO INDEXEDDB</a></p>
]]></content>
  </entry>
  <entry>
    <title>React</title>
    <url>/want/2019/03/07/React/</url>
    <content><![CDATA[<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ol>
<li>组件化</li>
<li>Virtual DOM</li>
</ol>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>React，用户不会直接操作DOM，而是用户直接更改状态，让React帮助操作DOM。具体如下：</p>
<pre class="mermaid">graph TB
A(用户更改状态) --> B(Render)
B --> C(新的完整的Virtual DOM)

C1(旧Virtual DOM) --> D(DIFF比较差异)
C --> D

D--> E(一次性更新真实DOM)

style A fill:greenyellow
style E fill:greenyellow</pre>


<p>注意点：</p>
<ol>
<li>当父组件state变动，会引发所有子组件Render（即便子组件本身的state毫无改变）。如果不想引发所有子组件render，见步骤5。</li>
<li>Render渲染出来的是完整的Virtual DOM。</li>
<li>利用DIFF算法，比较新旧两个Virtual DOM结构的差异（树对象的比较）</li>
<li>将差异变动，一次性渲染到真实DOM树。</li>
<li><p>如果不想引发所有子组件render，目前有两种方案：</p>
<ul>
<li><p>shouldComponentUpdate() {return false} </p>
</li>
<li><p>immutablejs + PureComponent</p>
</li>
</ul>
</li>
</ol>
<h4 id="期待"><a href="#期待" class="headerlink" title="期待"></a>期待</h4><p>React增加了VDOM的比较时间、减少了浏览器操作。</p>
<p>在重复渲染的时才可能提高性能。</p>
<p>因此，React完成了框架的意义：降低开发者的开发成本，但真正的性能比不上经过认真优化过的原生JS。</p>
<h4 id="为什么DOM操作浪费资源？"><a href="#为什么DOM操作浪费资源？" class="headerlink" title="为什么DOM操作浪费资源？"></a>为什么DOM操作浪费资源？</h4><ul>
<li><p>操作js对象</p>
</li>
<li><p>触发浏览器行为（罪魁祸首）</p>
<ul>
<li>重绘paint——调用浏览器UI引擎渲染展示页面（耗CPU和内存）</li>
<li>重排layout——布局变动，造成重新计算（耗CPU，有时也很耗内存）</li>
</ul>
</li>
</ul>
<p>其中，<strong>重绘</strong>、<strong>重排 </strong>最浪费性能。</p>
<pre class="mermaid">graph TB
A(DOM操作 -- 触发 --浏览器行为) --> B>浏览器解析DOM生成DOM树]
A --> C>浏览器解析CSS生成样式树]

C--> D>进行layout和paint]
B--> D

D --> E(展现到设备)</pre>

<p>为了减少重绘重排，可做如下努力：</p>
<ul>
<li>用Canvas / CSS3 ， 替代DOM动画</li>
<li><p>JQuery 减少DOM操作——</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 避免，频繁DOM操作</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; items.length; i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> item = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">    item.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"Option "</span> + i));</span><br><span class="line">    list.appendChild(item);</span><br><span class="line">&#125;   </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 推荐，使用容器存放临时变更， 最后再一次性更新DOM</span></span><br><span class="line"><span class="keyword">var</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; items.length; i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> item = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span><br><span class="line">    item.appendChild(<span class="built_in">document</span>.createTextNode(<span class="string">"Option "</span> + i));</span><br><span class="line">    fragment.appendChild(item);</span><br><span class="line">&#125;</span><br><span class="line">list.appendChild(fragment);</span><br></pre></td></tr></table></figure>
</li>
<li><p>上述所讲Virtual DOM，也是减少DOM操作的一个手段： 通过预先比较，得到差异，一次性更新DOM。</p>
</li>
</ul>
<h3 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h3><h4 id="传参"><a href="#传参" class="headerlink" title="传参"></a>传参</h4><p>react-router 4.x 传参不再支持query string。query的值不会反映到url上，而是放在内存里，状态非持久，刷页面，query值丢失。</p>
<p>如果你想打开全新的浏览器窗口，必须将参数反馈到url地址，可采取如下办法：</p>
<h5 id="办法1：-传递多个参数。"><a href="#办法1：-传递多个参数。" class="headerlink" title="办法1： 传递多个参数。"></a>办法1： 传递多个参数。</h5><p>使用【 search + 字符串解析工具 】</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 路由route定义</span><br><span class="line">path: &apos;/app-detail&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 路由使用（NavLink 或 push 配置）</span><br><span class="line">&#123;</span><br><span class="line">  pathname: &apos;/app-detail&apos;,</span><br><span class="line">  search: `id=$&#123;row.id&#125;&amp;isEdit=$&#123;isEdit&#125;` // 这里不需要写问号？</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取参数</span><br><span class="line">import querystring from &apos;querystring&apos;</span><br><span class="line">const &#123;id, isEdit&#125; = querystring.parse(this.props.location.search)</span><br></pre></td></tr></table></figure>
<h5 id="办法2：-传递少量参数"><a href="#办法2：-传递少量参数" class="headerlink" title="办法2： 传递少量参数"></a>办法2： 传递少量参数</h5><p>将变量放到路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 路由route定义</span><br><span class="line">path: &apos;/app-detail/:id?/:isEdit?&apos;</span><br><span class="line"></span><br><span class="line">// 路由使用（NavLink 或 push 配置）</span><br><span class="line">&#123;</span><br><span class="line">  pathname: `/app-detail/$&#123;id&#125;/$&#123;isEdit&#125;`,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取参数</span><br><span class="line">const &#123;id, isEdit&#125; = this.props.match.params;</span><br></pre></td></tr></table></figure>
<h3 id="高阶组件"><a href="#高阶组件" class="headerlink" title="高阶组件"></a>高阶组件</h3><img src="/want/2019/03/07/React/high-component.png" title="高阶组件应用">
<pre class="mermaid">graph TD
A(共用组件) --引用--> B(组件1)
A --引用--> C(组件2)
A --引用--> D(组件3)</pre>


<p>高阶组件定义–用作公共组件<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import &apos;./box.less&apos;;</span><br><span class="line"></span><br><span class="line">const Box = InnerComponent =&gt; class extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div className=&#123;`box-wrapper $&#123;this.props.className&#125;`&#125;&gt;</span><br><span class="line">        &lt;InnerComponent &#123;...this.props&#125; /&gt;</span><br><span class="line">        &lt;div className=&quot;box-mask&quot; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">export default Box;</span><br></pre></td></tr></table></figure></p>
<p>高阶组件调用–用共用组件包裹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 组件1</span><br><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import Box from &apos;../Card/box&apos;;</span><br><span class="line"></span><br><span class="line">class LineTrend extends React.Component &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Box(LineTrend);</span><br><span class="line"></span><br><span class="line">// 组件2</span><br><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import Box from &apos;../Card/box&apos;;</span><br><span class="line"></span><br><span class="line">class Pie extends React.Component &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Box(Pie);</span><br><span class="line"></span><br><span class="line">// ...其他组件</span><br></pre></td></tr></table></figure></p>
<h3 id="hooks"><a href="#hooks" class="headerlink" title="hooks"></a>hooks</h3><p>react的特点是组件化，而定义组建的方式如下：</p>
<ol>
<li>函数组件:  function。数据驱动，只负责渲染。方便复用，可独立测试。</li>
<li>类组件: class。包含状态，生命周期。提供数据维护及渲染。不方便复用。</li>
<li>hook: 让函数组件具备类组件的特性，比如状态和生命周期。</li>
</ol>
<p><strong>版本</strong>： React v16.8及以上</p>
<p><strong>作用</strong>： use state and other React features without writing a class。利用function定义组件时，可使用state等React特性。（不一定要class才有状态和生命周期啦， function也可以！）</p>
<ol>
<li>组件间状态逻辑的复用</li>
</ol>
<p>旧有方式中，如果想复用状态，有如下方式：</p>
<ul>
<li>react： <ul>
<li><code>render props</code> ：维护状态的组件+负责渲染的子组件</li>
<li><code>higher-order components</code> ：高阶组件（一个函数接受一个组件作为参数）</li>
<li>将state置于父组件，使其子组件可复用（陷入<code>wrapper hell</code>）</li>
</ul>
</li>
<li>redux： store + props 状态属于全局而非哪个组件，所以可以任意复用（状态不随组件而卸载，所以当使用该数据的组件都已被卸载，但数据仍然像幽灵一样存在）</li>
</ul>
<p>hooks：允许复用状态逻辑（reuse stateful logic），而不更改组件层级。即，一个独立组件，既方便渲染又自己包含状态。</p>
<ol start="2">
<li>生命周期钩子函数<br>通常在componentDidMount中做很多不同业务类型的事情，比如ajax请求、事件监听等。有时还需在componentDidUpdate做一遍同样的事情。</li>
</ol>
<p>hooks：希望把不同业务类型独立书写，逻辑更直观。</p>
<ol start="3">
<li>class组件<br>类组件，存在this指向问题、不方便复用、最初敲定使用function后因业务变动需大动干戈改为class组件等问题。</li>
</ol>
<p>hook：本质是带着状态的function，不存在上述问题。</p>
<p><strong>注意点</strong>：React是通过Hook调用的<strong>次序</strong>来记录各个内部状态的，因此react规定我们必须把hooks写在函数的最外层，不能写在if-else等条件语句当中，来确保hooks的执行顺序一致。</p>
<h4 id="useState"><a href="#useState" class="headerlink" title="useState"></a>useState</h4><p>状态维护。替代state 和 onStateChange。</p>
<p>利用数组解构，在function中实现如下功能：</p>
<ol>
<li>定义状态变量</li>
<li>定义更新状态方法（直接<strong>替换</strong>老状态、返回全新状态）</li>
<li>给出初始状态值</li>
</ol>
<h4 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a>useEffect</h4><p>状态更改后，做一些操作。替代生命周期函数(如，componentDidMount，componentDidUpdate和componentWillUnmount)。</p>
<ol>
<li>获取数据</li>
<li>操作DOM</li>
<li>清理计时器</li>
</ol>
<p>useEffect执行时机：</p>
<ol>
<li>react首次渲染和之后的<strong>每次渲染</strong>都会调用传给useEffect的函数。</li>
<li>useEffect中函数的执行不会阻碍浏览器更新视图，是异步的。</li>
<li>useEffect中执行清理操作，需要在其中返回一个清理函数。带return（从 effect 中返回一个 function，是 effect 可选的清理机制，每个 effect 都可以返回一个在它之后清理的 function， 当<strong>组件卸载</strong>时，React 会自己执行清理函数，进行清理工作。）</li>
</ol>
<p>可以控制useEffect执行时机：</p>
<ol>
<li>给出第二个参数，只有当这个参数改变时，才执行。</li>
<li>给出第二个参数为空数组[]时，只在首次渲染的时候执行（&lt;=&gt; componentDidMount，少用）。</li>
</ol>
<h4 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h4><p>复杂状态维护。</p>
<p>参考：</p>
<p><a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener">官网</a></p>
<h3 id="react衍生"><a href="#react衍生" class="headerlink" title="react衍生"></a>react衍生</h3><h4 id="styled-components"><a href="#styled-components" class="headerlink" title="styled-components"></a>styled-components</h4><h5 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h5><p>使样式组件化</p>
<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><p>百度地图”自动搜索地址”功能。</p>
<img src="/want/2019/03/07/React/autocomplete.gif" title="自动搜索地址">
<p>该所得到结果下拉框的样式是”内部全局样式”。只能通过”覆盖原生样式类”实现自定义样式。无法将其挂在到某个DOM，或直接设置类名 / style等。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 引用百度地图api</span></span><br><span class="line"><span class="keyword">const</span> suggest = <span class="keyword">new</span> BMap.Autocomplete(&#123;</span><br><span class="line">    input: inputId,</span><br><span class="line">    location: map,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 原生样式类 */</span></span><br><span class="line"><span class="selector-class">.tangram-suggestion-main</span> &#123;</span><br><span class="line">  .tangram-suggestion &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.tangram-suggestion</span> <span class="selector-tag">table</span> <span class="selector-tag">tr</span> <span class="selector-tag">td</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.tangram-suggestion-grey</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当该全局地图样式需要实现多套样式主题切换（换肤），该怎么实现呢？</p>
<p>以下方案无效：</p>
<ol>
<li>切换主题时，动态切换类名。（因为无法给自动搜索地址注入类名）</li>
<li>切换主题时，动态切换style对象值。（因为无法给自动搜索地址注入style）</li>
<li>将不同样式写入不同css文件，切换主题时，动态引入css文件。<ol>
<li>因为需要判断主题类型，因此不能采用import一开始就引入，只能采用require引入。</li>
<li>require引入后，将不能卸载，多个主题文件同时存在，后者覆盖前者。</li>
</ol>
</li>
</ol>
<p><strong>实现手段</strong>：</p>
<p>将主题样式组件化，动态引入/卸载组件。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	theme === <span class="string">'day'</span> ? &lt;DayStyle /&gt; : &lt;NightStyle /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createGlobalStyle &#125; <span class="keyword">from</span> <span class="string">'styled-components'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NightStyle = createGlobalStyle<span class="string">`</span></span><br><span class="line"><span class="string">.tangram-suggestion-main &#123;</span></span><br><span class="line"><span class="string">  z-index: 150;</span></span><br><span class="line"><span class="string">  margin-top: 10px;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion &#123;</span></span><br><span class="line"><span class="string">    background: rgba(19, 39, 56, 0.82);</span></span><br><span class="line"><span class="string">    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.73);</span></span><br><span class="line"><span class="string">    color: #fff;</span></span><br><span class="line"><span class="string">    border: 1px solid #2C9CFA;</span></span><br><span class="line"><span class="string">    height: 8rem;</span></span><br><span class="line"><span class="string">    overflow-y: auto;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion table tr td &#123;</span></span><br><span class="line"><span class="string">    height: 24px;</span></span><br><span class="line"><span class="string">    line-height: 24px;</span></span><br><span class="line"><span class="string">    color: #fff;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp;:hover, &amp;:focus, &amp;.tangram-suggestion-current &#123;</span></span><br><span class="line"><span class="string">      background: rgba(44, 156, 250, 0.8);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion-grey &#123;</span></span><br><span class="line"><span class="string">    color: #c0c0c0;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> DayStyle = createGlobalStyle<span class="string">`</span></span><br><span class="line"><span class="string">.tangram-suggestion-main &#123;</span></span><br><span class="line"><span class="string">  z-index: 150;</span></span><br><span class="line"><span class="string">  margin-top: 10px;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion &#123;</span></span><br><span class="line"><span class="string">    background: rgba(255, 255, 255, 0.9);</span></span><br><span class="line"><span class="string">    box-shadow: 0 1px 3px 0 rgba(255, 255, 255, 0.73);</span></span><br><span class="line"><span class="string">    color: #fff;</span></span><br><span class="line"><span class="string">    border: 1px solid #e9e9e9;</span></span><br><span class="line"><span class="string">    height: 8rem;</span></span><br><span class="line"><span class="string">    overflow-y: auto;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion table tr td &#123;</span></span><br><span class="line"><span class="string">    height: 24px;</span></span><br><span class="line"><span class="string">    line-height: 24px;</span></span><br><span class="line"><span class="string">    color: #3c3e4a;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &amp;:hover, &amp;:focus, &amp;.tangram-suggestion-current &#123;</span></span><br><span class="line"><span class="string">      background: #e6f7ff;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  .tangram-suggestion-grey &#123;</span></span><br><span class="line"><span class="string">    color: #999;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; NightStyle, DayStyle &#125;;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>SVG连线图</title>
    <url>/want/2018/09/30/SVG%E9%93%BE%E8%B7%AF%E5%9B%BE/</url>
    <content><![CDATA[<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><img src="/want/2018/09/30/SVG链路图/link.gif" title="SVG曲线实现效果图">
<p>主要内容：</p>
<ol>
<li>静态绘制</li>
<li>缩放/拖拽联动</li>
<li>选中效果/扩大点击区域/曲线可被选中而svg画布其他部分鼠标穿透</li>
<li>悬浮效果+获取tooltip数据</li>
</ol>
<h3 id="静态绘制曲线集"><a href="#静态绘制曲线集" class="headerlink" title="静态绘制曲线集"></a>静态绘制曲线集</h3><h4 id="svg"><a href="#svg" class="headerlink" title="svg"></a>svg</h4><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">class</span>=<span class="string">"home-broadband-chart-line"</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// active 选中效果</span><br><span class="line">  <span class="tag">&lt;<span class="name">g</span> <span class="attr">class</span>=<span class="string">"line-group active"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 扩大点击区域（d为曲线： M起点 Q折点, 终点）</span><br><span class="line">    <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"line-bg"</span> <span class="attr">d</span>=<span class="string">"M790,130 Q598.2258262634277,147.52609517415354 406.45165252685547,312.57828552246065"</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">// 真实曲线（d为曲线（同上）： M起点 Q折点, 终点）</span><br><span class="line">    <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"line"</span> <span class="attr">d</span>=<span class="string">"同上"</span> <span class="attr">style</span>=<span class="string">"stroke: rgb(238, 80, 66);"</span>&gt;</span><span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="css"><a href="#css" class="headerlink" title="css"></a>css</h4><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.home-broadband-chart-line</span> &#123;</span><br><span class="line">  <span class="attribute">pointer-events</span>: none; <span class="comment">// 设置svg鼠标穿透</span></span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.line-group</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">fill</span>: none;</span><br><span class="line">    <span class="attribute">pointer-events</span>: visiblepainted; <span class="comment">// 设置具体曲线可鼠标穿透</span></span><br><span class="line">    <span class="selector-tag">path</span> &#123;</span><br><span class="line">      <span class="attribute">fill</span>: none; <span class="comment">// 只渲染stroke曲线,不渲染闭合填充</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span>, <span class="selector-tag">&amp;</span><span class="selector-class">.active</span> &#123;</span><br><span class="line">      <span class="selector-class">.line</span> &#123;</span><br><span class="line">        <span class="attribute">stroke-width</span>: <span class="number">3</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.line-bg</span> &#123;</span><br><span class="line">    <span class="attribute">stroke</span>: transparent; <span class="comment">// 透明，用于扩大点击区域</span></span><br><span class="line">    <span class="attribute">stroke-width</span>: <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-class">.line</span> &#123;</span><br><span class="line">    <span class="attribute">stroke</span>: <span class="number">#55E38D</span>;</span><br><span class="line">    <span class="attribute">stroke-width</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">stroke-dasharray</span>: <span class="number">5</span>, <span class="number">2</span>; <span class="comment">// 虚线效果</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>参考： <a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/pointer-events" target="_blank" rel="noopener">visiblepainted</a></p>
<h3 id="动态绘制曲线集"><a href="#动态绘制曲线集" class="headerlink" title="动态绘制曲线集"></a>动态绘制曲线集</h3><p>获得每一条线的起始坐标，输入svg绘制即可。</p>
<h4 id="曲线"><a href="#曲线" class="headerlink" title="曲线"></a>曲线</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;svg</span><br><span class="line">  className=<span class="string">"home-broadband-chart-line"</span></span><br><span class="line">  version=<span class="string">"1.1"</span></span><br><span class="line">  xmlns=<span class="string">"http://www.w3.org/2000/svg"</span></span><br><span class="line">&gt;</span><br><span class="line">  &#123;</span><br><span class="line">  indexLinkList</span><br><span class="line">    .map(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;</span><br><span class="line">        id,</span><br><span class="line">        name,</span><br><span class="line">        bId,</span><br><span class="line">        aId,</span><br><span class="line">        legend,</span><br><span class="line">      &#125; = item;</span><br><span class="line">      <span class="keyword">const</span> &#123; color &#125; = MAP_LEGEND_INFO[legend];</span><br><span class="line">                </span><br><span class="line">      <span class="keyword">const</span> startPos = posType[bId] || [<span class="number">0</span>, <span class="number">0</span>]; <span class="comment">// 起点位置</span></span><br><span class="line">      <span class="keyword">const</span> x1 = startPos[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">const</span> y1 = startPos[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> endPos = posMap[aId] || [<span class="number">0</span>, <span class="number">0</span>]; <span class="comment">// 终点位置</span></span><br><span class="line">      <span class="keyword">const</span> x2 = endPos[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">const</span> y2 = endPos[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> cx = (x1 + x2) / <span class="number">2</span>; <span class="comment">// 折点位置 x</span></span><br><span class="line">      <span class="keyword">const</span> cy = (y1 + y2) / <span class="number">3</span>; <span class="comment">// 折点位置 y</span></span><br><span class="line">      <span class="keyword">const</span> operator = [<span class="string">'group'</span>, <span class="string">'idc'</span>].indexOf(bId) &gt; <span class="number">-1</span> ? <span class="number">1</span> : <span class="number">2</span>; <span class="comment">// 弧方向</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        &lt;g</span><br><span class="line">          key=&#123;id&#125;</span><br><span class="line">          className=&#123;<span class="string">`line-group <span class="subst">$&#123;id === currentId ? <span class="string">'active'</span> : <span class="string">''</span>&#125;</span>`</span>&#125;</span><br><span class="line">          onMouseOver=&#123;e =&gt; <span class="keyword">this</span>.onLinkHover(e, &#123; id, name, color &#125;)&#125;</span><br><span class="line">          onFocus=&#123;e =&gt; <span class="keyword">this</span>.onLinkHover(e, &#123; id, name, color &#125;)&#125;</span><br><span class="line">          onMouseOut=&#123;<span class="keyword">this</span>.onLinkOut&#125;</span><br><span class="line">          onBlur=&#123;<span class="keyword">this</span>.onLinkOut&#125;</span><br><span class="line">          onClick=&#123;() =&gt; onSelect(id)&#125;</span><br><span class="line">        &gt;</span><br><span class="line">          &lt;path</span><br><span class="line">            className=<span class="string">"line-bg"</span></span><br><span class="line">            d=&#123;<span class="string">`M<span class="subst">$&#123;x1&#125;</span>,<span class="subst">$&#123;y1&#125;</span> Q<span class="subst">$&#123;cx&#125;</span>,<span class="subst">$&#123;operator * cy&#125;</span> <span class="subst">$&#123;x2&#125;</span>,<span class="subst">$&#123;y2&#125;</span>`</span>&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">          &lt;path</span><br><span class="line">            className=<span class="string">"line"</span></span><br><span class="line">            d=&#123;<span class="string">`M<span class="subst">$&#123;x1&#125;</span>,<span class="subst">$&#123;y1&#125;</span> Q<span class="subst">$&#123;cx&#125;</span>,<span class="subst">$&#123;operator * cy&#125;</span> <span class="subst">$&#123;x2&#125;</span>,<span class="subst">$&#123;y2&#125;</span>`</span>&#125;</span><br><span class="line">            style=&#123;&#123;</span><br><span class="line">              stroke: color,</span><br><span class="line">            &#125;&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">      &lt;<span class="regexp">/g&gt;</span></span><br><span class="line"><span class="regexp">     );</span></span><br><span class="line"><span class="regexp">   &#125;)</span></span><br><span class="line"><span class="regexp"> &#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>svg&gt;</span><br></pre></td></tr></table></figure>
<h4 id="起点位置"><a href="#起点位置" class="headerlink" title="起点位置"></a>起点位置</h4><p>起点是四个DOM定点，只需获取四个DOM元素的中心位置(<strong>简单DOM操作</strong>，根据实际情况而定)<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 该示例不通用</span></span><br><span class="line">getPos = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; offsetLeft, offsetTop &#125; = <span class="keyword">this</span>[id].offsetParent; <span class="comment">// 位置</span></span><br><span class="line">    <span class="keyword">const</span> ball = <span class="keyword">this</span>[id].children[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> xCenter = (<span class="keyword">this</span>[id].clientWidth - ball.clientWidth) / <span class="number">2</span>; <span class="comment">// 中心</span></span><br><span class="line">    <span class="keyword">const</span> yCenter = ball.clientHeight / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      x: offsetLeft + <span class="keyword">this</span>[id].offsetLeft + xCenter,</span><br><span class="line">      y: (offsetTop + <span class="keyword">this</span>[id].offsetTop) + yCenter,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="终点位置"><a href="#终点位置" class="headerlink" title="终点位置"></a>终点位置</h4><p>终点是echarts图结点，需要获取echarts点位置<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">getPixel(info) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pos, geo = <span class="string">'geo'</span> &#125; = info;</span><br><span class="line">  <span class="keyword">const</span> &#123; lng, lat &#125; = pos;</span><br><span class="line">  <span class="keyword">const</span> &#123; chart &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">const</span> pixel = chart.convertToPixel(geo, [lng, lat]); <span class="comment">// 经纬度转平面坐标</span></span><br><span class="line">  <span class="keyword">return</span> pixel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="resize（拖拽-缩放）"><a href="#resize（拖拽-缩放）" class="headerlink" title="resize（拖拽/缩放）"></a>resize（拖拽/缩放）</h3><p>echarts图形变动——重新获取地图各点平面坐标（终点位置）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">setDataZoom(func) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; chart &#125; = <span class="keyword">this</span>;</span><br><span class="line">  chart.on(<span class="string">'georoam'</span>, () =&gt; &#123; <span class="comment">// 监听echart地图事件,同时响应缩放和拖拽</span></span><br><span class="line">    func();</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">chart.setDataZoom(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.getMapPixel(mapList));</span><br></pre></td></tr></table></figure>
<p>窗口变动——重新更新四个DOM元素平面坐标（起点位置）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'resize'</span>, <span class="keyword">this</span>.resize);。</span><br><span class="line"><span class="built_in">window</span>.removeEventListener(<span class="string">'resize'</span>, <span class="keyword">this</span>.resize);</span><br></pre></td></tr></table></figure>
<h3 id="判断鼠标“是否在同一条连线上连续移动”"><a href="#判断鼠标“是否在同一条连线上连续移动”" class="headerlink" title="判断鼠标“是否在同一条连线上连续移动”"></a>判断鼠标“是否在同一条连线上连续移动”</h3><p>鼠标在同一条连线上连续移动，不应重新调取tooltip接口，而应直接采用原有tooltip接口数据。</p>
<p>已知鼠标方法：</p>
<ul>
<li>鼠标落在连线： onmouseover</li>
<li>鼠标离开连线： onmouseout</li>
</ul>
<p>鼠标在曲线上移动过程中，视觉上虽然是连续的，但其实在一瞬间先经历了onmouseout又onmouseover的过程。</p>
<p><strong>思路</strong>： 利用定时器setTimeout，来延缓onmouseout。即在200ms内，再次onmouseover，则不再执行onmouseout的方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">onLinkOut = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.timer = setTimeout(<span class="keyword">this</span>.onReset, <span class="number">200</span>);</span><br><span class="line">&#125;;</span><br><span class="line">onLinkHover =<span class="function">(<span class="params">event, link</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.timer) &#123;</span><br><span class="line">    clearTimeout(<span class="keyword">this</span>.timer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定时器有广泛的应用意义：</p>
<ol>
<li>为了防止用户鼠标不经意划过链接，腾讯网首页几乎所有鼠标经过事件都进行了【延时处理】，即 鼠标经过后200毫秒，才执行鼠标经过事件。</li>
</ol>
<p>该方案是节流、防抖的思想之一。</p>
<h3 id="节流、防抖"><a href="#节流、防抖" class="headerlink" title="节流、防抖"></a>节流、防抖</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>因频繁执行DOM操作，资源加载等行为，导致UI停顿甚至浏览器崩溃。</p>
<p>常见导致原因如以下<strong>持续触发</strong>的事件——</p>
<ul>
<li>浏览器的 onresize / onscroll 等事件。</li>
<li>鼠标的 mousemove / mousedown 等事件。</li>
<li>键盘的 keydown / keyup 等事件。</li>
<li>地图的 zoomend / dragend / moveend 等事件。</li>
</ul>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><h5 id="节流throttle"><a href="#节流throttle" class="headerlink" title="节流throttle"></a>节流throttle</h5><p><strong>作用</strong>：<br>以一定的频率执行后续处理。<br>让水龙头每隔200毫秒流出一滴水。源源不断的流出水而又不浪费。</p>
<p><strong>场景</strong>：<br>拖拽DOM。在一定时间内多次执行，会感觉流畅。（如果使用防抖，一定时间内执行一次，会感觉卡顿）。</p>
<p><strong>分类</strong>：</p>
<ul>
<li>时间戳</li>
<li>定时版本</li>
</ul>
<h5 id="防抖debounce"><a href="#防抖debounce" class="headerlink" title="防抖debounce"></a>防抖debounce</h5><p><strong>作用</strong>：<br>停止n毫秒后，执行后续处理</p>
<p><strong>场景</strong>：<br>搜索。当联想搜索时，用户连续不断输入字符keyup，不应立即发送请求，而应等一段时间不输入了，才发送一次请求</p>
<p><strong>分类</strong>：</p>
<ul>
<li>非立即防抖</li>
<li>立即防抖</li>
</ul>
<h6 id="非立即防抖"><a href="#非立即防抖" class="headerlink" title="非立即防抖"></a>非立即防抖</h6><p>触发事件后函数<strong>不会立即执行</strong>，而是在n秒之后执行，如果n秒之内又触发了事件，则会重新计算函数执行时间。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, wait</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> timer = <span class="literal">null</span>; <span class="comment">// 定义计时器</span></span><br><span class="line">  <span class="keyword">var</span> context = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">arguments</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timer) &#123;</span><br><span class="line">      clearTimeout(timer); <span class="comment">// 在n时间内，又被执行，则清除计时器,重新计时</span></span><br><span class="line">    &#125;</span><br><span class="line">    timer = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      func.apply(context, args)</span><br><span class="line">    &#125;, wait); <span class="comment">// 触发事件后，等待n时间后才执行</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="立即防抖"><a href="#立即防抖" class="headerlink" title="立即防抖"></a>立即防抖</h6><p>触发事件后函数会<strong>立即执行</strong>，然后n秒内不触发事件才会执行函数的效果。<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> timeout = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> context = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> args = <span class="built_in">arguments</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (timeout) clearTimeout(timeout);</span><br><span class="line">        <span class="keyword">var</span> callNow = !timeout;</span><br><span class="line">        timeout = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            timeout = <span class="literal">null</span>;</span><br><span class="line">        &#125;, wait)</span><br><span class="line">        <span class="keyword">if</span> (callNow) func.apply(context, args)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="https://www.jianshu.com/p/566c66aafa22" target="_blank" rel="noopener">节流（throttle）与防抖（debounce）</a></li>
</ol>
]]></content>
      <tags>
        <tag>图</tag>
        <tag>SVG</tag>
      </tags>
  </entry>
  <entry>
    <title>docker</title>
    <url>/want/2018/09/20/docker/</url>
    <content><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>docker，一种容器化技术，一种进程。该进程通过操作镜像文件，生成若干虚拟容器，以装载若干彼此隔离的应用程序。</p>
<p><strong>目标</strong><br>隔离应用程序——提供若干彼此隔离的容器，在每个隔离的容器中，运行用户特定应用程序。</p>
<p><strong>优势</strong></p>
<ul>
<li>易移植，“build once, configure once and run anywhere“</li>
<li>速度飞快</li>
<li>隔离</li>
<li>CPU/内存的低消耗</li>
<li>快速开/关机</li>
<li>跨云计算基础构架</li>
</ul>
<p><strong>注意点</strong><br>1.保持职责单一，一个容器只提供一个服务，如，</p>
<ul>
<li>仅提供Nginx服务</li>
<li>仅提供 MySQL服务</li>
</ul>
<p>2.若想让容器处于启动状态，则容器托管的应用程序必须有一个正在运行的进程，</p>
<ul>
<li>如使用docker + nignx的时候，需要在niginx.conf文件头部加一个<strong>daemon off</strong>。或者手动启动 <strong>docker run -it nginx bash</strong>。</li>
<li>若启动命令是以后台守护(daemon on)模式启动nginx，则启动命令会立即结束，容器也会立即结束。</li>
<li>其实只要在任何命令之后加一句 &amp;&amp; cat，就会让这条命令卡在前台而不会结束，不必daemon off。</li>
</ul>
<p><strong>基础支撑元素</strong><br>1.<strong>client</strong>: 用户命令行工具，与daemon通讯<br>2.<strong>daemon</strong>: 运行在宿主机上的服务（常驻内存进程）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service docker start	<span class="comment">#启动docker daemon进程</span></span><br><span class="line">service docker stop	<span class="comment">#关闭docker daemon进程</span></span><br></pre></td></tr></table></figure></p>
<p>3.<strong>registry</strong>: 镜像仓库<br>集中存放镜像文件的场所【类似于git】</p>
<ul>
<li>公开仓库public：公有仓库如docker hub提供了非常多的镜像文件，可直接拉取，也可上传自定义镜像；可搜索、可重复使用</li>
<li>私有仓库private： 私有仓库可用于团队项目管理；仅供给拥有访问权限的成员使用</li>
</ul>
<p><strong> 重点要素</strong></p>
<ul>
<li>镜像</li>
<li>容器</li>
</ul>
<p>docker运行应用程序过程：</p>
<ol>
<li>构建镜像</li>
<li>运行容器</li>
</ol>
<p>docker实现目标的方式：</p>
<ul>
<li>通过命令，对镜像和容器的增删查改</li>
</ul>
<p><strong> 镜像 images</strong><br>用来创建container实例。只读。【类似于vm虚拟机中的快照】<br>分类</p>
<ul>
<li>基础镜像：仅仅包含操作系统，如centos</li>
<li>中间镜像：如数据库镜像， tomacat, redis</li>
<li>应用镜像：具体的应用服务，毕竟丰富</li>
</ul>
<p>获取方式</p>
<ul>
<li>从Docker hub公共仓库中拉取</li>
<li>自定义构建</li>
</ul>
<p><strong>容器 containers</strong></p>
<ul>
<li>从镜像中创建的运行实例，负责应用程序的运行。</li>
<li>容器之间彼此隔离。</li>
<li><p>容器可以启动、开始、停止、删除。容器停止后会处于exited状态，但数据不会丢失，仍可通过docker start命令来启动。只有删除掉容器才会清除所有数据。</p>
</li>
<li><p>容器的网络端口：可以将容器的特定端口映射到<strong>宿主机</strong>上的任意一个<strong>端口</strong></p>
</li>
</ul>
<p><strong>镜像-容器关系</strong><br>通过镜像Image#1可以生成若干独立容器Container#1/Container#2/Container#3</p>
<p><strong>使用过程</strong><br>1.构建<br>构建镜像并push到Docker仓库</p>
<ul>
<li><p>利用Dockerfile构建<br>Dockerfile包含创建镜像所需要的全部指令，说明如何自动创建镜像</p>
</li>
<li><p>手动命令行构建</p>
</li>
</ul>
<p>2.运输<br>从Docker仓库pull一份镜像到本地<br>3.运行<br>通过镜像文件开启Docker容器并提供服务</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="CentOS-版本"><a href="#CentOS-版本" class="headerlink" title="CentOS 版本"></a>CentOS 版本</h3><p>docker支持两种CentOS版本：</p>
<ul>
<li>CentOS 7 (64-bit, 系统内核3.10以上)</li>
<li>CentOS 6.5 (64-bit， 系统内核2.6.32-431以上) 或更高</li>
</ul>
<p>检测版本命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /etc/redhat-release	<span class="comment">#操作系统名称</span></span><br></pre></td></tr></table></figure>
<p>或<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">uname -r	<span class="comment">#系统内核号</span></span><br></pre></td></tr></table></figure></p>
<h3 id="CentOS-6-5或更高"><a href="#CentOS-6-5或更高" class="headerlink" title="CentOS 6.5或更高"></a>CentOS 6.5或更高</h3><p>安装及安装是否成功<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -iUvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span><br><span class="line">yum update -y</span><br><span class="line">yum -y install docker-io</span><br><span class="line"></span><br><span class="line">docker</span><br></pre></td></tr></table></figure></p>
<p>启动docker服务及启动是否成功<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service docker start</span><br><span class="line">docker verison</span><br></pre></td></tr></table></figure></p>
<p>配置加速器（因国内网速不佳）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/docker</span><br><span class="line">配置 other_args=<span class="string">"--registry-mirror=https://jxus37ad.mirror.aliyuncs.com"</span></span><br></pre></td></tr></table></figure></p>
<p>修改后重启并检查docker进程<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service docker restart</span><br><span class="line">ps -ef | grep docker</span><br></pre></td></tr></table></figure></p>
<h3 id="CentOS-7"><a href="#CentOS-7" class="headerlink" title="CentOS 7"></a>CentOS 7</h3><h4 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h4><p>1.配置yum（可忽略）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data.x86_64 lvm2	<span class="comment">#安装依赖环境</span></span><br><span class="line"></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo	<span class="comment">#添加软件源信息，建议使用国内源</span></span><br><span class="line"></span><br><span class="line">	- https://mirrors.ustc.edu.cn/docker-ce/linux/centos/docker-ce.repo	<span class="comment">#国内源</span></span><br><span class="line">	- https://download.docker.com/linux/centos/docker-ce.repo	<span class="comment">#官网源</span></span><br><span class="line"></span><br><span class="line">yum makecache fast	<span class="comment">#更新 yum 软件源缓存</span></span><br></pre></td></tr></table></figure></p>
<p>2.安装 Docker CE<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install -y docker-ce	<span class="comment">#安装 docker-ce</span></span><br></pre></td></tr></table></figure></p>
<h4 id="脚本安装"><a href="#脚本安装" class="headerlink" title="脚本安装"></a>脚本安装</h4><p>1.确保 sudo 或 root 权限。<br>2.确保 yum 包更新到最新。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum update -y	<span class="comment">#确保yum 包更新到最新</span></span><br><span class="line"></span><br><span class="line">curl -fsSL https://get.docker.com/ | sh	<span class="comment">#执行Docker安装脚本,添加docker.repo源并安装 Docker</span></span><br></pre></td></tr></table></figure></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="宿主机构建镜像构建的context"><a href="#宿主机构建镜像构建的context" class="headerlink" title="宿主机构建镜像构建的context"></a>宿主机构建镜像构建的context</h3><p>web-client<br>+– Dockerfile<br>+– dist<br>+—— index.html<br>+– conf<br>+—— nginx.conf</p>
<h3 id="编写Dockerfile"><a href="#编写Dockerfile" class="headerlink" title="编写Dockerfile"></a>编写Dockerfile</h3><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Base images 基础镜像</span></span><br><span class="line">FROM centos:centos7</span><br><span class="line"> </span><br><span class="line"><span class="comment">#MAINTAINER 维护者信息</span></span><br><span class="line">MAINTAINER network-bigdata</span><br><span class="line"> </span><br><span class="line"><span class="comment">#ADD  获取url中的文件,放在当前目录下</span></span><br><span class="line">ADD http://nginx.org/download/nginx-1.15.3.tar.gz .</span><br><span class="line"> </span><br><span class="line"><span class="comment">#RUN 执行以下命令</span></span><br><span class="line">RUN yum install -y pcre-devel wget net-tools gcc zlib zlib-devel make openssl-devel</span><br><span class="line">RUN tar -zxvf nginx-1.15.3.tar.gz</span><br><span class="line">RUN mkdir -p /usr/<span class="built_in">local</span>/nginx</span><br><span class="line">RUN <span class="built_in">cd</span> nginx-1.15.3 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line">RUN ln -s /usr/<span class="built_in">local</span>/nginx/sbin/* /usr/<span class="built_in">local</span>/sbin/</span><br><span class="line"></span><br><span class="line"><span class="comment">#REPLACE CONF 替换配置文件</span></span><br><span class="line">RUN rm /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br><span class="line">ADD conf/nginx.conf /usr/<span class="built_in">local</span>/nginx/conf/</span><br><span class="line"></span><br><span class="line"><span class="comment">#ADD RESOUCES 添加静态资源</span></span><br><span class="line">RUN rm /usr/<span class="built_in">local</span>/nginx/html/index.html</span><br><span class="line">RUN mkdir -p /usr/<span class="built_in">local</span>/nginx/html/static</span><br><span class="line">COPY dist/ /usr/<span class="built_in">local</span>/nginx/html/static</span><br><span class="line"> </span><br><span class="line"><span class="comment">#EXPOSE 映射端口</span></span><br><span class="line">EXPOSE 7070</span><br><span class="line"> </span><br><span class="line"><span class="comment">#CMD 运行以下命令</span></span><br><span class="line">CMD [<span class="string">"nginx"</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>FROM，选择基础镜像（必须且必置顶）FROM scratch表示一个空白的特殊镜像</li>
<li>RUN，创建镜像时运行的操作，RUN &lt;命令&gt;，就像在命令行中输入命令一样</li>
<li>COPY，复制宿主文件到镜像</li>
<li>ADD，更高级的复制，在COPY基础上，可以下载URL地址文件到镜像</li>
<li>EXPOSE，对外部开放端口，容器的端口</li>
<li>CMD，创建容器后启动的程序。如创建容器后，立即执行容器内的nginx进程（只有应用程序中有进程在前台运行，容器才能处于运行状态）</li>
</ul>
<h4 id="基于Dockerfile构建镜像"><a href="#基于Dockerfile构建镜像" class="headerlink" title="基于Dockerfile构建镜像"></a>基于Dockerfile构建镜像</h4><p>docker build [选项] &lt;上下文路径/URL/-&gt;</p>
<p>eg.<br>docker build -t 镜像名称:TAG 上下文路径<br>docker build -t 镜像名称 <strong>.</strong>        #在当前目录（有dockerfile）下构建镜像</p>
<p>docker build -t myapp:1.0.0 .<br>docker build -t ai-ops-web .</p>
<h3 id="构建镜像-运行容器"><a href="#构建镜像-运行容器" class="headerlink" title="构建镜像/运行容器"></a>构建镜像/运行容器</h3><h4 id="基于Dockerfile"><a href="#基于Dockerfile" class="headerlink" title="基于Dockerfile"></a>基于Dockerfile</h4><p>1.基于Dockerfile构建镜像<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t ai-ops-web:nginx .</span><br><span class="line"></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure></p>
<p>2.根据镜像构建并运行容器<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8081:7070 ai-ops-web:nginx</span><br><span class="line"></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure></p>
<p>3.打开浏览器访问ip:8081</p>
<h4 id="手动"><a href="#手动" class="headerlink" title="手动"></a>手动</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#直接从Docker hub拉取指定版本的镜像文件，默认最新版本latest</span></span><br><span class="line">docker pull 镜像名:TAG	</span><br><span class="line">docker pull ubuntu:latest</span><br><span class="line">docker pull busybox</span><br><span class="line"></span><br><span class="line"><span class="comment">#若镜像不存在，则新增并运行。即下载最新版本latest镜像，并运行镜像，临时启动一个容器</span></span><br><span class="line"><span class="comment">#若镜像存在则直接运行。</span></span><br><span class="line">docker run 镜像名</span><br><span class="line"></span><br><span class="line"><span class="comment">#如想一直启动一个容器，则-d</span></span><br><span class="line">docker run -d centos</span><br><span class="line"></span><br><span class="line"><span class="comment">#如想给将宿主网络端口映射到容器，则-p,-p &lt;宿主端口&gt;:&lt;容器端口&gt;</span></span><br><span class="line">docker run -d -p 3000:3000 myapp:1.0.0</span><br></pre></td></tr></table></figure>
<h3 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker images			<span class="comment">#查看本地已有镜像列表</span></span><br><span class="line">docker ps -a 			<span class="comment">#查看所有容器列表，包括运行中的和已经停止的</span></span><br><span class="line">docker ps				<span class="comment">#查看正运行的容器列表</span></span><br><span class="line"></span><br><span class="line">docker inspect 镜像ID(镜像名)/容器ID(容器名)	<span class="comment">#查看镜像/容器的详情</span></span><br><span class="line">docker inspect 2de3fe38fadc | grep IP</span><br></pre></td></tr></table></figure>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi 镜像ID	<span class="comment">#删除镜像，多个镜像ID之间用空格隔开</span></span><br><span class="line">docker rm 容器ID	<span class="comment">#删除容器，多个容器ID之间用空格隔开</span></span><br></pre></td></tr></table></figure>
<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><p>有时镜像构建过程中出现如下none的情况：<br>|REPOSITORY|TAG|IMAGE ID|CREATED|VIRTUAL SIZE|<br>|-|-|-|-|<br>|ai-ops-web-client|1.2.0-19|2ba15d4a7a51|7 minutes ago|99.8 MB|<br>|<none>|<none>|ab5e30d1e67f|2 weeks ago|397.1 MB|</none></none></p>
<p>修改如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker tag IMAGE_ID REPOSITORY:TAG</span><br><span class="line">docker tag ab5e30d1e67f ai-ops-web-client:1.2.0-18</span><br></pre></td></tr></table></figure></p>
<h3 id="停止-启动-重启容器"><a href="#停止-启动-重启容器" class="headerlink" title="停止/启动/重启容器"></a>停止/启动/重启容器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker start 容器ID</span><br><span class="line">docker restart 容器ID</span><br><span class="line">docker stop 容器ID</span><br></pre></td></tr></table></figure>
<h3 id="进入镜像"><a href="#进入镜像" class="headerlink" title="进入镜像"></a>进入镜像</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下载镜像，并启动、进入镜像终端， -it 使容器终端和当前终端进行关联</span></span><br><span class="line">docker run -it 镜像ID /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<h3 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看docker正在使用的容器 containerId</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment">#将虚拟机dist/下内容复制到docker容器(containerId)中的html/static文件夹下(Version 1.8才支持从宿主机cp文件到容器)</span></span><br><span class="line">docker cp dist/. 02895bc63d97:/usr/<span class="built_in">local</span>/nginx/html/static</span><br><span class="line"></span><br><span class="line"><span class="comment">#进入docker容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 02895bc63d97 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看一下，是否已成功复制</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/html/static/</span><br><span class="line"></span><br><span class="line"><span class="comment">#退出docker容器</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#清除浏览器缓存即更新成功</span></span><br></pre></td></tr></table></figure>
<h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker	<span class="comment">#查看docker已经安装</span></span><br><span class="line">docker info	<span class="comment">#docker信息</span></span><br><span class="line">docker version	<span class="comment">#docker版本信息</span></span><br><span class="line"></span><br><span class="line">service docker start	<span class="comment">#启动docker daemon进程</span></span><br><span class="line">service docker stop	<span class="comment">#关闭docker daemon进程</span></span><br><span class="line"></span><br><span class="line">docker build</span><br><span class="line">docker commit</span><br><span class="line"></span><br><span class="line">docker pull</span><br><span class="line">docker run</span><br><span class="line">docker <span class="built_in">exec</span></span><br><span class="line"></span><br><span class="line">docker images</span><br><span class="line">docker ps -a </span><br><span class="line">docker inspect</span><br><span class="line"></span><br><span class="line">docker rm</span><br><span class="line">docker rmi</span><br><span class="line"></span><br><span class="line">docker start/stop/restart</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>jackson</title>
    <url>/want/2020/11/24/jackson/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>jackson支持java和Kotlin、Scala等语言，支持JSON及JSON以外的多种格式转换。</p>
<p>是Spring家族默认的JSON、XML解析器。</p>
<p>语法特点：纵观整个Jackson，它更多的是使用抽象类而非接口。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="三大核心模块"><a href="#三大核心模块" class="headerlink" title="三大核心模块"></a>三大核心模块</h4><ul>
<li><code>jackson-core</code>： Streaming流处理模块，定义底层处理流API：JsonPaser和JsonGenerator等，并包含<strong>特定于json</strong>的实现。</li>
<li><code>jackson-annotations</code>：Annotations标准注解模块，包含标准的Jackson注解。</li>
<li><code>jackson-databind</code>：Databind数据绑定模块，在streaming包上实现数据绑定(和对象序列化)支持；<strong>它依赖于上面的两个模块</strong>，也是Jackson的高层API(如ObjectMapper)所在的模块。实际开发中，只用到<code>Databind数据绑定模块</code></li>
</ul>
<h4 id="扩展模块"><a href="#扩展模块" class="headerlink" title="扩展模块"></a>扩展模块</h4><p>通过扩展模块，让<code>Jackson databind</code>包(<code>ObjectMapper / ObjectReader / ObjectWriter</code>)能够顺利读写/转换扩展的类型。</p>
<ol>
<li>利用Jackson插件模块（<code>ObjectMapper.registerModule()</code>），</li>
<li>添加序列化器和反序列化器</li>
<li>最终支持各种常用Java库数据类型。</li>
</ol>
<h5 id="数据类型模块datatype"><a href="#数据类型模块datatype" class="headerlink" title="数据类型模块datatype"></a>数据类型模块datatype</h5><ol>
<li><p>官方维护的扩展模块</p>
<pre><code>* groupId为：`&lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt;`
</code></pre></li>
</ol>
<ul>
<li>version和官方主版本号相对应</li>
</ul>
<ol start="2">
<li><p>非官方直接维护的扩展模块</p>
<pre><code>* groupId不确定，版本号与官方主版本无关。比如：
</code></pre><ul>
<li>jackson-datatype-commons-lang3：支持<code>Apache Commons Lang v3</code>里面的一些类型</li>
<li>jackson-datatype-money：支持<code>javax.money</code></li>
<li>jackson-datatype-json-lib：对久远的<code>json-lib</code>这个库的支持</li>
</ul>
</li>
</ol>
<h5 id="数据格式模块dataformat"><a href="#数据格式模块dataformat" class="headerlink" title="数据格式模块dataformat"></a>数据格式模块dataformat</h5><p>支持<strong>JSON之外</strong>的数据格式，大多数只是实现streaming API抽象，以便数据绑定组件可以按原样使用。</p>
<ol>
<li>官方维护的扩展模块<ul>
<li>groupId为：<code>&lt;groupId&gt;com.fasterxml.jackson.dataformat&lt;/groupId&gt;</code></li>
<li>version和官方主版本号相对应。</li>
<li>Avro/CBOR/Ion/Protobuf/Smile(binary JSON) ：二进制格式，artifactId为：<code>&lt;artifactId&gt;jackson-dataformat-[FORMAT]&lt;/artifactId&gt;</code></li>
<li>CSV/Properties/XML/YAML等文本格式。</li>
</ul>
</li>
<li>非官方直接维护的扩展模块。</li>
</ol>
<h4 id="支持Kotlin和Scala的依赖"><a href="#支持Kotlin和Scala的依赖" class="headerlink" title="支持Kotlin和Scala的依赖"></a>支持Kotlin和Scala的依赖</h4><ul>
<li>groupId为：<code>&lt;groupId&gt;com.fasterxml.jackson.module&lt;/groupId&gt;</code></li>
<li>version和官方主版本号相对应。<ul>
<li>jackson-module-kotlin：处理kotlin源生类型</li>
<li>jackson-module-scala_[scala版本号]：处理scala源生类型</li>
</ul>
</li>
</ul>
<h4 id="支持移动端的依赖"><a href="#支持移动端的依赖" class="headerlink" title="支持移动端的依赖"></a>支持移动端的依赖</h4><p>jackson.jr，一个轻量级的更简单、更小的库。</p>
<p>仅依赖<code>jackson-core</code>，并不依赖于annotation和databind。</p>
<ol>
<li>Jackson三大核心模块大小：343KB（core）+ 66KB（annotation）+ 1.4M（databind）。</li>
<li>Jackson jr大小：96KB（jr） + 343KB（core)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.jr/jackson-jr-objects --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.jr<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-jr-objects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="JSON的三种处理方式"><a href="#JSON的三种处理方式" class="headerlink" title="JSON的三种处理方式"></a>JSON的三种处理方式</h3><table>
<thead>
<tr>
<th>方式</th>
<th>描述</th>
<th>隶属包</th>
</tr>
</thead>
<tbody>
<tr>
<td>流式API</td>
<td>读/写性能最好、开销最低、 速度最快； 其它2者都基于它实现。</td>
<td>jackson-core</td>
</tr>
<tr>
<td>树模型</td>
<td>类似于XML的DOM解析，层层嵌套。是最灵活的方式</td>
<td>jackson-core</td>
</tr>
<tr>
<td>数据绑定</td>
<td>JSON和POJO相互转换，是使用最方便的方式。使用最多。</td>
<td>jackson-databind</td>
</tr>
</tbody>
</table>
<ol>
<li>流式API，读取和写入JSON内容作为离散事件<ul>
<li>读数据：<code>org.codehaus.jackson.JsonParser</code></li>
<li>写数据：<code>org.codehaus.jackson.JsonGenerator</code></li>
<li>流式，指的是IO流，因此具有最低的开销。</li>
<li>使用流式API读写JSON的方式，使用的<strong>均是增量模式</strong>（每个部分一个一个地往上增加，类似于垒砖）</li>
<li>流式API里很重要的一个抽象概念<strong>JsonToken</strong>：每一部分都是一个独立的Token（有不同类型的Token），最终被“拼凑”起来就是一个JSON。</li>
</ul>
</li>
<li>树模型，JSON文件在内存里以树形式表示<ul>
<li><code>org.codehaus.jackson.map.ObjectMapper</code> 生成树</li>
<li>树组成<code>JsonNode</code> 节点集</li>
</ul>
</li>
<li>数据绑定，JSON和POJO相互转换<ul>
<li>简单数据绑定,是指从Java Map、List、String、Numbers、Boolean和空值进行转换</li>
<li>完整数据绑定,是指从任何Java bean类型 （及上文所述的”简单”类型） 进行转换</li>
<li>使用最方便的方式</li>
</ul>
</li>
</ol>
<h3 id="流式API"><a href="#流式API" class="headerlink" title="流式API"></a>流式API</h3><p>实际是i/o流读写。隶属于jackson-core包。</p>
<h4 id="写操作：JsonGenerator"><a href="#写操作：JsonGenerator" class="headerlink" title="写操作：JsonGenerator"></a>写操作：JsonGenerator</h4><h5 id="运行案例"><a href="#运行案例" class="headerlink" title="运行案例"></a>运行案例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ----------基本实现------</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJsonGenerator</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        JsonFactory factory = <span class="keyword">new</span> JsonFactory();</span><br><span class="line">        <span class="comment">// 将生成的json放到控制台，也可以放到文件（OutputStream）、网络（HttpOutputMessage）等</span></span><br><span class="line">        JsonGenerator jsonGenerator = factory.createGenerator(System.out, JsonEncoding.UTF8);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 体现了增量模式（每个部分一个一个地往上增加）</span></span><br><span class="line">            jsonGenerator.writeStartObject();</span><br><span class="line">            jsonGenerator.writeStringField(<span class="string">"name"</span>, <span class="string">"want"</span>);</span><br><span class="line">            jsonGenerator.writeNumberField(<span class="string">"age"</span>, <span class="number">23</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 只能出现一个独立key</span></span><br><span class="line">            <span class="comment">// jsonGenerator.writeFieldName("school");</span></span><br><span class="line">            <span class="comment">// jsonGenerator.writeFieldName("345");</span></span><br><span class="line">            jsonGenerator.writeFieldId(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">            jsonGenerator.writeEndObject();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            jsonGenerator.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// &#123;"name":"want","age":23,"123"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------try-with-resources实现（JsonGenerator实现了AutoCloseable接口）----</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJsonGeneratorAutoCloseable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     		OutputStream outputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"./jsonGenertor.txt"</span>);</span><br><span class="line">        <span class="keyword">try</span> (JsonGenerator jsonGenerator = factory.createGenerator(outputStream, JsonEncoding.UTF8)) &#123;</span><br><span class="line">            jsonGenerator.writeStartObject();</span><br><span class="line">            jsonGenerator.writeStringField(<span class="string">"name"</span>, <span class="string">"want"</span>);</span><br><span class="line">            jsonGenerator.writeNumberField(<span class="string">"age"</span>, <span class="number">23</span>);</span><br><span class="line">            jsonGenerator.writeEndObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ----------------实现了AutoCloseable接口-----------</span></span><br><span class="line"> 			<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Closeable</span> <span class="keyword">extends</span> <span class="title">AutoCloseable</span> </span>&#123;<span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;&#125;</span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonGenerator</span> <span class="keyword">implements</span> <span class="title">Closeable</span>, <span class="title">Flushable</span>, <span class="title">Versioned</span> </span>&#123;</span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">              <span class="keyword">super</span>.close();</span><br><span class="line">              <span class="comment">// 其他代码</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>try-with-resources：jdk1.7引入，一种语法糖，主要是替代了 try-catch-finally/try-finaly中的finally ，但是在编译的时候，还是会转回 try-catch-finally/try-finaly。</p>
<p>要求：在 try-with-resources 声明中定义的变量，要实现AutoCloseable 接口。</p>
<p>这样在系统可以自动调用它们的close方法，从而替代了finally中关闭资源的功能。</p>
<p>注意点：try-with-resources之后，又进行追加的catch 和 finally 中的代码，会在try-with-resources自动资源关闭之后才运行。</p>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/163106465" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/163106465</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// try-finaly</span></span><br><span class="line">InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    inputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"/my/file"</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// try-with-resources</span></span><br><span class="line"><span class="keyword">try</span> (InputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"/my/file"</span>)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以支持创建多个资源，先创建，后关闭</span></span><br><span class="line"><span class="keyword">try</span> (InputStream inputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"/my/file"</span>);</span><br><span class="line">     OutputStream outputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"./jsonGenertor.txt"</span>)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h5><ul>
<li><code>WriterBasedJsonGenerator</code>：基于:<code>java.io.Writer</code>处理字符编码（使用Writer输出JSON）<ul>
<li>因为UTF-8编码基本标准化了，因此Jackson内部也提供了<code>SegmentedStringWriter/UTF8Writer</code>来简化操作</li>
</ul>
</li>
<li><code>UTF8JsonGenerator</code>：基于OutputStream + UTF-8处理字符编码（默认指定使用UTF-8编码把字节变为字符）</li>
</ul>
<p><img src="C:\Users\luxia\AppData\Roaming\Typora\typora-user-images\1606270805638.png" alt="1606270805638"></p>
<h5 id="json实现"><a href="#json实现" class="headerlink" title="json实现"></a>json实现</h5><p><strong>key</strong>，可以独立存在（无需value），但value不能独立存在<code>{&quot;name&quot;:&quot;want&quot;,&quot;age&quot;:23,&quot;school&quot;}</code>。生成独立key方法如下：</p>
<ol>
<li>jsonGenerator.writeFieldName(“school”);</li>
<li>jsonGenerator.writeFieldId(123);只能是数字，且本质还是用writeFieldName来实现。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 独立存在的key,放到最后,因为碰到独立key,json就终止了</span><br><span class="line">            // jsonGenerator.writeFieldName(&quot;school&quot;);</span><br><span class="line">            // jsonGenerator.writeFieldName(&quot;345&quot;);</span><br><span class="line">            jsonGenerator.writeFieldId(123); // &#123;&quot;school&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>value</strong>，JSON中取值类型只能如下6种，但是Java中数据类型更丰富，需要JsonGenerator进行映射。</p>
<pre class="mermaid">graph LR
A(java数据类型) --JsonGenerator--> B(JSON数据格式)</pre>

<h6 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// key-value分开写</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"height"</span>);</span><br><span class="line">jsonGenerator.writeString(<span class="string">"170cm"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// key-value合并写法[推荐]</span></span><br><span class="line">jsonGenerator.writeStringField(<span class="string">"name"</span>, <span class="string">"want"</span>);</span><br></pre></td></tr></table></figure>
<p> Base64编码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonGenerator.writeFieldName(<span class="string">"base64"</span>);</span><br><span class="line">jsonGenerator.writeBinary(<span class="string">"hello,world!jackson!"</span>.getBytes()); <span class="comment">// "base64":"aGVsbG8sd29ybGQhamFja3NvbiE="</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并写法</span></span><br><span class="line">jsonGenerator.writeBinaryField(<span class="string">"base64"</span>, <span class="string">"hello,world!jackson!"</span>.getBytes())</span><br></pre></td></tr></table></figure>
<p>文本原样输出</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonGenerator.writeFieldName(<span class="string">"love1"</span>);</span><br><span class="line">jsonGenerator.writeString(<span class="string">"&#123;'love': 'batman'&#125;"</span>);<span class="comment">//"love1":"&#123;'love': 'batman'&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不做任何转义,也不添加分隔符</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"love2"</span>);</span><br><span class="line">jsonGenerator.writeRaw(<span class="string">"&#123;'love': 'batman'&#125;"</span>);<span class="comment">//"love2"&#123;'love': 'batman'&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不做任何转义,但添加分隔符</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"love3"</span>);</span><br><span class="line">jsonGenerator.writeRawValue(<span class="string">"&#123;'love': 'batman'&#125;"</span>);<span class="comment">//"love3":&#123;'love': 'batman'&#125;</span></span><br></pre></td></tr></table></figure>
<h6 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonGenerator.writeFieldName(<span class="string">"age"</span>);</span><br><span class="line">jsonGenerator.writeNumber(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并写法</span></span><br><span class="line">jsonGenerator.writeNumberField(<span class="string">"age"</span>, <span class="number">23</span>);</span><br></pre></td></tr></table></figure>
<h6 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonGenerator.writeFieldName(<span class="string">"isMan"</span>);</span><br><span class="line">jsonGenerator.writeBoolean(<span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//合并写法</span></span><br><span class="line">jsonGenerator.writeBooleanField(<span class="string">"isMan"</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<h6 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ------key-value分开写法------</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"friends"</span>);</span><br><span class="line">jsonGenerator.writeStartArray();</span><br><span class="line">            <span class="comment">// 数组元素-string</span></span><br><span class="line">            jsonGenerator.writeString(<span class="string">"tom"</span>);</span><br><span class="line">            </span><br><span class="line">						<span class="comment">// 数组元素-对象</span></span><br><span class="line">            jsonGenerator.writeStartObject();</span><br><span class="line">            jsonGenerator.writeStringField(<span class="string">"name"</span>, <span class="string">"zhou"</span>);</span><br><span class="line">            jsonGenerator.writeNumberField(<span class="string">"age"</span>, <span class="number">53</span>);</span><br><span class="line">            jsonGenerator.writeEndObject();</span><br><span class="line">            </span><br><span class="line">						<span class="comment">// 数组元素-数字</span></span><br><span class="line">            jsonGenerator.writeNumber(<span class="number">10</span>);</span><br><span class="line">jsonGenerator.writeEndArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------key-value合并写法------</span></span><br><span class="line"><span class="comment">// writeArrayFieldStart = writeFieldName + writeStartArray</span></span><br><span class="line">jsonGenerator.writeArrayFieldStart(<span class="string">"cakes"</span>);</span><br><span class="line">            jsonGenerator.writeString(<span class="string">"price"</span>);</span><br><span class="line">jsonGenerator.writeEndArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------快捷写入数组（从第index = 0位开始，取5个[0,0+5)）------</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"classmates"</span>);</span><br><span class="line">jsonGenerator.writeArray(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;, <span class="number">0</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<h6 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ------key-value分开写法------</span></span><br><span class="line">jsonGenerator.writeFieldName(<span class="string">"father"</span>);</span><br><span class="line">            <span class="comment">// JSON的顺序，和write的顺序保持一致</span></span><br><span class="line">            jsonGenerator.writeStartObject();</span><br><span class="line">            jsonGenerator.writeStringField(<span class="string">"name"</span>, <span class="string">"zhou"</span>);</span><br><span class="line">            jsonGenerator.writeNumberField(<span class="string">"age"</span>, <span class="number">53</span>);</span><br><span class="line">jsonGenerator.writeEndObject();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ------key-value合并写法------</span></span><br><span class="line"><span class="comment">// writeObjectFieldStart = writeFieldName + writeStartObject</span></span><br><span class="line">jsonGenerator.writeObjectFieldStart(<span class="string">"money"</span>);</span><br><span class="line">            jsonGenerator.writeStringField(<span class="string">"bank"</span>, <span class="string">"12345678901"</span>);</span><br><span class="line">jsonGenerator.writeEndObject();</span><br></pre></td></tr></table></figure>
<p>POJO实体类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// User实体类转json</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"loveName"</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer age = <span class="number">23</span>;</span><br><span class="line">    <span class="comment">// 其他</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义解码器</span></span><br><span class="line"><span class="comment"> * 用于把User写为JSON</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserObjectCodec</span> <span class="keyword">extends</span> <span class="title">ObjectCodec</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeValue</span><span class="params">(JsonGenerator gen, Object value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user = (User) value;</span><br><span class="line">        gen.writeStartObject();</span><br><span class="line">        gen.writeStringField(<span class="string">"name"</span>, user.getName());</span><br><span class="line">        gen.writeNumberField(<span class="string">"age"</span>, user.getAge());</span><br><span class="line">        gen.writeEndObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------执行JSON转换-----------</span></span><br><span class="line"><span class="comment">// 必须指定一个ObjectCodec解码器,才能转换实体类为JSON</span></span><br><span class="line"><span class="comment">// data-bind常见的ObjectMapper就是一个ObjectCodec解码器,这是ObjectMapper的原理雏形</span></span><br><span class="line">jsonGenerator.setCodec(<span class="keyword">new</span> UserObjectCodec());</span><br><span class="line">jsonGenerator.writeObject(<span class="keyword">new</span> User());</span><br></pre></td></tr></table></figure>
<p>嵌套实体类，其实是个树结构转JSON，但core模块没有提供树模型TreeNode的实现</p>
<p>实现方式：</p>
<ol>
<li>writeTree()</li>
<li>setCodec()解码器</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTreeNode</span> <span class="keyword">implements</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserTreeNode</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"loveName"</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer age = <span class="number">23</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTreeCodec</span> <span class="keyword">extends</span> <span class="title">ObjectCodec</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeValue</span><span class="params">(JsonGenerator gen, Object value)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> User) &#123;</span><br><span class="line">            user = User<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">value</span>)</span>; <span class="comment">// 类型强制转换等价于 (User) value</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> TreeNode) &#123;</span><br><span class="line">            user = UserTreeNode<span class="class">.<span class="keyword">class</span>.<span class="title">cast</span>(<span class="title">value</span>).<span class="title">getUser</span>()</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        gen.writeStartObject();</span><br><span class="line">        gen.writeStringField(<span class="string">"name"</span>, user.getName());</span><br><span class="line">        gen.writeNumberField(<span class="string">"age"</span>, user.getAge());</span><br><span class="line">        gen.writeEndObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJsonGeneratorTree</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JsonFactory jsonFactory = <span class="keyword">new</span> JsonFactory();</span><br><span class="line">    <span class="keyword">try</span> (JsonGenerator jsonGenerator = jsonFactory.createGenerator(System.out, JsonEncoding.UTF8)) &#123;</span><br><span class="line">        jsonGenerator.setCodec(<span class="keyword">new</span> UserTreeCodec());</span><br><span class="line">        jsonGenerator.writeTree(<span class="keyword">new</span> UserTreeNode(<span class="keyword">new</span> User()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="null"><a href="#null" class="headerlink" title="null"></a>null</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jsonGenerator.writeNullField(<span class="string">"weight"</span>);</span><br></pre></td></tr></table></figure>
<p>树模型</p>
<p><strong>writeTree()</strong></p>
]]></content>
  </entry>
  <entry>
    <title>linux</title>
    <url>/want/2020/06/25/linux/</url>
    <content><![CDATA[<h3 id="校验是否是同一个文件"><a href="#校验是否是同一个文件" class="headerlink" title="校验是否是同一个文件"></a>校验是否是同一个文件</h3><h4 id="md5sum"><a href="#md5sum" class="headerlink" title="md5sum"></a><strong>md5sum</strong></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">md5sum 文件名</span><br></pre></td></tr></table></figure>
<h4 id="sha1sum"><a href="#sha1sum" class="headerlink" title="sha1sum"></a>sha1sum</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sha1sum 文件名</span><br></pre></td></tr></table></figure>
<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><h4 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h4><ol>
<li>${var:=初始值} 调用初始值后，变量var也赋予了一个值</li>
<li>${var:-初始值}  临时调用，变量var并不改变，仍然为空</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@server0 ~]# a=$&#123;b:-12&#125;</span><br><span class="line">[root@server0 ~]# echo $a</span><br><span class="line">12</span><br><span class="line">[root@server0 ~]# echo $b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@server0 ~]# a=$&#123;b:=12&#125;</span><br><span class="line">[root@server0 ~]# echo $a</span><br><span class="line">12</span><br><span class="line">[root@server0 ~]# echo $b</span><br><span class="line">12</span><br></pre></td></tr></table></figure>
<h4 id="删除日志"><a href="#删除日志" class="headerlink" title="删除日志"></a>删除日志</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################删除文件#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">DAY=$&#123;1:-100&#125; #默认值100天</span><br><span class="line"></span><br><span class="line">BEFORE_COUNT=$(find ./microservice/logs -type f|wc -l) #统计原来的数量</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除100天前的操作</span></span><br><span class="line">find ./microservice/logs -mtime +$DAY -type f -name "*.log" | xargs rm -rf</span><br><span class="line"></span><br><span class="line">if [ $? = 0 ]</span><br><span class="line">then</span><br><span class="line">  AFTER_COUNT=$(find ./microservice/logs -type f|wc -l)</span><br><span class="line">  echo clear success!before_count=$BEFORE_COUNT,after_count=$AFTER_COUNT</span><br><span class="line">else echo 'clear fail!'</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################删除目录#################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">DAY=$&#123;1:-100&#125; #默认值100天</span><br><span class="line"></span><br><span class="line">BEFORE_COUNT=$(find . -type d|wc -l) #统计原来的数量</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除100天前的操作</span></span><br><span class="line">find . -mtime +$DAY -type d -name "*-M*" |xargs rm -rf</span><br><span class="line"></span><br><span class="line">if [ $? = 0 ]</span><br><span class="line">then</span><br><span class="line">  AFTER_COUNT=$(find . -type d|wc -l)</span><br><span class="line">  echo clear success!before_count=$BEFORE_COUNT,after_count=$AFTER_COUNT</span><br><span class="line">else echo 'clear fail!'</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h4 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h4><ol>
<li><p>直接赋值，格式为：变量名= 变量值</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">VAR='nice'</span><br></pre></td></tr></table></figure>
</li>
<li><p>Read 命令是系统内置命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">read -p "input a val:" VAR    #获取键盘输入的 VAR 变量</span><br><span class="line">read -p "please input your age: ,sex: " age sex #多个变量,以空格的形式截取</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用命令行参数赋值</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">0	<span class="comment">#shell脚本程序名</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">1	<span class="comment">#第一个参数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">2	<span class="comment">#第二个参数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="comment">#	#参数总数</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">*	<span class="comment">#所有位置的参数（所有参数）</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">?	<span class="comment">#上一次命令执行返回值</span></span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>利用命令的输出结果赋值：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">currentdir=`pwd`  </span><br><span class="line"> </span><br><span class="line">echo $currentdir</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>从文件中读入数据</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">HOSTLIST=$(cat hostList.txt)</span><br><span class="line"></span><br><span class="line">for HOST in $HOSTLIST</span><br></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/Dxd-python/articles/11125968.html" target="_blank" rel="noopener">https://www.cnblogs.com/Dxd-python/articles/11125968.html</a></p>
<h3 id="隐藏属性"><a href="#隐藏属性" class="headerlink" title="隐藏属性"></a>隐藏属性</h3><p>root</p>
<ol>
<li><p>chattr [+/-] [参数] [目录或文件]</p>
</li>
<li><p>lsattr [参数] [目录或文件]</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chattr +a test</span><br><span class="line">lsattr test</span><br><span class="line"></span><br><span class="line">chattr -a test</span><br><span class="line">lsattr test</span><br></pre></td></tr></table></figure>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>给文件/目录，赋予某用户/组的权限</p>
<ol>
<li>setfacl</li>
<li>getfacl</li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">setfacl -m u:luxia:rw- <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">-rw-rw-r--+ 1 root  root   6 Jun 25 10:14 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">getfacl <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="su-sudo"><a href="#su-sudo" class="headerlink" title="su / sudo"></a>su / sudo</h3><h4 id="su"><a href="#su" class="headerlink" title="su"></a>su</h4><p>su    需要输入目标用户的密码</p>
<ol>
<li><code>su</code>    不加用户，默认切到 root用户</li>
<li><code>su 用户名</code>    只能获得root的执行权限，不能获得环境变量(不改变当前用户的变量)</li>
<li><code>su - 用户名</code>    彻底切换为root用户（也切换了用户变量）</li>
</ol>
<h4 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h4><p>sudo    需要输入当前用户的密码</p>
<p><code>sudo 命令</code>    在当前用户下，执行root用户才能执行的命令。需要root给当前用户用visudo命令（或者编辑/etc/sudoers文件）配置权限</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户</span></span><br><span class="line">visudo 或者直接vim /etc/sudoers</span><br><span class="line"></span><br><span class="line">want ALL=(ALL) ALL</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到want用户</span></span><br><span class="line">sudo -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示无权限</span></span><br><span class="line">ls /root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以查看</span></span><br><span class="line">sudo ls /root</span><br></pre></td></tr></table></figure>
<p>`</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户</span></span><br><span class="line">visudo 或者直接vim /etc/sudoers</span><br><span class="line"></span><br><span class="line">want ALL=(ALL) /usr/bin/cat</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到want用户</span></span><br><span class="line">sudo -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提示无权限</span></span><br><span class="line">cat /etc/shadow</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以查看</span></span><br><span class="line">sudo cat /etc/shadow</span><br></pre></td></tr></table></figure>
<h3 id="ln"><a href="#ln" class="headerlink" title="ln"></a>ln</h3><p>ln [参数] 源文件 目标文件</p>
<ol>
<li>软连接，依赖源文件。</li>
<li>硬链接，不依赖源文件，类似于复制了一份文件。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"test link"</span> &gt;&gt; link.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">## 软连接</span></span><br><span class="line">ln -s link.txt  link2</span><br><span class="line"></span><br><span class="line">lrwxrwxrwx.  1 root root        8 Jun 25 11:37 link2 -&gt; link.txt</span><br><span class="line">-rw-r--r--.  1 root root       10 Jun 25 11:36 link.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">## 硬链接</span></span><br><span class="line">ln -s link.txt  link3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原始文件的硬盘链接数增加到2</span></span><br><span class="line">-rw-r--r--.  2 root root       10 Jun 25 11:39 link3</span><br><span class="line">-rw-r--r--.  2 root root       10 Jun 25 11:39 link.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除原始文件，软连接不能访问，硬链接仍然可以访问。</span></span><br><span class="line">lrwxrwxrwx.  1 root root        8 Jun 25 11:38 link2 -&gt; link.txt</span><br><span class="line">-rw-r--r--.  1 root root       10 Jun 25 11:39 link3</span><br></pre></td></tr></table></figure>
<h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><h4 id="ping"><a href="#ping" class="headerlink" title="ping"></a>ping</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ping -c 4 192.168.37.1</span><br><span class="line"></span><br><span class="line"><span class="comment">#参数</span></span><br><span class="line">-c 指明发送数据报文的次数</span><br><span class="line"></span><br><span class="line"><span class="comment">#退出</span></span><br><span class="line">Ctrl + C</span><br></pre></td></tr></table></figure>
<h4 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h4><p>安装（root用户）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 检查是否安装telnet,如果安装会有返回</span></span><br><span class="line">rpm -qa | grep telnet</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看可以查看的telnet相关的软件</span></span><br><span class="line">yum list | grep telnet</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">yum install -y telnet*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">或者指定具体安装内容</span></span><br><span class="line">yum install -y telnet-server.x86_64</span><br><span class="line">yum install -y telnet.x86_64</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">telnet 192.168.37.1 21</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 退出</span></span><br><span class="line">输入quit</span><br></pre></td></tr></table></figure>
<h4 id="traceroute"><a href="#traceroute" class="headerlink" title="traceroute"></a>traceroute</h4><ol>
<li>从计算机A到另一端主机B所经历的全部网络路径。</li>
<li>每次数据包由同样出发点（source）到达同样目的地(destination)走的路径可能不一样，大部分是相同的。</li>
<li>traceroute通过发送小的数据包到目的设备直到返回，来测量需要多长时间。一条路径上的每个设备traceroute要测3次。输出结果中包括每次测试的时间(ms)和设备的名称（如有）及其IP地址。</li>
<li>有些返回结果是星号*表示的，可能是防火墙封掉了ICMP的返回信息，所以得不到相关的数据包返回。</li>
</ol>
<p>命令：</p>
<ol>
<li>Linux，traceroute</li>
<li>Windows，tracert</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">traceroute 192.168.37.1</span><br><span class="line">traceroute www.baidu.com</span><br><span class="line"></span><br><span class="line">-q 默认向每个网关发送3个探测包，可以通过-q 指定次数。</span><br><span class="line">-d 使用Socket层级的排错功能。</span><br><span class="line">-f 设置第一个检测数据包的存活数值TTL的大小。</span><br><span class="line">-F 设置勿离断位。</span><br><span class="line">-g 设置来源路由网关，最多可设置8个。</span><br><span class="line">-i 使用指定的网络界面送出数据包。</span><br><span class="line">-I 使用ICMP回应取代UDP资料信息。</span><br><span class="line"></span><br><span class="line">-m 设置检测数据包的最大存活数值TTL的大小。【指定最多经过的路径跳数，默认30跳】</span><br><span class="line"></span><br><span class="line">-n 直接返回IP地址而非主机名称。【避免了域名的解析】</span><br><span class="line"></span><br><span class="line">-p 设置UDP传输协议的通信端口。</span><br><span class="line">-r 忽略普通的Routing Table，直接将数据包送到远端主机上。【绕过正常的路由表，直接发送到网络相连的主机】</span><br><span class="line">-s 设置本地主机送出数据包的IP地址。</span><br><span class="line">-t 设置检测数据包的TOS数值。</span><br><span class="line">-v 详细显示指令的执行过程。</span><br><span class="line">-w 设置等待远端主机回报的时间。【把对外发探测包的等待响应时间设置为XXX秒】</span><br><span class="line">-x 开启或关闭数据包的正确性检验。</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ol>
<li>traceroute <a href="https://blog.csdn.net/llq_200/article/details/81034345" target="_blank" rel="noopener">https://blog.csdn.net/llq_200/article/details/81034345</a></li>
</ol>
<h3 id="磁盘df"><a href="#磁盘df" class="headerlink" title="磁盘df"></a>磁盘df</h3><h4 id="查看所有磁盘分区的大小、已用、剩余"><a href="#查看所有磁盘分区的大小、已用、剩余" class="headerlink" title="查看所有磁盘分区的大小、已用、剩余"></a>查看所有磁盘分区的大小、已用、剩余</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">df -h</span><br><span class="line"></span><br><span class="line">Filesystem                       Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root               50G   41G  9.7G  81% /</span><br><span class="line">devtmpfs                          16G     0   16G   0% /dev</span><br><span class="line">tmpfs                             16G     0   16G   0% /dev/shm</span><br><span class="line">tmpfs                             16G  1.6G   15G  11% /run</span><br><span class="line">tmpfs                             16G     0   16G   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1                       1014M  140M  875M  14% /boot</span><br><span class="line">/dev/mapper/cl-home              142G  2.4G  139G   2% /home</span><br><span class="line">tmpfs                            3.2G     0  3.2G   0% /run/user/1001</span><br><span class="line">tmpfs                            3.2G     0  3.2G   0% /run/user/0</span><br><span class="line">dynamic.caiyun-clu-03.com:/HASZ  5.0T  209G  4.8T   5% /data</span><br></pre></td></tr></table></figure>
<h4 id="查看指定目录的磁盘剩余空间"><a href="#查看指定目录的磁盘剩余空间" class="headerlink" title="查看指定目录的磁盘剩余空间"></a>查看指定目录的磁盘剩余空间</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">df -h /usr/</span><br><span class="line"></span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root   50G   41G  9.7G  81% /</span><br></pre></td></tr></table></figure>
<h3 id="文件夹du"><a href="#文件夹du" class="headerlink" title="文件夹du"></a>文件夹du</h3><p>查看文件占用大小。用于快速定位大文件的位置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当前目录本身大小</span></span><br><span class="line">du -sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">指定文件、目录大小</span></span><br><span class="line">du -sh 文件或者目录</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前目录下所有文件大小</span></span><br><span class="line">du -sh *</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">指定目录下每个文件大小</span></span><br><span class="line">du -sh 目录/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">指定根目录下每个文件大小</span></span><br><span class="line">du -sh /*</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 目录+目录下所有子目录 大小</span></span><br><span class="line">du -h 目录					#查看指定目录下所有目录大小（含子目录）</span><br><span class="line">du -h --max-depth=1 /home/* #列出home下面所有一级目录的一级目录文件大小</span><br><span class="line">------------------------------------------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> 单位是MB</span></span><br><span class="line">du -sm</span><br></pre></td></tr></table></figure>
<h4 id="当前目录下的文件个数"><a href="#当前目录下的文件个数" class="headerlink" title="当前目录下的文件个数"></a>当前目录下的文件个数</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看当前目录下有多少文件、目录</span></span><br><span class="line">ls |wc -l</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">只查看目录个数</span></span><br><span class="line">find . -type d|wc -l</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">只查看文件个数</span></span><br><span class="line">find . -type f|wc -l</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>maven</title>
    <url>/want/2020/05/25/maven/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>一个项目管理工具，</p>
<ol>
<li>服务于java平台，也是由java编码</li>
<li>发展：Make-&gt;Ant-&gt;Maven-&gt;Gradle</li>
</ol>
<p>包含：</p>
<ol start="2">
<li>一个项目生命周期</li>
<li>一个Project Object Model 项目对象模型（抽象的生命周期定义）</li>
<li>一个依赖管理系统（具体实现生命周期）</li>
<li>一组标准集合</li>
<li>运行定义在生命周期阶段中插件目标的逻辑</li>
</ol>
<h4 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h4><ol>
<li>自动化构建工程</li>
<li>管理jar包</li>
<li>编译代码</li>
<li>自动运行单元测试、打包、生成报表、部署项目、生成web站点。。。</li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol>
<li><p>保证JDK安装</p>
</li>
<li><p>环境变量</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MAVEN_HOME</span><br><span class="line">%MAVEN_HOME%\bin;</span><br><span class="line"></span><br><span class="line">// 有时候使用M2_HOME为了向旧版本兼容。</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>mvn -v</li>
</ol>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>Maven生命周期，能够自动化完成项目构建的整个过程。</p>
<h4 id="常规构建过程"><a href="#常规构建过程" class="headerlink" title="常规构建过程"></a>常规构建过程</h4><p>以java源文件、框架文件、静态资源等作为原材料，生产得到一个可运行项目。具体包括：</p>
<ol>
<li>清理：删除旧class文件</li>
<li>编译：.java源文件 -&gt; .class字节码文件（JVM可执行文件）</li>
<li>测试：自动测试，自动调用junit程序</li>
<li>报告：测试结果</li>
<li>打包：动态web工程打war包，java工程打jar包</li>
<li>安装：Maven特定概念，打包文件复制到仓库指定位置（mvn install）</li>
<li>部署：war包复制到指定目录，使其可运行</li>
</ol>
<h4 id="Maven生命周期"><a href="#Maven生命周期" class="headerlink" title="Maven生命周期"></a>Maven生命周期</h4><p>maven核心程序定义了抽象的生命周期（各个构建环节），生命周期的各个阶段具体依赖插件完成。</p>
<p>三套相互独立的生命周期，三套生命周期的命令可以相互组合，分别是：</p>
<ol>
<li>Clean Lifecycle：清理工作<ul>
<li>pre-clean</li>
<li>clean：移除上一次构建文件</li>
<li>post-clean</li>
</ul>
</li>
<li>Default Lifecycle：构建核心，编译、测试、打包、安装、部署<ul>
<li>validate</li>
<li>compile</li>
<li>test</li>
<li>package</li>
<li>verify</li>
<li>install</li>
<li>deploy</li>
</ul>
</li>
<li>Site Lifecycle：生成报告、站点文档、发布站点<ul>
<li>pre-site</li>
<li>site：生成项目的站点文档</li>
<li>post-site</li>
<li>site-deploy：发布、部署生成的文档到特定服务器</li>
</ul>
</li>
</ol>
<p>当执行某个环节的命令时，如mvn test，其实maven会帮我们从生命周期最开始一直执行到mvn test，是个累进执行的过程。</p>
<h4 id="Maven命令"><a href="#Maven命令" class="headerlink" title="Maven命令"></a>Maven命令</h4><p>通过mvn命令，执行生命周期的各个阶段。</p>
<p>注意：一定要在pom.xml目录下，执行Maven命令。</p>
<p>常见命令如下：</p>
<ol>
<li><p>mvn clean</p>
</li>
<li><p>mvn compile</p>
</li>
<li><p>mvn package</p>
</li>
<li><p>mvn install: 安装</p>
<ul>
<li>把自定义的maven项目，安装至本地仓库。</li>
</ul>
</li>
</ol>
<ol start="5">
<li><p>mvn test-compile：编译测试程序</p>
</li>
<li><p>mvn test：执行测试</p>
</li>
</ol>
<ol start="7">
<li>mvn site</li>
</ol>
<h3 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h3><ol>
<li>Project Object Model 项目对象模型</li>
<li>pom.xml是maven工程的核心<strong>配置</strong>文件，配置构建过程的一切设置。</li>
</ol>
<h4 id="build"><a href="#build" class="headerlink" title="build"></a>build</h4><p>如果没有特殊配置，Maven会按照标准的目录结构查找和处理各种类型文件。</p>
<table>
<thead>
<tr>
<th>源代码目录</th>
<th>打包文件</th>
<th>打包目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>src/main/java</td>
<td>仅*.java</td>
<td>target/classes</td>
</tr>
<tr>
<td>src/test/java</td>
<td>仅*.java</td>
<td>targe/test-classes</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>src/main/resouces</td>
<td>所有文件</td>
<td>target/classes</td>
</tr>
<tr>
<td>src/test/resources</td>
<td>所有文件</td>
<td>target/test-classes</td>
</tr>
</tbody>
</table>
<ol>
<li>若将资源文件(xml，properites，xsd等)放在src/main/resources目录，maven默认把资源文件打包到相应的jar或者war里。</li>
<li>若将资源文件(mybatis的mapper.xml)放到src/main/java目录，则maven默认只打包java文件，而忽略.xml文件，<strong>需要在pom.xml中，进行配置</strong>。</li>
</ol>
<p>包含/排除特殊文件打包的配置方案有两种：</p>
<ol>
<li><build>元素下添加<resources>进行配置。不需要任何插件。</resources></build></li>
<li><build>的<plugins>子元素中配置maven-resources-plugin等处理资源文件的插件。</plugins></build></li>
</ol>
<h5 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h5><p>**/*：是为了保证各级子目录下的资源文件被打包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">includes</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">includes</span>&gt;</span>  </span><br><span class="line">      <span class="comment">&lt;!-- 处理主资源目下的资源文件时，是否对主资源目录开启资源过滤 --&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">resources</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认resources目录下的文件都会被打包</p>
<p>如果想过滤resources目录特殊文件，需要手动配置:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--过滤resource下的文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">includes</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">includes</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">excludes</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>app/**/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>node/**/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resources</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="插件"><a href="#插件" class="headerlink" title="插件"></a><strong>插件</strong></h5><p>resource功能可以使用插件实现，另外，插件具有自定义资源目录等额外功能。</p>
<ol>
<li><p>maven-resources-plugin：资源处理插件，可添加额外的资源文件目录</p>
</li>
<li><p>build-helper-maven-plugin：另一种资源处理插件</p>
</li>
<li><p>maven-compiler-plugin：java代码处理插件</p>
</li>
<li><p>maven-jar-plugin：target/classes目录中的一些文件不希望打入jar包中</p>
</li>
</ol>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>maven核心程序只定义抽象的生命周期，具体实现需要特定的依赖。</p>
<h4 id="依赖的来源"><a href="#依赖的来源" class="headerlink" title="依赖的来源"></a>依赖的来源</h4><h5 id="类别"><a href="#类别" class="headerlink" title="类别"></a>类别</h5><ol>
<li>本地仓库：部署在本地电脑，为本地电脑所有Maven工程服务</li>
<li>私服：局域网环境。私服与外网环境交流。供局域网内部使用。<ul>
<li>Maven私服产品Nexus。Nexus</li>
</ul>
</li>
<li>中央仓库：互联网，为全世界maven服务。</li>
<li>中央仓库镜像：分担中央仓库流量压力，提升用户访问速度。</li>
</ol>
<h5 id="仓库保存的内容"><a href="#仓库保存的内容" class="headerlink" title="仓库保存的内容"></a>仓库保存的内容</h5><ol>
<li>maven所需插件</li>
<li>第三方框架或工具的jar包<ul>
<li>第一方是JDK，第二方是开发者</li>
</ul>
</li>
<li>自己开发的maven工程</li>
</ol>
<h4 id="项目引用依赖的过程"><a href="#项目引用依赖的过程" class="headerlink" title="项目引用依赖的过程"></a>项目引用依赖的过程</h4><p>当执行maven命令，需要某些依赖包时，</p>
<ol>
<li>首先在本地仓库查找<ul>
<li>默认：用户电脑家目录.m2\repository </li>
<li>自定义：\maven目录\conf\settings.xml，修改localRepository标签</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;localRepository&gt;E:\repository&lt;/localRepository&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>本地找不到，会自动连外网到中央仓库下载</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https://mvnrepository.com/</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>外网连接失败，则构建失败</li>
</ol>
<h4 id="定位依赖（坐标）"><a href="#定位依赖（坐标）" class="headerlink" title="定位依赖（坐标）"></a>定位依赖（坐标）</h4><p>Maven坐标在仓库中唯一定位一个Maven工程，包括如下内容，简称gav。</p>
<ol>
<li>groupId：公司组织域名的倒序 + 项目名</li>
<li>artifactId：模块名</li>
<li>version：版本</li>
</ol>
<p>一个项目可以包含多个模块，或一个项目只有一个模块。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">项目名与模块名相同</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">项目名与模块名不同</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Maven坐标，与仓库中的路径，一致</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">groupId / artifactId / version / artifactId-version.jar</span><br><span class="line">io/springfox/springfox-swagger2/2.8.0/springfox-swagger2-2.8.0.jar</span><br><span class="line"></span><br><span class="line">如，结合本地仓库地址：</span><br><span class="line">E:\repository\io\springfox\springfox-swagger2\2.8.0\springfox-swagger2-2.8.0.jar</span><br></pre></td></tr></table></figure>
<h4 id="依赖作用范围"><a href="#依赖作用范围" class="headerlink" title="依赖作用范围"></a>依赖作用范围</h4><p>依赖的作用范围scope，常见取值：</p>
<ol>
<li>compile（默认）</li>
<li>test</li>
<li><p>provided</p>
<ul>
<li>相对于compile的区别：在打包阶段进行了exclude操作，不参与打包</li>
</ul>
</li>
<li><p>system</p>
<ul>
<li><p>与provided基本相同。</p>
</li>
<li><p>相对于provided的区别：不从maven仓库获取，而是从本地文件系统提取，利用systemPath指定路径。</p>
</li>
</ul>
</li>
<li>import<ul>
<li>maven2.0.9版本后的属性</li>
<li>只能在dependencyManagement的中使用，解决maven单继承问题</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th>scope</th>
<th>对主程序src/main是否有效</th>
<th>对测试程序src/test是否有效</th>
<th>是否参与打包</th>
</tr>
</thead>
<tbody>
<tr>
<td>compile</td>
<td>有效</td>
<td>有效</td>
<td>参与</td>
</tr>
<tr>
<td>test</td>
<td></td>
<td>有效</td>
<td></td>
</tr>
<tr>
<td>provided</td>
<td>有效</td>
<td>有效</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 本地依赖统一放到项目的lib目录下--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.bull.javamelody<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javamelody-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.75.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>system<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">systemPath</span>&gt;</span>$&#123;basedir&#125;/lib/javamelody-core-1.75.0.jar<span class="tag">&lt;/<span class="name">systemPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="依赖传递"><a href="#依赖传递" class="headerlink" title="依赖传递"></a>依赖传递</h4><ol>
<li><p>compile范围的依赖，自动传递：父项目pom.xml配置的依赖，各个子模块自动继承，不必再次声明。</p>
</li>
<li><p>非compile范围的依赖，不能传递。</p>
</li>
</ol>
<h4 id="依赖排除"><a href="#依赖排除" class="headerlink" title="依赖排除"></a>依赖排除</h4><p>依赖中排除特定jar包。被排除的内容也会具有传递性，在子项目中也会被排除。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="依赖原则"><a href="#依赖原则" class="headerlink" title="依赖原则"></a>依赖原则</h4><p>用于解决模块工程之间的jar包冲突问题：</p>
<ol>
<li>就近原则：如果从祖父、父模块，分别继承同一个jar包不同版本，则采取就近原则，使用父模块版本号。</li>
<li>先声明者优先（dependency顺序）：同时依赖了两个不同版本的jar包，则谁先声明谁优先。</li>
</ol>
<h4 id="统一管理依赖版本号"><a href="#统一管理依赖版本号" class="headerlink" title="统一管理依赖版本号"></a>统一管理依赖版本号</h4><h5 id="properties标签"><a href="#properties标签" class="headerlink" title="properties标签"></a>properties标签</h5><p>properties标签配合自定义标签不一定仅用于版本号，可以用于其他自定义场景。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 统一定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">net.version</span>&gt;</span>1.3.4-SNAPSHOT<span class="tag">&lt;/<span class="name">net.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">tomcat.version</span>&gt;</span>8.5.51<span class="tag">&lt;/<span class="name">tomcat.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 调用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;tomcat.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h5><ol>
<li>统一在父工程配置版本【父，只负责管理版本，不负责真正下载】</li>
<li>在子工程中声明依赖时，不指定版本【子，负责声明所需依赖，不负责版本】</li>
</ol>
<p>父工程</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>父工程groupId<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>父工程artifactId<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>父工程版本号<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子工程</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 指定父工程 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>父工程groupId<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>父工程artifactId<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>父工程版本号<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 子工程pom.xml为准的父工程pom.xml的相对路径 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h5><p>使用了继承的工程，mvn 安装要先安装父工程，再安装子工程。</p>
<p>可以使用聚合，来一键安装所有模块的依赖。</p>
<p>父工程</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 指定各子工程的相对路径，maven可以自动识别依赖顺序 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>net<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">module</span>&gt;</span>platform<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置构建过程中的特殊设置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 配置构建过程中的使用的插件 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li>生命周期：<a href="http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference" target="_blank" rel="noopener">http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference</a></li>
<li>maven依赖：<a href="https://mvnrepository.com/" target="_blank" rel="noopener">https://mvnrepository.com/</a></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>mybatis_plus</title>
    <url>/want/2021/02/08/mybatis-plus/</url>
    <content><![CDATA[<p>Mybatis Plus是Mybatis 增强版工具</p>
<ol>
<li>已经封装好一些crud方法，不需再写xml，直接调用这些方法即可。</li>
</ol>
<p>如果集成mybatis-plus，就把mybatis、mybatis-spring去掉，避免冲突</p>
<h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>Latest Version<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"tb_employee"</span>)  <span class="comment">//指定表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line">    <span class="comment">//value与数据库主键列名一致，若实体类属性名与表主键列名一致可省略value</span></span><br><span class="line">    <span class="meta">@TableId</span>(value = <span class="string">"id"</span>,type = IdType.AUTO)<span class="comment">//指定自增策略</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//若没有开启驼峰命名，或者表中列名不符合驼峰规则，可通过该注解指定数据库表中的列名，exist标明数据表中有没有对应列</span></span><br><span class="line">    <span class="meta">@TableField</span>(value = <span class="string">"last_name"</span>,exist = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他不需要特别处理</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h4><p>不需要写xml映射，不需要定义任何接口方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EmplopyeeDao</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Employee</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="crud操作"><a href="#crud操作" class="headerlink" title="crud操作"></a>crud操作</h3><ol>
<li>大部分<strong>单表 CRUD 操作</strong>，仅仅需要继承一个 <strong>BaseMapper</strong> 即可实现。</li>
<li>复杂CRUD操作，使用条件构造器： <strong>EntityWrapper</strong> 或 <strong>Condition</strong>。</li>
</ol>
<h4 id="基本crud操作"><a href="#基本crud操作" class="headerlink" title="基本crud操作"></a>基本crud操作</h4><h5 id="增"><a href="#增" class="headerlink" title="增"></a>增</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//insert 可以拿到insert之后的记录id</span></span><br><span class="line">Employee employee = <span class="keyword">new</span> Employee();</span><br><span class="line"><span class="keyword">int</span> emplopyeeDao.insert(employee);</span><br></pre></td></tr></table></figure>
<h5 id="删"><a href="#删" class="headerlink" title="删"></a>删</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// deleteById 根据id删除</span></span><br><span class="line">emplopyeeDao.deleteById(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// deleteBatchIds 根据多个id批量删除</span></span><br><span class="line"> List&lt;Integer&gt; idList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"> idList.add(<span class="number">1</span>);</span><br><span class="line"> idList.add(<span class="number">2</span>);</span><br><span class="line"> emplopyeeDao.deleteBatchIds(idList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// deleteByMap 根据自定义条件删除，返回值是Integer类型，表示影响的行数。</span></span><br><span class="line">Map&lt;String,Object&gt; columnMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">columnMap.put(<span class="string">"gender"</span>,<span class="number">0</span>);</span><br><span class="line">columnMap.put(<span class="string">"age"</span>,<span class="number">18</span>);</span><br><span class="line">emplopyeeDao.deleteByMap(columnMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 entity 条件，删除记录(条件构造器)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; wrapper)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="改"><a href="#改" class="headerlink" title="改"></a>改</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//updateById  根据id进行更新，只更新传值的属性，没有传值的属性就不会更新</span></span><br><span class="line">emplopyeeDao.updateById(employee);</span><br><span class="line"></span><br><span class="line"><span class="comment">//updateAllColumnById  根据id进行更新，默认更新所有属性，没传值的属性就更新为null</span></span><br><span class="line"><span class="comment">//emplopyeeDao.updateAllColumnById(employee);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//update  根据 whereEntity 条件，更新记录(条件构造器)</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(@Param(Constants.ENTITY)</span> T entity, @<span class="title">Param</span><span class="params">(Constants.WRAPPER)</span> Wrapper&lt;T&gt; updateWrapper)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="查"><a href="#查" class="headerlink" title="查"></a>查</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// selectById 只根据一个id，查询一条</span></span><br><span class="line">Employee employee = emplopyeeDao.selectById(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectBatchIds 根据多个id，批量查询</span></span><br><span class="line">List&lt;Integer&gt; idList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">idList.add(<span class="number">1</span>);</span><br><span class="line">idList.add(<span class="number">2</span>);</span><br><span class="line">idList.add(<span class="number">3</span>);</span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectBatchIds(idList);</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectOne 根据自定义条件，查询一条记录（若符合条件的记录有多条，不能使用这个方法，会直接报错！）</span></span><br><span class="line">emplopyeeDao.selectOne(employeeCondition);</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectByMap 根据自定义条件，查询多条记录（查询条件用map集合封装）</span></span><br><span class="line">Map&lt;String,Object&gt; columnMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">columnMap.put(<span class="string">"last_name"</span>,<span class="string">"tom"</span>);<span class="comment">//严格写表中的列名(而非实体类)</span></span><br><span class="line">columnMap.put(<span class="string">"gender"</span>,<span class="string">"1"</span>);</span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectByMap(columnMap);</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectList 根据 entity 条件，查询全部记录</span></span><br><span class="line"><span class="function">List&lt;T&gt; <span class="title">selectList</span><span class="params">(@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// selectMaps 根据 Wrapper 条件，查询全部记录,</span></span><br><span class="line">List&lt;Map&lt;String, Object&gt;&gt; selectMaps(<span class="meta">@Param</span>(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);</span><br><span class="line"><span class="comment">// selectObjs 根据 Wrapper 条件，查询全部记录。注意： 只返回第一个字段的值</span></span><br><span class="line"><span class="function">List&lt;Object&gt; <span class="title">selectObjs</span><span class="params">(@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// selectPage 根据 entity 条件，查询全部记录（并翻页）</span></span><br><span class="line"><span class="function">IPage&lt;T&gt; <span class="title">selectPage</span><span class="params">(IPage&lt;T&gt; page, @Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 Wrapper 条件，查询全部记录（并翻页）</span></span><br><span class="line">IPage&lt;Map&lt;String, Object&gt;&gt; selectMapsPage(IPage&lt;T&gt; page, <span class="meta">@Param</span>(Constants.WRAPPER) Wrapper&lt;T&gt; queryWrapper);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 Wrapper 条件，查询总记录数</span></span><br><span class="line"><span class="function">Integer <span class="title">selectCount</span><span class="params">(@Param(Constants.WRAPPER)</span> Wrapper&lt;T&gt; queryWrapper)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="条件构造器crud"><a href="#条件构造器crud" class="headerlink" title="条件构造器crud"></a>条件构造器crud</h4><p><strong>使用MyBatis :</strong> 需要在 SQL 映射文件中编写带条件查询的 SQL,并用PageHelper 插件完成分页. 实现以上一个简单的需求，往往需要我们做很多重复单调的工作。<br><strong>使用MybatisPlus:</strong> 依旧不用编写 SQL 语句，MP 提供了功能强大的条件构造器。</p>
<p><strong>条件构造器</strong>：</p>
<ol>
<li>Condition：调create方法创建出来，Condition.create()</li>
<li>EntityWrapper：是new出来的，new EntityWrapper&lt;&gt;()</li>
</ol>
<h5 id="查-1"><a href="#查-1" class="headerlink" title="查"></a>查</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 分页查询 selectPage</span></span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectPage(<span class="keyword">new</span> Page&lt;Employee&gt;(<span class="number">1</span>,<span class="number">3</span>),</span><br><span class="line">     <span class="keyword">new</span> EntityWrapper&lt;Employee&gt;()</span><br><span class="line">        .between(<span class="string">"age"</span>,<span class="number">18</span>,<span class="number">50</span>)</span><br><span class="line">        .eq(<span class="string">"gender"</span>,<span class="number">0</span>)</span><br><span class="line">        .eq(<span class="string">"last_name"</span>,<span class="string">"tom"</span>) <span class="comment">// 注意column是数据表对应的字段，而非实体类属性字段。</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectPage(<span class="keyword">new</span> Page&lt;Employee&gt;(<span class="number">1</span>,<span class="number">3</span>),</span><br><span class="line">     Condition.create()</span><br><span class="line">        .between(<span class="string">"age"</span>,<span class="number">18</span>,<span class="number">50</span>)</span><br><span class="line">        .eq(<span class="string">"gender"</span>,<span class="number">0</span>)</span><br><span class="line">        .eq(<span class="string">"last_name"</span>,<span class="string">"tom"</span>) <span class="comment">// 注意column是数据表对应的字段，而非实体类属性字段。</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// null，表示没有查询条件</span></span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectPage(<span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>,<span class="number">2</span>),<span class="keyword">null</span>);</span><br><span class="line">System.out.println(employees);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量查询 selectList, like</span></span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectList(</span><br><span class="line">     <span class="keyword">new</span> EntityWrapper&lt;Employee&gt;()</span><br><span class="line">        .eq(<span class="string">"gender"</span>,<span class="number">0</span>)</span><br><span class="line">        .like(<span class="string">"last_name"</span>,<span class="string">"老师"</span>) <span class="comment">// like方法模糊查询</span></span><br><span class="line">        <span class="comment">//.or()//和or new 区别不大</span></span><br><span class="line">        .orNew()</span><br><span class="line">        .like(<span class="string">"email"</span>,<span class="string">"a"</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量查询 selectList, last</span></span><br><span class="line">List&lt;Employee&gt; employees = emplopyeeDao.selectList(</span><br><span class="line">     <span class="keyword">new</span> EntityWrapper&lt;Employee&gt;()</span><br><span class="line">        .eq(<span class="string">"gender"</span>,<span class="number">0</span>)</span><br><span class="line">        .orderBy(<span class="string">"age"</span>)<span class="comment">//升序，orderByDesc是降序</span></span><br><span class="line">        .last(<span class="string">"desc limit 1,3"</span>)<span class="comment">//在sql语句后面直接追加last里面的内容(改为降序，同时分页)</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="改-1"><a href="#改-1" class="headerlink" title="改"></a>改</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// update  根据条件EntityWrapper，只更新明文设置的属性</span></span><br><span class="line">Employee employee = <span class="keyword">new</span> Employee();</span><br><span class="line">employee.setGender(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">emplopyeeDao.update(employee,</span><br><span class="line">     <span class="keyword">new</span> EntityWrapper&lt;Employee&gt;()</span><br><span class="line">        .eq(<span class="string">"last_name"</span>,<span class="string">"tom"</span>)</span><br><span class="line">        .eq(<span class="string">"age"</span>,<span class="number">25</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h5 id="删-1"><a href="#删-1" class="headerlink" title="删"></a>删</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// delete 把符合条件的全部删除</span></span><br><span class="line">emplopyeeDao.delete(</span><br><span class="line">        <span class="keyword">new</span> EntityWrapper&lt;Employee&gt;()</span><br><span class="line">        .eq(<span class="string">"last_name"</span>,<span class="string">"tom"</span>)</span><br><span class="line">        .eq(<span class="string">"age"</span>,<span class="number">16</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="ActiveRecord"><a href="#ActiveRecord" class="headerlink" title="ActiveRecord"></a>ActiveRecord</h3><p>AR是一种领域模型。领域模型的特点是一个模型类对应关系型数据库中的一个表，模型类的一个实例对应表中的一行记录。</p>
<p>所谓AR操作，是通过对象本身调用相关方法，比如要insert一个user，那就用这个user调用insert方法即可<code>user.insert()</code>。</p>
<p>MPlus 实现了只需要让实体类继承 <strong>Model</strong> 类且实现主键指定方法，即可使用AR。</p>
<p>步骤1：让实体类继承 <strong>Model</strong> 类，并实现指定主键的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer gender;</span><br><span class="line">    <span class="comment">//重写这个方法，return当前类的主键</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">pkVal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>步骤2：虽然AR模式用不到该接口，但是一定要定义，否则使用AR时会报空指针异常。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>步骤3：</p>
<p>可看到，不需要引入mapper接口（UserDao），就可以直接使用insert方法！不过，虽然不需要引入，但还是要定义，否则会报错。</p>
<p><code>user.insert();</code>就是AR的写法，可以看到返回值为布尔类型。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">user.setAge(<span class="number">22</span>);</span><br><span class="line">user.setGender(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">boolean</span> result = user.insert();</span><br><span class="line"></span><br><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">user.setId(<span class="number">1</span>);</span><br><span class="line">user.setName(<span class="string">"刘亦菲"</span>);</span><br><span class="line"><span class="keyword">boolean</span> result = user.updateById();</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> result = user.selectCount(<span class="keyword">new</span> EntityWrapper&lt;User&gt;().eq(<span class="string">"gender"</span>,<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">boolean</span> result = user.delete(<span class="keyword">new</span> EntityWrapper&lt;User&gt;().like(<span class="string">"name"</span>,<span class="string">"玲"</span>));</span><br></pre></td></tr></table></figure>
<h3 id="特殊用法"><a href="#特殊用法" class="headerlink" title="特殊用法"></a>特殊用法</h3><h4 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableLogic</span> <span class="comment">//标记逻辑删除属性</span></span><br><span class="line"><span class="keyword">private</span> Integer logicFlag;</span><br><span class="line"></span><br><span class="line">则执行delete语句时候，并不会真的删除，而是把被 <span class="meta">@TableLogic</span>修饰的字段，修改一下标志位</span><br></pre></td></tr></table></figure>
<h4 id="填充默认值"><a href="#填充默认值" class="headerlink" title="填充默认值"></a>填充默认值</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableField</span>(fill = FieldFill.INSERT, update = <span class="string">"now()"</span>) <span class="comment">// 插入时，填充now()</span></span><br><span class="line">override <span class="keyword">var</span> createdTime: Date = Date()</span><br><span class="line"></span><br><span class="line"><span class="meta">@TableField</span>(fill = FieldFill.INSERT_UPDATE)<span class="comment">//插入和更新时填充</span></span><br><span class="line"> <span class="keyword">private</span> String name;</span><br></pre></td></tr></table></figure>
<h4 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">private</span> GradeEnum grade;</span><br><span class="line"><span class="keyword">private</span> AgeEnum age;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GradeEnum &#123;</span><br><span class="line"></span><br><span class="line">    PRIMARY(<span class="number">1</span>, <span class="string">"小学"</span>),</span><br><span class="line">    SECONDORY(<span class="number">2</span>, <span class="string">"中学"</span>),</span><br><span class="line">    HIGH(<span class="number">3</span>, <span class="string">"高中"</span>);</span><br><span class="line"></span><br><span class="line">    GradeEnum(<span class="keyword">int</span> code, String descp) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.descp = descp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String descp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义方式2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AgeEnum implements IEnum&lt;Integer&gt; &#123;</span><br><span class="line">    ONE(<span class="number">1</span>, <span class="string">"一岁"</span>),</span><br><span class="line">    TWO(<span class="number">2</span>, <span class="string">"二岁"</span>),</span><br><span class="line">    THREE(<span class="number">3</span>, <span class="string">"三岁"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>枚举序列化（翻倍入库）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// springboot + jackson为例</span></span><br><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> GradeEnum &#123;</span><br><span class="line"></span><br><span class="line">    PRIMARY(<span class="number">1</span>, <span class="string">"小学"</span>),</span><br><span class="line">    SECONDORY(<span class="number">2</span>, <span class="string">"中学"</span>),</span><br><span class="line">    HIGH(<span class="number">3</span>, <span class="string">"高中"</span>);</span><br><span class="line"></span><br><span class="line">    GradeEnum(<span class="keyword">int</span> code, String descp) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.descp = descp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValue</span></span><br><span class="line">    <span class="meta">@JsonValue</span>	<span class="comment">//标记响应json值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String descp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="字段类型处理器"><a href="#字段类型处理器" class="headerlink" title="字段类型处理器"></a>字段类型处理器</h4><p>类型处理器：</p>
<ol>
<li>用于 JavaType 与 JdbcType 之间的转换</li>
<li><p>用于 PreparedStatement 设置参数值和从 ResultSet 或 CallableStatement 中取出一个值。</p>
<p><code>mybaits-plus</code> 内置常用类型处理器，通过<code>TableField</code>注解快速注入到 <code>mybatis</code> 容器中。</p>
</li>
</ol>
<h3 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h3><h4 id="分页插件："><a href="#分页插件：" class="headerlink" title="分页插件："></a>分页插件：</h4><p>BaseMapper的selectPage方法和AR提供的selectPage方法都不是物理分页，需要配置分页插件后才是物理分页</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//配置了分页插件后，还是和以前一样的使用selectpage方法，</span></span><br><span class="line"><span class="comment">//但是现在就是真正的物理分页了，sql语句中有limit了</span></span><br><span class="line">Page&lt;Employee&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">List&lt;Employee&gt; employeeList = emplopyeeDao.selectPage(page, <span class="literal">null</span>);</span><br><span class="line">page.setRecords(employeeList);</span><br></pre></td></tr></table></figure>
<p>数据库框架：Mybatis Plus &gt; Mybatis</p>
<p>代码生成器：Mybatis Plus Generator &gt; Mybatis Generator</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://mp.baomidou.com/guide/" target="_blank" rel="noopener">官网</a></p>
]]></content>
  </entry>
  <entry>
    <title>sftp</title>
    <url>/want/2020/06/11/sftp/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>SFTP是SSH的一部分，在SSH软件包中，已包含SFTP的安全文件信息传输子系统，它必须使用sshd守护进程(端口号默认是22)来完成相应的连接和答复操作。</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>SFTP</th>
<th>FTP</th>
</tr>
</thead>
<tbody>
<tr>
<td>是否额外安装</td>
<td>不需要。linux默认安装ssh，有SSH即有SFTP</td>
<td>Linux默认不提供ftp，需要手动安装FTP服务器</td>
</tr>
<tr>
<td>安全</td>
<td>更高。在ftp的基础上加密传输认证信息、数据。需要用户名密码登录，也需要密钥加密。</td>
<td>比sftp略差。有可能要求基于密码的安全验证。</td>
</tr>
<tr>
<td>端口</td>
<td>通过SSH协议(TCP端口22)建立连接</td>
<td>通过TCP端口21上的控制连接建立连接</td>
</tr>
<tr>
<td>协议</td>
<td>Secure File Transfer Protocol，SSH加密的文件传输协议</td>
<td>File Transfer Protocol，文件传输协议</td>
</tr>
<tr>
<td>效率</td>
<td>传输效率比普通的FTP要低</td>
<td>较高</td>
</tr>
</tbody>
</table>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="用户权限配置"><a href="#用户权限配置" class="headerlink" title="用户权限配置"></a>用户权限配置</h4><p>修改sftp配置的目的是：限制【特定用户】只能在【特定目录】的访问。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">比如：用户UserA，只能读取/data/usera，可以上传文件到/data/usera/upload。</span><br></pre></td></tr></table></figure></p>
<h3 id="java程序访问"><a href="#java程序访问" class="headerlink" title="java程序访问"></a>java程序访问</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>使用第三方工具jsch包中的ChannelSftp类，来访问SFTP。</p>
<ol>
<li>通过Ip、Port、Username、Password获取一个Session</li>
<li>通过Session打开SFTP通道（获得SFTP Channel对象）</li>
<li>再建立通道（Channel）连接</li>
<li>通过Channel对象来调用SFTP的各种操作方法</li>
<li>操作完SFTP需要手动断开Channel连接与Session连接</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.jcraft/jsch --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.jcraft<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.55<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="常见API"><a href="#常见API" class="headerlink" title="常见API"></a>常见API</h4><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cms.file:</span></span><br><span class="line">  <span class="attr">ip:</span></span><br><span class="line">    <span class="number">192.168</span><span class="number">.145</span><span class="number">.128</span></span><br><span class="line">  <span class="attr">usename:</span></span><br><span class="line">    <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span></span><br><span class="line">    <span class="string">root</span></span><br><span class="line">  <span class="attr">path:</span></span><br><span class="line">    <span class="string">/user/wlw</span></span><br></pre></td></tr></table></figure>
<h4 id="工具文件"><a href="#工具文件" class="headerlink" title="工具文件"></a>工具文件</h4><p>调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CommonSFtpFileService commonSFtpFileService;</span><br><span class="line">    </span><br><span class="line">commonSFtpFileService.uploadFile(inputStream, <span class="string">"test.csv"</span>);</span><br></pre></td></tr></table></figure>
<p>工具文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.sftp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jcraft.jsch.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.FileCopyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonSFtpFileService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.ip&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String destinationIp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.port:22&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> destinationPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.usename&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.password&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.path&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String destinationPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;cms.file.connect.time:300000&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ChannelSftp sftp;</span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger LOGGER = LoggerFactory.getLogger(CommonSFtpFileService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SFTP密码方式登录验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"boxing"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        LOGGER.info(<span class="string">"sftp connect by ip:&#123;&#125;,port:&#123;&#125;,userName:&#123;&#125;,password:&#123;&#125;"</span>, destinationIp, destinationPort, userName,</span><br><span class="line">                password);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> JSch jsch = <span class="keyword">new</span> JSch();</span><br><span class="line">            session = jsch.getSession(userName, destinationIp, destinationPort);</span><br><span class="line">            <span class="keyword">if</span> (session == <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">"登录参数不正确"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//密码验证方式</span></span><br><span class="line">            session.setPassword(password);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Properties linkConfig = <span class="keyword">new</span> Properties();</span><br><span class="line">            <span class="comment">//设置第一次登陆的时候提示，可选值：(ask | yes | no)</span></span><br><span class="line">            linkConfig.put(<span class="string">"StrictHostKeyChecking"</span>, <span class="string">"no"</span>);</span><br><span class="line">            session.setConfig(linkConfig);</span><br><span class="line">            <span class="comment">//设置超时时间</span></span><br><span class="line">            session.connect(connectTime);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Channel channel = session.openChannel(<span class="string">"sftp"</span>);</span><br><span class="line">            channel.connect();</span><br><span class="line"></span><br><span class="line">            sftp = (ChannelSftp) channel;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> JSchException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"Cannot connect to specified sftp server : &#123;&#125;:&#123;&#125; Exception message is: &#123;&#125;"</span>, destinationIp,</span><br><span class="line">                    destinationPort, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sftp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sftp.isConnected()) &#123;</span><br><span class="line">                sftp.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (session.isConnected()) &#123;</span><br><span class="line">                session.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以文件流方式上传附件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">(<span class="keyword">final</span> InputStream sourceFileInputStream, <span class="keyword">final</span> String sftpFileName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录验证</span></span><br><span class="line">        <span class="keyword">this</span>.login();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//切换到指定目录</span></span><br><span class="line">            sftp.cd(destinationPath);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SftpException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"directory is not exist"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sftp.mkdir(destinationPath);</span><br><span class="line">                sftp.cd(destinationPath);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SftpException e1) &#123;</span><br><span class="line">                LOGGER.warn(<span class="string">"directory build error!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sftp.put(sourceFileInputStream, sftpFileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SftpException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"file:&#123;&#125; is upload error!"</span>, sftpFileName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeStream(sourceFileInputStream, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">"file:&#123;&#125; is upload successful"</span>, sftpFileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除指定文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteFile</span><span class="params">(<span class="keyword">final</span> String sftpFileName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录验证</span></span><br><span class="line">        <span class="keyword">this</span>.login();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sftp.cd(destinationPath);</span><br><span class="line">            sftp.rm(sftpFileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SftpException e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"file:&#123;&#125; is delete error!"</span>, sftpFileName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeStream(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载FTP服务器上的文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"resource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">downloadFile</span><span class="params">(<span class="keyword">final</span> String sftpFileName, <span class="keyword">final</span> HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">final</span> HttpServletResponse res)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录验证</span></span><br><span class="line">        <span class="keyword">this</span>.login();</span><br><span class="line"></span><br><span class="line">        InputStream ins = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sftp.cd(destinationPath);</span><br><span class="line">            ins = sftp.get(sftpFileName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//设置下载格式</span></span><br><span class="line">            String fileName = <span class="keyword">null</span>;</span><br><span class="line">            out = <span class="keyword">new</span> BufferedOutputStream(res.getOutputStream());</span><br><span class="line">            <span class="comment">// response响应信息设置</span></span><br><span class="line">            res.setContentType(<span class="string">"application/octet-stream;charset=UTF-8"</span>);</span><br><span class="line">            <span class="comment">// 不同浏览器中文乱码问题</span></span><br><span class="line">            <span class="keyword">final</span> String userAgent = request.getHeader(<span class="string">"user-agent"</span>).toLowerCase();</span><br><span class="line">            <span class="keyword">if</span> (userAgent.contains(<span class="string">"msie"</span>) || userAgent.contains(<span class="string">"like gecko"</span>)) &#123;</span><br><span class="line">                fileName = URLEncoder.encode(sftpFileName, <span class="string">"UTF-8"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fileName = <span class="keyword">new</span> String(sftpFileName.getBytes(<span class="string">"UTF-8"</span>), <span class="string">"iso-8859-1"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            res.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + fileName);</span><br><span class="line">            res.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">            FileCopyUtils.copy(ins, out);</span><br><span class="line">            out.flush();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"FILE_DOWNLOAD_EXCEPTION:"</span> + e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeStream(ins, out);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭资源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeStream</span><span class="params">(<span class="keyword">final</span> InputStream in, <span class="keyword">final</span> OutputStream out)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            IOUtils.closeQuietly(in);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">            IOUtils.closeQuietly(out);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.logout();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>svg及动画</title>
    <url>/want/2020/12/08/svg%E5%8F%8A%E5%8A%A8%E7%94%BB/</url>
    <content><![CDATA[<h3 id="目标："><a href="#目标：" class="headerlink" title="目标："></a>目标：</h3><p>示例1：希望①旋转并②波纹扩散效果。</p>
<img src="/want/2020/12/08/svg及动画/animation.gif" title="路径动画">
<p>示例2：希望重新定义仪表盘组件。即根据数值，显示圆形进度条。</p>
<img src="/want/2020/12/08/svg及动画/path.png" title="描边动画">
<h3 id="实现SVG动画的三种方式"><a href="#实现SVG动画的三种方式" class="headerlink" title="实现SVG动画的三种方式"></a>实现SVG动画的三种方式</h3><h4 id="方式1：SMIL语言"><a href="#方式1：SMIL语言" class="headerlink" title="方式1：SMIL语言"></a>方式1：SMIL语言</h4><p><strong>特点</strong></p>
<ol>
<li>用SVG元素标签来描述动画。</li>
<li>仅嵌入SVG使用。</li>
<li>Synchronized Multimedia Integration Language（同步多媒体集成语言）。</li>
</ol>
<p><strong>动画标签</strong></p>
<p><code>&lt;set&gt;</code> 瞬间动画。虽然没有动画过度效果。但可实现延迟功能，类似setTimeout。<br><code>&lt;animate&gt;</code> 用于实现单属性的动画效果。<br><code>&lt;animateColor&gt;</code> 颜色发生动画效果（被animate替代）<br><code>&lt;animateTransform&gt;</code> 变形类动画<br><code>&lt;animateMotion&gt;</code>沿着某个路径运动</p>
<p>各标签自由组合，作用同一个元素。</p>
<p><strong>标签的位置</strong><br>位置1，作为需要动画SVG元素标签的子元素。<br>位置2，放到任意位置，只需要利用xlink:href = ‘#id’ 做关联即可，需要做如下配置：</p>
<ul>
<li>svg标签中引入属性「xmlns:xlink = “<a href="http://www.w3.org/1999/xlink&quot;」" target="_blank" rel="noopener">http://www.w3.org/1999/xlink&quot;」</a></li>
<li>对动画标签设置动画元素 「xlink:href=”#动画元素的id “ 」</li>
</ul>
<h4 id="方式2：CSS3"><a href="#方式2：CSS3" class="headerlink" title="方式2：CSS3"></a>方式2：CSS3</h4><p><strong>特点</strong></p>
<ol>
<li>用css样式描述动画。</li>
<li>嵌入SVG或外部css文件均可。  </li>
</ol>
<p><strong>使用示例</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span></span></span><br><span class="line"><span class="tag"> <span class="attr">version</span>=<span class="string">"1.1"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span></span></span><br><span class="line"><span class="tag"> <span class="attr">viewBox</span>=<span class="string">"0 0 638 458"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line"><span class="css">     <span class="selector-id">#innerCircle</span>, <span class="selector-id">#outerCircle</span>, <span class="selector-id">#middleCircle</span> &#123;</span></span><br><span class="line">        animation: process 3s linear infinite;</span><br><span class="line">        transform-origin: 25% 25%;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="css">      <span class="keyword">@keyframes</span> process &#123;</span></span><br><span class="line">        100% &#123;</span><br><span class="line"><span class="css">          <span class="selector-tag">transform</span>: <span class="selector-tag">scale</span>(1<span class="selector-class">.1</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!--其他SVG元素--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">defs</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">g</span> <span class="attr">id</span>=<span class="string">"innerCircle"</span> <span class="attr">style</span>=<span class="string">"stop-color:#2D80FF"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="方式3：JavaScript"><a href="#方式3：JavaScript" class="headerlink" title="方式3：JavaScript"></a>方式3：JavaScript</h4><p><strong>特点</strong></p>
<ol>
<li>直接用js来操作svg(dom)。</li>
<li>利用第三方js库操作svg(dom)：Snap.svg、Velocity.js、anime.js等。</li>
<li>单独的js文件。</li>
<li>Snap.svg是使用比较多的库。但是引用起来有点费事。</li>
<li>循环动画，需要借助js setInterval来实现。</li>
<li>如果只是简单的动图，没必要使用js。</li>
</ol>
<p><strong>使用示例</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm install snapsvg</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> Snap <span class="keyword">from</span> <span class="string">'imports-loader?this=&gt;window,fix=&gt;module.exports=0!snapsvg/dist/snap.svg.js'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">  <span class="keyword">const</span> svg = Snap(<span class="string">'#svg'</span>);</span><br><span class="line">  svg.paper.circle(&#123;</span><br><span class="line">    cx: <span class="number">100</span>,</span><br><span class="line">    cy: <span class="number">100</span>,</span><br><span class="line">    r: <span class="number">50</span>,</span><br><span class="line">    fill: <span class="string">'#f00'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">svg</span><br><span class="line">  .select(<span class="string">'circle'</span>)</span><br><span class="line">  .animate(</span><br><span class="line">    &#123;<span class="attr">r</span>: <span class="number">100</span>&#125;, </span><br><span class="line">    <span class="number">1000</span>, </span><br><span class="line">    mina.easeout(),</span><br><span class="line">   <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="built_in">console</span>.log(<span class="string">'animation end'</span>);&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="SVG动画的三种重要种类"><a href="#SVG动画的三种重要种类" class="headerlink" title="SVG动画的三种重要种类"></a>SVG动画的三种重要种类</h3><h4 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h4><p>svg动画的核心概念是路径path。path就是一条线，是直线，或者曲线，虚线或者实线。一个path长这样【请学习svg基础】——</p>
<p><code>M113,318c-50.7-1.8-74.3-24.8-81-32C6.7,258.7,8.1,224.2,11,155z</code></p>
<p>一个简单path标签长这样——</p>
<p><code>&lt;path d=&quot;M113,318c-50.7-1.8-74.3-24.8-81-32C6.7,258.7,8.1,224.2,11,155z&quot; /&gt;</code></p>
<p>path具有如下线的属性：</p>
<ol>
<li>stroke：颜色，stroke=”green”。</li>
<li>d：线条的形状。</li>
<li>stroke-width：宽度，单位是 px。</li>
<li>stroke-dasharray：定义形成一条虚线。stroke-dasharray=”5, 15” 表示，按照 实线dash为 5，间隔gap为 15 的排布重复下去。值可以为 number || percentage。</li>
<li>stroke-dashoffset：设置 dasharray 定义的 dash 线条开始的位置。值可以为 number || percentage。</li>
<li>stroke-linecap: 线条的端点样式。</li>
<li>stroke-linejoin: 线条连接的样式</li>
</ol>
<p>SVG预定义的六种基本形状： rect、circle、ellipse、line、polyline、polygon 都可以转换为path路径，从而实现动画。这篇文章提供了转换函数<a href="https://aotu.io/notes/2017/01/16/base-shapes-to-path/index.html" target="_blank" rel="noopener">https://aotu.io/notes/2017/01/16/base-shapes-to-path/index.html</a></p>
<h4 id="类型1：描边动画-划线动画"><a href="#类型1：描边动画-划线动画" class="headerlink" title="类型1：描边动画/划线动画"></a>类型1：描边动画/划线动画</h4><p>参见下文示例2的实现。</p>
<h5 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a><strong>实现方式</strong></h5><ol>
<li>方式1：【推荐】css3的stroke-dasharray和stroke-dashoffset。</li>
<li>方式2：SMIL的 <code>&lt;animate&gt;</code> 标签。</li>
</ol>
<h5 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a><strong>具体实现</strong></h5><p>描边动画有个核心问题：获取边的总长度。比如示例2中，需要获得圆盘的总长度。因为svg本身就是dom元素，可用js获取：<code>document.getElementById(&#39;路径path的id&#39;).getTotalLength()</code>。</p>
<h6 id="CSS3"><a href="#CSS3" class="headerlink" title="CSS3"></a>CSS3</h6><p>css3实现实线描边有两种方式，假设获得总长度369px。</p>
<p>方式一、利用stroke-dasharray和stroke-dashoffset。调整线的偏移量即可。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#path1</span> &#123;</span><br><span class="line">        <span class="attribute">animation</span>: process1 <span class="number">3s</span> linear forwards;</span><br><span class="line">        <span class="attribute">stroke-dasharray</span>: <span class="number">369px</span>, <span class="number">369px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> process1 &#123;</span><br><span class="line">        0% &#123; <span class="attribute">stroke-dashoffset</span>: <span class="number">369px</span>;&#125;</span><br><span class="line">        100% &#123; <span class="attribute">stroke-dashoffset</span>: <span class="number">0</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式二、纯利用stroke-dasharray。调整实线dash的大小即可。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#path</span> &#123; <span class="attribute">animation</span>: process <span class="number">3s</span> linear forwards; &#125;</span><br><span class="line"><span class="keyword">@keyframes</span> process &#123;</span><br><span class="line">        0%&#123; <span class="attribute">stroke-dasharray</span>: <span class="number">0</span>, <span class="number">369px</span>;&#125;</span><br><span class="line">        100%&#123; <span class="attribute">stroke-dasharray</span>: <span class="number">369px</span>, <span class="number">369px</span>; &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<h6 id="animate"><a href="#animate" class="headerlink" title="animate"></a>animate</h6><p><code>&lt;animate&gt;</code>可以通过改变样式属性来处理。 </p>
<figure class="highlight svg"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">animate</span></span></span><br><span class="line"><span class="tag">    <span class="attr">attributeName</span>=<span class="string">"stroke-dashoffset"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">begin</span>=<span class="string">"0.8"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">dur</span>=<span class="string">'0.3s'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">from</span>=<span class="string">'369.59027099609375px'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">to</span>=<span class="string">'0px'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">fill</span>=<span class="string">"freeze"</span></span></span><br><span class="line"><span class="tag">   /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="类型2：路径动画"><a href="#类型2：路径动画" class="headerlink" title="类型2：路径动画"></a>类型2：路径动画</h4><p>让元素沿着某条路径进行运动。参见下文示例1的实现。</p>
<h5 id="实现方式-1"><a href="#实现方式-1" class="headerlink" title="实现方式"></a><strong>实现方式</strong></h5><ol>
<li>方式1：【推荐】SMIL的 <code>&lt;animateMotion&gt;</code>标签。</li>
<li>方式2：CSS3 的offset-path和offset-distance样式。</li>
</ol>
<p>css3虽然操作顺手，但浏览器兼容性没有<code>&lt;animateMotion&gt;</code>好。而且，因为path本身是svg内部的元素，而路径轨迹动画本身依赖于路径。因此直接<code>&lt;animateMotion&gt;</code>比css更稳定方便。</p>
<h5 id="具体实现-1"><a href="#具体实现-1" class="headerlink" title="具体实现"></a><strong>具体实现</strong></h5><h6 id="animateMotion"><a href="#animateMotion" class="headerlink" title="animateMotion"></a>animateMotion</h6><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">g</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">rect</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span> <span class="attr">width</span>=<span class="string">"50"</span> <span class="attr">height</span>=<span class="string">"30"</span> <span class="attr">style</span>=<span class="string">"fill: #ccc;"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">"40"</span> <span class="attr">cy</span>=<span class="string">"30"</span> <span class="attr">r</span>=<span class="string">"10"</span> <span class="attr">style</span>=<span class="string">"fill: #cfc; stroke: green;"</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">animateMotion</span> <span class="attr">path</span>=<span class="string">"M50,125 C 100,25 150,225, 200, 125"</span> <span class="attr">dur</span>=<span class="string">"4s"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">或，预定义一个path，而后引用：</span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">defs</span>&gt;</span><span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"cubicCurve"</span> <span class="attr">d</span>=<span class="string">"M50,125 C 100,25 150,225, 200, 125"</span>/&gt;</span><span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">animateMotion</span> <span class="attr">dur</span>=<span class="string">"4s"</span> <span class="attr">fill</span>=<span class="string">"freeze"</span> <span class="attr">rotate</span>=<span class="string">"auto"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mpath</span> <span class="attr">xlink:href</span>=<span class="string">"#cubicCurve"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">animateMotion</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="css3"><a href="#css3" class="headerlink" title="css3"></a>css3</h6><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.ball</span> &#123;</span><br><span class="line"> <span class="attribute">offset-path</span>: <span class="built_in">path</span>(<span class="string">'M10 80 Q 77.5 10, 145 80 T 280 80'</span>);</span><br><span class="line"> <span class="attribute">offset-distance</span>: <span class="number">0%</span>;</span><br><span class="line"> <span class="attribute">animation</span>: red-ball <span class="number">2s</span> linear alternate infinite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> red-ball &#123;</span><br><span class="line"> <span class="selector-tag">from</span> &#123;</span><br><span class="line">  <span class="attribute">offset-distance</span>: <span class="number">0%</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="selector-tag">to</span> &#123;</span><br><span class="line">  <span class="attribute">offset-distance</span>: <span class="number">100%</span>;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="类型3：变形动画"><a href="#类型3：变形动画" class="headerlink" title="类型3：变形动画"></a>类型3：变形动画</h4><h5 id="实现方式-2"><a href="#实现方式-2" class="headerlink" title="实现方式"></a><strong>实现方式</strong></h5><ol>
<li>方式1：【推荐】CSS3 的transform。</li>
<li>方式2：SMIL的 animateTransform。</li>
</ol>
<p>两种方法都有如下属性：</p>
<ul>
<li>translate</li>
<li>rotate</li>
<li>scale</li>
<li>skew</li>
<li>等</li>
</ul>
<h5 id="具体实现-2"><a href="#具体实现-2" class="headerlink" title="具体实现"></a>具体实现</h5><p>在css和svg本身的属性中，都具备这几种变形。但是，他们坐标系不同。</p>
<ul>
<li>css以元素本身的中心点作为坐标原点进行变形。并且css可以通过transform-origin自定义原点。</li>
<li>svg以整个svg的左上角(0,0)为原点变形。当执行svg的scale时，x,y的位置也会跟着缩放。</li>
</ul>
<h6 id="animateTransform"><a href="#animateTransform" class="headerlink" title="animateTransform"></a>animateTransform</h6><figure class="highlight svg"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">animateTransform</span></span></span><br><span class="line"><span class="tag">    <span class="attr">id</span>=<span class="string">'a1'</span></span></span><br><span class="line"><span class="tag">    <span class="attr">attributeName</span>=<span class="string">"transform"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">type</span>=<span class="string">"scale"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">from</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">to</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">dur</span>=<span class="string">"5s"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">fill</span>=<span class="string">"freeze"</span></span></span><br><span class="line"><span class="tag">  /&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="css3-1"><a href="#css3-1" class="headerlink" title="css3"></a>css3</h6><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#innerCircle</span>, <span class="selector-id">#outerCircle</span>, <span class="selector-id">#middleCircle</span> &#123;</span><br><span class="line">  <span class="attribute">animation</span>: process <span class="number">3s</span> linear infinite;</span><br><span class="line">  <span class="attribute">transform-origin</span>: <span class="number">25%</span> <span class="number">25%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> process &#123;</span><br><span class="line">   100% &#123;</span><br><span class="line">      <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="目标示例的具体实现"><a href="#目标示例的具体实现" class="headerlink" title="目标示例的具体实现"></a>目标示例的具体实现</h3><ol>
<li>静态SVG图片本身由UI利用sketch或者Adobe Illustrator工具绘制。</li>
<li>动态SVG效果，由开发人员利用代码自行处理。</li>
<li>动画所沿路径path也可以由UI利用工具帮助勾勒。</li>
</ol>
<h4 id="示例1：①旋转并②波纹扩散"><a href="#示例1：①旋转并②波纹扩散" class="headerlink" title="示例1：①旋转并②波纹扩散"></a>示例1：①旋转并②波纹扩散</h4><img src="/want/2020/12/08/svg及动画/animation.gif" title="路径动画">
<h5 id="波纹：css的scale变换。变换动画。"><a href="#波纹：css的scale变换。变换动画。" class="headerlink" title="波纹：css的scale变换。变换动画。"></a>波纹：css的scale变换。变换动画。</h5><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">// 静态波纹本身，由UI提供</span><br><span class="line">&lt;g id="innerCircle"&gt;&lt;/g&gt;</span><br><span class="line">&lt;g id="outerCircle"&gt;&lt;/g&gt;</span><br><span class="line">&lt;g id="middleCircle"&gt;&lt;/g&gt;</span><br><span class="line"></span><br><span class="line">// 设置动画</span><br><span class="line"><span class="selector-id">#innerCircle</span>, <span class="selector-id">#outerCircle</span>, <span class="selector-id">#middleCircle</span> &#123;</span><br><span class="line">  <span class="attribute">animation</span>: process <span class="number">3s</span> linear infinite;</span><br><span class="line">  <span class="attribute">transform-origin</span>: <span class="number">25%</span> <span class="number">25%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@keyframes</span> process &#123;</span><br><span class="line">  100% &#123;</span><br><span class="line">   <span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="运动：animateMotion标签。路径动画。"><a href="#运动：animateMotion标签。路径动画。" class="headerlink" title="运动：animateMotion标签。路径动画。"></a>运动：animateMotion标签。路径动画。</h5><figure class="highlight svg"><table><tr><td class="code"><pre><span class="line">// 三个棋子要走的路线path，可由UI工具勾勒</span><br><span class="line"><span class="tag">&lt;<span class="name">defs</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"cubicCurve1"</span> <span class="attr">d</span>=<span class="string">"Mxxxxz"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"cubicCurve2"</span> <span class="attr">d</span>=<span class="string">"Mxxxxz"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">path</span> <span class="attr">id</span>=<span class="string">"cubicCurve3"</span> <span class="attr">d</span>=<span class="string">"Mxxxxz"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">defs</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">g</span> <span class="attr">id</span>=<span class="string">"棋子1"</span>&gt;</span></span><br><span class="line">  /** 静态棋子本身代码，由UI提供**/</span><br><span class="line">  </span><br><span class="line">  // 设置动画，即该棋子走的路线path</span><br><span class="line">  <span class="tag">&lt;<span class="name">animateMotion</span> <span class="attr">dur</span>=<span class="string">"20s"</span> <span class="attr">repeatCount</span>=<span class="string">"indefinite"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mpath</span> <span class="attr">xlink:href</span>=<span class="string">"#cubicCurve1"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">animateMotion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">g</span> <span class="attr">id</span>=<span class="string">"棋子2"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">animateMotion</span> <span class="attr">dur</span>=<span class="string">"20s"</span> <span class="attr">repeatCount</span>=<span class="string">"indefinite"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mpath</span> <span class="attr">xlink:href</span>=<span class="string">"#cubicCurve2"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">animateMotion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">g</span> <span class="attr">id</span>=<span class="string">"棋子3"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">animateMotion</span> <span class="attr">dur</span>=<span class="string">"20s"</span> <span class="attr">repeatCount</span>=<span class="string">"indefinite"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mpath</span> <span class="attr">xlink:href</span>=<span class="string">"#cubicCurve3"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">animateMotion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="示例2：定义仪表盘组件。根据数值，显示圆形进度条。"><a href="#示例2：定义仪表盘组件。根据数值，显示圆形进度条。" class="headerlink" title="示例2：定义仪表盘组件。根据数值，显示圆形进度条。"></a>示例2：定义仪表盘组件。根据数值，显示圆形进度条。</h4><img src="/want/2020/12/08/svg及动画/path.png" title="描边动画">
<p><strong>此图利用stroke-dasharray实现。描边动画。</strong></p>
<p>注意，总长度可由<code>document.getElementById(&#39;路径path的id&#39;).getTotalLength()</code> 取得。</p>
<p>此处为：document.getElementById(‘进度条高亮’).getTotalLength() = 365</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义百分比   </span></span><br><span class="line"><span class="keyword">const</span> value = (<span class="number">365</span> * percentFormat) / <span class="number">100</span>;</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 利用 value + stroke-dasharray 实现百分比效果</span></span><br><span class="line">&lt;path</span><br><span class="line">  id=<span class="string">"进度条高亮"</span></span><br><span class="line">  d=<span class="string">"Mxxxxx"</span></span><br><span class="line"></span><br><span class="line">  style=&#123;&#123; <span class="attr">strokeDasharray</span>: <span class="string">`<span class="subst">$&#123;value&#125;</span>px, 365px`</span>, <span class="attr">strokeDashoffset</span>: <span class="string">'-2.5px'</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">  stroke=<span class="string">"url(#linearGradient-10)"</span></span><br><span class="line">  strokeWidth=<span class="string">"22"</span></span><br><span class="line">  fillOpacity=<span class="string">"0"</span></span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>地图坐标系</title>
    <url>/want/2019/01/14/%E5%9C%B0%E5%9B%BE%E5%9D%90%E6%A0%87%E7%B3%BB/</url>
    <content><![CDATA[<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>所有坐标体系的原点，都是非洲几内亚湾。</p>
<p>按用途分类：</p>
<ol>
<li>GIS（尤其<strong>WebGIS</strong>）常用坐标系： WBS84，GCJ02，BD09</li>
<li><strong>测绘</strong>常用坐标系：西安80，北京54，CGC2000</li>
</ol>
<p>按测量单位分类：</p>
<ol>
<li>经纬度坐标：球面坐标，单位<strong>度</strong>，如(116.38817139.935961)。</li>
<li>墨卡托坐标：平面坐标，单位<strong>米</strong>，如(215362.00021333335 99526.00034912192)， 主要用于后台计算。</li>
</ol>
<p>墨卡托坐标和经纬度坐标基本一一对应，如 WGS84墨卡托，GCJ02墨卡托，BD09墨卡托，此处按下不表。</p>
<p>按获取途径分：</p>
<ol>
<li>设备获取GPS坐标：<ul>
<li>若ios的原生定位库，则获得WGS84</li>
<li>若高德sdk，则获取GCJ02</li>
<li>若百度sdk，则可获得百度坐标（bd09）或者火星坐标（GCJ02)，默认是bd09</li>
</ul>
</li>
<li>在线WEB地图应用：遵循各自的坐标系。</li>
</ol>
<h4 id="WGS84坐标系"><a href="#WGS84坐标系" class="headerlink" title="WGS84坐标系"></a>WGS84坐标系</h4><p>WGS-84坐标系（World Geodetic System）是目前<strong>国际</strong>上统一采用的大地坐标系。坐标原点为地球质心。</p>
<p>GPS广播星历是以WGS-84坐标系为根据的。</p>
<p>世界主流Web地图都基于该坐标系。如：</p>
<ul>
<li>Google Maps</li>
<li>OpenStreetMap</li>
<li>Bing Map</li>
<li>ArcGIS</li>
<li>Heremaps</li>
</ul>
<p>中国因政策要求，在WGS基础上进行经纬度加密，形成加密后的新坐标系（GCJ02、BD09）。</p>
<h4 id="GCJ02坐标系（火星坐标系）"><a href="#GCJ02坐标系（火星坐标系）" class="headerlink" title="GCJ02坐标系（火星坐标系）"></a>GCJ02坐标系（火星坐标系）</h4><p>GCJ-02坐标系(Guojia，Cehui，Ju)，是由<strong>中国国家测绘局</strong>制订的地理信息系统的坐标系统。</p>
<ul>
<li>该坐标系在<strong>WGS84</strong>坐标系的基础上，加密<strong>经纬度</strong>数据。</li>
<li>按地形图<strong>非线性</strong>保密处理算法，将真实坐标加密成虚假坐标。因随机加密，故各地偏移情况有所不同。</li>
<li>使用GCJ-02记录的地点，在GCJ-02地图中会正确显示位置，在WGS-84地图会有100-700米不等的偏移。</li>
<li>网上纠偏实现都是基于某份泄露的WGS到CGJ加偏代码实现。</li>
</ul>
<p>国内出版的各种地图系统（包括电子形式），必须至少采用GCJ-02对地理位置进行首次加密。</p>
<ul>
<li>国测局授权提供位置和地图服务的厂商，例如高德地图、NavInfo，都需要特别购买一个“纠偏”算法，将GPS坐标转为和地图一致的坐标系。</li>
<li>由于一国两制，<strong>香港、澳门</strong>地图不受测绘法限制，没有偏移问题。然而在两地和中国大陆边境附近，网络地图提供的道路形状会因为偏移而互相断开。</li>
</ul>
<p>中国主流Web地图都是基于GCJ02坐标系，如：</p>
<ol>
<li>谷歌中国地图(由高德提供地图数据)</li>
<li>腾讯地图</li>
<li>高德地图</li>
</ol>
<h4 id="BD09坐标系（百度坐标系）"><a href="#BD09坐标系（百度坐标系）" class="headerlink" title="BD09坐标系（百度坐标系）"></a>BD09坐标系（百度坐标系）</h4><p>该坐标系在GCJ02坐标系基础上，加密经纬度算法(百度自身的加偏算法)。<br>目前只有百度地图采用BD09坐标系：</p>
<ol>
<li>百度地图</li>
</ol>
<h4 id="其他坐标系"><a href="#其他坐标系" class="headerlink" title="其他坐标系"></a>其他坐标系</h4><p>搜狗坐标： 搜狐搜狗地图API</p>
<h4 id="关系图"><a href="#关系图" class="headerlink" title="关系图"></a>关系图</h4><p>互联网地图服务规定，国内互联网地图必须使用国测局加密的<strong>GCJ02</strong>坐标系。<br>百度在<strong>GCJ02</strong>的基础上，又做了一次加密。</p>
<pre class="mermaid">graph TD
A((WGS84坐标系)) ==> B>加密]
    B ==> C((GCJ02坐标系))
    C ==> E>加密]
    E ==> F((百度坐标系))

    A --- D(相关地图)
    D --- D1(GoogleMaps)
    D --- D2(BingMap)
    D --- D3(ArcGIS)
    D --- D4(OpenStreetMap)
    D --- D5(Heremaps)

    F --- F1(百度地图)

    C --- G(相关地图)
    G --- G1(高德地图)
    G --- G2(腾讯地图)
    G --- G3(谷歌中国地图)

    G1 -.- H1(阿里)
    G2 -.- H2(腾讯)

    F1 -.- H3(Echarts)

    style C fill:greenyellow
    style F fill:greenyellow

    style F1 fill:orange
    style G1 fill:orange
    style G2 fill:orange
    style G3 fill:orange</pre>

<h3 id="坐标转换"><a href="#坐标转换" class="headerlink" title="坐标转换"></a>坐标转换</h3><p>各类别坐标可相互转换（位置纠偏），但请首先确认采集数据的坐标系类别。</p>
<ol>
<li>坐标系类别</li>
<li>是否经纬度反序，如谷歌地图(lat, lng)，高德地图(lng, lat)</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GPSUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> pi = <span class="number">3.1415926535897932384626</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> x_pi = <span class="number">3.14159265358979324</span> * <span class="number">3000.0</span> / <span class="number">180.0</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> a = <span class="number">6378245.0</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> ee = <span class="number">0.00669342162296594323</span>;  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">transformLat</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">double</span> ret = -<span class="number">100.0</span> + <span class="number">2.0</span> * x + <span class="number">3.0</span> * y + <span class="number">0.2</span> * y * y + <span class="number">0.1</span> * x * y  + <span class="number">0.2</span> * Math.sqrt(Math.abs(x));  </span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(<span class="number">6.0</span> * x * pi) + <span class="number">20.0</span> * Math.sin(<span class="number">2.0</span> * x * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(y * pi) + <span class="number">40.0</span> * Math.sin(y / <span class="number">3.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        ret += (<span class="number">160.0</span> * Math.sin(y / <span class="number">12.0</span> * pi) + <span class="number">320</span> * Math.sin(y * pi / <span class="number">30.0</span>)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">transformLon</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">double</span> ret = <span class="number">300.0</span> + x + <span class="number">2.0</span> * y + <span class="number">0.1</span> * x * x + <span class="number">0.1</span> * x * y + <span class="number">0.1</span> * Math.sqrt(Math.abs(x));  </span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(<span class="number">6.0</span> * x * pi) + <span class="number">20.0</span> * Math.sin(<span class="number">2.0</span> * x * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        ret += (<span class="number">20.0</span> * Math.sin(x * pi) + <span class="number">40.0</span> * Math.sin(x / <span class="number">3.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        ret += (<span class="number">150.0</span> * Math.sin(x / <span class="number">12.0</span> * pi) + <span class="number">300.0</span> * Math.sin(x / <span class="number">30.0</span> * pi)) * <span class="number">2.0</span> / <span class="number">3.0</span>;  </span><br><span class="line">        <span class="keyword">return</span> ret;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] transform(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (outOfChina(lat, lon)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lat,lon&#125;;  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> dLat = transformLat(lon - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);  </span><br><span class="line">        <span class="keyword">double</span> dLon = transformLon(lon - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);  </span><br><span class="line">        <span class="keyword">double</span> radLat = lat / <span class="number">180.0</span> * pi;  </span><br><span class="line">        <span class="keyword">double</span> magic = Math.sin(radLat);  </span><br><span class="line">        magic = <span class="number">1</span> - ee * magic * magic;  </span><br><span class="line">        <span class="keyword">double</span> sqrtMagic = Math.sqrt(magic);  </span><br><span class="line">        dLat = (dLat * <span class="number">180.0</span>) / ((a * (<span class="number">1</span> - ee)) / (magic * sqrtMagic) * pi);  </span><br><span class="line">        dLon = (dLon * <span class="number">180.0</span>) / (a / sqrtMagic * Math.cos(radLat) * pi);  </span><br><span class="line">        <span class="keyword">double</span> mgLat = lat + dLat;  </span><br><span class="line">        <span class="keyword">double</span> mgLon = lon + dLon;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;mgLat,mgLon&#125;;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">outOfChina</span><span class="params">(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon)</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">if</span> (lon &lt; <span class="number">72.004</span> || lon &gt; <span class="number">137.8347</span>)  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">        <span class="keyword">if</span> (lat &lt; <span class="number">0.8293</span> || lat &gt; <span class="number">55.8271</span>)  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * WGS84 to GCJ-02</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lon </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gps84_To_Gcj02(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon) &#123;</span><br><span class="line">        <span class="keyword">if</span> (outOfChina(lat, lon)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;lat,lon&#125;;  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> dLat = transformLat(lon - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);  </span><br><span class="line">        <span class="keyword">double</span> dLon = transformLon(lon - <span class="number">105.0</span>, lat - <span class="number">35.0</span>);  </span><br><span class="line">        <span class="keyword">double</span> radLat = lat / <span class="number">180.0</span> * pi;  </span><br><span class="line">        <span class="keyword">double</span> magic = Math.sin(radLat);  </span><br><span class="line">        magic = <span class="number">1</span> - ee * magic * magic;  </span><br><span class="line">        <span class="keyword">double</span> sqrtMagic = Math.sqrt(magic);  </span><br><span class="line">        dLat = (dLat * <span class="number">180.0</span>) / ((a * (<span class="number">1</span> - ee)) / (magic * sqrtMagic) * pi);  </span><br><span class="line">        dLon = (dLon * <span class="number">180.0</span>) / (a / sqrtMagic * Math.cos(radLat) * pi);  </span><br><span class="line">        <span class="keyword">double</span> mgLat = lat + dLat;  </span><br><span class="line">        <span class="keyword">double</span> mgLon = lon + dLon;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;mgLat, mgLon&#125;;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * GCJ-02 to WGS84</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lon</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     * */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gcj02_To_Gps84(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon) &#123;  </span><br><span class="line">        <span class="keyword">double</span>[] gps = transform(lat, lon);  </span><br><span class="line">        <span class="keyword">double</span> lontitude = lon * <span class="number">2</span> - gps[<span class="number">1</span>];  </span><br><span class="line">        <span class="keyword">double</span> latitude = lat * <span class="number">2</span> - gps[<span class="number">0</span>];  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">double</span>[]&#123;latitude, lontitude&#125;;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * GCJ-02 to BD-09</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lon </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gcj02_To_Bd09(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon) &#123;  </span><br><span class="line">        <span class="keyword">double</span> x = lon, y = lat;  </span><br><span class="line">        <span class="keyword">double</span> z = Math.sqrt(x * x + y * y) + <span class="number">0.00002</span> * Math.sin(y * x_pi);  </span><br><span class="line">        <span class="keyword">double</span> theta = Math.atan2(y, x) + <span class="number">0.000003</span> * Math.cos(x * x_pi);  </span><br><span class="line">        <span class="keyword">double</span> tempLon = z * Math.cos(theta) + <span class="number">0.0065</span>;  </span><br><span class="line">        <span class="keyword">double</span> tempLat = z * Math.sin(theta) + <span class="number">0.006</span>;  </span><br><span class="line">        <span class="keyword">double</span>[] gps = &#123;tempLat,tempLon&#125;;  </span><br><span class="line">        <span class="keyword">return</span> gps;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * BD-09 to GCJ-02 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bd_lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bd_lon</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] bd09_To_Gcj02(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon) &#123;  </span><br><span class="line">        <span class="keyword">double</span> x = lon - <span class="number">0.0065</span>, y = lat - <span class="number">0.006</span>;  </span><br><span class="line">        <span class="keyword">double</span> z = Math.sqrt(x * x + y * y) - <span class="number">0.00002</span> * Math.sin(y * x_pi);  </span><br><span class="line">        <span class="keyword">double</span> theta = Math.atan2(y, x) - <span class="number">0.000003</span> * Math.cos(x * x_pi);  </span><br><span class="line">        <span class="keyword">double</span> tempLon = z * Math.cos(theta);  </span><br><span class="line">        <span class="keyword">double</span> tempLat = z * Math.sin(theta);  </span><br><span class="line">        <span class="keyword">double</span>[] gps = &#123;tempLat,tempLon&#125;;  </span><br><span class="line">        <span class="keyword">return</span> gps;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**WGS84to BD-09 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lon</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] gps84_To_bd09(<span class="keyword">double</span> lat,<span class="keyword">double</span> lon)&#123;  </span><br><span class="line">        <span class="keyword">double</span>[] gcj02 = gps84_To_Gcj02(lat,lon);  </span><br><span class="line">        <span class="keyword">double</span>[] bd09 = gcj02_To_Bd09(gcj02[<span class="number">0</span>],gcj02[<span class="number">1</span>]);  </span><br><span class="line">        <span class="keyword">return</span> bd09;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span>[] bd09_To_gps84(<span class="keyword">double</span> lat,<span class="keyword">double</span> lon)&#123;  </span><br><span class="line">        <span class="keyword">double</span>[] gcj02 = bd09_To_Gcj02(lat, lon);  </span><br><span class="line">        <span class="keyword">double</span>[] gps84 = gcj02_To_Gps84(gcj02[<span class="number">0</span>], gcj02[<span class="number">1</span>]);  </span><br><span class="line">        <span class="comment">//保留小数点后六位  </span></span><br><span class="line">        gps84[<span class="number">0</span>] = retain6(gps84[<span class="number">0</span>]);  </span><br><span class="line">        gps84[<span class="number">1</span>] = retain6(gps84[<span class="number">1</span>]);  </span><br><span class="line">        <span class="keyword">return</span> gps84;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**保留小数点后六位 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> num </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">retain6</span><span class="params">(<span class="keyword">double</span> num)</span></span>&#123;  </span><br><span class="line">        String result = String .format(<span class="string">"%.6f"</span>, num);  </span><br><span class="line">        <span class="keyword">return</span> Double.valueOf(result);  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>地图</tag>
      </tags>
  </entry>
  <entry>
    <title>大屏</title>
    <url>/want/2019/01/29/%E5%A4%A7%E5%B1%8F/</url>
    <content><![CDATA[<h3 id="拼接屏幕"><a href="#拼接屏幕" class="headerlink" title="拼接屏幕"></a>拼接屏幕</h3><p>设施：拼接屏组成大屏<br>特点：</p>
<ol>
<li>屏幕缝隙（常用的有无缝隙、1.7mm缝隙、3.5mm缝隙，缝隙越小价格越贵），设计原型时，使关键图像避开缝隙</li>
<li>分块展示数据</li>
<li>常据屏幕大小，固定尺寸（无需自适应）</li>
<li>大屏信号源<strong>电脑</strong>屏幕的分辨率 （主流分辨率 16：9 或 4：3）<ul>
<li>大屏逻辑分辨率（设计稿尺寸）</li>
<li>显卡输出分辨率</li>
<li>视频矩阵切换器（ DVI ）支持分辨率</li>
<li>大屏实际物理分辨率</li>
</ul>
</li>
</ol>
<img src="/want/2019/01/29/大屏/screen.jpg" title="大屏构造">
<h3 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h3><ol>
<li>深色调</li>
<li>整体页不能有滚动条</li>
<li>字号： <ul>
<li>普通字体：14号以上</li>
<li>标注信息：12号以上</li>
</ul>
</li>
</ol>
<h3 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h3><ol>
<li>grid/flex布局</li>
<li>100%</li>
<li><strong>rem</strong><br> 相对于根元素html（或  :root ）设置大小</li>
<li>em<br> 相对于元素自身font-size的大小（若没有对元素<strong>显式</strong>使用绝对单位声明font-size，则元素font-size属性自动继承自父元素）</li>
<li>vh / vw</li>
<li>px<br> 绝对单位</li>
<li>@media</li>
</ol>
<table>
<thead>
<tr>
<th>常见用途</th>
<th>单位</th>
</tr>
</thead>
<tbody>
<tr>
<td>字体</td>
<td>rem</td>
</tr>
<tr>
<td>boder</td>
<td>px</td>
</tr>
<tr>
<td>padding/margin</td>
<td>em</td>
</tr>
<tr>
<td>宽度</td>
<td>百分比</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">html &#123;</span><br><span class="line">  font-size: 0.75em;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@media (min-width: 800px) &#123;</span><br><span class="line">  html &#123;</span><br><span class="line">    font-size: 0.875em;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@media (min-width: 1200px) &#123;</span><br><span class="line">  html &#123;</span><br><span class="line">    font-size: 1em;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<br><a href="https://zhuanlan.zhihu.com/p/39811831" target="_blank" rel="noopener">CSS in Depth</a><br><a href="https://zhuanlan.zhihu.com/p/26955084" target="_blank" rel="noopener">为什么要使用em和rem</a></p>
<h3 id="常用实现"><a href="#常用实现" class="headerlink" title="常用实现"></a>常用实现</h3><h4 id="分割数字"><a href="#分割数字" class="headerlink" title="分割数字"></a>分割数字</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function split(num) &#123;</span><br><span class="line">	return (num || 0).toString().split(&apos;&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="增加千分位"><a href="#增加千分位" class="headerlink" title="增加千分位"></a>增加千分位</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function format (num) &#123;  </span><br><span class="line">    var reg=/\d&#123;1,3&#125;(?=(\d&#123;3&#125;)+$)/g;   </span><br><span class="line">    return (num + &apos;&apos;).replace(reg, &apos;$&amp;,&apos;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ol>
<li><a href="https://www.cnblogs.com/lvmylife/p/8287247.html" target="_blank" rel="noopener">JS实现千分位</a></li>
<li><a href="https://www.uisdc.com/large-screen-data-visualization-design" target="_blank" rel="noopener">可能是最详细的大屏数据可视化设计指南</a></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>工具</title>
    <url>/want/2019/01/14/%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h3 id="基本工具"><a href="#基本工具" class="headerlink" title="基本工具"></a>基本工具</h3><p><a href="http://www.bejson.com/jsonviewernew/" target="_blank" rel="noopener">JSON格式化</a><br><a href="http://tool.oschina.net/highlight" target="_blank" rel="noopener">在线代码着色</a></p>
<p><a href="https://www.uupoop.com/?use_old=1" target="_blank" rel="noopener">在线ps</a></p>
<p><a href="https://postimages.org/zh-tw/" target="_blank" rel="noopener">Postimage线上图片存储</a><br><a href="https://tinypng.com/" target="_blank" rel="noopener">TinyPNG无损压缩图片</a><br><a href="http://tool.chinaz.com/tools/imgtobase/" target="_blank" rel="noopener">图片转base64</a></p>
<h3 id="纹理背景"><a href="#纹理背景" class="headerlink" title="纹理背景"></a>纹理背景</h3><p><a href="http://www.hituyu.com/" target="_blank" rel="noopener">图鱼</a><br><a href="http://thepatternlibrary.com/" target="_blank" rel="noopener">PatternLibrary</a></p>
<h3 id="ICON库"><a href="#ICON库" class="headerlink" title="ICON库"></a>ICON库</h3><p><a href="https://www.easyicon.net/" target="_blank" rel="noopener">easyicon</a><br><a href="https://www.iconfont.cn/" target="_blank" rel="noopener">iconfont</a></p>
<h3 id="数据出图"><a href="#数据出图" class="headerlink" title="数据出图"></a>数据出图</h3><p>excel<br>tableu</p>
<h3 id="调查问卷"><a href="#调查问卷" class="headerlink" title="调查问卷"></a>调查问卷</h3><p><a href="https://jinshuju.net/" target="_blank" rel="noopener">金数据</a></p>
<h3 id="胡乱看看"><a href="#胡乱看看" class="headerlink" title="胡乱看看"></a>胡乱看看</h3><p><a href="http://liqi.io/creators/" target="_blank" rel="noopener">利器</a><br><a href="https://www.chuangkit.com/designtools/startdesign" target="_blank" rel="noopener">创客贴</a><br><a href="https://www.qdtalk.com/" target="_blank" rel="noopener">前端陌上寒</a></p>
<h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><p>360天擎<br>单点登录<br>Axure RP 8<br>Beyond Compare<br>Cent Browser<br>Everything<br>FastStone Capture<br>Foxmail<br>Git version<br>Google Chrome<br>IntelliJ IDEA 2018.3.3<br>Java<br>KMSpico<br>Listary version<br>Microsoft Office<br>Microsoft Visual Studio Code<br>Mozilla Firefox<br>Node.js<br>Notepad++<br>Npcap 0.995<br>PremiumSoft Navicat<br>Progress Telerik Fiddler<br>SangforHTP<br>SangforVNC<br>TeamViewer 14<br>TIM<br>Typora version 0.9.62<br>WinRAR<br>Wireshark 3.0.2 32-bit<br>Xftp 6<br>XMind 8<br>Xshell 6<br>百度网盘<br>福昕阅读器<br>网易有道词典<br>微信<br>迅雷<br>有道云笔记</p>
]]></content>
      <tags>
        <tag>tool</tag>
      </tags>
  </entry>
  <entry>
    <title>异步跳转</title>
    <url>/want/2019/08/02/%E5%BC%82%E6%AD%A5%E8%B7%B3%E8%BD%AC/</url>
    <content><![CDATA[<p>在跳转到一个新的tab页（打开新窗口之前），需要进行权限校验，数据追加等ajax异步获取数据操作。</p>
<p>显然<code>a href target=_blank</code>是同步操作，点击即跳转。<br>需要点击按钮、进行ajax拿到后、跳转新窗口。<br>做法如下：</p>
<ol>
<li>window.open【会被拦截】</li>
<li>点击按钮先跳转到临时tab页面(执行<code>a href target=_blank</code>)，在临时tab页中进行ajax数据操作。【多了不必要的跳转操作】</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;a onClick=&#123;<span class="keyword">this</span>.onAppClick&#125;&gt;进入应用&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">onAppClick = () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    onTokenCheck().then((token) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        const urlStr = `$&#123;urlFormat&#125;?token=$&#123;token&#125;`;</span></span><br><span class="line"><span class="regexp">        this.openWin(urlStr);</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">openWin= (url) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    $('body').append($(`&lt;a href=$&#123;url&#125; target="_blank" id="openWin"&gt;&lt;/</span>a&gt;<span class="string">`));</span></span><br><span class="line"><span class="string">    document.getElementById('openWin').click();</span></span><br><span class="line"><span class="string">    $('#openWin').remove();</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>微服务</title>
    <url>/want/2019/05/25/%E5%BE%AE%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://github.com/carnellj/spmia-chapter3" target="_blank" rel="noopener">Spring微服务实战</a></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>数字</title>
    <url>/want/2019/08/25/%E6%95%B0%E5%AD%97/</url>
    <content><![CDATA[<h3 id="精度"><a href="#精度" class="headerlink" title="精度"></a>精度</h3><h4 id="toFixed"><a href="#toFixed" class="headerlink" title="toFixed"></a>toFixed</h4><p><strong>四舍六入五成双（银行家舍入规则）</strong></p>
<ul>
<li>四舍</li>
<li>六入</li>
<li>五考虑<ul>
<li>五后非零就进一</li>
<li>五后为零看奇偶：五前为奇要进一，五前为偶应舍去</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="number">0.5251</span>).toFixed(<span class="number">2</span>) =&gt; <span class="number">0.53</span> <span class="comment">// 五后非零就进一</span></span><br><span class="line"></span><br><span class="line">(<span class="number">0.525</span>).toFixed(<span class="number">2</span>)=&gt;<span class="number">0.52</span> <span class="comment">//五后为零看奇偶,五前为偶应舍去</span></span><br></pre></td></tr></table></figure>
<p><strong>改造为四舍五入规则</strong><br>toFixed采用银行家规则有时并符合需求，改造为“四舍五入”：<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Number</span>.prototype.toFixed = <span class="function"><span class="keyword">function</span>(<span class="params">length</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> carry = <span class="number">0</span>; <span class="comment">//存放进位标志</span></span><br><span class="line">  <span class="keyword">var</span> num, multiple; <span class="comment">//num为原浮点数放大multiple倍后的数，multiple为10的length次方</span></span><br><span class="line">  <span class="keyword">var</span> str = <span class="keyword">this</span> + <span class="string">''</span>; <span class="comment">//将调用该方法的数字转为字符串</span></span><br><span class="line">  <span class="keyword">var</span> dot = str.indexOf(<span class="string">"."</span>); <span class="comment">//找到小数点的位置</span></span><br><span class="line">  <span class="keyword">if</span>(str.slice(dot + length + <span class="number">1</span>, dot + length + <span class="number">2</span>) &gt;= <span class="number">5</span>) carry = <span class="number">1</span>; <span class="comment">/*找到要进行舍入的数的位置，手动判断是否大于等于5，满足条件进位标志置为1,这里原作者用的是str.substr(dot + length + 1, 1)*/</span></span><br><span class="line">    multiple = <span class="built_in">Math</span>.pow(<span class="number">10</span>, length); <span class="comment">//设置浮点数要扩大的倍数</span></span><br><span class="line">    num = <span class="built_in">Math</span>.floor(<span class="keyword">this</span> * multiple) + carry; <span class="comment">//去掉舍入位后的所有数，然后加上我们的手动进位数</span></span><br><span class="line">    <span class="keyword">var</span> result = num / multiple + <span class="string">''</span>; <span class="comment">//将进位后的整数再缩小为原浮点数</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 处理进位后无小数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    dot = result.indexOf(<span class="string">"."</span>);</span><br><span class="line">    <span class="keyword">if</span>(dot === <span class="number">-1</span>)&#123;</span><br><span class="line">      result += <span class="string">'.'</span>;</span><br><span class="line">      dot = result.indexOf(<span class="string">"."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 处理多次进位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> len = result.length - (dot+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(len &lt; length)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length - len; i++)&#123;</span><br><span class="line">        result += <span class="number">0</span>        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
  </entry>
  <entry>
    <title>正则</title>
    <url>/want/2019/01/02/%E6%AD%A3%E5%88%99/</url>
    <content><![CDATA[<h3 id="案例1：-将下划线命名批量改成小驼峰命名"><a href="#案例1：-将下划线命名批量改成小驼峰命名" class="headerlink" title="案例1： 将下划线命名批量改成小驼峰命名"></a>案例1： 将下划线命名批量改成小驼峰命名</h3><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>Sql字段通常下划线命名，Java的dto通常小驼峰命名。示例如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hello_world</span><br><span class="line">转换为</span><br><span class="line">helloWorld</span><br></pre></td></tr></table></figure></p>
<p>旨在实现如下校验目标：</p>
<ol>
<li>若 “_小写字母”，则替换为“大写字母”</li>
</ol>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="1-若-“-小写字母”，则替换为“大写字母”"><a href="#1-若-“-小写字母”，则替换为“大写字母”" class="headerlink" title="1.若 “_小写字母”，则替换为“大写字母”"></a>1.若 “_小写字母”，则替换为“大写字母”</h5><ul>
<li>遍历欲替换的字符串列表</li>
<li>对每一项字符串替换</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> source=[</span><br><span class="line">  <span class="string">"wholePreAssets"</span>,</span><br><span class="line">  <span class="string">"wire_gsm_optimize_rate"</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> result=[];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> item <span class="keyword">of</span> source)&#123;</span><br><span class="line">  <span class="keyword">const</span> str=item.replace(<span class="regexp">/_[a-z]/g</span>,<span class="function"><span class="keyword">function</span>(<span class="params">word</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> word.substring(<span class="number">1</span>).toUpperCase();</span><br><span class="line">  &#125;);</span><br><span class="line">  result.push(str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<h5 id="2-将字符串-变量替换为abc"><a href="#2-将字符串-变量替换为abc" class="headerlink" title="2.将字符串/变量替换为abc"></a>2.将字符串/变量替换为abc</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const str = str.replace(new RegExp(name, &apos;gm&apos;), &apos;abc&apos;); // 全局替换</span><br><span class="line">const str = str.replace(name, &apos;abc&apos;); // 只替换第一个</span><br></pre></td></tr></table></figure>
<h4 id="正则整理"><a href="#正则整理" class="headerlink" title="正则整理"></a>正则整理</h4><ol>
<li>获取正则匹配值并替换: str.replace(regex, function(word){ });<ul>
<li>word 即为 正则匹配值</li>
</ul>
</li>
<li>js中没有replaceAll方法，要想全局替换，可借助正则表达式</li>
</ol>
<h3 id="案例2：-“伪SQL表达式”简单校验"><a href="#案例2：-“伪SQL表达式”简单校验" class="headerlink" title="案例2： “伪SQL表达式”简单校验"></a>案例2： “伪SQL表达式”简单校验</h3><h4 id="场景-1"><a href="#场景-1" class="headerlink" title="场景"></a>场景</h4><p>如下” 伪SQL表达式”，其中，数字序号代表具体的表达式（eg. name = 20），and or 小括号等是sql语句常用连接符。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1 and 2 and (3 or 4) and (5 or 6 or 7)</span><br></pre></td></tr></table></figure>
<p>旨在实现如下校验目标：</p>
<ol>
<li>小括号配对校验</li>
<li>将所有数字取出</li>
</ol>
<hr>
<p>附探讨目标：最初设计“伪SQL表达式”如下，以#num代表具体表达式。（毫无必要，已废弃）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#1 and #2 and (#3 or #4) and (#5 or #6 or #7)</span><br></pre></td></tr></table></figure>
<p>探讨目标：</p>
<ol start="3">
<li>#号后面必须紧跟数字</li>
<li>数字之前必须有#号</li>
</ol>
<hr>
<h4 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h4><h5 id="1-取出所有数字"><a href="#1-取出所有数字" class="headerlink" title="1.取出所有数字"></a>1.取出所有数字</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> patten = <span class="regexp">/\d+/g</span>;</span><br><span class="line"><span class="keyword">const</span> numList = str.match(patten) || [];</span><br></pre></td></tr></table></figure>
<h5 id="3-号后面必须紧跟数字"><a href="#3-号后面必须紧跟数字" class="headerlink" title="3.#号后面必须紧跟数字"></a>3.#号后面必须紧跟数字</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> patten = <span class="regexp">/#\D+/</span>;</span><br><span class="line"><span class="keyword">const</span> isNotNumber = patten.test(str);</span><br></pre></td></tr></table></figure>
<h5 id="4-数字之前必须有-号"><a href="#4-数字之前必须有-号" class="headerlink" title="4.数字之前必须有#号"></a>4.数字之前必须有#号</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> patten = <span class="regexp">/#?(?=\d+)\d+/g</span>;</span><br><span class="line"><span class="keyword">const</span> numList =str.match(patten) || []; <span class="comment">// [1,#2,#3,4,5,#6]</span></span><br><span class="line"><span class="keyword">const</span> list = numList.filter(<span class="function"><span class="params">o</span> =&gt;</span> o.indexOf(<span class="string">'#'</span>) === <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">if</span> (list &amp;&amp; list.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	<span class="comment">// 无#的数字列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-校验小括号是否配对"><a href="#2-校验小括号是否配对" class="headerlink" title="2.校验小括号是否配对"></a>2.校验小括号是否配对</h5><ul>
<li>准备一个<strong>栈</strong>结构</li>
<li>遍历字符串中所有字符</li>
<li>如果字符为<strong>左括号</strong>，则字符<strong>入栈</strong></li>
<li>如果字符为<strong>右括号</strong>，则<strong>出栈</strong></li>
<li>如果出栈字符为空，则说明该右括号无左括号对应，返回false</li>
<li>如果出栈字符与右括号所对应的左括号不一致，则说明右括号对应左括号出错，返回false</li>
<li>如果遍历完成后，栈的长度非空，则说明左右括号不一一配对，返回false</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 栈</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.dataStore = [];</span><br><span class="line">    <span class="keyword">this</span>.top = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  push(element) &#123;</span><br><span class="line">    <span class="keyword">this</span>.dataStore[<span class="keyword">this</span>.top++] = element;</span><br><span class="line">  &#125;</span><br><span class="line">  pop() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.dataStore[--<span class="keyword">this</span>.top];</span><br><span class="line">  &#125;</span><br><span class="line">  peek() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.top &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.dataStore[<span class="keyword">this</span>.top - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Empty'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  length() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.top;</span><br><span class="line">  &#125;</span><br><span class="line">  clear() &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.dataStore;</span><br><span class="line">    <span class="keyword">this</span>.dataStore = [];</span><br><span class="line">    <span class="keyword">this</span>.top = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 括号常量</span></span><br><span class="line"><span class="keyword">const</span> PARENTHESES = &#123;</span><br><span class="line">  left: [<span class="string">'('</span>, <span class="string">'&#123;'</span>, <span class="string">'['</span>],</span><br><span class="line">  right: [<span class="string">')'</span>, <span class="string">'&#125;'</span>, <span class="string">']'</span>],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验括号是否配对</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>testStr 待校验字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;boolean&#125;</span> </span>true则括号配对，false则括号不配对</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> checkParentheses = <span class="function">(<span class="params">testStr</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> testCharacterList = testStr.split(<span class="string">''</span>);</span><br><span class="line">  <span class="keyword">const</span> stack = <span class="keyword">new</span> Stack();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; testCharacterList.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> character = testCharacterList[i];</span><br><span class="line">    <span class="keyword">const</span> idxLeft = PARENTHESES.left.indexOf(character);</span><br><span class="line">    <span class="keyword">if</span> (idxLeft &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      stack.push(character);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> idxRight = PARENTHESES.right.indexOf(character);</span><br><span class="line">    <span class="keyword">if</span> (idxRight &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> outCharacter = stack.pop();</span><br><span class="line">      <span class="keyword">if</span> (!outCharacter) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (outCharacter !== PARENTHESES.left[idxRight]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> !stack.length();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="正则整理-1"><a href="#正则整理-1" class="headerlink" title="正则整理"></a>正则整理</h4><ol>
<li>全局匹配数字:  /\d+/g</li>
<li>全局匹配“数字、#数字两种类型” : /#?(?=\d+)\d+/g <ul>
<li>(?=\d+)    获取数字前的位置Pos</li>
<li>#?    位置Pos前有“0或1个＃号”</li>
<li>\d+    位置Pos后有数字</li>
</ul>
</li>
<li>“特殊符号#后不是数字”:/#\D+/</li>
<li>获取字符串内指定值，或正则表达式匹配值： str.match(regex / searchvalue)</li>
<li>检测字符串是否匹配正则模式： regex.test(str)</li>
</ol>
]]></content>
      <tags>
        <tag>数据结构</tag>
        <tag>校验</tag>
      </tags>
  </entry>
  <entry>
    <title>车</title>
    <url>/want/2020/09/13/%E8%BD%A6/</url>
    <content><![CDATA[<p>雷凌豪华版</p>
<h3 id="落地"><a href="#落地" class="headerlink" title="落地"></a>落地</h3><ol>
<li>裸车，115800</li>
<li>保险，5718.72</li>
<li>购置税，10247.79</li>
<li>车贷手续费，1000</li>
<li>上牌手续费，1000</li>
<li>总价 13万3千7百66.51</li>
</ol>
<p>其中，</p>
<ol>
<li>首付：5000</li>
<li>贷款：57900，2年免息。（按裸车价的50%贷款）</li>
</ol>
<h3 id="保险"><a href="#保险" class="headerlink" title="保险"></a>保险</h3><p>人保，首次保险：共5728.05。</p>
<ol>
<li><p>交强险，必须，950</p>
</li>
<li><p>车船税，100</p>
</li>
<li><p>商业险：4678.05</p>
<ul>
<li><p>三者险100万—1891.8——第三人伤亡，车</p>
</li>
<li><p>车损，2176.07（单独轮胎不保不赔）</p>
</li>
<li><p>不计免赔，车损险或三责险）的附加险，把本应由自己负责的5%到20%的赔偿责任再转加给保险公司</p>
<ul>
<li>车损险326.41</li>
<li>三者险283.77</li>
</ul>
</li>
<li><p>玻璃单独损坏险，打到玻璃，又砸到发动机</p>
</li>
<li><p>保驾驶员，保全座</p>
</li>
<li><p>全车盗抢险500（总计5300），</p>
</li>
<li><p>划痕险——涉水后熄火，千万不要二次点火</p>
</li>
</ul>
</li>
</ol>
<p>保险注意事项：</p>
<ol>
<li>超2次报案，优惠减少</li>
<li>超过5次要合影留念。。。</li>
<li>到期前的1、2月就进行续保。用老保险赔付。新保险不受影响。</li>
</ol>
<p>超5次，合影留念</p>
<h3 id="赠送"><a href="#赠送" class="headerlink" title="赠送"></a>赠送</h3><ol>
<li>防爆膜</li>
<li>脚垫</li>
<li>倒车雷达</li>
<li>前后双摄行车记录仪，sd卡，1个小时（1.5h?）</li>
<li>皮椅</li>
<li>遮阳挡</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>节假日</title>
    <url>/want/2021/03/04/%E8%8A%82%E5%81%87%E6%97%A5/</url>
    <content><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>工时统计，经常需要</p>
<p>①减除国家法定节假日</p>
<p>②并增加周末上班时长</p>
<p>这些节假日安排，是由国务院制定，并在上年末（通常是上年11月份）公布在<a href="http://www.gov.cn/" target="_blank" rel="noopener">中国政府网</a>。例如<a href="http://www.gov.cn/fuwu/2020-11/25/content_5564533.htm" target="_blank" rel="noopener">《国务院办公厅关于2021年部分节假日安排的通知》</a>。</p>
<p>而后，第三方的万年历网站会对新年节假日情况进行手动引入，基于此，万年历只能有当年及当年之前的节假日情况。如图示例，目前2021年，则2022年没有节假日信息。</p>
<img src="/want/2021/03/04/节假日/1.png" title="比较">
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>基于此，为了获取节假日可以采用两种手段</p>
<ol>
<li>等待政府消息，手动维护入库</li>
<li>借助已经处理过的第三方万年历入库</li>
</ol>
<p>第三方万年历网站：</p>
<table>
<thead>
<tr>
<th></th>
<th>链接</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>中华万年历</td>
<td><a href="http://yun.rili.cn/wnl/index.html" target="_blank" rel="noopener">http://yun.rili.cn/wnl/index.html</a></td>
<td>提供json返回数据，易于直接获取</td>
</tr>
<tr>
<td>百度</td>
<td><a href="http://opendata.baidu.com/api.php?query=2020%E5%B9%B45%E6%9C%88&amp;resource_id=6018&amp;format=json" target="_blank" rel="noopener">http://opendata.baidu.com/api.php?query=2020%E5%B9%B45%E6%9C%88&amp;resource_id=6018&amp;format=json</a></td>
<td>【老旧】经过尝试，无法获取最新年份的节假日</td>
</tr>
<tr>
<td>聚合数据</td>
<td><a href="https://www.juhe.cn/search/%E4%B8%87%E5%B9%B4%E5%8E%86" target="_blank" rel="noopener">https://www.juhe.cn/search/%E4%B8%87%E5%B9%B4%E5%8E%86</a></td>
<td>【麻烦】需要注册登录身份证实名认证</td>
</tr>
<tr>
<td>其他个人</td>
<td></td>
</tr>
</tbody>
</table>
<p>以中华万年历为例——</p>
<p>部署访问： <a href="http://10.139.18.182:9923/" target="_blank" rel="noopener">http://10.139.18.182:9923/</a></p>
<img src="/want/2021/03/04/节假日/2.png" title="界面示例">
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> onClickToGetAll() &#123;</span><br><span class="line">      <span class="keyword">const</span> year = <span class="string">"2021"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 中华万年历 http://yun.rili.cn/wnl/index.html</span></span><br><span class="line">      <span class="keyword">const</span> url = <span class="string">"http://pc.suishenyun.net/peacock/api/h5/festival"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> result = <span class="keyword">await</span> axios.get(url);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> list = result.data.holidays.cn;</span><br><span class="line">      <span class="keyword">const</span> yearList = list.filter(<span class="function">(<span class="params">item</span>) =&gt;</span></span><br><span class="line">        item.date.toString().startsWith(year)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 放假</span></span><br><span class="line">      <span class="keyword">const</span> holiDayList = yearList</span><br><span class="line">        .filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item.status == <span class="number">0</span>)</span><br><span class="line">        .map(<span class="function">(<span class="params">item</span>) =&gt;</span> item.date);</span><br><span class="line">      <span class="comment">// 周末上班</span></span><br><span class="line">      <span class="keyword">const</span> workDayList = yearList</span><br><span class="line">        .filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item.status == <span class="number">1</span>)</span><br><span class="line">        .map(<span class="function">(<span class="params">item</span>) =&gt;</span> item.date); </span><br><span class="line"></span><br><span class="line">      <span class="comment">// 工作日放假（抛去周末放假（周末本来就是节假日嘛)）</span></span><br><span class="line">      <span class="keyword">const</span> weekendList = <span class="keyword">this</span>.getWeekendList(year);</span><br><span class="line">      <span class="keyword">const</span> holiDayListExceptWeekend = holiDayList.filter(</span><br><span class="line">        (item) =&gt; !weekendList.includes(item)</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      <span class="built_in">console</span>.log(workDayList);</span><br><span class="line">      <span class="built_in">console</span>.log(holiDayListExceptWeekend);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// 待优化                  </span></span><br><span class="line">getWeekendList(year) &#123;</span><br><span class="line">      <span class="keyword">const</span> firstYearDate = moment(<span class="string">`<span class="subst">$&#123;year&#125;</span>-01-01`</span>);</span><br><span class="line">      </span><br><span class="line">  		<span class="keyword">let</span> firstYearWeek;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          <span class="number">0</span> ==</span><br><span class="line">          moment(firstYearDate)</span><br><span class="line">            .add(i, <span class="string">"days"</span>)</span><br><span class="line">            .weekday()</span><br><span class="line">        ) &#123;</span><br><span class="line">          firstYearWeek = moment(firstYearDate).add(i, <span class="string">"days"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> list = [];</span><br><span class="line">      <span class="keyword">while</span> (firstYearWeek.year() == year) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          moment(firstYearWeek)</span><br><span class="line">            .add(<span class="number">-1</span>, <span class="string">"days"</span>)</span><br><span class="line">            .year() == year</span><br><span class="line">        ) &#123;</span><br><span class="line">          list.push(firstYearWeek.clone().add(<span class="number">-1</span>, <span class="string">"days"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        list.push(firstYearWeek.clone());</span><br><span class="line">        firstYearWeek = moment(firstYearWeek).add(<span class="number">7</span>, <span class="string">"days"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> list.map(<span class="function">(<span class="params">item</span>) =&gt;</span> <span class="built_in">parseInt</span>(item.format(<span class="string">"YYYYMMDD"</span>)));</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>聚合数据使用案例：</p>
<p><a href="https://www.jianshu.com/p/ef14da9b6b6a" target="_blank" rel="noopener">https://www.jianshu.com/p/ef14da9b6b6a</a></p>
]]></content>
  </entry>
  <entry>
    <title>验证码</title>
    <url>/want/2019/06/06/%E9%AA%8C%E8%AF%81%E7%A0%81/</url>
    <content><![CDATA[<h3 id="SpringBoot-之-kaptcha"><a href="#SpringBoot-之-kaptcha" class="headerlink" title="SpringBoot 之 kaptcha"></a>SpringBoot 之 kaptcha</h3><p>kaptcha，一款谷歌出品的验证码工具</p>
<h4 id="引入kaptcha"><a href="#引入kaptcha" class="headerlink" title="引入kaptcha"></a>引入kaptcha</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="配置验证码样式"><a href="#配置验证码样式" class="headerlink" title="配置验证码样式"></a>配置验证码样式</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.util.Config;</span><br><span class="line"><span class="keyword">import</span> com.google.code.kaptcha.impl.DefaultKaptcha;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaptchaConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultKaptcha <span class="title">getDefaultKaptcha</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultKaptcha captchaProducer = <span class="keyword">new</span> DefaultKaptcha();</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.border"</span>, <span class="string">"yes"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.border.color"</span>, <span class="string">"44,156,250"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.color"</span>, <span class="string">"black"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.width"</span>, <span class="string">"110"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.image.height"</span>, <span class="string">"30"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.obscurificator.impl"</span>, <span class="string">"com.google.code.kaptcha.impl.ShadowGimpy"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.size"</span>, <span class="string">"24"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.session.key"</span>, <span class="string">"code"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.char.length"</span>, <span class="string">"4"</span>);</span><br><span class="line">        properties.setProperty(<span class="string">"kaptcha.textproducer.font.names"</span>, <span class="string">"宋体,楷体,微软雅黑"</span>);</span><br><span class="line">        Config config = <span class="keyword">new</span> Config(properties);</span><br><span class="line">        captchaProducer.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> captchaProducer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他配置项</p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>描写叙述</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>kaptcha.border</td>
<td>图片边框，合法值：yes , no</td>
<td>yes</td>
</tr>
<tr>
<td>kaptcha.border.color</td>
<td>边框颜色，合法值： r,g,b (and optional alpha) 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.border.thickness</td>
<td>边框厚度。合法值：&gt;0</td>
<td>1</td>
</tr>
<tr>
<td>kaptcha.image.width</td>
<td>图片宽</td>
<td>200</td>
</tr>
<tr>
<td>kaptcha.image.height</td>
<td>图片高</td>
<td>50</td>
</tr>
<tr>
<td>kaptcha.producer.impl</td>
<td>图片实现类</td>
<td>com.google.code.kaptcha.impl.DefaultKaptcha</td>
</tr>
<tr>
<td>kaptcha.textproducer.impl</td>
<td>文本实现类</td>
<td>com.google.code.kaptcha.text.impl.DefaultTextCreator</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.string</td>
<td>文本集合，验证码值从此集合中获取</td>
<td>abcde2345678gfynmnpwx</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.length</td>
<td>验证码长度</td>
<td>5</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.names</td>
<td>字体</td>
<td>Arial, Courier</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.size</td>
<td>字体大小</td>
<td>40px.</td>
</tr>
<tr>
<td>kaptcha.textproducer.font.color</td>
<td>字体颜色，合法值： r,g,b  或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.textproducer.char.space</td>
<td>文字间隔</td>
<td>2</td>
</tr>
<tr>
<td>kaptcha.noise.impl</td>
<td>干扰实现类</td>
<td>com.google.code.kaptcha.impl.DefaultNoise</td>
</tr>
<tr>
<td>kaptcha.noise.color</td>
<td>干扰颜色。合法值： r,g,b 或者 white,black,blue.</td>
<td>black</td>
</tr>
<tr>
<td>kaptcha.background.impl</td>
<td>背景实现类</td>
<td>com.google.code.kaptcha.impl.DefaultBackground</td>
</tr>
<tr>
<td>kaptcha.background.clear.from</td>
<td>背景颜色渐变，開始颜色</td>
<td>light grey</td>
</tr>
<tr>
<td>kaptcha.background.clear.to</td>
<td>背景颜色渐变。结束颜色</td>
<td>white</td>
</tr>
<tr>
<td>kaptcha.word.impl</td>
<td>文字渲染器</td>
<td>com.google.code.kaptcha.text.impl.DefaultWordRenderer</td>
</tr>
<tr>
<td>kaptcha.session.key</td>
<td>session key</td>
<td>KAPTCHA_SESSION_KEY</td>
</tr>
<tr>
<td>kaptcha.session.date</td>
<td>session date</td>
<td>KAPTCHA_SESSION_DATE</td>
</tr>
<tr>
<td>kaptcha.obscurificator.impl</td>
<td>图片样式：水纹com.google.code.kaptcha.impl.WaterRipple 鱼眼com.google.code.kaptcha.impl.FishEyeGimpy 阴影com.google.code.kaptcha.impl.ShadowGimpy</td>
<td>com.google.code.kaptcha.impl.WaterRipple</td>
</tr>
</tbody>
</table>
<h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/captcha"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaptchaController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DefaultKaptcha defaultKaptcha;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成验证码</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createKaptcha</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        HttpSession session = request.getSession();</span><br><span class="line">        response.setDateHeader(<span class="string">"Expires"</span>, <span class="number">0</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-store, no-cache, must-revalidate"</span>);</span><br><span class="line">        response.addHeader(<span class="string">"Cache-Control"</span>, <span class="string">"post-check=0, pre-check=0"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"image/jpeg"</span>);</span><br><span class="line"></span><br><span class="line">        String capText = defaultKaptcha.createText();</span><br><span class="line">        session.setAttribute(Const.KAPTCHA_SESSION_KEY, capText);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            BufferedImage img = defaultKaptcha.createImage(capText);</span><br><span class="line">            ImageIO.write(img, <span class="string">"jpg"</span>, out);</span><br><span class="line"></span><br><span class="line">            BASE64Encoder encoder = <span class="keyword">new</span> BASE64Encoder();</span><br><span class="line">            String base64 = encoder.encode(out.toByteArray()).trim();</span><br><span class="line">            String base64Format = <span class="string">"data:image/png;base64,"</span> + base64.replaceAll(<span class="string">"\n"</span>, <span class="string">""</span>).replaceAll(<span class="string">"\r"</span>, <span class="string">""</span>);</span><br><span class="line">            <span class="keyword">return</span> base64Format;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验验证码</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/verify"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">verifyKaptcha</span><span class="params">(@RequestParam String captcha, <span class="keyword">final</span> HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isCaptchaPassed = KaptchaUtil.checkVerifyCode(captcha, request);</span><br><span class="line">        <span class="keyword">return</span> isCaptchaPassed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KaptchaUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkVerifyCode</span><span class="params">(String captchaInput, <span class="keyword">final</span> HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String captchaExpected = (String) request.getSession().getAttribute(Const.KAPTCHA_SESSION_KEY);</span><br><span class="line">        <span class="keyword">return</span> captchaInput != <span class="keyword">null</span> &amp;&amp; captchaInput.equals(captchaExpected);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;img</span><br><span class="line">	className=&quot;image&quot;</span><br><span class="line">	alt=&quot;点击更换&quot;</span><br><span class="line">	onClick=&#123;this.onRefreshCode&#125;</span><br><span class="line">	src=&quot;&quot;</span><br><span class="line">	ref=&#123;(dom) =&gt; &#123; this.codeImg = dom; &#125;&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line">onRefreshCode = () =&gt; &#123;</span><br><span class="line">  this.props.getCode().then((data) =&gt; &#123;</span><br><span class="line">    if (data) &#123;</span><br><span class="line">      this.codeImg.src = data; // src = data:image/png;base64图片</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>调取校验接口（captcha/verify）时，注意<strong>跨域</strong>携带session（后端用其存储验证码）<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ajax：</span><br><span class="line">xhrFields: &#123;withCredentials: true&#125;</span><br><span class="line"></span><br><span class="line">fetch:</span><br><span class="line">credentials: &apos;include&apos;</span><br></pre></td></tr></table></figure></p>
]]></content>
  </entry>
  <entry>
    <title>SpringBoot</title>
    <url>/want/2019/02/18/SpringBoot/</url>
    <content><![CDATA[<h3 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h3><p>Spring boot项目启动方式<br>|启动方式|命令|<br>|-|-|<br>|主类启动|Run 类|<br>|以spring-boot的maven插件spring-boot-maven-plugin启动|mvn spring-boot:run|<br>|jar/war启动| mvn clean package &amp;&amp; java -jar xxx.jar   |</p>
<h3 id="带前端静态资源一键打包"><a href="#带前端静态资源一键打包" class="headerlink" title="带前端静态资源一键打包"></a>带前端静态资源一键打包</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>application.properties<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.mvc.static-path-pattern=/static/**</span><br><span class="line">spring.mvc.view.suffix=.html</span><br><span class="line">spring.mvc.throw-exception-if-no-handler-found=true</span><br><span class="line">spring.resources.static-locations=classpath:/META-INF/resources/,classpath:/resources/,classpath:/static/</span><br></pre></td></tr></table></figure></p>
<p>或者application.yml<br><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">mvc:</span></span><br><span class="line">        <span class="attr">static-path-pattern:</span> <span class="string">/static/**</span></span><br><span class="line">        <span class="attr">view:</span></span><br><span class="line">            <span class="attr">suffix:</span> <span class="string">.html</span></span><br><span class="line">        <span class="attr">throw-exception-if-no-handler-found:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">static-locations:</span> <span class="string">classpath:/META-INF/resources/,classpath:/resources/,classpath:/static/</span></span><br></pre></td></tr></table></figure></p>
<h4 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> *******;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">transient</span> Logger LOG = LoggerFactory.getLogger(SystemController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return to the index page.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the index page</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOG.debug(<span class="string">"return to the system index page."</span>);</span><br><span class="line">        <span class="comment">// the 'static' prefix MUST BE the same as the value of 'spring.mvc.static-path-pattern' field defined in 'application.properties'</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/static/index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>app/**/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>node/**/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>node<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.eirslett<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>frontend-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">installDirectory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">installDirectory</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">workingDirectory</span>&gt;</span>src/main/resources/app<span class="tag">&lt;/<span class="name">workingDirectory</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">id</span>&gt;</span>install node and npm<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>install-node-and-npm<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">nodeVersion</span>&gt;</span>v6.11.2<span class="tag">&lt;/<span class="name">nodeVersion</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">downloadRoot</span>&gt;</span>https://npm.taobao.org/mirrors/node/<span class="tag">&lt;/<span class="name">downloadRoot</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">id</span>&gt;</span>npm install<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>npm<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>install<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">id</span>&gt;</span>npm build<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>npm<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">phase</span>&gt;</span>generate-resources<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">arguments</span>&gt;</span>run build<span class="tag">&lt;/<span class="name">arguments</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><p>mvn clean package -Dmaven.test.skip=true -PdisableFindBug,node</p>
<p>mvn clean package -DskipTests -Pnode</p>
<h3 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h3><h5 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h5><p>implements Filter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"CorsFilter "</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>,<span class="string">"*"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST, GET, PATCH, DELETE, PUT"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Max-Age"</span>, <span class="string">"3600"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Origin, X-Requested-With, Content-Type, Accept"</span>);</span><br><span class="line">        chain.doFilter(req, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="单个接口"><a href="#单个接口" class="headerlink" title="单个接口"></a>单个接口</h4><p><strong>@CrossOrigin</strong>注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CrossOrigin</span>(origins = <span class="string">"http://localhost:4000"</span>)</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"goods-url"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">queryGoodsWithGoodsUrl</span><span class="params">(@RequestParam String goodsUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/grid?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=root</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>
<h3 id="mybatis"><a href="#mybatis" class="headerlink" title="mybatis"></a>mybatis</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis.spring.boot/mybatis-spring-boot-starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="让mapper类能够被Spring管理-引入Mybatis"><a href="#让mapper类能够被Spring管理-引入Mybatis" class="headerlink" title="让mapper类能够被Spring管理(引入Mybatis)"></a>让mapper类能够被Spring管理(引入Mybatis)</h4><pre class="mermaid">graph LR
A(注解) --> B{全局}
B -->|YES|B1(MapperScan)
B -->|NO|B2(Mapper)</pre>

<ol>
<li>@Mapper<ul>
<li>单个注解</li>
<li>要对每一个mapper类都注解@Mapper</li>
<li>在每一个mapper接口前指定</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="function">Long <span class="title">getCreditLevelById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>@MapperScan(“com.sample.ch1.persistence”)<ul>
<li>全局注解</li>
<li>全局指定要扫描的Mapper类的包路径</li>
<li>在项目入口文件处指定</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.sample.ch1.persistence"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Ch1Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Ch1Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mapper两种写法"><a href="#mapper两种写法" class="headerlink" title="mapper两种写法"></a>mapper两种写法</h4><pre class="mermaid">graph LR
A{SQL独立写入xml文件} --> |YES|B(两个文件)
A-->|NO|C(一个文件)

C --> C1(interface)

B --> B1(interface)
B --> B2(.xml)
B1 -.文件名相同+sql的Id与接口方法名相同.- B2</pre>

<ol>
<li>SQL直接与接口写在同一文件</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">"select credit_level from `user` where `id` = #&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">Long <span class="title">getCreditLevelById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>SQL单独写在xml文件中</li>
</ol>
<p><strong>接口文件</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">    <span class="function">Long <span class="title">getCreditLevelById</span><span class="params">(@Param(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>xml文件</strong><br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sample.ch1.persistence.UserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getCreditLevelById"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Long"</span> <span class="attr">parameterType</span>=<span class="string">"java.lang.String"</span>&gt;</span></span><br><span class="line">      select credit_level from `user` where `id` = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="mapper-xml的位置"><a href="#mapper-xml的位置" class="headerlink" title="mapper.xml的位置"></a>mapper.xml的位置</h4><pre class="mermaid">graph LR
B2(.xml) --> D{xml位置}

D --> E(resources静态文件夹)
D --> F(与interface同目录)

E --> E1(配置application.properties)
F --> F1(配置pom.xml)</pre>

<ol>
<li>resources<br> maven项目的mapper.xml默认放<strong>resources</strong>中，项目构建时会自动加载到target。<br> 此方案需配置application.properties。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#application.properties</span><br><span class="line"></span><br><span class="line">#mybatis</span><br><span class="line"></span><br><span class="line">#Mapper.xml存放位置。当Mapper.xml与对应Mapper接口同一位置时，不用指定该属性的值。</span><br><span class="line">mybatis.mapper-locations=classpath:mapping/*.xml</span><br><span class="line"></span><br><span class="line">#实体类所在包。多个package用逗号或者分号分隔。</span><br><span class="line">mybatis.type-aliases-package=com.sample.ch1.model</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>非resources<br> 非resources的.xml(比如，和Mapper接口置于同一文件夹)，默认不会编译到target。<br> 需要在pom.xml文件的build添加resource资源列表。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java/com/sample/ch1/persistence<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>com/sample/ch1/persistence<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>true<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="mybatis-generator"><a href="#mybatis-generator" class="headerlink" title="mybatis-generator"></a>mybatis-generator</h4><p>mybatis自动代码生成工具，自动生成如下内容：</p>
<ol>
<li>实体</li>
<li>mapper接口</li>
<li>xml配置文件</li>
</ol>
<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><p>官网下载<br><a href="https://github.com/mybatis/generator/releases" target="_blank" rel="noopener">https://github.com/mybatis/generator/releases</a></p>
<p>引入方式有两种：</p>
<ol>
<li>直接下载mybatis-generator-core-1.3.7.jar，以命令行方式运行</li>
<li>添加maven依赖，以maven方式执行</li>
</ol>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://blog.mybatis.org/" target="_blank" rel="noopener">MyBatis</a></li>
<li><a href="https://github.com/mybatis/generator/releases" target="_blank" rel="noopener">MyBatis generator</a></li>
</ol>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>SpringBoot支持多种日志框架，如 log4j2 \ logback \ java util logging 等。其中logback是SpringBoot内置的日志框架。</p>
<p>由于log4j2 <a href="https://www.jianshu.com/p/f18a9cff351d" target="_blank" rel="noopener">性能</a> 和配置的灵活性，SpringBoot1.4以上版本建议使用log4j2。</p>
<h4 id="配置log4j2"><a href="#配置log4j2" class="headerlink" title="配置log4j2"></a>配置log4j2</h4><h5 id="去掉内置框架-pom-xml"><a href="#去掉内置框架-pom-xml" class="headerlink" title="去掉内置框架(pom.xml)"></a>去掉内置框架(pom.xml)</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--去掉内置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="引入log4j2-pom-xml"><a href="#引入log4j2-pom-xml" class="headerlink" title="引入log4j2 (pom.xml)"></a>引入log4j2 (pom.xml)</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="配置log4j2-1"><a href="#配置log4j2-1" class="headerlink" title="配置log4j2"></a>配置log4j2</h5><pre class="mermaid">graph TB
A(配置log4j2) --> B(log4j2-spring.xml)
A --> C(application.properties)
B --- D{所处位置}
D --- D1(resources静态资源)
D --- D2(config配置文件夹)

D1 -.application.properties.- E(logging.config= classpath:log4j2.xml)
D2 -.application.properties.- F(logging.config=./config/log4j2-spring.xml)

D1 -.- E1(命名为log4j2-spring.xml也可省配置)
C -.- G(直接命令行配置)</pre>

<p>配置log4j2有两种方式：</p>
<ol>
<li><p>单独创建xml， 在application.properties引入</p>
</li>
<li><p>在application.properties通过命令行配置</p>
</li>
</ol>
<p>无论上述哪种方式，当①位置在resources中，且②命名符合spring标准，则可省去在application.properties引入。命名规则如下：</p>
<ul>
<li>Logback： logback-spring.xml, logback-spring.groovy, logback.xml, logback.groovy</li>
<li>Log4j： log4j-spring.properties, <strong>log4j-spring.xml</strong>, log4j.properties,  log4j.xml</li>
<li>Log4j2： <strong>log4j2-spring.xml</strong>, log4j2.xml</li>
<li>JDK (Java Util Logging)： logging.properties</li>
</ul>
<p>否则，需要做如下引入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#application.properties</span><br><span class="line"></span><br><span class="line">#若放置于config</span><br><span class="line">logging.config=./config/log4j2-spring.xml</span><br><span class="line"></span><br><span class="line">#若放置于resources</span><br><span class="line">#logging.config= classpath:log4j2.xml</span><br></pre></td></tr></table></figure>
<h4 id="语法说明"><a href="#语法说明" class="headerlink" title="语法说明"></a>语法说明</h4><h5 id="日志配置结构"><a href="#日志配置结构" class="headerlink" title="日志配置结构"></a>日志配置结构</h5><pre class="mermaid">graph TB

A(Configuration) --> B(Properties)
A --> C(Appenders)
A --> D(Loggers)

B --> B1(Property)

C --> C1(Console)
C --> C2(RollingFile)

D --> D1(Root必须)
D --> D2(Logger)

C1 -.- E(PatternLayout)
C2 -.- E

E --- E1(格式输出规则)

D1 -.- F(AppenderRef)
D2 -.- F</pre>



<h5 id="格式输出规则"><a href="#格式输出规则" class="headerlink" title="格式输出规则"></a>格式输出规则</h5><table>
<thead>
<tr>
<th>格式</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>%d{HH: mm:ss.SSS} / %date</td>
<td>日志输出时间</td>
</tr>
<tr>
<td>%thread</td>
<td>输出日志的进程名字，这在Web应用以及异步任务处理中很有用</td>
</tr>
<tr>
<td>%-5level</td>
<td>日志级别，并且使用5个字符靠左对齐</td>
</tr>
<tr>
<td>%level</td>
<td>级别</td>
</tr>
<tr>
<td>%-</td>
<td>左对齐</td>
</tr>
<tr>
<td>%5</td>
<td>5个固定字符，不足用空格补齐</td>
</tr>
<tr>
<td>%logger{36} / %c</td>
<td>包名+类名，{36}限制长度，长度不够则尽可能显示雷鸣，压缩报名</td>
</tr>
<tr>
<td>%msg / %m</td>
<td>日志消息</td>
</tr>
<tr>
<td>%n</td>
<td>平台的换行符</td>
</tr>
<tr>
<td>%M</td>
<td>方法名字</td>
</tr>
<tr>
<td>%L</td>
<td>日志调用所在代码行，线上不建议</td>
</tr>
</tbody>
</table>
<h5 id="级别level"><a href="#级别level" class="headerlink" title="级别level"></a>级别level</h5><p>Log4j建议只使用四个级别，优先级从高到低分别是error、warn、info、debug。如果将日志设置在某个等级，则只能打印&gt;=等级的日志。</p>
<pre class="mermaid">graph TB

A(日志级别) --- B(aLL)
A --- C(trace)
A--- D(debug)
A --> E[info]
A --> F[warn]
A --> G[error]
A --> H(fatal)
A --> I(off)

D --- D1[常用]
E --- E1[常用]
F --- F1[常用]
G --- G1[常用]</pre>

<table>
<thead>
<tr>
<th>级别</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>all</td>
<td>最低等级，打开所有日志记录</td>
</tr>
<tr>
<td>trace</td>
<td>一般不会使用</td>
</tr>
<tr>
<td>debug</td>
<td>细粒度信息，有助于调试，用于开发过程中打印一些运行信息</td>
</tr>
<tr>
<td>info</td>
<td>粗粒度信息，突出应用程序的运行过程。可在生产环境中输出程序运行的重要信息，但是不能滥用，避免打印过多的日志。</td>
</tr>
<tr>
<td>warn</td>
<td>会出现潜在错误的场景，有些信息不是错误信息，但是也要给程序员提示。</td>
</tr>
<tr>
<td>error</td>
<td>虽然发生错误，但不影响系统继续运行。打印错误和异常信息。如果不想输出太多的日志，可以使用这个级别。</td>
</tr>
<tr>
<td>fatal</td>
<td>严重错误，将导致应用程序退出。这种级别可以直接停止程序。</td>
</tr>
<tr>
<td>off</td>
<td>最高等级，用于关闭所有日志记录</td>
</tr>
</tbody>
</table>
<h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout" target="_blank" rel="noopener">log4j官网</a></li>
<li><a href="https://my.oschina.net/xiedeshou/blog/1931982" target="_blank" rel="noopener">日志管理之整合篇</a></li>
<li><a href="https://www.jianshu.com/p/f67c721eea1b" target="_blank" rel="noopener">Spring Boot 日志配置(超详细)</a></li>
</ol>
<h3 id="Swagger2"><a href="#Swagger2" class="headerlink" title="Swagger2"></a>Swagger2</h3><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">pom.xml      </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="创建配置类-Swagger2Config"><a href="#创建配置类-Swagger2Config" class="headerlink" title="创建配置类 Swagger2Config"></a>创建配置类 Swagger2Config</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(aipInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.sample.ch1.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">aipInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"demo rest api"</span>)</span><br><span class="line">                .description(<span class="string">"Spring BOOT 2基础示例"</span>)</span><br><span class="line">                .license(<span class="string">"@2019"</span>)</span><br><span class="line">                .version(<span class="string">"1.0.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="在controller使用"><a href="#在controller使用" class="headerlink" title="在controller使用"></a>在controller使用</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(value = <span class="string">"用户管理"</span>, tags = <span class="string">"用户管理接口"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">     <span class="meta">@ApiOperation</span>(value = <span class="string">"查看用户列表"</span>) <span class="comment">// 注意指定method</span></span><br><span class="line">     <span class="meta">@RequestMapping</span>(value = <span class="string">"/list"</span>, method = RequestMethod.GET)</span><br><span class="line">     <span class="function"><span class="keyword">public</span> List&lt;UserDto&gt; <span class="title">getUserList</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 <a href="http://localhost:8080/swagger-ui.html" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html</a></p>
<h4 id="启用场景"><a href="#启用场景" class="headerlink" title="启用场景"></a>启用场景</h4><p>Swagger文档在开发环境可查看，在生产环境不可查看。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">#application.properties</span><br><span class="line"></span><br><span class="line">swagger.enable=false</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Swagger2Config</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;swagger.enable&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> swaggerEnable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">               .enable(swaggerEnable) <span class="comment">// 启用</span></span><br><span class="line">               .apiInfo(aipInfo())</span><br><span class="line">               .select()</span><br><span class="line">               .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.sample.ch1.controller"</span>))</span><br><span class="line">               .paths(PathSelectors.any())</span><br><span class="line">               .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://blog.didispace.com/springbootswagger2/" target="_blank" rel="noopener">Spring Boot中使用Swagger2构建强大的RESTful API文档</a></li>
</ol>
<h3 id="Spring-Boot-Actuator"><a href="#Spring-Boot-Actuator" class="headerlink" title="Spring Boot Actuator"></a>Spring Boot Actuator</h3><p>监控和管理Spring Boot应用，比如健康检查、审计、统计和HTTP追踪等。</p>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><p>安装依赖<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p>
<p>启动项目<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure></p>
<p>访问地址，展示所有通过HTTP暴露的endpoints<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/actuator</span><br></pre></td></tr></table></figure></p>
<p>访问具体endpoints，查看状态，如果UP则健康，DOWN不健康<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://localhost:8080/actuator/health</span><br></pre></td></tr></table></figure></p>
<h4 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h4><p><a href="https://www.jianshu.com/p/d5943e303a1f" target="_blank" rel="noopener">Spring Boot Actuator:健康检查、审计、统计和监控</a></p>
<h3 id="REST-API"><a href="#REST-API" class="headerlink" title="REST API"></a>REST API</h3><h4 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentVersioningController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"v1/student"</span>)</span><br><span class="line">  <span class="comment">// @GetMapping(value = "/student/param", params = "version=1")</span></span><br><span class="line">  <span class="comment">// @GetMapping(value = "/student/header", headers = "X-API-VERSION=1")</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> StudentV1 <span class="title">studentV1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StudentV1(<span class="string">"Bob Charlie"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"v2/student"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> StudentV2 <span class="title">studentV2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StudentV2(<span class="keyword">new</span> Name(<span class="string">"Bob"</span>, <span class="string">"Charlie"</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h3><h4 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h4><ol>
<li>Plain Ordinary Java Object，简单Java对象。</li>
<li>只有一些属性及getter/setter的实体类，没有业务逻辑。</li>
<li>常用于model或dto。</li>
</ol>
<h4 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h4><ol>
<li>提供一个默认的无参构造函数。</li>
<li>需要被序列化并且实现了Serializable接口。</li>
<li>可能有一系列可读写属性。</li>
<li>可能有一系列的”getter”或”setter”方法。</li>
</ol>
<h4 id="JavaBean与POJO"><a href="#JavaBean与POJO" class="headerlink" title="JavaBean与POJO"></a>JavaBean与POJO</h4><ol>
<li>POJO是比Javabean更纯净的简单类或接口。POJO严格地遵守简单对象的概念，而一些JavaBean中往往会封装一些简单逻辑。</li>
<li>POJO主要用于数据的临时传递，它只能装载数据， 作为数据存储的载体，而不具有业务逻辑处理的能力。</li>
<li>Javabean虽然数据的获取与POJO一样，但是javabean当中可以有其它的方法。</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>ftp</title>
    <url>/want/2020/06/11/ftp/</url>
    <content><![CDATA[<p>环境：centos8.1</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install vsftpd</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 进入root用户</span><br><span class="line">sudo -i</span><br><span class="line"></span><br><span class="line"># 进入ftp配置文件</span><br><span class="line">vim /etc/vsftpd/vsftpd.conf</span><br></pre></td></tr></table></figure>
<h4 id="匿名登录"><a href="#匿名登录" class="headerlink" title="匿名登录"></a>匿名登录</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 匿名登录开启</span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line"></span><br><span class="line">local_enable=YES</span><br><span class="line"></span><br><span class="line">write_enable=YES</span><br><span class="line"></span><br><span class="line">local_umask=022</span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名上传</span></span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名操作文件夹</span></span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许修改或删除文件</span></span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"></span><br><span class="line">dirmessage_enable=YES</span><br><span class="line"></span><br><span class="line">xferlog_enable=YES</span><br><span class="line"></span><br><span class="line">connect_from_port_20=YES</span><br><span class="line"></span><br><span class="line">xferlog_std_format=YES</span><br><span class="line"></span><br><span class="line">listen=NO</span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名权限,新增文件权限<span class="built_in">umask</span></span></span><br><span class="line">anon_umask=022</span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名FTP的根路径</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认根目录/var/ftp/pub，此处修改到另一个目录/user/wlw</span></span><br><span class="line">anon_root=/user/wlw</span><br><span class="line">local_root=/user/wlw</span><br><span class="line">listen_ipv6=YES</span><br><span class="line"></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br></pre></td></tr></table></figure>
<h3 id="启动ftp服务"><a href="#启动ftp服务" class="headerlink" title="启动ftp服务"></a>启动ftp服务</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start vsftpd.service</span><br><span class="line">systemctl status vsftpd.service</span><br><span class="line"></span><br><span class="line">或者命令：service vsftpd.service start</span><br></pre></td></tr></table></figure>
<h3 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=21/tcp --permanent</span><br><span class="line"></span><br><span class="line">firewall-cmd --zone=public --add-port=1025-65535/tcp --permanent</span><br><span class="line"></span><br><span class="line">systemctl restart firewalld</span><br></pre></td></tr></table></figure>
<h3 id="selinux配置"><a href="#selinux配置" class="headerlink" title="selinux配置"></a>selinux配置</h3><h4 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h4><ol>
<li>selinux是内核级加强型火墙</li>
<li>开启或关闭selinux，需要重启电脑</li>
</ol>
<p>selinux的状态：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>Enforcing</td>
<td>警告并拒绝</td>
</tr>
<tr>
<td>Permissive</td>
<td>警告并允许</td>
</tr>
<tr>
<td>Disabled</td>
<td>关闭</td>
</tr>
</tbody>
</table>
<p>查看selinux状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getenforce</span><br></pre></td></tr></table></figure>
<p>更改selinux的状态</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">setenforce 1		##更改selinux的状态为Enforcing</span><br><span class="line">setenforce 0		##更改selinux的状态为Permissive</span><br></pre></td></tr></table></figure>
<h4 id="FTP相关"><a href="#FTP相关" class="headerlink" title="FTP相关"></a>FTP相关</h4><p>vsftpd 默认被 SELinux 拦截，会碰到如下问题：</p>
<ol>
<li>226 Transfer done (but failed to open directory).（传输完成，但是打开路径失败）</li>
<li>550 Failed to change directory（更改路径失败）</li>
<li>553 Could not create file.</li>
<li>或者干脆在发送了LIST命令以后，服务器没响应，超时断开。</li>
</ol>
<p>方法1：降低SELinux安全级别，把enforcing降低到permissive 或disabled</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 打开文件</span></span><br><span class="line">vim /etc/sysconfig/selinux</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动修改selinux状态为Disabled。并重启。</span></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure>
<p>方法2：只修改SELinux的FTP相关内容</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看SELinux中有关FTP的设置状态</span></span><br><span class="line">getsebool -a | grep ftp</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加-P是保存选项，每次重启时不必重新执行这个命令了</span></span><br><span class="line">setsebool -P ftpd_disable_trans 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">setsebool -P ftp_home_dir 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启FTP服务</span></span><br><span class="line">service vsftpd restart</span><br></pre></td></tr></table></figure>
<h3 id="路径问题"><a href="#路径问题" class="headerlink" title="路径问题"></a>路径问题</h3><p>无论匿名用户还是实名用户都要注意可访问目录的权限问题。</p>
<p>匿名FTP的根路径，权限：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">drwxr-xr-x    3 root root   17 6月   6 05:01 user</span><br><span class="line">drwxr-xr-x 3 root root 19 6月   6 05:01 wlw</span><br></pre></td></tr></table></figure></p>
<p>配置的最佳实践是将【var/ftp/pub】（/user/wlw/share）目录所有者改为ftp，文件操作仅在share目录进行。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chown ftp:ftp -R /var/ftp/pub</span><br><span class="line">chown ftp:ftp -R /user/wlw/share</span><br><span class="line"></span><br><span class="line">drwxrwxrwx 2 ftp ftp 155 6月   9 20:49 share</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 或，如果使用var/ftp/pub目录</span></span><br><span class="line">drwxrwxrwx. 2 ftp ftp 43 6月  11 17:22 pub</span><br></pre></td></tr></table></figure>
<p>总言之，</p>
<blockquote>
<p>在/etc/vsft pd/vsftpd.conf查看根路径。</p>
<p>默认是/var/ftp/pub【此时将路径写成pub】。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">根目录是/user/wlw</span><br><span class="line">当要访问/user/wlw/share目录</span><br><span class="line">就要将路径写成share目录</span><br><span class="line">而不是/user/wlw/share</span><br></pre></td></tr></table></figure>
<p>即在真正调用ftp路径时候，只需要将<code>share</code>目录作为路径（应该忽略ftp根路径），不需要配/user/wlw/share整个路径。</p>
<h3 id="windows客户端工具"><a href="#windows客户端工具" class="headerlink" title="windows客户端工具"></a>windows客户端工具</h3><p>FTP配置后，先使用客户端工具尝试访问成功之后，再使用程序测试。</p>
<h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><img src="/want/2020/06/11/ftp/browser.png" title="浏览器">
<h4 id="资源管理器"><a href="#资源管理器" class="headerlink" title="资源管理器"></a>资源管理器</h4><img src="/want/2020/06/11/ftp/resource.png" title="资源管理器">
<h4 id="cmd命令"><a href="#cmd命令" class="headerlink" title="cmd命令"></a>cmd命令</h4><p>cmd命令的匿名用户名是ftp，密码为空</p>
<img src="/want/2020/06/11/ftp/cmd.png" title="cmd 命令行访问">
<h3 id="Java程序"><a href="#Java程序" class="headerlink" title="Java程序"></a>Java程序</h3><p>Java中与FTP服务器交互的客户端程序有两种：</p>
<ol>
<li>【推进】使用第三方依赖包commons-net的FTPClient</li>
<li>使用JDK自带sun.net.ftp.FtpClient（JDK自带程序存在一些问题）</li>
</ol>
<p>目前，commons-net的FTPClient使用更为普遍。</p>
<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-net/commons-net --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-net<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-net<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h4><h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FTPClient ftp = new FTPClient()</span><br></pre></td></tr></table></figure>
<h5 id="连接-断连"><a href="#连接-断连" class="headerlink" title="连接/断连"></a>连接/断连</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ftp.connect(host, port);</span><br><span class="line">boolean ftp.isConnected()</span><br><span class="line">ftp.disconnect();</span><br></pre></td></tr></table></figure>
<h5 id="登录-注销"><a href="#登录-注销" class="headerlink" title="登录/注销"></a>登录/注销</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ftp.login(username, password);</span><br><span class="line">ftp.logout();</span><br></pre></td></tr></table></figure>
<h5 id="FTP状态码"><a href="#FTP状态码" class="headerlink" title="FTP状态码"></a>FTP状态码</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int replyCode = ftp.getReplyCode();</span><br><span class="line"></span><br><span class="line">boolean isLoginSuccess = FTPReply.isPositiveCompletion(replyCode)</span><br></pre></td></tr></table></figure>
<p>replyCode含义</p>
<table>
<thead>
<tr>
<th>代码</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>FTP服务器: 220</td>
<td>链接成功</td>
</tr>
<tr>
<td>FTP客户端: USER useway</td>
<td>输入用户名</td>
</tr>
<tr>
<td>FTP服务器: 331 Please specify the password.</td>
<td>请输入密码</td>
</tr>
<tr>
<td>FTP客户端: PASS !@#$%abce</td>
<td>输入密码</td>
</tr>
<tr>
<td>FTP服务器: 230 Login successful.</td>
<td>登录成功</td>
</tr>
<tr>
<td>FTP客户端: CWD /home/useway</td>
<td>切换目录</td>
</tr>
<tr>
<td>FTP服务器: 250 Directory successfully changed.</td>
<td>目录切换成功</td>
</tr>
<tr>
<td>FTP客户端: EPSV ALL</td>
<td>为EPSV被动链接方式</td>
</tr>
<tr>
<td>FTP服务器: 200 EPSV ALL ok.</td>
<td>OK</td>
</tr>
<tr>
<td>FTP客户端: EPSV</td>
<td>链接</td>
</tr>
<tr>
<td>FTP服务器: 229 Entering Extended Passive Mode(62501)</td>
<td>被动链接端口为62501</td>
</tr>
<tr>
<td>FTP客户端: LIST</td>
<td>执行LIST显示文件列表</td>
</tr>
<tr>
<td>FTP服务器: 150 Here comes the directory listing.</td>
<td>列表从62501端口被发送</td>
</tr>
<tr>
<td>FTP服务器: 226 Directory send OK.</td>
<td>发送完成</td>
</tr>
<tr>
<td>FTP客户端: QUIT</td>
<td>退出FTP</td>
</tr>
<tr>
<td>FTP服务器: 221 Goodbye.</td>
<td>再见</td>
</tr>
</tbody>
</table>
<h5 id="属性设置"><a href="#属性设置" class="headerlink" title="属性设置"></a>属性设置</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ftp.setConnectTimeout(60000);</span><br><span class="line">ftp.enterLocalPassiveMode();</span><br><span class="line">ftp.setFileType(FTP.BINARY_FILE_TYPE);</span><br><span class="line">ftp.setControlEncoding(&quot;UTF-8&quot;);</span><br><span class="line"></span><br><span class="line">// 设置linux环境</span><br><span class="line">FTPClientConfig conf = new FTPClientConfig(FTPClientConfig.SYST_UNIX);</span><br><span class="line">ftp.configure(conf);</span><br></pre></td></tr></table></figure>
<h5 id="目录-文件操作"><a href="#目录-文件操作" class="headerlink" title="目录/文件操作"></a>目录/文件操作</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切换到目录（是否成功）</span></span><br><span class="line"><span class="keyword">boolean</span> hasPath = ftp.changeWorkingDirectory(path);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建目录</span></span><br><span class="line">ftp.makeDirectory(<span class="string">"want"</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 根据文件名，找到文件流</span></span><br><span class="line">InputStream basicFile = ftp.retrieveFileStream(originFilename);</span><br><span class="line"><span class="keyword">boolean</span> isExisted = !(basicFile == <span class="keyword">null</span> || ftp.getReplyCode() == FTPReply.FILE_UNAVAILABLE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到目录下所有文件</span></span><br><span class="line">FTPFile[] ftpFiles = ftp.listFiles();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上传文件流</span></span><br><span class="line"><span class="keyword">boolean</span> isStoreFileSuccess = ftp.storeFile(uploadFilename, inputStream);</span><br></pre></td></tr></table></figure>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p>配置文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">performance.ftp.ip=192.168.145.128</span><br><span class="line">performance.ftp.port=21</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注意路径，不应包含ftp的根路径</span></span><br><span class="line">performance.ftp.path=share</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 匿名登录的用户名密码</span></span><br><span class="line">performance.ftp.username=anonymous</span><br><span class="line">performance.ftp.password=null</span><br><span class="line"></span><br><span class="line">performance.ftp.max-file-size=41943040</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ftp服务器地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;performance.ftp.ip&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String ftpHost;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;performance.ftp.port:21&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> ftpPort;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;performance.ftp.path&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String ftpPath;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;performance.ftp.username&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String ftpUsername;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;performance.ftp.password&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String ftpPassword;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 调用FTP上报文件流</span></span><br><span class="line">List&lt;InputStream&gt; csvFileStreamList = CsvUtil.createCsvFileStreamList();</span><br><span class="line">    </span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  commonFtpFileService.uploadFileList(csvFileStreamList, prefixFileName, ftpPath, ftpHost, ftpPort, ftpUsername, ftpPassword);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">  LOGGER.error(<span class="string">"上传文件失败"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.ftp.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonFtpFileServiceImpl</span> <span class="keyword">implements</span> <span class="title">ICommonFtpFileService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(CommonFtpFileServiceImpl<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FTPClient ftp = <span class="keyword">new</span> FTPClient();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String fileNameReset = <span class="string">"_R"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String fileNameSplit = <span class="string">"_P"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String fileNameEnd = <span class="string">"_END"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String fileNameExtension = <span class="string">".csv"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量上传文件到FTP服务器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStreamList 文件流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefixFileName  文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path            文件存放目录路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> host            服务器地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> port            端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username        用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password        密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uploadFileList</span><span class="params">(List&lt;InputStream&gt; inputStreamList, String prefixFileName, String path, String host, <span class="keyword">int</span> port, String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!login(host, port, username, password)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasPath(path)) &#123;</span><br><span class="line">            logout();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> count = inputStreamList.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; count; index++) &#123;</span><br><span class="line">            String noStr = createNo(index);</span><br><span class="line">            String fileName = prefixFileName + fileNameSplit + noStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (index == count - <span class="number">1</span>) &#123;</span><br><span class="line">                fileName = fileName + fileNameEnd;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fileName = fileName + fileNameExtension;</span><br><span class="line"></span><br><span class="line">            upload(inputStreamList.get(index), fileName);</span><br><span class="line">        &#125;</span><br><span class="line">        logout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录FTP服务器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> host     服务器地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> port     端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功返回true，否则返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">login</span><span class="params">(String host, <span class="keyword">int</span> port, String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 连接</span></span><br><span class="line">            ftp.connect(host, port);</span><br><span class="line">            <span class="comment">// 登录</span></span><br><span class="line">            ftp.login(username, password);</span><br><span class="line">            <span class="comment">// 登录返回值</span></span><br><span class="line">            <span class="keyword">int</span> replyCode = ftp.getReplyCode();</span><br><span class="line">            <span class="keyword">if</span> (FTPReply.isPositiveCompletion(replyCode)) &#123;</span><br><span class="line">                settingFtp();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ftp.disconnect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"连接FTP失败，请检查配置信息！"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件到FTP服务器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream 文件流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename    文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path        文件存放目录路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> host        服务器地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> port        端口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username    用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password    密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功返回true，否则返回false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">uploadFile</span><span class="params">(InputStream inputStream, String filename, String path, String host, <span class="keyword">int</span> port, String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!login(host, port, username, password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!hasPath(path)) &#123;</span><br><span class="line">            logout();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isUploadSuccess = upload(inputStream, filename);</span><br><span class="line">        logout();</span><br><span class="line">        <span class="keyword">return</span> isUploadSuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成序号</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> no 初始序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 格式化序号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">createNo</span><span class="params">(<span class="keyword">int</span> no)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> nextNo = no + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> nextNo &lt; <span class="number">10</span> ? <span class="string">"0"</span> + nextNo : String.valueOf(nextNo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传单个文件的逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream 文件流</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename    文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回true表示上传成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Boolean <span class="title">upload</span><span class="params">(InputStream inputStream, String filename)</span> </span>&#123;</span><br><span class="line">        String uploadFilename = filename;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uploadFilename = formatFileName(filename);</span><br><span class="line">            <span class="comment">// 上传文件流</span></span><br><span class="line">            <span class="keyword">boolean</span> isStoreFileSuccess = ftp.storeFile(uploadFilename, inputStream);</span><br><span class="line">            inputStream.close();</span><br><span class="line">            <span class="keyword">if</span> (isStoreFileSuccess) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">"FTP文件上传成功！文件名："</span> + uploadFilename);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"FTP文件上传失败！文件名："</span> + uploadFilename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置FTP属性等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">settingFtp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 连接超时毫秒</span></span><br><span class="line">            ftp.setConnectTimeout(<span class="number">60000</span>);</span><br><span class="line">            <span class="comment">// 启动FTP服务器被动模式（被动接受上传）</span></span><br><span class="line">            ftp.enterLocalPassiveMode();</span><br><span class="line">            <span class="comment">// 文件类型二进制流（默认ASCII）</span></span><br><span class="line">            ftp.setFileType(FTP.BINARY_FILE_TYPE);</span><br><span class="line">            <span class="comment">// 编码</span></span><br><span class="line">            ftp.setControlEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置linux环境</span></span><br><span class="line">            FTPClientConfig conf = <span class="keyword">new</span> FTPClientConfig(FTPClientConfig.SYST_UNIX);</span><br><span class="line">            ftp.configure(conf);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"设置FTP属性失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出FTP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 退出FTP </span></span><br><span class="line">            ftp.logout();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"关闭FTP服务器连接失败！"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ftp.isConnected()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ftp.disconnect();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"关闭连接失败！"</span>, ioe);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FTP路径是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path 路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true则存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Boolean <span class="title">hasPath</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 切换到目录下 </span></span><br><span class="line">            <span class="keyword">boolean</span> hasPath = ftp.changeWorkingDirectory(path);</span><br><span class="line">            <span class="keyword">if</span> (hasPath) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"访问FTP目录路径失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断路径下是否已存该文件名,如已存在,则启用文件名重传标识</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> originFilename 原始文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 带重传标志的文件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">formatFileName</span><span class="params">(String originFilename)</span> </span>&#123;</span><br><span class="line">        String fileName = originFilename;</span><br><span class="line"></span><br><span class="line">        String[] fileNameWithExtension = originFilename.split(<span class="string">"\\."</span>);</span><br><span class="line">        String originName = fileNameWithExtension[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">// 检索某个文件名是否存在</span></span><br><span class="line">            InputStream basicFile = ftp.retrieveFileStream(originFilename);</span><br><span class="line">            <span class="keyword">boolean</span> isExisted = !(basicFile == <span class="keyword">null</span> || ftp.getReplyCode() == FTPReply.FILE_UNAVAILABLE);</span><br><span class="line">            <span class="keyword">if</span> (isExisted) &#123;</span><br><span class="line">                <span class="comment">// 调用有返回流方法时，需要调用completePendingCommad</span></span><br><span class="line">                ftp.completePendingCommand();</span><br><span class="line">                List&lt;Integer&gt; reUploadNoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                <span class="comment">// 列举目录下文件名</span></span><br><span class="line">                FTPFile[] ftpFiles = ftp.listFiles();</span><br><span class="line">							</span><br><span class="line">                <span class="keyword">for</span> (FTPFile file : ftpFiles) &#123;</span><br><span class="line">                    String ftpName = file.getName().split(<span class="string">"\\."</span>)[<span class="number">0</span>];</span><br><span class="line">                    String[] ftpNameRList = ftpName.split(fileNameReset);</span><br><span class="line">                    String ftpNameBasic = ftpNameRList[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (originName.equals(ftpNameBasic)) &#123;</span><br><span class="line">                        reUploadNoList.add(ftpNameRList.length &gt; <span class="number">1</span> ? Integer.parseInt(ftpNameRList[<span class="number">1</span>]) : <span class="number">0</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Integer no = Collections.max(reUploadNoList);</span><br><span class="line">                String nextNoStr = createNo(no);</span><br><span class="line"></span><br><span class="line">                fileName = originName + fileNameReset + nextNoStr + fileNameExtension;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"获取FTP目录下文件列表失败"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>Java FTPClient实现文件上传下载</p>
<p><a href="https://blog.csdn.net/qq_36248731/article/details/91038014" target="_blank" rel="noopener">https://blog.csdn.net/qq_36248731/article/details/91038014</a></p>
<p>JAVA FTPClient FTP简单操作</p>
<p><a href="https://www.jianshu.com/p/453829127487" target="_blank" rel="noopener">https://www.jianshu.com/p/453829127487</a></p>
]]></content>
  </entry>
  <entry>
    <title>mysql</title>
    <url>/want/2020/05/31/mysql/</url>
    <content><![CDATA[<h3 id="mysql命令行工具"><a href="#mysql命令行工具" class="headerlink" title="mysql命令行工具"></a>mysql命令行工具</h3><p>查看mysql命令行工具的命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql --help</span><br></pre></td></tr></table></figure>
<h4 id="进入mysql工具"><a href="#进入mysql工具" class="headerlink" title="进入mysql工具"></a>进入mysql工具</h4><ul>
<li>-u 用户</li>
<li>-p 密码</li>
<li>-h 主机地址</li>
<li>-P 端口号</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 用户进入</span><br><span class="line">mysql -u root</span><br><span class="line"></span><br><span class="line"># 带密码用户进入</span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"># 带密码、主机名、端口号，用户进入</span><br><span class="line">mysql -u root -p -h 10.XX.XX.XX -P 3306</span><br></pre></td></tr></table></figure>
<h4 id="退出mysql工具"><a href="#退出mysql工具" class="headerlink" title="退出mysql工具"></a>退出mysql工具</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">quit</span><br><span class="line">或</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<h4 id="使用mysql工具"><a href="#使用mysql工具" class="headerlink" title="使用mysql工具"></a>使用mysql工具</h4><ol>
<li>命令在<code>mysql&gt;</code>后输入。</li>
<li>命令必须使用<code>;</code>或<code>\g</code>结束后，按enter才能执行。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show databases;</span><br><span class="line"></span><br><span class="line">show databases\g</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>命令帮助可以借助<code>help</code>或<code>\h</code>。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">help select;</span><br><span class="line"></span><br><span class="line">\h insert;</span><br></pre></td></tr></table></figure>
<h3 id="库表"><a href="#库表" class="headerlink" title="库表"></a>库表</h3><h4 id="库"><a href="#库" class="headerlink" title="库"></a>库</h4><ol>
<li>查看所有数据库列表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show databases;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用某一个数据库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use 数据库名;</span><br></pre></td></tr></table></figure>
<h4 id="表"><a href="#表" class="headerlink" title="表"></a>表</h4><ol>
<li>查看所有表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show tables;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>查看某个表的所有列字段</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show columns from 表名;</span><br><span class="line">或者</span><br><span class="line">describe 表名;</span><br></pre></td></tr></table></figure>
<h4 id="show命令"><a href="#show命令" class="headerlink" title="show命令"></a>show命令</h4><p>查看所有show命令。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">help show;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查看授权用户及安全权限</span><br><span class="line">show grants;</span><br><span class="line"></span><br><span class="line"># 查看创建数据库/表的sql语句</span><br><span class="line">show create database 库名;</span><br><span class="line">show create table 表名;</span><br><span class="line"></span><br><span class="line"># 查看服务器的错误/告警信息</span><br><span class="line">show errors;</span><br><span class="line">show warnings;</span><br></pre></td></tr></table></figure>
<h3 id="sql语句"><a href="#sql语句" class="headerlink" title="sql语句"></a>sql语句</h3><p>sql语句不区分大小写，但是为了便于阅读，可以采取如下方式：</p>
<blockquote>
<p>sql关键词大写，表名和列名小写。</p>
</blockquote>
<p>语句执行要求：</p>
<ol>
<li>mysql命令行工具，必须加上<code>;</code>或<code>\g</code>来结束语句。</li>
<li>其他客户端工具，单行语句大部分不需要<code>;</code>或<code>\g</code>，多条语句必须使用<code>;</code>或<code>\g</code>来分隔。</li>
</ol>
<h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><p>如果select没有明确指定排序，则返回结果顺序不定。</p>
<ol>
<li>默认会按照插入顺序。</li>
<li>但一旦进行了改删，顺序会受到mysql重用回收存储空间的影响，而变得混乱不定。</li>
</ol>
<p>除非需要所有列，最好不使用<code>通配符*</code>，会浪费性能。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 单字段查询</span><br><span class="line">select name from user;</span><br><span class="line"></span><br><span class="line"># 多字段查询</span><br><span class="line">select id, name from user;</span><br><span class="line"></span><br><span class="line"># 利用通配符，所有字段查询</span><br><span class="line">select * from user;</span><br></pre></td></tr></table></figure>
<h4 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h4><ol>
<li>用于查询结果去重</li>
<li>只能用于select语句</li>
<li>distinct<strong>只能放于所有字段的最前面</strong>。</li>
<li><strong>作用范围是distinct后的所有字段</strong>，而不只是紧跟着它的第一个字段。</li>
<li>对NULL是不进行过滤的，即返回的结果中是包含NULL值的</li>
<li><code>*</code>代表整列，使用distinct对<code>*</code>操作，即是对所有列组合进行去重。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 对name去重</span><br><span class="line">select distinct name from user;</span><br><span class="line"></span><br><span class="line"># 对age和name的组合去重</span><br><span class="line">select distinct age, name from user;</span><br><span class="line"></span><br><span class="line"># 对所有列的组合去重</span><br><span class="line">select distinct * from user;</span><br></pre></td></tr></table></figure>
<p>由于distinct的特性（只能返回他的目标字段，而无法返回其他字段），所以往往只用distinct来返回不重复字段的条数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select count(distinct name) from user;</span><br></pre></td></tr></table></figure>
<p>如果要查询不重复的记录，可以用group by，而且group by 比 distinct 性能上更快：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select id, name from user group by name;</span><br></pre></td></tr></table></figure>
<h4 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h4><ol>
<li>返回select结果的某几行数据。</li>
<li>LIMIT [offset], rows <ul>
<li>limit 开始位置索引, 返回的行数</li>
</ul>
</li>
<li>LIMIT rows OFFSET offset <ul>
<li>limit 返回的行数 offset 开始位置的索引</li>
</ul>
</li>
<li>offset索引从0开始</li>
<li>row行数-1表示直到结束为止，的所有行数</li>
<li>offset越大，性能越优</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 第六行（索引5）到15行，共10行</span><br><span class="line">SELECT * FROM table LIMIT 5,10</span><br><span class="line"></span><br><span class="line"># 第1行（索引0）到10行，共10行</span><br><span class="line">SELECT * FROM table LIMIT 10</span><br><span class="line"></span><br><span class="line"># 第11行到所有</span><br><span class="line">SELECT * FROM table LIMIT 10,-1</span><br></pre></td></tr></table></figure>
<h4 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h4><ol>
<li>order by后的排序列，不一定是显式检索列</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select age, name from user order by id;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>排序方向，默认升序</p>
<ul>
<li>DESC降序</li>
<li>ASC升序</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 先按id降序、再按age降序</span><br><span class="line"></span><br><span class="line">select age, name from user order by id desc, age desc;</span><br><span class="line"></span><br><span class="line"># 先按id降序、再按age升序</span><br><span class="line">select age, name from user order by id desc, age;</span><br><span class="line"></span><br><span class="line"># 先按id升序、再按age升序</span><br><span class="line">select age, name from user order by id, age;</span><br></pre></td></tr></table></figure>
<h5 id="order-by-limit查找最大-最小值"><a href="#order-by-limit查找最大-最小值" class="headerlink" title="order by + limit查找最大/最小值"></a>order by + limit查找最大/最小值</h5><ol>
<li>order by必须位于from之后</li>
<li>order by必须位于where之后</li>
<li>limit必须位于order by之后</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 查找最小值</span><br><span class="line">select age from user order by age limit 1;</span><br><span class="line"></span><br><span class="line"># 查找最大值</span><br><span class="line">select age from user order by age desc limit 1;</span><br></pre></td></tr></table></figure>
<h4 id="where"><a href="#where" class="headerlink" title="where"></a>where</h4><p>用于返回满足匹配条件的行。</p>
<ol>
<li>where匹配条件时，默认不区分字符串大小写。</li>
<li>where匹配条件时，字符串用<strong>单引号</strong>，  数值不用引号。</li>
<li>NULL（无值）可以用 IS NULL 匹配。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 默认不区分大小写。也可以搜索到Want、WANT...</span><br><span class="line">select name from user where name=&apos;want&apos;</span><br><span class="line"></span><br><span class="line"># between and </span><br><span class="line">select name, age from user where age between 5 and 10</span><br><span class="line"></span><br><span class="line"># 用于匹配null</span><br><span class="line">select name from user where name is null;</span><br></pre></td></tr></table></figure>
<h5 id="比较操作符"><a href="#比较操作符" class="headerlink" title="比较操作符"></a>比较操作符</h5><ol>
<li>=</li>
<li>&lt;&gt;</li>
<li>!=</li>
<li>&lt;</li>
<li>&lt;=</li>
<li>></li>
<li>>=</li>
<li>between and</li>
<li>is null</li>
</ol>
<h5 id="AND-OR"><a href="#AND-OR" class="headerlink" title="AND/OR"></a>AND/OR</h5><p>and和or操作符，都是where条件的子句。</p>
<ol>
<li>and 同时满足所有条件。</li>
<li><p>or 只需要满足其中一个条件即可。</p>
</li>
<li><p>and和or条件可以任意组合使用。</p>
</li>
<li>and的优先级最高。</li>
<li>为了避免逻辑混乱，使用<code>圆括号()</code>明确分组。</li>
</ol>
<p>and和or操作符，都是where条件的子句。</p>
<ol>
<li><p>and 同时满足所有条件。</p>
</li>
<li><p>or 只需要满足其中一个条件即可。</p>
</li>
</ol>
<ol start="3">
<li><p>and和or条件可以任意组合使用。</p>
</li>
<li><p>and的优先级最高。</p>
</li>
<li><p>为了避免逻辑混乱，使用<code>圆括号()</code>明确分组。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 因为and优先级最高，实际上两者等价</span><br><span class="line">select name, age from user where age = 23 or age = 24 and name = &apos;want&apos;</span><br><span class="line">select name, age from user where age = 23 or (age = 24 and name = &apos;want&apos;)</span><br><span class="line"></span><br><span class="line"># 使用()明确逻辑,消除歧义</span><br><span class="line">select name, age from user where (age = 23 or age = 24) and name = &apos;want&apos;</span><br></pre></td></tr></table></figure>
<h5 id="IN"><a href="#IN" class="headerlink" title="IN"></a>IN</h5><p>IN操作符是OR操作符的简写形式。</p>
<ol>
<li>in更清楚直观</li>
<li>in比or执行的更快</li>
<li>in最大的优点：<code>可以包含其他select语句</code>！</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select name, age from user where age in (23, 24, 18)</span><br><span class="line"></span><br><span class="line"># 等价于</span><br><span class="line">select name, age from user where age = 23 or age = 24 or age = 18</span><br></pre></td></tr></table></figure>
<h5 id="NOT"><a href="#NOT" class="headerlink" title="NOT"></a>NOT</h5><p>用于否定之后的条件。<br>与以下语句结合使用：</p>
<ol>
<li>IN</li>
<li>BETWEEN</li>
<li>EXISTS</li>
<li>LIKE</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select name, age from user where age not in (23, 24, 18)</span><br><span class="line"></span><br><span class="line">select name, age from user where age not BETWEEN 23 AND 24</span><br></pre></td></tr></table></figure>
<h5 id="LIKE"><a href="#LIKE" class="headerlink" title="LIKE"></a>LIKE</h5><p>like操作符，结合通配符，用来模糊匹配字符。<br>通配符：</p>
<ol>
<li>% 任何字符出现的任意次数【任意字符，0-n次】</li>
<li>_ 总是匹配一个字符</li>
<li>%不能匹配NULL</li>
</ol>
<p>大小写：</p>
<ol>
<li>默认不区分大小写</li>
</ol>
<p>性能建议：</p>
<ol>
<li>不要过度使用通配符。如果能用其他操作符达到目的，应该使用其他操作符。</li>
<li>把通配符放在开头处，搜索起来最慢！</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select name from user where name like &apos;want%&apos;</span><br><span class="line"></span><br><span class="line">select name from user where name like &apos;want_&apos;</span><br><span class="line"></span><br><span class="line">select name from user where name not like &apos;want_&apos;</span><br></pre></td></tr></table></figure>
<h5 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h5><p>LIKE只是正则表达式的子集。</p>
<h4 id="group-by"><a href="#group-by" class="headerlink" title="group by"></a>group by</h4><p>把MySQL升级到5.7或者更高的版本，一些以前看上去不会出错的group by 操作在这个版本以后就会出现语法报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">only_full_group_by</span><br></pre></td></tr></table></figure>
<p>在这个模式下，使用分组查询时，出现在select字段后面的字段，必须只能是group by后面的分组字段，或使用聚合函数包裹着的字段。</p>
<h4 id="case-when"><a href="#case-when" class="headerlink" title="case/when"></a>case/when</h4><h5 id="mysql-行变列"><a href="#mysql-行变列" class="headerlink" title="mysql 行变列"></a>mysql 行变列</h5><p>源数据<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+----+------+--------+-------+</span><br><span class="line">| id | name | clazz  | score |</span><br><span class="line">+----+------+--------+-------+</span><br><span class="line">|  1 | lux  | 数学   |    10 |</span><br><span class="line">|  2 | want | 数学   |    15 |</span><br><span class="line">|  3 | wei  | 数学   |    20 |</span><br><span class="line">|  4 | lux  | 语文   |    50 |</span><br><span class="line">|  5 | want | 语文   |    55 |</span><br><span class="line">|  6 | wei  | 语文   |    60 |</span><br><span class="line">|  7 | lux  | 英语   |    70 |</span><br><span class="line">|  8 | want | 英语   |    75 |</span><br><span class="line">|  9 | wei  | 英语   |    80 |</span><br><span class="line">+----+------+--------+-------+</span><br></pre></td></tr></table></figure></p>
<p>目标<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------+----------+</span><br><span class="line">| name | score    |</span><br><span class="line">+------+----------+</span><br><span class="line">| lux  | 10;50;70 |</span><br><span class="line">| want | 15;55;75 |</span><br><span class="line">| wei  | 20;60;80 |</span><br><span class="line">+------+----------+</span><br><span class="line">select name, group_concat(score Separator &apos;;&apos;) as score from grade group by name;</span><br></pre></td></tr></table></figure></p>
<p>目标<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------+----------------------------+</span><br><span class="line">| name | score                      |</span><br><span class="line">+------+----------------------------+</span><br><span class="line">| lux  | 数学10;语文50;英语70       |</span><br><span class="line">| want | 数学15;语文55;英语75       |</span><br><span class="line">| wei  | 数学20;语文60;英语80       |</span><br><span class="line">+------+----------------------------+</span><br><span class="line">select name, group_concat(concat(clazz,score) Separator &apos;;&apos;) as score from grade group by name;</span><br></pre></td></tr></table></figure></p>
<p>目标<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+------+------+---------+---------+</span><br><span class="line">| name | math | chinese | english |</span><br><span class="line">+------+------+---------+---------+</span><br><span class="line">| lux  |   10 |      50 |      70 |</span><br><span class="line">| want |   15 |      55 |      75 |</span><br><span class="line">| wei  |   20 |      60 |      80 |</span><br><span class="line">+------+------+---------+---------+</span><br><span class="line">select</span><br><span class="line">  name, </span><br><span class="line">  MAX(case clazz when &apos;数学&apos; then score else 0 end) as math,</span><br><span class="line">  MAX(case clazz when &apos;语文&apos; then score else 0 end) as chinese,</span><br><span class="line">  MAX(case clazz when &apos;英语&apos; then score else 0 end) as english</span><br><span class="line">from grade group by name;</span><br></pre></td></tr></table></figure></p>
<p>参考：</p>
<p><a href="https://www.cnblogs.com/small8/p/6211009.html" target="_blank" rel="noopener">https://www.cnblogs.com/small8/p/6211009.html</a></p>
<h4 id="判断字符串字段-是否包含某字符串"><a href="#判断字符串字段-是否包含某字符串" class="headerlink" title="判断字符串字段,是否包含某字符串"></a>判断字符串字段,是否包含某字符串</h4><p>方法一：like 模糊判断</p>
<figure class="highlight plain"><figcaption><span>* FROM 表名 WHERE 字段名 like "%字符%";```</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">方法二：find_in_set() 严格判断</span><br><span class="line"></span><br><span class="line">1. 利用mysql 字符串函数 find_in_set();</span><br><span class="line">2. find_in_set(str1,str2)函数是返回str2中str1所在的位置索引，不存在就返回0，str2必须以&quot;,&quot;分割开。</span><br><span class="line"></span><br><span class="line">```mysql</span><br><span class="line">SELECT * FROM users WHERE find_in_set(&apos;字符&apos;, 字段名)</span><br><span class="line">SELECT find_in_set(&apos;3&apos;,&apos;3,6,13,24,33,36&apos;)</span><br></pre></td></tr></table></figure>
<p>方法三：locate(字符,字段名) 模糊判断</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from 表名 where locate(字符,字段)</span><br><span class="line">select * from 表名 where position(字符 in 字段);</span><br><span class="line">update site set url =concat(&apos;http://&apos;,url) where locate(&apos;http://&apos;,url)=0</span><br></pre></td></tr></table></figure>
<p> 方法四：INSTR(字段,字符) 模糊判断</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from 表名 where INSTR(字段,字符)</span><br></pre></td></tr></table></figure>
<h4 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h4><p>DATE_FORMAT(date,format)　　日期格式化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT DATE_FORMAT(NOW(), &apos;%Y-%m-%d&apos;);</span><br></pre></td></tr></table></figure>
<p>STR_TO_DATE(str,format)　　字符串 ===》 日期</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select str_to_date(&apos;2016-01-02&apos;, &apos;%Y-%m-%d %H&apos;);</span><br></pre></td></tr></table></figure>
<p>UNIX_TIMESTAMP()　　其他数据 ===》时间戳</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select unix_timestamp(now());</span><br><span class="line">select unix_timestamp(&apos;2016-02-01&apos;);</span><br></pre></td></tr></table></figure>
<p>FROM_UNIXTIME(unix_timestamp,format)　　时间戳格式化</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 十三位时间戳转时间。</span></span><br><span class="line"><span class="keyword">SELECT</span> FROM_UNIXTIME(<span class="built_in">time</span>/<span class="number">1000</span>,<span class="string">'%Y-%m-%d %h:%i:%s'</span>)  <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 十位时间戳转时间。(%H)</span></span><br><span class="line"><span class="keyword">SELECT</span> FROM_UNIXTIME(<span class="built_in">time</span>,<span class="string">'%Y-%m-%d %h:%i:%s'</span>)  <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p>时间格式</p>
<table>
<thead>
<tr>
<th>毫秒</th>
<th>%f</th>
<th>毫秒数（000000…999999）</th>
</tr>
</thead>
<tbody>
<tr>
<td>秒</td>
<td>%S、%s</td>
<td>两位数字形式的秒（ 00,01, …, 59）</td>
</tr>
<tr>
<td>分</td>
<td>%I、%i</td>
<td>两位数字形式的分（ 00,01, …, 59）</td>
</tr>
<tr>
<td>小时</td>
<td>%H</td>
<td>24小时制，两位数形式小时（00,01, …,23）</td>
</tr>
<tr>
<td></td>
<td>%h</td>
<td>12小时制，两位数形式小时（00,01, …,12）</td>
</tr>
<tr>
<td></td>
<td>%k</td>
<td>24小时制，数形式小时（0,1, …,23）</td>
</tr>
<tr>
<td></td>
<td>%l</td>
<td>12小时制，数形式小时（0,1, …,12）</td>
</tr>
<tr>
<td></td>
<td>%T</td>
<td>24小时制，时间形式（HH:mm:ss）</td>
</tr>
<tr>
<td></td>
<td>%r</td>
<td>12小时制，时间形式（hh:mm:ss AM 或 PM）</td>
</tr>
<tr>
<td></td>
<td>%p</td>
<td>AM上午或PM下午</td>
</tr>
<tr>
<td>周</td>
<td>%W</td>
<td>一周中每一天的名称，周日到周六（Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday）</td>
</tr>
<tr>
<td></td>
<td>%a</td>
<td>一周中每一天的名称的缩写，周日到周六（Sun,Mon,Tue,Wed,Thu,Fri,Sat）</td>
</tr>
<tr>
<td></td>
<td>%w</td>
<td>以数字形式标识周（0=Sunday,1=Monday, …,6=Saturday）</td>
</tr>
<tr>
<td></td>
<td>%U</td>
<td>数字表示周数，星期天为周中第一天</td>
</tr>
<tr>
<td></td>
<td>%u</td>
<td>数字表示周数，星期一为周中第一天</td>
</tr>
<tr>
<td>天</td>
<td>%d</td>
<td>两位数字表示月中天数（01,02, …,31）</td>
</tr>
<tr>
<td></td>
<td>%e</td>
<td>数字表示月中天数（1,2, …,31）</td>
</tr>
<tr>
<td></td>
<td>%D</td>
<td>英文后缀表示月中天数（1st,2nd,3rd …）</td>
</tr>
<tr>
<td></td>
<td>%j</td>
<td>以三位数字表示年中天数（001,002, …,366）</td>
</tr>
<tr>
<td>月</td>
<td>%M</td>
<td>英文月名（January,February,March,April,May,June,July,August,September,October,November,December）</td>
</tr>
<tr>
<td></td>
<td>%b</td>
<td>英文缩写月名（Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec）</td>
</tr>
<tr>
<td></td>
<td>%m</td>
<td>两位数字表示月份（01,02, …,12）</td>
</tr>
<tr>
<td></td>
<td>%c</td>
<td>数字表示月份（1,2, …,12）</td>
</tr>
<tr>
<td>年</td>
<td>%Y</td>
<td>四位数字表示的年份（2015,2016…）</td>
</tr>
<tr>
<td></td>
<td>%y</td>
<td>两位数字表示的年份（15,16…）</td>
</tr>
<tr>
<td>文字输出</td>
<td>%文字</td>
<td>直接输出文字内容</td>
</tr>
</tbody>
</table>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create database grid;</span><br></pre></td></tr></table></figure>
<h4 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h4><table>
<thead>
<tr>
<th>java类</th>
<th></th>
<th>mysql数据库</th>
</tr>
</thead>
<tbody>
<tr>
<td>java.lang.Byte</td>
<td>byte</td>
<td>TINYINT</td>
</tr>
<tr>
<td>java.lang.Short</td>
<td>short</td>
<td>SMALLINT</td>
</tr>
<tr>
<td>java.lang.Integer</td>
<td>integer</td>
<td>INGEGER</td>
</tr>
<tr>
<td>java.lang.Long</td>
<td>long</td>
<td>BIGINT</td>
</tr>
<tr>
<td>java.lang.Float</td>
<td>float</td>
<td>FLOAT</td>
</tr>
<tr>
<td>java.lang.Double</td>
<td>double</td>
<td>DOUBLE</td>
</tr>
<tr>
<td>java.lang.BigDecimal</td>
<td>big_decimal</td>
<td>NUMERIC</td>
</tr>
<tr>
<td>java.lang.Boolean</td>
<td>boolean</td>
<td>BIT</td>
</tr>
<tr>
<td>java.lang.String</td>
<td>string</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>java.lang.Boolean</td>
<td>yes_no</td>
<td>CHAR(1)(‘Y’或’N’)</td>
</tr>
<tr>
<td>java.lang.Boolean</td>
<td>true_false</td>
<td>CHAR(1)(‘Y’或’N’)</td>
</tr>
<tr>
<td>java.uitl.Date / java.sql.Date</td>
<td>date</td>
<td>DATE</td>
</tr>
<tr>
<td>java.sql.Time</td>
<td>time</td>
<td>TIME</td>
</tr>
<tr>
<td>java.sql.Timestamp</td>
<td>timestamp</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>java.uitl.Calendar</td>
<td>celendar</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>java.uitl.Calendar</td>
<td>calendar</td>
<td>TIMESTAMP</td>
</tr>
<tr>
<td>java.io.Serializable</td>
<td>serializable</td>
<td>VARBINARY/BLOB</td>
</tr>
<tr>
<td>java.sql.Clob</td>
<td>clob</td>
<td>CLOB</td>
</tr>
<tr>
<td>java.sql.Blob</td>
<td>blob</td>
<td>BLOB</td>
</tr>
<tr>
<td>java.lang.Class</td>
<td>class</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>java.uitl.Locale</td>
<td>locale</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>java.uitl.TimeZone</td>
<td>timezone</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>java.uitl.Currency</td>
<td>currency</td>
<td>VARCHAR</td>
</tr>
</tbody>
</table>
<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建</span><br><span class="line">create table user</span><br><span class="line">(</span><br><span class="line">	id int AUTO_INCREMENT,</span><br><span class="line">	name varchar(50) not null,</span><br><span class="line">	age int default 0,</span><br><span class="line">	primary key (id)</span><br><span class="line">) engine=InnoDB;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">SHOW COLUMNS from user;</span><br></pre></td></tr></table></figure>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 省略列指定，表示全部列</span><br><span class="line">insert into user values(null, &apos;want&apos;, 23);</span><br><span class="line"></span><br><span class="line"># 显式指定列</span><br><span class="line">insert into user(name, age) values(&apos;yuni&apos;, 18);</span><br></pre></td></tr></table></figure>
<h3 id="alter"><a href="#alter" class="headerlink" title="alter"></a>alter</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 增加新列</span><br><span class="line">alter table user add column time Date;</span><br><span class="line"># 修改列</span><br><span class="line">alter table user modify column time bigint;</span><br></pre></td></tr></table></figure>
<h3 id="存储过程procedure"><a href="#存储过程procedure" class="headerlink" title="存储过程procedure"></a>存储过程procedure</h3><p>操作多条语句的完整过程。</p>
<h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE PROCEDURE handleage()</span><br><span class="line">BEGIN</span><br><span class="line">	select avg(age) as avgAge from user;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CALL handleage(@mymax, @mymin, @myavg)</span><br></pre></td></tr></table></figure>
<p>show character set;</p>
<p>show collation;</p>
<p>show variables like ‘character%’;</p>
<p>show variables like ‘collation%’</p>
<h3 id="通过-sql文件执行命令"><a href="#通过-sql文件执行命令" class="headerlink" title="通过.sql文件执行命令"></a>通过.sql文件执行命令</h3><p>方法1：source</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt;use mytable;</span><br><span class="line">mysql&gt;source ../testsql.sql;</span><br></pre></td></tr></table></figure>
<p>方法2: <code>&lt;</code> (小于号)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -u root -p &lt; ../testsql.sql</span><br></pre></td></tr></table></figure>
<h3 id="账号管理"><a href="#账号管理" class="headerlink" title="账号管理"></a>账号管理</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br><span class="line">select user from user;</span><br><span class="line"></span><br><span class="line"># 创建账号（带密码）</span><br><span class="line">create user test identified by &apos;test&apos;;</span><br><span class="line"></span><br><span class="line"># 创建账号（无密码）</span><br><span class="line">create user want;</span><br><span class="line"></span><br><span class="line"># 获取当前账号</span><br><span class="line">select user();</span><br><span class="line"></span><br><span class="line"># 重命名账号</span><br><span class="line">rename user want to wanted; </span><br><span class="line"></span><br><span class="line"># 修改密码</span><br><span class="line">[废弃]set password for test = Password(&apos;test123&apos;);</span><br><span class="line">[新版]alter user test identified by &apos;test123&apos;;</span><br><span class="line"></span><br><span class="line"># 修改当前用户的密码</span><br><span class="line">alter user user() identified by &apos;test&apos;;</span><br><span class="line"></span><br><span class="line">#删除账号</span><br><span class="line">drop user wanted;</span><br></pre></td></tr></table></figure>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="客户端连接MySQL报错-authentication-plugin-‘caching-sha2-password’-navicat"><a href="#客户端连接MySQL报错-authentication-plugin-‘caching-sha2-password’-navicat" class="headerlink" title="客户端连接MySQL报错- authentication plugin ‘caching_sha2_password’ -navicat"></a>客户端连接MySQL报错- authentication plugin ‘caching_sha2_password’ -navicat</h4><p>原因：</p>
<ul>
<li><p>mysql 8.0 版本默认使用 caching_sha2_password 身份验证机制</p>
</li>
<li><p>mysql 8.0以前版本使用 mysql_native_password</p>
</li>
<li><p>低版本升级到8.0 验证方式不变，新用户使用8.0验证方式改变，而客户端不支持新的加密方式</p>
</li>
</ul>
<p>解决方案：</p>
<ol>
<li>方法之一：修改用户的密码和加密方式</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED WITH mysql_native_password BY &apos;root&apos;;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>之前可能由于设置远程连接的问题而在mysql.user表中对root的Host列做了修改，要确定上面的 localhost 必须存在于该表中user为root的Host列中。</li>
<li>如上语句，只针对使用root用户在localhost下连接生效</li>
</ul>
<ol start="2">
<li>方法二：修改文件 /etc/my.cnf</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">default_authentication_plugin=mysql_native_password</span><br></pre></td></tr></table></figure>
<h4 id="IDEA中配置MySQL出现Server-returns-invalid-timezone问题"><a href="#IDEA中配置MySQL出现Server-returns-invalid-timezone问题" class="headerlink" title="IDEA中配置MySQL出现Server returns invalid timezone问题"></a>IDEA中配置MySQL出现Server returns invalid timezone问题</h4><p>原因：<br>首先，出现该问题的原因是MySQL驱动jar中的默认时区是UTC。</p>
<p>UTC代表的是全球标准时间 ，但是我们使用的时间是北京时区也就是东八区，领先UTC八个小时。</p>
<p>因为时区不一致，所以提示Server returns invalid timezone.</p>
<p>解决方案：</p>
<p> Go to ‘<strong>Advanced</strong>’ tab and set ‘<strong>serverTimezone</strong>’ property manually</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Asia/Shanghai</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>redis哨兵</title>
    <url>/want/2020/11/30/redis%E5%93%A8%E5%85%B5/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>哨兵</strong>：Sentinel，一个独立运行的进程，<strong>监控</strong>主从机器，在故障时<strong>自动转移</strong>。</p>
<p><strong>用途</strong>：让redis宕机后可以自动进行故障转移。用有一个或多个哨兵组成哨兵系统，来监视任意数量服务器（包括主机和主机下属的从机），并在被监视的主机故障下线时，自动将主机下的从机升级为主机。</p>
<h4 id="分类："><a href="#分类：" class="headerlink" title="分类："></a>分类：</h4><ol>
<li>单机哨兵</li>
<li>多哨兵</li>
</ol>
<p><strong>单哨兵工作过程：</strong></p>
<ol>
<li><p>哨兵发送命令给各个服务器</p>
</li>
<li><p>各个服务器响应并返回运行状态给哨兵</p>
</li>
<li><p>哨兵发现主机宕机，</p>
</li>
<li><ol>
<li>就自动将slave切换成master</li>
<li>通过发布订阅模式告知其他服务器，修改配置文件，切换主机。</li>
</ol>
</li>
</ol>
<p><strong>多哨兵模式：</strong></p>
<ul>
<li>使用多个哨兵监控服务器。</li>
<li>且各哨兵之间相互监控。</li>
<li>一般是3个及以上。</li>
</ul>
<p><strong>多哨兵工作、故障切换：</strong></p>
<ol>
<li>主服务器宕机，哨兵1先检测到，但系统并不会马上进行failover过程，这是因为仅仅是哨兵1主观的认为主服务器不可用，这个现象成为<strong>主观下线</strong>。</li>
<li>当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起<strong>，进行failover操作</strong>。</li>
<li>切换成功后，就会<strong>通过发布订阅模式</strong>，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。这样对于客户端而言，一切都是透明的。</li>
</ol>
<h3 id="哨兵结构"><a href="#哨兵结构" class="headerlink" title="哨兵结构"></a>哨兵结构</h3><p><img src="C:\Users\luxia\AppData\Roaming\Typora\typora-user-images\1606724867172.png" alt="1606724867172"></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>ip地址</th>
<th>端口</th>
</tr>
</thead>
<tbody>
<tr>
<td>redis服务器（主机）</td>
<td>A</td>
<td>p1</td>
</tr>
<tr>
<td>redis服务器（备机）</td>
<td>B</td>
<td>p1</td>
</tr>
<tr>
<td>哨兵1</td>
<td>A</td>
<td>p2</td>
</tr>
<tr>
<td>哨兵2</td>
<td>B</td>
<td>p2</td>
</tr>
</tbody>
</table>
<p>首先，建立主备关系，确认从机隶属的主机。</p>
<p>其次，建立哨兵，确认哨兵监听的主机。</p>
<p>这样，当哨兵监听的主机下线时，会自动获取主机下的从机作为主机。</p>
<h3 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h3><p>修改redis.conf文件。</p>
<h4 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">开启保护模式</span></span><br><span class="line">protected-mode yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以守护线程的形式运行，默认no</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口，默认6379</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line">masterauth 123456</span><br><span class="line"><span class="meta">#</span><span class="bash"> 访问主机redis需要的密码</span></span><br><span class="line">requirepass 123456</span><br><span class="line"></span><br><span class="line">slave-read-only yes # 设置读写分离，备机只负责读</span><br><span class="line">slave-priority 100</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志输出文件</span></span><br><span class="line">logfile "/app/redis/log/redis.log"</span><br></pre></td></tr></table></figure>
<h4 id="从机"><a href="#从机" class="headerlink" title="从机"></a>从机</h4><p>从机，比主机，多一个slaveof的配置和密码。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">protected-mode yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否以守护线程的形式运行，默认是no</span></span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 端口，默认6379</span></span><br><span class="line">port 6379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志输出文件</span></span><br><span class="line">logfile "/app/redis/log/redis.log"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机redis密码</span></span><br><span class="line">masterauth 123456</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对应的主机，5.0版本升级成relicaof</span></span><br><span class="line">slave-read-only yes # 设置读写分离，备机只负责读</span><br><span class="line">slave-priority 90</span><br><span class="line">slaveof 10.14.6.70 6379</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查看redis版本</p>
<p>./redis-server –version</p>
<p>./redis-server -v</p>
<p> ./redis-cli –version</p>
<p>./redis-cli -v</p>
</blockquote>
<h3 id="配置哨兵"><a href="#配置哨兵" class="headerlink" title="配置哨兵"></a>配置哨兵</h3><p><code>cd /app/redis/bin</code>，发现有可执行文件 <code>redis-sentinel</code>。</p>
<p><code>cd /app/redis/conf</code>，手动增加并修改<code>sentinel.conf</code>文件。</p>
<p>多个哨兵分布在不同服务器上，sentinel.conf 相同。（也可多个哨兵分布在同一个服务器，端口不同）</p>
<blockquote>
<p>复制到其他服务器 scp sentinel.conf 用户名@ip地址:/app/redis/conf/sentinel.conf</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 和redis保持一致</span></span><br><span class="line">protected-mode yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵端口号，默认26379</span></span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 【被哨兵监控的主机】，不能写localhost或127.0.0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel monitor：代表监控</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mymaster：代表服务器的默认名称，可以自定义，此处为apnmaster</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.14.6.70：代表监控的主服务器IP地址，6379代表端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1：代表只有1个或1个以上的哨兵认为主机故障时，才会进行故障转移（failover）操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span></span><br><span class="line">sentinel monitor apnmaster 10.14.6.70 6379 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志</span></span><br><span class="line">logfile "/app/redis/log/sentinel.log"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否可达的轮询间隔，30000毫秒没收到回复则认为故障，默认30秒</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置连接主机和备机的密码，主机和备机的密码要相同，因为哨兵不能分别为master和slave设置密码。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel author-pass：代表设置密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mymaster：主从机名称</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 123456：主从机密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span></span><br><span class="line">sentinel auth-pass apnmaster 123456</span><br></pre></td></tr></table></figure>
<h3 id="启动并验证"><a href="#启动并验证" class="headerlink" title="启动并验证"></a>启动并验证</h3><p>配置和启动时候，一定要注意用户是否有权限启动，比如<code>chmod 775 bin</code>  /  <code>chown want.want dump.rdb</code>。</p>
<p>如果启动不成功，需要查看日志原因 <code>tailf -n 100 /app/redis/log/redis.log</code>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /app/redis/bin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Redis服务器进程</span></span><br><span class="line">./redis-server ../conf/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动哨兵进程</span></span><br><span class="line">./redis-sentinel ../conf/sentinel.conf  --sentinel</span><br></pre></td></tr></table></figure>
<h4 id="主从验证"><a href="#主从验证" class="headerlink" title="主从验证"></a>主从验证</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./redis-cli -h localhost -p 6379 -a 密码</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机redis</span></span><br><span class="line">localhost:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1 #有一个备机</span><br><span class="line">slave0:ip=10.14.6.69,port=6379,state=online,offset=6569974,lag=0</span><br><span class="line">master_repl_offset:6569974</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:5521399</span><br><span class="line">repl_backlog_histlen:1048576</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从机redis</span></span><br><span class="line">localhost:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave # 角色是备机</span><br><span class="line">master_host:10.14.6.70 #主机ip</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:6</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:6570197</span><br><span class="line">slave_priority:90</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:0</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:17</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>
<h4 id="主从恢复"><a href="#主从恢复" class="headerlink" title="主从恢复"></a>主从恢复</h4><p>SLAVEOF，用于在 Redis 运行时，动态地修改复制(replication)功能的行为。</p>
<ol>
<li>SLAVEOF host port :  将当前服务器（无论从、主），变为指定服务器host:port的从机。<ul>
<li>如果当前机器本是A主机的从机，那会变成指定的host:port主机的从机。当前机器【<strong>会丢弃</strong>】从A同步的数据集，全新同步新主机的数据。</li>
<li>如果当前机器本是主机，那会变成指定的host:port主机的从机。当前机器【<strong>会丢弃</strong>】原来的数据集，全新同步新主机的数据。</li>
</ul>
</li>
<li>SLAVEOF NO ONE：将从机变为主机，且【<strong>不丢弃</strong>】原来同步的数据集。【故而主机故障时，从机变为主机，数据不丢失，实现了无间断运行】</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 当Redis运行时，突然主机故障，可以使用`SLAVEOF`命令，手动重设主备关系（而不需要重启redis）。</span></span><br><span class="line">./redis-cli -h localhost -p 6379 -a 密码</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">首先，设置为主机：</span></span><br><span class="line">localhost:6379&gt;SLAVEOF NO ONE</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">其次，给备机重新指定主机：</span></span><br><span class="line">localhost:6379&gt;SLAVEOF 10.14.6.70 6379</span><br></pre></td></tr></table></figure>
<h4 id="读写分离验证"><a href="#读写分离验证" class="headerlink" title="读写分离验证"></a>读写分离验证</h4><p>仅主机能写入，但都能读到</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看当前所有key</span></span><br><span class="line">localhost:6379&gt; keys *</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机redis写</span></span><br><span class="line">localhost:6379&gt; set mytest a</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机redis读</span></span><br><span class="line">localhost:6379&gt; get mytest</span><br><span class="line">"a"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从机redis写（不可写）</span></span><br><span class="line">localhost:6379&gt; set mytest a</span><br><span class="line">(error) READONLY You can't write against a read only slave.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从机redis读</span></span><br><span class="line">localhost:6379&gt; get mytest</span><br><span class="line">"a"</span><br></pre></td></tr></table></figure>
<h4 id="哨兵验证"><a href="#哨兵验证" class="headerlink" title="哨兵验证"></a>哨兵验证</h4><p>当主机A故障，从机B成为主机，此时<strong>主机A又恢复了</strong>，B仍然是主机，而不被A抢回。</p>
<h5 id="哨兵信息查看"><a href="#哨兵信息查看" class="headerlink" title="哨兵信息查看"></a>哨兵信息查看</h5><p>哨兵节点本质上是一个特殊的Redis节点，可以通过redis-cli查询相关信息。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ./redis-cli -h 127.0.0.1 -p 26379 info Sentinel</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sentinel</span></span><br><span class="line">sentinel_masters:1</span><br><span class="line">sentinel_tilt:0</span><br><span class="line">sentinel_running_scripts:0</span><br><span class="line">sentinel_scripts_queue_length:0</span><br><span class="line">sentinel_simulate_failure_flags:0</span><br><span class="line">master0:name=apnmaster,status=ok,address=10.14.6.70:6379,slaves=1,sentinels=2</span><br></pre></td></tr></table></figure>
<h5 id="验证哨兵自动恢复"><a href="#验证哨兵自动恢复" class="headerlink" title="验证哨兵自动恢复"></a>验证哨兵自动恢复</h5><ol>
<li>启动所有redis<br>启动所有哨兵</li>
<li>查看哨兵日志<br>查看主机/从机的状态 info replication</li>
<li>kill -9 主机进程ID</li>
<li>查看哨兵日志<br>查看主机/从机的状态 info replication，发现重新选举了主机。</li>
</ol>
<h5 id="哨兵日志"><a href="#哨兵日志" class="headerlink" title="哨兵日志"></a>哨兵日志</h5><p>跟踪日志： tailf  -n 100 /app/redis/log</p>
<p>日志内容：</p>
<ol>
<li>sdown：主观宕机，一个哨兵，ping一个主机超时了，这个哨兵自己就主观认为宕机了。</li>
<li>odown：客观宕机，一个哨兵在一定时间内，收到了满足一定数量的哨兵的消息，大家都觉得主机宕机了。</li>
<li>new-epoch: 标注版本号</li>
</ol>
<hr>
<ol>
<li>try-failover：达到故障转移条件，发起转移，开始等待其他哨兵的选举（只有发起哨兵有这个）</li>
<li>vote-for-leader： 所有哨兵投票</li>
<li>selected-slave：选出一个备机当新主机</li>
<li>switch-master apnmaster：进行身份切换</li>
<li>convert-to-slave slave：进行身份切换</li>
<li>failover-end：故障转移完成</li>
</ol>
<h3 id="spring-boot中使用哨兵模式"><a href="#spring-boot中使用哨兵模式" class="headerlink" title="spring boot中使用哨兵模式"></a>spring boot中使用哨兵模式</h3><h4 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="原理性程序"><a href="#原理性程序" class="headerlink" title="原理性程序"></a>原理性程序</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSentinel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建连接池</span></span><br><span class="line">  JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">  jedisPoolConfig.setMaxTotal(<span class="number">10</span>);</span><br><span class="line">  jedisPoolConfig.setMaxIdle(<span class="number">5</span>);</span><br><span class="line">  jedisPoolConfig.setMinIdle(<span class="number">5</span>);</span><br><span class="line">                                                                                               <span class="comment">// 哨兵模式,指定哨兵列表的ip:port</span></span><br><span class="line">	JedisSentinelPool pool = <span class="keyword">new</span> JedisSentinelPool(<span class="string">"apnmaster"</span>, <span class="keyword">new</span> HashSet&lt;&gt;(Arrays.asList(<span class="string">"10.14.6.70:26379"</span>, <span class="string">"10.14.6.69:26379"</span>)), jedisPoolConfig, <span class="number">60000</span>, <span class="string">"123456"</span>);</span><br><span class="line">  <span class="comment">// 获取客户端</span></span><br><span class="line">  Jedis jedis = pool.getResource();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行两个命令</span></span><br><span class="line">  jedis.set(<span class="string">"testKey"</span>, <span class="string">"testValue"</span>);</span><br><span class="line">  String value = jedis.get(<span class="string">"testKey"</span>);</span><br><span class="line">  System.out.println(value);</span><br><span class="line">        </span><br><span class="line">---------------------------------------------</span><br><span class="line">  <span class="comment">// 非哨兵模式,指定redis的ip:port</span></span><br><span class="line">  JedisPool jedisPool = <span class="keyword">new</span> JedisPool(jedisPoolConfig, <span class="string">"10.14.6.70"</span>, <span class="number">6379</span>, <span class="number">30000</span>, <span class="string">"ShLsEs3j"</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">  <span class="comment">// 获取客户端</span></span><br><span class="line">  Jedis jedis1 = jedisPool.getResource();</span><br><span class="line">  jedis1.set(<span class="string">"testKey1"</span>, <span class="string">"testValue1"</span>);</span><br><span class="line">  String value1 = jedis.get(<span class="string">"testKey1"</span>);</span><br><span class="line">  System.out.println(value1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="springboot调用"><a href="#springboot调用" class="headerlink" title="springboot调用"></a>springboot调用</h4><h5 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h5><p>增加<code>spring.redis.sentinel</code>相关配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#spring.redis.host=10.14.6.121 # 单机模式才需要</span><br><span class="line">#spring.redis.port=6379 # 单机模式才需要</span><br><span class="line">#redis.cache.host=redis://:abc@10.14.6.121:6379/1 # 单机模式才需要</span><br><span class="line"></span><br><span class="line">#注意不要使用springboot的ENC加密</span><br><span class="line">spring.redis.password=123456</span><br><span class="line">spring.redis.pool.max-active=100</span><br><span class="line">spring.redis.database=0</span><br><span class="line"></span><br><span class="line">#------redis哨兵模式------------</span><br><span class="line"># 哨兵监听的主机别名</span><br><span class="line">spring.redis.sentinel.master=apnmaster</span><br><span class="line"># 哨兵的部署节点</span><br><span class="line">spring.redis.sentinel.nodes=10.14.6.70:26379,10.14.6.69:26379</span><br></pre></td></tr></table></figure>
<h5 id="方式1：springboot-java-程序"><a href="#方式1：springboot-java-程序" class="headerlink" title="方式1：springboot java 程序"></a>方式1：springboot java 程序</h5><h6 id="读取application-properties"><a href="#读取application-properties" class="headerlink" title="读取application.properties"></a>读取application.properties</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"redis"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisClientProperties</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> database = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">private</span> String host = <span class="string">"localhost"</span>;</span><br><span class="line">  <span class="keyword">private</span> String password;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">6379</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> timeout = Protocol.DEFAULT_TIMEOUT;</span><br><span class="line">  <span class="keyword">private</span> Pool pool;</span><br><span class="line">  <span class="keyword">private</span> Sentinel sentinel;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Pool</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> maxIdle = <span class="number">8</span>;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> minIdle = <span class="number">0</span>;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> maxActive = <span class="number">40</span>;</span><br><span class="line">  	<span class="keyword">private</span> <span class="keyword">int</span> maxWait = <span class="number">5000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sentinel</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">private</span> String master;</span><br><span class="line">  	<span class="keyword">private</span> String nodes;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="程序调用"><a href="#程序调用" class="headerlink" title="程序调用"></a>程序调用</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisClientAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisClientProperties properties;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 可以把jedisPool放到RedisCache中，这样就可以全局调用redisCache了</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"redisCache"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCache <span class="title">RedisCache</span><span class="params">(@Qualifier(<span class="string">"jedisPool"</span>)</span> <span class="keyword">final</span> Pool&lt;Jedis&gt; jedisPool) </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> RedisCache cache = <span class="keyword">new</span> RedisCache();</span><br><span class="line">        cache.setJedisPool(jedisPool);</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">// 根据conf参数进行模式选择</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"jedisPool"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Pool&lt;Jedis&gt; <span class="title">JedisPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Sentinel sentinel = properties.getSentinel();</span><br><span class="line">        <span class="keyword">if</span> (sentinel != <span class="keyword">null</span> &amp;&amp; sentinel.getMaster() != <span class="keyword">null</span> &amp;&amp; sentinel.getNodes() != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> createRedisSentinelPool();<span class="comment">//2.哨兵模式调用</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> createRedisPool();<span class="comment">//3.非哨兵调用</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.非哨兵调用   </span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pool&lt;Jedis&gt; <span class="title">createRedisPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisPool(jedisPoolConfig(), properties.getHost(), properties.getPort(), properties.getTimeout(),properties.getPassword(), properties.getDatabase());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.哨兵模式调用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Pool&lt;Jedis&gt; <span class="title">createRedisSentinelPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Sentinel sentinel = properties.getSentinel();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String master = sentinel.getMaster();</span><br><span class="line">        <span class="keyword">final</span> String nodes = sentinel.getNodes();</span><br><span class="line">        <span class="keyword">final</span> String[] nodeArray = nodes.split(<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Set&lt;String&gt; sentinels = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String node : nodeArray) &#123;</span><br><span class="line">            sentinels.add(node.trim());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisSentinelPool(master, sentinels, jedisPoolConfig(), properties.getTimeout(),properties.getPassword(), properties.getDatabase());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.连接池</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JedisPoolConfig <span class="title">jedisPoolConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        <span class="keyword">final</span> RedisClientProperties.Pool props = <span class="keyword">this</span>.properties.getPool() != <span class="keyword">null</span> ? <span class="keyword">this</span>.properties.getPool() : <span class="keyword">new</span> RedisClientProperties.Pool();</span><br><span class="line">        config.setMaxTotal(props.getMaxActive());</span><br><span class="line">        config.setMaxIdle(props.getMaxIdle());</span><br><span class="line">        config.setMinIdle(props.getMinIdle());</span><br><span class="line">        config.setMaxWaitMillis(props.getMaxWait());</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="方式2：springboot-xml程序"><a href="#方式2：springboot-xml程序" class="headerlink" title="方式2：springboot xml程序"></a>方式2：springboot xml程序</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pool注册到代码中使用，RedisCache参见下文 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisCache"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">"RedisCache"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jedisPool"</span> <span class="attr">ref</span>=<span class="string">"jedisSentinelPool"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 哨兵模式配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisSentinelPool"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisSentinelPool"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"$&#123;spring.redis.sentinel.master&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">value</span>=<span class="string">"#&#123;'$&#123;spring.redis.sentinel.nodes&#125;'.split(',')&#125;"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"$&#123;spring.redis.password&#125;"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 连接池 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPoolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxTotal:200&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxIdle:10&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.timeBetweenEvictionRunsMillis:30000&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.minEvictableIdleTimeMillis:1800000&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"softMinEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.softMinEvictableIdleTimeMillis:1800000&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.maxWaitMillis:1500&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.testOnBorrow:true&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testWhileIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.testWhileIdle:true&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnReturn"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.testOnReturn:false&#125;"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"blockWhenExhausted"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.pool.blockWhenExhausted:false&#125;"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--------- 非哨兵模式配置 ---------&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisURI"</span> <span class="attr">class</span>=<span class="string">"java.net.URI"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.cache.host&#125;"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisPool"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPool"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"jedisPoolConfig"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">ref</span>=<span class="string">"jedisURI"</span> <span class="attr">type</span>=<span class="string">"java.net.URI"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"2"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.client.timeout:2000&#125;"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"3"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.client.timeout:2000&#125;"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisCache redisCache;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Long incrValue = redisCache.incr(redisKey); <span class="comment">// 使用举例</span></span><br></pre></td></tr></table></figure>
<h5 id="RedisCache封装常见redis操作"><a href="#RedisCache封装常见redis操作" class="headerlink" title="RedisCache封装常见redis操作"></a>RedisCache封装常见redis操作</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICache</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">get</span><span class="params">(String key)</span></span>;</span><br><span class="line">    &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getList</span><span class="params">(String key, Class&lt;T&gt; clazz)</span></span>;</span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(String key, Class&lt;T&gt; clazz)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">set</span><span class="params">(String key, String value)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">set</span><span class="params">(String key, Object object)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">set</span><span class="params">(String key, String value, <span class="keyword">int</span> seconds)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">set</span><span class="params">(String key, Object object, <span class="keyword">int</span> seconds)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(String key)</span></span>;</span><br><span class="line">    <span class="function">Long <span class="title">ttl</span><span class="params">(String key)</span></span>;</span><br><span class="line">    <span class="function">Long <span class="title">incr</span><span class="params">(String key)</span></span>;</span><br><span class="line">    <span class="function">Long <span class="title">incr</span><span class="params">(String key, <span class="keyword">long</span> start)</span></span>;</span><br><span class="line">    <span class="function">Long <span class="title">expireAt</span><span class="params">(String key, <span class="keyword">long</span> unixTime)</span></span>;</span><br><span class="line">    <span class="function">Long <span class="title">expire</span><span class="params">(String key, <span class="keyword">int</span> seconds)</span></span>;</span><br><span class="line">    <span class="function">Boolean <span class="title">exists</span><span class="params">(String key)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCache</span> <span class="keyword">implements</span> <span class="title">ICache</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Pool&lt;Jedis&gt; jedisPool;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Jedis <span class="title">getResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJedisPool</span><span class="params">(<span class="keyword">final</span> Pool&lt;Jedis&gt; jedisPool)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jedisPool = jedisPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.get(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">getList</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">final</span> String value = jedis.get(key);</span><br><span class="line">            <span class="keyword">return</span> JsonUtil.toList(value, clazz);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">final</span> String value = jedis.get(key);</span><br><span class="line">            <span class="keyword">return</span> JsonUtil.toBean(value, clazz);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">set</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.set(key, value);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">set</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String value = JsonUtil.toJson(object);</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.set(key, value);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">set</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> String value, <span class="keyword">final</span> <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.setex(key, seconds, value);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">incr</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.incr(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">incr</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> start)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.incrBy(key, start);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">exists</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.exists(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">expireAt</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> unixTime)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.expireAt(key, unixTime);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">expire</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.expire(key, seconds);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">set</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> Object object, <span class="keyword">final</span> <span class="keyword">int</span> seconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String value = JsonUtil.toJson(object);</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.setex(key, seconds, value);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            jedis.del(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">ttl</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.ttl(key);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://www.cnblogs.com/guolianyu/p/10249687.html" target="_blank" rel="noopener">https://www.cnblogs.com/guolianyu/p/10249687.html</a></p>
]]></content>
  </entry>
  <entry>
    <title>布局</title>
    <url>/want/2018/10/18/%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p><strong>flex</strong>:  一维布局， 一次只能处理一个维度上的元素布局，一行或者一列。<br><strong>grid</strong>：二维布局， 同时处理行和列上的布局，跨行跨列。</p>
<h3 id="Grid"><a href="#Grid" class="headerlink" title="Grid"></a>Grid</h3><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p>实现如下布局：<br><img src="/want/2018/10/18/布局/grid.png" title="grid布局"></p>
<p>代码：<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrapper"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"large"</span>&gt;</span>海瑞<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"middle"</span>&gt;</span>徐阶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"middle"</span>&gt;</span>高拱<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"large"</span>&gt;</span>嘉靖<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"middle"</span>&gt;</span>张居中<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"middle"</span>&gt;</span>裕王<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">	<span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="attribute">display</span>: grid;</span><br><span class="line">	<span class="attribute">grid-gap</span>: <span class="number">1rem</span>;</span><br><span class="line">	<span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(<span class="number">4</span>, calc((<span class="number">100%</span> / <span class="number">4</span>) - (<span class="number">3</span> / <span class="number">4</span>) * <span class="number">1rem</span>));</span><br><span class="line">	<span class="attribute">grid-template-rows</span>: <span class="built_in">repeat</span>(<span class="number">2</span>, calc((<span class="number">100%</span> / <span class="number">2</span>) - (<span class="number">1rem</span> / <span class="number">2</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.large</span> &#123;</span><br><span class="line">	<span class="attribute">grid-row</span>: span <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.middle</span> &#123;</span><br><span class="line">	<span class="attribute">grid-row</span>: span <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.wrapper</span> &gt; <span class="selector-tag">div</span> &#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="number">#f1f1f1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="网格容器Grid-Container"><a href="#网格容器Grid-Container" class="headerlink" title="网格容器Grid Container"></a>网格容器Grid Container</h4><h5 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">display: grid | inline-grid;</span><br></pre></td></tr></table></figure>
<h5 id="行列模板"><a href="#行列模板" class="headerlink" title="行列模板"></a>行列模板</h5><p><code>track-size</code>:   a length, a percentage, or a fraction of the free space in the grid (the <code>fr</code> unit)<br><code>line-name</code>: 网格线名称<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">grid-template-rows: &lt;track-size&gt; ... | &lt;line-name&gt; &lt;track-size&gt; ...;</span><br><span class="line">grid-template-columns: &lt;track-size&gt; ... | &lt;line-name&gt; &lt;track-size&gt; ...;</span><br></pre></td></tr></table></figure></p>
<h5 id="区块模板-area"><a href="#区块模板-area" class="headerlink" title="区块模板 area"></a>区块模板 area</h5><p>每个区块是一个网格组合。用每个区块占领grid-template-rows/columns定义的网格位置 。<br>其中，区块（<strong>area</strong>）和网格线（<strong>line</strong>,  eg. row1-start）分别代表两种不同的维度。<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 调用区块名称， 其中 . 或 none 表示空位 */</span></span><br><span class="line"><span class="selector-tag">grid-template-areas</span>: </span><br><span class="line">    "&lt;grid-area-name&gt; | . | none | ..."</span><br><span class="line">    "..."</span><br><span class="line">    "...";</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 为每个区块定义名称 */</span></span><br><span class="line"><span class="selector-tag">grid-area</span>: "&lt;<span class="selector-tag">grid-area-name</span>&gt;"</span><br></pre></td></tr></table></figure></p>
<h5 id="隐式（默认）行列"><a href="#隐式（默认）行列" class="headerlink" title="隐式（默认）行列"></a>隐式（默认）行列</h5><p>当某个网格项，没有显式定义行列（属于显式定义之外的超出项），但也想设置<strong>默认网格项</strong>的行列值。<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-auto-columns</span>: &lt;<span class="selector-tag">track-size</span>&gt; ...;</span><br><span class="line"><span class="selector-tag">grid-auto-rows</span>: &lt;<span class="selector-tag">track-size</span>&gt; ...;</span><br></pre></td></tr></table></figure></p>
<h5 id="流排列"><a href="#流排列" class="headerlink" title="流排列"></a>流排列</h5><p>若没有显式指定网格项的排列方式，可以指定默认<strong>流向</strong>。（这个效果跟flex很像了）。</p>
<ul>
<li>row：默认行流向。自动换行。</li>
<li>column：默认列流向。自动换列。</li>
<li>dense：【不推荐】后面的网格项 往前挤，占领前面的空位</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">grid-auto-flow: row | column | row dense | column dense</span><br></pre></td></tr></table></figure>
<h5 id="模板简写"><a href="#模板简写" class="headerlink" title="模板简写"></a>模板简写</h5><h6 id="grid-template"><a href="#grid-template" class="headerlink" title="grid-template"></a>grid-template</h6><p><code>grid-template</code>是 <code>grid-template-rows</code>, <code>grid-template-columns</code>,  <code>grid-template-areas</code> 的简写形式。</p>
<p>由于 <code>grid-template</code>  不能设置隐式的grid属性(<code>grid-auto-columns</code>, <code>grid-auto-rows</code>, and <code>grid-auto-flow</code>)，因此推荐使用grid-*属性替代 <code>grid-template</code>  。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">grid-template: none | &lt;grid-template-rows&gt; / &lt;grid-template-columns&gt;; /* 先行/后列 */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">grid-template</span>:</span><br><span class="line">    <span class="selector-attr">[row1-start]</span> "<span class="selector-tag">header</span> <span class="selector-tag">header</span> <span class="selector-tag">header</span>" 25<span class="selector-tag">px</span> <span class="selector-attr">[row1-end]</span></span><br><span class="line">    <span class="selector-attr">[row2-start]</span> "<span class="selector-tag">footer</span> <span class="selector-tag">footer</span> <span class="selector-tag">footer</span>" 25<span class="selector-tag">px</span> <span class="selector-attr">[row2-end]</span></span><br><span class="line">    / auto 50px auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 与下述等价，行列模板与区块模板分开处理即可 */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">grid-template-rows</span>: <span class="selector-attr">[row1-start]</span> 25<span class="selector-tag">px</span> <span class="selector-attr">[row1-end row2-start]</span> 25<span class="selector-tag">px</span> <span class="selector-attr">[row2-end]</span>;</span><br><span class="line"><span class="selector-tag">grid-template-columns</span>: <span class="selector-tag">auto</span> 50<span class="selector-tag">px</span> <span class="selector-tag">auto</span>;</span><br><span class="line"><span class="selector-tag">grid-template-areas</span>: </span><br><span class="line">    "<span class="selector-tag">header</span> <span class="selector-tag">header</span> <span class="selector-tag">header</span>" </span><br><span class="line">    "<span class="selector-tag">footer</span> <span class="selector-tag">footer</span> <span class="selector-tag">footer</span>";</span><br></pre></td></tr></table></figure>
<h6 id="grid"><a href="#grid" class="headerlink" title="grid"></a>grid</h6><p><code>grid</code>是 <code>grid-template-rows</code>, <code>grid-template-columns</code>,  <code>grid-template-areas</code> , 及 <code>grid-auto-rows</code>, <code>grid-auto-columns</code>, <code>grid-auto-flow</code>的简写形式。可以同时显式定义/隐式定义模板值。</p>
<h5 id="间隔-gap"><a href="#间隔-gap" class="headerlink" title="间隔 gap"></a>间隔 gap</h5><p>网格区域内部间隔，不包括网格容器的外边界。<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">grid-column-gap</span>: &lt;<span class="selector-tag">line-size</span>&gt;; <span class="comment">/* 新版本 column-gap */</span></span><br><span class="line"><span class="selector-tag">grid-row-gap</span>: &lt;<span class="selector-tag">line-size</span>&gt;; <span class="comment">/* 新版本 row-gap */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">grid-gap</span>: &lt;<span class="selector-tag">grid-row-gap</span>&gt; &lt;<span class="selector-tag">grid-column-gap</span>&gt;; <span class="comment">/* 新版本 gap */</span></span><br></pre></td></tr></table></figure></p>
<h5 id="对齐方式-align"><a href="#对齐方式-align" class="headerlink" title="对齐方式 align"></a>对齐方式 align</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 网格内部内容的align */</span></span><br><span class="line">justify-items: start | end | center | stretch;</span><br><span class="line">align-items: start | end | center | stretch;</span><br><span class="line">place-items: &lt;align-items&gt; / &lt;justify-items&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 网格的本身相对于其父容器的align */</span></span><br><span class="line">justify-content: start | end | center | stretch | space-around | space-between | space-evenly;	</span><br><span class="line">align-content: start | end | center | stretch | space-around | space-between | space-evenly;	</span><br><span class="line">place-content: &lt;align-content&gt; / &lt;justify-content&gt;;</span><br></pre></td></tr></table></figure>
<h5 id="网格线名称-line"><a href="#网格线名称-line" class="headerlink" title="网格线名称 line"></a>网格线名称 line</h5><p>部分示例：</p>
<p>[first]<br>[line2]<br>[col4-start]<br>[five]<br>[end]</p>
<p>[row1-start]<br>[row1-end]]<br>[third-line]<br>[last-line]<br>[row2-end]</p>
<p>[row1-end row2-start]</p>
<h4 id="网格项Grid-Items"><a href="#网格项Grid-Items" class="headerlink" title="网格项Grid Items"></a>网格项Grid Items</h4><p>在网格项中，以下属性失效：</p>
<ul>
<li>float</li>
<li>display: inline-block</li>
<li>display: table-cell</li>
<li>vertical-align</li>
<li>column-*</li>
</ul>
<h5 id="行列位置"><a href="#行列位置" class="headerlink" title="行列位置"></a>行列位置</h5><p>基于<strong>line</strong>取值（从第几个到第几个网格线）：</p>
<ol>
<li>number:  a number of grid line</li>
<li>name:  a name of grid line</li>
<li><code>span &lt;name&gt;</code>:   从当前开始，到名称为name的 line 结束。</li>
</ol>
<p>基于<strong>track</strong>取值（共几个网格）：</p>
<ol>
<li><code>span &lt;number&gt;</code>:   across number of grid tracks</li>
</ol>
<p>默认span = 1，即跨一个网格项</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">grid-column-start: &lt;number&gt; | &lt;name&gt; | span &lt;number&gt; | span &lt;name&gt; | auto;</span><br><span class="line">grid-column-end: &lt;number&gt; | &lt;name&gt; | span &lt;number&gt; | span &lt;name&gt; | auto;</span><br><span class="line"></span><br><span class="line">grid-row-start: &lt;number&gt; | &lt;name&gt; | span &lt;number&gt; | span &lt;name&gt; | auto;</span><br><span class="line">grid-row-end: &lt;number&gt; | &lt;name&gt; | span &lt;number&gt; | span &lt;name&gt; | auto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 行简写 列简写 */</span></span><br><span class="line">grid-column: &lt;start-line&gt; / &lt;end-line&gt; | &lt;start-line&gt; / span &lt;value&gt;;</span><br><span class="line">grid-row: &lt;start-line&gt; / &lt;end-line&gt; | &lt;start-line&gt; / span &lt;value&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 行列简写， 区块名称 */</span></span><br><span class="line">grid-area: &lt;name&gt; | &lt;row-start&gt; / &lt;column-start&gt; / &lt;row-end&gt; / &lt;column-end&gt;;</span><br></pre></td></tr></table></figure>
<h5 id="对齐方式-align-1"><a href="#对齐方式-align-1" class="headerlink" title="对齐方式 align"></a>对齐方式 align</h5><figure class="highlight"><table><tr><td class="code"><pre><span class="line">justify-self: start | end | center | stretch;</span><br><span class="line">align-self: start | end | center | stretch;</span><br><span class="line">place-self: &lt;align-self&gt; / &lt;justify-self&gt;;</span><br></pre></td></tr></table></figure>
<h5 id="叠加"><a href="#叠加" class="headerlink" title="叠加"></a>叠加</h5><p>z-index    #控制网格项的叠加顺序</p>
<p>order #顺序</p>
<h5 id="特殊值"><a href="#特殊值" class="headerlink" title="特殊值"></a>特殊值</h5><p>repeat     #重复若干次，eg： repeat(6, 1fr),  repeat(3, 20px [col-start]);</p>
<p>fr    #网格容器剩余空间<strong>等分</strong></p>
<p>单位：px, rem, %, min-content, max-content, auto, fr等，混合亦可。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p>[1]<a href="http://cssgridgarden.com/" target="_blank" rel="noopener">grid布局游戏</a><br>[2]<a href="http://www.css88.com/archives/8506" target="_blank" rel="noopener">5分钟学会 CSS Grid 布局</a><br>[3]<a href="https://css-tricks.com/snippets/css/complete-guide-grid/" target="_blank" rel="noopener">CSS-TRICKS A Complete Guide to Grid</a></p>
<h3 id="Flex"><a href="#Flex" class="headerlink" title="Flex"></a>Flex</h3><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><p>实现如下布局：<br><img src="/want/2018/10/18/布局/flex.png" title="flex布局"></p>
<p>代码：<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">	<span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">	<span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">	 </span><br><span class="line">	<span class="attribute">display</span>: flex;</span><br><span class="line">	<span class="attribute">flex-direction</span>: rows;</span><br><span class="line">	<span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.large</span> &#123;</span><br><span class="line">	<span class="attribute">flex</span>: <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.middle</span> &#123;</span><br><span class="line">	<span class="attribute">flex</span>: <span class="number">2</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="selector-class">.wrapper</span> &gt; <span class="selector-tag">div</span> &#123;</span><br><span class="line">	<span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>;</span><br><span class="line">	<span class="attribute">background</span>: <span class="number">#f1f1f1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.wrapper</span> &gt; <span class="selector-tag">div</span><span class="selector-pseudo">:not(</span><span class="selector-pseudo">:nth-last-of-type(1))</span> &#123;</span><br><span class="line">	<span class="attribute">margin-right</span>: <span class="number">1rem</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="垂直居中，且出现垂直滚动条"><a href="#垂直居中，且出现垂直滚动条" class="headerlink" title="垂直居中，且出现垂直滚动条"></a>垂直居中，且出现垂直滚动条</h4><img src="/want/2018/10/18/布局/flex-right.gif" title="正确的滚动"><img src="/want/2018/10/18/布局/flex-error.gif" title="错误-无法滚动到顶部">
<p>如上图图例，实现如下效果：</p>
<ol>
<li>内容较少，无滚动条时，图例垂直居中</li>
<li>内容较多，出现滚动条</li>
</ol>
<h5 id="错误示例-flex"><a href="#错误示例-flex" class="headerlink" title="错误示例-flex"></a>错误示例-flex</h5><p>如下方式，只能实现垂直居中；当出现滚动条时，会吞掉顶部数据。<br>when the flex item overflows the container,  the top becomes inaccessible.</p>
<blockquote>
<p>justify-content: <strong>safe</strong> center; 其中，safe是flex用来解决overflow问题的，但基本不支持任何主流浏览器</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrapper"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">justify-content</span>: safe center; <span class="comment">/* attention */</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.item</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h5 id="解决示例-margin-auto"><a href="#解决示例-margin-auto" class="headerlink" title="解决示例-margin:auto"></a>解决示例-margin:auto</h5><p>用flex包裹一个子元素，使得该子元素margin:auto 居中（一种变通解决方案workaround）<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"wrapper"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"items"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">  <span class="attribute">overflow-y</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.items</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: auto; <span class="comment">/* attention */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也许是flex的核心理念就在于有缩放特点的<strong>弹性布局</strong>，而不愿在弹性布局之上出现滚动条（破坏缩放）。</p>
<h4 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h4><p>[1]<a href="https://www.hellojava.com/a/44618.html" target="_blank" rel="noopener">Can’t scroll to top of flex item that is overflowing container</a></p>
]]></content>
      <tags>
        <tag>grid</tag>
        <tag>flex</tag>
      </tags>
  </entry>
  <entry>
    <title>bind主从部署过程</title>
    <url>/want/2021/06/24/bind%E4%B8%BB%E4%BB%8E%E9%83%A8%E7%BD%B2%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="系统及部署环境"><a href="#系统及部署环境" class="headerlink" title="系统及部署环境"></a>系统及部署环境</h3><p>获取操作系统命令</p>
<ol>
<li>uname -sr</li>
<li>cat /etc/redhat-release</li>
</ol>
<p>设置机器信息及主备关系</p>
<table>
<thead>
<tr>
<th>主机</th>
<th>主备</th>
<th>操作系统</th>
<th>bind版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>fnc05 10.154.5.163</td>
<td>主机master</td>
<td>CentOS Linux release 7.9.2009 (Core) / Linux 3.10.0-1160.11.1.el7.x86_64</td>
<td>BIND 9.16.17 (Stable Release)</td>
</tr>
<tr>
<td>fnc04 10.154.5.162</td>
<td>从机slave</td>
<td>CentOS Linux release 7.8.2003 (Core) / Linux 3.10.0-1127.18.2.el7.x86_64</td>
<td>BIND 9.16.16 (Stable Release)</td>
</tr>
<tr>
<td>fnc03 10.154.5.214</td>
<td>从机slave</td>
<td>BigCloud Enterprise Linux For LDK release 7.6.1906 (Core) / Linux 4.19.25-200.1.el7.bclinux.x86_64</td>
<td>BIND 9.16.17 (Stable Release)</td>
</tr>
</tbody>
</table>
<p>上述主备机仍需注意如下配置：</p>
<ol>
<li>确保防火墙的规则不会拦截Bind的监听端口，默认为53</li>
<li>确保主从服务器的时钟一致</li>
<li>确保named用户拥有操作相关目录的权限（默认安装后就有了）</li>
</ol>
<h3 id="bind9-16安装配置"><a href="#bind9-16安装配置" class="headerlink" title="bind9.16安装配置"></a>bind9.16安装配置</h3><h4 id="9-16安装"><a href="#9-16安装" class="headerlink" title="9.16安装"></a>9.16安装</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vim bind.repo</span><br><span class="line">[copr:copr.fedorainfracloud.org:isc:bind]</span><br><span class="line">name=Copr repo for bind owned by isc</span><br><span class="line">baseurl=https://download.copr.fedorainfracloud.org/results/isc/bind/epel-7-$basearch/</span><br><span class="line">type=rpm-md</span><br><span class="line">skip_if_unavailable=True</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://download.copr.fedorainfracloud.org/results/isc/bind/pubkey.gpg</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">enabled_metadata=1</span><br><span class="line"></span><br><span class="line">yum list isc-bind*</span><br><span class="line"></span><br><span class="line">yum install isc-bind-bind isc-bind-bind-utils isc-bind-bind-libs -y</span><br><span class="line"></span><br><span class="line">守护进程文件位置：/etc/opt/isc/isc-bind/sysconfig/named</span><br><span class="line">配置文件位置：/etc/opt/isc/isc-bind/named.conf</span><br><span class="line">发现有如下内容：</span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/opt/isc/isc-bind/named/data";</span><br><span class="line">        listen-on &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 &#123; ::1; &#125;;</span><br><span class="line">        dnssec-validation auto;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "named.run";</span><br><span class="line">                print-time yes;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">尝试启动，发现成功</span></span><br><span class="line">systemctl start isc-bind-named</span><br><span class="line">systemctl enable isc-bind-named</span><br><span class="line">systemctl status isc-bind-named</span><br></pre></td></tr></table></figure>
<p>安装过程可能确实某些安装包，可以自行安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/scl-utils-20130529-19.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum install scl-utils-build-20130529-19.el7.x86_64.rpm -y</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> iso-codes</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/iso-codes-3.46-2.el7.noarch.rpm</span><br><span class="line">yum install iso-codes-3.46-2.el7.noarch.rpm -y</span><br></pre></td></tr></table></figure>
<p>安装包下载网站</p>
<ol>
<li><p><a href="https://pkgs.org/download/iso-codes" target="_blank" rel="noopener">Iso-codes Download (APK, DEB, EOPKG, RPM, TGZ, TXZ, XZ, ZST) (pkgs.org)</a></p>
</li>
<li><p><a href="https://centos.pkgs.org/7/centos-x86_64/scl-utils-20130529-19.el7.x86_64.rpm.html" target="_blank" rel="noopener">scl-utils-20130529-19.el7.x86_64.rpm CentOS 7 Download (pkgs.org)</a></p>
</li>
</ol>
<h4 id="9-16配置"><a href="#9-16配置" class="headerlink" title="9.16配置"></a>9.16配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在物理机/etc/profile.d/⽬录下创建isc-bind-named.sh⽂件。并输⼊以下内容，保存。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">然后重启物理机即可。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">source scl_source enable isc-bind</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">或临时方案，不重启主机</span></span><br><span class="line">scl enable isc-bind bash</span><br><span class="line">rndc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">获取<span class="built_in">bind</span>版本命令发，发现是9.16</span></span><br><span class="line">named -v</span><br><span class="line"><span class="meta">#</span><span class="bash">如若不是所安装的9.16版本，停止当前版本</span></span><br><span class="line">systemctl stop named</span><br></pre></td></tr></table></figure>
<h5 id="配置rndc-confgen"><a href="#配置rndc-confgen" class="headerlink" title="配置rndc-confgen"></a>配置rndc-confgen</h5><p>主从都可照着此步骤配置（但从机可以不用配置，因为从机仅同步查询数据，不做维护）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rndc-confgen -r  /dev/urandom  &gt; /etc/opt/isc/isc-bind/rndc.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生成rndc.conf文件，内容如下。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">将得到的内容，key和controls挪到named.conf中</span></span><br><span class="line"><span class="meta">#</span><span class="bash">将得到的内容，key和算法，放到python程序的config.yml中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#bind_algorithm: md5</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#bind_secret: rf27GDGjr6J2rRK5Ljsq2Q==</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Start of rndc.conf</span></span><br><span class="line">key "rndc-key" &#123;</span><br><span class="line">        algorithm hmac-md5;</span><br><span class="line">        secret "rf27GDGjr6J2rRK5Ljsq2Q==";</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        default-key "rndc-key";</span><br><span class="line">        default-server 127.0.0.1;</span><br><span class="line">        default-port 953;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of rndc.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use with the following <span class="keyword">in</span> named.conf, adjusting the allow list as needed:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> key <span class="string">"rndc-key"</span> &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       algorithm hmac-md5;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       secret <span class="string">"rf27GDGjr6J2rRK5Ljsq2Q=="</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> controls &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">       inet 127.0.0.1 port 953</span></span><br><span class="line"><span class="meta">#</span><span class="bash">               allow &#123; 127.0.0.1; &#125; keys &#123; <span class="string">"rndc-key"</span>; &#125;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> &#125;;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> End of named.conf</span></span><br></pre></td></tr></table></figure>
<h5 id="配置transfer-key"><a href="#配置transfer-key" class="headerlink" title="配置transfer-key"></a>配置transfer-key</h5><h6 id="主机生成密钥"><a href="#主机生成密钥" class="headerlink" title="主机生成密钥"></a>主机生成密钥</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">生成一个主机名称为dnssec-transfer的128位HMAC-MD5算法的密钥文件（公钥+私钥）</span></span><br><span class="line">dnssec-keygen -a HMAC-MD5 -b 128 -n HOST  dnssec-transfer</span><br><span class="line"><span class="meta">#</span><span class="bash">得到Kdnssec-transfer.+157+54187</span></span><br><span class="line"></span><br><span class="line">ls -al Kdnssec-transfer.+157+54187.*</span><br><span class="line"><span class="meta">#</span><span class="bash">-rw------- 1 root root  59 Jun 18 16:05 Kdnssec-transfer.+157+54187.key <span class="comment">#公钥</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">-rw------- 1 root root 165 Jun 18 16:05 Kdnssec-transfer.+157+54187.private <span class="comment">#私钥</span></span></span><br><span class="line"></span><br><span class="line">cat Kdnssec-transfer.+157+54187.private</span><br><span class="line"><span class="meta">#</span><span class="bash">复制key参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Key: /y7HAkwBH0KP9g9M+jADJg==</span></span><br></pre></td></tr></table></figure>
<p>将私钥key放到一个新的文件中，并将这个文件引入到named.conf中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /etc/opt/isc/isc-bind/ 或 cd /etc/  #密钥验证文件在/etc目录(与named.conf同一个目录下)</span><br><span class="line"></span><br><span class="line">vim transfer.key</span><br><span class="line">key "dnssec-transfer" &#123;                                     #密钥名称</span><br><span class="line">    algorithm hmac-md5;                                      #加密算法</span><br><span class="line">    secret "/y7HAkwBH0KP9g9M+jADJg==";                       #私钥加密字符串</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">chown root:named transfer.key                            #把文件所属组改为named，降低权限</span><br><span class="line">chmod 640 transfer.key </span><br><span class="line"></span><br><span class="line">vim /etc/named.conf</span><br><span class="line">include "/etc/transfer.key";</span><br><span class="line">allow-transfer &#123; key dnssec-transfer; &#125;;  #只允许拥有该密钥验证文件的人进行同步</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart named</span><br></pre></td></tr></table></figure>
<h6 id="从机引用密钥"><a href="#从机引用密钥" class="headerlink" title="从机引用密钥"></a>从机引用密钥</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp /etc/transfer.key root@从机ip地址:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line"></span><br><span class="line">scp /etc/transfer.key root@10.154.5.214:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line">scp /etc/transfer.key root@10.154.5.162:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line"></span><br><span class="line">chown root:named transfer.key</span><br><span class="line">chmod 640 transfer.key</span><br></pre></td></tr></table></figure>
<p>named.conf文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">不属于全局options</span></span><br><span class="line">server 10.154.5.163 &#123; # 主机ip地址</span><br><span class="line"> 	keys &#123; dnssec-transfer; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>重启从服务器的Bind服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<p>发现已经同步过来了。</p>
<h5 id="配置catalog"><a href="#配置catalog" class="headerlink" title="配置catalog"></a>配置catalog</h5><h6 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h6><ol>
<li>打开目录<code>/var/opt/isc/isc-bind/named/data</code>，新建catalog目录文件（后缀名可以为.db或者.zone）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/opt/isc/isc-bind/named/data</span><br><span class="line"></span><br><span class="line">vim catalog.default.zone</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 3600</span></span><br><span class="line">@       IN SOA . . 1 86400 3600 86400 3600</span><br><span class="line">@       IN NS  nop.</span><br><span class="line">version IN TXT "1"</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">修改权限</span></span><br><span class="line">chown named.named catalog.default.zone</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将catalog目录文件引入到named.conf中</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">...</span></span><br><span class="line">	allow-new-zones yes; # RNDC动态维护zones</span><br><span class="line">	notify yes; # 主动通知从机更新,而不需要等待轮询时间进行更新</span><br><span class="line"> 	also-notify &#123; 10.154.5.162; &#125;; # 被主动通知的从机地址，可多个地址</span><br><span class="line"> 	allow-transfer &#123; 10.154.5.162; 10.154.5.163; &#125;; # 只允许列表中的主机传递主域名服务器的数据,为了方便扩展可以设置为key</span><br><span class="line">    allow-update &#123; any; &#125;; #允许向主zone文件发送动态更新的匹配列表，如果设置为none，则无法使用update命令（更新记录zone等）</span><br><span class="line">    allow-query  &#123; any; &#125;; #添加允许访问DNS的地址段</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">          type master;</span><br><span class="line">          file "catalog.default.zone";</span><br><span class="line">          #also-notify &#123; 10.154.5.162; &#125;; </span><br><span class="line">          #allow-transfer &#123; 10.154.5.162; 10.154.5.163; &#125;;</span><br><span class="line">          #allow-update &#123; any; &#125;; </span><br><span class="line">          #allow-query &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">named-checkzone catalog.default catalog.default.zone</span><br></pre></td></tr></table></figure>
<h6 id="从机"><a href="#从机" class="headerlink" title="从机"></a>从机</h6><p>named.conf配置catalog目录，与主机建立关联。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">...</span></span><br><span class="line">	listen-on port 53 &#123; 127.0.0.1; 10.154.5.162; 10.154.5.163; &#125;; # 主机</span><br><span class="line">	allow-new-zones yes; # RNDC动态维护zones</span><br><span class="line">	masterfile-format text; #从机乱码问题</span><br><span class="line">	catalog-zones &#123;</span><br><span class="line">                zone "catalog.default"  default-masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">          type slave;</span><br><span class="line">          file "catalog.default.zone";</span><br><span class="line">          masters &#123; 10.154.5.163; &#125;; // 主机ip</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h6><p>至此完成catalog目录的配置。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">主机、从机都重启</span></span><br><span class="line">systemctl restart named 或</span><br><span class="line">systemctl restart isc-bind-named</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在主机上验证主从是否搭建catalog成功</span></span><br><span class="line">dig +short @10.154.5.163 soa catalog.default</span><br><span class="line">dig +short @10.154.5.162 soa catalog.default</span><br></pre></td></tr></table></figure>
<h5 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h5><h6 id="生成日志存储文件"><a href="#生成日志存储文件" class="headerlink" title="生成日志存储文件"></a>生成日志存储文件</h6><p>cd /var/opt/isc/isc-bind/log/</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim namelist.txt</span></span><br><span class="line">default.log</span><br><span class="line">general.log</span><br><span class="line">database.log</span><br><span class="line">security.log</span><br><span class="line">config.log</span><br><span class="line">resolver.log</span><br><span class="line">xfer-in.log</span><br><span class="line">xfer-out.log</span><br><span class="line">notify.log</span><br><span class="line">client.log</span><br><span class="line">unmatched.log</span><br><span class="line">queries.log</span><br><span class="line">network.log</span><br><span class="line">update.log</span><br><span class="line">dispatch.log</span><br><span class="line">dnssec.log</span><br><span class="line">lame-servers.log</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">printf "*************************************\n"</span><br><span class="line">echo " cat file whiel read line"</span><br><span class="line">cat namelist.txt |while read line</span><br><span class="line">do</span><br><span class="line">echo $line;</span><br><span class="line"></span><br><span class="line">touch $line;</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chown named.named -R ../log</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bash createlog.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">发送到从机</span></span><br><span class="line">scp /var/opt/isc/isc-bind/log/namelist.txt  root@10.154.5.162:/var/opt/isc/isc-bind/log/namelist.txt</span><br><span class="line">scp /var/opt/isc/isc-bind/log/createlog.sh  root@10.154.5.162:/var/opt/isc/isc-bind/log/createlog.sh</span><br><span class="line">bash createlog.sh</span><br></pre></td></tr></table></figure>
<h6 id="named-conf配置"><a href="#named-conf配置" class="headerlink" title="named.conf配置"></a>named.conf配置</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">​```shell</span><br><span class="line">logging &#123;</span><br><span class="line"> channel default_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/default.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel general_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/general.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel database_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/database.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel security_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/security.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel config_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/config.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel resolver_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/resolver.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-in_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-in.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-out_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-out.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel notify_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/notify.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel client_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/client.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel unmatched_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/unmatched.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel queries_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/queries.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel network_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/network.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel update_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/update.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dispatch_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dispatch.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dnssec_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dnssec.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel lame-servers_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/lame-servers.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    category default &#123; default_file; &#125;;</span><br><span class="line">    category general &#123; general_file; &#125;;</span><br><span class="line">    category database &#123; database_file; &#125;;</span><br><span class="line">    category security &#123; security_file; &#125;;</span><br><span class="line">    category config &#123; config_file; &#125;;</span><br><span class="line">    category resolver &#123; resolver_file; &#125;;</span><br><span class="line">    category xfer-in &#123; xfer-in_file; &#125;;</span><br><span class="line">    category xfer-out &#123; xfer-out_file; &#125;;</span><br><span class="line">    category notify &#123; notify_file; &#125;;</span><br><span class="line">    category client &#123; client_file; &#125;;</span><br><span class="line">    category unmatched &#123; unmatched_file; &#125;;</span><br><span class="line">    category queries &#123; queries_file; &#125;;</span><br><span class="line">    category network &#123; network_file; &#125;;</span><br><span class="line">    category update &#123; update_file; &#125;;</span><br><span class="line">    category dispatch &#123; dispatch_file; &#125;;</span><br><span class="line">    category dnssec &#123; dnssec_file; &#125;;</span><br><span class="line">    category lame-servers &#123; lame-servers_file; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主从机都配置！</p>
<h5 id="最终主机配置"><a href="#最终主机配置" class="headerlink" title="最终主机配置"></a>最终主机配置</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">key rndc-key &#123;</span><br><span class="line">        algorithm hmac-md5;</span><br><span class="line">        secret "rf27GDGjr6J2rRK5Ljsq2Q==";</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line">options &#123;</span><br><span class="line">	directory "/var/opt/isc/isc-bind/named/data";</span><br><span class="line">	listen-on port 53 &#123; 127.0.0.1; 10.154.5.163; &#125;;</span><br><span class="line"><span class="meta">	#</span><span class="bash">listen-on-v6 &#123; ::1; &#125;;</span></span><br><span class="line">	dnssec-enable yes;</span><br><span class="line">	dnssec-validation yes;</span><br><span class="line"></span><br><span class="line">	allow-query &#123; any; &#125;;</span><br><span class="line">        allow-update &#123; any; &#125;;</span><br><span class="line">	allow-transfer &#123; 10.154.5.163; key dnssec-transfer; &#125;;</span><br><span class="line">	notify yes;</span><br><span class="line"><span class="meta">	#</span><span class="bash">notify-to-soa yes;</span></span><br><span class="line">	also-notify &#123; 10.154.5.162; 10.154.5.214; &#125;;</span><br><span class="line">	allow-new-zones yes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.163 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">controls &#123;</span><br><span class="line">       inet * port 953</span><br><span class="line">       allow &#123; any; &#125; keys &#123; "rndc-key"; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	channel default_debug &#123;</span><br><span class="line">		file "named.run";</span><br><span class="line">		print-time yes;</span><br><span class="line">		severity dynamic;</span><br><span class="line">	&#125;;</span><br><span class="line">   channel default_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/default.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel general_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/general.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel database_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/database.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel security_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/security.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel config_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/config.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel resolver_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/resolver.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-in_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-in.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-out_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-out.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel notify_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/notify.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel client_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/client.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel unmatched_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/unmatched.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel queries_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/queries.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel network_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/network.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel update_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/update.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dispatch_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dispatch.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dnssec_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dnssec.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel lame-servers_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/lame-servers.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    category default &#123; default_file; &#125;;</span><br><span class="line">    category general &#123; general_file; &#125;;</span><br><span class="line">    category database &#123; database_file; &#125;;</span><br><span class="line">    category security &#123; security_file; &#125;;</span><br><span class="line">    category config &#123; config_file; &#125;;</span><br><span class="line">    category resolver &#123; resolver_file; &#125;;</span><br><span class="line">    category xfer-in &#123; xfer-in_file; &#125;;</span><br><span class="line">    category xfer-out &#123; xfer-out_file; &#125;;</span><br><span class="line">    category notify &#123; notify_file; &#125;;</span><br><span class="line">    category client &#123; client_file; &#125;;</span><br><span class="line">    category unmatched &#123; unmatched_file; &#125;;</span><br><span class="line">    category queries &#123; queries_file; &#125;;</span><br><span class="line">    category network &#123; network_file; &#125;;</span><br><span class="line">    category update &#123; update_file; &#125;;</span><br><span class="line">    category dispatch &#123; dispatch_file; &#125;;</span><br><span class="line">    category dnssec &#123; dnssec_file; &#125;;</span><br><span class="line">    category lame-servers &#123; lame-servers_file; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "catalog.default.zone";</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">named-checkconf 验证配置</span><br><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<h5 id="最终从机配置"><a href="#最终从机配置" class="headerlink" title="最终从机配置"></a>最终从机配置</h5><p>从机配置同步数据所在目录slaves</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/opt/isc/isc-bind/named/data</span><br><span class="line">mkdir slaves</span><br><span class="line">chown named.named slaves</span><br></pre></td></tr></table></figure>
<p>named</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">key "rndc-key" &#123;</span><br><span class="line">        algorithm hmac-sha256;</span><br><span class="line">        secret "bshuXqh379VDuCYQqWJY68F1rkCEsf5LLfc274USvZQ=";</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">	directory "/var/opt/isc/isc-bind/named/data/slaves";</span><br><span class="line">	listen-on port 53 &#123; 127.0.0.1; 10.154.5.214; 10.154.5.163; &#125;;</span><br><span class="line"><span class="meta">	#</span><span class="bash">listen-on-v6 &#123; ::1; &#125;;</span></span><br><span class="line">	dnssec-validation auto;</span><br><span class="line"></span><br><span class="line">	allow-query &#123; any; &#125;;</span><br><span class="line">        allow-update &#123; any; &#125;;</span><br><span class="line">        allow-transfer &#123;any;&#125;;</span><br><span class="line">	allow-new-zones yes;</span><br><span class="line">	masterfile-format text;</span><br><span class="line">	catalog-zones &#123;</span><br><span class="line">                zone "catalog.default"  default-masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.214 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> controls &#123;</span><br><span class="line">       inet 127.0.0.1 port 953</span><br><span class="line">               allow &#123; 127.0.0.1; &#125; keys &#123; "rndc-key"; &#125;;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	channel default_debug &#123;</span><br><span class="line">		file "named.run";</span><br><span class="line">		print-time yes;</span><br><span class="line">		severity dynamic;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"> channel default_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/default.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel general_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/general.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel database_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/database.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel security_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/security.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel config_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/config.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel resolver_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/resolver.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-in_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-in.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-out_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-out.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel notify_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/notify.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel client_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/client.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel unmatched_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/unmatched.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel queries_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/queries.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel network_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/network.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel update_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/update.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dispatch_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dispatch.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dnssec_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dnssec.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel lame-servers_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/lame-servers.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    category default &#123; default_file; &#125;;</span><br><span class="line">    category general &#123; general_file; &#125;;</span><br><span class="line">    category database &#123; database_file; &#125;;</span><br><span class="line">    category security &#123; security_file; &#125;;</span><br><span class="line">    category config &#123; config_file; &#125;;</span><br><span class="line">    category resolver &#123; resolver_file; &#125;;</span><br><span class="line">    category xfer-in &#123; xfer-in_file; &#125;;</span><br><span class="line">    category xfer-out &#123; xfer-out_file; &#125;;</span><br><span class="line">    category notify &#123; notify_file; &#125;;</span><br><span class="line">    category client &#123; client_file; &#125;;</span><br><span class="line">    category unmatched &#123; unmatched_file; &#125;;</span><br><span class="line">    category queries &#123; queries_file; &#125;;</span><br><span class="line">    category network &#123; network_file; &#125;;</span><br><span class="line">    category update &#123; update_file; &#125;;</span><br><span class="line">    category dispatch &#123; dispatch_file; &#125;;</span><br><span class="line">    category dnssec &#123; dnssec_file; &#125;;</span><br><span class="line">    category lame-servers &#123; lame-servers_file; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file "catalog.default.zone";</span><br><span class="line">        masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line"></span><br><span class="line">server 10.154.5.163 &#123;</span><br><span class="line"> 	keys &#123; dnssec-transfer; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><img src="/want/2021/06/24/bind主从部署过程/exporter.png" title="exporter">
<h4 id="Bind基本配置"><a href="#Bind基本配置" class="headerlink" title="Bind基本配置"></a>Bind基本配置</h4><p>用于获取监控数据</p>
<p>vim /etc/opt/isc/isc-bind/named.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.162 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问10.154.5.162:8889</p>
<p><strong>注意端口号8889</strong></p>
<h4 id="bind-exporter"><a href="#bind-exporter" class="headerlink" title="bind_exporter"></a>bind_exporter</h4><p>用于图形化展现。</p>
<p>bind_exporter基于statistics-channels记录的统计数据，并对数据统计分析并输出到Prometheus</p>
<h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p>查看linux版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat /proc/version</span><br><span class="line">Linux version 3.10.0-1127.18.2.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) ) #1 SMP Sun Jul 26 15:27:06 UTC 2020</span><br></pre></td></tr></table></figure>
<p>根据版本下载</p>
<p><a href="https://github.com/prometheus-community/bind_exporter/releases" target="_blank" rel="noopener">https://github.com/prometheus-community/bind_exporter/releases</a></p>
<p>如上图，linux是86_64，则下载版本</p>
<p>bind_exporter-0.4.0.linux-amd64.tar.gz</p>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>解压到/usr/local/bin/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"> tar -xvf bind_exporter-0.4.0.linux-amd64.tar.gz</span><br><span class="line"> </span><br><span class="line"> cd /usr/local/bin/</span><br><span class="line">-rwxr-xr-x 1 3434 3434 15762489 Jan 14 22:55 bind_exporter</span><br><span class="line">-rw-r--r-- 1 3434 3434    11357 Jan 14 23:57 LICENSE</span><br><span class="line">-rw-r--r-- 1 3434 3434      252 Jan 14 23:57 NOTICE</span><br></pre></td></tr></table></figure>
<p>创建⼀个systemd配置⽂件以运⾏bind_exporter</p>
<ol>
<li>–web.listen-address为对外暴露的metric地址和端⼝，Prometheus从此处抓取bind_exporter的metrics；即对外提供数据的端口。</li>
<li>– bind.stats-url为本地bind服务绑定的地址和IP。即获取bind数据的地址。</li>
</ol>
<p>注意此处的⽤⼾和组可以使⽤与named程序相同的⽤⼾和组“named”，也可 以使⽤root。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/bind_exporter.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=bind_exporter</span><br><span class="line">Documentation=https://github.com/prometheus-community/bind_exporter</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">ExecStart=/usr/local/bin/bind_exporter \</span><br><span class="line">--bind.pid-file=/var/opt/isc/isc-bind/run/named/named.pid \</span><br><span class="line">--bind.timeout=20s \</span><br><span class="line">--web.listen-address=0.0.0.0:9154 \</span><br><span class="line">--web.telemetry-path=/metrics \</span><br><span class="line">--bind.stats-url=http://10.154.5.162:8889/ \</span><br><span class="line">--bind.stats-groups=server,view,tasks</span><br><span class="line">Restart=always</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure>
<p><strong>注意端口号9154</strong></p>
<p>加载并启动bind_export</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart bind_exporter.service</span><br></pre></td></tr></table></figure>
<h4 id="Prometheus-Server"><a href="#Prometheus-Server" class="headerlink" title="Prometheus Server"></a>Prometheus Server</h4><p>Prometheus基于Go编写，编译后的软件包，不依赖于任何的第三⽅依赖。只需要下载对应平台的⼆进制包，解压并且添加基本 的配置即可正常启Prometheus Server。</p>
<p>Prometheus Server负责定时在目标上抓取Metrics数据，每个抓取目标都需要暴露一个HTTP服务接口用于Prometheus定时抓取。</p>
<p>这种调用被监控对象获取监控数据的方式被称为Pull。Pull方式体现了Prometheus独特的设计哲学与大多数采用了Push方式的监控系统不同。</p>
<p>但某些现有系统是通过push方式实现的，为了接入这个系统，Prometheus提供对PushGateway的支持，这些系统主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。</p>
<p>AlertManager是独立于Prometheus的一个组件，在触发了预先设置在Prometheus中的高级规则后，Prometheus便会推送告警信息到AlertManager。</p>
<p>根据版本下载：</p>
<p><a href="https://prometheus.io/download/" target="_blank" rel="noopener">Download | Prometheus</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xf prometheus-2.27.1.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.27.1.linux-amd64 /usr/local/</span><br><span class="line">ln -s /usr/local/prometheus-2.27.1.linux-amd64/ /usr/local/prometheus</span><br></pre></td></tr></table></figure>
<p>创建Prometheus的⽤⼾(此处用户prometheus)及数据存储⽬录（/data/prometheus）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> useradd -s /sbin/nologin -M prometheus</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mkdir /data/prometheus -p</span></span><br><span class="line"><span class="meta">#</span><span class="bash">修改⽬录属主</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chown -R prometheus:prometheus /usr/<span class="built_in">local</span>/prometheus/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chown -R prometheus:prometheus /data/prometheus/</span></span><br></pre></td></tr></table></figure>
<p>配置/usr/local/prometheus/promethes.yml</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp prometheus.yml prometheus.yml-default #备份一下默认配置</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my global config</span></span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line"><span class="meta">  #</span><span class="bash"> scrape_timeout is <span class="built_in">set</span> to the global default (10s).</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: ["localhost:9093"]</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Load rules once and periodically evaluate them according to the global <span class="string">'evaluation_interval'</span>.</span></span><br><span class="line">rule_files:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"first_rules.yml"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"second_rules.yml"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Here it<span class="string">'s Prometheus itself.</span></span></span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  - job_name: 'prometheus'</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to '/metrics'</span><br><span class="line">    # scheme defaults to 'http'.</span><br><span class="line">	scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9090'] #浏览器访问9090打开管理界面</span><br><span class="line">   </span><br><span class="line">  - job_name: 'bind-fnc04'</span><br><span class="line">	scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['10.154.5.162:9154'] #监听bind_exporter</span><br></pre></td></tr></table></figure>
<p>默认启动后的端口为9090。</p>
<p>启动方式1</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local/prometheus</span><br><span class="line">./prometheus --version</span><br><span class="line">./prometheus &amp;</span><br></pre></td></tr></table></figure>
<p>启动方式2</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/prometheus.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml --storage.tsdb.path=/data/prometheus</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>如此可以用命令启动服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable prometheus</span><br><span class="line">systemctl start prometheus</span><br></pre></td></tr></table></figure>
<p>浏览器访问<a href="http://10.154.5.162:9090/targets" target="_blank" rel="noopener">http://10.154.5.162:9090/targets</a></p>
<h4 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h4><p>一个数据分析统计可视化报表，⽤来展⽰ prometheus收集到的数据</p>
<p><a href="https://zhuanlan.zhihu.com/p/351995351" target="_blank" rel="noopener">Grafana+Prometheus的详解以及使用 - 知乎 (zhihu.com)</a></p>
<p>下载</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.7.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xzvf grafana-7.5.7.linux-amd64.tar.gz</span><br><span class="line">mv grafana-7.5.7 /usr/local/</span><br><span class="line">ln -s /usr/local/grafana-7.5.7/ /usr/local/grafana</span><br></pre></td></tr></table></figure>
<p>创建grafana⽤⼾及数据存放⽬录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M grafana</span><br><span class="line">mkdir /data/grafana</span><br><span class="line">chown -R grafana:grafana /usr/local/grafana/</span><br><span class="line">chown -R grafana:grafana /data/grafana</span><br></pre></td></tr></table></figure>
<p>修改目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> cd /usr/local/grafana/conf/</span><br><span class="line"> cp defaults.ini defaults.ini-default 先备份</span><br><span class="line"> </span><br><span class="line"> vim defaults.ini</span><br><span class="line">data = /data/grafana/data</span><br><span class="line">logs = /data/grafana/log</span><br><span class="line">plugins = /data/grafana/plugins</span><br><span class="line">provisioning = /data/grafana/conf/provisioning</span><br></pre></td></tr></table></figure>
<p>新增 grafana-server.service ⽂件，使⽤systemd来管理grafana服务</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/grafana-server.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Grafana</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">User=grafana</span><br><span class="line">Group=grafana</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/grafana/bin/grafana-server -homepath /usr/local/grafana</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl status grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问</p>
<p><a href="http://10.154.5.162:3000/login" target="_blank" rel="noopener">http://10.154.5.162:3000/login</a></p>
<p>默认的账号密码 admin/admin</p>
<p>把grafana和prometheus关联起来，也就是在 grafana中添加添加数据源——</p>
<p>在配置⻚⾯点击添加数据源，然后选择prometheus，输⼊prometheus服务的参数即可。</p>
<img src="/want/2021/06/24/bind主从部署过程/prometheus.png" title="prometheus">
<img src="/want/2021/06/24/bind主从部署过程/prometheus_setting.png" title="prometheus_setting">
<h5 id="Grafana三种方式导入Dashboard"><a href="#Grafana三种方式导入Dashboard" class="headerlink" title="Grafana三种方式导入Dashboard"></a>Grafana三种方式导入Dashboard</h5><img src="/want/2021/06/24/bind主从部署过程/Grafana_import.png" title="Grafana_import">
<img src="/want/2021/06/24/bind主从部署过程/Grafana_import_detail.png" title="Grafana_import_detail">
<img src="/want/2021/06/24/bind主从部署过程/grafana_dashboards.png" title="grafana_dashboards">
<p>参考：</p>
<ol>
<li><a href="https://blog.csdn.net/y368769/article/details/108514720" target="_blank" rel="noopener">Grafana三种方式导入Dashboard_y368769的博客-CSDN博客_grafana import</a></li>
<li><a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards</a></li>
</ol>
<h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h4><p><a href="https://prometheus.io/download/" target="_blank" rel="noopener">https://prometheus.io/download/</a></p>
<img src="/want/2021/06/24/bind主从部署过程/node_exporter.png" title="node_exporter">
<p>采集主机的运⾏指标如CPU，内存，磁盘等信息。可以使⽤Node Exporter</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln -s  node_exporter-1.1.2.linux-amd64/  node_exporter</span><br><span class="line"></span><br><span class="line">启动，默认会启动9100端⼝</span><br><span class="line">nohup /usr/local/prometheus_exporter/node_exporter/node_exporter &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">或</span><br><span class="line">/usr/local/prometheus_exporter/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>
<p>​        </p>
<p>开机启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup /usr/local/prometheus_exporter/node_exporter/node_exporter &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<h5 id="加入prometheus"><a href="#加入prometheus" class="headerlink" title="加入prometheus"></a>加入prometheus</h5><p>编辑prometheus.yml⽂件，增加后⾯4⾏.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  - job_name: 'prometheus'</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to '/metrics'</span><br><span class="line">    # scheme defaults to 'http'.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9090']</span><br><span class="line"></span><br><span class="line">  - job_name: 'bind-fnc04'</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['10.154.5.162:9154'] #监听bind_exporter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  - job_name: 'node'</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9100']</span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart prometheus.service</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>mybatis</title>
    <url>/want/2020/05/25/mybatis/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>MyBatis 是一款优秀的<strong>持久层</strong>框架，它支持<strong>自定义 SQL</strong>、<strong>存储过程</strong>以及<strong>高级映射</strong>。</p>
<p>MyBatis 免除了几乎所有的 JDBC 代码、设置参数、获取结果集的工作。MyBatis 可以通过简单的 XML 或注解来配置和映射原始类型、接口、Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。</p>
<p>官网讲的非常清楚。加载页面比较慢，可以慢慢等到。</p>
<h3 id="作用域（Scope）和生命周期"><a href="#作用域（Scope）和生命周期" class="headerlink" title="作用域（Scope）和生命周期"></a>作用域（Scope）和生命周期</h3><h5 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h5><p>只是用来创建SqlSessionFactory，一旦创建了 SqlSessionFactory，就不再需要。</p>
<p>可以重用 SqlSessionFactoryBuilder 来创建多个 SqlSessionFactory 实例，但最好用完就丢弃。</p>
<p>因此 SqlSessionFactoryBuilder 实例的最佳作用域是<strong>方法作用域</strong>（也就是局部方法变量）。 </p>
<h5 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h5><p>SqlSessionFactory 一被创建就该在应用运行期间一直存在，不能丢弃或重新创建另一个实例。</p>
<p>最佳实践是在应用运行期间不要重复创建多次。</p>
<p>因此 SqlSessionFactory 的最佳作用域是<strong>应用作用域</strong>。 可以采用<strong>单例模式</strong>或<strong>静态单例模式</strong>来实现。</p>
<h5 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h5><p>每个线程都应该创建自己的 SqlSession 实例。</p>
<p>不是线程安全的，不能被共享的，所以它的最佳的作用域是<strong>请求或方法作用域</strong>。</p>
<p>每次用完，应该及时关闭SqlSession 实例。可以try finaly 进行关闭。</p>
<ol>
<li><p>绝不能将 SqlSession 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。</p>
</li>
<li><p>绝不能将 SqlSession 实例的引用放在任何类型的托管作用域中，比如 Servlet 框架中的 HttpSession。 如果你现在正在使用一种 Web 框架，考虑将 SqlSession 放在一个和 HTTP 请求相似的作用域中。 换句话说，每次收到 HTTP 请求，就可以打开一个 SqlSession，返回一个响应后，就关闭它。 </p>
</li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>根据官网要求，去maven依赖管理网站，找到依赖，放到pom.xml文件中。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="SqlSessionFactory-1"><a href="#SqlSessionFactory-1" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h4><p>SqlSessionFactory 实例是基于 MyBatis 应用的核心。</p>
<p>SqlSessionFactory 的实例可以通过 SqlSessionFactoryBuilder 获得。SqlSessionFactoryBuilder 从 XML 配置文件或一个预先配置的 Configuration 实例来构建出 SqlSessionFactory 实例。</p>
<p>目前构建方式有两种：</p>
<ol>
<li>【推荐】使用xml + java配置文件构建</li>
<li>只使用java配置文件构建（只用于简单的配置）</li>
</ol>
<h5 id="【推荐】使用xml-java配置文件构建"><a href="#【推荐】使用xml-java配置文件构建" class="headerlink" title="【推荐】使用xml + java配置文件构建"></a>【推荐】使用xml + java配置文件构建</h5><p>XML 配置文件中包含了对 MyBatis 系统的核心设置，具体为：</p>
<ul>
<li>数据源DataSource</li>
<li>决定事务作用域和控制方式的事务管理器TransactionManager</li>
</ul>
<h6 id="mybatis-config-xml"><a href="#mybatis-config-xml" class="headerlink" title="mybatis-config.xml"></a>mybatis-config.xml</h6><p>一个完整的配置文件</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/config.properties"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"dev_user"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"F2Fa3!33TYyg"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;url&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;username&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;password&#125;"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#config.properties</span><br><span class="line"></span><br><span class="line">driver=org.postgresql.Driver</span><br><span class="line">url=jdbc:postgresql://xxx.xxx.xxx.xxx:5432/fgm</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ol>
<li><p>environment ：包含事务管理和连接池的配置。</p>
</li>
<li><p>mappers ：包含一组映射器（mapper），这些映射器的 XML 映射文件包含了 SQL 代码和映射定义信息。</p>
</li>
<li><p>配置会先从.xml文件内部的properties读取，而后再读取外部配置文件中的配置（优先级最高）</p>
</li>
<li><p>MyBatis 3.4.2以上版本，使用:可为占位符指定<strong>默认值</strong>。该特性默认关闭，需要进行配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver:org.postgresql.Driver&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/config.properties"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 启用默认值特性 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"org.apache.ibatis.parsing.PropertyParser.enable-default-value"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span> </span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 自定义修改默认值的分隔符，默认是：冒号 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"org.apache.ibatis.parsing.PropertyParser.default-value-separator"</span> <span class="attr">value</span>=<span class="string">"?:"</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>设置文件</p>
<p>这是 MyBatis 中极为重要的调整设置，它们会改变 MyBatis 的运行时行为。 下表描述了常见设置中各项设置的含义、默认值等。</p>
<p><a href="https://mybatis.org/mybatis-3/zh/configuration.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/configuration.html</a></p>
<table>
<thead>
<tr>
<th style="text-align:left">设置名</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">有效值</th>
<th style="text-align:left">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">cacheEnabled</td>
<td style="text-align:left">全局性地开启或关闭所有映射器配置文件中已配置的任何缓存。</td>
<td style="text-align:left">true \</td>
<td style="text-align:left">false</td>
<td>true</td>
</tr>
<tr>
<td style="text-align:left">mapUnderscoreToCamelCase</td>
<td style="text-align:left">是否开启驼峰命名自动映射，即从经典数据库列名 A_COLUMN 映射到经典 Java 属性名 aColumn。</td>
<td style="text-align:left">true \</td>
<td style="text-align:left">false</td>
<td>False</td>
</tr>
<tr>
<td style="text-align:left">logImpl</td>
<td style="text-align:left">指定 MyBatis 所用日志的具体实现，未指定时将自动查找。</td>
<td style="text-align:left">SLF4J \</td>
<td style="text-align:left">LOG4J \</td>
<td>LOG4J2 \</td>
<td>JDK_LOGGING \</td>
<td>COMMONS_LOGGING \</td>
<td>STDOUT_LOGGING \</td>
<td>NO_LOGGING</td>
<td>未设置</td>
</tr>
<tr>
<td style="text-align:left">logPrefix</td>
<td style="text-align:left">指定 MyBatis 增加到日志名称的前缀。</td>
<td style="text-align:left">任何字符串</td>
<td style="text-align:left">未设置</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"cacheEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadingEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"multipleResultSetsEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useColumnLabel"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"useGeneratedKeys"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingBehavior"</span> <span class="attr">value</span>=<span class="string">"PARTIAL"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"autoMappingUnknownColumnBehavior"</span> <span class="attr">value</span>=<span class="string">"WARNING"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultExecutorType"</span> <span class="attr">value</span>=<span class="string">"SIMPLE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultStatementTimeout"</span> <span class="attr">value</span>=<span class="string">"25"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"defaultFetchSize"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"safeRowBoundsEnabled"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 自动进行驼峰命名与数据库下划线字段的转换 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"localCacheScope"</span> <span class="attr">value</span>=<span class="string">"SESSION"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"jdbcTypeForNull"</span> <span class="attr">value</span>=<span class="string">"OTHER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"lazyLoadTriggerMethods"</span> <span class="attr">value</span>=<span class="string">"equals,clone,hashCode,toString"</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 打印sql日志 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"STDOUT_LOGGING"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>别名：</p>
<p>在sql语句，指定返回类型时候，需要带自定义类型的全路径。可以使用别名进行简化。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">别名简化前</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getKpiList"</span> <span class="attr">resultType</span>=<span class="string">"domain.blog.Blog"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">别名简化后</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getKpiList"</span> <span class="attr">resultType</span>=<span class="string">"Blog"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当别名配置后，<code>Blog</code> 可以直接使用到任何使用 <code>domain.blog.Blog</code> 的地方。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Author"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Author"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Blog"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Blog"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Comment"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Comment"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Post"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Post"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Section"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Section"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Tag"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Tag"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以指定一个包名，MyBatis 会在包名下面搜索需要的 Java Bean</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"domain.blog"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>每一个在包 <code>domain.blog</code> 中的 Java Bean，在没有注解的情况下，会使用 Bean 的首字母小写的非限定类名来作为它的别名。 比如 <code>domain.blog.Author</code> 的别名为 <code>author</code>；</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">别名简化前</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getKpiList"</span> <span class="attr">resultType</span>=<span class="string">"domain.blog.Blog"</span>&gt;</span></span><br><span class="line">别名简化后</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getKpiList"</span> <span class="attr">resultType</span>=<span class="string">"blog"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>若有注解，则别名为其注解值。见下面的例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Alias</span>(<span class="string">"author"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Author</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>映射器（mappers）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 将包内的映射器接口实现全部注册为映射器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"org.mybatis.builder"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用相对于类路径的资源引用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/builder/AuthorMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/builder/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/builder/PostMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用映射器接口实现类的完全限定类名 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"org.mybatis.builder.AuthorMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"org.mybatis.builder.BlogMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"org.mybatis.builder.PostMapper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用完全限定资源定位符（URL） --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///var/mappers/AuthorMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///var/mappers/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///var/mappers/PostMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="MyBatisConfig-java"><a href="#MyBatisConfig-java" class="headerlink" title="MyBatisConfig.java"></a>MyBatisConfig.java</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String resource = <span class="string">"org/mybatis/example/mybatis-config.xml"</span>;</span><br><span class="line">InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>
<h5 id="只使用java配置文件构建"><a href="#只使用java配置文件构建" class="headerlink" title="只使用java配置文件构建"></a>只使用java配置文件构建</h5><p>其实就是把xml文件的配置信息用java编写</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataSource dataSource = BlogDataSourceFactory.getBlogDataSource();</span><br><span class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</span><br><span class="line">Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">configuration.addMapper(BlogMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br></pre></td></tr></table></figure>
<h4 id="SqlSession-1"><a href="#SqlSession-1" class="headerlink" title="SqlSession"></a>SqlSession</h4><p>真正去调用sql映射文件，并执行。</p>
<p>映射器是一些绑定映射语句的接口，映射器接口的实例从 SqlSession 中获得。映射器实例应该在调用它们的方法中被获取，使用完毕之后即可丢弃。 最好将映射器放在方法作用域内。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (SqlSession session = sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  <span class="comment">// 映射器</span></span><br><span class="line">  BlogMapper mapper = session.getMapper(BlogMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  Blog blog = mapper.selectBlog(<span class="number">101</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="xml映射文件"><a href="#xml映射文件" class="headerlink" title="xml映射文件"></a>xml映射文件</h3><p>Mybatis接口方法与真实SQL关联</p>
<p>方法1：注解</p>
<ul>
<li>适合简单SQL语句</li>
<li>自动提交事务</li>
<li>底层通过反射实现</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Select(&quot;select * from user where id=#&#123;id&#125;&quot;)</span><br><span class="line">List&lt;User&gt; getUsers()</span><br></pre></td></tr></table></figure>
<p>方法2：mapper.xml</p>
<ul>
<li><p>适合复杂SQL语句</p>
</li>
<li><p>手动提交事务</p>
</li>
</ul>
<p>通常使用mapper.xml的方式。具体如下：</p>
<p><a href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/sqlmap-xml.html</a></p>
<p>mapper.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.mybatis.example;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BlogMapper</span> </span>&#123;</span><br><span class="line">  <span class="function">Blog <span class="title">selectBlog</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"org.mybatis.example.BlogMapper"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectBlog"</span> <span class="attr">resultType</span>=<span class="string">"Blog"</span>&gt;</span></span><br><span class="line">    select * from Blog where id = #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SQL 映射文件只有很少的几个顶级元素（按照如下顺序列出）：</p>
<ul>
<li><code>cache</code> – 该命名空间的缓存配置。</li>
<li><code>cache-ref</code> – 引用其它命名空间的缓存配置。</li>
<li><code>resultMap</code> – 描述如何从数据库结果集中加载对象，是最复杂也是最强大的元素。</li>
<li><del><code>parameterMap</code> – 老式风格的参数映射。此元素已被废弃，并可能在将来被移除！请使用行内参数映射。文档中不会介绍此元素。</del></li>
<li><code>sql</code> – 可被其它语句引用的可重用语句块。</li>
<li><code>insert</code> – 映射插入语句。</li>
<li><code>update</code> – 映射更新语句。</li>
<li><code>delete</code> – 映射删除语句。</li>
<li><code>select</code> – 映射查询语句。</li>
</ul>
<h5 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">List<span class="tag">&lt;<span class="name">FgmKpi</span>&gt;</span> getKpiList();                </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getKpiList"</span> <span class="attr">resultType</span>=<span class="string">"fgmKpi"</span>&gt;</span></span><br><span class="line">        select * from t_fg_pm_kpi limit 10</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Boolean insertKpi(FgmKpi fgmKpi);</span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertKpi"</span>&gt;</span></span><br><span class="line">        insert into t_fg_pm_kpi</span><br><span class="line">            (uuid, pid, en_name, ch_name, definition, unit)</span><br><span class="line">         values</span><br><span class="line">            (#&#123;id&#125;, #&#123;pId&#125;,#&#123;enName&#125;, #&#123;chName&#125;, #&#123;definition&#125;, #&#123;unit&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Boolean updateKpi(Map fgmKpi);</span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateKpi"</span>&gt;</span></span><br><span class="line">        update t_fg_pm_kpi</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"definition != null"</span>&gt;</span></span><br><span class="line">                definition = #&#123;definition&#125;,</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"unit != null"</span>&gt;</span></span><br><span class="line">                unit = #&#123;unit&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"id != null"</span>&gt;</span></span><br><span class="line">                uuid=#&#123;id&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Boolean deleteKpi(@Param("id") String id);</span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteKpi"</span>&gt;</span></span><br><span class="line">        delete from t_fg_pm_kpi where uuid=#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="参数的传递"><a href="#参数的传递" class="headerlink" title="参数的传递"></a>参数的传递</h5><ol>
<li>基本类型：注解传参。<img src="/want/2020/05/25/mybatis/param注解.png" title="param注解"></li>
<li>引用类型：<ul>
<li>使用自定义的Map，SQL会自动解析Map对象的key和value</li>
<li>使用自定义的类，SQL会自动解析类的属性字段key和value</li>
</ul>
</li>
</ol>
<h5 id="参数的接收"><a href="#参数的接收" class="headerlink" title="参数的接收"></a>参数的接收</h5><ol>
<li><h6 id="参数类型"><a href="#参数类型" class="headerlink" title="参数类型"></a>参数类型</h6></li>
</ol>
<p>MyBatis 可以通过类型处理器（TypeHandler）自行推断出具体传入语句的参数。<br>为了可读性，可以使用<code>parameterType</code>指定参数类型：</p>
<ol>
<li>parameterType属性可选</li>
<li>默认值为未设置（unset）</li>
<li>如果有值，则需要类的全路径名，或起别名。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">"insertAuthor"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"domain.blog.Author"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><h6 id="参数值的接收"><a href="#参数值的接收" class="headerlink" title="参数值的接收"></a>参数值的接收</h6></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#&#123;id&#125;</span><br><span class="line">#&#123;middleInitial,jdbcType=VARCHAR&#125;</span><br><span class="line"></span><br><span class="line">几乎总是可以根据参数对象的类型确定 javaType，除非该对象是一个 HashMap</span><br><span class="line">#&#123;id,javaType=int,jdbcType=NUMERIC&#125;</span><br><span class="line">#&#123;height,javaType=double,jdbcType=NUMERIC,numericScale=2&#125;</span><br><span class="line"></span><br><span class="line">HashMap</span><br><span class="line">#&#123;age,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;</span><br></pre></td></tr></table></figure>
<h5 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h5><p>返回值类型，resultType 和 resultMap 只能同时使用一个。</p>
<h6 id="resultType"><a href="#resultType" class="headerlink" title="resultType"></a>resultType</h6><ol>
<li>返回值的类型，通常 MyBatis 可以推断出来。但是为了更加准确，可以使用。</li>
<li>任何基本类型都可以，包括字符串。</li>
<li>若简单返回多个列，则可使用包含期望属性的 Object 或 Map。</li>
<li>若要返回指定自定义类，则需要返回类的全路径名，或别名。</li>
<li>如果返回的是集合，那应该设置为集合包含的类型，而不是集合本身的类型。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"map"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"com.someapp.model.User"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"User"</span> /&gt;</span> <span class="comment">&lt;!-- 别名 --&gt;</span></span><br></pre></td></tr></table></figure>
<h6 id="resultMap"><a href="#resultMap" class="headerlink" title="resultMap"></a>resultMap</h6><p>resultMap是 MyBatis 最强大的特性。</p>
<p>resultType本质上是由MyBatis 在幕后自动创建一个 ResultMap，再根据属性名来映射列到 JavaBean 的属性上。</p>
<p>当列名和属性名不匹配，有2种方式，且这2种方式可以混用——提供了显式指定之后，未显式指定的字段，仍然采用自动映射。</p>
<img src="/want/2020/05/25/mybatis/resultMap.png" title="resultMap">
<ol>
<li>自动映射：可以采用原生sql的<code>as</code> + <code>resultType</code>：</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">    user_id             as "id",</span><br><span class="line">    user_name           as "userName",</span><br><span class="line">    hashed_password     as "hashedPassword"</span><br><span class="line">  from some_table</span><br><span class="line">  where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>显式映射：可以采用resultMap显式指定</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userResultMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"user_id"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"user_name"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"hashed_password"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">  select user_id, user_name, hashed_password</span><br><span class="line">  from some_table</span><br><span class="line">  where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>混用</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userResultMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"hashed_password"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">    user_id             as "id",</span><br><span class="line">    user_name           as "userName",</span><br><span class="line">    hashed_password</span><br><span class="line">  from some_table</span><br><span class="line">  where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>resultMap更深入的用法——处理 <strong>表关联</strong> 的返回值类型</p>
<p>无论是association，还是collection，一定要<strong>显式</strong>映射字段，否则将不能展示。</p>
<ol>
<li>association：关联</li>
</ol>
<p>案例：每个学生关联一位老师。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// !!! Student的属性中，包含Teacher</span></span><br><span class="line">    <span class="keyword">private</span> Teacher teacher;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"StudentTeacher"</span> <span class="attr">type</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"sid"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"sname"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 类型为Teacher的属性teacher，关联具体内容--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">association</span> <span class="attr">property</span>=<span class="string">"teacher"</span> <span class="attr">javaType</span>=<span class="string">"Teacher"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"tname"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">association</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getStudents"</span> <span class="attr">resultMap</span>=<span class="string">"StudentTeacher"</span> &gt;</span></span><br><span class="line">    select s.id sid, s.name sname, t.name tname</span><br><span class="line">    from student s,teacher t</span><br><span class="line">    where s.tid = t.id</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>collection：集合</li>
</ol>
<p>案例：每个老师关联一批学生。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// !!! Teacher的属性中，包含List&lt;Student&gt;</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Student&gt; students;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"TeacherStudent"</span> <span class="attr">type</span>=<span class="string">"Teacher"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span>  <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"tid"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span>  <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"tname"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"students"</span> <span class="attr">ofType</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"sid"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"sname"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"tid"</span> <span class="attr">column</span>=<span class="string">"tid"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getTeacher"</span> <span class="attr">resultMap</span>=<span class="string">"TeacherStudent"</span>&gt;</span></span><br><span class="line">  select </span><br><span class="line">  	s.id sid,</span><br><span class="line">  	s.name sname,</span><br><span class="line">  	t.name tname,</span><br><span class="line">  	t.id tid </span><br><span class="line">  from student s,teacher t</span><br><span class="line">  where s.tid = t.id and t.id=#&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>JavaType是用来指定pojo(java bean)中属性的类型</li>
<li>ofType指定的是映射到list集合属性中pojo的类型</li>
</ul>
<h3 id="动态sql标签"><a href="#动态sql标签" class="headerlink" title="动态sql标签"></a>动态sql标签</h3><p><a href="https://mybatis.org/mybatis-3/zh/dynamic-sql.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/dynamic-sql.html</a></p>
<p>本质还是sql，只是增加了逻辑判断</p>
<h4 id="where"><a href="#where" class="headerlink" title="where"></a>where</h4><ol>
<li>如后续没有条件，则不会插入where</li>
<li>如开头语句为and或or，则自动删除where后的and或or<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from blog</span><br><span class="line">&lt;where&gt;</span><br><span class="line">    and title like #&#123;title&#125;</span><br><span class="line">&lt;/where&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="set"><a href="#set" class="headerlink" title="set"></a>set</h4><ol>
<li>如果没有set后的条件语句，则不会插入set</li>
<li>删除多余逗号<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update blog</span><br><span class="line">&lt;set&gt;</span><br><span class="line">    &lt;if test=&quot;title != null&quot;&gt;</span><br><span class="line">        title = #&#123;title&#125;,</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;author != null&quot;&gt;</span><br><span class="line">        author = #&#123;author&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">&lt;/set&gt;</span><br><span class="line">where id=#&#123;id&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="trim"><a href="#trim" class="headerlink" title="trim"></a>trim</h4><ol>
<li>增加前缀</li>
<li>前面符号覆盖</li>
<li>增加后缀</li>
<li>后面符号覆盖<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;trim prefix=&quot;&quot; prefixOverrides=&quot;&quot; suffix=&quot;&quot; suffixOverrides=&quot;&quot;&gt;&lt;/trim&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>替代where<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;trim prefix=&quot;where&quot; prefixOverrides=&quot;and | or&quot;&gt;&lt;/trim&gt;</span><br></pre></td></tr></table></figure></p>
<p>替代set<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;trim prefix=&quot;set&quot; suffixOverrides=&quot;,&quot; /&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="if"><a href="#if" class="headerlink" title="if"></a>if</h4><ol>
<li>if分支，是否显示当前分支</li>
<li>test中书写表达式<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from blog</span><br><span class="line">&lt;where&gt;</span><br><span class="line">    &lt;if test=&quot;author != null&quot;&gt;</span><br><span class="line">        author like #&#123;author&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;title != null&quot;&gt;</span><br><span class="line">        and title like #&#123;title&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">&lt;/where&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="test"><a href="#test" class="headerlink" title="test"></a>test</h4><h5 id="如何判断等于条件？"><a href="#如何判断等于条件？" class="headerlink" title="如何判断等于条件？"></a>如何判断等于条件？</h5><ol>
<li>常量需要<code>==</code>加.toString()来转换，更稳定，推荐。</li>
<li>其他方式如.equal()  等，都存在风险。</li>
</ol>
<h5 id="如何判断使用-还是-？"><a href="#如何判断使用-还是-？" class="headerlink" title="如何判断使用=还是==？"></a>如何判断使用=还是==？</h5><p>根据变量值的类型来判断。注意char和String不是同一类型。</p>
<p><code>=</code>一个等号，会把<code>=</code>两边的值自动拆箱成基础数据类型。</p>
<ol>
<li>只要变量的值是【<strong>基础数值类型</strong>】就用“=”。因此只要变量值是【数值型】就用“=”</li>
<li>当传参的类型是Object的情况下，当Object的值为【<strong>单个的大小写字母或一些特殊字符串</strong>】会被转换成ASCII码，此时也用”=“。因此只要变量值是单个大写或小写字母就用“=”。</li>
</ol>
<p><code>==</code></p>
<ol>
<li>只要变量值是【<strong>字符串型</strong>】就用==</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"circuitType == 1 or circuitType == 2 or circuitType == 3"</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"circuitType == '1'.toString() or circuitType == '2'.toString() or circuitType == '3'.toString() or circuitType == '4'.toString()"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and 'hello'.toString() == username.toString()"</span>&gt;</span><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username.indexOf('ji') == 0"</span>&gt;</span> <span class="tag">&lt;/<span class="name">if</span>&gt;</span> <span class="comment">&lt;!-- 是否以什么开头 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username.indexOf('ji') &gt;= 0"</span>&gt;</span> <span class="tag">&lt;/<span class="name">if</span>&gt;</span> <span class="comment">&lt;!-- 是否包含某字符 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"username != null and username.lastIndexOf('ji') &gt; 0"</span>&gt;</span><span class="tag">&lt;/<span class="name">if</span>&gt;</span>  <span class="comment">&lt;!-- 是否以什么结尾 --&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="choose-when-otherwise"><a href="#choose-when-otherwise" class="headerlink" title="choose,when,otherwise"></a>choose,when,otherwise</h4><ol>
<li>switch分支，只选一分支</li>
<li>test中书写表达式<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from blog</span><br><span class="line">&lt;where&gt;</span><br><span class="line">    &lt;choose&gt;</span><br><span class="line">        &lt;when test=&quot;title != null&quot;&gt;</span><br><span class="line">            title like #&#123;title&#125;</span><br><span class="line">        &lt;/when&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;when test=&quot;author != null&quot;&gt;</span><br><span class="line">            and author like #&#123;author&#125;</span><br><span class="line">        &lt;/when&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;otherwise&gt;</span><br><span class="line">            and views like #&#123;views&#125;</span><br><span class="line">        &lt;/otherwise&gt;</span><br><span class="line">    &lt;/choose&gt;</span><br><span class="line">&lt;/where&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h4><p>【如果sql较复杂，建议还是在java层面操作】</p>
<ol>
<li>可遍历任何可迭代对象（List/set等，index是索引，item是元素）、Map对象（index是键， item是值）<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 使用在in中</span><br><span class="line">select * from blog</span><br><span class="line">where id in</span><br><span class="line">&lt;foreach</span><br><span class="line">    collection=&quot;list&quot; item=&quot;item&quot; index=&quot;index&quot;</span><br><span class="line">    open=&quot;(&quot;</span><br><span class="line">    close=&quot;)&quot;</span><br><span class="line">    separator=&quot;,&quot; </span><br><span class="line">&gt;</span><br><span class="line">    #&#123;item&#125;</span><br><span class="line">&lt;/foreach&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 使用在多个or或and拼接中</span><br><span class="line">select * from blog</span><br><span class="line">&lt;where&gt;</span><br><span class="line">&lt;foreach</span><br><span class="line">    collection=&quot;list&quot; item=&quot;id&quot;</span><br><span class="line">    open=&quot;and (&quot;</span><br><span class="line">    close=&quot;)&quot;</span><br><span class="line">    separator=&quot;or&quot;</span><br><span class="line">&gt;</span><br><span class="line">    id=#&#123;id&#125;</span><br><span class="line">&lt;/foreach&gt;</span><br><span class="line">&lt;/where&gt;</span><br></pre></td></tr></table></figure>
<h4 id="sql-include"><a href="#sql-include" class="headerlink" title="sql + include"></a>sql + include</h4><ol>
<li>抽取公共片段</li>
<li>复用</li>
</ol>
<p>注意：</p>
<ol>
<li>最好基于单表来定义sql片段，方便复用</li>
<li>sql片段中不要存在where标签，方便复用<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 定义</span><br><span class="line">&lt;sql id=&quot;common-sql&quot;&gt;</span><br><span class="line">    &lt;if test=&quot;author != null&quot;&gt;</span><br><span class="line">        author like #&#123;author&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">    &lt;if test=&quot;title != null&quot;&gt;</span><br><span class="line">        and title like #&#123;title&#125;</span><br><span class="line">    &lt;/if&gt;</span><br><span class="line">&lt;/sql&gt;</span><br><span class="line"></span><br><span class="line">// 调用</span><br><span class="line">select * from blog</span><br><span class="line">&lt;where&gt;</span><br><span class="line">    &lt;include refid=&quot;common-sql&quot;&gt;&lt;/include&gt;</span><br><span class="line">&lt;/where&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h4><p>可以在表达式以外，创建一个变量，并将其绑定到当前的上下文。</p>
<p>如下示例，将接收到的参数进行格式化处理，得到新的变量pattern</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectBlogsLike"</span> <span class="attr">resultType</span>=<span class="string">"Blog"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bind</span> <span class="attr">name</span>=<span class="string">"pattern"</span> <span class="attr">value</span>=<span class="string">"'%' + _parameter.getTitle() + '%'"</span> /&gt;</span></span><br><span class="line">  </span><br><span class="line">  SELECT * FROM BLOG WHERE title LIKE #&#123;pattern&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="script"><a href="#script" class="headerlink" title="script"></a>script</h4><p>使用场景不多，主要用于注解sql。在带注解的映射器<strong>接口类</strong>中使用<strong>动态 SQL</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Update</span>(&#123;<span class="string">"&lt;script&gt;"</span>,</span><br><span class="line">      <span class="string">"update Author"</span>,</span><br><span class="line">      <span class="string">"  &lt;set&gt;"</span>,</span><br><span class="line">      <span class="string">"    &lt;if test='username != null'&gt;username=#&#123;username&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">      <span class="string">"    &lt;if test='password != null'&gt;password=#&#123;password&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">      <span class="string">"    &lt;if test='email != null'&gt;email=#&#123;email&#125;,&lt;/if&gt;"</span>,</span><br><span class="line">      <span class="string">"    &lt;if test='bio != null'&gt;bio=#&#123;bio&#125;&lt;/if&gt;"</span>,</span><br><span class="line">      <span class="string">"  &lt;/set&gt;"</span>,</span><br><span class="line">      <span class="string">"where id=#&#123;id&#125;"</span>,</span><br><span class="line">      <span class="string">"&lt;/script&gt;"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateAuthorValues</span><span class="params">(Author author)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="占位符"><a href="#占位符" class="headerlink" title="占位符"></a>占位符</h3><p><code>${column}</code> 不能防止sql注入。会被直接替换</p>
<p><code>#{value}</code> 防止sql注入。会使用 <code>?</code> 预处理【创建 <code>PreparedStatement</code> 参数占位符，并通过占位符设置参数（就像 ? ）】</p>
<h4 id><a href="#" class="headerlink" title="${}"></a>${}</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Select</span>(<span class="string">"select * from user where $&#123;column&#125; = #&#123;value&#125;"</span>)</span><br><span class="line"></span><br><span class="line">而不是写三个</span><br><span class="line"><span class="meta">@Select</span>(<span class="string">"select * from user where email = #&#123;email&#125;"</span>)</span><br><span class="line"><span class="meta">@Select</span>(<span class="string">"select * from user where name = #&#123;name&#125;"</span>)</span><br><span class="line"><span class="meta">@Select</span>(<span class="string">"select * from user where id = #&#123;id&#125;"</span>)</span><br></pre></td></tr></table></figure>
<h5 id="模糊查询示例"><a href="#模糊查询示例" class="headerlink" title="模糊查询示例"></a>模糊查询示例</h5><p>由于$是参数直接注入的，导致大括号里面不能注明jdbcType</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">错误的用法</span><br><span class="line">like &apos;%$&#123;name, jdbcType=VARCHAR&#125;%&apos;</span><br><span class="line"></span><br><span class="line">正确的用法</span><br><span class="line">like &apos;%$&#123;name&#125;%&apos;</span><br></pre></td></tr></table></figure>
<h4 id="-1"><a href="#-1" class="headerlink" title="#{}"></a>#{}</h4><h5 id="模糊查询示例-1"><a href="#模糊查询示例-1" class="headerlink" title="模糊查询示例"></a>模糊查询示例</h5><p>因为#{…}解析成sql语句时候，会在变量外侧【自动加单引号’  ‘】，所以这里 % 需要使用双引号”  “，不能使用单引号 ‘  ‘，不然会查不到任何结果。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">like &quot;%&quot;#&#123;name, jdbcType=VARCHAR&#125;&quot;%&quot;</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">like CONCAT(&apos;%&apos;, #&#123;name, jdbcType=VARCHAR&#125;,&apos;%&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><ul>
<li><code>cache</code> – 该命名空间的缓存配置。</li>
<li><code>cache-ref</code> – 引用其它命名空间的缓存配置。</li>
</ul>
<h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>用途：将查询结果临时存在内存中，减少数据库交互，提高效率</p>
<p>适合：经常查询且稳定不易变的数据</p>
<p>Mybatis缓存：内置事务性查询<strong>Select</strong>缓存机制。</p>
<p>缓存顺序：</p>
<ol>
<li>先查询数据库拿到数据</li>
<li>存到一级缓存，一级缓存供一次会话中调用</li>
<li>一次会话结束，一级缓存转存到二级缓存</li>
</ol>
<p>调用顺序：</p>
<ol>
<li>先查询二级缓存</li>
<li>再查一级缓存</li>
<li>查询数据库</li>
</ol>
<h4 id="一级缓存（默认开启）"><a href="#一级缓存（默认开启）" class="headerlink" title="一级缓存（默认开启）"></a>一级缓存（默认开启）</h4><ol>
<li>sqlSession会话级缓存<ul>
<li>即，从sqlSession.open到sqlSession.close，同一sql只执行一次</li>
</ul>
</li>
<li>缓存失效：<ul>
<li>只要遇到增删改insert/delete/update，必定缓存失效</li>
<li>手动清理缓存,sqlSession.clearCache()</li>
<li>会自动使用LRU Least Recently Used算法，来清除不必要的缓存</li>
</ul>
</li>
</ol>
<h4 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h4><ol>
<li>namespace级别缓存（基于mapper.xml）</li>
<li>当会话关闭，一级缓存消失，才会将一级缓存对象保存到二级缓存中。【转存】</li>
<li>此时，依赖于namespace的另一个会话开启后，会从二级缓存中读取。</li>
</ol>
<h4 id="开启二级缓存"><a href="#开启二级缓存" class="headerlink" title="开启二级缓存"></a>开启二级缓存</h4><ol>
<li><p>保证全局开启缓存,即设置settings中的cacheEnabled属性为true。（该属性默认已开启）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;settings&gt;</span><br><span class="line">    &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&lt;/settings&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Mapper.xml文件中，增加<code>&lt;cache /&gt;</code>标签</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;mapper namespace=&quot;&quot;&gt;</span><br><span class="line">    &lt;cache /&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!--其他内容--&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>单个select语句也可以显示关闭/开启缓存，使用<code>useCache</code>属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;mapper namespace=&quot;&quot;&gt;</span><br><span class="line">    &lt;cache /&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;select id=&quot;&quot; useCache=&quot;false&quot;&gt;&lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="配置二级缓存"><a href="#配置二级缓存" class="headerlink" title="配置二级缓存"></a>配置二级缓存</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;cache</span><br><span class="line">    eviction=&quot;FIFO&quot;</span><br><span class="line">    flushInterval=&quot;60000&quot;</span><br><span class="line">    size=&quot;512&quot;</span><br><span class="line">    readOnly=&quot;true&quot;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<h5 id="清除策略eviction"><a href="#清除策略eviction" class="headerlink" title="清除策略eviction"></a>清除策略eviction</h5><table>
<thead>
<tr>
<th>类别</th>
<th>中文</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>LRU（默认）</td>
<td>最近最小使用</td>
<td>移除最长时间没使用的对象</td>
</tr>
<tr>
<td>FIFO</td>
<td>先进先出</td>
<td>按对象进入缓存的顺序来移除</td>
</tr>
<tr>
<td>SOFT</td>
<td>软引用</td>
<td></td>
</tr>
<tr>
<td>WEAK</td>
<td>弱引用</td>
</tr>
</tbody>
</table>
<h5 id="刷新间隔flushInterval"><a href="#刷新间隔flushInterval" class="headerlink" title="刷新间隔flushInterval"></a>刷新间隔flushInterval</h5><p>正整数，毫秒</p>
<h5 id="可缓存的引用数目size"><a href="#可缓存的引用数目size" class="headerlink" title="可缓存的引用数目size"></a>可缓存的引用数目size</h5><ol>
<li>正整数，默认值1024</li>
<li>最多可缓存的缓存数量</li>
</ol>
<h5 id="readOnly"><a href="#readOnly" class="headerlink" title="readOnly"></a>readOnly</h5><p>只读缓存会给所有调用者返回缓存对象相同的实例，这些对象不能被修改。</p>
<h4 id="二级缓存-自定义缓存"><a href="#二级缓存-自定义缓存" class="headerlink" title="二级缓存-自定义缓存"></a>二级缓存-自定义缓存</h4><p>工作缓存基本使用Redis!</p>
<h5 id="一个举例：Ehcache"><a href="#一个举例：Ehcache" class="headerlink" title="一个举例：Ehcache"></a>一个举例：Ehcache</h5><ol>
<li><p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!--mybatis-encache--&gt;</span><br><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.mybatis.caches/mybatis-ehcache --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis.caches&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-ehcache&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.2.1&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加入到mybatis的二级缓存中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;cache type=&quot;org.mybatis.caches.ehcache.EhcacheCache&quot;/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Ehcache配置项</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ehcache.xml</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>MyBatis 内置日志工厂会基于【运行时检测信息】选择日志委托实现。它会按下面罗列的顺序，使用第一个查找到的实现。当没有找到这些实现时，将会禁用日志功能。</p>
<ul>
<li>SLF4J</li>
<li>Apache Commons Logging</li>
<li>Log4j 2</li>
<li>Log4j</li>
<li>JDK logging</li>
</ul>
<p>即，当项目中已经包含了 Commons Logging，在这种配置环境下，MyBatis 会<strong>默认</strong>把 Commons Logging 作为日志工具。</p>
<p>如果你的应用部署在一个类路径已经包含 Commons Logging 的环境中，而你又想使用其它日志实现，你可以通过在 MyBatis 配置文件 mybatis-config.xml 里面添加一项 setting 来选择其它日志实现。可选的值有：SLF4J、LOG4J、LOG4J2、JDK_LOGGING、COMMONS_LOGGING、STDOUT_LOGGING、NO_LOGGING，</p>
<p>如果使用内置的日志工具STDOUT_LOGGING（仅控制台查看，不能输出文件），只需如下即可。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"STDOUT_LOGGING"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果使用Log4J 等更高级日志工具，则需要以下步骤：</p>
<ol>
<li>配置依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/log4j/log4j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置log4j.properties文件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">### 设置###</span><br><span class="line">log4j.rootLogger = debug,stdout,D,E</span><br><span class="line"></span><br><span class="line">### 输出信息到控制抬 ###</span><br><span class="line">log4j.appender.stdout = org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.Target = System.out</span><br><span class="line">log4j.appender.stdout.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern = [%-5p] %d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; method:%l%n%m%n</span><br><span class="line"></span><br><span class="line">### 输出DEBUG 级别以上的日志到=E://logs/error.log ###</span><br><span class="line">log4j.appender.D = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.D.File = .//logs/log.log</span><br><span class="line">log4j.appender.D.Append = true</span><br><span class="line">log4j.appender.D.Threshold = DEBUG </span><br><span class="line">log4j.appender.D.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.D.layout.ConversionPattern = %-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br><span class="line"></span><br><span class="line">### 输出ERROR 级别以上的日志到=E://logs/error.log ###</span><br><span class="line">log4j.appender.E = org.apache.log4j.DailyRollingFileAppender</span><br><span class="line">log4j.appender.E.File =.//logs/error.log </span><br><span class="line">log4j.appender.E.Append = true</span><br><span class="line">log4j.appender.E.Threshold = ERROR </span><br><span class="line">log4j.appender.E.layout = org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.E.layout.ConversionPattern = %-d&#123;yyyy-MM-dd HH:mm:ss&#125;  [ %t:%r ] - [ %p ]  %m%n</span><br><span class="line"></span><br><span class="line"># MyBatis 日志配置</span><br><span class="line">#log4j.logger.org.mybatis.example.BlogMapper=TRACE</span><br><span class="line"></span><br><span class="line">#为了实现更细粒度的日志输出，你也可以只打印特定语句的日志。以下配置将只打印语句 selectBlog 的日志：</span><br><span class="line">#log4j.logger.org.mybatis.example.BlogMapper.selectBlog=TRACE</span><br><span class="line"></span><br><span class="line">#你也可以打印一组映射器的日志，只需要打开映射器所在的包的日志功能即可</span><br><span class="line">#log4j.logger.org.mybatis.example=DEBUG</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Mybatis配置</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>使用。mybatis中的sql文件已经可以使用了。如果想在方法中使用日志，如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FgmKpiMapperTest</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> Logger logger = Logger.getLogger(FgmKpiMapperTest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getKpiList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"--------info------"</span>);</span><br><span class="line">        logger.debug(<span class="string">"--------debug------"</span>);</span><br><span class="line">        logger.error(<span class="string">"--------error------"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><pre class="mermaid">graph LR
A(分页) --> B(RowBounds面向对象,陈旧)
A --> C(sql limit手动,效率最高)
A -->D(插件PageHelper)
D --> D1(https://pagehelper.github.io/)</pre>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>官网：<a href="https://mybatis.org/mybatis-3/zh/index.html" target="_blank" rel="noopener">https://mybatis.org/mybatis-3/zh/index.html</a></p>
<p>maven依赖包官网：<a href="https://mvnrepository.com/" target="_blank" rel="noopener">https://mvnrepository.com/</a></p>
]]></content>
      <tags>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>单元测试</title>
    <url>/want/2021/05/13/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>单元测试（unit testing），是指对软件中的最小可测试单元进行检查和验证。在Java中单元测试的最小单元是类。</p>
<p>为什么写单元测试？</p>
<ol>
<li>保证或验证实现功能。</li>
<li>保护已经实现的功能不被破坏。</li>
</ol>
<p>只针对某一个功能点写测试，比如独立测试某类中的某个方法。但这个类和方法本身不是独立的，可能会去调用其他的类或方法。我们可以采用Mockito和PowerMock两种工具，来虚拟那些外部的、不容易构造的对象：</p>
<ol>
<li><p>Mockito：适用于大多数标准的单元测试。</p>
</li>
<li><p>PowerMock</p>
</li>
<li><ul>
<li>PowerMock在Mockito的基础上，额外增加了更多case（如static Method，final method, 枚举类， private method和Constructor）</li>
<li>PowerMock写法与Mockito基本相同，这是因为PowerMock是从Mockito的一个特殊的API衍化而来。比如当添加PowerMock Junit-module的maven依赖时时，其实还要导入Mockito-API。</li>
</ul>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.powermock<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>powermock-module-junit4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.powermock<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>powermock-api-mockito2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Mockito"><a href="#Mockito" class="headerlink" title="Mockito"></a>Mockito</h4><p>通过创建mock或spy对象，并制定具体返回规则来实现模拟的功能：</p>
<ol>
<li>mock对象对于未指定处理规则的调用，会按方法返回值类型返回该类型的默认值（如int、long则返回0，boolean则返回false，对象则返回null，void则什么都不做）</li>
<li>spy对象在未指定处理规则时则会直接调用真实方法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OpenServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @InjectMocks真正需要被测试的类</span></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IOpenService openService = <span class="keyword">new</span> OpenServiceImpl();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Mock创建虚拟对象(外部类等)</span></span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> IOpenWorkOrderDao openWorkOrderDao;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> ITunnelService tunnelService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getOpenDetailTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id = <span class="number">321</span>;</span><br><span class="line">        <span class="keyword">final</span> OpenWorkOrderEntity openWorkOrderEntity = <span class="keyword">new</span> OpenWorkOrderEntity() &#123;&#123;</span><br><span class="line">            <span class="keyword">this</span>.setId(id);</span><br><span class="line">            <span class="keyword">this</span>.setWorkOrderNo(<span class="string">"12"</span>);</span><br><span class="line">            <span class="keyword">this</span>.setCustomName(<span class="string">"tom"</span>);</span><br><span class="line">            <span class="keyword">this</span>.setApnType(<span class="number">1</span>);</span><br><span class="line">        &#125;&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mock的发生时机是当程序执行至”when-method-call-then-return”之类的语句时,可以测试类的逻辑流程</span></span><br><span class="line">        Mockito.when(openWorkOrderDao.selectOpenWorkOrderById(anyInt())).thenReturn(openWorkOrderEntity);</span><br><span class="line">        Mockito.doNothing().when(tunnelService).getTunnelInfo(any(OpenDetailDto<span class="class">.<span class="keyword">class</span>), <span class="title">anyInt</span>(), <span class="title">anyInt</span>())</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> OpenDetailDto openDetailDtoResult = openService.getOpenDetail(id);</span><br><span class="line">        <span class="comment">// Assertions.assertThat(openDetailDtoResult.getId()).isEqualTo(321);</span></span><br><span class="line">        Assertions.assertThat(openDetailDtoResult)</span><br><span class="line">                .extracting(<span class="string">"id"</span>, <span class="string">"workOrderNo"</span>, <span class="string">"customName"</span>, <span class="string">"apnType"</span>)</span><br><span class="line">                .contains(</span><br><span class="line">                        <span class="number">321</span>, <span class="string">"12"</span>, <span class="string">"name"</span>, <span class="number">1</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="PowerMock"><a href="#PowerMock" class="headerlink" title="PowerMock"></a>PowerMock</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.class)</span><br></pre></td></tr></table></figure>
<h4 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h4><p><code>SpringBoot</code>也是基于<code>Junit</code>进行单位测试的。</p>
<p>spring-boot-starter-test这个依赖中包含了：</p>
<ul>
<li>JUnit：Java 应用程序单元测试标准类库。</li>
<li>Spring Test &amp; Spring Boot Test：Spring Boot 应用程序功能集成化测试支持。</li>
<li>Mockito：一个Java Mock测试框架。</li>
<li>AssertJ：一个轻量级的断言类库。</li>
<li>Hamcrest：一个对象匹配器类库。</li>
<li>JSONassert：一个用于JSON的断言库。</li>
<li>JsonPath：一个JSON操作类库。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">  &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>打开IDEA，在任意类名、任意接口名上，按<code>ctrl+shift+t</code>，选择<code>Create New Test</code>。然后根据提示操作（默认即可），点击确认，就在项目的/test/java下的对应包里，生成了与类对应的测试类。</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513110038208.png" alt="image-20210513110038208"></p>
<p>或者，在任意类名、任意接口名上，按<code>Alt+Insert</code>，然后选择<code>Test</code>。然后根据提示操作（默认即可），点击确认，就在项目的/test/java下的对应包里，生成了与类对应的测试类。</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513125151127.png" alt="image-20210513125151127"></p>
<p>如果没有“Create New Test”，请更新idea版本或者在plugin中安装插件JUnitGenerator V2.0（仅支持到JUNIT4、3等老版本。idea升级后新版本不需要安装此插件）。</p>
<p>参阅：<a href="https://blog.csdn.net/e6486883/article/details/108073594" target="_blank" rel="noopener">Spring Boot：快速创建单元测试_e6486883的博客-CSDN博客_springboot创建测试单元</a></p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513110528189.png" alt="image-20210513110528189"></p>
<h4 id="代码覆盖率测试工具"><a href="#代码覆盖率测试工具" class="headerlink" title="代码覆盖率测试工具"></a>代码覆盖率测试工具</h4><p>Intellij IDEA集成了三种分析单元测试覆盖率的工具，包括IntelliJ IDEA、JaCoCo和Emma。</p>
<ol>
<li>IntelliJ IDEA，是idea默认自带的插件，统计出来的覆盖率只包含classes、method、line，不详细</li>
<li>JaCoCo，最常用。需要首先在Idea中选择JaCoCo模式，而后在项目的maven polm文件中进行依赖配置。</li>
</ol>
<h5 id="IntelliJ-IDEA使用步骤"><a href="#IntelliJ-IDEA使用步骤" class="headerlink" title="IntelliJ IDEA使用步骤"></a>IntelliJ IDEA使用步骤</h5><ol>
<li><p>Run → Edit Configurations</p>
</li>
<li><p>选择测试范围：指定要测试的包路径或类文件等</p>
</li>
</ol>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513135536067.png" alt="image-20210513135536067"></p>
<ol start="3">
<li><code>Code Coverage</code>选项卡可以调整覆盖率设置。<ul>
<li>Tracing mode模式会增加消耗，但测量会更精确。</li>
<li>可以设置记录覆盖信息的类或包，即最后生成的测试覆盖率报告里包含了哪些类或包。</li>
</ul>
</li>
</ol>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513135742771.png" alt="image-20210513135742771"></p>
<ol start="4">
<li>右键选择<code>Run &#39;All Tests&#39; with Coverage</code>，开始运行所有测试用例。运行完后，IDE将会在<code>Coverage</code>工具窗显示所有include进来的包/类的覆盖率数据，也可以导出测试覆盖率报告 。</li>
</ol>
<ul>
<li>红色方块：没有覆盖（在这一行中没有分支被执行）</li>
<li>黄色方块：部分覆盖（这一行的分支中只有一部分被执行）</li>
<li>绿色方块：完全覆盖（这一行的所有分支都被执行）</li>
</ul>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513140508548.png" alt="image-20210513140508548"></p>
<h5 id="JaCoCo使用步骤"><a href="#JaCoCo使用步骤" class="headerlink" title="JaCoCo使用步骤"></a>JaCoCo使用步骤</h5><ol>
<li>Run → Edit Configurations中设置为JaCoCo</li>
</ol>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513135742771.png" alt="image-20210513135742771"></p>
<ol start="2">
<li>maven配置</li>
</ol>
<p>添加依赖：配置JaCoCo插件一定注意和JDK版本的对应关系，如果是jdk1.8，则插件一定要用最新版，不然会报错误。g’g</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.jacoco&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.8.5&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>配置plugins</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">     &lt;groupId&gt;org.jacoco&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;0.8.5&lt;/version&gt;</span><br><span class="line">     &lt;configuration&gt;</span><br><span class="line">          &lt;destFile&gt;target/coverage-reports/jacoco-unit.exec&lt;/destFile&gt;</span><br><span class="line">          &lt;dataFile&gt;target/coverage-reports/jacoco-unit.exec&lt;/dataFile&gt;</span><br><span class="line">          &lt;includes&gt;</span><br><span class="line">               &lt;include&gt;**/service/**&lt;/include&gt;</span><br><span class="line">               &lt;include&gt;**/controller/**&lt;/include&gt;</span><br><span class="line">               &lt;!--&lt;include&gt;**/service/impl/*.class&lt;/include&gt;--&gt;</span><br><span class="line">          &lt;/includes&gt;</span><br><span class="line"></span><br><span class="line">		  &lt;!-- rules里面指定覆盖规则，在覆盖率不满足的情况下，mvn install会报错Build Failure --&gt;</span><br><span class="line">          &lt;rules&gt;</span><br><span class="line">               &lt;rule implementation=&quot;org.jacoco.maven.RuleConfiguration&quot;&gt;</span><br><span class="line">                    &lt;element&gt;BUNDLE&lt;/element&gt;</span><br><span class="line">                    &lt;limits&gt;</span><br><span class="line">                         &lt;!-- 指定方法覆盖到50% --&gt;</span><br><span class="line">                         &lt;limit implementation=&quot;org.jacoco.report.check.Limit&quot;&gt;</span><br><span class="line">                              &lt;counter&gt;METHOD&lt;/counter&gt;</span><br><span class="line">                              &lt;value&gt;COVEREDRATIO&lt;/value&gt;</span><br><span class="line">                              &lt;minimum&gt;0.50&lt;/minimum&gt;</span><br><span class="line">                     	 &lt;/limit&gt;</span><br><span class="line">                     	 </span><br><span class="line">                         &lt;!-- 指定分支覆盖到50% --&gt;</span><br><span class="line">                         &lt;limit implementation=&quot;org.jacoco.report.check.Limit&quot;&gt;</span><br><span class="line">                              &lt;counter&gt;BRANCH&lt;/counter&gt;</span><br><span class="line">                              &lt;value&gt;COVEREDRATIO&lt;/value&gt;</span><br><span class="line">                              &lt;minimum&gt;0.50&lt;/minimum&gt;</span><br><span class="line">                         &lt;/limit&gt;</span><br><span class="line">                         </span><br><span class="line">                         &lt;!-- 指定类覆盖到100%，不能遗失任何类 --&gt;</span><br><span class="line">                         &lt;limit implementation=&quot;org.jacoco.report.check.Limit&quot;&gt;</span><br><span class="line">                             &lt;counter&gt;CLASS&lt;/counter&gt;</span><br><span class="line">                             &lt;value&gt;MISSEDCOUNT&lt;/value&gt;</span><br><span class="line">                             &lt;maximum&gt;0&lt;/maximum&gt;</span><br><span class="line">                         &lt;/limit&gt;</span><br><span class="line">                    &lt;/limits&gt;</span><br><span class="line">               &lt;/rule&gt;</span><br><span class="line">          &lt;/rules&gt;</span><br><span class="line">     &lt;/configuration&gt;</span><br><span class="line">     &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">              &lt;!--在maven的initialize阶段，将Jacoco的runtime agent作为VM的一个参数传给被测程序，用于监控JVM中的调用。--&gt;</span><br><span class="line">               &lt;id&gt;jacoco-initialize&lt;/id&gt;</span><br><span class="line">               &lt;goals&gt;</span><br><span class="line">                	&lt;goal&gt;prepare-agent&lt;/goal&gt;</span><br><span class="line">               &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">          </span><br><span class="line">          &lt;!--这个check:对代码进行检测，控制项目构建成功还是失败--&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">               &lt;id&gt;check&lt;/id&gt;</span><br><span class="line">               &lt;goals&gt;</span><br><span class="line">                	&lt;goal&gt;check&lt;/goal&gt;</span><br><span class="line">               &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">          </span><br><span class="line">          &lt;!--report:对代码进行检测，然后生成index.html在 target/site/index.html中可以查看检测的详细结果--&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">               &lt;id&gt;jacoco-site&lt;/id&gt;</span><br><span class="line">               &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">               &lt;!--&lt;phase&gt;test&lt;/phase&gt;写上test的时候会自动出现site文件夹，而不需执行下面的jacoco:report步骤，推荐--&gt;</span><br><span class="line">               &lt;goals&gt;</span><br><span class="line">                	&lt;goal&gt;report&lt;/goal&gt;</span><br><span class="line">               &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">     &lt;/executions&gt; </span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>
<p>刷新maven，会发现多了一个插件:</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513144223695.png" alt="image-20210513144223695"></p>
<p>arget文件夹中会多出一个site文件夹（如果没有点击上述jacoco:report）。点击里面的index.html文件，用浏览器打开即可看到测试报告。</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210513144313023.png" alt="image-20210513144313023"></p>
<ol>
<li>maven配置</li>
</ol>
<p>执行<code>mvn install</code> 或者 <code>mvn test</code> 命令，获得 JaCoCo的统计数据。执行完以后，target/site/jacoco/目录下会生成一个index.html文件，这是统计数据总览页面，可以在浏览器打开查看。</p>
<h6 id="集成多模块报告"><a href="#集成多模块报告" class="headerlink" title="集成多模块报告"></a>集成多模块报告</h6><p>执行 <code>mvn clean package</code>（clean install）命令后，在项目的 ROOT\target\site\目录会生成 jacoco目录</p>
<h3 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h3><h4 id="Assert"><a href="#Assert" class="headerlink" title="Assert"></a>Assert</h4><ul>
<li>Assert.assertEquals 对比两个值相等</li>
<li>Assert.assertNotEquals 对比两个值不相等</li>
<li>Assert.assertSame 对比两个对象的引用相等</li>
<li>Assert.assertArrayEquals 对比两个数组相等</li>
<li>Assert.assertTrue 验证返回是否为真</li>
<li>Assert.assertFlase 验证返回是否为假</li>
<li>Assert.assertNull 验证null</li>
<li>Assert.assertNotNull 验证非null</li>
</ul>
<h4 id="Assertions"><a href="#Assertions" class="headerlink" title="Assertions"></a>Assertions</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p><a href="https://my.oschina.net/lineshtw/blog/747722" target="_blank" rel="noopener">「译」JUnit 5 系列：基础入门 - Linesh 林从羽 - OSCHINA - 中文开源技术交流社区</a></p>
<p><a href="https://www.cnblogs.com/jpfss/p/10955009.html" target="_blank" rel="noopener">JUnit 单元测试断言推荐 AssertJ - 星朝 - 博客园 (cnblogs.com)</a></p>
<p><a href="https://zuozewei.blog.csdn.net/article/details/86567263" target="_blank" rel="noopener">走进Java接口测试之流式断言库AssertJ_Mo小泽的技术博客-CSDN博客</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.assertj.core.api.Assertions;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本数据类型</span></span><br><span class="line">Assertions.assertThat(result).isEqualTo(<span class="number">123456</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象</span></span><br><span class="line">Assertions.assertThat(openDetailDtoResult)</span><br><span class="line">                .extracting(<span class="string">"id"</span>, <span class="string">"workOrderNo"</span>, <span class="string">"customName"</span>, <span class="string">"apnType"</span>)</span><br><span class="line">                .contains(</span><br><span class="line">                        <span class="number">321</span>, <span class="string">"12"</span>, <span class="string">"集团客户"</span>, <span class="number">1</span></span><br><span class="line">                );</span><br><span class="line"><span class="comment">// 数组</span></span><br><span class="line">Assertions.assertThat(listDto.getDataList())</span><br><span class="line">                .isNotEmpty()</span><br><span class="line">                .hasSize(<span class="number">2</span>)</span><br><span class="line">                .extracting(<span class="string">"id"</span>, <span class="string">"workOrderNo"</span>)</span><br><span class="line">                .contains(tuple(<span class="number">1</span>, <span class="string">"first"</span>), tuple(<span class="number">2</span>, <span class="string">"second"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map</span></span><br><span class="line">        Assertions.assertThat(queryParamsMap)</span><br><span class="line">                .hasSize(<span class="number">2</span>)</span><br><span class="line">                .containsKeys(<span class="string">"name"</span>, <span class="string">"age"</span>)</span><br><span class="line">                .contains(</span><br><span class="line">                        entry(<span class="string">"name"</span>, <span class="string">"nice"</span>),</span><br><span class="line">                        entry(<span class="string">"age"</span>, <span class="string">"23"</span>)</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">Collections.singletonList(<span class="string">"23"</span>)这个方法主要用于只有一个元素的优化，减少内存分配，无需分配额外的内存，可以从SingletonList内部类看得出来,由于只有一个element,因此可以做到内存分配最小化，相比之下ArrayList的DEFAULT_CAPACITY=<span class="number">10</span>个。</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRespErrorMessage</span><span class="params">(ReturnMessage&lt;?&gt; returnMessage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (returnMessage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.EMPTY;</span><br><span class="line">    &#125;</span><br><span class="line">    如果returnMessage.getErrorMessage()不为空，则返回returnMessage.getErrorMessage()</span><br><span class="line">    否则returnMessage.getErrorCode()不为空，则返回returnMessage.getErrorCode()，否则返回空</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(returnMessage.getErrorMessage())<span class="comment">//有errorMessage，返回之</span></span><br><span class="line">            .orElseGet(() -&gt; Optional.ofNullable(returnMessage.getErrorCode())<span class="comment">//否则返回errorCode</span></span><br><span class="line">                    .orElse(StringUtils.EMPTY));<span class="comment">//二者均为null，返回空字符串</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Expected :java.util.Arrays$ArrayList&lt;[SimpleResolver [/8.8.8.8:53], SimpleResolver [/114.114.114.114:53]]&gt;</span><br><span class="line">Actual   :java.util.ArrayList&lt;[SimpleResolver [/8.8.8.8:53], SimpleResolver [/114.114.114.114:53]]&gt;</span><br><span class="line"></span><br><span class="line">Arrays.asList():得到的类型是java.util.Arrays$ArrayList，而非java.util.ArrayList</span><br><span class="line"></span><br><span class="line">使用Arrays.asList()的原因无非是想将数组或一些元素转为集合,而你得到的集合并不一定是你想要的那个集合。</span><br><span class="line"></span><br><span class="line">而一开始asList的设计时用于打印数组而设计的，但jdk1.5开始，有了另一个比较更方便的打印函数Arrays.toString(),于是打印不再使用asList()，而asList()恰巧可用于将数组转为集合。</span><br><span class="line"></span><br><span class="line">isEqualTo()比较引用地址，所以不相等，对象时使用isEqualToComparingFieldByFieldRecursively</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/qq_34802416/article/details/84192236" target="_blank" rel="noopener">https://blog.csdn.net/qq_34802416/article/details/84192236</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import org.junit.Test;</span><br><span class="line">而不是别的</span><br></pre></td></tr></table></figure>
<p>私有方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.class)</span><br><span class="line">class ExportUtilTest &#123;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">     void setRequestId() throws Exception &#123;</span><br><span class="line">         ReturnMessage returnMessage = new ReturnMessage();</span><br><span class="line"></span><br><span class="line">         ReturnMsgUtil returnMsgUtil = new ReturnMsgUtil();</span><br><span class="line">         Whitebox.invokeMethod(returnMsgUtil, &quot;setRequestId&quot;, returnMessage);</span><br><span class="line">         Assertions.assertThat(returnMessage.getRequestId()).doesNotContain(&quot;-&quot;).hasSize(32);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>私有属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RunWith(PowerMockRunner.class)</span><br><span class="line">public class TldCacheTest &#123;</span><br><span class="line">    @InjectMocks</span><br><span class="line">    private TldCache tldCache;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void isSupportedTldTest() throws IllegalAccessException &#123;</span><br><span class="line">        // 模拟私有属性</span><br><span class="line">        MemberModifier</span><br><span class="line">                .field(TldCache.class, &quot;tldSet&quot;)</span><br><span class="line">                .set(tldCache, new HashSet&lt;&gt;(Arrays.asList(&quot;cn&quot;, &quot;com&quot;, &quot;us&quot;)));</span><br><span class="line">        Boolean isSupported = tldCache.isSupportedTld(&quot;cn&quot;);</span><br><span class="line">        Assertions.assertThat(isSupported).isTrue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Set断言</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void getIdSetByPackage() throws IllegalAccessException &#123;</span><br><span class="line">    final HashMap&lt;PackageType, Set&lt;String&gt;&gt; typeToIdMap = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    typeToIdMap.put(PackageType.STANDARD, new HashSet&lt;&gt;(Arrays.asList(&quot;0&quot;, &quot;3=1&quot;)));</span><br><span class="line"></span><br><span class="line">    MemberModifier</span><br><span class="line">            .field(LineCache.class, &quot;typeToIdMap&quot;)</span><br><span class="line">            .set(lineCache, typeToIdMap);</span><br><span class="line"></span><br><span class="line">    Assertions.assertThat(lineCache.getIdSetByPackage(PackageType.STANDARD))</span><br><span class="line">            .hasSize(2).contains(&quot;0&quot;, &quot;3=1&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Junit常用注解说明"><a href="#Junit常用注解说明" class="headerlink" title="Junit常用注解说明"></a>Junit常用注解说明</h3><ul>
<li>@BeforeClass 加上这个注解，则该方法会第一个执行（在所有方法中），且方法要<strong>加上关键词static</strong>，是一个<strong>static方法</strong></li>
<li>@Before 带上@Test的方法执行前会执行该方法</li>
<li>@Test 加在<strong>待测试的方法</strong>前面，@Test(timeout = 1000)设置1000毫秒后超时</li>
<li>@After 带上@Test的方法执行完毕后会执行该方法</li>
<li>@AfterClass 加上这个注解，则该方法最后一个执行（在所有方法中）,同样，方法要<strong>加上关键词static</strong>，是一个<strong>static方法</strong></li>
</ul>
<p>一个单元测试类执行顺序为：</p>
<p>@BeforeClass -&gt; @Before -&gt; @Test -&gt; @After -&gt; @AfterClass</p>
<p>单元测试之使用H2 Database模拟数据库环境 <a href="http://coderec.cn/2016/08/09/单元测试之使用H2-Database模拟数据库环境/" target="_blank" rel="noopener">单元测试之使用H2 Database模拟数据库环境 | Coderec’s Blog</a></p>
<p><a href="http://www.h2database.com/html/grammar.html" target="_blank" rel="noopener">SQL Grammar (h2database.com)</a></p>
<p>单元测试之Mockito与PowerMock <a href="https://www.jianshu.com/p/51930cc5dcf9" target="_blank" rel="noopener">https://www.jianshu.com/p/51930cc5dcf9</a></p>
<p><a href="https://blog.csdn.net/qisibajie/article/details/79068086" target="_blank" rel="noopener">https://blog.csdn.net/qisibajie/article/details/79068086</a></p>
<p><a href="https://juejin.cn/post/6844903711483887623" target="_blank" rel="noopener">https://juejin.cn/post/6844903711483887623</a></p>
<p><strong>Mockito与PowerMock的使用基础教程</strong></p>
<p><a href="https://juejin.cn/post/6844903711483887623" target="_blank" rel="noopener">https://juejin.cn/post/6844903711483887623</a></p>
<h3 id="WEB测试"><a href="#WEB测试" class="headerlink" title="WEB测试"></a>WEB测试</h3><p>在Spring Boot项目里面可以直接使用JUnit对web项目进行测试，Spring 提供了“TestRestTemplate”对象，使用这个对象可以很方便的进行模拟请求。</p>
<p>Web测试只需要进行两步操作：</p>
<ol>
<li>在@SpringBootTest注解上设置“ebEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT”随机端口；</li>
<li>使用TestRestTemplate进行post或get请求；</li>
</ol>
<p>示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">webEnvironment</span> </span>= SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestRestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = restTemplate.getForObject(<span class="string">"/name"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(name);</span><br><span class="line">        Assert.assertEquals(<span class="string">"Adam"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中getForObject的含义代表执行get请求，并返回Object结果，第二个参数设置返回结果为String类型，更多的请求方法：</p>
<ul>
<li>getForEntity：Get请求，返回实体对象（可以是集合）；</li>
<li>postForEntity：Post请求，返回实体对象（可以是集合）；</li>
<li>postForObject：Post请求，返回对象；</li>
</ul>
<h3 id="数据库测试"><a href="#数据库测试" class="headerlink" title="数据库测试"></a>数据库测试</h3><p>测试数据操作时，如果给测试类上添加<code>@Transactional</code>，会让数据操作都在内存中完成，并不会真正的commit到数据库，将数据持久化操作截断。</p>
<ol>
<li>好处是：既可以测试数据操作方法，又不会污染数据库。</li>
<li>注意点是：数据持久化的过程不再真实，没有了commit的过程。从而会导致——<ul>
<li>无法保证 Entity 之间关联关系，唯一索引和主外键关联的准确性。</li>
<li>无法保证 Entity 创建时间、更新时间和版本化(乐观锁)的赋值逻辑的准确性。</li>
<li>无法保证 Entity 中有 @Transient 注解的属性的赋值逻辑的准确性。</li>
<li>测试的数据不是真实场景存在的问题。</li>
<li>测试中，单个事务中的准备数据，无法在多线程中共享。</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setName(<span class="string">"Adam"</span>);</span><br><span class="line">    user.setAge(<span class="number">19</span>);</span><br><span class="line">    user.setPwd(<span class="string">"123456"</span>);</span><br><span class="line">    userRepository.save(user);</span><br><span class="line">    System.out.println(<span class="string">"userId:"</span> + user.getId());</span><br><span class="line">    Assert.assertTrue(user.getId()&gt;<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集成测试"><a href="#集成测试" class="headerlink" title="集成测试"></a>集成测试</h3><ol>
<li>集成多个功能</li>
<li>加载 spring 框架，要启整个 Spring</li>
</ol>
<p>1.在class上加入@SpringBootTest 和@RunWith(SpringRunner.class)两个注解即可。</p>
<ul>
<li><code>@SpringBootTest</code>：获取启动类，加载配置，寻找主配置启动类（被 @SpringBootApplication 注解的类）</li>
<li><code>@RunWith(SpringRunner.class)</code>：让JUnit运行Spring的测试环境,获得Spring环境的上下文的支持</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class Test() &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>增加@Transactional支持回滚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">@Transactional</span><br><span class="line">public class Test() &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>增加@Transactional支持回滚的同时，单独设置方法不回滚（正常提交）<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest</span><br><span class="line">@Transactional</span><br><span class="line">public class Test() &#123;</span><br><span class="line"></span><br><span class="line">	// @Transactional的前提下，实现真正提交事务（即指定@Rollback(false)）</span><br><span class="line">	@Test</span><br><span class="line">	@Rollback(false)</span><br><span class="line">	void testCommit()&#123;&#125;</span><br><span class="line"></span><br><span class="line">	// @Transactional的前提下，默认会回滚（即@Rollback(True)）</span><br><span class="line">	@Test</span><br><span class="line">	void testRollBack()&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.在测试方法上加上@Test注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner::<span class="class"><span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Transactional</span></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">UserServiceImplTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> lateinit <span class="keyword">var</span> userServiceImpl: UserServiceImpl</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> userId = <span class="string">"CIDC-U-cd8e01a325ea4eb0bcf0b83f973d5d9f"</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function">fun <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AuthUserContext.setAuthUser(RequestUser(userId))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function">fun <span class="title">getUserInfoById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        val result = userServiceImpl.getUserInfoById(<span class="keyword">this</span>.userId)</span><br><span class="line">        assertNotNull(result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试私有方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">@RunWith(SpringJUnit4ClassRunner.class)</span><br><span class="line">@SpringBootTest(classes = Application.class)</span><br><span class="line">public class Test &#123;</span><br><span class="line"> </span><br><span class="line">    @Autowired</span><br><span class="line">    private Service service;</span><br><span class="line"> </span><br><span class="line">    @Test</span><br><span class="line">    public void test() throws NoSuchMethodException, ClassNotFoundException, IllegalAccessException, InstantiationException, InvocationTargetException &#123;</span><br><span class="line">        // 获取class</span><br><span class="line">        Class&lt;? extends Service&gt; clazz = service.getClass();</span><br><span class="line">        // 获取方法，注意param的类型</span><br><span class="line">        Method myPricateMothod= clazz.getDeclaredMethod(&quot;myPricateMothod&quot;, String.class);</span><br><span class="line">        myPricateMothod.setAccessible(true);</span><br><span class="line">        // 执行这个service，不要使用clazz.newInstance()，这个方法是新new一个对象</span><br><span class="line">        myPricateMothod.invoke(service, &quot;myparam&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">val targetClass = DomainServiceImpl::class.java</span><br><span class="line">val method: Method = targetClass.getDeclaredMethod(</span><br><span class="line">    &quot;createDomainInVendorWrapper&quot;,</span><br><span class="line">    DomainCreation::class.javaObjectType,</span><br><span class="line">    Vendor::class.javaObjectType</span><br><span class="line">) //获得method.注意,这里不能使用getMethod方法,因为这个方法只能获取public修饰的方法..</span><br><span class="line">method.setAccessible(true)</span><br><span class="line"></span><br><span class="line">val operatorServiceField: Field = targetClass.getDeclaredField(&quot;operatorService&quot;)</span><br><span class="line">operatorServiceField.setAccessible(true)</span><br><span class="line">operatorServiceField.set(domainService, operatorService)</span><br><span class="line"></span><br><span class="line">val instanceServiceField: Field = targetClass.getDeclaredField(&quot;instanceService&quot;)</span><br><span class="line">instanceServiceField.setAccessible(true)</span><br><span class="line">instanceServiceField.set(domainService, instanceService)</span><br><span class="line"></span><br><span class="line">val operateResult: Any = method.invoke(</span><br><span class="line">    domainService,</span><br><span class="line">    DomainCreation(&quot;abc.com&quot;, &quot;unit test&quot;, instancePO.instanceId),</span><br><span class="line">    Vendor.DNS_POD</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><code>ReflectionUtils</code>是<code>Spring</code>中一个常用的类，属于<code>spring-core</code>包；</p>
<p><code>ReflectionTestUtils</code>则属于<code>spring-test</code>包。</p>
<p>两者功能有重叠的地方，而<code>ReflectionUtils</code>会更强大。在单元测试时使用<code>ReflectionTestUtils</code>，能增加我们的便利性。</p>
<p>处理</p>
<p><a href="https://blog.csdn.net/zhuqiuhui/article/details/88215632" target="_blank" rel="noopener">UT中使用ReflectionTestUtils.setField不能mock掉依赖问题解决_苦行僧-CSDN博客_reflectiontestutils.setfield</a></p>
<p><a href="https://stackoverflow.com/questions/39989090/reflectiontestutils-not-working-with-autowired-in-spring-test" target="_blank" rel="noopener">service - ReflectionTestUtils not working with @Autowired in Spring Test - Stack Overflow</a></p>
<p>获取对象的成员变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getField</span><span class="params">(@Nullable Object targetObject, String name)</span></span></span><br></pre></td></tr></table></figure>
<p>给对象注入成员变量：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Class&lt;?&gt; targetClass, String name, @Nullable Object value)</span></span></span><br></pre></td></tr></table></figure>
<p>调用成员方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">invokeMethod</span><span class="params">(Object target, String name, Object... args)</span></span></span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210524162554542.png" alt="image-20210524162554542"></p>
<p>单元测试时测试一个private私有方法时，我们第一想法可能是用java反射机制。</p>
<p>…<br>Method method = clazz.getDeclaredMethod(methodName, classes)<br>method.setAccessible(true);<br>method.invoke(obj, objects)</p>
<p>Spring 有一个好用的测试工具类ReflectionTestUtils</p>
<p>…<br>ReflectionTestUtils.invokeMethod(Object target, String name, Object… args)</p>
<p>即可完成调用私有方法。</p>
<p>maven依赖：</p>
<p><dependency><br>      <groupid>org.springframework</groupid><br>      <artifactid>spring-test</artifactid><br>      <version>4.1.6.RELEASE</version><br>      <scope>test</scope><br>    </dependency><br>————————————————<br>版权声明：本文为CSDN博主「lijie2049」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br>原文链接：<a href="https://blog.csdn.net/lijie2049/article/details/84732723" target="_blank" rel="noopener">https://blog.csdn.net/lijie2049/article/details/84732723</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Unexpected exception, expected&lt;exception.DomainException&gt; but was&lt;java.lang.reflect.InvocationTargetException&gt;</span><br></pre></td></tr></table></figure>
<p>反射，异常处理</p>
<p><a href="https://www.baeldung.com/java-lang-reflect-invocationtargetexception" target="_blank" rel="noopener">What Causes java.lang.reflect.InvocationTargetException? | Baeldung</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">val targetClass = DomainServiceImpl::class.java</span><br><span class="line">val method: Method = targetClass.getDeclaredMethod(</span><br><span class="line">    &quot;handleExitedParentsDomainName&quot;,</span><br><span class="line">    String::class.java</span><br><span class="line">)</span><br><span class="line">method.setAccessible(true)</span><br><span class="line">val exception: Exception = assertThrows(InvocationTargetException::class.java) &#123;</span><br><span class="line">    method.invoke(domainService, domainName)</span><br><span class="line">&#125;</span><br><span class="line">Assertions.assertThat(exception.cause!!.javaClass).isEqualTo(DomainException::class.java)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    private fun getSubDomainPOList(domainName: String, withUser: Boolean, userId: String? = null): List&lt;DomainPO&gt;? </span><br><span class="line">    </span><br><span class="line">    val method: Method = targetClass.getDeclaredMethod(</span><br><span class="line">        &quot;getSubDomainPOList&quot;,</span><br><span class="line">        String::class.java,</span><br><span class="line">        Boolean::class.java,</span><br><span class="line">        String::class.java</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     private fun getDomainListByInstanceId(</span><br><span class="line">        instanceId: String, withUser: Boolean? = null, userId: String? = null</span><br><span class="line">): List&lt;DomainPO&gt;</span><br><span class="line">     val method: Method = targetClass.getDeclaredMethod(</span><br><span class="line">        &quot;getDomainListByInstanceId&quot;,</span><br><span class="line">        String::class.java,</span><br><span class="line">        Boolean::class.javaObjectType,</span><br><span class="line">        String::class.java</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.csdn.net/weixin_40763897/article/details/111956633" target="_blank" rel="noopener">Java类型与Kotlin类型对应关系_WongKyunban的博客-CSDN博客</a></p>
<p>MockMvc是由spring-test包提供，实现了对Http请求的模拟，能够直接使用网络的形式，转换到Controller的调用，使得测试速度快、不依赖网络环境。同时提供了一套验证的工具，结果的验证十分方便。</p>
<p>(1) mockMvc.perform执行一个请求。</p>
<p>(2) MockMvcRequestBuilders.get(“XXX”)构造一个请求。</p>
<p>(3) ResultActions.param添加请求传值 </p>
<p>(4) ResultActions.accept()设置返回类型 </p>
<p>(5) ResultActions.andExpect添加执行完成后的断言。</p>
<p>(6) ResultActions.andDo添加一个结果处理器，表示要对结果做点什么事情，比如处使用print()输出整个响应结果信息。</p>
<p>(7) ResultActions.andReturn表示执行完成后返回相应的结果。</p>
]]></content>
  </entry>
  <entry>
    <title>knotdns</title>
    <url>/want/2021/07/26/knotdns/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Knot ，High-performance authoritative-only DNS server</p>
<p><a href="https://www.saashub.com/compare-bind-vs-knot-dns?ref=dropdown" target="_blank" rel="noopener">BIND VS Knot DNS - compare differences &amp; reviews? (saashub.com)</a></p>
<ol>
<li>一个开源DNS软件</li>
</ol>
<ul>
<li>The first public release of Knot DNS (0.8) was published in <strong>2011</strong></li>
</ul>
<ol start="2">
<li><p>号称第3个支持完全RFC标准的DNS服务器(另外2个为: BIND &amp; NSD)</p>
<ul>
<li><p>more speed, less memory used, better security</p>
</li>
<li><p>由运营 .CZ 顶级域名的团队 CZ.NIC（捷克） 创建，Knot DNS 也为 .CZ TLD 提供支持</p>
</li>
</ul>
</li>
<li><p>一个高性能的权威 DNS 服务器</p>
<ul>
<li>3500K的QPS</li>
<li>每秒处理超过 50 万个查询</li>
<li>内存使用量保持在 BIND 9 以下</li>
<li>knot 3.0.0开始 支持 高性能XDP (AF_XDP) 模式, 可以显着提高 UDP 响应性能,但是需升级内核到 4.18.x(推荐使用 5.x 内核).</li>
<li>Knot 利用 userspace-rcu 库(Linux Kernel Read-Copy-Update (RCU) 用户空间实现版本) 技术消耗更多的内存来加速DNS响应:</li>
</ul>
</li>
</ol>
<p>授权协议: GPL / 操作系统: Linux / 开发语言: C</p>
<p>Both Knot DNS / Knot Resolver are <strong>open source</strong> and are completely <strong>free to download and use</strong>. The source code is available under <strong>GPL license</strong>.</p>
<p>Knot Resolver 是一个缓存 DNS 解析器，可以加速和保护 Linux 工作站上的 DNS 解析。</p>
<p>日志：<a href="http://dnstap.info/" target="_blank" rel="noopener">dnstap</a></p>
<p> Catalog Zones:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">knot DNS has processing of DNS Catalog Zones since Knot DNS Version 3.0.0, which was released on September 9, 2020.</span><br></pre></td></tr></table></figure>
<h3 id="简化的yaml语法："><a href="#简化的yaml语法：" class="headerlink" title="简化的yaml语法："></a>简化的yaml语法：</h3><ol>
<li>如果value包含空格或其他特殊字符，则需要将value放在双引号””中</li>
<li>注释<strong>#</strong></li>
<li>多个值[]</li>
<li>可在当前文件的顶层引入其他的配置文件<ul>
<li>文件路径可以是相对、绝对路径</li>
<li>文件路径可以使用正则表达式，eg. dir/*.conf</li>
<li><code>include: otherfilepath</code></li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">address: [10.0.0.1, 10.0.0.2]</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line">address: 10.0.0.1</span><br><span class="line">address: 10.0.0.2</span><br></pre></td></tr></table></figure>
<h3 id="knot-conf文件"><a href="#knot-conf文件" class="headerlink" title="knot.conf文件"></a>knot.conf文件</h3><p>There are 14 fixed sections ，Module sections are prefixed with the <strong>mod-</strong> prefix (e.g. <strong>mod-stats</strong>).</p>
<p><strong>module</strong>, </p>
<p><strong>server</strong>,</p>
<p><strong>key</strong>, </p>
<p><strong>acl</strong>, </p>
<p><strong>control</strong>, </p>
<p><strong>statistics</strong>, </p>
<p><strong>database</strong>,</p>
<p><strong>keystore</strong>,</p>
<p><strong>submission</strong>, </p>
<p><strong>policy</strong>,</p>
<p><strong>remote</strong>, </p>
<p><strong>template</strong>,</p>
<p> <strong>zone</strong>,</p>
<p> <strong>log</strong></p>
<h3 id="沟通交流"><a href="#沟通交流" class="headerlink" title="沟通交流"></a>沟通交流</h3><ol>
<li>Knot DNS官网<br>–<a href="http://www.knot-dns.cz/" target="_blank" rel="noopener">http://www.knot-dns.cz/</a></li>
<li>Issue tracking and source code<br>–<a href="https://gitlab.nic.cz/knot/knot-dns" target="_blank" rel="noopener">Knot projects / Knot DNS · GitLab (nic.cz)</a></li>
<li>Mailing list<br><a href="mailto:knot-dns-users@lists.nic.cz" target="_blank" rel="noopener">knot-dns-users@lists.nic.cz</a></li>
</ol>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载地址：<a href="https://www.knot-dns.cz/download/" target="_blank" rel="noopener">Download – Knot DNS (knot-dns.cz)</a></p>
<p>安装knot</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vim knot.repo</span><br><span class="line">[copr:copr.fedorainfracloud.org:group_cznic:knot-dns-latest]</span><br><span class="line">name=Copr repo for knot-dns-latest owned by @cznic</span><br><span class="line">baseurl=https://download.copr.fedorainfracloud.org/results/@cznic/knot-dns-latest/epel-7-$basearch/</span><br><span class="line">type=rpm-md</span><br><span class="line">skip_if_unavailable=True</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://download.copr.fedorainfracloud.org/results/@cznic/knot-dns-latest/pubkey.gpg</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">enabled_metadata=1</span><br><span class="line"></span><br><span class="line">yum list knot-*</span><br><span class="line"></span><br><span class="line">repotrack knot knot-utils knot-resolver -p /data/knot</span><br><span class="line">(yum install knot knot-utils knot-resolver -y)</span><br><span class="line"></span><br><span class="line">rpm -Uvh --force --nodeps *.rpm</span><br></pre></td></tr></table></figure>
<p>knot-utils——kdig等</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kdig +short @localhost . NS</span><br></pre></td></tr></table></figure>
<p>knotdns下载地址</p>
<p><a href="https://copr-be.cloud.fedoraproject.org/results/%40cznic/knot-dns-latest/" target="_blank" rel="noopener">Index of /results/@cznic/knot-dns-latest/ (copr-be.cloud.fedoraproject.org)</a></p>
<h4 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h4><p>下载地址：<a href="https://www.knot-dns.cz/download" target="_blank" rel="noopener">Download – Knot DNS (knot-dns.cz)</a></p>
<p>选择SourceCode Tarball</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar -xvf knot-3.0.8.tar.xz</span><br><span class="line">configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">#可能需要一些其他的依赖</span><br></pre></td></tr></table></figure>
<h4 id="centos7在线安装"><a href="#centos7在线安装" class="headerlink" title="centos7在线安装"></a>centos7在线安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install knot</span><br></pre></td></tr></table></figure>
<h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotd -v #查看版本号</span><br><span class="line"></span><br><span class="line">systemctl enable knot # 开机启动</span><br></pre></td></tr></table></figure>
<h4 id="master配置"><a href="#master配置" class="headerlink" title="master配置"></a>master配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">备份默认配置</span></span><br><span class="line">cat /etc/knot/knot.conf</span><br><span class="line">cp /etc/knot/knot.conf /etc/knot/knot.conf-default</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">去编辑配置文件</span></span><br><span class="line">vim /etc/knot/knot.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">手动生成域名zone文件</span></span><br><span class="line">vim /var/lib/knot/run.com.zone</span><br><span class="line">chown knot:knot run.com.zone</span><br><span class="line">chmod 640 run.com.zone</span><br><span class="line"><span class="meta">#</span><span class="bash">chown root:knot run.com.zone</span></span><br><span class="line">kzonecheck /var/lib/knot/run.com.zone</span><br><span class="line"></span><br><span class="line">systemctl restart knot</span><br><span class="line">systemctl status knot</span><br><span class="line"></span><br><span class="line">kdig @127.0.0.1 dns1.run.com -p 58</span><br><span class="line">kdig @10.154.5.163 dns1.run.com -p 58</span><br><span class="line">kdig dns1.run.com -p 58 #不可执行。。。</span><br></pre></td></tr></table></figure>
<p>Knot 配置文件 /etc/knot/knot.conf 使用简化的 YAML 格式。缩进4个空格。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> This is a sample of a minimal configuration file <span class="keyword">for</span> Knot DNS.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See knot.conf(5) or refer to the server documentation.</span></span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">    rundir: "/run/knot"</span><br><span class="line">    user: knot:knot #安装Knot时自动创建了用户knot</span><br><span class="line">    listen: [ 127.0.0.1@53, ::1@53 ]</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TSIG，keygen 生成</span></span><br><span class="line">key:</span><br><span class="line">  - id: tsigkey1.</span><br><span class="line">    algorithm: hmac-sha256</span><br><span class="line">    secret: base64-keyvalue</span><br><span class="line"></span><br><span class="line">log:</span><br><span class="line">  - target: syslog # syslog，stdout，stderr 或 文件名</span><br><span class="line">    any: info</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  - target: stdout</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    any: debug</span></span><br><span class="line"></span><br><span class="line">database:</span><br><span class="line">    storage: "/var/lib/knot"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">  authorized slaves ，定义备机</span></span><br><span class="line"><span class="meta">#</span><span class="bash">请注意，master接受多个remote列表。第一个remote具有最高优先级，其他remote用于故障转移。当服务器从列出的远程接收区域update通知时，该远程将是后续传输的首选。</span></span><br><span class="line">remote:</span><br><span class="line">  - id: slave1</span><br><span class="line">    address: 192.168.1.1@53</span><br><span class="line">    key: tsigkey1.</span><br><span class="line">  - id: slave2</span><br><span class="line">    address: 192.168.2.1@53</span><br><span class="line">    key: tsigkey1.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> the server<span class="string">'s access control lists (ACLs),若无ACL规则，则zone的所有行为都被拒绝</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果一个zone配置了多个acl,以第一个acl优先级最高</span></span><br><span class="line">acl:</span><br><span class="line">  - id: acl_axfr</span><br><span class="line">    action: transfer #用于接收来自slave的 AXFR 请求</span><br><span class="line">    key: tsigkey1. #Access based just on TSIG key</span><br><span class="line">  - id: acl_upme</span><br><span class="line">    address: 127.0.0.0/24</span><br><span class="line">    action: update #促进源自本地主机的 nsupdate 请求</span><br><span class="line">    key: tsigkey1.</span><br><span class="line">  - id: acl_primary</span><br><span class="line">    address: [ 127.0.0.0/24, 172.28.1.20 ]</span><br><span class="line">    action: [transfer, notify]</span><br><span class="line">  - id: deny_rule</span><br><span class="line">    address: 192.168.2.100</span><br><span class="line">    action: transfer #no action specified and deny on implies denial of all actions</span><br><span class="line">    deny: on </span><br><span class="line">  - id: owner_type_rule</span><br><span class="line">    action: update</span><br><span class="line">    update-type: [A, AAAA, MX] # Updates are only allowed to update records of the specified types</span><br><span class="line">    update-owner: name         # The allowed owners are specified by the list on the next line</span><br><span class="line">    update-owner-name: [a, b.example.com.] # Non-FQDN names are relative to the effective zone name</span><br><span class="line">    update-owner-match: equal  # The owners of records in an update must be exactly equal to the names in the list</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">可以添加多个模板。模板必须存在于 knot.conf 中，否则Knot启动时报错。</span></span><br><span class="line">template:</span><br><span class="line">  - id: default</span><br><span class="line">    storage: "/var/lib/knot"</span><br><span class="line">    file: "%s.zone"</span><br><span class="line">  - id: slave</span><br><span class="line">    storage: "/var/lib/knot/slave"</span><br><span class="line"></span><br><span class="line">zone:</span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="comment"># Primary zone</span></span></span><br><span class="line">  - domain: example.com</span><br><span class="line">  	file: "cpu-chow-local.zone" #可以没有file，若有，不允许是路径（template提供路径）</span><br><span class="line">    notify: slave1</span><br><span class="line">    acl: acl_axfr</span><br><span class="line">	acl: acl_upme</span><br><span class="line"><span class="meta">#</span><span class="bash">	template: template-id <span class="comment">#可以手动指定template</span></span></span><br><span class="line">	semantic-checks: on #语义检查，对zone文件进行额外的语法检查</span><br><span class="line">	disable-any: on #a -t ANY query to prevent DNS zone-reflection attacks</span><br><span class="line">    serial-policy: increment #确保动态更新将触发zone的序列号增量。</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">    <span class="comment"># Secondary zone</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">  - domain: example.net</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    master: primary</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    acl: acl_primary</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Configuration <span class="built_in">export</span> (Knot DNS 3.0.8)</span></span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">    rundir: "/run/knot"</span><br><span class="line">    user: "knot:knot"</span><br><span class="line">    listen: [ "127.0.0.1@53", "100.71.9.148@53", "100.73.9.148@53" ]</span><br><span class="line">    tcp-workers: 100</span><br><span class="line">    background-workers: 100</span><br><span class="line">    udp-workers: 100</span><br><span class="line">log:</span><br><span class="line">  - target: "syslog"</span><br><span class="line">    any: "info"</span><br><span class="line"></span><br><span class="line">database:</span><br><span class="line">    storage: "/var/lib/knot/confdb"</span><br><span class="line"></span><br><span class="line">mod-stats:</span><br><span class="line">  - id: custom</span><br><span class="line">    request-protocol: on</span><br><span class="line">    server-operation: on</span><br><span class="line">    request-bytes: off</span><br><span class="line">    response-bytes: off</span><br><span class="line"><span class="meta">#</span><span class="bash">    edns-presence: on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    flag-presence: on</span></span><br><span class="line">    response-code: on</span><br><span class="line"><span class="meta">#</span><span class="bash">    request-edns-option: on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    response-edns-option: on</span></span><br><span class="line">    reply-nodata: on</span><br><span class="line">    query-type: on</span><br><span class="line"><span class="meta">#</span><span class="bash">    query-size: on</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    reply-size: on</span></span><br><span class="line"></span><br><span class="line">statistics:</span><br><span class="line">    timer: 1</span><br><span class="line">    file: "/var/lib/knot/stats.yaml"</span><br><span class="line">    append: on</span><br><span class="line"></span><br><span class="line">template:</span><br><span class="line">  - id: "default"</span><br><span class="line">    storage: "/var/lib/knot"</span><br><span class="line">    file: "%s.zone"</span><br><span class="line">    global-module: mod-stats/custom</span><br><span class="line"></span><br><span class="line">zone:</span><br><span class="line">  - domain: "yx1.com."</span><br><span class="line"></span><br><span class="line">  - domain: "example.com."</span><br><span class="line"></span><br><span class="line">  - domain: "mascotdokky.com."</span><br></pre></td></tr></table></figure>
<h4 id="slave配置"><a href="#slave配置" class="headerlink" title="slave配置"></a>slave配置</h4><p>第二个 Knot 实例，需要创建第二个运行目录和存储位置。</p>
<p>利用/usr/sbin/knotc来启动运行指定配置文件的实例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/usr/sbin/knotc -c config-file [ command ]</span><br><span class="line">/usr/sbin/knotc -c /etc/knot/slave.conf</span><br><span class="line">/usr/sbin/knotd -c /etc/knot/knot.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动、停服</span></span><br><span class="line">knotd -d -c /etc/knot/knot.conf</span><br><span class="line">knotc -c knot.conf stop</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /run/snot /var/lib/snot</span><br><span class="line">chown knot:knot /run/snot /var/lib/snot</span><br><span class="line">chmod 755 /run/snot /var/lib/snot</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/knot/slave.conf</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">    listen: slaveIp@53</span><br><span class="line">    user: knot:knot</span><br><span class="line">    rundir: /run/snot</span><br><span class="line"></span><br><span class="line">key:</span><br><span class="line">  - id: tsigkey1.</span><br><span class="line">    algorithm: hmac-sha256</span><br><span class="line">    secret: base64-keyvalue</span><br><span class="line"></span><br><span class="line">template:</span><br><span class="line">  - id: default</span><br><span class="line">    storage: /var/lib/snot</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">slave必须设置。</span></span><br><span class="line">remote:</span><br><span class="line">  - id: master1 #自定义</span><br><span class="line">    address: 127.0.0.9@53</span><br><span class="line">    key: tsigkey1.</span><br><span class="line"></span><br><span class="line">acl:</span><br><span class="line">  - id: notify_from_master</span><br><span class="line">    address: 主机ip</span><br><span class="line">    action: notify #</span><br><span class="line">    key: tsigkey1.</span><br><span class="line"></span><br><span class="line">log:</span><br><span class="line">  - target: stdout</span><br><span class="line">    any: debug</span><br><span class="line"></span><br><span class="line">zone:</span><br><span class="line">  - domain: example.com</span><br><span class="line">    master: master1 #masterId</span><br><span class="line">    acl: notify_from_master</span><br></pre></td></tr></table></figure>
<h4 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tail -f /var/log/syslog</span><br></pre></td></tr></table></figure>
<p>### </p>
<h3 id="GeoIP"><a href="#GeoIP" class="headerlink" title="GeoIP"></a>GeoIP</h3><p>您想为世界各地的许多客户提供您的网站 <a href="http://www.example.com。您可以将站点数据存储在单个服务器上，供所有客户端访问。或者，您可能将站点的多个副本存储在世界各地的多个数据服务器上。" target="_blank" rel="noopener">www.example.com。您可以将站点数据存储在单个服务器上，供所有客户端访问。或者，您可能将站点的多个副本存储在世界各地的多个数据服务器上。</a></p>
<p>当客户端请求服务器的 IP 地址时，选择离客户端最近的服务器，从而节省路由时间并最大程度地减少延迟不是很好吗？</p>
<p>BIND、PowerDNS 和 Knot DNS等DNS 服务器中的 GeoIP，就是一种可以做到这一点的机制。</p>
<h4 id="Knot-DNS的GeoIP模块"><a href="#Knot-DNS的GeoIP模块" class="headerlink" title="Knot DNS的GeoIP模块"></a>Knot DNS的GeoIP模块</h4><p>两种不同的运行模式：</p>
<ol>
<li>subnet模式：在子网模式下，根据client源地址是属于 IPv4 还是 IPv6 地址的特定子网来选择适当的响应。不需要任何外部数据库，使用较为简单。</li>
<li>geodb模式：在 geodb 模式下，根据client地址关联的地理数据进行响应，这些数据是从一个 MaxMind 格式的外部 GeoIP 数据库中检索的，例如 GeoIP2 或免费的 GeoLite2。根据数据库，或模块的配置情况，响应的选择可以考虑客户的大陆、经济、城市、自治系统编号 (ASN)、互联网服务提供商 (ISP) 等因素。</li>
</ol>
<p>GeoIP模块支持DNSSEC。</p>
<h4 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h4><ol>
<li><p>为了测试geodb模式，需要下载解压免费的<a href="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.tar.gz" target="_blank" rel="noopener">GeoLite2 City</a>数据库。</p>
</li>
<li><p>vim example.com.zone</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">ORIGIN example.com.</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 3600</span></span><br><span class="line">@    SOA    dns1.example.com. hostmaster.example.com. (</span><br><span class="line">            2010111213  ; serial</span><br><span class="line">            6h          ; refresh</span><br><span class="line">            1h          ; retry</span><br><span class="line">            1w          ; expire</span><br><span class="line">            1d )        ; minimum</span><br><span class="line"></span><br><span class="line">     NS     dns1</span><br><span class="line">dns1 A      192.0.2.1</span><br><span class="line">www  A      203.0.113.50</span><br><span class="line">     TXT    "default server"</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>配置文件</li>
</ol>
<pre class="mermaid">graph TB
A(配置文件) --主配置-->B(/etc/knot/knot.conf)
A --subnet mode--> C(net.conf)
A --geodb mode--> D(geo.conf)</pre>

<h5 id="knot-conf"><a href="#knot-conf" class="headerlink" title="knot.conf"></a>knot.conf</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">    listen: 127.0.0.1@53</span><br><span class="line">    edns-client-subnet: on #启用 EDNS 客户端子网选项</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 子网模式</span></span><br><span class="line">mod-geoip:</span><br><span class="line">  - id: net </span><br><span class="line">    config-file: "/path/to/net.conf"</span><br><span class="line">    mode: subnet</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> geodb模式</span></span><br><span class="line">mod-geoip:</span><br><span class="line">  - id: geo </span><br><span class="line">    config-file: "/path/to/geo.conf"</span><br><span class="line">    mode: geodb</span><br><span class="line">    geodb-file: "/path/to/GeoLite2-City.mmdb"</span><br><span class="line">    geodb-key: [country/iso_code, city/names/en] #specifies a list of database keys，据此返回合适的response。Here we use the client’s economy referred to by its ISO code, and if available, their city specified by its name in English (note that the order in which the keys are given is important).</span><br><span class="line"></span><br><span class="line">zone:</span><br><span class="line">  - domain: example.com.</span><br><span class="line">    file: "/path/to/example.com.zone"</span><br><span class="line">    module: mod-geoip/net</span><br><span class="line">    module: mod-geoip/geo</span><br></pre></td></tr></table></figure>
<h5 id="net-conf"><a href="#net-conf" class="headerlink" title="net.conf"></a>net.conf</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.example.com: </span><br><span class="line">  - net: 192.0.2.0/24 </span><br><span class="line">    A: 192.0.2.50 </span><br><span class="line">  - net: 198.51.100.0/24 </span><br><span class="line">    A: 198.51.100.50</span><br></pre></td></tr></table></figure>
<p>如果客户端从 192.0.2.0-192.0.2.255 范围内的地址查询域 <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 的 A 记录，Knot 将响应 192.0.2.50，类似地使用第二个选项。如果客户端从其他地址发送查询，将收到来自 example.com 区域的默认的A记录返回值。</p>
<h5 id="geo-conf"><a href="#geo-conf" class="headerlink" title="geo.conf"></a>geo.conf</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">www.example.com: </span><br><span class="line">  - geo: &quot;CZ;Prague&quot; </span><br><span class="line">    A: 192.0.2.0 </span><br><span class="line">    TXT: &quot;Prague&quot; </span><br><span class="line">  - geo: &quot;CZ;Brno&quot; </span><br><span class="line">    A: 192.0.2.1 </span><br><span class="line">    TXT: &quot;Brno&quot;</span><br><span class="line">  - geo: &quot;CZ;*&quot;</span><br><span class="line">    A: 192.0.2.2</span><br><span class="line">    TXT: &quot;Czechia&quot;</span><br></pre></td></tr></table></figure>
<p>如果客户从Prague或Brno查询，将要返回指定的 A 和 TXT 记录。如果客户在捷克共和国CZ上述两个城市之外的地方进行查询，则适用第三个选项。 * 代表“任何城市”。最后，如果客户端从其他地方查询，则返回区域中的默认记录。</p>
<p>启动项目：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start knot</span><br><span class="line">或</span><br><span class="line">knotd -c /etc/knot/knot.conf</span><br></pre></td></tr></table></figure>
<p>子网模式示例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kdig @127.0.0.1 A www.example.com +subnet=192.0.2.66</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">得到192.0.2.50 </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">+subnet:specify different <span class="built_in">source</span> addresses and</span></span><br></pre></td></tr></table></figure>
<p>geodb模式示例</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kdig @127.0.0.1 TXT www.example.com +subnet=88.146.42.14</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">得到Brno</span></span><br></pre></td></tr></table></figure>
<h3 id="Knot-Resolver"><a href="#Knot-Resolver" class="headerlink" title="Knot Resolver"></a>Knot Resolver</h3><p> DNS 缓存解析器（caching DNS resolver）,可以帮助加速、保证安全的DNS解析。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kresd -h</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">默认监察localhost:53端口（通过kresd.conf修改ip:port），且一核cpu</span></span><br><span class="line">systemctl start kresd@1.service #single instance of kresd, responding on localhost</span><br><span class="line">systemctl status kresd@1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">开启及重启（reboot后启动）</span></span><br><span class="line">systemctl enable --now kresd@1.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">使用手册</span></span><br><span class="line">man kresd.systemd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">多核cpu-start和<span class="built_in">enable</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">如果您希望 kresd 在共享cache和sockets的同时利用所有可用内核的优势，您应该启用和启动与内核数量一样多的 kresd@.service 实例。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">通常，每个实例都只是命名为 kresd@N.service，其中 N 是十进制数。例如，启用和启动 3 个并发守护进程</span></span><br><span class="line">systemctl start kresd@1.service kresd@2.service kresd@3.service</span><br><span class="line">systemctl enable --now kresd@1.service kresd@2.service kresd@3.service</span><br><span class="line"><span class="meta">#</span><span class="bash">或者，bash &#123;&#125;批量start / <span class="built_in">enable</span></span></span><br><span class="line">systemctl enable --now kresd@&#123;1..4&#125;.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">或者批量start所有的enabled kresd daemons</span></span><br><span class="line">systemctl start kresd.target</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">The systemd-managed kresd service <span class="built_in">set</span> is grouped <span class="keyword">in</span> the system-kresd.slice slice.  The slice includes all running daemons (instances of kresd@.service).</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">多核restart (这个glob表达式不能用在start或<span class="built_in">enable</span>上)</span></span><br><span class="line">systemctl restart 'kresd@*'</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">systemd 管理的 kresd 服务集合 利用 system-kresd.slice 切片进行分组</span></span><br><span class="line"><span class="meta">#</span><span class="bash">该切片包括所有正在运行的守护进程（kresd@.service 的实例）。</span></span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/knot-resolver/kresd.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">示例文件/usr/share/doc/knot-resolver-5.3.2/examples/</span></span><br><span class="line"></span><br><span class="line">-- SPDX-License-Identifier: CC0-1.0</span><br><span class="line">-- vim:syntax=lua:set ts=4 sw=4:</span><br><span class="line">-- Refer to manual: https://knot-resolver.readthedocs.org/en/stable/</span><br><span class="line"></span><br><span class="line">-- Network interface configuration</span><br><span class="line">net.listen('127.0.0.1', 58, &#123; kind = 'dns' &#125;)</span><br><span class="line">net.listen('127.0.0.1', 853, &#123; kind = 'tls' &#125;)</span><br><span class="line">--net.listen('127.0.0.1', 443, &#123; kind = 'doh2' &#125;)</span><br><span class="line">--net.listen('::1', 58, &#123; kind = 'dns', freebind = true &#125;)</span><br><span class="line">--net.listen('::1', 853, &#123; kind = 'tls', freebind = true &#125;)</span><br><span class="line">--net.listen('::1', 443, &#123; kind = 'doh2' &#125;)</span><br><span class="line"></span><br><span class="line">-- Load useful modules</span><br><span class="line">modules = &#123;</span><br><span class="line">        'hints &gt; iterate',  -- Load /etc/hosts and allow custom root hints</span><br><span class="line">        'stats',            -- Track internal statistics</span><br><span class="line">        'predict',          -- Prefetch expiring/frequent records</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-- Cache size</span><br><span class="line">cache.size = 100 * MB</span><br></pre></td></tr></table></figure>
<p>##### </p>
<blockquote>
<p>两种DNS加密协议：</p>
<p>DoT：DNS-over-TLS， TCP port 853</p>
<p>DoH：DNS-over-HTTPS</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net.listen(&apos;192.0.2.1&apos;) # 53port,udp,unencrypted DNS queries</span><br><span class="line">net.listen(&apos;2001:db8::1&apos;)</span><br><span class="line">net.listen(net.eth0, 853, &#123; kind = &apos;tls&apos; &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="区域传输"><a href="#区域传输" class="headerlink" title="区域传输"></a>区域传输</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@fnc05 knot]# keymgr -t key_knsupdate</span><br><span class="line"># hmac-sha256:key_knsupdate:LNL9O44NLCGmSkvUH6IIF/7lljBpB2j0kkkbdB33xhA=</span><br><span class="line">key:</span><br><span class="line">  - id: key_knsupdate</span><br><span class="line">    algorithm: hmac-sha256</span><br><span class="line">    secret: LNL9O44NLCGmSkvUH6IIF/7lljBpB2j0kkkbdB33xhA=</span><br></pre></td></tr></table></figure>
<h3 id="动态更新"><a href="#动态更新" class="headerlink" title="动态更新"></a>动态更新</h3><p>动态更新是临时的（until the server stop）！！！</p>
<p>要想持久化，必须使用指定的配置database或者初始化默认database。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">knotc conf-init</span><br></pre></td></tr></table></figure>
<p>Knot DNS 使用zone parser（ Ragel 编写）来实现启动时快速加载zones。</p>
<h4 id="knotc"><a href="#knotc" class="headerlink" title="knotc"></a>knotc</h4><p>Knot DNS 使用“knotc”来动态的更改配置文件并重新加载服务器，以达到动态添加和删除区域的目的。</p>
<p>conf配置文件操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotc conf-init</span><br><span class="line">knotc conf-import /etc/knot/knot.conf （-f 会强制覆盖既有data.mdb。 从conf导出到data.mdb）</span><br><span class="line">knotc conf-export output.conf (从data.mdb导出到output.conf)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl stop knotc</span><br><span class="line"></span><br><span class="line">knotc conf-import /etc/knot/knot.conf （-f）</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生成了/var/lib/knot/confdb</span></span><br><span class="line"></span><br><span class="line">chown knot:knot /var/lib/knot/confdb -R</span><br><span class="line"></span><br><span class="line">systemctl start knotc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个配置数据库mdb，无法打开。</p>
<p>利用mdbtools工具：mdb-tables data.mdb 报错 File does not appear to be an Access database</p>
<p>利用windows的excel和access都打开失败。</p>
<p>目前只能： knotc conf-import conf  =》 data.mdb</p>
<p>然后要看的时候，再从data.mdb =》 conf文件，进行查阅</p>
</blockquote>
<h5 id="conf操作"><a href="#conf操作" class="headerlink" title="conf操作"></a>conf操作</h5><p>对conf文件的操作</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotc conf-init # 初始化,生成目录文件/var/lib/knot/confdb/data.mdb和/var/lib/knot/confdb/lock.mdb</span><br><span class="line">knotc conf-import knont.conf # con =&gt; db</span><br><span class="line">knotc conf-export knont.conf # db =&gt; conf,得到knont.conf文件</span><br></pre></td></tr></table></figure>
<h5 id="zone操作"><a href="#zone操作" class="headerlink" title="zone操作"></a>zone操作</h5><h6 id="动态增加want-com示例"><a href="#动态增加want-com示例" class="headerlink" title="动态增加want.com示例"></a>动态增加want.com示例</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@fnc05 knot]# knotc conf-begin</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-set 'zone[want.com]'</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-diff</span><br><span class="line">+zone.domain = want.com.</span><br><span class="line">[root@fnc05 knot]# knotc conf-commit</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-read 'zone.domain'</span><br><span class="line">zone.domain = lu.org.</span><br><span class="line">zone.domain = run.com.</span><br><span class="line">zone.domain = want.com.</span><br><span class="line">zone.domain = example.com.</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotc conf-set 'zone[catalog.default].catalog-role' 'interpret'</span><br><span class="line">knotc conf-set 'zone[catalog.default].catalog-template' 'default'</span><br><span class="line"></span><br><span class="line">zone:</span><br><span class="line">  - domain: "catalog.default."</span><br><span class="line">    notify: "slave"</span><br><span class="line">    acl: [ "acl_update", "acl_slave" ]</span><br><span class="line">    semantic-checks: "on"</span><br><span class="line">    catalog-role: "interpret"</span><br><span class="line">    catalog-template: "default"</span><br></pre></td></tr></table></figure>
<h6 id="动态删除want-com示例"><a href="#动态删除want-com示例" class="headerlink" title="动态删除want.com示例"></a>动态删除want.com示例</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@fnc05 knot]# knotc conf-begin</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-unset 'zone[want.com]'</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-diff</span><br><span class="line">-zone.domain = want.com.</span><br><span class="line">[root@fnc05 knot]# knotc conf-commit</span><br><span class="line">OK</span><br><span class="line">[root@fnc05 knot]# knotc conf-read 'zone.domain'</span><br><span class="line">zone.domain = lu.org.</span><br><span class="line">zone.domain = run.com.</span><br><span class="line">zone.domain = example.com.</span><br></pre></td></tr></table></figure>
<h6 id="安全增删zone"><a href="#安全增删zone" class="headerlink" title="安全增删zone"></a>安全增删zone</h6><p>安全修改zone文件的方法是<strong>首先冻结zone events)</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotc -b zone-freeze example.com.</span><br><span class="line">knotc -b zone-flush example.com. #刷新zone文件,对zone调用freeze后，可能还有zone操作（例如signing）在运行，导致冻结挂起。因此，使用阻塞模式来确保操作完成。然后可以将该zone刷新到文件中。</span><br><span class="line"></span><br><span class="line">vim example.com.zone #修改文件</span><br><span class="line"></span><br><span class="line">knotc -b zone-reload example.com. #load被修改的zone</span><br><span class="line">knotc zone-thaw example.com. #解冻</span><br></pre></td></tr></table></figure>
<h6 id="zone文件-增删解析记录"><a href="#zone文件-增删解析记录" class="headerlink" title="zone文件-增删解析记录"></a>zone文件-增删解析记录</h6><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">knotc conf-begin</span><br><span class="line">knotc conf-set 'zone[yun.com]'</span><br><span class="line">knotc conf-diff</span><br><span class="line">knotc conf-commit</span><br><span class="line">knotc conf-read 'zone.domain'</span><br><span class="line"></span><br><span class="line">vim /var/lib/knot/want.com.zone或者动态添加zone——</span><br><span class="line"><span class="meta">#</span><span class="bash">真正产生zone文件</span></span><br><span class="line">knotc zone-begin yun.com</span><br><span class="line">knotc zone-set yun.com @ 7200 SOA ns1 grover.yun.com. 1 86400 900 691200 3600</span><br><span class="line">knotc zone-set yun.com @ 3600 NS ns1</span><br><span class="line">knotc zone-set yun.com ns1 3600 A 1.1.1.2</span><br><span class="line">knotc zone-set yun.com @ 3600 A 1.1.1.3</span><br><span class="line">knotc zone-set yun.com www 3600 A 1.1.1.4</span><br><span class="line">knotc zone-diff yun.com</span><br><span class="line">knotc zone-commit yun.com</span><br><span class="line"></span><br><span class="line">knotc zone-abort yun.com #终止</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kdig @127.0.0.1 www.yun.com -p 58 +short</span><br><span class="line">kdig @127.0.0.1 www.yx1.com -p 58 +short</span><br><span class="line">cd /var/lib/knot</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">校验</span></span><br><span class="line">knotc zone-check example.com</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">获取每个zone文件的SOA情况</span></span><br><span class="line">knotc zone-read -- @ SOA</span><br><span class="line"></span><br><span class="line">knotc zone-read --</span><br><span class="line">knotc zone-read example.com</span><br><span class="line">knotc zone-read example.com ns1</span><br><span class="line">knotc zone-read example.com ns1 NS</span><br><span class="line">knotc zone-read example.com dns1 A</span><br></pre></td></tr></table></figure>
<h6 id="修改解析记录"><a href="#修改解析记录" class="headerlink" title="修改解析记录"></a>修改解析记录</h6><p>增加2条新记录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> knsupdate</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> server 192.168.1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> zone example.com.</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> origin example.com.</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ttl 3600</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> add test1.example.com. 7200 A 192.168.2.2</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> add test2 TXT <span class="string">"hello"</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> show</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> send</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> answer</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> quit</span></span><br></pre></td></tr></table></figure>
<p>虽然可以动态更改大多数配置参数或通过配置文件重新加载，但部分服务器中的一些参数需要重新启动服务器，以便更改生效。这些参数是：rundir、user、pidfile、tcp-reuseport、udp-workers、tcp-workers、background-workers 和 listen。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">获取当前服务配置</span></span><br><span class="line">knotc conf-read server</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重载所有配置</span></span><br><span class="line">knotc reload</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">获取当zones列表</span></span><br><span class="line">knotc conf-read zone.domain</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">获取 lu.com 区域的master</span></span><br><span class="line">knotc conf-read 'zone[lu.com].master'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">动态添加zone</span></span><br><span class="line">knotc conf-begin #开始</span><br><span class="line"></span><br><span class="line">knotc conf-set 'zone[lu.org]'</span><br><span class="line">knotc conf-set 'zone[lu.org].file' '/var/zones/example.org.zone'</span><br><span class="line">knotc conf-set 'server.identity' 'Knot DNS'</span><br><span class="line">knotc conf-set 'server.listen' '0.0.0.0@53' '::@53'</span><br><span class="line">knotc conf-set 'zone[example.com]'</span><br><span class="line">knotc conf-set 'zone.slave' 'slave2'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">取消配置</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> knotc conf-unset</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> knotc conf-unset <span class="string">'zone'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> knotc conf-unset <span class="string">'zone[example.com]'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> knotc conf-unset <span class="string">'zone[example.com].master'</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> knotc conf-unset <span class="string">'zone[example.com].master'</span> <span class="string">'remote2'</span> <span class="string">'remote5'</span></span></span><br><span class="line"></span><br><span class="line">knotc conf-commit #结束</span><br><span class="line">knotc conf-abort #放弃</span><br></pre></td></tr></table></figure>
<h3 id="主从同步"><a href="#主从同步" class="headerlink" title="主从同步"></a>主从同步</h3><p><a href="https://datatracker.ietf.org/doc/draft-ietf-dnsop-dns-catalog-zones/" target="_blank" rel="noopener">draft-ietf-dnsop-dns-catalog-zones-02 - DNS Catalog Zones</a></p>
<p><strong>kcatalogprint</strong> utility is provided to manage the catalog.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">warning: [yun.com.] notify, outgoing, remote 10.154.5.162@58, server responded with error 'NOTAUTH'</span><br></pre></td></tr></table></figure>
<h3 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h3><p><a href="https://zh.omatomeloanhikaku.com/how-to-choose-the-best-and-fastest-alternative-dns-server-12236" target="_blank" rel="noopener">如何选择最佳（和最快）备用DNS服务器 - 如何 - 2021 (omatomeloanhikaku.com)</a></p>
<p><a href="https://zhangyu.guru/performancetesting/2019/04/13/a-byte-of-performance-testing/" target="_blank" rel="noopener">压力测试简介 (zhangyu.guru)</a></p>
<p>windows <a href="https://www.grc.com/dns/benchmark.htm" target="_blank" rel="noopener">GRC’s | DNS Nameserver Performance Benchmark</a></p>
<ol>
<li>缓存的查询–返回解析器名称缓存中已经存在的域名的时间。</li>
<li>未缓存的查询–返回尚未在解析器的名称缓存中的子域名的时间。</li>
<li>Dotcom查找–为域名服务商咨询域名服务器选择的dotcom解析器的时间。</li>
</ol>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210802113606027.png" alt="image-20210802113606027"></p>
<p>并发用户数、响应时间、系统吞吐量间的关系。</p>
<p>负载的执行时间、传输速度、吞吐量、资源占用率</p>
<p>QPS（TPS）= 并发数/平均响应时间 或者 并发数 = QPS*平均响应时间</p>
<ul>
<li><p>首先需要明确系统的关键指标， 如：</p>
<ul>
<li>DNS服务每秒可以响应20W个查询请求</li>
<li>95%的查询请求响应时间在5ms以内</li>
<li>当请求量达到25W每秒时，其中的20W请求能正确处理，响应时间波动在5%以内</li>
</ul>
<p>其次需要明确资源限制，如：</p>
<ul>
<li>硬件：如网口速率，CPU核心数，内存大小，是否SSD，交换机速率等</li>
<li>OS：如内核版本，是否支持zero copy，是否支持bbr等</li>
<li>应用软件：如asyncio，coroutine，GIL，是否采用DPDK等</li>
</ul>
<p>接下来就需要定义压测的场景，如：</p>
<ul>
<li>A类内部DNS请求场景</li>
<li>A类转发外部DNS请求场景</li>
<li>AAAA类内部DNS请求场景</li>
</ul>
</li>
</ul>
<ol>
<li>基准测试：许多DNS提供商都专注于速度，只有运行基准测试才能告诉您哪种方法最适合您。</li>
</ol>
<ol>
<li>后端性能测试（Back-end Performance Test）<ol>
<li>性能测试工具模拟大量的并发用户请求，然后获取系统性能的各项指标</li>
<li>并发用户数、响应时间和系统吞吐量外，还包括各类资源的使用率，比如系统级别的CPU占用率、内存使用率、磁盘I/O和网络I/O等，再比如应用级别以及JVM级别的各类资源使用率指标等。</li>
<li>模拟的并发用户数，通常在「几百」到「几百万」的数量级，所以选择的性能测试工具，一定不是基于GUI的，而是要采用基于协议的模拟方式，也就是去模拟用户在GUI操作的过程中实际向后端服务发起的请求。</li>
</ol>
</li>
<li>前端性能测试（Front-end Performance Test）</li>
<li>代码级性能测试（Code-level Performance Test）</li>
<li>压力测试（Load/Stress Test）<ol>
<li>一般采用后端性能测试的方法，不断对系统施加压力，并验证系统化处于或长期处于临界饱和阶段的稳定性以及性能指标，并试图找到系统处于临界状态时的主要瓶颈点。所以，压力测试往往被用于系统容量规划的测试。</li>
</ol>
</li>
<li>配置测试（Configuration Test）<ol>
<li>通过性能基准测试（Performance Benchmark）建立性能基线（Performance Baseline）</li>
<li>在此基础上，调整配置</li>
<li>基于同样的性能基准测试，观察不同配置条件下系统性能的差异，根本目的是要找到特定压力模式下的最佳配置。<ol>
<li>宿主操作系统的配置；</li>
<li>应用服务器的配置</li>
<li>数据库的配置</li>
<li>JVM的配置</li>
<li>网络环境的配置</li>
</ol>
</li>
</ol>
</li>
<li>并发测试（Concurrence Test）</li>
<li>以及可靠性测试（Reliability Test）</li>
</ol>
<p>600万qps</p>
<p>2s</p>
<p><strong>生成queries.txt文件</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat want.com.zone  | awk &quot;&#123;print \$1,\$3&#125;&quot; | grep -E &quot;(NS|DS|A|AAAA|PTR|MX|SOA)$&quot; | sort -u -R &gt; queries.txt</span><br></pre></td></tr></table></figure>
<p><strong>dnsperf测试</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">dnsperf -c 1000 -d ./queries.txt -p 58 -s 10.144.85.96</span><br><span class="line">dnsperf -c 1000 -d ./130w.txt -p 58 -s 10.154.5.163</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-s     用来指定DNS服务器的IP地址，默认值是127.0.0.1</span><br><span class="line">-p     用来指定DNS服务器的端口，默认值是53</span><br><span class="line">-d     用来指定DNS消息的内容文件，该文件中包含要探测的域名和资源记录类型，见下文</span><br><span class="line">-t     用来指定每个请求的超时时间，默认值是3000ms</span><br><span class="line">-Q     用来指定本次压测的最大请求数，默认值是1000 (-q: 请求多少次)</span><br><span class="line">-c     用来指定并发探测数，默认值是100. dnsperf会从-d指定的文件中随机选取100个座位探测域名来发送DNS请求.</span><br><span class="line">-l     用来指定本次压测的时间，默认值是无穷大。</span><br><span class="line">-e     本选项通过EDNS0，在OPT资源记录中运用edns-client-subnet来指定真实的client ip. </span><br><span class="line"></span><br><span class="line">-P     指定用哪个传输层协议发送DNS请求，udp或者tcp。默认值是udp</span><br><span class="line">-f     指定用什么地址类型发送DNS请求，inet或者inet6。默认值是inet</span><br><span class="line">-v     除了标准的输出外，还输出每个相应码的个数。</span><br><span class="line">-h     打印帮助</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">  - domain: &quot;yx1.com.&quot;</span><br><span class="line"></span><br><span class="line">  - domain: &quot;want.com.&quot;</span><br><span class="line">  </span><br><span class="line">www.yx1.com A</span><br><span class="line">www.example.com A</span><br><span class="line">host1.example.com A</span><br><span class="line">www.mascotdokky.com A</span><br></pre></td></tr></table></figure>
<p><strong>kxdpgun Linux kernel 4.18+ is required.</strong></p>
<p><a href="https://www.knot-dns.cz/docs/latest/html/man_kxdpgun.html" target="_blank" rel="noopener">kxdpgun – DNS benchmarking tool — Knot DNS 3.1.0 documentation (knot-dns.cz)</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kxdpgun -t 120 -Q 6000000 -i ./queries.txt -b 5 -r -p 58 10.144.85.96</span><br></pre></td></tr></table></figure>
<p>the famous Winston Churchill’s quote may have come to your mind: “<strong>I only believe in statistics that I doctored myself</strong>“</p>
<p>通过具有10GbE网络连接的UDP每秒的峰值响应数超过50万。</p>
<p>We discovered one important thing while benchmarking DNS: <strong>the network card chipset</strong> can make a huge difference. As a rule of thumb, <strong>the Intel server NIC chipsets</strong> are never a bad choice.</p>
<p>网络芯片，导致巨大的差异。根据经验，英特尔服务器NIC芯片组从来都不是一个坏的选择。</p>
<p><a href="https://gitlab.nic.cz/knot/dns-benchmarking/-/tree/master" target="_blank" rel="noopener">Files · master · Knot projects / dns-benchmarking · GitLab (nic.cz)</a></p>
<h6 id="PF-RING"><a href="#PF-RING" class="headerlink" title="PF_RING"></a>PF_RING</h6><p>提高数据包捕获速度。高速数据包捕获库,通过它可以实现将通用 PC 计算机变成一个有效且便宜的<strong>网络测量工具箱</strong>,进行数据包和现网流量的分析和操作。</p>
<p>现状：CPU的多数时间都被用在把网卡接收到的数据包经过内核的数据结构队列发送到用户空间的过程中。也就是说是从<strong>网卡–&gt;内核</strong>， 再从<strong>内核–&gt;用户空间</strong>，这两个步骤，花去了大量CPU时间，从而导致没有其他时间用来进行数据包的进一步处理。在传输过程中<code>sk_buff</code>结构的多次拷贝，以及涉及用户空间和内核空间的反复系统调用极大的限制了接收报文的效率，尤其是对小报文的接收影响更为明显。</p>
<p> PF_RING提出的核心解决方案便是减少报文在传输过程中的拷贝次数。</p>
<p>robdns using PF_RING seems to be able to deliver about 1 million packets per second <em>per core</em>.</p>
<p>使用 PF_RING 的 robdns 似乎能够每秒每核传输大约 100 万个数据包。</p>
<p>查看网卡带宽</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifconfig</span><br><span class="line">ethtool eth0</span><br><span class="line">ethtool bond1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">Speed: 1000Mb/s</span></span><br></pre></td></tr></table></figure>
<p>查看内存RAM</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">free -h</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">376G</span></span><br></pre></td></tr></table></figure>
<p>查看CPU</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lscpu</span><br></pre></td></tr></table></figure>
<h6 id="Performance-Tuning"><a href="#Performance-Tuning" class="headerlink" title="Performance Tuning"></a>Performance Tuning</h6><ol>
<li>UDP workers：handle all network requests coming through UDP  protocol</li>
<li>TCP workers</li>
<li>Background workers：used to execute background operations (zone loading, zone updates, etc.)</li>
</ol>
<p>默认，Knot通过CPU核数来确定各个workers种类的合适数量（well-fitting）。</p>
<p>用户可以自定义每个workers 数量，通过配置 configuration/server section: <a href="https://www.knot-dns.cz/docs/2.7/html/reference.html#server-udp-workers" target="_blank" rel="noopener">udp-workers</a>, <a href="https://www.knot-dns.cz/docs/2.7/html/reference.html#server-tcp-workers" target="_blank" rel="noopener">tcp-workers</a>, <a href="https://www.knot-dns.cz/docs/2.7/html/reference.html#server-background-workers" target="_blank" rel="noopener">background-workers</a>.</p>
<p>当服务器落后于预期性能而 CPU 使用率低时，增加工作线程数：用户应该尝试将（相关类型的）worker 的数量稍微增加到 100 以上，如果性能变得更好，他可以决定进一步的精确设置。</p>
<p>工具：dnsperf</p>
<p>自变量：the number  of threads/processes</p>
<p>因变量：queries per second</p>
<p>多次迭代获取比较稳定的结果</p>
<p>运行操作系统：Linux 4.19.25-200.1.el7.bclinux.x86_64</p>
<p>knotd (Knot DNS), version 3.0.8</p>
<table>
<thead>
<tr>
<th>number of threads</th>
<th>qps</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
</tr>
<tr>
<td>3</td>
</tr>
</tbody>
</table>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210805110115421.png" alt="image-20210805110115421"></p>
<p>工具：pcap/tcpreplay based （<a href="https://www.yadifa.eu/benchmark" target="_blank" rel="noopener">Benchmark | YADIFA</a>）</p>
<p>自变量：qps（queries per second）(每秒查询量)</p>
<p>因变量：percentage of lost queries （丢失查询的百分比）</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210805110820737.png" alt="image-20210805110820737"></p>
<h3 id="Sender"><a href="#Sender" class="headerlink" title="Sender"></a>Sender</h3><ul>
<li>Server: HP ProLiant DL160 G5</li>
<li>CPU: 2x Quad core (Intel(R) Xeon(R) CPU E5405 @ 2.00GHz)</li>
<li>Memory: 4x 4GiB DDR2 (FB-DIMM DDR2 FB-DIMM Synchronous 667 MHz (1.5 ns))</li>
<li>NIC: Broadcom Corporation NetXtreme BCM5722 Gigabit Ethernet PCI Express</li>
<li>OS: Ubuntu 12.04 kernel 3.2.0 (minimal server install)</li>
</ul>
<h3 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h3><ul>
<li>Server: Supermicro X8DTU</li>
<li>CPU: 2x Quad core HT enabled (Intel(R) Xeon(R) CPU L5630 @ 2.13GHz)</li>
<li>Memory: 6x 8GiB (DIMM DDR-3-1333 1066 MHz (0.9 ns))</li>
<li>NIC: Intel Corporation 82576 Gigabit Network Connection</li>
<li>OS: Ubuntu 12.04 minimal server install or FreeBSD 8.2</li>
</ul>
<ol>
<li>创建具有6 00万个UDP DNS查询报文的单个PCAP文件。</li>
<li>在客户端上使用tcpreplay，以预置速率发送一些包 packets 到服务器上</li>
<li>回复率 = 10万qps * 80%的回复率 = 8万aps(answers per second)</li>
</ol>
<h1 id="措施"><a href="#措施" class="headerlink" title="措施"></a>措施</h1><ol>
<li>应尽量增加worker（相关类型的）的数量略高于100％，如果性能有所提升，再具体设置更细的具体数量。</li>
<li>升级，使用kxdpgun 发包</li>
</ol>
<p>10Gb 以太网是主要瓶颈</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@fnc13 bak]# lspci | grep -i 'eth'</span><br><span class="line">06:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">06:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">16:00.0 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme BCM5719 Gigabit Ethernet PCIe (rev 01)</span><br><span class="line">16:00.1 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme BCM5719 Gigabit Ethernet PCIe (rev 01)</span><br><span class="line">16:00.2 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme BCM5719 Gigabit Ethernet PCIe (rev 01)</span><br><span class="line">16:00.3 Ethernet controller: Broadcom Inc. and subsidiaries NetXtreme BCM5719 Gigabit Ethernet PCIe (rev 01)</span><br><span class="line">81:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">81:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line"></span><br><span class="line">扩展10G口，82599ES网卡</span><br></pre></td></tr></table></figure>
<p>网卡队列数64——是否48个队列最好？The number of nameserver threads/processes was set to 128</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ethtool -S ens5f0</span><br><span class="line">ethtool -S ens4f0</span><br><span class="line">队列数64</span><br></pre></td></tr></table></figure>
<h6 id="Sysctl-和-NIC-网卡-优化"><a href="#Sysctl-和-NIC-网卡-优化" class="headerlink" title="Sysctl 和 NIC (网卡)优化"></a><strong>Sysctl 和 NIC (网卡)优化</strong></h6><p>如果您的 NIC 驱动程序允许（请参阅 /proc/interrupts ），请手动设置 CPU (/proc/irq/$IRQ/smp_affinity)，以便每个 NIC 通道由唯一的 CPU 内核提供服务。您必须先关闭 irqbalance 服务以避免配置覆盖。</p>
<p><strong>Configure sysctl：</strong></p>
<p> <em>/etc/sysctl.conf</em> </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">socket_bufsize=1048576</span><br><span class="line">busy_latency=0</span><br><span class="line">backlog=40000</span><br><span class="line">optmem_max=20480</span><br><span class="line"></span><br><span class="line">net.core.wmem_max     = $socket_bufsize #发送窗口的最大大小</span><br><span class="line">net.core.wmem_default = $socket_bufsize #每一个TCP socket默认的用于TCP发送数据的缓存大小，字节</span><br><span class="line">net.core.rmem_max     = $socket_bufsize #每一个TCP socket最大的接收数据缓的最大存</span><br><span class="line">net.core.rmem_default = $socket_bufsize</span><br><span class="line">net.core.busy_read = $busy_latency</span><br><span class="line">net.core.busy_poll = $busy_latency</span><br><span class="line">net.core.netdev_max_backlog = $backlog</span><br><span class="line">net.core.optmem_max = $optmem_max</span><br></pre></td></tr></table></figure>
<p>Disable huge pages.</p>
<p>Configure your CPU to “performance” mode. This can be achieved depending on architecture, e.g. in BIOS, or e.g. configuring /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor to “performance”.</p>
<p><strong>Tune your NIC device with ethtool:</strong></p>
<p>网卡修改参数</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ethtool -A $dev autoneg off rx off tx off #自协商传输模式关闭</span><br><span class="line">ethtool -K $dev tso off gro off ufo off</span><br><span class="line">ethtool -G $dev rx 4096 tx 4096</span><br><span class="line">ethtool -C $dev rx-usecs 75</span><br><span class="line">ethtool -C $dev tx-usecs 75</span><br><span class="line">ethtool -N $dev rx-flow-hash udp4 sdfn</span><br><span class="line">ethtool -N $dev rx-flow-hash udp6 sdfn</span><br></pre></td></tr></table></figure>
<h6 id="DNS-Shotgun"><a href="#DNS-Shotgun" class="headerlink" title="DNS Shotgun"></a>DNS Shotgun</h6><p><a href="https://gitlab.labs.nic.cz/knot/shotgun" target="_blank" rel="noopener">https://gitlab.labs.nic.cz/knot/shotgun</a></p>
<p><a href="https://ripe79.ripe.net/programme/meeting-plan/dns-wg/" target="_blank" rel="noopener">https://ripe79.ripe.net/programme/meeting-plan/dns-wg/</a></p>
<ol>
<li>模拟真实的DNS基准Realistic DNS benchmarking</li>
<li>新的工具集</li>
</ol>
<p>DNS Shotgun操作步骤：</p>
<p>第1阶段：数据准备 </p>
<p>第2阶段：流量回复</p>
<p>第3阶段：绘制漂亮图表</p>
<p><a href="https://zhuanlan.zhihu.com/p/58896031" target="_blank" rel="noopener">「测试」 - 性能 &amp; 性能测试基本方法 - 未完成 - 知乎 (zhihu.com)</a></p>
<h3 id="knot-exporter"><a href="#knot-exporter" class="headerlink" title="knot_exporter"></a>knot_exporter</h3><p>rpm -ivh libffi-devel-3.0.13-19.el7.x86_64.rpm</p>
<p>cd Python-3.6.4/</p>
<p> make &amp;&amp; make install</p>
<p>pip3 install psutil -i <a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p>
<p>python3 -m pip install –upgrade –force pip</p>
<p> python3 -m pip install –upgrade –force pip -i <a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p>
<p> pip3 install libknot -i <a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p>
<p>pip3 install prometheus_client -i <a href="http://pypi.douban.com/simple/" target="_blank" rel="noopener">http://pypi.douban.com/simple/</a> –trusted-host pypi.douban.com</p>
<p> ./knot_exporter –knot-library-path /usr/lib64/libknot.so.11 –web-listen-addr 100.71.9.148</p>
<h3 id="日志-1"><a href="#日志-1" class="headerlink" title="日志"></a>日志</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kjournalprint -l 5 /var/lib/knot/journal groverchou.com</span><br></pre></td></tr></table></figure>
<h3 id="响应限速"><a href="#响应限速" class="headerlink" title="响应限速"></a>响应限速</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rate-limit 100; # 限制响应100qps以内</span><br><span class="line"> rate-limit-slip 2;</span><br></pre></td></tr></table></figure>
<p><a href="https://jpmens.net/2013/03/12/knot-dns-dynamic-updates-and-a-bit-of-rrl/" target="_blank" rel="noopener">Jan-Piet Mens :: Knot-DNS: Dynamic Updates and a bit of RRL (jpmens.net)</a></p>
<h3 id="tcpreplay"><a href="#tcpreplay" class="headerlink" title="tcpreplay"></a>tcpreplay</h3><p>tcpreplay 用于重放 UDP 流量、速率、 数据包总量。</p>
<p>在高速率下 tcpreplay 不会 有足够的分辨率来每秒输出请求的数据包，这会导致 X 轴上的条带。相信这对实验影响不大 虽然无法测试中间利率</p>
<p>抓包</p>
<p>准备一个 pcap 文件 （UDP IPv4 queries is prepared）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump udp -i bond0.1209 -n  -w dump-ip.pcap -v</span><br><span class="line">-i #是指定要抓取的网卡</span><br><span class="line">-w #指定结果保存的位置</span><br><span class="line"></span><br><span class="line">kdig @100.71.9.148 www.yx1.com -p 53 +short</span><br><span class="line">kdig @100.71.9.148 host1.example.com -p 53 +short</span><br><span class="line">kdig @100.71.9.148 www.mascotdokky.com -p 53 +short</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">使用tcpprep区分client和server端，生成cache文件。</span></span><br><span class="line">tcpprep -a client -i dump-ip.pcap -o dump-ip.cache</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">生成目的端口为80的报文缓存文件</span></span><br><span class="line">tcpprep -i dump-ip.pcap -o dump-ip.cache -p 80</span><br></pre></td></tr></table></figure>
<p> 对包文件进行改写：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcprewrite -e 192.85.1.2:192.85.2.2 </span><br><span class="line">--enet-dmac=00:15:17:2b:ca:14,00:15:17:2b:ca:15 </span><br><span class="line">--enet-smac=00:10:f3:19:79:86,00:10:f3:19:79:87 </span><br><span class="line">-c test.cache</span><br><span class="line">-i test.tcpdump </span><br><span class="line">-o 1.pcap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">把报文的端口修改为80-&gt;8080</span></span><br><span class="line">tcprewrite -r 80:8080 -i dump-ip.pcap -o dump-ip-test.pcap</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpreplay-edit #直接回放编辑后的报文，不生成中间文件</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpliveplay was designed to work only with TCP connections, as this is</span><br><span class="line">where client is required to send to the server data relevant for its</span><br><span class="line">responses (in regards to SEQ &amp; ACK numbers). This is not needed for UDP.</span><br></pre></td></tr></table></figure>
<p>该软件默认是线速发包，试验发现会有错误的包和乱序的包。配置为1000个包/s时，不会失序。</p>
<p>推测失序原因：在高速发包时，特别依赖于网卡，只要网卡有抖动，可能会导致client端和服务器端发送的包在通过DUT时，排序有问题。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpreplay -i bond0.1209 -l 0 -p 100 dump-ip.pcap </span><br><span class="line">tcpreplay -i bond0.1209 -I bond0.1209 -p 1000 -c dump-ip.cache  dump-ip.pcap</span><br><span class="line">tcpreplay -i bond0.1209 -I bond0.1209 -l 0 -p 1000 -c dump-ip.cache  dump-ip.pcap</span><br><span class="line"></span><br><span class="line">tcpreplay-edit --unique-ip -l 1000 -M 1000 -i bond0.1209 dump-ip.pcap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">以最快的速度循环播放1000次</span></span><br><span class="line">tcpreplay -i bond0.1209 -t -K -l 1000 -M 1000  dump-ip.pcap</span><br><span class="line"><span class="meta">#</span><span class="bash">或者以每秒 100 个数据包的速率继续重播一分钟：</span></span><br><span class="line">tcpreplay -i bond0.1209 -K --pps 100 --duration 60  dump-ip.pcap</span><br><span class="line"></span><br><span class="line">tcpreplay-edit --unique-ip -l 1000 -M 1000 -i bond0.1209 dump-ip.pcap</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-i : 设置报文回放的出端口，即报文是从这台linux的哪个端口出去的。</span><br><span class="line">-l : 设置报文回放的次数， 1 即为一次， 0 为不断循环回放。</span><br><span class="line">-p: 设置报文回放的速度，每秒多少个包，这里设置为100即为每秒回放100个包。</span><br><span class="line">最后的为指定回放的是哪个pcap 报文。</span><br><span class="line"> </span><br><span class="line">-K的作用就是将数据包预先读取到内存中.发出数据包时就可以不受硬盘读写速度的限制，保证较为稳定的流量。</span><br><span class="line"></span><br><span class="line">由于内存的限制，不可能将很大的PCAP文件读取到内存中，我们可以利用tcpreplay-edit的loop功能配合一些选项，让数据包不断循环回放，从而达到延长测试时间的目的。</span><br><span class="line"></span><br><span class="line">-unique-ip的作用是每一次循环回放时，都修改数据包中的IP地址，从而形成新的流。-l是循环回放PCAP文件。</span><br></pre></td></tr></table></figure>
<h3 id="DNSSEC"><a href="#DNSSEC" class="headerlink" title="DNSSEC"></a>DNSSEC</h3><h3 id="reuseport"><a href="#reuseport" class="headerlink" title="reuseport"></a>reuseport</h3><p>reuseport是一种套接字复用机制，它允许你将多个套接字bind在同一个IP地址/端口对上，这样一来，就可以建立多个服务来接受到同一个端口的连接。<br>using reuseport for UDP<br>2021-08-06T14:22:32+0800 info: <strong>binding to interface</strong> 127.0.0.1@58<br>2021-08-06T14:22:32+0800 info: <strong>binding to interface</strong> 10.154.5.163@58<br>2021-08-06T14:22:32+0800 info: <strong>binding to interface</strong> ::1@58</p>
<p>对于不同的内核，处理机制是不一样的，总的说来，reuseport分为两种模式，即热备份模式和负载均衡模式，在早期的内核版本中，即便是加入对reuseport选项的支持，也仅仅为热备份模式，而在3.9内核之后，则全部改为了负载均衡模式，两种模式没有共存</p>
<p><a href="https://blog.groverchou.com/2020/08/10/Knot-DNS-使用教程/" target="_blank" rel="noopener">Knot DNS 使用教程 (groverchou.com)</a></p>
<p><a href="https://blog.csdn.net/force_eagle/article/details/108821280" target="_blank" rel="noopener">knot DNS 01 Tips_奋斗中拥有-CSDN博客</a></p>
<p><a href="https://www.haiyun.me/archives/1398.html" target="_blank" rel="noopener">ubuntu安装Knot 域名权威Authoritative DNS服务器配置ddns动态更新ip - 海运的博客 (haiyun.me)</a></p>
<p><a href="https://www.linuxjournal.com/content/knot-dns-one-tame-and-sane-authoritative-dns-server" target="_blank" rel="noopener">Knot DNS: One Tame and Sane Authoritative DNS Server | Linux Journal</a></p>
<p><a href="https://blog.apnic.net/2018/11/14/geoip-in-knot-dns-2-7/" target="_blank" rel="noopener">GeoIP in Knot DNS 2.7 | APNIC Blog</a></p>
<p><a href="https://www.ctrl.blog/entry/knot-dns-resolver-tutorial.html" target="_blank" rel="noopener">Get faster and more secure DNS resolution with Knot Resolver on Fedora (ctrl.blog)</a></p>
<p><a href="https://dnsmonitor.com/dns-tutorial-1-the-basics/#Top_1" target="_blank" rel="noopener">DNS Tutorial part 1 – DNS basics – DNS monitor</a></p>
<p>统计</p>
<p><a href="https://fossies.org/linux/knot/src/knot/modules/stats/stats.rst" target="_blank" rel="noopener">Knot DNS: src/knot/modules/stats/stats.rst | Fossies</a></p>
]]></content>
  </entry>
  <entry>
    <title>Java</title>
    <url>/want/2019/02/21/Java/</url>
    <content><![CDATA[<p>Java8帮助API文档：</p>
<p><a href="https://docs.oracle.com/javase/8/docs/api/?xd_co_f=278ba860ac89178ee421598661572254" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/api/?xd_co_f=278ba860ac89178ee421598661572254</a></p>
<h3 id="三大版本"><a href="#三大版本" class="headerlink" title="三大版本"></a>三大版本</h3><p>javaSE：标准版，基础、核心（控制台开发、桌面程序）</p>
<p>javaEE：企业级开发，广泛应用（web端，服务器开发）</p>
<p>javaME：嵌入式开发，基本没人使用。（手机、小家电）</p>
<h3 id="JDK-JRE-JVM"><a href="#JDK-JRE-JVM" class="headerlink" title="JDK/JRE/JVM"></a>JDK/JRE/JVM</h3><p>JDK：java development kit。 java开发环境。</p>
<p>JRE：java runtime environment。java运行环境。</p>
<p>JVM：java virtual machine。 java虚拟机（模拟了一个虚拟机专门运行java程序，屏蔽了底层操作系统的差异）</p>
<p>JDK包含JRE，JRE包含JVM。<code>JDK ( JRE (JVM) )</code></p>
<p><img src="F:\java\jdk.jpg" alt="jdk"></p>
<p>java结构图： <a href="https://docs.oracle.com/javase/8/docs/" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/</a></p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200829164337413.png" alt="image-20200829164337413"></p>
<h3 id="程序运行的两种机制"><a href="#程序运行的两种机制" class="headerlink" title="程序运行的两种机制"></a>程序运行的两种机制</h3><ol>
<li>编译型compile，预先翻译好。（c、c++）</li>
<li>解释型，随着运行随着翻译。（javascript等）</li>
</ol>
<p>因为现在电脑性能比较高，所以解释型编译型的效率差距无关痛痒。</p>
<p>java两者兼而有之，先javac编译成class文件，再在jvm中解释class文件。</p>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ol>
<li>下载jdk7 / jdk8</li>
<li>配置环境变量<ul>
<li>JAVA_HOME  <strong>F:\xxxx\jdk1.8*</strong> </li>
<li>PATH  <strong>%JAVA_HOME%\bin</strong> 和 <strong>%JAVA_HOME%\jre\bin</strong><ul>
<li>%是应用变量的意思</li>
</ul>
</li>
</ul>
</li>
<li>java -version 发现java已经安装</li>
</ol>
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><ol>
<li>删除java安装目录</li>
<li>删除环境变量：JAVA_HOME / path下java相关</li>
<li>java -version 发现java已经被卸载</li>
</ol>
<h4 id="jdk目录简介"><a href="#jdk目录简介" class="headerlink" title="jdk目录简介"></a>jdk目录简介</h4><p>bin    可执行文件，比如javac</p>
<p>include    jdk使用c编写，此处是c引用的头文件</p>
<p>jre    java的运行环境</p>
<p>lib    java开发用到的库文件</p>
<p>src    java资源类文件（java基础类的源代码）</p>
<h3 id="hello-word"><a href="#hello-word" class="headerlink" title="hello word"></a>hello word</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// HelloWord.java</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWord</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"hello word!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>cmd编译执行<br><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line"># 编译（编译得到.class文件）</span><br><span class="line">javac HelloWord.java</span><br><span class="line"></span><br><span class="line"># 运行（运行编译出来的.class文件）</span><br><span class="line">java HelloWord</span><br></pre></td></tr></table></figure></p>
<p>注意：</p>
<ol>
<li>java大小写敏感</li>
<li>java名尽量英文</li>
<li>文件名和类名必须一致</li>
</ol>
<h3 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h3><p>所有操作符基本只能操作基础类型，但有如下特例：</p>
<h4 id="操作所有对象"><a href="#操作所有对象" class="headerlink" title="操作所有对象"></a>操作所有对象</h4><ul>
<li>=</li>
<li>==（只能判断引用地址，不能判断内容）</li>
<li>!=（只能判断引用地址，不能判断内容）</li>
</ul>
<h4 id="操作String对象"><a href="#操作String对象" class="headerlink" title="操作String对象"></a>操作String对象</h4><ul>
<li>+</li>
<li>+=</li>
</ul>
<h4 id="“-”操作符作用"><a href="#“-”操作符作用" class="headerlink" title="“+”操作符作用"></a>“+”操作符作用</h4><ol>
<li>字符串拼接</li>
<li>字符串转换</li>
<li>数值计算</li>
</ol>
<h4 id="“-”操作符作用-1"><a href="#“-”操作符作用-1" class="headerlink" title="“=”操作符作用"></a>“=”操作符作用</h4><ol>
<li>基本类型=&gt;深度复制</li>
<li>对象类型=&gt;指向同一对象（仅复制引用<strong>地址</strong>，并没有复制对象本身内容）</li>
</ol>
<h4 id="判断内容相等"><a href="#判断内容相等" class="headerlink" title="判断内容相等"></a>判断内容相等</h4><p>基本类型</p>
<ul>
<li>==</li>
<li>!=</li>
</ul>
<p>对象</p>
<ul>
<li><p>equals</p>
<p>自定义类需要在类中覆盖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public boolean equals(Object obj) &#123;</span><br><span class="line">  return (this == obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>String</p>
<ul>
<li>当作基本类型赋值，则可以使用 <strong>==</strong> 或 <strong>equals</strong>。如String str1 = “Str123”;</li>
<li>当作对象赋值，则使用<strong>equals</strong>。如String str3 = new String(“Str123”);</li>
<li>建议使用equals。</li>
</ul>
<h4 id="幂运算"><a href="#幂运算" class="headerlink" title="幂运算"></a>幂运算</h4><ul>
<li>2^3 = 2的3次方</li>
<li>Math.pow(2, 3)</li>
</ul>
<h4 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h4><ol>
<li>&amp;&amp; 与</li>
<li>|| 或</li>
<li>！ 非</li>
<li><strong>短路运算</strong>，如果前面的逻辑能够得到结果，后续运算不再执行。</li>
</ol>
<h4 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h4><table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>与，两者皆1，才1</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>或，两者有1，就1</td>
</tr>
<tr>
<td>^</td>
<td>异或，两者不同，则1</td>
</tr>
<tr>
<td>~</td>
<td>取反</td>
</tr>
<tr>
<td>>></td>
<td>左移4位，每移1位除以2</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>右移4位，每移1位乘以2。16=1&lt;&lt;4</td>
</tr>
<tr>
<td>>>></td>
</tr>
</tbody>
</table>
<h5 id="取反"><a href="#取反" class="headerlink" title="取反"></a>取反</h5><p><strong>int型</strong>，4字节。最高位为符号位，0为正数，1为负数。</p>
<h6 id="原码"><a href="#原码" class="headerlink" title="原码"></a>原码</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正数 3的二进制：00000000	00000000	00000000	00000011</span><br><span class="line">负数-3的二进制：10000000	00000000	00000000	00000011</span><br></pre></td></tr></table></figure>
<h6 id="反码"><a href="#反码" class="headerlink" title="反码"></a>反码</h6><ol>
<li>正数，反码就是原码。</li>
<li>负数，反码是<strong>将原码除符号外的位取反</strong>。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正数 3的反码二进制：00000000	00000000	00000000	00000011</span><br><span class="line">负数-3的反码二进制：11111111	11111111	11111111	11111100</span><br></pre></td></tr></table></figure>
<h6 id="补码"><a href="#补码" class="headerlink" title="补码"></a>补码</h6><ol>
<li>正数，补码就是原码</li>
<li>负数，补码是反码+1</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正数 3的补码二进制：00000000	00000000	00000000	00000011</span><br><span class="line">负数-3的补码二进制：11111111	11111111	11111111	11111101</span><br></pre></td></tr></table></figure>
<h6 id="取反-1"><a href="#取反-1" class="headerlink" title="取反"></a>取反</h6><p>计算机中，都是用补码存储整数，取反是对补码取反。</p>
<ol>
<li>~3，得到 - 4</li>
<li>~-3，得到2</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">正数 3的补码二进制：11111111	11111111	11111111	11111100</span><br><span class="line">负数-3的补码二进制：00000000	00000000	00000000	00000010</span><br></pre></td></tr></table></figure>
<h3 id="包package"><a href="#包package" class="headerlink" title="包package"></a>包package</h3><ol>
<li>用来区别<strong>类名</strong>和<strong>命名空间</strong>。</li>
<li>一般用<strong>公司域名倒置</strong>作为包名。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">定义包名：</span><br><span class="line">  <span class="keyword">package</span> com.baidu;</span><br><span class="line"></span><br><span class="line">引入包：</span><br><span class="line">  <span class="keyword">import</span> com.baidu.(具体类名 或者 *);</span><br></pre></td></tr></table></figure>
<h3 id="JavaDoc"><a href="#JavaDoc" class="headerlink" title="JavaDoc"></a>JavaDoc</h3><h4 id="编写说明"><a href="#编写说明" class="headerlink" title="编写说明"></a>编写说明</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.baidu;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 作者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 版本号</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 最早使用的JDK版本号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 参数名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> name 返回值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 异常抛出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成文档"><a href="#生成文档" class="headerlink" title="生成文档"></a>生成文档</h4><h5 id="命令行方式"><a href="#命令行方式" class="headerlink" title="命令行方式"></a>命令行方式</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">javadoc -encoding UTF-8 -charset UTF-8 Base.java</span><br></pre></td></tr></table></figure>
<h5 id="Idea导出"><a href="#Idea导出" class="headerlink" title="Idea导出"></a>Idea导出</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">Tools-&gt;</span><span class="bash">Gerenate JavaDoc</span></span><br><span class="line"></span><br><span class="line">Other command line arguments：-encoding utf-8 -charset utf-8</span><br></pre></td></tr></table></figure>
<h4 id="查看文档"><a href="#查看文档" class="headerlink" title="查看文档"></a>查看文档</h4><ol>
<li>打开index.html</li>
</ol>
<h3 id="Scanner"><a href="#Scanner" class="headerlink" title="Scanner"></a>Scanner</h3><ol>
<li>可以用来获取用户输入。</li>
<li>在Java5引入的的工具类。</li>
</ol>
<h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line">Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"></span><br><span class="line">scanner.close(); <span class="comment">// io流的类都应该关闭，减少资源占用</span></span><br></pre></td></tr></table></figure>
<h4 id="关键方法"><a href="#关键方法" class="headerlink" title="关键方法"></a>关键方法</h4><h5 id="next"><a href="#next" class="headerlink" title="next"></a>next</h5><ul>
<li>next();</li>
<li>hasNext();</li>
<li>一直读取到【有效字符】才可以结束</li>
<li>在【有效字符】前遇到的【空白】，直接去掉</li>
<li>在【有效字符】后遇到的【空白】，作为分隔符或结束符</li>
<li>不能得到带有【空白】的字符串</li>
</ul>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200829172907167.png" alt="image-20200829172907167"></p>
<h5 id="nextLine"><a href="#nextLine" class="headerlink" title="nextLine"></a>nextLine</h5><ul>
<li>nextLine();</li>
<li>hasNextLine();</li>
<li>以【回车enter】作为结束符</li>
<li>可以获得【空白】</li>
</ul>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200829172823026.png" alt="image-20200829172823026"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luxia.scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Interactive</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        testInputNext();</span><br><span class="line"><span class="comment">//        testInputNextLine();</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInputSimple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String input = scanner.nextLine();</span><br><span class="line">        scanner.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInputNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"next-input please : "</span>);</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">if</span> (scanner.hasNext()) &#123;</span><br><span class="line">            String input = scanner.next();</span><br><span class="line">            System.out.println(<span class="string">"your input is : "</span> + input);</span><br><span class="line">        &#125;</span><br><span class="line">        scanner.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testInputNextLine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"next line-input please : "</span>);</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">if</span> (scanner.hasNextLine()) &#123;</span><br><span class="line">            String input = scanner.nextLine();</span><br><span class="line">            System.out.println(<span class="string">"your input is : "</span> + input);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// 计算平均值和总和</span></span><br><span class="line"> 		<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">computeAvgSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">        System.out.println(<span class="string">"请输入数字："</span>);</span><br><span class="line">        <span class="keyword">while</span> (scanner.hasNextDouble()) &#123;</span><br><span class="line">            String input = scanner.nextLine();</span><br><span class="line">            sum += Double.parseDouble(input);</span><br><span class="line">            size += <span class="number">1</span>;</span><br><span class="line">            System.out.println(<span class="string">"继续输入数字："</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"没有输入数字"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> avg = sum / size;</span><br><span class="line">        System.out.println(<span class="string">"总和:"</span> + sum + <span class="string">"；平均值:"</span> + avg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><ol>
<li>元素是相同类型的、有序的一组数据。</li>
<li>元素可以是基本类型，也可以是引用类型。</li>
<li>长度是确定的，一旦创建，不可改变</li>
<li>引用类型（引用地址-<strong>栈</strong>，实质存储空间-<strong>堆</strong>）。</li>
<li>数组一经分配空间，他的每一个元素也都被隐式的初始化。<ol>
<li>int默认初始化为0</li>
<li>String默认初始化为nulld等</li>
</ol>
</li>
</ol>
<h4 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 常用</span></span><br><span class="line"><span class="keyword">int</span>[] ages;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C/C++演变而来，不常用</span></span><br><span class="line"><span class="keyword">int</span> counts[];</span><br></pre></td></tr></table></figure>
<h4 id="初始化（分配了堆空间））"><a href="#初始化（分配了堆空间））" class="headerlink" title="初始化（分配了堆空间））"></a>初始化（分配了堆空间））</h4><p>静态初始化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[] ages = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">2</span>,<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="keyword">int</span>[] ages = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>动态初始化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[] ages = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">4</span>]; <span class="comment">//仅分配空间</span></span><br><span class="line">ages[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">ages[<span class="number">1</span>] = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h4 id="取值"><a href="#取值" class="headerlink" title="取值"></a>取值</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 总长度</span></span><br><span class="line">ages.length</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下标取值，下标范围[0,length - 1],否则会越界</span></span><br><span class="line">ages[<span class="number">0</span>]</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 直接取值</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> age:ages) &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h4><p>数组内部的元素也是个数组。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[][] a1= <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">3</span>][<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span>[][] a2= &#123;&#123;<span class="number">2</span>,<span class="number">3</span>&#125;,&#123;<span class="number">4</span>,<span class="number">5</span>&#125;,&#123;<span class="number">6</span>,<span class="number">7</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">a2[<span class="number">0</span>][<span class="number">1</span>] <span class="comment">// 3</span></span><br><span class="line">a2[<span class="number">1</span>][<span class="number">1</span>] <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>
<h4 id="Arrays类"><a href="#Arrays类" class="headerlink" title="Arrays类"></a>Arrays类</h4><p>数组的工具类java.util.Arrays</p>
<ol>
<li>fill 给数组赋值</li>
<li>sort 给数组<strong>升序</strong></li>
<li>equals 比较数组元素</li>
<li>binarySearch <strong>搜索</strong>，对排序后的数组，进行二分查找</li>
<li>asList 转换为List类型</li>
<li>Arrays.toString()</li>
<li>copyOf()</li>
</ol>
<h4 id="稀疏数组"><a href="#稀疏数组" class="headerlink" title="稀疏数组"></a>稀疏数组</h4><p>当二维数组中，很多默认值是0，会记录没有意义的数据，可以用稀疏数组。</p>
<ol>
<li>记录数组一共有几行几列，有多少个不同值</li>
<li>把不同值的行列及值记录在一个小规模的数组中，减少程序规模</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200906233936492.png" alt="image-20200906233936492"></p>
<h3 id="类-1"><a href="#类-1" class="headerlink" title="类"></a>类</h3><p>本质：抽象。以<strong>类</strong>的方式组织代码，以<strong>对象</strong>组织（封装）数据。</p>
<h4 id="三大特性"><a href="#三大特性" class="headerlink" title="三大特性"></a>三大特性</h4><ol>
<li>封装 （隐藏数据，属性私有：高内聚，低耦合，如get/set）</li>
<li>继承 （extends / super）</li>
<li>多态 （基类）</li>
</ol>
<h4 id="封装"><a href="#封装" class="headerlink" title="封装"></a><strong>封装</strong></h4><ol>
<li>保护属性，提高程序的安全性/可维护性</li>
<li>隐藏代码细节</li>
<li>统一接口</li>
</ol>
<h4 id="继承"><a href="#继承" class="headerlink" title="继承"></a><strong>继承</strong></h4><ol>
<li>所有类的基类是Object。</li>
<li>先执行父类，再执行子类。</li>
</ol>
<h5 id="super"><a href="#super" class="headerlink" title="super"></a><strong>super</strong></h5><ol>
<li>super只能在子类的方法或构造器中</li>
<li>super()    调用父类的构造器，必须出现在构造器的最开始</li>
<li>super(参数)</li>
</ol>
<h5 id="this"><a href="#this" class="headerlink" title="this"></a><strong>this</strong></h5><ol>
<li>本类</li>
<li>this 调用本类的方法或属性</li>
<li>this()    本类的构造器，也必须出现在构造器的最开始。所以this()和super()不能同时调用</li>
<li>this(参数)</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// extends</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//此代码默认隐藏，实则调用了父类的无参构造。</span></span><br><span class="line">      <span class="comment">//如果父类没有无参构造，则此处也要显式编写super(参数)</span></span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">      </span><br><span class="line">        System.out.println(<span class="string">"子类构造器"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name);</span><br><span class="line">      	<span class="comment">// super父类</span></span><br><span class="line">        System.out.println(<span class="keyword">super</span>.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>idea的<strong>ctrl + H</strong>，可以查看当前类的父祖类。</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200909223503930.png" alt="image-20200909223503930"></p>
<p>#### </p>
<h4 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h4><h5 id="重写"><a href="#重写" class="headerlink" title="重写"></a>重写</h5><p>指的是，子类继承父类，子类想重写父类的方法。</p>
<ol>
<li>静态方法，是类的方法。静态方法，不能重写。</li>
<li>普通方法，是对象的方法。<strong>普通方法才能重写</strong>。</li>
</ol>
<p><strong>重写和重载的区分</strong>：</p>
<ol>
<li>重写：①必须有<strong>继承</strong>关系，子类重写父类；②修饰符可以扩大范围（不能缩小）；③方法名、参数列表，必须相同；④抛出的异常可以缩小范围（不能扩大）。<strong>只有方法体不同</strong>。</li>
<li>重载：方法名相同，参数、返回值等不同。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOverride</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Override Person父类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Static Person父类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Person父类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// 注解：代表重写的注释</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOverride</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Override Teacher子类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Static Teacher子类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Teacher子类"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">Teacher teacher = <span class="keyword">new</span> Teacher();</span><br><span class="line">teacher.testStatic(); <span class="comment">// 静态方法，Teacher，子</span></span><br><span class="line">teacher.test(); <span class="comment">// 普通方法，Teacher，子</span></span><br><span class="line">teacher.testOverride(); <span class="comment">// 普通方法重写，Teacher，子</span></span><br><span class="line"></span><br><span class="line">Person te = <span class="keyword">new</span> Teacher();</span><br><span class="line">te.testStatic(); <span class="comment">// 静态方法，Person，父</span></span><br><span class="line">te.test(); <span class="comment">// 普通方法，Teacher，子</span></span><br><span class="line">te.testOverride(); <span class="comment">// 普通方法重写，Teacher，子</span></span><br></pre></td></tr></table></figure>
<h5 id="多态-1"><a href="#多态-1" class="headerlink" title="多态"></a>多态</h5><p>多态是<strong>方法</strong>的多态，属性没有多态性。</p>
<p>即，同一方法，根据发送对象的不同，而有不同的行为方式。</p>
<p>存在条件：有继承关系，子类方法重写父类方法，父类引用Person指向子类对象Teacher。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person teacher = <span class="keyword">new</span> Teacher();</span><br><span class="line">teacher.run();</span><br><span class="line"></span><br><span class="line">Person student = <span class="keyword">new</span> Student();</span><br><span class="line">student.run();</span><br></pre></td></tr></table></figure>
<h4 id="instanceOf"><a href="#instanceOf" class="headerlink" title="instanceOf"></a>instanceOf</h4><p>object instanceOf Class</p>
<p>object 是Class的子孙类对象或对象，返回true，否则返回false</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Person teacher = <span class="keyword">new</span> Teacher();</span><br><span class="line">System.out.println(teacher <span class="keyword">instanceof</span> Teacher); <span class="comment">// true</span></span><br><span class="line">System.out.println(teacher <span class="keyword">instanceof</span> Person); <span class="comment">// true</span></span><br><span class="line">System.out.println(teacher <span class="keyword">instanceof</span> Object); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h4 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 子类--&gt;父类（直接转换）</span></span><br><span class="line">Person teacher = <span class="keyword">new</span> Teacher();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类--&gt;子类</span></span><br><span class="line">teacher.myown(); <span class="comment">// 报错，Person类中找不到此方法</span></span><br><span class="line">((Teacher)teacher).myown(); <span class="comment">// 父向子类转换，调用子类方法。</span></span><br></pre></td></tr></table></figure>
<h4 id="class-类（抽象）"><a href="#class-类（抽象）" class="headerlink" title="class 类（抽象）"></a>class 类（抽象）</h4><h4 id="new-对象（实例化）"><a href="#new-对象（实例化）" class="headerlink" title="new 对象（实例化）"></a>new 对象（实例化）</h4><p>new创建对象时，①分配内存空间，②初始化对象（值），③调用类的构造器</p>
<p>初始值：</p>
<ol>
<li>数字：    0    0.0</li>
<li>char：    u0000</li>
<li>boolean:    false</li>
<li>引用类型：    null</li>
</ol>
<h4 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h4><p>使用new实例化对象，本质是在调用构造器。</p>
<p>构造器可以用来初始化对象的值。</p>
<ol>
<li>必须和类名相同</li>
<li>必须没有返回类型，也不能写void</li>
<li>如果自定义了构造器，隐式默认构造器会失效</li>
</ol>
<h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>abstract / extends</p>
<ol>
<li>abstract class 抽象类</li>
<li>abstract 方法 抽象方法</li>
</ol>
<p>抽象类和接口，都是一种顶层的<strong>约束</strong>规则，不负责真正的实现。只能依靠子类，或者接口实现类去实现。</p>
<p>因为抽象类不负责实现，所以<strong>不能new</strong>这个抽象类。但是抽象类是有构造器滴！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 抽象类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可以写普通方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象方法。抽象方法必须在抽象类中。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">AbstractTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 父抽象类的抽象方法，必须被子类实现</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>interface / implements</p>
<p>接口，就是规范！一般会先把接口设计好，再去实现。</p>
<ol>
<li>类：只负责具体实现。</li>
<li>抽象类：有具体的实现，也有抽象的规则。本质是类，只能单继承。</li>
<li>接口：只有约束规则。一个类，可以实现多个接口！（类似多继承）</li>
</ol>
<p>接口的方法，默认就是【public + 抽象】的（实际编程中，缩略不写）</p>
<p>接口的属性，默认都是【public + static + final 常量】！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InterfaceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> AGE = <span class="number">23</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">go</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实现了接口，就必须重写接口中的所有方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span> <span class="keyword">implements</span> <span class="title">InterfaceTest</span>, <span class="title">InterfaceTest02</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(InterfaceTest.AGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// InterfaceTest02的方法重写</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>在一个类A的内部，定义一个类B。B是内部类，A是外部类。</p>
<ol>
<li>成员内部类</li>
<li>静态内部类</li>
<li>局部内部类</li>
<li>匿名内部类</li>
</ol>
<h4 id="成员内部类"><a href="#成员内部类" class="headerlink" title="成员内部类"></a>成员内部类</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClassTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UUID id = UUID.randomUUID();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"我是外部类，我可以直接调用内部类"</span>);</span><br><span class="line">        Inner inner = <span class="keyword">new</span> Inner();</span><br><span class="line">        inner.in();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">in</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"我是内部类"</span>);</span><br><span class="line">            <span class="comment">// 成员内部类，可以访问外部类的私有属性</span></span><br><span class="line">            System.out.println(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 一个java类中，可以有多个class类，但只能有一个public类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        InnerClassTest innerClassTest = <span class="keyword">new</span> InnerClassTest();</span><br><span class="line">        innerClassTest.run();</span><br><span class="line">        <span class="comment">// 通过外部类，实例化内部类</span></span><br><span class="line">        InnerClassTest.Inner inner = innerClassTest.<span class="keyword">new</span> Inner();</span><br><span class="line">        inner.in();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="静态成员内部类（static-class）"><a href="#静态成员内部类（static-class）" class="headerlink" title="静态成员内部类（static class）"></a>静态成员内部类（static class）</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luxia.base;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClassTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UUID id = UUID.randomUUID();</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">in</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"我是内部类"</span>);</span><br><span class="line">            <span class="comment">// 内部类，可以访问外部类的私有静态属性</span></span><br><span class="line">            System.out.println(id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        InnerClassTest innerClassTest = <span class="keyword">new</span> InnerClassTest();</span><br><span class="line">        innerClassTest.run();</span><br><span class="line">        <span class="comment">// 通过外部类，实例化内部类</span></span><br><span class="line">        InnerClassTest.Inner inner = <span class="keyword">new</span> InnerClassTest.Inner();</span><br><span class="line">        inner.in();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="局部内部类-方法内部"><a href="#局部内部类-方法内部" class="headerlink" title="局部内部类(方法内部)"></a>局部内部类(方法内部)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerClassTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UUID id = UUID.randomUUID();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Inner</span> </span>&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">in</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"我是局部内部类"</span>);</span><br><span class="line">                System.out.println(id);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Inner inner = <span class="keyword">new</span> Inner();</span><br><span class="line">        inner.in();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h4><p>初始化类时，不指定名字。不用将实例保留到变量中。</p>
<h3 id="内存分析"><a href="#内存分析" class="headerlink" title="内存分析"></a>内存分析</h3><h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><ol>
<li>存放基本变量（包括基本类型的值）</li>
<li>引用对象的变量（存放这个引用在堆里面的具体<strong>引用地址</strong>）</li>
</ol>
<h4 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h4><ol>
<li>存放new的对象和数组的<strong>实质内容</strong>。</li>
<li>可被所有线程共享。</li>
</ol>
<h4 id="方法区（属于堆）"><a href="#方法区（属于堆）" class="headerlink" title="方法区（属于堆）"></a>方法区（属于堆）</h4><ol>
<li>存放所有的class和static变量</li>
<li>可被所有线程共享。</li>
</ol>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p><code>int[] myList = new int[4];</code></p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200906174107698.png" alt="image-20200906174107698"></p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200909221955646.png" alt="image-20200909221955646"></p>
<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><h4 id="静态属性"><a href="#静态属性" class="headerlink" title="静态属性"></a>静态属性</h4><p>多用于多线程。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> age; <span class="comment">// 静态属性</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> score; <span class="comment">// 普通属性</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(StaticTest.age); <span class="comment">// 静态属性，被类调用（推荐） 0</span></span><br><span class="line"></span><br><span class="line">        StaticTest staticTest = <span class="keyword">new</span> StaticTest();</span><br><span class="line">        System.out.println(staticTest.age); <span class="comment">// 静态属性，可被对象实例调用 0</span></span><br><span class="line">        System.out.println(staticTest.score); <span class="comment">// 普通属性，只被对象实例调用 0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"not static"</span>);</span><br><span class="line">        go(); <span class="comment">// 普通方法，可以调用静态方法（因为静态是随着类早就存在了）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"static"</span>);</span><br><span class="line">        run(); <span class="comment">// 报错！静态方法，不能调用普通方法（因为普通方法是动态的，静态方法存在时它还不存在）</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        go(); <span class="comment">// 静态方法，属于类，可以直接被调用</span></span><br><span class="line">        StaticTest.go();</span><br><span class="line"></span><br><span class="line">        run(); <span class="comment">// 报错！</span></span><br><span class="line">        staticTest.run(); <span class="comment">// 普通方法，只能被对象实例调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="静态代码块"><a href="#静态代码块" class="headerlink" title="静态代码块"></a>静态代码块</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeBlock</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">"匿名代码块"</span>); <span class="comment">// 2，赋初始值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">"静态代码块"</span>); <span class="comment">// 1，只执行一次</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CodeBlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"构造器"</span>); <span class="comment">// 3</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> CodeBlock();</span><br><span class="line">        System.out.println(<span class="string">"---------------------"</span>);</span><br><span class="line">        <span class="keyword">new</span> CodeBlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态代码块</span><br><span class="line">匿名代码块</span><br><span class="line">构造器</span><br><span class="line">---------------------</span><br><span class="line">匿名代码块</span><br><span class="line">构造器</span><br></pre></td></tr></table></figure>
<h4 id="静态导入包"><a href="#静态导入包" class="headerlink" title="静态导入包"></a>静态导入包</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 常规调用：</span></span><br><span class="line">System.out.println(Math.random());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态导入方法：</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.Math.random;</span><br><span class="line">System.out.println(random());</span><br></pre></td></tr></table></figure>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><h4 id="Java中，参数只有值传递"><a href="#Java中，参数只有值传递" class="headerlink" title="Java中，参数只有值传递"></a>Java中，参数只有值传递</h4><p>只不过对于对象参数，【值的内容】是【对象的引用】</p>
<h4 id="静态方法-1"><a href="#静态方法-1" class="headerlink" title="静态方法"></a>静态方法</h4><ol>
<li>非静态方法，可调用静态方法，或普通方法。</li>
<li>静态方法，只能调用静态方法，不能调用普通方法。因为类创建时，静态方法已经创建，而普通方法还没有被创建（在实例化对象时才被创建）</li>
</ol>
<h4 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h4><ol>
<li>jdk1.5开始，可以传递同类型的、可变参数。</li>
<li>类型后面加省略号（…）</li>
<li>可变参数只能是最后一个参数</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 调用</span></span><br><span class="line">testRestParams(<span class="string">"tom"</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">testRestParams(<span class="string">"jack"</span>, <span class="number">11</span>, <span class="number">22</span>, <span class="number">13</span>);</span><br><span class="line">testRestParams(<span class="string">"lucy"</span>, <span class="number">51</span>, <span class="number">232</span>, <span class="number">1113</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testRestParams</span><span class="params">(String name, <span class="keyword">int</span>... scores)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (scores.length == <span class="number">0</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">"no score passed"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> max = scores[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> score : scores) &#123;</span><br><span class="line">        <span class="keyword">if</span> (score &gt; max) &#123;</span><br><span class="line">            max = score;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(name + <span class="string">" max:"</span> + max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="命令行传参"><a href="#命令行传参" class="headerlink" title="命令行传参"></a>命令行传参</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CmdLine</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String arg : args) &#123;</span><br><span class="line">            System.out.println(arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="idea传参"><a href="#idea传参" class="headerlink" title="idea传参"></a>idea传参</h5><p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200830180532275.png" alt="image-20200830180532275"></p>
<h5 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h5><ol>
<li>javac CmdLine.java    生成.class</li>
<li>java com.example.base.CmdLine    运行.class</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200830181053267.png" alt="image-20200830181053267"></p>
<h3 id="for"><a href="#for" class="headerlink" title="for"></a>for</h3><p>增加型for循环，java5引入，多用于集合、数组。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span>[] counts = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> count : counts) &#123;</span><br><span class="line">    System.out.print(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><ol>
<li>byte</li>
<li>short</li>
<li>int</li>
<li>char</li>
<li>String(JavaSE7)（字符的本质还是数字）</li>
<li>枚举</li>
</ol>
<h4 id="字符的本质是数字"><a href="#字符的本质是数字" class="headerlink" title="字符的本质是数字"></a>字符的本质是数字</h4><p>idea反编译演示——</p>
<p>编译： .java =&gt; .class。从如下目录找到编译后的class文件</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200830155211670.png" alt="image-20200830155211670"></p>
<p>反编译：.class 。将.class用idea打开，可以看到，将字符串转换成了数字。</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200830160056425.png" alt="image-20200830160056425"></p>
<h4 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h4><p>switch判断枚举值的时候，①枚举的是枚举类型本身；②case后的枚举类型，不能加枚举前缀（An enum switch case label must be the unqualified name of an enumeration constant）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TypeEnum typeEnum = TypeEnum.GOOD;</span><br><span class="line"><span class="keyword">switch</span> (typeEnum) &#123;</span><br><span class="line">    <span class="keyword">case</span> NICE: &#123;</span><br><span class="line">        System.out.println(<span class="string">"你很优秀"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> GOOD: &#123;</span><br><span class="line">        System.out.println(<span class="string">"good"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> BAD: &#123;</span><br><span class="line">        System.out.println(<span class="string">"继续加油"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">        System.out.println(<span class="string">"还没出成绩"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> TypeEnum &#123;</span><br><span class="line">    NICE(<span class="number">1</span>),</span><br><span class="line">    GOOD(<span class="number">2</span>),</span><br><span class="line">    BAD(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line"></span><br><span class="line">    TypeEnum(<span class="keyword">int</span> code) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="String-和List相互转换"><a href="#String-和List相互转换" class="headerlink" title="String[]和List相互转换"></a>String[]和List相互转换</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// String[] 转换为 List&lt;String&gt;</span></span><br><span class="line"><span class="comment">// 将String[]转化为List&lt;String&gt;，不能对转化出来的List进行add，remove，因为他们并不是ArrayList，而是Arrays里面的内部类ArrayList</span></span><br><span class="line">String[] strings = <span class="keyword">new</span> String[]&#123;<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>, <span class="string">"e"</span>&#125;;</span><br><span class="line">List&lt;String&gt; list = Arrays.asList(strings);</span><br><span class="line">System.out.println(list.toString());</span><br><span class="line"></span><br><span class="line"><span class="comment">// List&lt;String&gt; 转换为 String[]</span></span><br><span class="line">List&lt;String&gt; list1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">list1.add(<span class="string">"nice"</span>);</span><br><span class="line">list1.add(<span class="string">"good"</span>);</span><br><span class="line">list1.add(<span class="string">"bad"</span>);</span><br><span class="line">String[] strings1 = list.toArray(<span class="keyword">new</span> String[]&#123;&#125;);</span><br><span class="line">System.out.println(Arrays.toString(strings1));</span><br></pre></td></tr></table></figure>
<h3 id="取最大值最小值"><a href="#取最大值最小值" class="headerlink" title="取最大值最小值"></a>取最大值最小值</h3><h4 id="获取List中的最大最小值"><a href="#获取List中的最大最小值" class="headerlink" title="获取List中的最大最小值"></a>获取List中的最大最小值</h4><p>List&lt; Integer &gt; 或者 List&lt; double &gt;</p>
<p>注意不能有null元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Collections.min(Arrays.asList(1,2,3,4))</span><br><span class="line">Collections.max(Arrays.asList(1,2,3,4))</span><br></pre></td></tr></table></figure>
<p>List&lt; 实体类&gt;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 自己写for寻找</span><br></pre></td></tr></table></figure>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>exception。</p>
<p>java把异常当做<strong>对象</strong>处理，<code>java.lang.Throwable</code>是所有异常的基类。</p>
<p>异常类分为两类：</p>
<ol>
<li>错误Error<ul>
<li>由<strong>java虚拟机</strong>生成并抛出<ul>
<li>OutOfMemoryError  内存溢出</li>
<li>NoClassDefFoundError  类定义错误</li>
<li>LinkageError  链接错误</li>
</ul>
</li>
<li>大多数错误，与代码开发者所执行的操作无关</li>
<li>灾难性，致命，无法控制和处理，当发生时，JVM一般会终止线程</li>
</ul>
</li>
<li>异常Exception<ul>
<li>RuntimeException 运行时异常（由<strong>逻辑</strong>引起，是不检查异常，程序中可以自己选择是否捕获、是否处理）<ul>
<li>数组下标越界</li>
<li>空指针</li>
<li>算术异常</li>
<li>丢失资源</li>
<li>ClassNotFoundException 找不到类</li>
</ul>
</li>
<li>检查异常</li>
<li>可以被程序处理，在程序中应该尽可能的去处理。</li>
</ul>
</li>
</ol>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><table>
<thead>
<tr>
<th>类别</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>检查性异常</td>
<td>编译时。</td>
</tr>
<tr>
<td>运行时异常</td>
<td>运行时（编译时被忽略）</td>
</tr>
<tr>
<td>错误ERROR</td>
<td>错误，不是异常。如当栈溢出，发生错误，编译时无法检查到。</td>
</tr>
</tbody>
</table>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200824233037728.png" alt="image-20200824233037728"></p>
<h4 id="异常处理的方法"><a href="#异常处理的方法" class="headerlink" title="异常处理的方法"></a>异常处理的方法</h4><p>ctr alt t</p>
<p>使用异常处理后，碰到异常，<strong>会正常执行</strong>，而不会终止。</p>
<h5 id="try-catch-捕获"><a href="#try-catch-捕获" class="headerlink" title="try/catch 捕获"></a>try/catch 捕获</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 可多个catch</span></span><br><span class="line"><span class="comment">// 越基础的异常，越靠后</span></span><br><span class="line"><span class="keyword">try</span>&#123;&#125;</span><br><span class="line"><span class="keyword">catch</span>(异常类)&#123;&#125;</span><br><span class="line"><span class="keyword">catch</span>(ArrithmeticException a)&#123;&#125;</span><br><span class="line"><span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line"><span class="keyword">catch</span>(Throwable t)&#123;</span><br><span class="line">		e.printStackTrace() <span class="comment">// 打印错误的栈信息</span></span><br><span class="line">      <span class="comment">// 尽量额外的逻辑来处理异常</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span>&#123;</span><br><span class="line">  <span class="comment">// 选用，用于io、资源等的关闭操作，释放资源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="throws-在方法上抛出异常"><a href="#throws-在方法上抛出异常" class="headerlink" title="throws 在方法上抛出异常"></a>throws 在方法上抛出异常</h5><p>如果本方法无法处理异常，可以抛出异常到方法外。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> ArrithmeticException</span>&#123;	</span><br><span class="line">	<span class="keyword">if</span>(a==<span class="number">0</span>) &#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="throw-方法中主动抛出异常"><a href="#throw-方法中主动抛出异常" class="headerlink" title="throw 方法中主动抛出异常"></a>throw 方法中主动抛出异常</h5><p>一般在方法中使用，在方法中抛出。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;	</span><br><span class="line">	<span class="keyword">if</span>(a==<span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArrithmeticException();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>##### </p>
<h4 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h4><p>只需要继承exception类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    Integer detail;</span><br><span class="line">    MyException(Integer e) &#123;</span><br><span class="line">        <span class="keyword">this</span>.detail = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"MyException&#123;"</span> +</span><br><span class="line">                <span class="string">"detail="</span> + detail +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyExceptionTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> MyExceptionTest().testNumber();<span class="comment">//在此处理异常</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (MyException e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">testNumber</span><span class="params">()</span> <span class="keyword">throws</span> MyException </span>&#123;<span class="comment">// 异常抛出方法外处理</span></span><br><span class="line">        Integer a = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (a == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MyException(a); <span class="comment">// 主动抛出</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h3><h4 id="新老版本"><a href="#新老版本" class="headerlink" title="新老版本"></a>新老版本</h4><p>Java原本自带时间类（单线程不会有问题，多线程有风险，且使用困难）</p>
<ol>
<li>java.util.Date;（JDK1.1已经被弃用）<ol>
<li>java.sql.Date是其子类</li>
</ol>
</li>
<li>java.util.Calendar;（JDK1.1推出）</li>
</ol>
<p>Java8增加的时间类</p>
<ol>
<li>java.time（基于Joda-Time库）</li>
</ol>
<h5 id="繁琐程度对比"><a href="#繁琐程度对比" class="headerlink" title="繁琐程度对比"></a>繁琐程度对比</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 旧版本</span></span><br><span class="line">SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Date birthDay = simpleDateFormat.parse(<span class="string">"1991-11-23"</span>);</span><br><span class="line">    Date now = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> time = now.getTime() - birthDay.getTime();</span><br><span class="line">    <span class="keyword">long</span> day = time / <span class="number">1000</span> / <span class="number">3600</span> / <span class="number">24</span>;</span><br><span class="line">    System.out.println(day);</span><br><span class="line">&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Java8新版本</span></span><br><span class="line"><span class="keyword">long</span> day2 = ChronoUnit.DAYS.between(LocalDate.of(<span class="number">1991</span>, <span class="number">11</span>, <span class="number">23</span>), LocalDate.now());</span><br><span class="line">System.out.println(day2);</span><br></pre></td></tr></table></figure>
<h5 id="线程对比"><a href="#线程对比" class="headerlink" title="线程对比"></a>线程对比</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 旧版本,全局共享的是同一个calendar对象，如果没有线程同步措施，会造成线程安全问题</span></span><br><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> SimpleDateFormat SIMPLE_DATE_FORMAT = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Date date = SIMPLE_DATE_FORMAT.parse(<span class="string">"1991-11-23 06:06:06"</span>);</span><br><span class="line">                    System.out.println(date);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 正确写法</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> SimpleDateFormat SIMPLE_DATE_FORMAT = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (SIMPLE_DATE_FORMAT) &#123; <span class="comment">// 增加同步控制</span></span><br><span class="line">                        Date date = SIMPLE_DATE_FORMAT.parse(<span class="string">"1991-11-23 06:06:06"</span>);</span><br><span class="line">                        System.out.println(date);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Calendar避免直接使用数字，而应该使用枚举常量"><a href="#Calendar避免直接使用数字，而应该使用枚举常量" class="headerlink" title="Calendar避免直接使用数字，而应该使用枚举常量"></a>Calendar避免直接使用数字，而应该使用枚举常量</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Calendar calendar = Calendar.getInstance();</span><br><span class="line">calendar.set(<span class="number">1991</span>, <span class="number">11</span>, <span class="number">23</span>); <span class="comment">// 避免直接使用数字</span></span><br><span class="line">calendar.set(<span class="number">1991</span>, Calendar.DECEMBER, <span class="number">23</span>); <span class="comment">// 使用枚举常量</span></span><br><span class="line">System.out.println(calendar.getTime());</span><br></pre></td></tr></table></figure>
<h5 id="Java8时间类API"><a href="#Java8时间类API" class="headerlink" title="Java8时间类API"></a>Java8时间类API</h5><p>java.time中的类</p>
<table>
<thead>
<tr>
<th>类</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Instant</td>
<td>时间戳。作为中间类转换。</td>
</tr>
<tr>
<td>Duration</td>
<td>时间间隔，秒、纳秒，适合处理较短、较精确</td>
</tr>
<tr>
<td>Period</td>
<td>一段时间，年月日</td>
</tr>
<tr>
<td>LocalDate</td>
<td>不可变，日期，年月日</td>
</tr>
<tr>
<td>LocalTime</td>
<td>不可变，时间，时分秒</td>
</tr>
<tr>
<td>LocalDateTime</td>
<td>不可变，日期+时间，年月日时分秒</td>
</tr>
<tr>
<td>ZonedDateTime</td>
<td>不可变，具有时区的日期+时间</td>
</tr>
</tbody>
</table>
<p>java.time中的类都不生成不可变实例，也不提供公共构造函数，没办法通过new的方式直接创建，需要采用工厂方法实例化。</p>
<h6 id="now方法获取当前时间"><a href="#now方法获取当前时间" class="headerlink" title="now方法获取当前时间"></a>now方法获取当前时间</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Instant instant = Instant.now();</span><br><span class="line">System.out.println(instant); <span class="comment">//2020-08-02T09:30:01.526Z，是个国际标准时间</span></span><br><span class="line"></span><br><span class="line">LocalDate localDate = LocalDate.now();</span><br><span class="line">System.out.println(localDate);<span class="comment">//2020-08-02</span></span><br><span class="line"></span><br><span class="line">LocalTime localTime = LocalTime.now();</span><br><span class="line">System.out.println(localTime);<span class="comment">//17:30:01.773</span></span><br><span class="line"></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">System.out.println(localDateTime);<span class="comment">//2020-08-02T17:30:01.774</span></span><br><span class="line"></span><br><span class="line">ZonedDateTime zonedDateTime = ZonedDateTime.now();</span><br><span class="line">System.out.println(zonedDateTime);<span class="comment">//2020-08-02T17:30:01.775+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Year year = Year.now();</span><br><span class="line">System.out.println(year);<span class="comment">// 2020</span></span><br><span class="line"></span><br><span class="line">YearMonth yearMonth = YearMonth.now();</span><br><span class="line">System.out.println(yearMonth); <span class="comment">// 2020-08</span></span><br><span class="line"></span><br><span class="line">MonthDay monthDay = MonthDay.now();</span><br><span class="line">System.out.println(monthDay); <span class="comment">// --08-02</span></span><br></pre></td></tr></table></figure>
<h6 id="of方法获取指定时间"><a href="#of方法获取指定时间" class="headerlink" title="of方法获取指定时间"></a>of方法获取指定时间</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LocalDate localDate = LocalDate.of(<span class="number">1991</span>, <span class="number">11</span>, <span class="number">23</span>);</span><br><span class="line">System.out.println(localDate);<span class="comment">// 1991-11-23</span></span><br><span class="line"></span><br><span class="line">LocalTime localTime = LocalTime.of(<span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line">System.out.println(localTime);<span class="comment">// 06:06:06</span></span><br><span class="line"></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.of(<span class="number">1991</span>, <span class="number">11</span>, <span class="number">23</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line">System.out.println(localDateTime);<span class="comment">// 1991-11-23T06:06:06</span></span><br><span class="line"></span><br><span class="line">LocalDateTime localDateTime2 = LocalDateTime.of(localDate, localTime);</span><br><span class="line">System.out.println(localDateTime2);<span class="comment">// 1991-11-23T06:06:06</span></span><br></pre></td></tr></table></figure>
<h6 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 全部时区列表</span></span><br><span class="line">Set&lt;String&gt; zoneIds = ZoneId.getAvailableZoneIds();</span><br><span class="line"><span class="keyword">for</span> (String zoneId : zoneIds) &#123;</span><br><span class="line">    System.out.println(zoneId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认时区</span></span><br><span class="line">ZoneId defaultZoneId = ZoneId.systemDefault();</span><br><span class="line">System.out.println(defaultZoneId); <span class="comment">// Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 给时间指定市区</span></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.now();</span><br><span class="line">ZonedDateTime zonedDateTime = localDateTime.atZone(ZoneId.of(<span class="string">"Asia/Shanghai"</span>));</span><br><span class="line">System.out.println(zonedDateTime); <span class="comment">// 2020-08-02T18:01:06.660+08:00[Asia/Shanghai]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 同时间，其他时区的时间</span></span><br><span class="line">ZonedDateTime zonedDateTime1 = zonedDateTime.withZoneSameInstant(ZoneId.of(<span class="string">"Europe/Berlin"</span>));</span><br><span class="line">System.out.println(zonedDateTime1); <span class="comment">//2020-08-02T12:01:06.660+02:00[Europe/Berlin]</span></span><br></pre></td></tr></table></figure>
<h4 id="Date获取年月日等方法被弃用"><a href="#Date获取年月日等方法被弃用" class="headerlink" title="Date获取年月日等方法被弃用"></a>Date获取年月日等方法被弃用</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Date date1 = <span class="keyword">new</span> Date();</span><br><span class="line">date1.getDate();</span><br><span class="line">date1.getYear();</span><br><span class="line">date1.getMonth();</span><br><span class="line">date1.getDay();</span><br><span class="line">date1.getHours();</span><br><span class="line">date1.getMinutes();</span><br><span class="line">date1.getSeconds();</span><br></pre></td></tr></table></figure>
<h5 id="方法一：Calendar类"><a href="#方法一：Calendar类" class="headerlink" title="方法一：Calendar类"></a>方法一：Calendar类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Calendar calendar = Calendar.getInstance();</span><br><span class="line">calendar.setTime(<span class="keyword">new</span> Date());					<span class="comment">//放入Date类型数据</span></span><br><span class="line"></span><br><span class="line">calendar.get(Calendar.YEAR);					<span class="comment">//获取年份</span></span><br><span class="line">calendar.get(Calendar.MONTH);					<span class="comment">//获取月份</span></span><br><span class="line">calendar.get(Calendar.DATE);					<span class="comment">//获取日</span></span><br><span class="line"></span><br><span class="line">calendar.get(Calendar.HOUR);					<span class="comment">//时（12小时制）</span></span><br><span class="line">calendar.get(Calendar.HOUR_OF_DAY);				<span class="comment">//时（24小时制）</span></span><br><span class="line">calendar.get(Calendar.MINUTE);					<span class="comment">//分</span></span><br><span class="line">calendar.get(Calendar.SECOND);					<span class="comment">//秒</span></span><br><span class="line"></span><br><span class="line">calendar.get(Calendar.DAY_OF_WEEK);				<span class="comment">//一周的第几天</span></span><br></pre></td></tr></table></figure>
<h5 id="方法二：SimpleDateFormat类"><a href="#方法二：SimpleDateFormat类" class="headerlink" title="方法二：SimpleDateFormat类"></a>方法二：SimpleDateFormat类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] strNow1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>).format(<span class="keyword">new</span> Date()).toString().split(<span class="string">"-"</span>);</span><br><span class="line"> </span><br><span class="line">Integer.parseInt(strNow1[<span class="number">0</span>]);			<span class="comment">//获取年</span></span><br><span class="line">Integer.parseInt(strNow1[<span class="number">1</span>]);			<span class="comment">//获取月</span></span><br><span class="line">Integer.parseInt(strNow1[<span class="number">2</span>]);			<span class="comment">//获取日</span></span><br><span class="line"> </span><br><span class="line">String[] strNow2 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"hh:mm:ss"</span>).format(<span class="keyword">new</span> Date()).toString().split(<span class="string">":"</span>);</span><br><span class="line"> </span><br><span class="line">Integer.parseInt(strNow2[<span class="number">0</span>]);			<span class="comment">//获取时（12小时制）</span></span><br><span class="line">Integer.parseInt(strNow2[<span class="number">1</span>]);			<span class="comment">//获取分</span></span><br><span class="line">Integer.parseInt(strNow2[<span class="number">2</span>]);			<span class="comment">//获取秒</span></span><br><span class="line"> </span><br><span class="line">String[] strNow3 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()).toString().split(<span class="string">":"</span>);</span><br><span class="line">		</span><br><span class="line">Integer.parseInt(strNow3[<span class="number">0</span>]);			<span class="comment">//获取时（24小时制）</span></span><br><span class="line">Integer.parseInt(strNow3[<span class="number">1</span>]);			<span class="comment">//获取分</span></span><br><span class="line">Integer.parseInt(strNow3[<span class="number">2</span>]);			<span class="comment">//获取秒</span></span><br></pre></td></tr></table></figure>
<h4 id="时间转换案例"><a href="#时间转换案例" class="headerlink" title="时间转换案例"></a>时间转换案例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2017-01-01 19:01:01转化为19:01:01</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testDate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">        Date date = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            date = format.parse(<span class="string">"2017-01-01 19:01:01"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line">        String time = format.format(date);</span><br><span class="line">        System.out.println(time);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 判断当前时间是否在时间范围内,含年月日</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEffectiveDate</span><span class="params">(Date nowTime, Date startTime, Date endTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nowTime.getTime() == startTime.getTime()</span><br><span class="line">                || nowTime.getTime() == endTime.getTime()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Calendar start = Calendar.getInstance();</span><br><span class="line">        start.setTime(startTime);</span><br><span class="line"></span><br><span class="line">        Calendar end = Calendar.getInstance();</span><br><span class="line">        end.setTime(endTime);</span><br><span class="line"></span><br><span class="line">        Calendar now = Calendar.getInstance();</span><br><span class="line">        now.setTime(nowTime);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> now.after(start) &amp;&amp; now.before(end);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 判断是否是工作时间，只有时间</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">isWorkTime</span><span class="params">(<span class="keyword">final</span> Date datetime)</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Date curDate = simpleDateFormat.parse(simpleDateFormat.format(datetime));</span><br><span class="line">            Date startDate = simpleDateFormat.parse(<span class="string">"08:30:00"</span>);</span><br><span class="line">            Date endDate = simpleDateFormat.parse(<span class="string">"18:00:00"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">long</span> curTime = curDate.getTime();</span><br><span class="line">            <span class="keyword">long</span> startTime = startDate.getTime();</span><br><span class="line">            <span class="keyword">long</span> endTime = endDate.getTime();</span><br><span class="line">            <span class="keyword">return</span> curTime &gt;= startTime &amp;&amp; curTime &lt;= endTime;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"simpleDateFormat.parse解析失败"</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="第三方库Joda"><a href="#第三方库Joda" class="headerlink" title="第三方库Joda"></a>第三方库Joda</h4><p><a href="https://www.ibm.com/developerworks/cn/java/j-jodatime.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/java/j-jodatime.html</a></p>
<h3 id="excel"><a href="#excel" class="headerlink" title="excel"></a>excel</h3><ol>
<li>poi支持.xls和.xlsx</li>
<li>jxl只支持.xls</li>
</ol>
<p>POI：是对所有office资源进行读写的一套工具包、属于apache开源组织。</p>
<h4 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h4><ol>
<li>[.xls]excel 2003   HSSFWorkbook workbook = new <strong>HSSFWorkbook</strong>();</li>
<li>[.xlsx]excel 2007 XSSFWorkbook workBook =  new <strong>XSSFWorkbook</strong>();</li>
</ol>
<table>
<thead>
<tr>
<th>元素</th>
<th>.xls excel2003</th>
<th>.xlsx excel 2007</th>
</tr>
</thead>
<tbody>
<tr>
<td>工作簿</td>
<td>HSSFWorkbook</td>
<td>XSSFWorkbook</td>
</tr>
<tr>
<td>工作表</td>
<td>HSSFSheet</td>
<td>XSSFSheet</td>
</tr>
<tr>
<td>行</td>
<td>HSSFRow</td>
<td>XSSFRow</td>
</tr>
<tr>
<td>单元格</td>
<td>HSSFCell</td>
<td>XSSFCell</td>
</tr>
<tr>
<td></td>
<td>HSSFCellStyle</td>
<td>XSSFCellStyle</td>
</tr>
</tbody>
</table>
<h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.poi/poi --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.poi/poi-ooxml --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 为POI支持Office Open XML --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- import org.apache.poi.xssf.usermodel.XSSFWorkbook; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="多个sheet导出"><a href="#多个sheet导出" class="headerlink" title="多个sheet导出"></a>多个sheet导出</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建Excel文件</span></span><br><span class="line">HSSFWorkbook workbook = <span class="keyword">new</span> HSSFWorkbook();</span><br><span class="line"><span class="comment">// 获取名称集合</span></span><br><span class="line">List&lt;String&gt; nameList = Arrays.asList(<span class="string">"learn1Sheet"</span>, <span class="string">"learn2Sheet"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;nameList.size();i++)&#123;</span><br><span class="line">  <span class="comment">// 遍历名称</span></span><br><span class="line">  String sheetname = nameList.get(i));</span><br><span class="line">  <span class="comment">// 创建工作簿</span></span><br><span class="line">  HSSFSheet sheet = workbook.createSheet(sheetname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="合并单元格"><a href="#合并单元格" class="headerlink" title="合并单元格"></a>合并单元格</h4><p>合并单元格之后单元格内容会保留第一个单元格的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//合并单元格</span></span><br><span class="line">CellRangeAddress callRangeAddress = <span class="keyword">new</span> CellRangeAddress(<span class="number">0</span>, <span class="number">1</span>, (<span class="keyword">short</span>)<span class="number">0</span>, (<span class="keyword">short</span>)<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//加载合并单元格</span></span><br><span class="line">sheet.addMergedRegion(callRangeAddress);</span><br></pre></td></tr></table></figure>
<h4 id="样式属性"><a href="#样式属性" class="headerlink" title="样式属性"></a>样式属性</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 行高，行高计算公式：x*20 (x为需要设置的行高)</span></span><br><span class="line">row.setHeight((<span class="keyword">short</span>)<span class="number">405</span>); <span class="comment">// 此处行高是405/20 = 20.25</span></span><br><span class="line"><span class="comment">// 列宽，列宽计算公式：256*x+184 (x为需要设置的列宽)</span></span><br><span class="line">sheet.setColumnWidth(<span class="number">1</span>,<span class="number">9656</span>); <span class="comment">// 1为列号，此处列宽为37</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 单元格</span></span><br><span class="line"><span class="keyword">final</span> CellStyle cellStyle = workBook.createCellStyle();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//自定义背景色</span></span><br><span class="line">HSSFPalette palette = workbook.getCustomPalette();</span><br><span class="line">palette.setColorAtIndex(IndexedColors.GREY_25_PERCENT.getIndex(), (<span class="keyword">byte</span>) <span class="number">214</span>, (<span class="keyword">byte</span>) <span class="number">220</span>, (<span class="keyword">byte</span>) <span class="number">228</span>);</span><br><span class="line"><span class="comment">//单元格颜色</span></span><br><span class="line">cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">cellStyle.setFillPattern(HSSFCellStyle.SOLID_FOREGROUND);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//水平居中</span></span><br><span class="line">cellStyle.setAlignment(HSSFCellStyle.ALIGN_CENTER);</span><br><span class="line"><span class="comment">//垂直居中</span></span><br><span class="line">cellStyle.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);</span><br><span class="line"><span class="comment">//水平居左</span></span><br><span class="line">cellStyle.setAlignment(HSSFCellStyle.ALIGN_LEFT);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//下边框</span></span><br><span class="line">cellStyle.setBorderBottom(HSSFCellStyle.BORDER_THIN);</span><br><span class="line"><span class="comment">//左边框</span></span><br><span class="line">cellStyle.setBorderLeft(HSSFCellStyle.BORDER_THIN);</span><br><span class="line"><span class="comment">//上边框</span></span><br><span class="line">cellStyle.setBorderTop(HSSFCellStyle.BORDER_THIN);</span><br><span class="line"><span class="comment">//右边框</span></span><br><span class="line">cellStyle.setBorderRight(HSSFCellStyle.BORDER_THIN);</span><br><span class="line"></span><br><span class="line"><span class="comment">//单元格内容自动换行</span></span><br><span class="line">cellStyle.setWrapText(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//字体</span></span><br><span class="line">HSSFFont font = workbook.createFont();</span><br><span class="line"><span class="comment">//设置字体大小</span></span><br><span class="line">font.setFontHeightInPoints(<span class="number">11</span>);</span><br><span class="line"><span class="comment">//设置字体类型</span></span><br><span class="line">font.setFontName(<span class="string">"等线"</span>);</span><br><span class="line"><span class="comment">//加载字体</span></span><br><span class="line">cellStyle.setFont(font);</span><br></pre></td></tr></table></figure>
<h4 id="输出流"><a href="#输出流" class="headerlink" title="输出流"></a>输出流</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ServletOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            out = resp.getOutputStream();</span><br><span class="line">            <span class="comment">//添加时间，防止文件名字重复</span></span><br><span class="line">            SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd_HHmmss"</span>);</span><br><span class="line">            String timer = sdf.format(<span class="keyword">new</span> Date(System.currentTimeMillis()));</span><br><span class="line">            <span class="comment">//设置信息头</span></span><br><span class="line">            resp.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + </span><br><span class="line">                           URLEncoder.encode(<span class="string">"导出"</span> + <span class="string">"("</span> + timer + <span class="string">")"</span>, <span class="string">"UTF-8"</span>) + <span class="string">".xls"</span>);</span><br><span class="line">            resp.setHeader(<span class="string">"Content-Type"</span>, <span class="string">"application/octet-stream"</span>);</span><br><span class="line">            <span class="comment">//写出文件</span></span><br><span class="line">            workbook.write(out);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//10.关闭输出流</span></span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>Reflection</p>
<p>正常方式：</p>
<pre class="mermaid">graph LR
A(包类名称) --> B(new实例化) --> C(得到实例化对象)</pre>

<p>反射方式：</p>
<pre class="mermaid">graph LR
A(实例化对象) --> B(getClass方法) --> C(得到包类名称)</pre>



<h4 id="类的加载过程与ClassLoader"><a href="#类的加载过程与ClassLoader" class="headerlink" title="类的加载过程与ClassLoader"></a>类的加载过程与ClassLoader</h4><p>Class对象是在运行时、在内存中产生，是动态的。</p>
<h5 id="加载load："><a href="#加载load：" class="headerlink" title="加载load："></a>加载load：</h5><ol>
<li>将javac编译后的.class文件内容加载到内存中，即，将静态数据转换成方法区的运行时数据结构</li>
<li>加载类之后，在堆内存的方法区中，产生一个Class类型的对象（java.lang.Class）。该对象包含了完整的类的结构信息，可以通过这个对象看到类的结构。一个类只有唯一一个Class对象。就像镜子，称之为反射。</li>
</ol>
<h5 id="链接link："><a href="#链接link：" class="headerlink" title="链接link："></a>链接link：</h5><p>目的是将Java类的二进制代码合并到JRE（java runtime environment）中。</p>
<ol>
<li><p>验证：加载的java类信息符合JRE规范，没有安全问题。报错机制。</p>
</li>
<li><p>准备：</p>
<ul>
<li><p>为类变量（static）分配内存</p>
</li>
<li><p>为类变量（static）设置默认值</p>
</li>
</ul>
</li>
<li><p>解析：将常量名（虚拟机常量池内的符号引用）替换为直接引用地址</p>
<ul>
<li>常量：final static int = 324;</li>
</ul>
</li>
</ol>
<h5 id="初始化："><a href="#初始化：" class="headerlink" title="初始化："></a>初始化：</h5><ol>
<li>JVM执行类构造器<clinit>()方法的过程（构造器初始化）</clinit></li>
<li>当初始化一个类时，如果父类还没有初始化，会先父类初始化</li>
<li>虚拟机保证一个类的<clinit>()方法在多线程环境中被正确加锁和同步</clinit></li>
</ol>
<h5 id="什么时候发生类的初始化？"><a href="#什么时候发生类的初始化？" class="headerlink" title="什么时候发生类的初始化？"></a>什么时候发生类的初始化？</h5><p>一、类的主动引用，一定会发生类的初始化：</p>
<ol>
<li>new 一个对象</li>
<li>反射</li>
<li>类的静态成员和静态方法（final常量除外）</li>
<li>首先初始化main方法所在类</li>
<li>首先初始化父类</li>
</ol>
<p>二、类的被动引用，不会发生类的初始化：</p>
<ol>
<li>当子类引用父类的静态变量，子类不会被初始化。【只有真正声明静态域的类才会被初始化】</li>
<li>通过【数组】定义类引用，类不会被初始化。</li>
<li>使用类的【final常量】，类不会被初始化。（链接link阶段已经放入常量池了）</li>
</ol>
<pre class="mermaid">graph TB

A(程序调用类) --> B{类是否在内存中}
B --否--> C
subgraph 类的初始化 
    C(类的加载Load) --> C2(类的链接Link) --> C3(类的初始化Initialize)
end

C -.- D1>类加载器,将类的.class读入内存并为之创建一个java.lang.Class对象]
C2 -.- D2>将类的二进制数据合并到JRE中]
C3 -.- D3>JVM负责对类初始化]</pre>



<p>栈</p>
<p>堆</p>
<p>方法区（特殊的堆）</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20200726153025301.png" alt="image-20200726153025301"></p>
<h4 id="哪些元素类型拥有Class对象"><a href="#哪些元素类型拥有Class对象" class="headerlink" title="哪些元素类型拥有Class对象"></a>哪些元素类型拥有Class对象</h4><p>只要元素类型相同，则拥有同一个Class对象</p>
<ol>
<li>class，外部类，成员（成员内部类，静态内部类），局部内部类，匿名内部类</li>
<li>interface</li>
<li>数组</li>
<li>枚举</li>
<li>注解</li>
<li>基本数据类型</li>
<li>void</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 类        </span></span><br><span class="line">Class a1 = Object<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class java.lang.Object</span></span><br><span class="line">Class a11 = Class<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class java.lang.Class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口        </span></span><br><span class="line">Class a2 = Comparable<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// interface java.lang.Comparable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数组        </span></span><br><span class="line">Class a3 = String[]<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class [Ljava.lang.String;</span></span><br><span class="line">Class a31 = <span class="keyword">int</span>[][]<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class [[I</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 枚举</span></span><br><span class="line">Class a4 = ElementType<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class java.lang.annotation.ElementType</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注解</span></span><br><span class="line">Class a5 = Override<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// interface java.lang.Override</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基本数据类型</span></span><br><span class="line">Class a6 = <span class="keyword">int</span><span class="class">.<span class="keyword">class</span></span>; <span class="comment">// int</span></span><br><span class="line">Class a61 = Integer<span class="class">.<span class="keyword">class</span></span>; <span class="comment">// class java.lang.Integer</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// void</span></span><br><span class="line">Class a7 = <span class="keyword">void</span><span class="class">.<span class="keyword">class</span></span>; <span class="comment">// void</span></span><br></pre></td></tr></table></figure>
<h4 id="创建Class对象的方式"><a href="#创建Class对象的方式" class="headerlink" title="创建Class对象的方式"></a>创建Class对象的方式</h4><ol>
<li>通过类的<code>class</code>获取。最安全可靠、性能最高</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz = User<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line"></span><br><span class="line">Class clazz = String<span class="class">.<span class="keyword">class</span></span>;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>通过类的实例的<code>getClass()</code>方法获取。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">Class clazz = user.getClass();</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>通过<code>Class.forName(&quot;类的全类名&quot;)</code>获取。可能存在<code>ClassNotFoundException</code>异常。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz = Class.forName(<span class="string">"demo.User"</span>);</span><br><span class="line"></span><br><span class="line">Class clazz = Class.forName(<span class="string">"java.lang.String"</span>);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>内置基本类型的包装类可直接使用<code>类名.Type</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class clazz = Integer.TYPE;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>利用<code>ClassLoader</code></li>
</ol>
<h4 id="Class对象的用途"><a href="#Class对象的用途" class="headerlink" title="Class对象的用途"></a>Class对象的用途</h4><h5 id="动态的创建一个新的实例newInstance"><a href="#动态的创建一个新的实例newInstance" class="headerlink" title="动态的创建一个新的实例newInstance"></a>动态的创建一个新的实例newInstance</h5><ol>
<li>默认调用类的无参构造器</li>
<li>类构造器必须有足够的访问权限</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 无参数构造器，构造对象 newInstance</span></span><br><span class="line">Class userClazz = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">User userNew = (User) userClazz.newInstance();</span><br><span class="line">System.out.println(userNew);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有参数构造器，构造对象 constructor + newInstance</span></span><br><span class="line">Class userClazz1 = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">Constructor constructor = userClazz1.getDeclaredConstructor(String<span class="class">.<span class="keyword">class</span>, <span class="title">int</span>.<span class="title">class</span>)</span>;</span><br><span class="line">User userNew1 = (User) constructor.newInstance(<span class="string">"niceId"</span>, <span class="number">23</span>);</span><br><span class="line">System.out.println(userNew1);</span><br></pre></td></tr></table></figure>
<h5 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h5><ol>
<li>getDeclaredMethod 根据方法名获取方法</li>
<li>invoke 调用方法</li>
<li>反射操作方法，比直接调用更灵活，因为方法名，可以作为字符串参数传进去</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class userClazz = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">User userNew = (User) userClazz.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接调用</span></span><br><span class="line">userNew.setAge(<span class="number">23</span>);</span><br><span class="line">userNew.setId(<span class="string">"newId"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反射的形式调用</span></span><br><span class="line">Method setStudent = userClazz.getDeclaredMethod(<span class="string">"setStudent"</span>, <span class="keyword">boolean</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">setStudent.invoke(userNew, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(userNew);</span><br></pre></td></tr></table></figure>
<h5 id="调用属性"><a href="#调用属性" class="headerlink" title="调用属性"></a>调用属性</h5><ol>
<li>getDeclaredField 根据属性名获取属性</li>
<li>set</li>
<li>默认情况下，由于类的属性是私有属性private，所以不能直接操作。通过setAccessible(true)来关闭程序的安全监测，从而可以操作私有属性。默认是setAccessible(false)。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class userClazz = Class.forName(<span class="string">"User"</span>);</span><br><span class="line">User userNew = (User) userClazz.newInstance();</span><br><span class="line"></span><br><span class="line">Field age = userClazz.getDeclaredField(<span class="string">"age"</span>);</span><br><span class="line">age.setAccessible(<span class="keyword">true</span>); <span class="comment">// true,则关闭程序的安全监测，从而可以操作私有属性</span></span><br><span class="line">age.set(userNew, <span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(userNew);</span><br></pre></td></tr></table></figure>
<h5 id="setAccessible"><a href="#setAccessible" class="headerlink" title="setAccessible"></a>setAccessible</h5><p>用于启动（默认fasle）或关闭（true）访问安全检查的开关，如此可以直接处理类中的私有属性、私有方法等。以下都有setAccessible方法：</p>
<ol>
<li>Method 方法</li>
<li>Field 属性</li>
<li>Constructor 构造器</li>
</ol>
<p>关闭安全检查，可以提高性能。</p>
<h5 id="操作泛型"><a href="#操作泛型" class="headerlink" title="操作泛型"></a>操作泛型</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbReflectAnnotation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Class dbReflectAnnotationClazz = Class.forName(<span class="string">"DbReflectAnnotation"</span>);</span><br><span class="line">        Method method01 = dbReflectAnnotationClazz.getMethod(<span class="string">"test01"</span>, Map<span class="class">.<span class="keyword">class</span>, <span class="title">List</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        Type[] genericParameterTypes = method01.getGenericParameterTypes();</span><br><span class="line">        <span class="keyword">for</span> (Type genericParameterType : genericParameterTypes) &#123;</span><br><span class="line">            System.out.println(genericParameterType);</span><br><span class="line">            <span class="keyword">if</span> (genericParameterType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">                Type[] actualTypeArguments = ((ParameterizedType) genericParameterType).getActualTypeArguments();</span><br><span class="line">                <span class="keyword">for</span> (Type actualTypeArgument : actualTypeArguments) &#123;</span><br><span class="line">                    System.out.println(actualTypeArgument);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">        Method method02 = dbReflectAnnotationClazz.getMethod(<span class="string">"test02"</span>);</span><br><span class="line">        Type genericReturnType = method02.getGenericReturnType();</span><br><span class="line">        System.out.println(genericReturnType);</span><br><span class="line">        <span class="keyword">if</span> (genericReturnType <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">            Type[] actualTypeArguments = ((ParameterizedType) genericReturnType).getActualTypeArguments();</span><br><span class="line">            <span class="keyword">for</span> (Type actualTypeArgument : actualTypeArguments) &#123;</span><br><span class="line">                System.out.println(actualTypeArgument);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">(Map&lt;String, Integer&gt; map, List&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"参数是泛型"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Integer, String&gt; <span class="title">test02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"结果是泛型"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="操作注解"><a href="#操作注解" class="headerlink" title="操作注解"></a>操作注解</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbReflectAnnotation</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException </span>&#123;</span><br><span class="line">        Class personClazz = Class.forName(<span class="string">"Person"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取指定注解</span></span><br><span class="line">        DBTable annotation = (DBTable) personClazz.getAnnotation(DBTable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(annotation);</span><br><span class="line">        System.out.println(annotation.value());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历全部注解</span></span><br><span class="line">        Annotation[] annotations = personClazz.getAnnotations();</span><br><span class="line">        <span class="keyword">for</span> (Annotation annotation1 : annotations) &#123;</span><br><span class="line">            System.out.println(annotation1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Field[] fields = personClazz.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">            DBField field1 = field.getAnnotation(DBField<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            System.out.println(field1);</span><br><span class="line">            System.out.println(field1.name());</span><br><span class="line">            System.out.println(field1.type());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DBTable</span>(<span class="string">"person"</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="meta">@DBField</span>(name = <span class="string">"id"</span>, type = <span class="string">"int"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DBField</span>(name = <span class="string">"name"</span>, type = <span class="string">"varchar"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DBField</span>(name = <span class="string">"age"</span>, type = <span class="string">"int"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@interface</span> DBTable &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@interface</span> DBField &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">type</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h5><p>正常效率最高 &gt; 反射（关闭检测） &gt; 反射（启动检测）效率最低</p>
]]></content>
  </entry>
  <entry>
    <title>java数据校验</title>
    <url>/want/2020/11/24/java%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><h4 id="数据校验（Bean-Validation）"><a href="#数据校验（Bean-Validation）" class="headerlink" title="数据校验（Bean Validation）"></a>数据校验（Bean Validation）</h4><ol>
<li>Bean Validation是将校验逻辑与相应的Bean域模型进行绑，是基于Bean的校验。</li>
<li>契约式编程：避免了if else 等硬编码校验（能通过契约约定解决的就不要去硬编码）。</li>
<li>面向接口编程：Bean Validation属于Java EE标准规范，是JSR（Java Specification Requests）抽象的具体实现，实际使用过程中仅需要面向标准使用即可。</li>
</ol>
<p><img src="C:\Users\luxia\AppData\Local\YNote\data\wythyw@163.com\1116f7dea63d49fd8a64edd9a8e93b53\clipboard.png" alt="img"></p>
<h4 id="JSR标准"><a href="#JSR标准" class="headerlink" title="JSR标准"></a>JSR标准</h4><p>JSR（Java Specification Requests），为需要校验的JavaBean，定义了源数据模型 和 API。</p>
<p><strong>版本变迁：</strong></p>
<p>JSR303，2009年，Java Bean Validation 1.0</p>
<ul>
<li>规定了Java数据校验的模型和API</li>
<li>只支持对Java Bean进行校验</li>
</ul>
<p>JSR349，2013年，Bean Validation 1.1，伴随着Java EE 7一起发布</p>
<ul>
<li>支持方法级验证(入参或返回值的验证)</li>
<li>Bean验证组件的依赖注入</li>
</ul>
<p>JSR380，2019，Java Bean Validation 2.0和Jakarta Bean Validation 2.0（两者只有名字的区别），当前主流。</p>
<ul>
<li>JDK最低版本要求：JDK 8</li>
<li>一些新增的标准</li>
</ul>
<h4 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h4><p>由Java Bean Validation变为Jakarta Bean Validation。（雅加达）</p>
<p>2018年03月， Oracle 把 JavaEE （Java Enterprise Edition）移交给开源组织 Eclipse 基金会，并把Java EE（包名javax）改为Jakarta EE。Eclipse接手后发布的首个Enterprise Java将是 Jakarta EE 9，该版本将以Java EE 8作为其基准版本（最低版本要求是Java8）</p>
<p>由于上述版本迁移问题，maven包由<code>javax</code>和<code>jakarta</code>下的两种坐标，但目前2.0.1版本下，内容完全一样：</p>
<ol>
<li>javax.validation到2.0.1.Final版本就彻底结束了，不再升级。</li>
<li>jakarta.validation从2.0.1版本开始。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.validation/validation-api --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/jakarta.validation/jakarta.validation-api --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>目前最新版本是Jakarta Bean Validation 3.0，它唯一的变化，只是包名。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/jakarta.validation/jakarta.validation-api --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>不只是校验包，其他包名也有更改，如”javax.servlet.”改成了”jakarta.servlet.”</p>
<blockquote>
<p> <code>java.*</code>：java SE的标准库，是对外承诺的java开发接口。会保持向后兼容，不会轻易修改。<br> <code>javax.*</code>： java的扩展包，如servelet/xml/validation等。属于某特定领域，不是普遍的api。被官方支持，兼容所有java支持的平台。</p>
<p> <code>com.sun.*</code>：不被官方支持，不推荐使用。是sun的hotspot虚拟机中<code>java.*</code> 和<code>javax.*</code>的实现类。因包含在rt中，故也可调用。但因为不是sun对外公开承诺的接口，所以根据实现的需要随时增减，不保证api跨平台（linux和windows的api可能不一样）、兼容版本（在不同版本的hotspot中可能不同)。<br> <code>org.omg.*</code>：大部分不是sun公司提供的，不具备向后兼容性，会根据需要随时增减。其中比较常用的是w3c提供的对XML、网页、服务器的类和接口。</p>
<p> HotSpot 虚拟机: 是Sun JDK和OpenJDK中所带的虚拟机，是目前使用范围最广的Java虚拟机。</p>
</blockquote>
<h3 id="起步案例"><a href="#起步案例" class="headerlink" title="起步案例"></a>起步案例</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.hibernate.validator/hibernate-validator --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">	<span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">	<span class="meta">@Min</span>(<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">public</span> Integer age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Person person = <span class="keyword">new</span> Person();</span><br><span class="line">    person.setAge(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、使用【默认配置】得到一个校验工厂</span></span><br><span class="line">    ValidatorFactory validatorFactory = Validation.buildDefaultValidatorFactory();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、得到一个校验器</span></span><br><span class="line">    Validator validator = validatorFactory.getValidator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、校验Java Bean,解析注解返回校验结果</span></span><br><span class="line">    Set&lt;ConstraintViolation&lt;Person&gt;&gt; result = validator.validate(person);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出校验结果</span></span><br><span class="line">    result.stream().map(v -&gt; v.getPropertyPath() + <span class="string">" "</span> + v.getMessage() + <span class="string">": "</span> + v.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常见约束注解"><a href="#常见约束注解" class="headerlink" title="常见约束注解"></a>常见约束注解</h3><p>多个可以组合发挥作用，如  @Min(value = 10,message = “年龄最小为10”)@Max(value = 100,message = “年龄最大为100”)。</p>
<p>除了内置校验，也可以自定义校验注解：</p>
<ol>
<li><p>首先必须定义一个注解</p>
</li>
<li><p>然后才实现自定义校验类（具体逻辑）</p>
</li>
</ol>
<h4 id="BeanValidation内置"><a href="#BeanValidation内置" class="headerlink" title="BeanValidation内置"></a>BeanValidation内置</h4><table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Valid</td>
<td>被注释的元素是一个对象，需要检查此对象的所有字段值。适用于嵌套。@Valid注解用于验证<strong>级联</strong>的属性、方法参数或方法返回类型。比如你的属性仍旧是个Java Bean，你想深入进入校验它里面的约束，那就在此属性头上标注此注解即可。另外，通过使用@Valid可以实现<strong>递归验证</strong>，因此可以标注在List上，对它里面的每个对象都执行校验</td>
</tr>
<tr>
<td>@Null</td>
<td>被注释的元素必须为 null</td>
</tr>
<tr>
<td>@NotNull</td>
<td>被注释的元素必须不为 null</td>
</tr>
<tr>
<td>@AssertTrue</td>
<td>被注释的元素必须为 true</td>
</tr>
<tr>
<td>@AssertFalse</td>
<td>被注释的元素必须为 false</td>
</tr>
<tr>
<td>@Min(value)</td>
<td>被注释的元素必须是一个数字，其值必须大于等于指定的最小值</td>
</tr>
<tr>
<td>@Max(value)</td>
<td>被注释的元素必须是一个数字，其值必须小于等于指定的最大值</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>@DecimalMin(value)</td>
<td>被注释的元素必须是一个数字，其值必须大于等于指定的最小值</td>
</tr>
<tr>
<td>@DecimalMax(value)</td>
<td>被注释的元素必须是一个数字，其值必须小于等于指定的最大值</td>
</tr>
<tr>
<td>@Size(max, min)</td>
<td>被注释的元素的大小必须在指定的范围内@Size(min = 1,max = 10,message = “姓名长度必须为1到10”)</td>
</tr>
<tr>
<td>@Digits (integer, fraction)</td>
<td>被注释的元素必须是一个数字，其值必须在可接受的范围内</td>
</tr>
<tr>
<td>@Past</td>
<td>被注释的元素必须是一个过去的日期</td>
</tr>
<tr>
<td>@Future</td>
<td>被注释的元素必须是一个将来的日期。必须是相对当前时间来讲“未来的”某个时间 @Future@JSONField(format=”yyyy-MM-dd HH:mm:ss”)private Date birth;</td>
</tr>
<tr>
<td>@Pattern(value)</td>
<td>被注释的元素必须符合指定的正则表达式</td>
</tr>
<tr>
<td>@GroupSequence</td>
<td>控制校验顺序。</td>
</tr>
</tbody>
</table>
<h4 id="HibernateValidator附加"><a href="#HibernateValidator附加" class="headerlink" title="HibernateValidator附加"></a>HibernateValidator附加</h4><p>也内置在springboot中了</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Email</td>
<td>被注释的元素必须是电子邮箱地址</td>
</tr>
<tr>
<td>@Length(min=, max=)</td>
<td>被注释的字符串的大小必须在指定的范围内</td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>被注释的字符串的必须非空</td>
</tr>
<tr>
<td>@Range(min=, max=)</td>
<td>被注释的元素必须在合适的范围内</td>
</tr>
<tr>
<td>@GroupSequenceProvider</td>
<td>比@GroupSequence更强大的控制group调用注解（字段之间校验依赖）</td>
</tr>
<tr>
<td>@NotBlank</td>
<td>被注释的字符串的必须非空</td>
</tr>
<tr>
<td>@URL(protocol=,host=,    port=, regexp=, flags=)</td>
<td>被注释的字符串必须是一个有效的url</td>
</tr>
<tr>
<td>@CreditCardNumber</td>
<td>被注释的字符串必须通过Luhn校验算法，银行卡，信用卡等号码一般都用Luhn计算合法性</td>
</tr>
<tr>
<td>@ScriptAssert(lang=, script=, alias=)</td>
<td>要有Java Scripting API 即JSR 223 (“Scripting for the JavaTM Platform”)的实现</td>
</tr>
<tr>
<td>@SafeHtml(whitelistType=, additionalTags=)</td>
<td>classpath中要有jsoup包</td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="非空判断注解的区别"><a href="#非空判断注解的区别" class="headerlink" title="非空判断注解的区别"></a>非空判断注解的区别</h4><ol>
<li>@NotNull 用在基本类型上,不能为null，但可以为空字符串</li>
<li>@NotBlank 用在String上面,只能作用在String上，不能为null，而且调用trim()后，长度必须大于0（不能是空字符串）</li>
<li>@NotEmpty用在集合类上面,不能为null，并且长度必须大于0、</li>
</ol>
<p>kotlin的写法略有不同</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">For a field @field:NotBlank</span><br><span class="line"></span><br><span class="line">For a getter @get:NotBlank</span><br><span class="line"></span><br><span class="line">For a constructor @param:NotBlank</span><br></pre></td></tr></table></figure>
<h4 id="groups"><a href="#groups" class="headerlink" title="groups"></a>groups</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IpRequired</span> </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 应用到字段等</span></span><br><span class="line"><span class="meta">@NotNull</span>(groups = IpRequired<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">Integer</span> <span class="title">ipAddress</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只校验ipAddress字段，其他不校验</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAllUserByName</span><span class="params">(@Validated(IpRequired.class)</span> User user) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAllUserByBigAge</span><span class="params">(@Validated(&#123;CHECK.class, IpRequired.class&#125;)</span> User user) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GroupSequence"><a href="#GroupSequence" class="headerlink" title="@GroupSequence"></a>@GroupSequence</h4><ul>
<li>在使用组序列验证的时候，如果序列前边的组验证失败，则后面的组将不再给予验证。</li>
<li>控制group校验顺序，实现参数的顺序校验（默认情况下，不同group的约束校验无序）</li>
<li>Bean Validation 中内置的标准注解</li>
</ul>
<p>顺序只能控制在分组级别，无法控制在约束注解级别。因为一个类内的约束（同一分组内），它的顺序是Set&lt;MetaConstraint&lt;?&gt;&gt; metaConstraints来保证的，所以可以认为同一分组内的校验器是没有有执行先后顺序的（不管是类、属性、方法、构造器…)</p>
<p>约束验证的顺序和短路能力，在某些场景十分重要：</p>
<ol>
<li>第一个约束正确，第二个约束才有意义。</li>
<li>对于性能消耗非常大的约束，应该把它放到最后</li>
</ol>
<p>实现GroupIpInfoBean中，先校验IAreaCkeckSequence，再校验GroupIpInfoBean自己。而IAreaCkeckSequence中，又先校验省IProvinceCheck，地市ICityCheck，再区县ICountyCheck。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IProvinceCheck</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICityCheck</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICountyCheck</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GroupSequence</span>(&#123;IProvinceCheck<span class="class">.<span class="keyword">class</span>,<span class="title">ICityCheck</span>.<span class="title">class</span>,<span class="title">ICountyCheck</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">IAreaCkeckSequence</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GroupSequence</span>(&#123;IAreaCkeckSequence<span class="class">.<span class="keyword">class</span>,<span class="title">GroupIpInfoBean</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">GroupIpInfoBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValidAnnotation</span>(message = <span class="string">"所属省份不符合枚举要求"</span>,target = <span class="string">"area-province"</span>,field = <span class="string">"belongProvince"</span>,groups = &#123;IProvinceCheck<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">belongProvince</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValidAnnotation</span>(message = <span class="string">"所属地市不符合枚举要求"</span>,target = <span class="string">"area-city"</span>,field = <span class="string">"belongCity"</span>,groups = &#123;ICityCheck<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">belongCity</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EnumValidAnnotation</span>(message = <span class="string">"所属区县不符合枚举要求"</span>,target = <span class="string">"area-county"</span>,field = <span class="string">"belongCounty"</span>,groups = &#123;ICountyCheck<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">belongCounty</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他字段校验</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="GroupSequenceProvider"><a href="#GroupSequenceProvider" class="headerlink" title="@GroupSequenceProvider"></a>@GroupSequenceProvider</h4><p>多字段组合逻辑校验，若想借助@GroupSequence完成，相对来说还是比较困难的。</p>
<ul>
<li>比 @GroupSequence更强大，能够控制group校验，从而实现多种校验场景。</li>
<li>比如多字段联合逻辑校验场景：当且仅当属性a值满足条件时，属性b的校验逻辑才生效</li>
<li>Hibernate Validator 附加的 constraint，非标准</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NetworkGroupSeqProvider</span> <span class="keyword">implements</span> <span class="title">DefaultGroupSequenceProvider</span>&lt;<span class="title">Network</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Class&lt;?&gt;&gt; getValidationGroups(Network network) &#123;</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; defaultGroupSeq = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        defaultGroupSeq.add(Network<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (network != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Integer protocolType = network.getProtocolType();</span><br><span class="line">            Integer circuitType = network.getCircuitType();</span><br><span class="line"></span><br><span class="line">						<span class="comment">// 自定义校验条件</span></span><br><span class="line">            <span class="keyword">if</span> (protocolType == <span class="keyword">null</span> || circuitType == <span class="keyword">null</span></span><br><span class="line">                    || !(protocolType == <span class="number">2</span> || circuitType == <span class="number">2</span>)</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// 必填</span></span><br><span class="line">                defaultGroupSeq.add(Network.IpRequired<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> defaultGroupSeq;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="meta">@GroupSequenceProvider</span>(NetworkGroupSeqProvider<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">Network</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span>(groups = IpRequired<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">Range</span>(<span class="title">min</span> </span>= <span class="number">0</span>, max = <span class="number">1</span>, message = <span class="string">"是否固定IP取值不在0~1范围内"</span>, groups = IpRequired<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Integer</span> <span class="title">ipAddress</span></span>;</span><br><span class="line"></span><br><span class="line">   	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IpRequired</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Bean-Validation四种约束级别"><a href="#Bean-Validation四种约束级别" class="headerlink" title="Bean Validation四种约束级别"></a>Bean Validation四种约束级别</h3><ol>
<li>字段约束（Field）</li>
<li>属性约束（Property）</li>
<li>容器<strong>元素</strong>约束（Container Element）</li>
<li>类约束（Class）</li>
</ol>
<p>Bean Validation标准的约束全部支持1/2/3级别，全部不支持第4级。</p>
<p>作为补充的Hibernate-Validator提供了一些专门用于类级别的约束注解。</p>
<h4 id="字段约束Field"><a href="#字段约束Field" class="headerlink" title="字段约束Field"></a>字段约束Field</h4><p>最常见。</p>
<p>不支持对静态字段static的约束。</p>
<p>直接反射访问字段的值 -&gt; Field#get（不会执行get方法体）。不会调用任何方法来进行校验，比如对应的get/set方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">  <span class="meta">@Size</span>(min=<span class="number">3</span>,max = <span class="number">50</span>)</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="自定义字段注解"><a href="#自定义字段注解" class="headerlink" title="自定义字段注解"></a>自定义字段注解</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.FIELD, ElementType.PARAMETER&#125;)</span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123;InStrListImp<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">InStrList</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    指定的有效值，多个使用,隔开</span></span><br><span class="line">    <span class="function">String <span class="title">values</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    无效时的提示内容</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "必须在逗号隔开的字符串列表中"</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InStrListImp</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">InStrList</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String values;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回true表示符合逻辑</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Object value, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        String[] valueArray = values.split(<span class="string">","</span>);</span><br><span class="line">        Boolean isFlag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueArray.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 存在一致就跳出循环</span></span><br><span class="line">            <span class="keyword">if</span> (valueArray[i].equals(value)) &#123;</span><br><span class="line">                isFlag = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isFlag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(InStrList inStrList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.values = inStrList.values();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>枚举自定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="meta">@ValidEnum</span>(type = IfConstantsEnum<span class="class">.<span class="keyword">class</span>, <span class="title">ignoreNull</span> </span>= <span class="keyword">false</span>)</span><br><span class="line"><span class="keyword">private</span> Integer cakes;</span><br><span class="line"><span class="comment">// 枚举定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICompareEnum</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">getComparedValue</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> IfConstantsEnum implements ICompareEnum &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getComparedValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="comment">// 定义需要枚举校验的值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.index;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义枚举注解</span></span><br><span class="line"><span class="meta">@Target</span>(&#123; METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER &#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123; EnumValidator<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">ValidEnum</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "枚举值不合法"</span>;</span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Enum&lt;?&gt;&gt; type();</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">ignoreNull</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Defines several &#123;<span class="doctag">@link</span> ValidEnum&#125; annotations on the same element.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ValidEnum</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Target</span>(&#123; METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER &#125;)</span><br><span class="line">    <span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@interface</span> List &#123;</span><br><span class="line">        ValidEnum[] value();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EnumValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">ValidEnum</span>, <span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;? extends Enum&lt;?&gt;&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreNull;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> ValidEnum constraintAnnotation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.type = constraintAnnotation.type();</span><br><span class="line">        <span class="keyword">this</span>.ignoreNull = constraintAnnotation.ignoreNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(<span class="keyword">final</span> Object value, <span class="keyword">final</span> ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (type == <span class="keyword">null</span> || (value == <span class="keyword">null</span> &amp;&amp; ignoreNull)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Enum&lt;?&gt; element : type.getEnumConstants()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ICompareEnum<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">type</span>)) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (value.equals(((ICompareEnum) element).getComparedValue())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (value.equals(element.name())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="属性约束Property"><a href="#属性约束Property" class="headerlink" title="属性约束Property"></a>属性约束Property</h4><p>若一个Bean遵循Java Bean规范（getter/setter），则可使用属性约束来代替字段约束。</p>
<p>会调用属性get方法 -&gt; getXXX（会执行get方法体）来获取待校验的值。</p>
<ol>
<li>约束放在get方法上<strong>优于</strong>放在set方法上，这样只读属性（没有set方法）依然可以执行约束逻辑</li>
<li>不要在<strong>属性和字段</strong>上都标注注解，否则会重复执行约束逻辑（有多少个注解就执行多少次）</li>
<li>不要既在属性的get方法上又在set方法上标注约束注解。</li>
</ol>
<p>如果希望执行了验证就输出一句日志，又或者POJO被字节码增强了，建议使用属性约束。</p>
<p>字节码增强：<a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html" target="_blank" rel="noopener">https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@NotNull</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="容器元素级别约束Container-Element"><a href="#容器元素级别约束Container-Element" class="headerlink" title="容器元素级别约束Container Element"></a>容器元素级别约束Container Element</h4><p>容器，List、Set、Map等。</p>
<p>验证容器内（每个）元素，形如<code>List&lt;User&gt;</code>希望验证List容器内部元素User。</p>
<p>必须基于Java Bean，验证才会生效，所以需要将容器（List等），封装成Bean来使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserList</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 对于Hibernate-Validator6.0之前,验证容器元素时必填@Valid，后续版本非必填</span></span><br><span class="line">    <span class="comment">// 支持Bean Validator和Hibernate-Validator</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;<span class="meta">@Valid</span> <span class="meta">@NotNull</span> User&gt; userList;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserList</span><span class="params">(List&lt;@Valid @NotNull User&gt; userList)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">this</span>.userList = userList;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">List&lt;<span class="meta">@NotNull</span> User&gt; userList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">userList.add(<span class="keyword">null</span>);</span><br><span class="line">userList.add(<span class="keyword">new</span> User());</span><br><span class="line">User user = <span class="keyword">new</span> User();</span><br><span class="line">user.setName=<span class="string">"haha"</span>;</span><br><span class="line">userList.add(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须基于Java Bean，验证才会生效</span></span><br><span class="line">UserList userListValidate = <span class="keyword">new</span> UserList(userList);</span><br></pre></td></tr></table></figure>
<h5 id="自定义容器元素"><a href="#自定义容器元素" class="headerlink" title="自定义容器元素"></a><strong>自定义容器</strong>元素</h5><p>某些容器不被支持校验，如Result<t>，可以自定义容器元素。</t></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 首先注册一个值提取器，ValueExtractor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultValueExtractor</span> <span class="keyword">implements</span> <span class="title">ValueExtractor</span>&lt;<span class="title">Result</span>&lt;@<span class="title">ExtractedValue</span> ?&gt;&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extractValues</span><span class="params">(Result&lt;?&gt; originalValue, ValueReceiver receiver)</span> </span>&#123;</span><br><span class="line">        receiver.value(<span class="keyword">null</span>, originalValue.getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Result&lt;<span class="meta">@Valid</span> User&gt; userResult; </span><br><span class="line">&#125;</span><br><span class="line">                    </span><br><span class="line">   	User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.name = <span class="string">"nice"</span>;</span><br><span class="line">    Result&lt;User&gt; result = <span class="keyword">new</span> Result&lt;&gt;();</span><br><span class="line">    result.setData(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把Result作为属性放进去</span></span><br><span class="line">    ResultDemo resultDemo = <span class="keyword">new</span> ResultDemo();</span><br><span class="line">    resultDemo.userResult = result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册自定义的值提取器</span></span><br><span class="line">    Validator validator = ValidatorUtil.obtainValidatorFactory()</span><br><span class="line">            .usingContext()</span><br><span class="line">            <span class="comment">//将自定义值提取器注册到Validator中</span></span><br><span class="line">            .addValueExtractor(<span class="keyword">new</span> ResultValueExtractor())</span><br><span class="line">            .getValidator();</span><br><span class="line">                    </span><br><span class="line">    ValidatorUtil.printViolations(validator.validate(resultDemo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SpringBoot实现</p>
<p>需要自行提供一个验证器来<strong>覆盖掉</strong>自动装配进去的，可参考<code>ValidationAutoConfiguration</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="类约束Class"><a href="#类约束Class" class="headerlink" title="类约束Class"></a>类约束Class</h4><p><strong>所有的约束注解都会执行，不存在短路效果</strong></p>
<h5 id="ScriptAssert"><a href="#ScriptAssert" class="headerlink" title="@ScriptAssert"></a>@ScriptAssert</h5><p>@ScriptAssert对null值并不免疫，都会执行，因此书写脚本时注意判空</p>
<p>语义上不够明显，需要阅读脚本才知，推荐使用在验证逻辑只用一次（只一个地方使用）且简单（比如只是简单判断而已）的情况。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ScriptAssert</span>(lang = <span class="string">"javascript"</span>, alias = <span class="string">"_"</span>, script = <span class="string">"_.maxStuNum &gt;= _.studentNames.length"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Room</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Positive</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxStuNum;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; studentNames;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">.validate(room)</span><br></pre></td></tr></table></figure>
<h5 id="自定义类注解"><a href="#自定义类注解" class="headerlink" title="自定义类注解"></a>自定义类注解</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 类注解</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;TYPE, ANNOTATION_TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123;ValidStudentCountConstraintValidator<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> @<span class="title">interface</span> <span class="title">ValidStudentCount</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "学生人数超过最大限额"</span>;</span><br><span class="line">    <span class="comment">// String message() default "&#123;com.example.validation.ValidAddress.message&#125;";</span></span><br><span class="line">                    </span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidStudentCountConstraintValidator</span> <span class="keyword">implements</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">ValidStudentCount</span>, <span class="title">Room</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ValidStudentCount constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(Room room, ConstraintValidatorContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (room == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isValid = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (room.getStudentNames().size() &lt;= room.getMaxStuNum()) &#123;</span><br><span class="line">            isValid = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义提示语（当然你也可以不自定义，那就使用注解里的message字段的值）</span></span><br><span class="line">        <span class="keyword">if</span> (!isValid) &#123;</span><br><span class="line">            context.disableDefaultConstraintViolation();</span><br><span class="line">            context.buildConstraintViolationWithTemplate(<span class="string">"校验失败xxx"</span>)</span><br><span class="line">                    .addPropertyNode(<span class="string">"studentNames"</span>)</span><br><span class="line">                    .addConstraintViolation();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isValid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="meta">@ValidStudentCount</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Room</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SpringBoot校验应用场景"><a href="#SpringBoot校验应用场景" class="headerlink" title="SpringBoot校验应用场景"></a>SpringBoot校验应用场景</h3><p>上述已经定义好的四种约束，如何使用呢？</p>
<p>备注：java代码的侵入性强。可以通过两种AOP方式减少侵入：</p>
<ol>
<li>基于Java EE的@Inteceptors实现</li>
<li>基于Spring Framework实现，此处spring boot为例。</li>
</ol>
<p>Springboot默认集成了BeanValidation和HibernateValidator校验。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/Snailclimb/springboot-guide/blob/master/docs/advanced/spring-bean-validation.md" target="_blank" rel="noopener">https://github.com/Snailclimb/springboot-guide/blob/master/docs/advanced/spring-bean-validation.md</a></p>
<p><strong>@Validated</strong></p>
<p>在Controller 中 请求参数上添加@Validated 标签开启验证</p>
<p>与@Valid异同: @Validated是Spring对@Valid(<strong>javax.validation.Valid</strong>)的一层封装.</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>@Validated</th>
<th>@Valid</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>controller验证Request Body</td>
<td>@Validated</td>
<td>@Valid</td>
<td>抛出MethodArgumentNotValidException，Spring默认转为400（Bad Request）请求</td>
</tr>
<tr>
<td>controller验证PathVariable/RequestParam</td>
<td>类上标注@Validated,并方法参数声明需要的约束注解</td>
<td></td>
<td>抛出ConstraintViolationException</td>
</tr>
<tr>
<td>Service验证,需要组合两个注解使用</td>
<td>类上标注@Validated</td>
<td>并方法参数@Valid</td>
<td></td>
</tr>
<tr>
<td>Bean字段属性上,嵌套校验</td>
<td></td>
<td>@Valid</td>
<td></td>
</tr>
<tr>
<td>构造器</td>
<td></td>
<td>@Valid</td>
<td></td>
</tr>
<tr>
<td>类</td>
<td>@Validated</td>
<td></td>
<td></td>
</tr>
<tr>
<td>分组</td>
<td>@Validated</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// @validated和@valid只能在controller层的参数前面</span></span><br><span class="line"><span class="comment">// Service验证,需要组合两个注解使用示例</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 该请求只校验没分组的字段，school</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAllUser</span><span class="params">(@Valid User user)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"nicecccccccc"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">valid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        com.lean.https.dto.User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setAge(<span class="number">23</span>);</span><br><span class="line">        userService.getAllUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">报错:</span><br><span class="line"></span><br><span class="line">javax.validation.ConstraintViolationException: getAllUser.user.school: 不能为空, getAllUser.user.card: 请输入card</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">BrandMapper</span>, <span class="title">Brand</span>&gt; <span class="keyword">implements</span> <span class="title">BrandService</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">saveBrand</span><span class="params">(@Valid Brand brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> save(brand);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateBrand</span><span class="params">(@Valid Brand brand)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> updateById(brand);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// -----------------------------------------------</span></span><br><span class="line">                    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Brand <span class="title">getBrandByCode</span><span class="params">(@NotBlank String brandCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getById(brandCode);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Validated</span>(&#123;ValidGroup<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">boolean</span> <span class="title">saveBrand</span>(@<span class="title">Valid</span> <span class="title">Brand</span> <span class="title">brand</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> save(brand);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Validated</span>(&#123;ValidGroup<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">boolean</span> <span class="title">updateBrand</span>(@<span class="title">Valid</span> <span class="title">Brand</span> <span class="title">brand</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> updateById(brand);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="路径校验-PathVariable"><a href="#路径校验-PathVariable" class="headerlink" title="路径校验(PathVariable)"></a>路径校验(PathVariable)</h4><p>可以对url地址路径进行正则表达式的校验</p>
<ol>
<li>语法：<code>路径变量:正则表达式</code></li>
<li>当URI不满足正则表达式时，客户端将收到<strong>404错误码</strong>。</li>
<li>而不是通过捕获异常的方式，向前端返回统一的、自定义格式的响应参数。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"detail/&#123;domain:[a-zA-Z]+&#125;/&#123;userId&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPath</span><span class="params">(@PathVariable(<span class="string">"domain"</span>)</span> String group, @<span class="title">PathVariable</span><span class="params">(<span class="string">"userId"</span>)</span> Integer userId) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问：https://localhost/detail/a/2</span></span><br><span class="line"><span class="comment">// 返回404</span></span><br></pre></td></tr></table></figure>
<h4 id="方法参数校验"><a href="#方法参数校验" class="headerlink" title="方法参数校验"></a>方法参数校验</h4><ol>
<li>基本类型参数校验（RequestParam）：需要所在类上增加注解@Validated</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"basic"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="comment">// 该请求需要校验name,age</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getByAge</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Size(min = <span class="number">1</span>, max = <span class="number">10</span>, message = <span class="string">"姓名字符串的长度为1到10"</span>)</span> @<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">            @<span class="title">Min</span><span class="params">(value = <span class="number">10</span>, message = <span class="string">"年龄最小为10"</span>)</span> @<span class="title">Max</span><span class="params">(value = <span class="number">100</span>, message = <span class="string">"年龄最大为100"</span>)</span> @<span class="title">RequestParam</span><span class="params">(<span class="string">"age"</span>)</span> Integer age) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 访问https://localhost/basic?name=12345678901234567890&amp;age=2</span></span><br><span class="line"><span class="comment">// 返回报错：javax.validation.ConstraintViolationException: getByAge.age: 年龄最小为10, getByAge.name: 姓名字符串的长度为1到10</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Bean参数校验</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Java Bean作为入参校验</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(@NotNull @Valid Person person)</span> <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line">    Method currMethod = <span class="keyword">this</span>.getClass().getMethod(<span class="string">"save"</span>, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    Set&lt;ConstraintViolation&lt;PersonService&gt;&gt; validResult = obtainExecutableValidator().validateParameters(<span class="keyword">this</span>, currMethod, <span class="keyword">new</span> Object[]&#123;person&#125;);</span><br><span class="line">    <span class="keyword">if</span> (!validResult.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// ... 输出错误详情validResult</span></span><br><span class="line">        validResult.stream().map(v -&gt; v.getPropertyPath() + <span class="string">" "</span> + v.getMessage() + <span class="string">": "</span> + v.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"参数错误"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Bean返回值校验</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//校验方法返回值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@NotNull</span> <span class="function">Person <span class="title">getOne</span><span class="params">(@NotNull @Min(<span class="number">1</span>)</span> Integer id, String name) <span class="keyword">throws</span> NoSuchMethodException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 模拟逻辑执行，得到一个result</span></span><br><span class="line">    Person result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在结果返回之前校验</span></span><br><span class="line">    Method currMethod = <span class="keyword">this</span>.getClass().getMethod(<span class="string">"getOne"</span>, Integer<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    Set&lt;ConstraintViolation&lt;PersonService&gt;&gt; validResult = obtainExecutableValidator().validateReturnValue(<span class="keyword">this</span>, currMethod, result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!validResult.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 输出错误详情validResult</span></span><br><span class="line">        validResult.stream().map(v -&gt; v.getPropertyPath() + <span class="string">" "</span> + v.getMessage() + <span class="string">": "</span> + v.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"参数错误"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>注解应该写在接口的方法内上还是实现的方法内？</p>
<ul>
<li>如果该方法<strong>是接口方法</strong>的实现，那么可存在如下两种case：</li>
<li><ul>
<li>保持和接口方法<strong>一毛一样</strong>的约束条件（极限情况：接口没约束注解，那你也不能有）</li>
<li>实现类<strong>一个都不写</strong>约束条件，结果就是接口里有约束就有，没约束就没有</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>   @Validated注解应该放在接口（方法）上，还是实现类（方法）上？</p>
   <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@NotNull加到接口,@Validated加到[实现]或者接口都可以</span><br><span class="line"></span><br><span class="line">那么,@Validated加到哪里比较好呢?</span><br><span class="line"></span><br><span class="line">放到实现上的原因:</span><br><span class="line"></span><br><span class="line">(1).更灵活,如果一个接口多个实现的话,需要校验的实现可以对其进行校验,不需要校验的就不用校验参数</span><br><span class="line"></span><br><span class="line">(2).避免坑,如果实现和接口是在不同的maven项目下,接口就可以不用引用hibernate-validator这个包,避免包冲突的坑</span><br><span class="line"></span><br><span class="line">(3).更符合规范,接口是定义方法的规范,@Validated是实现校验,应该放到实现中</span><br><span class="line"></span><br><span class="line">综上,@Validated放到实现上,@NotNull,@Valid等声明放到接口上</span><br></pre></td></tr></table></figure>
<h4 id="对象校验-bean"><a href="#对象校验-bean" class="headerlink" title="对象校验(bean)"></a>对象校验(bean)</h4><p>详见Bean Validation四种约束级别。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字段约束示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">                    </span><br><span class="line">    <span class="meta">@Pattern</span>(regexp =<span class="string">"^[1][3,4,5,6,7,8,9][0-9]&#123;9&#125;$"</span>, message = <span class="string">"手机号格式有误"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer phone;</span><br><span class="line">                    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用 @Validated也可以忽略</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAllUser</span><span class="params">(@Validated User user)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="分组校验-Group"><a href="#分组校验-Group" class="headerlink" title="分组校验(Group)"></a>分组校验(Group)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设置归属组</span></span><br><span class="line">    <span class="meta">@NotNull</span>(groups = NAME<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">String</span> <span class="title">name</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">3</span>, groups = AGE<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Integer</span> <span class="title">age</span></span>;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 定义分组名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NAME</span> </span>&#123;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AGE</span> </span>&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 @Validated(&#123;NAME.class, AGE.class&#125;，只校验这两分组，User其他字段不校验</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAllUser</span><span class="params">(@Validated(&#123;NAME.class, AGE.class&#125;)</span> User user) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"nice"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="全局异常拦截器"><a href="#全局异常拦截器" class="headerlink" title="全局异常拦截器"></a>全局异常拦截器</h3><p>全局异常处理器，将Controller层异常统一封装，并向前端返回校验失败信息。</p>
<ul>
<li>优点：<ul>
<li>将 Controller 层的异常和数据校验的异常进行统一处理，减少模板代码，减少编码量，提升扩展性和可维护性。</li>
<li>去掉了try catch高耦合代码</li>
<li>统一封装，返回给前端一个友好的界面</li>
<li>避免了层层向上抛出异常</li>
</ul>
</li>
<li>缺点：只能处理 Controller 层未捕获（往外抛）的异常，对于 Interceptor（拦截器）层的异常，Spring 框架层的异常，就无能为力了</li>
</ul>
<p>实现方式：</p>
<ol>
<li>Spring的AOP（复杂）</li>
<li><code>@ControllerAdvice</code>结合<code>@ExceptionHandler</code>（简单）</li>
</ol>
<h4 id="ControllerAdvice"><a href="#ControllerAdvice" class="headerlink" title="@ControllerAdvice"></a>@ControllerAdvice</h4><p>@ControllerAdvice注解源码中被@Component标记，所以可以被组件扫描到Spring容器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// controller通知器</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerExceptionAdvice</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 异常类型对应的处理方法</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="comment">// 返回值：给前端的是个String类型</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleValidationException</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@ControllerAdvice使用形式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 全局使用</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 只对某个包下面的controller进行通知</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(basePackages = <span class="string">"com.example.services.nice"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只对某个类（或多个类）下面的controller进行通知</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(basePackageClasses = &#123; MyTokenController<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br></pre></td></tr></table></figure>
<p>@RestControllerAdvice</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@RestControllerAdvice = @ControllerAdvice + @ResponseBody</span><br><span class="line"></span><br><span class="line">方法返回值默认作为HTTP Body处理，即默认增加了@ResponseBody注解。</span><br></pre></td></tr></table></figure>
<p>顺序：如果有多个<code>@ControllerAdvice</code>注解类，当第一个加载的注解类里有对需要捕获异常的相同类/父类有方法处理，就会使用第一个处理方法。可@Order指定顺序。</p>
<h4 id="ExceptionHandler"><a href="#ExceptionHandler" class="headerlink" title="@ExceptionHandler"></a>@ExceptionHandler</h4><p>所有异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span></span><br></pre></td></tr></table></figure>
<p>ConstraintViolationException</p>
<ol>
<li>指定参数为方法的<strong>基本参数异常</strong></li>
<li>参数前有@RequestParam</li>
<li>如<a href="http://localhost/user?age=3&amp;name=nice中的age和name校验异常" target="_blank" rel="noopener">http://localhost/user?age=3&amp;name=nice中的age和name校验异常</a></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ExceptionHandler</span>(value = ConstraintViolationException<span class="class">.<span class="keyword">class</span>)</span></span><br></pre></td></tr></table></figure>
<p>MethodArgumentNotValidException</p>
<ol>
<li>指定参数为实体类时异常</li>
<li>实体类前必须有@RequestBody，才能捕获</li>
<li>Content-Type为application/json</li>
</ol>
<p>BindException</p>
<ol>
<li>指定参数为实体类时异常</li>
<li>实体类前没有有@RequestBody，但的确是个实体类</li>
<li>Content-Type为application/x-www-form-urlencoded，即表单请求</li>
</ol>
<p>这两者一般会合起来处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAllUser</span><span class="params">(@Validated User user)</span> </span>&#123;&#125;</span><br><span class="line"><span class="meta">@ExceptionHandler</span>(BindException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">String</span> <span class="title">getAllUser</span>(@<span class="title">Validated</span> @<span class="title">RequestBody</span> <span class="title">User</span> <span class="title">user</span>) </span>&#123;&#125;</span><br><span class="line"><span class="meta">@ExceptionHandler</span>(&#123;MethodArgumentNotValidException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">// 合并写法</span></span><br><span class="line"><span class="class">@<span class="title">ExceptionHandler</span>(</span>&#123;MethodArgumentNotValidException<span class="class">.<span class="keyword">class</span>,<span class="title">BindException</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">List</span>&lt;<span class="title">ObjectError</span>&gt; <span class="title">objectErrors</span> </span>= e <span class="keyword">instanceof</span> BindException</span><br><span class="line">                ? ((BindException) e).getBindingResult().getAllErrors()</span><br><span class="line">                : ((MethodArgumentNotValidException) e).getBindingResult().getAllErrors();</span><br></pre></td></tr></table></figure>
<p>自定义异常</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 捕获</span></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(value = ElegantException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">ResultVO</span> <span class="title">elegantExceptionHandle</span>(<span class="title">ElegantException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ResultVOUtil.error(e.getCode(), e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义异常</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElegantException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElegantException</span><span class="params">(ResultEnum resultEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(resultEnum.getMessage());</span><br><span class="line">        <span class="keyword">this</span>.code = resultEnum.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ElegantException</span><span class="params">(Integer code, String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ElegantException(ResultEnum.PARAM_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>封装返给前端的内容。</p>
<p>包括如下内容：</p>
<ol>
<li>BaseResponseEnum.java 编码常量</li>
<li>ResponseUtil.java 包装类</li>
<li>其他关于返回值的特定封装类：<ul>
<li>自定义ParameterException类，封装参数异常返回</li>
<li>自定义UserAppException类，封装用户程序应用异常类</li>
</ul>
</li>
</ol>
<h5 id="BaseResponseEnum-java-编码常量"><a href="#BaseResponseEnum-java-编码常量" class="headerlink" title="BaseResponseEnum.java 编码常量"></a>BaseResponseEnum.java 编码常量</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IResponse</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getCode</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getMessage</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> BaseResponseEnum implements IResponse &#123;</span><br><span class="line">    SUCCESS(<span class="string">"SC_200"</span>, <span class="string">"成功"</span>),</span><br><span class="line">    PARAMETER_EXCEPTION(<span class="string">"SC_400"</span>, <span class="string">"参数校验错误"</span>),</span><br><span class="line">    AUTHORITY_EXCEPTION(<span class="string">"SC_403"</span>, <span class="string">"权限不足"</span>),</span><br><span class="line">    SYSTEM_EXCEPTION(<span class="string">"SC_500"</span>, <span class="string">"系统错误"</span>),</span><br><span class="line">    BUSINESS_EXCEPTION(<span class="string">"SC_500"</span>, <span class="string">"业务错误"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    BaseResponseEnum(<span class="keyword">final</span> String code, <span class="keyword">final</span> String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ResponseUtil-java-包装类"><a href="#ResponseUtil-java-包装类" class="headerlink" title="ResponseUtil.java 包装类"></a>ResponseUtil.java 包装类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseUtil</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 默认构造器</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ResponseUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 返回成功</span></span><br><span class="line">    <span class="comment">// return ResponseUtil.wrapSuccess();</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseDto&lt;Void&gt; <span class="title">wrapSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseDto&lt;Void&gt;(BaseResponseEnum.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 返回成功 + 内容 </span></span><br><span class="line">    <span class="comment">// return ResponseUtil.wrapSuccess(new UserDto())</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ResponseDto&lt;T&gt; <span class="title">wrapSuccess</span><span class="params">(<span class="keyword">final</span> T body)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseDto&lt;T&gt;(BaseResponseEnum.SUCCESS, body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回成失败</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseDto&lt;Void&gt; <span class="title">wrapException</span><span class="params">(<span class="keyword">final</span> String code, <span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseDto&lt;Void&gt;(code, message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ApplicationException，用户定义应用程序异常</span></span><br><span class="line">		<span class="comment">// return IrmsResponseUtil.wrapException(e)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseDto&lt;Void&gt; <span class="title">wrapException</span><span class="params">(<span class="keyword">final</span> ApplicationException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseDto&lt;Void&gt;(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exception，所有异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ResponseDto&lt;Void&gt; <span class="title">wrapException</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wrapException(<span class="keyword">new</span> SystemException(e));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="UserAppException自定义异常类（用户程序应用异常类）"><a href="#UserAppException自定义异常类（用户程序应用异常类）" class="headerlink" title="UserAppException自定义异常类（用户程序应用异常类）"></a>UserAppException自定义异常类（用户程序应用异常类）</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAppException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> <span class="keyword">implements</span> <span class="title">IResponse</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BaseResponseEnum.SYSTEM_EXCEPTION.getMessage());</span><br><span class="line">        <span class="keyword">this</span>.code = BaseResponseEnum.SYSTEM_EXCEPTION.getCode();</span><br><span class="line">        <span class="keyword">this</span>.message = BaseResponseEnum.SYSTEM_EXCEPTION.getMessage();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationException</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">        <span class="keyword">this</span>.code = BaseResponseEnum.SYSTEM_EXCEPTION.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ApplicationException</span><span class="params">(<span class="keyword">final</span> String code, <span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ParameterException类"><a href="#ParameterException类" class="headerlink" title="ParameterException类"></a>ParameterException类</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterException</span> <span class="keyword">extends</span> <span class="title">UserAppException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PARAM_CODE = BaseResponseEnum.PARAMETER_EXCEPTION.getCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PARAM_MESSAGE = BaseResponseEnum.PARAMETER_EXCEPTION.getMessage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String code;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParameterException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.code = DEFAULT_PARAM_CODE;</span><br><span class="line">        <span class="keyword">this</span>.message = DEFAULT_PARAM_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParameterException</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(DEFAULT_PARAM_CODE, message);</span><br><span class="line">        <span class="keyword">this</span>.code = DEFAULT_PARAM_CODE;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParameterException</span><span class="params">(<span class="keyword">final</span> String code, <span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(code, message);</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="拦截案例"><a href="#拦截案例" class="headerlink" title="拦截案例"></a>拦截案例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerExceptionAdvice</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ControllerExceptionAdvice<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">// 实体类参数校验</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123; BindException<span class="class">.<span class="keyword">class</span>, <span class="title">MethodArgumentNotValidException</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseDto</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleValidationException</span>(<span class="title">final</span> <span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        List&lt;FieldError&gt; errors = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BindException) &#123;</span><br><span class="line">            errors = ((BindException) e).getFieldErrors();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodArgumentNotValidException) &#123;</span><br><span class="line">            errors = ((MethodArgumentNotValidException) e).getBindingResult().getFieldErrors();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.wrapException(<span class="keyword">new</span> ParameterException(<span class="keyword">this</span>.getFieldErrorString(errors)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕获前端发送过来的数据无法被正常处理（比如，后端希望json格式，前端却非json）</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123; HttpMessageNotReadableException<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseDto</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleValidationException</span>(<span class="title">final</span> <span class="title">HttpMessageNotReadableException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.wrapException(<span class="keyword">new</span> ParameterException(e.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义用户程序异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123; UserAppException<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseDto</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleUserAppException</span>(<span class="title">final</span> <span class="title">UserAppException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.wrapException(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 所有异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(&#123; Exception<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseDto</span>&lt;<span class="title">Void</span>&gt; <span class="title">handleException</span>(<span class="title">final</span> <span class="title">Exception</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        LOGGER.error(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.wrapException(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   	<span class="meta">@ExceptionHandler</span>(&#123; ClientAbortException<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseBody</span></span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseDto</span>&lt;<span class="title">Void</span>&gt; <span class="title">clientAbortException</span>(<span class="title">final</span> <span class="title">ClientAbortException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        LOGGER.warn(e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> ResponseUtil.wrapException(e);</span><br><span class="line">    &#125;</span><br><span class="line">                    </span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"nls"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getFieldErrorString</span><span class="params">(<span class="keyword">final</span> List&lt;FieldError&gt; errors)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> FieldError error : errors) &#123;</span><br><span class="line">            sb.append(error.getField() + <span class="string">": "</span> + error.getDefaultMessage() + <span class="string">"! "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工具方法"><a href="#工具方法" class="headerlink" title="工具方法"></a>工具方法</h3><p>因为Validator等校验器是线程安全的，因此一般来说一个应用全局仅需一份、只初始化一次。可以封装这些方法作为工具方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidatorUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ValidatorFactory <span class="title">obtainValidatorFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Validation.buildDefaultValidatorFactory();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Validator <span class="title">obtainValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obtainValidatorFactory().getValidator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutableValidator <span class="title">obtainExecutableValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obtainValidator().forExecutables();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">printViolations</span><span class="params">(Set&lt;ConstraintViolation&lt;T&gt;&gt; violations)</span> </span>&#123;</span><br><span class="line">        violations.stream().map(v -&gt; v.getPropertyPath() + <span class="string">" "</span> + v.getMessage() + <span class="string">": "</span> + v.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="一些核心思想"><a href="#一些核心思想" class="headerlink" title="一些核心思想"></a>一些核心思想</h3><h4 id="Validator"><a href="#Validator" class="headerlink" title="Validator"></a>Validator</h4><p>校验器，可实现对Java Bean、某个属性、方法、构造器等完成校验。</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>validate</td>
<td>校验Java Bean上的所有约束，包括属性约束  + 类的约束。.validate(user)</td>
</tr>
<tr>
<td>validateProperty</td>
<td>校验指定的属性。.validateProperty(user, “fullName”)</td>
</tr>
<tr>
<td>validateValue</td>
<td>校验指定value值，是否符合指定属性上的所有约束。不需要存在对象实例，直接校验某个值是否满足某个属性的所有约束，可以做事前的校验判断。 .validateValue(User.class, “fullName”, “want”)</td>
</tr>
<tr>
<td>getConstraintsForClass</td>
<td>获取Class类型描述。.getConstraintsForClass(User.class)</td>
</tr>
<tr>
<td>forExecutables</td>
<td>获得Executable校验器，只能校验Java Bean</td>
</tr>
</tbody>
</table>
<p>使用案例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Network</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Range</span>(min = <span class="number">0</span>, max = <span class="number">5</span>, message = <span class="string">"组网模式取值不在0~5范围内"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer circuitType;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@NotBlank</span>(message = <span class="string">"不能为空的字符串"</span>) <span class="function">String <span class="title">getDrive</span><span class="params">(@Max(<span class="number">75</span>)</span> <span class="keyword">int</span> speedInMph) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidGroup</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Network network = <span class="keyword">new</span> Network();</span><br><span class="line">        network.setCircuitType(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Validator validator = Validation.buildDefaultValidatorFactory().getValidator();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// validate实例对象</span></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkViolation = validator.validate(network);</span><br><span class="line">        networkViolation.stream().map(v -&gt;</span><br><span class="line">                v.getPropertyPath() + v.getMessage() + <span class="string">":"</span> + v.getInvalidValue()</span><br><span class="line">        ).forEach(System.out::println);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// validate实例某一个属性</span></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkProperty = validator.validateProperty(network, <span class="string">"circuitType"</span>);</span><br><span class="line">        networkProperty.stream().map(s -&gt; s.getPropertyPath() + s.getMessage() + <span class="string">":"</span> + s.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// validate实例某一个属性值校验</span></span><br><span class="line">        Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkValue = validator.validateValue(Network.class, "circuitType", 10);</span><br><span class="line">        networkValue.stream().map(s -&gt; s.getPropertyPath() + s.getMessage() + <span class="string">":"</span> + s.getInvalidValue()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Class类型描述</span></span><br><span class="line">        BeanDescriptor beanDescriptor = validator.getConstraintsForClass(Network<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        beanDescriptor.getConstrainedProperties(); <span class="comment">// 被约束的field列表</span></span><br><span class="line">        beanDescriptor.getConstrainedMethods(MethodType.GETTER); <span class="comment">// 被约束的属性列表（get方法）</span></span><br><span class="line">        beanDescriptor.getConstrainedConstructors();</span><br><span class="line">        beanDescriptor.getConstraintsForProperty(<span class="string">"circuitType"</span>);</span><br><span class="line">        beanDescriptor.isBeanConstrained();</span><br><span class="line">        beanDescriptor.getConstraintDescriptors().size();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得校验执行器，可以对方法输入参数、方法返回值进行约束校验</span></span><br><span class="line">        ExecutableValidator executableValidator = validator.forExecutables();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object[] parameterValues = &#123;<span class="number">80</span>&#125;;</span><br><span class="line">             <span class="comment">// 对方法的输入参数进行校验</span></span><br><span class="line">            Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkReqList = executableValidator.validateParameters(</span><br><span class="line">                    network,</span><br><span class="line">                    network.getClass().getDeclaredMethod(<span class="string">"getDrive"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">                    <span class="title">parameterValues</span></span></span><br><span class="line"><span class="class">            )</span>;</span><br><span class="line">            networkReqList.stream().map(s -&gt; s.getPropertyPath() + s.getMessage() + <span class="string">":"</span> + s.getInvalidValue()).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"> 						<span class="comment">// 对方法的返回值进行校验</span></span><br><span class="line">            Method method = network.getClass().getDeclaredMethod(<span class="string">"getDrive"</span>, <span class="keyword">int</span><span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkRespList = executableValidator.validateReturnValue(</span><br><span class="line">                    network,</span><br><span class="line">                    method,</span><br><span class="line">                    method.invoke(network, parameterValues)</span><br><span class="line">            );</span><br><span class="line">            networkRespList.stream().map(s -&gt; s.getPropertyPath() + s.getMessage() + <span class="string">":"</span> + s.getInvalidValue()).forEach(System.out::println);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ConstraintViolation"><a href="#ConstraintViolation" class="headerlink" title="ConstraintViolation"></a>ConstraintViolation</h4><p>约束校验失败的详情信息。违反一个约束，就生成一个实例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Set&lt;ConstraintViolation&lt;Network&gt;&gt; networkViolation = validator.validate(network);</span><br><span class="line">networkViolation.stream().map(v -&gt;</span><br><span class="line">                v.getPropertyPath() + v.getMessage() + <span class="string">":"</span> + v.getInvalidValue()</span><br><span class="line">        ).forEach(System.out::println);</span><br></pre></td></tr></table></figure>
<h4 id="ValidatorContext"><a href="#ValidatorContext" class="headerlink" title="ValidatorContext"></a>ValidatorContext</h4><p>可以定制设置校验器的核心组件(提供了Validator校验器的五大核心组件可以定制)。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidatorContext</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 对message内容进行格式化，若有占位符&#123;&#125;或者el表达式$&#123;&#125;，就执行替换和计算</span></span><br><span class="line">  <span class="comment">// 如@NotNull(message="&#123;username.size&#125;") username.sizes是配置文件中的变量</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">messageInterpolator</span><span class="params">(MessageInterpolator messageInterpolator)</span></span>;</span><br><span class="line">                    </span><br><span class="line">  <span class="comment">// 确定某个属性是否能被ValidationProvider访问</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">traversableResolver</span><span class="params">(TraversableResolver traversableResolver)</span></span>;</span><br><span class="line">                    </span><br><span class="line">  <span class="comment">// @Constraint(validatedBy = &#123; xxx.class &#125;)。</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">constraintValidatorFactory</span><span class="params">(ConstraintValidatorFactory factory)</span></span>;</span><br><span class="line">                    </span><br><span class="line">  <span class="comment">// 获取方法/构造器的参数名</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">parameterNameProvider</span><span class="params">(ParameterNameProvider parameterNameProvider)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提供一个Clock，给@Past、@Future等阅读判断提供参考。唯一实现为DefaultClockProvider</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">clockProvider</span><span class="params">(ClockProvider clockProvider)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 添加</span></span><br><span class="line">	<span class="function">ValidatorContext <span class="title">addValueExtractor</span><span class="params">(ValueExtractor&lt;?&gt; extractor)</span></span>;</span><br><span class="line">  <span class="comment">// 得到一个定制化的校验器</span></span><br><span class="line">	<span class="function">Validator <span class="title">getValidator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ValueExtractor"><a href="#ValueExtractor" class="headerlink" title="ValueExtractor"></a>ValueExtractor</h4><p>值提取器，2.0版本新增，用于把值从容器内提取出来参与校验（容器包括数组、集合、Map、Optional等）</p>
<blockquote>
<p>所以从Bean Validation2.0开始就支持验证<strong>容器内</strong>的元素，形如：<code>List&lt;@NotNull @Valid Person&gt;、Optional&lt;@NotNull @Valid Person&gt;</code></p>
</blockquote>
<p>可以自定义ValueExtractor来实现自定义容器值提取器。</p>
<ol>
<li>定义</li>
<li>添加<code>ValidatorContext#addValueExtractor()</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 自定义容器Result</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> T data = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String errCode;</span><br><span class="line">    <span class="keyword">private</span> String errMsg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册到值提取器，ValueExtractor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultValueExtractor</span> <span class="keyword">implements</span> <span class="title">ValueExtractor</span>&lt;<span class="title">Result</span>&lt;@<span class="title">ExtractedValue</span> ?&gt;&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extractValues</span><span class="params">(Result&lt;?&gt; originalValue, ValueReceiver receiver)</span> </span>&#123;</span><br><span class="line">        receiver.value(<span class="keyword">null</span>, originalValue.getData());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Result&lt;<span class="meta">@Valid</span> User&gt; userResult; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">   	User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.name = <span class="string">"nice"</span>;</span><br><span class="line">    Result&lt;User&gt; result = <span class="keyword">new</span> Result&lt;&gt;();</span><br><span class="line">    result.setData(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 把Result作为属性放进去</span></span><br><span class="line">    ResultDemo resultDemo = <span class="keyword">new</span> ResultDemo();</span><br><span class="line">    resultDemo.userResult = result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册自定义的值提取器</span></span><br><span class="line">    Validator validator = ValidatorUtil.obtainValidatorFactory()</span><br><span class="line">            .usingContext()</span><br><span class="line">            <span class="comment">//将自定义值提取器注册到Validator中</span></span><br><span class="line">            .addValueExtractor(<span class="keyword">new</span> ResultValueExtractor())</span><br><span class="line">            .getValidator();</span><br><span class="line">                    </span><br><span class="line">    ValidatorUtil.printViolations(validator.validate(resultDemo));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义的Validator"><a href="#自定义的Validator" class="headerlink" title="自定义的Validator"></a>自定义的Validator</h4><p>利用ValidatorContext，要想定制设置核心组件，实现自定义的Validator，两种方式：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new实例的方式，不够抽象，强耦合了Hibernate Validator的API（ValidatorContextImpl）</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先使用默认的Context上下文，并且初始化一个Validator实例</span></span><br><span class="line">    ValidatorFactoryImpl validatorFactory = (ValidatorFactoryImpl) ValidatorUtil.buildDefaultValidatorFactory();</span><br><span class="line">    <span class="comment">// 必须传入一个校验器工厂实例</span></span><br><span class="line">    ValidatorContext validatorContext = <span class="keyword">new</span> ValidatorContextImpl(validatorFactory)</span><br><span class="line">            .parameterNameProvider(<span class="keyword">new</span> DefaultParameterNameProvider())</span><br><span class="line">            .clockProvider(DefaultClockProvider.INSTANCE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过该上下文，生成校验器实例（注意：调用多次，则生成多个实例）</span></span><br><span class="line">    <span class="keyword">return</span> validatorContext.getValidator();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 工厂生成方式，推荐，主要是使用ValidatorFactory中的usingContext方法</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Validator validator = Validation.buildDefaultValidatorFactory().usingContext()</span><br><span class="line">            .parameterNameProvider(<span class="keyword">new</span> DefaultParameterNameProvider())</span><br><span class="line">            .clockProvider(DefaultClockProvider.INSTANCE)</span><br><span class="line">            .getValidator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获得Validator实例的两种办法"><a href="#获得Validator实例的两种办法" class="headerlink" title="获得Validator实例的两种办法"></a>获得Validator实例的两种办法</h4><ol>
<li>工厂直接获取，默认</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Validator validator = Validation.buildDefaultValidatorFactory().getValidator();</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>从上下文获取,可以任意指定核心组件实现,实现定制。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Validator validator = Validation.buildDefaultValidatorFactory().usingContext()</span><br><span class="line">            .parameterNameProvider(<span class="keyword">new</span> DefaultParameterNameProvider())</span><br><span class="line">            .clockProvider(DefaultClockProvider.INSTANCE)</span><br><span class="line">            .getValidator();</span><br></pre></td></tr></table></figure>
<h3 id="ValidationMessages-properties"><a href="#ValidationMessages-properties" class="headerlink" title="ValidationMessages.properties"></a>ValidationMessages.properties</h3><ol>
<li><p>可以把校验消息都配置到.properties文件中。默认目录是<code>resources/ValidationMessages.properties</code></p>
<p>（spring boot自动读取classpath中的ValidationMessages.properties）</p>
</li>
<li><p>当验证不通过时会抛出 <code>ValidationMessages.properties</code> 中配置的提示信息。</p>
</li>
<li><p>若想自定义文件名，如 <code>messages.properties</code>，可以做路径配置即可。</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">include</span>&gt;</span>app/build/**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">include</span>&gt;</span>messages.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">include</span>&gt;</span>WEB-INF/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>node/**/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>内容：</strong></p>
<p><code>key=value</code>(value即消息，默认是ASCII编码)，需要修改为UTF-8格式编码</p>
<p><img src="C:\Users\luxia\AppData\Local\YNote\data\wythyw@163.com\660f999f697641f7859f05d45d5246fe\clipboard.png" alt="img"></p>
<p><img src="https://www.pianshen.com/images/530/b4355e37fbd0533470cc75936dca8ad2.png" alt="在这里插入图片描述"></p>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Bean中使用注解</span></span><br><span class="line"><span class="meta">@NotNull</span>(message = <span class="string">"&#123;user.card&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String card;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// resources/ValidationMessages.properties文件中，设置校验异常消息</span></span><br><span class="line">user.card=请输入card</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>不吹不擂，第一篇就能提升你对Bean Validation数据校验的认知</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/108184782" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/108184782</a></p>
<p>Bean Validation声明式校验方法的参数、返回值</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/108256131" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/108256131</a></p>
<p>站在使用层面，Bean Validation这些标准接口你需要烂熟于胸</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/108342248" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/108342248</a></p>
<p>Validator校验器的五大核心组件，一个都不能少</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/108358583" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/108358583</a></p>
<p>Bean Validation声明式验证四大级别：字段、属性、容器元素、类</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/109234678" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/109234678</a></p>
<p>自定义容器类型元素验证，类级别验证（多字段联合验证）</p>
<p><a href="https://blog.csdn.net/f641385712/article/details/109270066" target="_blank" rel="noopener">https://blog.csdn.net/f641385712/article/details/109270066</a></p>
<p>SpringBoot里参数校验/参数验证</p>
<p><a href="https://blog.csdn.net/jinjiankang/article/details/89711493" target="_blank" rel="noopener">https://blog.csdn.net/jinjiankang/article/details/89711493</a></p>
<p>【springboot全局异常处理】— 请求参数异常+自定义异常+其他异常</p>
<p><a href="https://blog.csdn.net/nrsc272420199/article/details/102645938/" target="_blank" rel="noopener">https://blog.csdn.net/nrsc272420199/article/details/102645938/</a></p>
]]></content>
  </entry>
  <entry>
    <title>线程</title>
    <url>/want/2020/10/17/%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ol>
<li>即使程序编码时没有主动自定义线程，运行时仍然会有一些默认线程，如主线程【main()】、gc线程【jvm提供的垃圾回收】。</li>
<li>多线程操作同一份资源，存在资源抢夺，需要加入并发控制。（每个线程在自己的工作内存交互，内存控制不当会造成数据不一致。）。每个拿到资源的线程都上一把锁，就算是Thread.sleep()也不会释放这把锁。保证安全性。</li>
<li>线程的运行由调度器安排，调度器与操作系统紧密相关，因此线程运行的先后顺序无法人为干预。</li>
<li>额外性能开销：CPU调度时间、并发控制开销</li>
</ol>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20201012215342413.png" alt="image-20201012215342413"></p>
<h3 id="程序、进程、线程关系"><a href="#程序、进程、线程关系" class="headerlink" title="程序、进程、线程关系"></a>程序、进程、线程关系</h3><ol>
<li>程序：没有运行的含义，静态的代码</li>
<li>进程Process：运行的程序【系统分配的】</li>
<li>线程Thread：一个进程中包含&gt;=1个线程，真正程序的执行由线程来完成【由CPU调度和执行】</li>
</ol>
<h3 id="多线程类别"><a href="#多线程类别" class="headerlink" title="多线程类别"></a>多线程类别</h3><ul>
<li>真正的多线程，有多个CPU（多核）</li>
<li>模拟的多线程，仅一个CPU，（在同一时间点CPU仍然只能做一件事），但因为cpu执行的任务切换的非常快，从而产生了同时执行的错觉。</li>
</ul>
<h3 id="线程创建"><a href="#线程创建" class="headerlink" title="线程创建"></a>线程创建</h3><p>三种方式：</p>
<ol>
<li><p>Thread类</p>
</li>
<li><p>Runnable接口</p>
<ul>
<li>Thread类实际上是实现了Runnable接口。</li>
<li>建议使用，接口实现</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Callable接口</p>
</li>
</ol>
<h4 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h4><ol>
<li>继承Thread类</li>
<li>重写run()方法，run方法为线程执行体</li>
<li>调用start()方法，启动线程。</li>
<li>线程不一定立即执行，由CPU安排调度。线程调用顺序不是同步一次执行（多线程是同时执行的）</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoutTest</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"SoutTest i:"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadMainTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SoutTest soutTest = <span class="keyword">new</span> SoutTest();</span><br><span class="line">        soutTest.start();</span><br><span class="line">      </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"ThreadMainTest i:"</span> + i);</span><br><span class="line">            <span class="comment">//观察结果可知，SoutTest和ThreadMainTest出现的时机无序</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>下载文件案例</strong></p>
<p>使用依赖包<code>commons-io</code>实现文件下载。如果是maven项目，直接引入依赖；否则，手动引入。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20201017113300379.png" alt="image-20201017113300379" style="zoom:100%;"></p>
<p>可以看到已经成功引入。</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20201017113613211.png" alt="image-20201017113613211"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileDownloadTest</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FileDownloadTest</span><span class="params">(String url, String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Downloader downloader = <span class="keyword">new</span> Downloader();</span><br><span class="line">        downloader.download(url, fileName);</span><br><span class="line">        System.out.println(<span class="string">"download:"</span> + fileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"70迈4K行车记录仪.jpg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/article/2020/09/28/fc6567a9b2d4f176c11bae1c6d226f05.jpg"</span>);</span><br><span class="line">        map.put(<span class="string">"360G580行车记录.jpeg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/article/2020/08/23/7c707202008231518243883_1800_500.jpeg?imageMogr2/auto-orient"</span>);</span><br><span class="line">        map.put(<span class="string">"小米行车记录仪2-2k版.jpeg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/sale/2020/10/121388f202010121029499586_1800_500.jpeg"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            FileDownloadTest f = <span class="keyword">new</span> FileDownloadTest(map.get(key), key);</span><br><span class="line">            f.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Downloader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(String url, String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">// commons.io处理文件</span></span><br><span class="line">            FileUtils.copyURLToFile(<span class="keyword">new</span> URL(url), <span class="keyword">new</span> File(fileName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">"IO异常，download方法出现问题"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h4><ol>
<li>实现Runnable接口</li>
<li>实现run()方法</li>
<li>借助Thread类，调用start()方法，启动线程。</li>
<li>线程不一定立即执行，由CPU安排调度。线程调用顺序不是同步一次执行（多线程是同时执行的）</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RunnableTest</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">            System.out.println(id + <span class="string">"-"</span> + i + <span class="string">":线程"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    		<span class="comment">// 创建实现类实例</span></span><br><span class="line">        RunnableTest runnableTest = <span class="keyword">new</span> RunnableTest(<span class="number">1</span>);</span><br><span class="line">      	<span class="comment">// 创建线程对象，还是通过Thread实例启动(start)线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(runnableTest).start();</span><br><span class="line"></span><br><span class="line">        RunnableTest runnableTest1 = <span class="keyword">new</span> RunnableTest(<span class="number">132</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(runnableTest1,<span class="string">"线程名"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h4><ol>
<li>实现<code>Callable&lt;数据类型&gt;</code>接口</li>
<li>实现<code>call(数据类型)</code>方法</li>
<li>启动线程<ul>
<li>创建执行服务 ExecutorService executorService = Executors.newFixedThreadPool(1);//线程个数</li>
<li>提交执行 Future<boolean> future = executorService.submit(f); // 每个线程一次</boolean></li>
<li>获取结果 Boolean r1 = future.get(); // 每个线程一次</li>
<li>关闭服务 executorService.shutdownNow(); // //所有线程关闭</li>
</ul>
</li>
<li>线程不一定立即执行，由CPU安排调度。线程调用顺序不是同步一次执行（多线程是同时执行的）</li>
<li>好处：<ul>
<li>可以定义返回值</li>
<li>可以抛出异常</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CallableFileDownloadTest</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Boolean</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CallableFileDownloadTest</span><span class="params">(String url, String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重点</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CDownloader downloader = <span class="keyword">new</span> CDownloader();</span><br><span class="line">        downloader.download(url, fileName);</span><br><span class="line">        System.out.println(<span class="string">"download:"</span> + fileName);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"./src/com/thread/img/70迈4K行车记录仪.jpg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/article/2020/09/28/fc6567a9b2d4f176c11bae1c6d226f05.jpg"</span>);</span><br><span class="line">        map.put(<span class="string">"./src/com/thread/img//360G580行车记录.jpeg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/article/2020/08/23/7c707202008231518243883_1800_500.jpeg?imageMogr2/auto-orient"</span>);</span><br><span class="line">        map.put(<span class="string">"./src/com/thread/img/小米行车记录仪2-2k版.jpeg"</span>, <span class="string">"http://s1.dgtle.com/dgtle_img/sale/2020/10/121388f202010121029499586_1800_500.jpeg"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建执行服务，线程池有3个线程</span></span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            CallableFileDownloadTest f = <span class="keyword">new</span> CallableFileDownloadTest(map.get(key), key);</span><br><span class="line">						<span class="comment">//提交执行</span></span><br><span class="line">            Future&lt;Boolean&gt; future = executorService.submit(f);</span><br><span class="line">          <span class="comment">// FutureTask&lt;Boolean&gt; future = new FutureTask&lt;Boolean&gt;(new CallableFileDownloadTest()); new Thread(future).start();</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//获取结果</span></span><br><span class="line">                Boolean r1 = future.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//关闭服务</span></span><br><span class="line">        executorService.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CDownloader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">download</span><span class="params">(String url, String fileName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.copyURLToFile(<span class="keyword">new</span> URL(url), <span class="keyword">new</span> File(fileName));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">"IO异常，download方法出现问题"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程生命周期"><a href="#线程生命周期" class="headerlink" title="线程生命周期"></a>线程生命周期</h3><p><strong>生命周期</strong>：</p>
<p><img src="C:\Users\lux\AppData\Roaming\Typora\typora-user-images\image-20201025143842137.png" alt="image-20201025143842137"></p>
<table>
<thead>
<tr>
<th>环节</th>
<th>描述</th>
<th>拟人</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建状态（新生状态）</td>
<td>Thread thread = new Thread() 线程对象实例创建。尚未启动。</td>
<td>来了</td>
</tr>
<tr>
<td>就绪状态</td>
<td>thread.start() 线程变为就绪状态。</td>
<td>准备工作了</td>
</tr>
<tr>
<td>运行状态</td>
<td>真正执行线程体、真正工作。</td>
<td>在工作</td>
</tr>
<tr>
<td>阻塞状态</td>
<td>thread.sleep() / thread.wait() / 同步锁定时，代码不再执行。阻塞事件解除后，重新进入就绪状态，等待cpu调度。</td>
<td>午休</td>
</tr>
<tr>
<td>死亡状态</td>
<td>线程中断或结束。一旦死亡不能再次启动。</td>
<td>离开了</td>
</tr>
</tbody>
</table>
<h4 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h4><p><a href="https://docs.oracle.com/javase/8/docs/api/index.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/api/index.html</a></p>
<p>Thread.state，一个线程在给定时间点，必定处于一个状态。这个状态是虚拟机状态，而不能反映操作系统线程状态。</p>
<p>使用方式：</p>
<ol>
<li>Thread.State.TERMINATED</li>
<li>thread.getState()</li>
</ol>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NEW</td>
<td>线程创建，但尚未启动</td>
</tr>
<tr>
<td>RUNNABLE</td>
<td>线程正在运行</td>
</tr>
<tr>
<td>BLOCKED</td>
<td>线程被阻塞</td>
</tr>
<tr>
<td>WAITING</td>
<td>正等待另一线程执行特定动作</td>
</tr>
<tr>
<td>TIMED_WAITING</td>
<td>正等待另一线程执行特定动作，且并已经到了指定的等待时间</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>线程已退出</td>
</tr>
</tbody>
</table>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadStateTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"-------------"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// --------------------------------------</span></span><br><span class="line">        <span class="comment">/* lamda表达式，等价如下内容</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                final Runnable runnable = () -&gt; &#123;</span></span><br><span class="line"><span class="comment">                    // 代码执行体</span></span><br><span class="line"><span class="comment">                &#125;;</span></span><br><span class="line"><span class="comment">                Thread thread = new Thread(runnable);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">// --------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化但尚未启动</span></span><br><span class="line">        Thread.State state = thread.getState();</span><br><span class="line">        System.out.println(state); <span class="comment">// NEW</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动后</span></span><br><span class="line">        thread.start();</span><br><span class="line">        System.out.println(thread.getState()); <span class="comment">// RUNNABLE</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 休眠一下</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(thread.getState()); <span class="comment">// TIMED_WAITING</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 结束了</span></span><br><span class="line">        <span class="keyword">while</span> (!Thread.State.TERMINATED.equals(thread.getState())) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(thread.getState()); <span class="comment">// 最后一个状态是TERMINATED</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程优先级"><a href="#线程优先级" class="headerlink" title="线程优先级"></a>线程优先级</h3><p>优先级低，只是意味着，获得调度的<strong>概率比较低</strong>。</p>
<p>Thread类：</p>
<ol>
<li><p>public final static int MIN_PRIORITY = 1;最小优先级</p>
</li>
<li><p>public final static int NORM_PRIORITY = 5; 默认优先级</p>
</li>
<li><p>public final static int MAX_PRIORITY = 10;最大优先级</p>
</li>
</ol>
<ol start="4">
<li><p>setPriority(int newPriority)，建议在start()调度前设置</p>
</li>
<li><p>getPriority()</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPriorityTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Love love = <span class="keyword">new</span> Love();</span><br><span class="line">        Thread thread1 = <span class="keyword">new</span> Thread(love, <span class="string">"最大"</span>);</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(love, <span class="string">"最小"</span>);</span><br><span class="line">        Thread thread3 = <span class="keyword">new</span> Thread(love, <span class="string">"c"</span>);</span><br><span class="line">        Thread thread4 = <span class="keyword">new</span> Thread(love, <span class="string">"d"</span>);</span><br><span class="line">        Thread thread5 = <span class="keyword">new</span> Thread(love, <span class="string">"e"</span>);</span><br><span class="line"></span><br><span class="line">        thread1.setPriority(<span class="number">10</span>);<span class="comment">// 优先级最大</span></span><br><span class="line">        thread1.start();</span><br><span class="line"></span><br><span class="line">        thread2.setPriority(<span class="number">2</span>); <span class="comment">// 优先级最小</span></span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line">        thread3.start();</span><br><span class="line">        thread4.start();</span><br><span class="line">        thread5.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Love</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"nice:"</span></span><br><span class="line">                + Thread.currentThread().getName()</span><br><span class="line">                + Thread.currentThread().getPriority()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程方法"><a href="#线程方法" class="headerlink" title="线程方法"></a>线程方法</h3><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean isAlive()</td>
<td>获取是否活动状态</td>
</tr>
<tr>
<td>setPriority(int priority)</td>
<td>修改线程优先级</td>
</tr>
<tr>
<td><strong>static</strong> void yield()</td>
<td>Thread.yield() 礼让线程。礼让不一定成功，看CPU。暂停当前执行的线程实例，并执行其他线程。</td>
</tr>
<tr>
<td><strong>static</strong> void sleep(long millis)</td>
<td>Thread.sleep(200) 暂停线程，让线程休眠，毫秒数。sleep能够放大问题的发生性。</td>
</tr>
<tr>
<td>void interrupt()</td>
<td>中断线程。不建议使用。</td>
</tr>
<tr>
<td>void join()</td>
<td>myThread.join() 插队。myThread线程插队先执行。其他线程阻塞。等插队进行执行完成后，再执行其他线程。</td>
</tr>
</tbody>
</table>
<h4 id="线程停止"><a href="#线程停止" class="headerlink" title="线程停止"></a>线程停止</h4><ol>
<li>【废弃】Thread提供的stop()\destroy()方法不要使用，已废弃@Deprecated。</li>
<li>【办法】手动设置标志位flag = false，让线程代码不真正运行。或其他手动停止的办法。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadStopTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 手动flag</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isStopped = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// flag 停止代码运行</span></span><br><span class="line">        <span class="keyword">while</span> (!isStopped) &#123;</span><br><span class="line">            System.out.println(<span class="string">"喝酸奶，身体健康，心情舒畅:"</span> + i++);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isStopped = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadStopTest drinkYogurt = <span class="keyword">new</span> ThreadStopTest();</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(drinkYogurt);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">990</span>) &#123;</span><br><span class="line">              <span class="comment">// 手动停止代码运行</span></span><br><span class="line">                drinkYogurt.stop();</span><br><span class="line">                System.out.println(<span class="string">"线程已停止"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="线程休眠"><a href="#线程休眠" class="headerlink" title="线程休眠"></a>线程休眠</h4><p>sleep</p>
<ol>
<li>当前线程阻塞的毫秒数。</li>
<li>时间到达后进入就绪状态。</li>
<li>存在异常InterruptedException。</li>
<li>可以模拟网络延时、倒计时等。</li>
</ol>
<h5 id="模拟网络延时"><a href="#模拟网络延时" class="headerlink" title="模拟网络延时"></a>模拟网络延时</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(<span class="string">"a"</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  	<span class="comment">// 延时2秒</span></span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2秒后再运行</span></span><br><span class="line">System.out.println(<span class="string">"b"</span>);</span><br></pre></td></tr></table></figure>
<h5 id="模拟倒计时"><a href="#模拟倒计时" class="headerlink" title="模拟倒计时"></a>模拟倒计时</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">  	System.out.println(i);</span><br><span class="line">  	<span class="keyword">if</span>(i&gt;<span class="number">1</span>) &#123;</span><br><span class="line">  	  	<span class="keyword">try</span> &#123;</span><br><span class="line">  	  	  	Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">  	  	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">  	  	  	e.printStackTrace();</span><br><span class="line">  	  	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="打印当前时间"><a href="#打印当前时间" class="headerlink" title="打印当前时间"></a>打印当前时间</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">10</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">  	System.out.println(simpleDateFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">  	<span class="keyword">if</span> (i &gt; <span class="number">1</span>) &#123;</span><br><span class="line">  	  	<span class="keyword">try</span> &#123;</span><br><span class="line">  	  	  	Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">  	  	&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">  	  	  	e.printStackTrace();</span><br><span class="line">  	  	&#125;</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>System.currentTimeMillis()获取当前时间的13位时间戳。new Date(System.currentTimeMillis())。</p>
</blockquote>
<h4 id="线程礼让"><a href="#线程礼让" class="headerlink" title="线程礼让"></a>线程礼让</h4><p>yield</p>
<ol>
<li>礼让，让线程从运行状态，转为就绪状态。</li>
<li>如，线程a执行到中途，不执行了，变成就绪状态。让线程b执行。</li>
<li>礼让不一定成功！看CUP的心情。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadYieldTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyYield yield = <span class="keyword">new</span> MyYield();</span><br><span class="line">        <span class="keyword">new</span> Thread(yield, <span class="string">"曹植"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(yield, <span class="string">"曹丕"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyYield</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"线程开始执行"</span>);</span><br><span class="line">        Thread.yield(); <span class="comment">// 礼让</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">"线程停止执行，end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这个案例不太好，因为线程执行本身是无序的。但通过概率，还是能看出礼让情况。</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 礼让，曹植没有一直执行到完毕。而是礼让了一下曹丕。</span></span><br><span class="line">曹植线程开始执行</span><br><span class="line">曹丕线程开始执行</span><br><span class="line">曹植线程停止执行，end</span><br><span class="line">曹丕线程停止执行，end</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不礼让</span></span><br><span class="line">曹植线程开始执行</span><br><span class="line">曹植线程停止执行，end</span><br><span class="line">曹丕线程开始执行</span><br><span class="line">曹丕线程停止执行，end</span><br></pre></td></tr></table></figure>
<h4 id="线程强制执行"><a href="#线程强制执行" class="headerlink" title="线程强制执行"></a>线程强制执行</h4><p>join</p>
<ol>
<li>线程到其他线程去插队执行，当插队线程执行完成后，再执行其他线程。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luxia.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadJoinTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadJoinTest threadJoinTest = <span class="keyword">new</span> ThreadJoinTest();</span><br><span class="line">        Thread threadJoin = <span class="keyword">new</span> Thread(threadJoinTest);</span><br><span class="line">        threadJoin.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">50</span>) &#123;</span><br><span class="line">                <span class="comment">//join线程（threadJoin.join）来插队,join线程先执行，然后再执行main</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    threadJoin.join();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"main"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"join: "</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="守护线程daemon"><a href="#守护线程daemon" class="headerlink" title="守护线程daemon"></a>守护线程daemon</h3><p>线程的分类：</p>
<ol>
<li>用户线程：thread.setDaemon(false)。虚拟机必须确保用户线程执行完毕。main()。</li>
<li>守护线程：thread.setDaemon(true)。虚拟机不会等待守护线程执行完毕。 后台记录操作日志，监控内存，垃圾回收gc()等待…</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luxia.thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadDaemonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ServiceProcess serviceProcess = <span class="keyword">new</span> ServiceProcess();</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(serviceProcess);</span><br><span class="line"></span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>); <span class="comment">// 设为守护进程，只要用户线程执行完毕，虚拟机就不管了（虚拟机关闭需要一点时间，所以还会看到一些）。</span></span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> MainProcess()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceProcess</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"守护进程，为执行线程提供保障"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainProcess</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"我在执行"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"==========我不执行了=========="</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程Thread是一种静态代理模式"><a href="#线程Thread是一种静态代理模式" class="headerlink" title="线程Thread是一种静态代理模式"></a>线程Thread是一种静态代理模式</h3><h4 id="静态代理模式"><a href="#静态代理模式" class="headerlink" title="静态代理模式"></a>静态代理模式</h4><ol>
<li>真实对象，和代理对象，都实现了同一个接口。</li>
<li>代理对象要代理真实对象</li>
</ol>
<p>new Thread(真实执行实例)。</p>
<p>其中</p>
<ol>
<li>Thread类，继承了Runnable接口，是代理。</li>
<li>真实执行类，也继承了Runnable接口，是真正的执行人。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建实现类实例</span></span><br><span class="line">RunnableTest runnableTest = <span class="keyword">new</span> RunnableTest(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线程对象，还是通过Thread实例启动(start)线程</span></span><br><span class="line"><span class="keyword">new</span> Thread(runnableTest).start();</span><br></pre></td></tr></table></figure>
<h4 id="一个静态代理示例"><a href="#一个静态代理示例" class="headerlink" title="一个静态代理示例"></a>一个静态代理示例</h4><p>消费者要买车，4s店可以代理消费者买车。</p>
<p>都实现了买车这个行为，4s店代理消费者完成。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticProxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Auto4sShop auto4sShop = <span class="keyword">new</span> Auto4sShop(<span class="keyword">new</span> BuyCar());</span><br><span class="line">        auto4sShop.sale(<span class="string">"levin"</span>, <span class="string">"lucy"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 同一个接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">CarLife</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sale</span><span class="params">(String carName, String consumer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">service</span><span class="params">(String carName, String consumer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sparepart</span><span class="params">(String carName, String consumer)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">survey</span><span class="params">(String carName, String consumer)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 真实对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyCar</span> <span class="keyword">implements</span> <span class="title">CarLife</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sale</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        System.out.println(consumer + <span class="string">"买了这个车："</span> + carName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        System.out.println(consumer + <span class="string">"需要服务，车型："</span> + carName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sparepart</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        System.out.println(consumer + <span class="string">"需要零配件，车型："</span> + carName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">survey</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        System.out.println(consumer + <span class="string">"反馈了一些问题，车型："</span> + carName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auto4sShop</span> <span class="keyword">implements</span> <span class="title">CarLife</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CarLife target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Auto4sShop</span><span class="params">(CarLife target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sale</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        start();</span><br><span class="line">        <span class="keyword">this</span>.target.sale(carName, consumer);</span><br><span class="line">        end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        start();</span><br><span class="line">        <span class="keyword">this</span>.target.service(carName, consumer);</span><br><span class="line">        end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sparepart</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        start();</span><br><span class="line">        <span class="keyword">this</span>.target.sparepart(carName, consumer);</span><br><span class="line">        end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">survey</span><span class="params">(String carName, String consumer)</span> </span>&#123;</span><br><span class="line">        start();</span><br><span class="line">        <span class="keyword">this</span>.target.survey(carName, consumer);</span><br><span class="line">        end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"欢迎光临!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"谢谢惠顾!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h3><h4 id="并发问题"><a href="#并发问题" class="headerlink" title="并发问题"></a>并发问题</h4><p>同一份资源，需要被多个线程同时操作。</p>
<ol>
<li>抢火车票</li>
<li>同时取钱</li>
</ol>
<p>但各线程都有自己的内存，当拿到资源之后，都会以为自己处理了资源。导致资源处理出错。</p>
<p>线程a认为还剩1张票，线程b也认为还剩1张票，在各自内存进行了-1操作，导致实际上取了2张票。</p>
<h4 id="同步机制"><a href="#同步机制" class="headerlink" title="同步机制"></a>同步机制</h4><p>用来解决并发问题。</p>
<p>线程同步机制，本质是一种【等待】机制，多个想同时访问此对象的线程进入这份资源的等待池，形成【队列】，等待前一个线程使用完毕【锁】，下一个线程再使用。</p>
<ol>
<li>访问同一资源的多个线程形成【队列】，等待。</li>
<li>当时占用资源的线程，上【锁】，保证安全，直到使用完成后释放。</li>
</ol>
<h4 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h4><ol>
<li><p>synchronized隐式锁。</p>
<ul>
<li><p>出了作用域自动释放。</p>
</li>
<li><p>可以锁方法、锁代码块。</p>
</li>
</ul>
</li>
<li><p>lock显式锁。</p>
<ul>
<li><p>手动开锁、关锁。</p>
</li>
<li><p>只锁代码块。</p>
</li>
<li>性能更好（jvm花费更少时间来调度线程）</li>
<li>扩展性更好（提供了更多子类）</li>
</ul>
</li>
</ol>
<p>优先级顺序：lock锁 &gt; 同步代码块 &gt; 同步方法</p>
<h5 id="synchronized隐式锁"><a href="#synchronized隐式锁" class="headerlink" title="synchronized隐式锁"></a>synchronized隐式锁</h5><p>一个线程一旦获得资源，就获得一把排它锁，独占资源。此时，其他线程必须等待，直到使用完成释放锁。</p>
<ol>
<li>一个线程拥有了锁，就会导致其他需要此资源的线程挂起。</li>
<li>加锁、释放锁，会导致上下文切换和调度延时，引起性能问题。</li>
<li>优先级高的线程，等待优先级低的线程释放锁，会导致优先级倒置，引起性能问题。</li>
</ol>
<p><strong><em>synchronized锁如何修改对象资源?</em></strong></p>
<p>每个对象资源都有一把锁，谁来访问谁拥有。</p>
<p>因为数据对象已经被private控制，只能通过方法进行修改，所以只需要对方法进行锁机制，就可保证同步。</p>
<p>方法里有需要修改的资源，就需要锁。其他不需要，否则浪费资源。</p>
<ol>
<li>synchronized方法。将一个大方法申明为synchronized会影响效率。</li>
</ol>
<p>synchronized方法，默认锁的是this（对象本身，或者反射class)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public synchronized void method(int args) &#123;//含修改共享资源的代码&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>synchronized块。</li>
</ol>
<p>synchronized块，需要指定监听器Obj，可以是任何对象，推荐使用共享资源作为监听器。</p>
<p>synchronized方法，其实就是监听的对象本身。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">synchronized(Obj) &#123;//含修改共享资源的代码&#125;</span><br></pre></td></tr></table></figure>
<h5 id="lock显式锁"><a href="#lock显式锁" class="headerlink" title="lock显式锁"></a>lock显式锁</h5><ol>
<li>jdk5.0开始引入</li>
<li>拥有与synchronized相同的并发性和内存语义，但更强大。</li>
<li>显式定义【同步锁对象（Lock对象）】，来实现同步。</li>
<li>接口：java.util.concurrent.locks.Lock。</li>
<li>Lock接口实现类：ReentrantLock，可以显式加锁、释放锁。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">lock.lock();</span><br><span class="line"><span class="comment">/**代码块*/</span></span><br><span class="line">lock.unlock();</span><br></pre></td></tr></table></figure>
<h3 id="锁示例"><a href="#锁示例" class="headerlink" title="锁示例"></a>锁示例</h3><h4 id="取票"><a href="#取票" class="headerlink" title="取票"></a>取票</h4><h5 id="不安全取票"><a href="#不安全取票" class="headerlink" title="不安全取票"></a>不安全取票</h5><p>买票时候，会拿到0票和-1票。</p>
<p>因为每个线程都把资源数量copy到自己的线程中了，比如，只剩1张票的情况下，小红、小明和黄牛都看到了1张票，都放到了自己的线程内存中，继续对ticketCount进行了处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticketCount = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (ticketCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>); <span class="comment">// 模拟延时，sleep能够放大问题的发生性。</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()</span><br><span class="line">                    + <span class="string">"，买到了第【"</span> + (ticketCount--) + <span class="string">"】张票"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TicketTest ticketTest = <span class="keyword">new</span> TicketTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小红"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小明"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"黄牛"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="安全锁：synchronized方法"><a href="#安全锁：synchronized方法" class="headerlink" title="安全锁：synchronized方法"></a>安全锁：synchronized方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticketCount = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                buy();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// synchronized方法，默认锁的是this（对象本身，或者反射class)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(ticketCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            System.out.println(<span class="string">"票卖完了"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">200</span>); <span class="comment">// 模拟延时</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName()</span><br><span class="line">                + <span class="string">"，买到了第【"</span> + (ticketCount--) + <span class="string">"】张票"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TicketTest ticketTest = <span class="keyword">new</span> TicketTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小红"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小明"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"黄牛"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="安全锁：synchronized块"><a href="#安全锁：synchronized块" class="headerlink" title="安全锁：synchronized块"></a>安全锁：synchronized块</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ticketCount = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isFinished = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (!isFinished) &#123;</span><br><span class="line">          <span class="comment">// synchronized块</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ticketCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    isFinished = <span class="keyword">true</span>;</span><br><span class="line">                    System.out.println(<span class="string">"票卖完了"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">200</span>); <span class="comment">// 模拟延时</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(Thread.currentThread().getName()</span><br><span class="line">                        + <span class="string">"，买到了第【"</span> + (ticketCount--) + <span class="string">"】张票"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TicketTest ticketTest = <span class="keyword">new</span> TicketTest();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小红"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"小明"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(ticketTest, <span class="string">"黄牛"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="安全锁：lock对象"><a href="#安全锁：lock对象" class="headerlink" title="安全锁：lock对象"></a>安全锁：lock对象</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BuyTicket buyTicket = <span class="keyword">new</span> BuyTicket();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket, <span class="string">"lu"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket, <span class="string">"want"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket, <span class="string">"long"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyTicket</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// 显式锁</span></span><br><span class="line">    <span class="keyword">private</span> ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 加锁</span></span><br><span class="line">                lock.lock();</span><br><span class="line">                <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>); <span class="comment">// 模拟延时，sleep能够放大问题的发生性。</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(</span><br><span class="line">                        Thread.currentThread().getName() + <span class="string">"拿到第"</span> + count-- + <span class="string">"张票"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 解锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="取钱"><a href="#取钱" class="headerlink" title="取钱"></a>取钱</h4><h5 id="synchronized块"><a href="#synchronized块" class="headerlink" title="synchronized块"></a>synchronized块</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BankTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Bank bank = <span class="keyword">new</span> Bank(<span class="string">"工商银行"</span>, <span class="number">200</span>);</span><br><span class="line">        <span class="keyword">final</span> Drawing drawingL = <span class="keyword">new</span> Drawing(bank, <span class="number">110</span>, <span class="string">"lu"</span>); <span class="comment">// 线程1</span></span><br><span class="line">        <span class="keyword">final</span> Drawing drawingW = <span class="keyword">new</span> Drawing(bank, <span class="number">100</span>, <span class="string">"want"</span>); <span class="comment">// 线程2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(drawingL).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(drawingW).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 共享资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer money;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bank</span><span class="params">(String name, Integer money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(Integer money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 操作资源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Drawing</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取款人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取钱金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer money;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 银行资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Bank bank;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Drawing</span><span class="params">(Bank bank, Integer money, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bank = bank;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"===="</span> + <span class="keyword">this</span>.name + <span class="string">",欢迎来到"</span> + bank.getName() + <span class="string">"===="</span>);</span><br><span class="line">      	<span class="comment">// 安全块</span></span><br><span class="line">        <span class="keyword">synchronized</span> (bank) &#123;</span><br><span class="line">            System.out.println(<span class="string">"**账户余额:"</span> + bank.getMoney() + <span class="string">"**"</span>);</span><br><span class="line">            <span class="keyword">if</span> (bank.getMoney() &lt; money) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"想取"</span> + <span class="keyword">this</span>.money + <span class="string">"，但是余额只有"</span> + bank.getMoney());</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> left = bank.getMoney() - money;</span><br><span class="line">            bank.setMoney(left);</span><br><span class="line">            System.out.println(</span><br><span class="line">                    <span class="keyword">this</span>.name + <span class="string">"取了"</span> + money);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="操作List资源"><a href="#操作List资源" class="headerlink" title="操作List资源"></a>操作List资源</h4><h5 id="synchronized块-1"><a href="#synchronized块-1" class="headerlink" title="synchronized块"></a>synchronized块</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadListTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">          <span class="comment">// lamda表达式匿名类（Runnable是函数式接口）</span></span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">              <span class="comment">// 函数块</span></span><br><span class="line">                <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">                    list.add(Thread.currentThread(R).getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">      	<span class="comment">// sleep,防止主线程提前完成</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="线程安全的方法"><a href="#线程安全的方法" class="headerlink" title="线程安全的方法"></a>线程安全的方法</h5><p>CopyOnWriteArrayList相对于List方法，本身就是一种线程安全的方法。自带LOCK锁机制</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.luxia.thread;</span><br><span class="line"><span class="comment">// CopyOnWriteArrayList线程安全方法，属于JUC（java.util.concurrent）</span></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadSafeMethodTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CopyOnWriteArrayList&lt;String&gt; copyOnWriteArrayList =</span><br><span class="line">                <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                copyOnWriteArrayList.add(Thread.currentThread().getName());</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(</span><br><span class="line">                copyOnWriteArrayList.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p><strong>死锁</strong>，多个线程互相占着对方需要的资源，形成僵持，导致所有线程都运行停止。</p>
<ol>
<li>线程1，占用资源a。但等待线程2释放资源b。</li>
<li>线程2，占用资源b。但等待线程1释放资源a。</li>
</ol>
<p>某【一个同步块】（synchronized块），同时拥有【两个以上资源的锁】，就可能发生死锁。</p>
<p><strong>产生死锁的四个必要条件</strong></p>
<ol>
<li>资源独占，即每次只能被一个进程调用。</li>
<li>资源霸占，一个进程绝不主动释放已获资源，</li>
<li>资源不剥夺，在进程使用完资源前，绝不能强行剥夺资源。</li>
<li>资源循环等待：若干进程之间，形成头尾相接的循环等待资源关系。</li>
</ol>
<h4 id="死锁案例"><a href="#死锁案例" class="headerlink" title="死锁案例"></a>死锁案例</h4><p>拥有各自资源的情况下，又试图占用对方的资源。</p>
<p>想把多个资源都同时锁住，但是有资源已经被别人锁了，导致线程停止。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 死锁</span></span><br><span class="line"><span class="comment"> * 两个线程，相互拥有对方的资源。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockDeadTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MarkUp markUp = <span class="keyword">new</span> MarkUp(<span class="string">"lu"</span>, <span class="number">1</span>); <span class="comment">// 线程1</span></span><br><span class="line">        MarkUp markUp1 = <span class="keyword">new</span> MarkUp(<span class="string">"want"</span>, <span class="number">2</span>); <span class="comment">// 线程2</span></span><br><span class="line">        <span class="keyword">new</span> Thread(markUp).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(markUp1).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LispStick</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mirror</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MarkUp</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LispStick lispStick = <span class="keyword">new</span> LispStick(); <span class="comment">// 共享资源1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Mirror mirror = <span class="keyword">new</span> Mirror(); <span class="comment">// 共享资源2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MarkUp</span><span class="params">(String name, <span class="keyword">int</span> flag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 锁住lispStick的同时，又试图占用mirror。可是mirror已经被占用，导致线程停止。</span></span><br><span class="line">            <span class="keyword">synchronized</span> (lispStick) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"占用了lispStick"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (mirror) &#123;</span><br><span class="line">                    System.out.println(<span class="keyword">this</span>.name + <span class="string">"也占用了mirror"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 锁住mirror的同时，又试图占用lispStick。可是lispStick已经被占用，导致线程停止。</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mirror) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"占用了mirror"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (lispStick) &#123;</span><br><span class="line">                    System.out.println(<span class="keyword">this</span>.name + <span class="string">"也占用了lispStick"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="不死锁写法"><a href="#不死锁写法" class="headerlink" title="不死锁写法"></a>不死锁写法</h4><p>用完就释放，而不是一直锁住。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程行为</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MarkUp</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LispStick lispStick = <span class="keyword">new</span> LispStick(); <span class="comment">// 共享资源1</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Mirror mirror = <span class="keyword">new</span> Mirror(); <span class="comment">// 共享资源2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> flag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MarkUp</span><span class="params">(String name, <span class="keyword">int</span> flag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 用完释放</span></span><br><span class="line">            <span class="keyword">synchronized</span> (lispStick) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"占用了lispStick"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 再使用其他资源</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mirror) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"也占用了mirror"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mirror) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"占用了mirror"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (lispStick) &#123;</span><br><span class="line">                System.out.println(<span class="keyword">this</span>.name + <span class="string">"也占用了lispStick"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程协作"><a href="#线程协作" class="headerlink" title="线程协作"></a>线程协作</h3><p>目的是实现多线程之间进行通信。</p>
<h4 id="通信方法"><a href="#通信方法" class="headerlink" title="通信方法"></a>通信方法</h4><p>是Object类的方法(意味着所有类都有该方法)，且只能在同步方法/同步代码块中使用，否则存在异常<code>IIIegalMonitorStateException</code>。</p>
<table>
<thead>
<tr>
<th></th>
<th>方法名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>等待</td>
<td>wait()</td>
<td>线程一直等待，直到收到其他线程的通知。</td>
</tr>
<tr>
<td>等待</td>
<td>wait(long timeout)</td>
<td>指定毫秒数</td>
</tr>
<tr>
<td>唤醒</td>
<td>notify()</td>
<td>唤醒一个处于等待状态的线程</td>
</tr>
<tr>
<td>唤醒</td>
<td>notifyAll()</td>
<td>唤醒同一对象上所有调用wait()方法的线程，优先唤醒优先级高的线程</td>
</tr>
</tbody>
</table>
<h4 id="生产者消费者模型的通信方式"><a href="#生产者消费者模型的通信方式" class="headerlink" title="生产者消费者模型的通信方式"></a>生产者消费者模型的通信方式</h4><ol>
<li>管程法</li>
<li>信号灯法</li>
</ol>
<pre class="mermaid">graph LR

a(生产者) --> B{数据缓存区}
B --> C(消费者)</pre>

<p>生产者消费者模型：</p>
<ul>
<li>生产者：负责生产数据</li>
<li>消费者：负责处理数据</li>
<li>缓冲区：生产者将数据放入缓冲区，消费者从缓冲区拿出数据</li>
</ul>
<h5 id="管程法"><a href="#管程法" class="headerlink" title="管程法"></a>管程法</h5><ul>
<li><ol>
<li>缓冲区</li>
</ol>
</li>
<li><ol start="2">
<li>notify() / wait()</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程之间通信之生产者消费者模式</span></span><br><span class="line"><span class="comment"> * 管程法</span></span><br><span class="line"><span class="comment"> * 1. 缓冲区</span></span><br><span class="line"><span class="comment"> * 2. notify() / wait()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CooperationPipe</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> BufferData bufferData = <span class="keyword">new</span> BufferData();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Producer(bufferData)).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Consumer(bufferData)).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 缓存区</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferData</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] list = <span class="keyword">new</span> String[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    final ReentrantLock lock = new ReentrantLock();</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            lock.lock();</span></span><br><span class="line">        <span class="keyword">if</span> (count == list.length) &#123;</span><br><span class="line">            <span class="comment">// 容器满了，生产者等待</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait(); <span class="comment">// BufferData</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 容器未满，进行生产</span></span><br><span class="line">        list[count] = str;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="comment">// 告知消费者</span></span><br><span class="line">        <span class="keyword">this</span>.notifyAll();</span><br><span class="line"><span class="comment">//        &#125; finally &#123;</span></span><br><span class="line"><span class="comment">//            lock.unlock();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            lock.lock();</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 产品没了，自己等待</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        count--;</span><br><span class="line">        <span class="comment">// 通知生产者生产</span></span><br><span class="line">        <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        <span class="keyword">return</span> list[count];</span><br><span class="line"><span class="comment">//        &#125; finally &#123;</span></span><br><span class="line"><span class="comment">//            lock.unlock();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferData bufferData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BufferData bufferData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferData = bufferData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"生产了"</span> + i);</span><br><span class="line">            bufferData.push(String.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BufferData bufferData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BufferData bufferData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bufferData = bufferData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">"消费了----"</span> + bufferData.pop());</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="信号灯法"><a href="#信号灯法" class="headerlink" title="信号灯法"></a>信号灯法</h5><ol>
<li>标志位</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程之间通信之生产者消费者模式</span></span><br><span class="line"><span class="comment"> * 信号灯法</span></span><br><span class="line"><span class="comment"> * 1. 标志位</span></span><br><span class="line"><span class="comment"> * 2. notify() / wait()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CooperationSign</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Sign sign = <span class="keyword">new</span> Sign();</span><br><span class="line">        Producer1 producer = <span class="keyword">new</span> Producer1(sign);</span><br><span class="line">        <span class="keyword">new</span> Thread(producer).start();</span><br><span class="line"></span><br><span class="line">        Consumer1 consumer = <span class="keyword">new</span> Consumer1(sign);</span><br><span class="line">        <span class="keyword">new</span> Thread(consumer).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 信号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sign</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生产中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isProduct = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> String produce;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">product</span><span class="params">(String produce)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isProduct) &#123;</span><br><span class="line"><span class="comment">//            System.out.println("消费者正在使用，无法生产");</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"生产者生产了"</span> + produce);</span><br><span class="line">        <span class="keyword">this</span>.produce = produce;</span><br><span class="line">        <span class="keyword">this</span>.isProduct = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.notifyAll(); <span class="comment">// 唤醒消费者</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isProduct) &#123;</span><br><span class="line"><span class="comment">//            System.out.println("生产者正在生产，无法消费");</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"消费者消费了"</span> + <span class="keyword">this</span>.produce);</span><br><span class="line">        <span class="keyword">this</span>.isProduct = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.notifyAll(); <span class="comment">// 唤醒生产者</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Producer1</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sign sign;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Producer1</span><span class="params">(Sign sign)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sign = sign;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sign.product(<span class="string">"苹果"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Consumer1</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Sign sign;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Consumer1</span><span class="params">(Sign sign)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sign = sign;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.sign.consume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><ol>
<li>jdk5.0引入线程池API</li>
<li>可提前创建很多线程，放在线程池，使用时直接取用，用完放回池中。避免频繁创建销毁线程，实现重复利用。提高响应速度，降低资源消耗，便于线程管理。</li>
<li><strong>ExecutorService</strong>：线程池【<strong>接口</strong>】，常见子类ThreadPoolExecutor。<ul>
<li>void execute()  执行任务，没有返回值，一般用来执行【Runnable】线程类</li>
<li>submit()  执行任务，有返回值，一般用来执行【Callable】线程类</li>
<li>void shutdown()  关闭连接池</li>
</ul>
</li>
<li><strong>Executors</strong>：工具类、线程池的【<strong>工厂类</strong>】，用于创建并返回不同类型的线程池。</li>
<li>corePoolSize 核心池大小</li>
<li>maximumPoolSize 最大线程数</li>
<li>keepAliveTime 线程没有任务时，最多保持多长时间终止</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建</span></span><br><span class="line">ExecutorService service = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line">service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line">service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line">service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭</span></span><br><span class="line">service.shutdown();</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建线程池</span></span><br><span class="line">        ExecutorService service = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行线程</span></span><br><span class="line">        service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line">        service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line">        service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line">        service.execute(<span class="keyword">new</span> MyThread());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭线程池</span></span><br><span class="line">        service.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>quartz</title>
    <url>/want/2020/06/10/quartz/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Quartz，由Java编写、用于Java程序执行定时任务。可JVM独立运行，也可集成使用。</p>
<ul>
<li>可以通过 Calendar 执行(排除节假日)</li>
<li>指定某个时间无限循环执行， 比如每五分钟执行一次</li>
<li>固定时间执行，如每周周一上午10点执行，每月2号上午10点执行</li>
</ul>
<p>相较于<code>java.util.Timer</code>， Quartz增加了很多功能：</p>
<ol>
<li>持久性作业 - 保持调度定时的状态;</li>
<li>作业管理 - 对调度作业进行有效的管理;</li>
</ol>
<table>
<thead>
<tr>
<th>Quartz核心概念</th>
<th>中文</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Job</td>
<td>任务</td>
<td>具体的作业。what to do</td>
</tr>
<tr>
<td>Trigger</td>
<td>触发器</td>
<td>触发Job，指定Job的执行时间、执行间隔、运行次数等。 when to do</td>
</tr>
<tr>
<td>Scheduler</td>
<td>调度器</td>
<td>联接Job和Trigger，指定Trigger执行指定Job</td>
</tr>
</tbody>
</table>
<p>一个 Job 可以对应多个 Trigger， 但一个 Trigger 只能对应一个 Job。<code>job(1) &lt;=&gt; Trigger(n)</code></p>
<pre class="mermaid">graph TB
A[Scheduler]
A ==> B[Job]
A ==> C[Trigger]

B -.- B1(JobDetail)
B -.- B2(JobExecutionContext)

C -.- C1(CronTrigger)
C -.- C2(SimpleTrigger)</pre>



<p>配置核心概念的方式：</p>
<ol>
<li>java直接配置并实现。</li>
<li>xml配置Quartz参数，Java只负责业务实现。</li>
<li>和spring相关框架搭配。</li>
</ol>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>定义需要具体执行的任务。</p>
<h4 id="Job-1"><a href="#Job-1" class="headerlink" title="Job"></a>Job</h4><p>是个接口，只有一个方法<code>execute(JobExecutionContext context)</code>，在实现类的execute中编写业务逻辑。</p>
<ul>
<li>JobExecutionContext：包含了Quartz运行时的环境以及Job本身的详细数据信息，其中Job运行时的信息保存在 JobDataMap 实例中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Job接口源码</span></span><br><span class="line"><span class="keyword">package</span> org.quartz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext var1)</span> <span class="keyword">throws</span> JobExecutionException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在Job接口的实现类中，定义业务逻辑！！！（真正要执行的内容）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoPrint</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException 		</span>&#123;</span><br><span class="line">        SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        String time = simpleDateFormat.format(<span class="keyword">new</span> Date());</span><br><span class="line">        Integer random = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</span><br><span class="line">        System.out.println(<span class="string">"=================Time:"</span> + time + <span class="string">", Random:"</span> + random);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="JobDetail"><a href="#JobDetail" class="headerlink" title="JobDetail"></a>JobDetail</h4><p>用来绑定指定的Job，为Job实例提供属性：</p>
<ul>
<li>name：Job 名字</li>
<li>group</li>
<li>jobClass</li>
<li>jobDataMap：实现了JDK的Map接口，可以以Key-Value的形式存储数据。<code>JobDetail</code>、<code>Trigger</code>都可以使用JobDataMap来设置一些参数信息</li>
<li>不直接接受一个 Job 的实例，相反它接收一个 Job 实现类，以便运行时通过 <code>newInstance()</code> 的反射机制实例化 Job。</li>
</ul>
<p>每次Scheduler调度执行一个Job的时候,①先根据JobDetail找到对应的Job，②根据JobDetail重新创建一个<code>Job实例</code>，③执行<code>Job实例</code>的execute方法。④任务执行结束后，关联的<code>Job实例</code>会被释放，且被JVM GC清除。</p>
<blockquote>
<p>JobDetail定义的是任务配置，真正执行是Job。<br>这是因为任务有可能【并发执行】，如果Scheduler直接使用Job，会存在对同一Job实例并发访问的问题。<br>而JobDetail &amp; Job 方式，Scheduler每次执行，都会根据JobDetail创建一个新的Job实例，这样就可以规避并发访问的问题。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 绑定AutoPrint这个执行逻辑</span></span><br><span class="line">JobDetail jobDetail = JobBuilder.newJob(AutoPrint<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">                    .withIdentity("jobKey", "groupKey")</span><br><span class="line">                    .setJobData(jobDataMap)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定AutoPrint1执行逻辑</span></span><br><span class="line">JobDetail jobDetail1 = JobBuilder.newJob(AutoPrint1<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">                    .withIdentity("jobKey1", "groupKey1")</span><br><span class="line">                    .build();</span><br></pre></td></tr></table></figure>
<h4 id="任务状态"><a href="#任务状态" class="headerlink" title="任务状态"></a>任务状态</h4><ol>
<li><p>有状态Job：</p>
<ul>
<li>共享同一个 JobDataMap 实例，每次任务执行对 JobDataMap 所做的更改会保存下来，后面的执行可以看到这个更改，即每次执行任务后都会对后面的执行发生影响。</li>
<li><strong>不能</strong>并发执行。上次job未执行完毕，则下次job将<code>阻塞等待</code>，直到上次job执行完毕。</li>
</ul>
</li>
<li><p>无状态Job：</p>
<ul>
<li>在执行时拥有自己的 JobDataMap 拷贝，对 JobDataMap 的更改不会影响下次的执行</li>
<li><strong>能</strong>并发执行。</li>
</ul>
</li>
</ol>
<h4 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h4><p>JobListener 监听任务执行前事件、任务执行后事件；</p>
<h3 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h3><p>触发任务。是个接口，描述触发 job 执行的时间触发规则。</p>
<ol>
<li>new Trigger().startAt()：表示触发器首次被触发的时间;</li>
<li>new Trigger().endAt()：表示触发器结束触发的时间;</li>
</ol>
<p>包括两类触发器：</p>
<ol>
<li>SimpleTrigger：简单，适合次数和间隔</li>
<li>CronTrigger：灵活常用，适合次数、间隔等，也适合精准定时。</li>
</ol>
<p>也可以使用ScheduleBuilder的子类来触发操作：</p>
<ol>
<li>SimpleScheduleBuilder</li>
<li>CronScheduleBuilder。</li>
</ol>
<h4 id="SimpleTrigger"><a href="#SimpleTrigger" class="headerlink" title="SimpleTrigger"></a>SimpleTrigger</h4><ol>
<li>强调次数，比如每天执行若干次。用于当且仅当需调度一次、或者以固定时间间隔周期执行调度。</li>
<li>精准指定间隔，如，程序运行5s后开始执行Job，执行Job 5s后结束执行。</li>
<li>无法设置具体时间，及不适合每天定时执行任务的场景，比如不能设置每天半夜十二点执行任务。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建SimpleTrigger startTime end 分别表示触发器的首次触发时间和不再被触发的时间</span></span><br><span class="line"> SimpleTrigger trigger = newTrigger()</span><br><span class="line">                    .withIdentity(<span class="string">"triggerKey"</span>, <span class="string">"groupKey"</span>)</span><br><span class="line">                    .startAt(startTime)</span><br><span class="line">                    .endAt(end)</span><br><span class="line">                    .withSchedule(</span><br><span class="line">                        SimpleScheduleBuilder</span><br><span class="line">                            .simpleSchedule()</span><br><span class="line">                            .withIntervalInHours(<span class="number">2</span>)</span><br><span class="line">                            .withRepeatCount(<span class="number">0</span>) <span class="comment">// 定义重复执行次数是无限次</span></span><br><span class="line">                    )</span><br><span class="line">                    .build();</span><br></pre></td></tr></table></figure>
<h4 id="CronTrigger"><a href="#CronTrigger" class="headerlink" title="CronTrigger"></a>CronTrigger</h4><p>基于Cron表达式定义更灵活的时间规则，是基于日历的作业调度。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建CornTrigger 比如下面的就是设计每天中午十二点整触发</span></span><br><span class="line">CronTrigger trigger = newTrigger()</span><br><span class="line">                  .withIdentity(<span class="string">"triggerKey"</span>, <span class="string">"groupKey"</span>)</span><br><span class="line">                  .withSchedule(cronSchedule(<span class="string">"0 0 12 * * ?"</span>))</span><br><span class="line">                  .build();</span><br></pre></td></tr></table></figure>
<h4 id="Cron表达式"><a href="#Cron表达式" class="headerlink" title="Cron表达式"></a>Cron表达式</h4><p>设置定时任务执行的时间</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;bean class=&quot;org.springframework.scheduling.quartz.CronTriggerFactoryBean&quot;&gt;</span><br><span class="line">	&lt;!-- 设置调度的时间规则--&gt;</span><br><span class="line">	&lt;property name=&quot;cronExpression&quot; value=&quot;0 */15 * * * ?&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<p>cronExpression是以5或6个空格隔开的字符串。分成6或7个域。每个域代表一个含义。</p>
<p>在线生成Cron表达式：<a href="https://cron.qqe2.com/" target="_blank" rel="noopener">https://cron.qqe2.com/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 7种</span><br><span class="line">[秒] [分] [时] [日] [月] [周] [年]</span><br><span class="line">Seconds Minutes Hours DayofMonth Month DayofWeek Year</span><br><span class="line"></span><br><span class="line"># 6种</span><br><span class="line">[秒] [分] [时] [日] [月] [周]</span><br><span class="line">Seconds Minutes Hours DayofMonth Month DayofWeek</span><br><span class="line"></span><br><span class="line"># 每月的2日10:00:00，触发调度</span><br><span class="line">0 0 10 2 * ?</span><br></pre></td></tr></table></figure>
<blockquote>
<p>字符不区分大小写</p>
</blockquote>
<table>
<thead>
<tr>
<th>含义</th>
<th>可能值</th>
<th>有效范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>Seconds</td>
<td>, - * /</td>
<td>0-59的整数</td>
</tr>
<tr>
<td>Minutes</td>
<td>, - * /</td>
<td>0-59的整数</td>
</tr>
<tr>
<td>Hours</td>
<td>, - * /</td>
<td>0-23的整数</td>
</tr>
<tr>
<td>DayofMonth</td>
<td>, - * / ? L W C</td>
<td>0-31的整数</td>
</tr>
<tr>
<td>Month</td>
<td>, - * /</td>
<td>0-11的整数或JAN-DEc</td>
</tr>
<tr>
<td>DayofWeek</td>
<td>, - * / ? L C #</td>
<td>1，2，3，4，5，6，7或 SUN，MON，TUE，WED，THU，FRI，SAT两种，1星期天，2星期一</td>
</tr>
<tr>
<td>Year</td>
<td>, - * /</td>
<td>1970-2099的整数</td>
</tr>
</tbody>
</table>
<blockquote>
<p>符号含义</p>
</blockquote>
<table>
<thead>
<tr>
<th>符号</th>
<th>用途</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>匹配该域的任意值</td>
<td>如在Minutes域使用*, 表示每分钟都会触发事件</td>
</tr>
<tr>
<td>/</td>
<td>起始时间开始触发，每隔固定时间再触发</td>
<td>如在Minutes域使用5/20,则意味着5分钟触发一次，以后每隔20分钟再次触发，如25，45等分别触发一次</td>
</tr>
<tr>
<td>-</td>
<td>范围</td>
<td>如在Minutes域使用5-20，表示从5分到20分钟每分钟触发一次</td>
</tr>
<tr>
<td>,</td>
<td>列出枚举值</td>
<td>如在Minutes域使用5,20，则意味着在5和20分每分钟触发一次</td>
</tr>
<tr>
<td>?</td>
<td>只用在DayofMonth和DayofWeek,匹配该域任意值</td>
<td>因DayofMonth和DayofWeek会冲突，故要在每月20日触发调度，则不管20日到底是星期几，只能使用如下写法： 13 13 15 20 <em> ?。即最后一位只能用?而不能用</em>，如果使用*则表示不管星期几都会触发，实际并非如此</td>
</tr>
<tr>
<td>L</td>
<td>只用在DayofMonth和DayofWeek,表示最后</td>
<td>如在DayofWeek域使用5L,表示只在最后的一个星期四触发</td>
</tr>
<tr>
<td>W</td>
<td>只用在DayofMonth,在本月中、离指定日期(周一到周五)最近的有效工作日触发</td>
<td>在DayofMonth使用5W，如果5日是星期六，则将在本月中最近的工作日：星期五，即4日触发</td>
</tr>
<tr>
<td>LW</td>
<td>连用，只用在DayofMonth,在某个月最后一个工作日</td>
<td>即最后一个星期五</td>
</tr>
<tr>
<td>#</td>
<td>只能在DayofMonth域，确定每个月第几个星期几</td>
<td>在4#2，表示某月的第2个星期3</td>
</tr>
</tbody>
</table>
<p>举例:<br>| 例 | 用途|<br>| – | – |<br>| 0 0 2 1 <em> ? </em>            | 每月的1日02点                 |<br>| 0 15 10 ? <em> MON-FRI      | 周一到周五每日的10:15                  |<br>| 0 15 10 ? </em> 6L 2002-2006 | 2002-2006年，每年最后一个周五的10:15    |<br>| 0 0 10,14,16 <em> </em> ?       | 每天的10点14点16点                      |<br>| 0 0/30 9-17 <em> </em> ?        | 9点到17点，从0分开始，每隔30分钟执行一次 |<br>| 0 0 12 ? <em> WED           | 每周三的12点:00            |<br>| 0 0 12 </em> <em> ?             | 每天12:00  |<br>| 0 </em> 14 <em> </em> ?             | 每天14点到14:59的每一分钟都执行   |<br>| 0 15 10 ? * 6#3          | 每个月的第3个星期5当天的10:15:00     |</p>
<h4 id="监听-1"><a href="#监听-1" class="headerlink" title="监听"></a>监听</h4><p>TriggerListener 监听触发器触发前事件、触发后事件</p>
<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>调度器相当于一个容器，装载着任务Job和触发器Trigger。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建计划任务抽象工厂</span></span><br><span class="line">SchedulerFactory schedulerFactory = <span class="keyword">new</span> StdSchedulerFactory();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建计划任务【从工厂生产任务调度】</span></span><br><span class="line">Scheduler scheduler = schedulerFactory.getScheduler();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 把job和trigger加入调度</span></span><br><span class="line">scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line"></span><br><span class="line"><span class="comment">//启动scheduler</span></span><br><span class="line">scheduler.start();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 6. 任务执行后20秒后休眠</span></span><br><span class="line">            Thread.sleep(startTime.getTime() + <span class="number">20000L</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭scheduler</span></span><br><span class="line">   <span class="keyword">if</span> (scheduler.isStarted()) &#123;</span><br><span class="line">scheduler.shutdown(<span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Scheduler 是个接口，定义了多个接口方法， 允许外部通过组及名称访问和控制容器中 Trigger 和 JobDetail。</p>
<p>Trigger 和 JobDetail 注册到 Scheduler 中， 两者在 Scheduler 中拥有各自的组及名称， 组及名称是 Scheduler 查找定位容器中某一对象的依据， Trigger 的组及名称必须唯一， JobDetail 的组和名称也必须唯一（但可以和 Trigger 的组和名称相同，因为它们是不同类型的）。</p>
<p>Scheduler 可以将 Trigger 绑定到某一 JobDetail 中， 这样当 Trigger 触发时， 对应的 Job 就被执行。一个 Job 可以对应多个 Trigger， 但一个 Trigger 只能对应一个 Job。</p>
<p><strong>SchedulerFactory</strong> </p>
<p>通过 SchedulerFactory 创建一个 SchedulerFactory 实例。</p>
<p><strong>SchedulerContext</strong></p>
<p>Scheduler 拥有一个 SchedulerContext，保存着 Scheduler 上下文信息，Job 和 Trigger 都可以访问 SchedulerContext 内的信息。</p>
<p>SchedulerContext 内部通过一个 Map，以键值对的方式维护这些数据，SchedulerContext 为保存和获取数据提供了多个 <code>put()</code> 和 <code>getXxx()</code> 的方法。可以通过 <code>Scheduler#getContext()</code> 获取对应的 SchedulerContext 实例。</p>
<h4 id="监听-2"><a href="#监听-2" class="headerlink" title="监听"></a>监听</h4><p>SchedulerListener 听调度器开始事件、关闭事件等等，可以注册相应的监听器处理感兴趣的事件。</p>
<h4 id="ThreadPool"><a href="#ThreadPool" class="headerlink" title="ThreadPool"></a>ThreadPool</h4><p>Scheduler 使用一个线程池作为任务运行的基础设施，任务通过共享线程池中的线程提高运行效率。</p>
<p>Scheduler调度线程主要有两个:</p>
<ol>
<li>执行常规调度的线程：轮询存储的所有trigger，如果有需要触发的trigger，即到达了下一次触发的时间，则从任务执行线程池获取一个空闲线程，执行与该trigger关联的任务</li>
<li>执行misfiredtrigger的线程：扫描所有的trigger，查看是否有misfiredtrigger，如果有的话根据misfire的策略分别处理(fire now OR wait for the next fire)。</li>
</ol>
<p>org.quartz.simpl.SimpleThreadPool’ - with 10 threads</p>
<p>在Quartz中有两类线程：Scheduler调度线程和任务执行线程。</p>
<ul>
<li><p>任务执行线程：Quartz不会在主线程(QuartzSchedulerThread)中处理用户的Job。Quartz把线程管理的职责委托给ThreadPool，一般的设置使用SimpleThreadPool。</p>
</li>
<li><p>SimpleThreadPool创建了一定数量的WorkerThread实例来使得Job能够在线程中进行处理。WorkerThread是定义在SimpleThreadPool类中的内部类，它实质上就是一个线程。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 默认，且默认10个线程</span><br><span class="line">org.quartz.simpl.SimpleThreadPool</span><br></pre></td></tr></table></figure>
<h3 id="Calendars"><a href="#Calendars" class="headerlink" title="Calendars"></a>Calendars</h3><p>用于触发器的触发计划中排除时间块，比如国庆期间不营业。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.quartz.impl.calendar.HolidayCalendar;</span><br><span class="line"></span><br><span class="line">HolidayCalendar cal = <span class="keyword">new</span> HolidayCalendar();</span><br><span class="line">cal.addExcludedDate( someDate );</span><br><span class="line">cal.addExcludedDate( someOtherDate );</span><br><span class="line"></span><br><span class="line">sched.addCalendar(<span class="string">"myHolidays"</span>, cal, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Trigger t = newTrigger()</span><br><span class="line">    .withIdentity(<span class="string">"myTrigger"</span>)</span><br><span class="line">    .forJob(<span class="string">"myJob"</span>)</span><br><span class="line">    .withSchedule(dailyAtHourAndMinute(<span class="number">9</span>, <span class="number">30</span>)) <span class="comment">// execute job daily at 9:30</span></span><br><span class="line">    .modifiedByCalendar(<span class="string">"myHolidays"</span>) <span class="comment">// 假日除外</span></span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>
<ol>
<li>AnnualCalendar 年历</li>
<li>CronCalendar cron 日历</li>
<li>DailyCalendar 每日日历</li>
<li>HolidayCalendar 假日日历</li>
<li>MonthlyCalendar 月历</li>
<li>WeeklyCalendar 周历</li>
</ol>
<h3 id="Job-Stores"><a href="#Job-Stores" class="headerlink" title="Job Stores"></a>Job Stores</h3><blockquote>
<p>Quartz中的trigger和job需要存储下来才能被使用。</p>
<p>主要存储内容是scheduler下的job、trigger、calender等==work data==</p>
</blockquote>
<p>Quartz中有两种常用的存储方式：</p>
<ol>
<li>RAMJobStore：内存存储。存取速度快，停止后数据丢失。</li>
<li>JDBCJobStore： 数据库存储。持久化数据，集群中只能使用持久化存储。</li>
</ol>
<h4 id="1-RAMJobStore-内存存储"><a href="#1-RAMJobStore-内存存储" class="headerlink" title="1. RAMJobStore(内存存储 )"></a>1. RAMJobStore(内存存储 )</h4><p>【默认配置】scheduler 被关闭或机器故障后，数据就丢了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.class = org.quartz.simpl.RAMJobStore</span><br></pre></td></tr></table></figure>
<h4 id="2-JDBCJobStore-数据库存储"><a href="#2-JDBCJobStore-数据库存储" class="headerlink" title="2. JDBCJobStore(数据库存储)"></a>2. JDBCJobStore(数据库存储)</h4><p>支持的数据库有==Oracle, PostgreSQL, MySQL, MS SQLServer, HSQLDB, and DB2==，需要创建quartz单独的数据库表，各类数据库的quartz表结构语句在quartz源代码的==“docs/dbTables”==下。参见集群相关库表。</p>
<p>事务类型：</p>
<ol>
<li>JobStoreTX（默认，常见）：TM 是 transactions-managed 的缩写，该类会处理事务的提交和回滚等逻辑。</li>
<li>JobStoreCMT：CMT 是 container-managed-transactions 的缩写，当前类不处理事务的提交和回滚，全权由应用服务器自身处理。quartz会让应用服务来管理quartz事务</li>
</ol>
<h5 id="配置quartz-使用JobStoreTX"><a href="#配置quartz-使用JobStoreTX" class="headerlink" title="配置quartz 使用JobStoreTX"></a>配置quartz 使用JobStoreTX</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.class = org.quartz.impl.jdbcjobstore.JobStoreTX</span><br></pre></td></tr></table></figure>
<h5 id="配置数据库委托"><a href="#配置数据库委托" class="headerlink" title="配置数据库委托"></a>配置数据库委托</h5><blockquote>
<p>数据库委托信息在包==org.quartz.impl.jdbcjobstore==下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span><br></pre></td></tr></table></figure>
<h5 id="quartz数据库表的前缀"><a href="#quartz数据库表的前缀" class="headerlink" title="quartz数据库表的前缀"></a>quartz数据库表的前缀</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.tablePrefix = QRTZ_</span><br></pre></td></tr></table></figure>
<h5 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h5><p>可以指定==org.quartz.jobStore.useProperties==为==true==，这样的就是以==String==类型存储==JobDataMaps==信息，而不是==BLOB==</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.dataSource = myDS</span><br></pre></td></tr></table></figure>
<h4 id="3-TerracottaJobStore（Terracotta服务器存储）"><a href="#3-TerracottaJobStore（Terracotta服务器存储）" class="headerlink" title="3. TerracottaJobStore（Terracotta服务器存储）"></a>3. TerracottaJobStore（Terracotta服务器存储）</h4><p>Quartz被Terracotta收购了。</p>
<blockquote>
<p>TerracottaJobStore可以是集群，也可以是单点的，不过都可以为作业数据提供存储介质，因为数据存储在Terracotta服务器中，因此在应用程序重新启动期间是持久存储的。、</p>
<p>它的性能比JDBCJobStore使用数据库要好得多(大约好一个数量级)，但是比RAMJobStore慢得多。</p>
</blockquote>
<h5 id="配置使用TerracottaJobStore"><a href="#配置使用TerracottaJobStore" class="headerlink" title="配置使用TerracottaJobStore"></a>配置使用TerracottaJobStore</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.quartz.jobStore.class = org.terracotta.quartz.TerracottaJobStore</span><br><span class="line">org.quartz.jobStore.tcConfigUrl = localhost:9510</span><br></pre></td></tr></table></figure>
<h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p>Quartz在某一个时刻，将随机指定集群中的某一个节点，来完成任务。</p>
<ol>
<li>一致性：即节点之间在同一时刻是互斥关系，通过锁机制，保证多个节点Scheduler实例对任务的调度唯一。</li>
<li>高可用性：当一个节点执行失败，可以依靠另一个节点运行。</li>
</ol>
<blockquote>
<p>高可用的两种配置：</p>
<ol>
<li><p>当一个节点Sheduler实例执行某个Job失败时，希望由另一正常工作节点的Scheduler实例接过这个Job重新运行。则，配置给JobDetail对象的Job<strong>可恢复属性</strong>必须设为true（jobDetail.setRequestsRecovery(true)）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;    &lt;property name=&quot;requestsRecovery&quot; value=&quot;true&quot; /&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<blockquote>
<ol start="2">
<li><p>当一个节点Scheduler实例执行某个Job失败时，希望Job不再重新运行，而是由另一个节点Scheduler实例在下一次触发时间触发。则，可恢复属性应该设置为false(默认为false)。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;    &lt;property name=&quot;requestsRecovery&quot; value=&quot;false&quot; /&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<blockquote>
<p>Scheduler实例出现故障后多快能被侦测到，取决于每个Scheduler检入间隔（org.quartz.jobStore.clusterCheckinInterval）。</p>
</blockquote>
<h4 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h4><ol>
<li><p>Quartz集群中，每个节点是一个独立的Quartz应用，必须对每个节点分别启动或停止。</p>
</li>
<li><p>Quartz集群中，独立Quartz节点并不与其他节点通信，而是通过【<strong>相同的数据库表</strong>】感知另一Quartz应用。</p>
</li>
<li>只有使用【<strong>持久化JobStore</strong>】存储Job和Trigger才能完成Quartz集群。因此<strong>集群依赖于数据库</strong>，</li>
</ol>
<p>JobStore的存储方式有两种：</p>
<ul>
<li>RAMJobStore：将scheduler存储在内存中，但是<strong>重启服务器信息会丢失</strong>。</li>
<li>JDBCJobStore：将scheduler存储在数据库中。<strong>适用于集群。</strong></li>
</ul>
<p>因为<strong>集群依赖于数据库</strong>，所以必须采用数据库用来持久化存储scheduler数据。</p>
<p>数据库利用QRTZ_LOCKS表执行“行锁”（数据库悲观锁），来保证某时刻某job只能被一个节点执行。</p>
<pre class="mermaid">graph TB

A0(Quartz服务器节点1) --> C(Quartz数据库)
A1(Quartz服务器节点2) --> C
A2(Quartz服务器节点...) --> C</pre>

<h4 id="集群相关数据库表"><a href="#集群相关数据库表" class="headerlink" title="集群相关数据库表"></a>集群相关数据库表</h4><p>集群依赖于数据库，所以首先创建Quartz数据库表。</p>
<blockquote>
<p>Quartz官方提供了生成数据库表的sql语句：</p>
<p><a href="https://github.com/quartz-scheduler/quartz/blob/master/quartz-core/src/main/resources/org/quartz/impl/jdbcjobstore/tables_mysql_innodb.sql" target="_blank" rel="noopener">https://github.com/quartz-scheduler/quartz/blob/master/quartz-core/src/main/resources/org/quartz/impl/jdbcjobstore/tables_mysql_innodb.sql</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>表名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>QRTZ_JOB_DETAILS</td>
<td>记录每个任务JOB的详细信息</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>QRTZ_TRIGGERS</td>
<td>记录每个触发器Trigger的详细信息</td>
</tr>
<tr>
<td>QRTZ_CRON_TRIGGERS</td>
<td>存放cron类型的触发器</td>
</tr>
<tr>
<td>QRTZ_SIMPLE_TRIGGERS</td>
<td>存储简单的trigger，包括重复次数，间隔，以及触发次数。</td>
</tr>
<tr>
<td>QRTZ_FIRED_TRIGGERS</td>
<td>存储已经触发的trigger相关信息，trigger随着时间的推移状态发生变化，直到最后trigger执行完成，从表中被删除。<strong>相同的trigger和job，每触发一次都会创建一个实例；从刚被创建的ACQUIRED状态，到EXECUTING状态，最后执行完从数据库中删除；</strong></td>
</tr>
<tr>
<td>QRTZ_PAUSED_TRIGGER_GRPS</td>
<td>存储已暂停的 Trigger 组的信息</td>
</tr>
<tr>
<td>QRTZ_SIMPROP_TRIGGERS</td>
<td>存储CalendarIntervalTrigger和DailyTimeIntervalTrigger两种类型的触发器</td>
</tr>
<tr>
<td>QRTZ_BLOB_TRIGGERS</td>
<td>自定义的triggers使用blog类型进行存储（非自定义的triggers不会存放在此表中，Quartz提供的triggers包括：CronTrigger，CalendarIntervalTrigger，DailyTimeIntervalTrigger以及SimpleTrigger）</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>QRTZ_CALENDARS</td>
<td>以 Blob 类型存储 Quartz 的 Calendar 信息</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>QRTZ_SCHEDULER_STATE</td>
<td>存储集群下所有节点的scheduler实例名，会定期检查scheduler是否失效，启动多个scheduler，查询数据库。记录了最后最新的检查时间。</td>
</tr>
<tr>
<td>QRTZ_LOCKS</td>
<td>存储程序的悲观锁的信息(假如使用了悲观锁)</td>
</tr>
</tbody>
</table>
<p>QRTZ_SCHEDULER_STATE：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;bean name=&quot;quartzScheduler&quot;   class=&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>Quartz提供的锁表，为多个节点调度提供分布式锁，实现分布式调度，默认有2个锁：</p>
<ul>
<li><strong>STATE_ACCESS</strong>：主要用在scheduler定期检查是否有效的时候，保证只有一个节点去处理已经失效的scheduler。</li>
<li><strong>TRIGGER_ACCESS</strong>：主要用在TRIGGER被调度的时候，保证只有一个节点去执行调度。</li>
</ul>
<p>还有其他锁：</p>
<ul>
<li><strong>CALENDAR_ACCESS </strong></li>
<li><strong>JOB_ACCESS</strong></li>
<li><strong>MISFIRE_ACCESS</strong> </li>
</ul>
<h5 id="sql附录"><a href="#sql附录" class="headerlink" title="sql附录"></a>sql附录</h5><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_FIRED_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_PAUSED_TRIGGER_GRPS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SCHEDULER_STATE;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_LOCKS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SIMPLE_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_SIMPROP_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_CRON_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_BLOB_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_TRIGGERS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_JOB_DETAILS;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> QRTZ_CALENDARS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_JOB_DETAILS(</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">DESCRIPTION <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="literal">NULL</span>,</span><br><span class="line">JOB_CLASS_NAME <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">IS_DURABLE <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">IS_NONCONCURRENT <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">IS_UPDATE_DATA <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">REQUESTS_RECOVERY <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,JOB_NAME,JOB_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_TRIGGERS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">DESCRIPTION <span class="built_in">VARCHAR</span>(<span class="number">250</span>) <span class="literal">NULL</span>,</span><br><span class="line">NEXT_FIRE_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,</span><br><span class="line">PREV_FIRE_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,</span><br><span class="line"><span class="keyword">PRIORITY</span> <span class="built_in">INTEGER</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_STATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_TYPE <span class="built_in">VARCHAR</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">START_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">END_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="literal">NULL</span>,</span><br><span class="line">CALENDAR_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="literal">NULL</span>,</span><br><span class="line">MISFIRE_INSTR <span class="built_in">SMALLINT</span>(<span class="number">2</span>) <span class="literal">NULL</span>,</span><br><span class="line">JOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,JOB_NAME,JOB_GROUP)</span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SIMPLE_TRIGGERS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">REPEAT_COUNT <span class="built_in">BIGINT</span>(<span class="number">7</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">REPEAT_INTERVAL <span class="built_in">BIGINT</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TIMES_TRIGGERED <span class="built_in">BIGINT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_CRON_TRIGGERS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">CRON_EXPRESSION <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TIME_ZONE_ID <span class="built_in">VARCHAR</span>(<span class="number">80</span>),</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SIMPROP_TRIGGERS</span><br><span class="line">  (</span><br><span class="line">    SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    STR_PROP_1 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,</span><br><span class="line">    STR_PROP_2 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,</span><br><span class="line">    STR_PROP_3 <span class="built_in">VARCHAR</span>(<span class="number">512</span>) <span class="literal">NULL</span>,</span><br><span class="line">    INT_PROP_1 <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line">    INT_PROP_2 <span class="built_in">INT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LONG_PROP_1 <span class="built_in">BIGINT</span> <span class="literal">NULL</span>,</span><br><span class="line">    LONG_PROP_2 <span class="built_in">BIGINT</span> <span class="literal">NULL</span>,</span><br><span class="line">    DEC_PROP_1 <span class="built_in">NUMERIC</span>(<span class="number">13</span>,<span class="number">4</span>) <span class="literal">NULL</span>,</span><br><span class="line">    DEC_PROP_2 <span class="built_in">NUMERIC</span>(<span class="number">13</span>,<span class="number">4</span>) <span class="literal">NULL</span>,</span><br><span class="line">    BOOL_PROP_1 <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,</span><br><span class="line">    BOOL_PROP_2 <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span><br><span class="line">    <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span><br><span class="line">    <span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_BLOB_TRIGGERS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">BLOB_DATA <span class="built_in">BLOB</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</span><br><span class="line"><span class="keyword">INDEX</span> (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),</span><br><span class="line"><span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</span><br><span class="line"><span class="keyword">REFERENCES</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_CALENDARS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">CALENDAR_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">CALENDAR <span class="built_in">BLOB</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,CALENDAR_NAME))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_PAUSED_TRIGGER_GRPS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,TRIGGER_GROUP))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_FIRED_TRIGGERS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">ENTRY_ID <span class="built_in">VARCHAR</span>(<span class="number">95</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">TRIGGER_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">INSTANCE_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">FIRED_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">SCHED_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line"><span class="keyword">PRIORITY</span> <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">STATE <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">JOB_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="literal">NULL</span>,</span><br><span class="line">JOB_GROUP <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="literal">NULL</span>,</span><br><span class="line">IS_NONCONCURRENT <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,</span><br><span class="line">REQUESTS_RECOVERY <span class="built_in">VARCHAR</span>(<span class="number">1</span>) <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,ENTRY_ID))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_SCHEDULER_STATE (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">INSTANCE_NAME <span class="built_in">VARCHAR</span>(<span class="number">190</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LAST_CHECKIN_TIME <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">CHECKIN_INTERVAL <span class="built_in">BIGINT</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,INSTANCE_NAME))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> QRTZ_LOCKS (</span><br><span class="line">SCHED_NAME <span class="built_in">VARCHAR</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">LOCK_NAME <span class="built_in">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">PRIMARY <span class="keyword">KEY</span> (SCHED_NAME,LOCK_NAME))</span><br><span class="line"><span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_J_REQ_RECOVERY <span class="keyword">ON</span> QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_J_GRP <span class="keyword">ON</span> QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_J <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_JG <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_C <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_G <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_N_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_N_G_STATE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NEXT_FIRE_TIME <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_MISFIRE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_T_NFT_ST_MISFIRE_GRP <span class="keyword">ON</span> QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_TRIG_INST_NAME <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_INST_JOB_REQ_RCVRY <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_J_G <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_JG <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_T_G <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> IDX_QRTZ_FT_TG <span class="keyword">ON</span> QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure>
<h4 id="注意问题"><a href="#注意问题" class="headerlink" title="注意问题"></a>注意问题</h4><h5 id="1-时间同步问题"><a href="#1-时间同步问题" class="headerlink" title="1. 时间同步问题"></a><strong>1. 时间同步问题</strong></h5><p>Quartz并不关心是在相同机器、还是不同的机器运行节点。<br>|水平集群|垂直集群|<br>|–|–|<br>|集群放置在不同的机器上|节点跑在同一台机器上|<br>|存在时间同步问题|存在单点故障的问题，无法真正高可用，一旦机器崩溃，全部终止|</p>
<p>节点用时间戳来通知其他实例它自己的最后检入时间。假如节点的时钟被设置为将来的时间，那么运行中的Scheduler将再也意识不到那个结点已经宕掉了。</p>
<p>另一方面，如果某个节点的时钟被设置为过去的时间，也许另一节点就会认定那个节点已宕掉并试图接过它的Job重运行。</p>
<p>需要同步计算机时钟：比如两者都是使用某一个Internet时间服务器(Internet Time Server ITS)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y ntpdate</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同步时间</span></span><br><span class="line">ntpdate time.nist.gov</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看同步后时间</span></span><br><span class="line">date</span><br></pre></td></tr></table></figure>
<h5 id="2-节点争抢Job问题"><a href="#2-节点争抢Job问题" class="headerlink" title="2. 节点争抢Job问题"></a><strong>2. 节点争抢Job问题</strong></h5><blockquote>
<p>Quartz官网，当前还不存在一个方法来指派(钉住) 一个 Job 只能由集群中的某个特定节点执行。</p>
<p>Quartz使用一个<strong>随机</strong>的负载均衡算法，Job以<strong>随机的方式由不同的实例执行</strong>。</p>
</blockquote>
<h3 id="quartz-properties"><a href="#quartz-properties" class="headerlink" title="quartz.properties"></a>quartz.properties</h3><p>Quartz支持配置文件，好处是比编写代码简单，且修改后不需要重新编译源码</p>
<ol>
<li>文件定义了Quartz应用<strong>运行时</strong>行为，还包含了许多能控制Quartz运转的属性</li>
<li>文件应放在工程的classpath中</li>
<li>主要包括scheduler、threadPool、jobStore、plugin等</li>
<li>所有属性使用固定前缀org.quartz</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Default Properties file for use by StdSchedulerFactory</span><br><span class="line"># to create a Quartz Scheduler Instance, if a different</span><br><span class="line"># properties file is not explicitly specified.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#============================================================================</span><br><span class="line"># Configure Main Scheduler Properties</span><br><span class="line">#============================================================================</span><br><span class="line"></span><br><span class="line"># 实例名，集群中所有节点的instanceName必须相同。【集群中每个实例配置文件quartz.properties必须相同】</span><br><span class="line">org.quartz.scheduler.instanceName: QuartzScheduler</span><br><span class="line"></span><br><span class="line"># 实例ID，每个节点实例的instanceId必须唯一，可借助AUTO自动生成（主机名称+时间戳）</span><br><span class="line">org.quartz.scheduler.instanceId = AUTO</span><br><span class="line"></span><br><span class="line">org.quartz.scheduler.rmi.export: false</span><br><span class="line">org.quartz.scheduler.rmi.proxy: false</span><br><span class="line">org.quartz.scheduler.wrapJobExecutionInUserTransaction: false</span><br><span class="line">#============================================================================</span><br><span class="line"># Configure ThreadPool</span><br><span class="line">#============================================================================</span><br><span class="line">org.quartz.threadPool.class: org.quartz.simpl.SimpleThreadPool</span><br><span class="line"># 并发线程个数</span><br><span class="line">org.quartz.threadPool.threadCount: 10</span><br><span class="line"># 优先级</span><br><span class="line">org.quartz.threadPool.threadPriority: 5</span><br><span class="line">org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread: true</span><br><span class="line"></span><br><span class="line">org.quartz.jobStore.misfireThreshold: 1000</span><br><span class="line">#============================================================================</span><br><span class="line"># Configure JobStore</span><br><span class="line">#============================================================================</span><br><span class="line"> </span><br><span class="line"># 默认存储到内存</span><br><span class="line">#org.quartz.jobStore.class: org.quartz.simpl.RAMJobStore</span><br><span class="line"># 集群需要持久化存储，使用JobStoreTX事务类型</span><br><span class="line">org.quartz.jobStore.class:org.quartz.impl.jdbcjobstore.JobStoreTX</span><br><span class="line"># 数据库委托信息</span><br><span class="line">org.quartz.jobStore.driverDelegateClass:org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span><br><span class="line">org.quartz.jobStore.useProperties:true</span><br><span class="line"></span><br><span class="line">#============================================================================</span><br><span class="line">#havent cluster spring</span><br><span class="line">#============================================================================</span><br><span class="line"># 集群部署（分布式）</span><br><span class="line">org.quartz.jobStore.isClustered = true </span><br><span class="line"></span><br><span class="line"># 检入间隔时长</span><br><span class="line">org.quartz.jobStore.clusterCheckinInterval = 20000 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">org.quartz.jobStore.tablePrefix:QRTZ_</span><br><span class="line">#org.quartz.jobStore.dataSource:qzDS</span><br><span class="line"></span><br><span class="line">#============================================================================</span><br><span class="line"># Configure Datasources</span><br><span class="line">#============================================================================</span><br><span class="line">#JDBC</span><br><span class="line">#org.quartz.dataSource.qzDS.driver:com.mysql.jdbc.Driver</span><br><span class="line">#org.quartz.dataSource.qzDS.URL:jdbc:mysql://localhost:3306/quartz_test2</span><br><span class="line">#org.quartz.dataSource.qzDS.user:root</span><br><span class="line">#org.quartz.dataSource.qzDS.password:</span><br><span class="line">#org.quartz.dataSource.qzDS.maxConnection:10</span><br></pre></td></tr></table></figure>
<h3 id="各框架使用"><a href="#各框架使用" class="headerlink" title="各框架使用"></a>各框架使用</h3><h4 id="QuartzJobBean"><a href="#QuartzJobBean" class="headerlink" title="QuartzJobBean"></a>QuartzJobBean</h4><p>无论SpringMvc还是SpringBoot都可以使用spring帮我们封装的Job抽象<code>QuartzJobBean</code>。</p>
<p>QuartzJobBean是对Job的实现类，增加了executeInternal抽象方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.scheduling.quartz;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Job;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SchedulerException;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzJobBean</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">			<span class="comment">//具体请参加源代码</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新增了一个抽象方法</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QuartzJobBean依赖的jar包——</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 在SpringMVC 中可以额外借助 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 在SpringBoot 中连同quartz一起 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h4><h5 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">quartz.version</span>&gt;</span>2.2.1<span class="tag">&lt;/<span class="name">quartz.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;quartz.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz-jobs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;quartz.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 基于spring架构，提供QuartzJobBean抽象类 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="xml配置"><a href="#xml配置" class="headerlink" title="xml配置"></a>xml配置</h5><blockquote>
<p>resources/  microservice-quartz.xml</p>
</blockquote>
<p>Job</p>
<ul>
<li>JobDetailFactoryBean</li>
<li>MethodInvokingJobDetailFactoryBean</li>
</ul>
<p>Trigger</p>
<ul>
<li>CronTriggerFactoryBean</li>
<li>SimpleTriggerFactoryBean</li>
</ul>
<p>Scheduler</p>
<ul>
<li>SchedulerFactoryBean</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 1. 创建调度器。加入调度工厂SchedulerFactoryBean,引入所有调度触发器 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">        <span class="attr">name</span>=<span class="string">"quartzScheduler"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</span></span><br><span class="line">                      </span><br><span class="line">		<span class="comment">&lt;!-- 1.1 装载所有触发器 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"triggers"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"autoCompleteTrigger"</span>/&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"updateCompleteTimeTrigger"</span>/&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"overTimeRemindTrigger"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                      </span><br><span class="line">    <span class="comment">&lt;!--可选，QuartzScheduler 启动时更新己存在的Job，这样就不用每次修改targetObject后删除qrtz_job_details表对应记录了 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"overwriteExistingJobs"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span>                 </span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"applicationContextSchedulerContextKey"</span> <span class="attr">value</span>=<span class="string">"applicationContext"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:quartz.properties"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">&lt;!-- 定时任务开关 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoStartup"</span> <span class="attr">value</span>=<span class="string">"$&#123;scheduleJob.autoStartup:false&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">&lt;!-- 2. 创建CronTrigger触发器1，每3分钟执行一次--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"autoCompleteTrigger"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2.1 关联具体任务Job --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"autoCompleteJobDetail"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 2.2 Cron表达式 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span> <span class="attr">value</span>=<span class="string">"0 */3 * * * ?"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"startDelay"</span> <span class="attr">value</span>=<span class="string">"500"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"misfireInstruction"</span> <span class="attr">value</span>=<span class="string">"2"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- 3. 创建任务JobDetail--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"autoCompleteJobDetail"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailFactoryBean"</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 3.1 绑定具体的Job实现类 --&gt;</span>          </span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">value</span>&gt;</span>com.my.services.quartz.AutoCompleteTask<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">     </span><br><span class="line"><span class="comment">&lt;!-- 3.1 或者手动指定目标类和方法，手动指定的可以是与Job无关的普通类/方法  </span></span><br><span class="line"><span class="comment">     &lt;!-- 目标对象 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetObject"</span> <span class="attr">ref</span>=<span class="string">"cleanController"</span>/&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- 目标方法 --&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetMethod"</span> <span class="attr">value</span>=<span class="string">"cleanFile"</span>/&gt;</span>      </span><br><span class="line">--&gt;</span><br><span class="line">                      </span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"durability"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"requestsRecovery"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 2. 创建SimpleTrigger触发器 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;bean class="org.springframework.scheduling.quartz.SimpleTriggerFactoryBean" id="simpleTrigger"&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引用任务 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name="jobDetail" ref="jobDetail"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 指定循环时间，以秒为单位 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;property name="repeatInterval" value="10000"/&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/bean&gt;--&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="xml文件引入"><a href="#xml文件引入" class="headerlink" title="xml文件引入"></a>xml文件引入</h5><p>resources/  microservice-quartz.xml</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在主应用程序入口，引入配置xml文件</span></span><br><span class="line"><span class="meta">@ImportResource</span>(locations = &#123; <span class="string">"classpath*:/spring-configuration/spring-context*.xml"</span>,</span><br><span class="line">        <span class="string">"classpath*:/microservice-configuration/microservice-*.xml"</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApnApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ApnApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="执行类和方法"><a href="#执行类和方法" class="headerlink" title="执行类和方法"></a>执行类和方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.quartz.DisallowConcurrentExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.quartz.PersistJobDataAfterExecution;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SchedulerException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@PersistJobDataAfterExecution</span></span><br><span class="line"><span class="meta">@DisallowConcurrentExecution</span> <span class="comment">// 不允许并发执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有定时任务都需要继承QuartzJobBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoCompleteTask</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定时执行的方法。所有定时任务都需要实现Quartz提供的JobExecutionException接口。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(<span class="keyword">final</span> JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> IAutoCompleteTaskService autoCompleteTaskService = getApplicationContext(jobExecutionContext)</span><br><span class="line">                .getBean(<span class="string">"autoCompleteTaskService"</span>, IAutoCompleteTaskService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        autoCompleteTaskService.autoCompleteTask();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">(<span class="keyword">final</span> JobExecutionContext jobexecutioncontext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (ApplicationContext) jobexecutioncontext.getScheduler().getContext().get(<span class="string">"applicationContext"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="springmvc调用-service方法"><a href="#springmvc调用-service方法" class="headerlink" title="springmvc调用@service方法"></a>springmvc调用@service方法</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// quartz bean中配置属性</span></span><br><span class="line">&lt;!-- 将spring上下文以key/value存放在quartz上下文中，可以用applicationContextSchedulerContextKey定义的key得到对应的ring上下文 --&gt;                  </span><br><span class="line"></span><br><span class="line">  &lt;property name=<span class="string">"applicationContextSchedulerContextKey"</span> value=<span class="string">"applicationContext"</span> /&gt;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 通过getApplicationContext方法传入quartz的context即可获取ApplicationContext上下文，进而获取对应的bean</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">(<span class="keyword">final</span> JobExecutionContext jobexecutioncontext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (ApplicationContext) jobexecutioncontext.getScheduler().getContext().get(<span class="string">"applicationContext"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SchedulerException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在QuartzJobBean实现类中使用service</span></span><br><span class="line"><span class="keyword">final</span> MyService myService = getApplicationContext(jobExecutionContext)</span><br><span class="line">                .getBean(<span class="string">"myService"</span>, MyService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">myService.getList();</span><br></pre></td></tr></table></figure>
<h4 id="Spring-boot"><a href="#Spring-boot" class="headerlink" title="Spring boot"></a>Spring boot</h4><h5 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h5><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring boot集成quartz--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-quartz --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h5><p><strong>StoreDurably</strong>：</p>
<p>默认情况下，当 Job 没有对应的 Trigger 时，Job 不能直接被加入调度器，或者在 Trigger 过期之后， 没有关联 Trigger 的 Job 也会被删除。可以<strong>通过 JobBuilder 的 StoreDurably 使 Job 独立存储于调度器中</strong>。</p>
<p>添加job不带触发器必须写storeDurably()否则报如下异常，durable指明任务就算没有绑定Trigger仍保留在Quartz的JobStore中。</p>
<p>storeDurably的xml写法。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"durability"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">		<span class="comment">//具体任务：JobDetail实例绑定job</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">uploadTaskDetail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder</span><br><span class="line">        .newJob(MyJob<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">        .withIdentity("MyJobDetail")</span><br><span class="line">        .storeDurably()</span><br><span class="line">        .build();</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//触发器配置：CronTrigger，并绑定JobDetail</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">uploadTaskTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(<span class="string">"*/5 * * * * ?"</span>);</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(uploadTaskDetail())</span><br><span class="line">                .withIdentity(<span class="string">"MyTrigger"</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="执行类和方法-1"><a href="#执行类和方法-1" class="headerlink" title="执行类和方法"></a>执行类和方法</h5><p>使用spring抽象类QuartzJobBean</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        <span class="comment">//TODO 这里写定时任务的执行逻辑</span></span><br><span class="line">        System.out.println(<span class="string">"简单的定时任务执行时间："</span>+<span class="keyword">new</span> Date().toLocaleString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="spring-boot调用-service方法"><a href="#spring-boot调用-service方法" class="headerlink" title="spring boot调用@service方法"></a>spring boot调用@service方法</h5><p>问题描述：定时任务QuartzJobBean实现类中，@Autowired 注入service 报错<code>NullPointerException</code>，即spring boot spring mvc 在QuartzJobBean实现类中，不能直接 注入service</p>
<p> 原因：由于定时任务Quartz的job是在quartz中实例化出来的，优先级高于Spring的自动注入，创建的Service将由Quartz管理，而不是Spring，所以无法注入。不受spring的管理。所以就导致注入不进去了</p>
<p> 办法：</p>
<ol>
<li>在方法中获取bean的方式。不通过spring的@Autowired 注入service，而是直接获取spring上下文中的service类。 【参见springMvc的解决方式】</li>
<li>利用@Autowired 注入service，需要做一些配置。</li>
<li>其他方法注入service。</li>
</ol>
<h6 id="方法1：获取bean的方式"><a href="#方法1：获取bean的方式" class="headerlink" title="方法1：获取bean的方式"></a>方法1：获取bean的方式</h6><p>首先，定义一个ApplicationContextAware的组件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        ApplicationContextUtil.applicationContext = applicationContext;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext.getBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而后，在servcie的实现类注解添加名字，以便bean的获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"UserService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    		<span class="comment">// 业务逻辑</span></span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，使用bean的方式拿到service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoPrint</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 直接使用bean的方式拿到service</span></span><br><span class="line">        UserService userService = (UserService) ApplicationContextUtil.getBean(<span class="string">"UserService"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> no = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</span><br><span class="line">        List&lt;String&gt; list = userService.getUserList();</span><br><span class="line">        System.out.println(<span class="string">"===============no:"</span> + no);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="方法2：-Autowired-注入service"><a href="#方法2：-Autowired-注入service" class="headerlink" title="方法2：@Autowired 注入service"></a>方法2：@Autowired 注入service</h6><p>首先，定义一个AdaptableJobFactory的组件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.spi.TriggerFiredBundle;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.AdaptableJobFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"MyAdaptableJobFactory"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdaptableJobFactory</span> <span class="keyword">extends</span> <span class="title">AdaptableJobFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AutowireCapableBeanFactory capableBeanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createJobInstance</span><span class="params">(TriggerFiredBundle bundle)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 调用父类的方法</span></span><br><span class="line">        Object jobInstance = <span class="keyword">super</span>.createJobInstance(bundle);</span><br><span class="line">        <span class="comment">// 进行注入</span></span><br><span class="line">        capableBeanFactory.autowireBean(jobInstance);</span><br><span class="line">        <span class="keyword">return</span> jobInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而后，在Quartz的配置文件中将job实例化，能够操作进行Spring 注入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Scheduler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 引入组件</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAdaptableJobFactory myAdaptableJobFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBean <span class="title">schedulerFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SchedulerFactoryBean schedulerFactoryBean = <span class="keyword">new</span> SchedulerFactoryBean();</span><br><span class="line">        </span><br><span class="line">        schedulerFactoryBean.setOverwriteExistingJobs(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        schedulerFactoryBean.setStartupDelay(<span class="number">10</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 防止Spring依赖注入为null,将job实例化，能够操作进行Spring 注入</span></span><br><span class="line">        schedulerFactoryBean.setJobFactory(myAdaptableJobFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 创建schedule **/</span></span><br><span class="line">    <span class="comment">/**  方便其他位置调用，如 private Scheduler scheduler = (Scheduler)ApplicationContextUtil.getBean("scheduler"); */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"scheduler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean().getScheduler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.quartz.SchedulerException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoPrint</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可以直接注入service并使用</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> no = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</span><br><span class="line">        List&lt;String&gt; list = userService.getUserList();</span><br><span class="line">        System.out.println(<span class="string">"===============no:"</span> + no);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="动态案例"><a href="#动态案例" class="headerlink" title="动态案例"></a>动态案例</h5><h6 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现项目启动后自运行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobSchedule</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"任务调度开始==============任务调度开始"</span>);</span><br><span class="line">        QuartzBean quartzBean = <span class="keyword">new</span> QuartzBean();</span><br><span class="line">        quartzBean.setJobId(<span class="string">"autoPrintJob"</span>);</span><br><span class="line">        quartzBean.setJobClassName(<span class="string">"com.example.demoinit.quartz.dynamic.AutoPrint"</span>);</span><br><span class="line">        quartzBean.setCronExpression(<span class="string">"*/4 * * * * ? *"</span>);</span><br><span class="line">        QuartzUtils.createScheduler(quartzBean);</span><br><span class="line"></span><br><span class="line">        QuartzUtils.pauseJob (<span class="string">"autoPrintJob"</span>);</span><br><span class="line">        QuartzUtils.resumeScheduleJob (<span class="string">"autoPrintJob"</span>);</span><br><span class="line">        QuartzUtils.runOnce (<span class="string">"autoPrintJob"</span>);</span><br><span class="line"></span><br><span class="line">        quartzBean.setCronExpression(<span class="string">"*/2 * * * * ? *"</span>);</span><br><span class="line">        QuartzUtils.updateScheduleJob (quartzBean);</span><br><span class="line">        QuartzUtils.deleteScheduleJob (<span class="string">"autoPrintJob"</span>);</span><br><span class="line">        System.out.println(<span class="string">"任务调度结束==============任务调度结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="增删改操作"><a href="#增删改操作" class="headerlink" title="增删改操作"></a>增删改操作</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Scheduler scheduler = (Scheduler)ApplicationContextUtil.getBean(<span class="string">"scheduler"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createScheduler</span><span class="params">(QuartzBean quartzBean)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// JobDetail</span></span><br><span class="line">            Class&lt;? extends QuartzJobBean&gt; jobClass = (Class&lt;? extends QuartzJobBean&gt;) Class.forName(quartzBean.getJobClassName());</span><br><span class="line">            JobDetail jobDetail = JobBuilder.newJob(jobClass).withIdentity(quartzBean.getJobId()).build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Trigger</span></span><br><span class="line">            CronScheduleBuilder cronScheduleBuilder = CronScheduleBuilder.cronSchedule(quartzBean.getCronExpression());</span><br><span class="line">            CronTrigger trigger = TriggerBuilder.newTrigger().withIdentity(quartzBean.getJobId()).withSchedule(</span><br><span class="line">                    cronScheduleBuilder</span><br><span class="line">            ).build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 装载</span></span><br><span class="line">            scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line"><span class="comment">//            scheduler.start(); // 此处不需要进行start了，springboot默认会启动调度</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据jobId暂停定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pauseJob</span><span class="params">(String jobId)</span></span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(jobId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.pauseJob(jobKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"暂停定时任务出错："</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务名称恢复定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId    定时任务名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SchedulerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">resumeScheduleJob</span><span class="params">(String jobId)</span> </span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(jobId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.resumeJob(jobKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"启动定时任务出错："</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务名称立即运行一次定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId       定时任务名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SchedulerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runOnce</span><span class="params">(String jobId)</span></span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(jobId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.triggerJob(jobKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"运行定时任务出错："</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> quartzBean  定时任务信息类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SchedulerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateScheduleJob</span><span class="params">(QuartzBean quartzBean)</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取到对应任务的触发器</span></span><br><span class="line">            TriggerKey triggerKey = TriggerKey.triggerKey(quartzBean.getJobId());</span><br><span class="line">            <span class="comment">//设置定时任务执行方式</span></span><br><span class="line">            CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(quartzBean.getCronExpression());</span><br><span class="line">            <span class="comment">//重新构建任务的触发器trigger</span></span><br><span class="line">            CronTrigger trigger = (CronTrigger) scheduler.getTrigger(triggerKey);</span><br><span class="line">            trigger = trigger.getTriggerBuilder().withIdentity(triggerKey).withSchedule(scheduleBuilder).build();</span><br><span class="line">            <span class="comment">//重置对应的job</span></span><br><span class="line">            scheduler.rescheduleJob(triggerKey, trigger);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"更新定时任务出错："</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据定时任务名称从调度器当中删除定时任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId   定时任务名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SchedulerException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteScheduleJob</span><span class="params">(String jobId)</span> </span>&#123;</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(jobId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scheduler.deleteJob(jobKey);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SchedulerException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"删除定时任务出错："</span>+e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String jobId;</span><br><span class="line">    <span class="keyword">private</span> String jobClassName;</span><br><span class="line">    <span class="keyword">private</span> String cronExpression;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJobId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJobId</span><span class="params">(String jobId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jobId = jobId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJobClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJobClassName</span><span class="params">(String jobClassName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jobClassName = jobClassName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCronExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCronExpression</span><span class="params">(String cronExpression)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cronExpression = cronExpression;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数Job实现类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionContext;</span><br><span class="line"><span class="keyword">import</span> org.quartz.JobExecutionException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.QuartzJobBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoPrint</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> no = <span class="keyword">new</span> Random().nextInt(<span class="number">100</span>);</span><br><span class="line">        List&lt;String&gt; list = userService.getUserList();</span><br><span class="line">        System.out.println(<span class="string">"===============no:"</span> + no);</span><br><span class="line">        System.out.println(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参数job调用的service层</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getUserList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span>, <span class="string">"d"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Scheduler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.SchedulerFactoryBean;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyAdaptableJobFactory myAdaptableJobFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBean <span class="title">schedulerFactoryBean</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SchedulerFactoryBean schedulerFactoryBean = <span class="keyword">new</span> SchedulerFactoryBean();</span><br><span class="line">        <span class="comment">//覆盖已存在的任务</span></span><br><span class="line">        schedulerFactoryBean.setOverwriteExistingJobs(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//延时10秒启动定时任务，避免系统未完全启动却开始执行定时任务的情况</span></span><br><span class="line">        schedulerFactoryBean.setStartupDelay(<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 防止Spring依赖注入为null</span></span><br><span class="line">        schedulerFactoryBean.setJobFactory(myAdaptableJobFactory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 创建schedule **/</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"scheduler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Scheduler <span class="title">scheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean().getScheduler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>防止Spring依赖注入为null<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.spi.TriggerFiredBundle;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.AutowireCapableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.quartz.AdaptableJobFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"MyAdaptableJobFactory"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAdaptableJobFactory</span> <span class="keyword">extends</span> <span class="title">AdaptableJobFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AutowireCapableBeanFactory capableBeanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">createJobInstance</span><span class="params">(TriggerFiredBundle bundle)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 调用父类的方法</span></span><br><span class="line">        Object jobInstance = <span class="keyword">super</span>.createJobInstance(bundle);</span><br><span class="line">        <span class="comment">// 进行注入</span></span><br><span class="line">        capableBeanFactory.autowireBean(jobInstance);</span><br><span class="line">        <span class="keyword">return</span> jobInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h4><p>没有任何框架。</p>
<h5 id="依赖-2"><a href="#依赖-2" class="headerlink" title="依赖"></a>依赖</h5><p>.quartz依赖</p>
<p>.quartz-jobs</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.quartz-scheduler/quartz --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.quartz-scheduler/quartz-jobs --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.quartz-scheduler<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quartz-jobs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>使用quartz接口Job</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// job实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException 		</span>&#123;</span><br><span class="line">    		<span class="comment">// 获取参数</span></span><br><span class="line">        JobDataMap jobDataMap = jobExecutionContext.getJobDetail().getJobDataMap();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 业务逻辑 ...</span></span><br><span class="line">        log.info(jobDataMap.get(<span class="string">"name"</span>).toString()+<span class="string">"，"</span>+jobExecutionContext.getTrigger());</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"==================开始执行任务=================="</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="配置调度和触发器"><a href="#配置调度和触发器" class="headerlink" title="配置调度和触发器"></a>配置调度和触发器</h5><h6 id="1-可以写到main方法中执行。"><a href="#1-可以写到main方法中执行。" class="headerlink" title="1. 可以写到main方法中执行。"></a>1. 可以写到main方法中执行。</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> SchedulerException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// 创建调度器实例</span></span><br><span class="line">        SchedulerFactory schedulerFactory = <span class="keyword">new</span> StdSchedulerFactory();</span><br><span class="line">        Scheduler scheduler = schedulerFactory.getScheduler();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建JobDetail实例,并与MyJob这个Job实现类绑定</span></span><br><span class="line">        JobDetail job = JobBuilder.newJob(MyJob.class).withIdentity("job1", "group1").build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SimpleTrigger，从当前时间的下 1 秒开始，每隔 1 秒执行 1 次，重复执行 2 次</span></span><br><span class="line"><span class="comment">/*        Trigger trigger = TriggerBuilder.newTrigger()</span></span><br><span class="line"><span class="comment">                .withIdentity("trigger1", "group1")</span></span><br><span class="line"><span class="comment">                // .startNow() 默认立即执行</span></span><br><span class="line"><span class="comment">                .startAt(DateBuilder.evenSecondDate(new Date())) // 从当前时间的下 1 秒开始执行</span></span><br><span class="line"><span class="comment">                .withSchedule(</span></span><br><span class="line"><span class="comment">                        SimpleScheduleBuilder.simpleSchedule()</span></span><br><span class="line"><span class="comment">                                .withIntervalInSeconds(1) // 每隔 1 秒执行 1 次</span></span><br><span class="line"><span class="comment">                                .repeatForever() // 一直执行</span></span><br><span class="line"><span class="comment">                                .withRepeatCount(2) // 重复执行 2 次，一共执行 3 次</span></span><br><span class="line"><span class="comment">                )</span></span><br><span class="line"><span class="comment">                .build();*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// corn 表达式，先立即执行 1 次，然后每隔 5 秒执行 1 次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        HolidayCalendar cal = new HolidayCalendar();</span></span><br><span class="line"><span class="comment">//        cal.addExcludedDate( someDate );</span></span><br><span class="line"><span class="comment">//        cal.addExcludedDate( someOtherDate );</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        sched.addCalendar("myHolidays", cal, false);</span></span><br><span class="line"></span><br><span class="line">        Trigger trigger = TriggerBuilder.newTrigger()</span><br><span class="line">                .withIdentity(<span class="string">"trigger1"</span>, <span class="string">"group1"</span>)</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">"*/5 * * * * ?"</span>))</span><br><span class="line"><span class="comment">//                .modifiedByCalendar("myHolidays") // but not on holidays</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化参数传递到 job</span></span><br><span class="line">        job.getJobDataMap().put(<span class="string">"myDescription"</span>, <span class="string">"Hello Quartz"</span>);</span><br><span class="line">        job.getJobDataMap().put(<span class="string">"myValue"</span>, <span class="number">1990</span>);</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(<span class="string">"firstItem"</span>);</span><br><span class="line">        job.getJobDataMap().put(<span class="string">"myArray"</span>, list);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把作业和触发器注册到任务调度中</span></span><br><span class="line">        scheduler.scheduleJob(job, trigger);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行计划程序</span></span><br><span class="line">        scheduler.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待 10 秒，使我们的 job 有机会执行</span></span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待作业执行完成时才关闭调度器</span></span><br><span class="line">        scheduler.shutdown(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------Job监听器(Trigger监听器同理)-------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册对特定作业的监听器</span></span><br><span class="line"><span class="comment">//        scheduler.getListenerManager().addJobListener(new MyJobListener(), KeyMatcher.keyEquals(new JobKey("job1", "group1")));</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">//        注册对一个特定组的所有作业的 JobListener</span></span><br><span class="line"><span class="comment">        scheduler.getListenerManager().addJobListener(new MyJobListener(), GroupMatcher.jobGroupEquals("group1"));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">//        注册对两个特定组的所有作业的 JobListener</span></span><br><span class="line"><span class="comment">        scheduler.getListenerManager().addJobListener(new MyJobListener(), OrMatcher.or(GroupMatcher.jobGroupEquals("group1"), GroupMatcher.jobGroupEquals("group2")));</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">//        注册对所有作业的 JobListener：</span></span><br><span class="line"><span class="comment">        scheduler.getListenerManager().addJobListener(new MyJobListener(), EverythingMatcher.allJobs());</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//-------------------调度器监听器(Trigger监听器同理)-------------------</span></span><br><span class="line"><span class="comment">//        注册对添加调度器时的 SchedulerListener：</span></span><br><span class="line"><span class="comment">//        scheduler.getListenerManager().addSchedulerListener(mySchedListener);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        注册对删除调度器时的 SchedulerListener：</span></span><br><span class="line"><span class="comment">//        scheduler.getListenerManager().removeSchedulerListener(mySchedListener);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="2-也可以写implements-CommandLineRunner的方法中，会项目启动后就自动运行"><a href="#2-也可以写implements-CommandLineRunner的方法中，会项目启动后就自动运行" class="headerlink" title="2. 也可以写implements CommandLineRunner的方法中，会项目启动后就自动运行"></a>2. 也可以写implements CommandLineRunner的方法中，会项目启动后就自动运行</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demoinit.quartz.dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.quartz.Scheduler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现项目启动后自运行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobSchedule</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"任务调度开始==============任务调度开始"</span>);</span><br><span class="line">				<span class="comment">// 调度逻辑</span></span><br><span class="line">        System.out.println(<span class="string">"任务调度结束==============任务调度结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>Quartz框架</p>
<p><a href="https://www.jianshu.com/p/2a5d3b6336ba" target="_blank" rel="noopener">https://www.jianshu.com/p/2a5d3b6336ba</a></p>
<p>Quartz集群实战与原理分析</p>
<p><a href="https://blog.51cto.com/simplelife/2314620" target="_blank" rel="noopener">https://blog.51cto.com/simplelife/2314620</a></p>
<p><a href="https://segmentfault.com/a/1190000009128277#item-1" target="_blank" rel="noopener">https://segmentfault.com/a/1190000009128277#item-1</a></p>
<p><a href="https://blog.csdn.net/noaman_wgs/article/details/80984873" target="_blank" rel="noopener">https://blog.csdn.net/noaman_wgs/article/details/80984873</a></p>
<p>Xml <a href="https://zhuanlan.zhihu.com/p/46245863" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/46245863</a></p>
<p>简单配置属性手册 <a href="https://www.jianshu.com/p/0bf5d791d3c9" target="_blank" rel="noopener">https://www.jianshu.com/p/0bf5d791d3c9</a></p>
<p>springboot 整合 quartz 实现定时任务的动态修改，启动，暂停等操作 <a href="https://hacpai.com/article/1548229459644" target="_blank" rel="noopener">https://hacpai.com/article/1548229459644</a></p>
<p>Springboot 2.x 整合 quartz 定时任务 实现动态添加、暂停、删除等功能 <a href="https://zzzmh.cn/single?id=83" target="_blank" rel="noopener">https://zzzmh.cn/single?id=83</a></p>
<p>springboot 博客 <a href="http://tigerdu.com/2018/01/16/springboot-quartz/" target="_blank" rel="noopener">http://tigerdu.com/2018/01/16/springboot-quartz/</a></p>
]]></content>
  </entry>
  <entry>
    <title>百度地图-测距</title>
    <url>/want/2019/07/18/%E7%99%BE%E5%BA%A6%E5%9C%B0%E5%9B%BE-%E6%B5%8B%E8%B7%9D/</url>
    <content><![CDATA[<h3 id="bug来源及解决"><a href="#bug来源及解决" class="headerlink" title="bug来源及解决"></a>bug来源及解决</h3><p>使用百度地图测距控件时，引入如下版本：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;https://api.map.baidu.com/library/DistanceTool/1.2/src/DistanceTool_min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>但存在如下问题：</p>
<ol>
<li>系统首次加载地图实例，测距控件使用正常。</li>
<li>关闭该地图，切换另一个地图，或者重新打开该地图，都无法使用测距控件。</li>
<li>已经保证每次打开的是一个完全崭新的地图实例（完全重新初始化）</li>
</ol>
<img src="/want/2019/07/18/百度地图-测距/example.png" title="切换示例">
<p>经过源代码调试，发现是该DistanceTool文件，将测距工具的配置属性OperationMask，设置成挂靠window而非map实例的全局变量。导致就算map实例被销毁，属性配置依然被保留。</p>
<p>而本bug产生真实原因如下：</p>
<ol>
<li>测距工具创建后，会根据当前map实例所在的dom，产生一个dom遮罩层_maskElement（z-index=1000）</li>
<li>测距工具利用遮罩层_maskElement监听地图取点事件（单击、双击等）</li>
<li>但window下的全局变量OperationMask的._maskElement属性，却保留旧有map实例产生的DOM值，导致新建map后，无法获取最新的DOM监听测控工具点击事件。</li>
<li>因此测距工具失效。</li>
</ol>
<p>解决方法：</p>
<ol>
<li><p>可OperationMask设置为挂靠map实例。</p>
</li>
<li><p>可OperationMask._maskElement及时清理（设置为null）。</p>
</li>
</ol>
<p><a href="http://lbsyun.baidu.com/jsdemo.htm#f0_6" target="_blank" rel="noopener">官网示例</a></p>
<p><a href="http://api.map.baidu.com/library/DistanceTool/1.2/docs/symbols/BMapLib.DistanceTool.html" target="_blank" rel="noopener"> BMapLib.DistanceTool</a></p>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><h4 id="引入DistanceTool"><a href="#引入DistanceTool" class="headerlink" title="引入DistanceTool"></a>引入DistanceTool</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化测距方法</span></span><br><span class="line"><span class="keyword">const</span> createDistanceTool = <span class="function">(<span class="params">map</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// const distanceTool = new BMapLib.DistanceTool(map);</span></span><br><span class="line">  <span class="keyword">const</span> distanceTool = <span class="keyword">new</span> DistanceTool(map);</span><br><span class="line">  distanceTool.setOperationMask(&#123;</span><br><span class="line">    _maskElement: <span class="literal">null</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> distanceTool;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用初始化测距方法</span></span><br><span class="line"><span class="keyword">const</span> distanceTool = createDistanceTool(map);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击测距按钮，则open</span></span><br><span class="line">onMapToolChange = <span class="function"><span class="params">toolActive</span> =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; distanceTool &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    distanceTool.open();</span><br><span class="line"></span><br><span class="line">    distanceTool.addEventListener(<span class="string">'drawend'</span>, () =&gt; &#123;</span><br><span class="line">       <span class="comment">// 双击结束路径绘制后，重新激活的测距按钮</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">toolActive</span>: <span class="string">''</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; toolActive &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="改造后的DistanceTool-js文件"><a href="#改造后的DistanceTool-js文件" class="headerlink" title="改造后的DistanceTool.js文件"></a>改造后的DistanceTool.js文件</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@fileoverview </span>百度地图的测距工具类，对外开放。</span></span><br><span class="line"><span class="comment"> * 允许用户在地图上点击完成距离的测量。</span></span><br><span class="line"><span class="comment"> * 使用者可以自定义测距线段的相关样式，例如线宽、颜色、测距结果所用的单位制等等。</span></span><br><span class="line"><span class="comment"> * 主入口类是&lt;a href="symbols/BMapLib.DistanceTool.html"&gt;DistanceTool&lt;/a&gt;，</span></span><br><span class="line"><span class="comment"> * 基于Baidu Map API 1.2。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author </span>Baidu Map Api Group</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version </span>1.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@namespace </span>BMap的所有library类均放在BMapLib命名空间下</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> BMap <span class="keyword">from</span> <span class="string">'BMap'</span>;</span><br><span class="line"><span class="keyword">import</span> BMapLib <span class="keyword">from</span> <span class="string">'BMapLib'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声明baidu包</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> baidu = baidu || &#123; <span class="attr">guid</span>: <span class="string">'$BAIDU$'</span> &#125;;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 一些页面级别唯一的属性，需要挂载在window[baidu.guid]上</span></span><br><span class="line">  <span class="built_in">window</span>[baidu.guid] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将源对象的所有属性拷贝到目标对象中</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.extend</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.extend(target, source)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>target 目标对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>source 源对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;Object&#125;</span> </span>目标对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.extend = <span class="function"><span class="keyword">function</span> (<span class="params">target, source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> p <span class="keyword">in</span> source) &#123;</span><br><span class="line">      <span class="keyword">if</span> (source.hasOwnProperty(p)) &#123;</span><br><span class="line">        target[p] = source[p];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@namespace</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@baidu</span>.lang 对语言层面的封装，包括类型判断、模块扩展、继承基类以及对象自定义事件的支持。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@property </span>guid 对象的唯一标识</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang = baidu.lang || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 返回一个当前页面的唯一标识字符串。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.guid()</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;String&#125;</span> </span>当前页面的唯一标识字符串</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.guid = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`TANGRAM__<span class="subst">$&#123;(<span class="built_in">window</span>[baidu.guid]._counter++).toString(<span class="number">36</span>)&#125;</span>`</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">window</span>[baidu.guid]._counter = <span class="built_in">window</span>[baidu.guid]._counter || <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 所有类的实例的容器</span></span><br><span class="line"><span class="comment">   * key为每个实例的guid</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">window</span>[baidu.guid]._instances = <span class="built_in">window</span>[baidu.guid]._instances || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Tangram继承机制提供的一个基类，用户可以通过继承baidu.lang.Class来获取它的属性及方法。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.lang.Class</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.Class(guid)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>guid	对象的唯一标识</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark </span>baidu.lang.Class和它的子类的实例均包含一个全局唯一的标识guid。</span></span><br><span class="line"><span class="comment">   * guid是在构造函数中生成的，因此，继承自baidu.lang.Class的类应该直接或者间接调用它的构造函数。&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * baidu.lang.Class的构造函数中产生guid的方式可以保证guid的唯一性，及每个实例都有一个全局唯一的guid。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class = <span class="function"><span class="keyword">function</span> (<span class="params">guid</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.guid = guid || baidu.lang.guid();</span><br><span class="line">    <span class="built_in">window</span>[baidu.guid]._instances[<span class="keyword">this</span>.guid] = <span class="keyword">this</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">window</span>[baidu.guid]._instances = <span class="built_in">window</span>[baidu.guid]._instances || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断目标参数是否string类型或String对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.lang.isString</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.isString(source)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Any&#125;</span> </span>source 目标参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">isString</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;boolean&#125;</span> </span>类型判断结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.isString = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(source) == <span class="string">'[object String]'</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断目标参数是否为function或Function实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.lang.isFunction</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.isFunction(source)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Any&#125;</span> </span>source 目标参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;boolean&#125;</span> </span>类型判断结果</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.isFunction = <span class="function"><span class="keyword">function</span> (<span class="params">source</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(source) == <span class="string">'[object Function]'</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 重载了默认的toString方法，使得返回信息更加准确一些。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>对象的String表示形式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class.prototype.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`[object <span class="subst">$&#123;<span class="keyword">this</span>._className || <span class="string">'Object'</span>&#125;</span>]`</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 释放对象所持有的资源，主要是自定义事件。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name <span class="variable">dispose</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>obj.dispose()</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class.prototype.dispose = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="built_in">window</span>[baidu.guid]._instances[<span class="keyword">this</span>.guid];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> property <span class="keyword">in</span> <span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!baidu.lang.isFunction(<span class="keyword">this</span>[property])) &#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>[property];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.disposed = <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义的事件对象。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.lang.Event</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.Event(type[, target])</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>type	 事件类型名称。为了方便区分事件和一个普通的方法，事件类型名称必须以"on"(小写)开头。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>[target]触发事件的对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark </span>引入该模块，会自动为Class引入3个事件扩展方法：addEventListener、removeEventListener和dispatchEvent。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see </span>baidu.lang.Class</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Event = <span class="function"><span class="keyword">function</span> (<span class="params">type, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.type = type;</span><br><span class="line">    <span class="keyword">this</span>.returnValue = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.target = target || <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.currentTarget = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 注册对象的事件监听器。引入baidu.lang.Event后，Class的子类实例才会获得该方法。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>obj.addEventListener(type, handler[, key])</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param 	<span class="type">&#123;string&#125;</span>   </span>type         自定义事件的名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param 	<span class="type">&#123;Function&#125;</span> </span>handler      自定义事件被触发时应该调用的回调函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param 	<span class="type">&#123;string&#125;</span>   </span>[key]		为事件监听函数指定的名称，可在移除时使用。如果不提供，方法会默认为它生成一个全局唯一的key。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark 	</span>事件类型区分大小写。如果自定义事件名称不是以小写"on"开头，该方法会给它加上"on"再进行判断，即"click"和"onclick"会被认为是同一种事件。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class.prototype.addEventListener = <span class="function"><span class="keyword">function</span> (<span class="params">type, handler, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!baidu.lang.isFunction(handler)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    !<span class="keyword">this</span>.__listeners &amp;&amp; (<span class="keyword">this</span>.__listeners = &#123;&#125;);</span><br><span class="line">    <span class="keyword">let</span> t = <span class="keyword">this</span>.__listeners,</span><br><span class="line">      id;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp; key) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/[^\w\-]/</span>.test(key)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (<span class="string">`nonstandard key:<span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        handler.hashCode = key;</span><br><span class="line">        id = key;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    type.indexOf(<span class="string">'on'</span>) != <span class="number">0</span> &amp;&amp; (type = <span class="string">`on<span class="subst">$&#123;type&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">typeof</span> t[type] !== <span class="string">'object'</span> &amp;&amp; (t[type] = &#123;&#125;);</span><br><span class="line">    id = id || baidu.lang.guid();</span><br><span class="line">    handler.hashCode = id;</span><br><span class="line">    t[type][id] = handler;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 移除对象的事件监听器。引入baidu.lang.Event后，Class的子类实例才会获得该方法。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>obj.removeEventListener(type, handler)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span>   </span>type     事件类型</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function|string&#125;</span> </span>handler  要移除的事件监听函数或者监听函数的key</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark 	</span>如果第二个参数handler没有被绑定到对应的自定义事件中，什么也不做。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class.prototype.removeEventListener = <span class="function"><span class="keyword">function</span> (<span class="params">type, handler</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (baidu.lang.isFunction(handler)) &#123;</span><br><span class="line">      handler = handler.hashCode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!baidu.lang.isString(handler)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    !<span class="keyword">this</span>.__listeners &amp;&amp; (<span class="keyword">this</span>.__listeners = &#123;&#125;);</span><br><span class="line">    type.indexOf(<span class="string">'on'</span>) != <span class="number">0</span> &amp;&amp; (type = <span class="string">`on<span class="subst">$&#123;type&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">const</span> t = <span class="keyword">this</span>.__listeners;</span><br><span class="line">    <span class="keyword">if</span> (!t[type]) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    t[type][handler] &amp;&amp; <span class="keyword">delete</span> t[type][handler];</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 派发自定义事件，使得绑定到自定义事件上面的函数都会被执行。引入baidu.lang.Event后，Class的子类实例才会获得该方法。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>obj.dispatchEvent(event, options)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;baidu.lang.Event|String&#125;</span> </span>event 	Event对象，或事件名称(1.1.1起支持)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>options 扩展参数,所含属性键值会扩展到Event对象上(1.2起支持)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark </span>处理会调用通过addEventListenr绑定的自定义事件回调函数之外，还会调用直接绑定到对象上面的自定义事件。</span></span><br><span class="line"><span class="comment">   * 例如：&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * myobj.onMyEvent = function()&#123;&#125;&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * myobj.addEventListener("onMyEvent", function()&#123;&#125;);</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.Class.prototype.dispatchEvent = <span class="function"><span class="keyword">function</span> (<span class="params">event, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (baidu.lang.isString(event)) &#123;</span><br><span class="line">      event = <span class="keyword">new</span> baidu.lang.Event(event);</span><br><span class="line">    &#125;</span><br><span class="line">    !<span class="keyword">this</span>.__listeners &amp;&amp; (<span class="keyword">this</span>.__listeners = &#123;&#125;);</span><br><span class="line">    options = options || &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> options) &#123;</span><br><span class="line">      event[i] = options[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> i,</span><br><span class="line">      t = <span class="keyword">this</span>.__listeners,</span><br><span class="line">      p = event.type;</span><br><span class="line">    event.target = event.target || <span class="keyword">this</span>;</span><br><span class="line">    event.currentTarget = <span class="keyword">this</span>;</span><br><span class="line">    p.indexOf(<span class="string">'on'</span>) != <span class="number">0</span> &amp;&amp; (p = <span class="string">`on<span class="subst">$&#123;p&#125;</span>`</span>);</span><br><span class="line">    baidu.lang.isFunction(<span class="keyword">this</span>[p]) &amp;&amp; <span class="keyword">this</span>[p].apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> t[p] === <span class="string">'object'</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i <span class="keyword">in</span> t[p]) &#123;</span><br><span class="line">        t[p][i].apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> event.returnValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为类型构造器建立继承关系</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.lang.inherits</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.lang.inherits(subClass, superClass[, className])</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>subClass 子类构造器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>superClass 父类构造器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>className 类名标识</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark </span>使subClass继承superClass的prototype，</span></span><br><span class="line"><span class="comment">   * 因此subClass的实例能够使用superClass的prototype中定义的所有属性和方法。&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * 这个函数实际上是建立了subClass和superClass的原型链集成，并对subClass进行了constructor修正。&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * &lt;strong&gt;注意：如果要继承构造函数，需要在subClass里面call一下，具体见下面的demo例子&lt;/strong&gt;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">inherits</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see </span>baidu.lang.Class</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.lang.inherits = <span class="function"><span class="keyword">function</span> (<span class="params">subClass, superClass, className</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> key,</span><br><span class="line">      proto,</span><br><span class="line">      selfProps = subClass.prototype,</span><br><span class="line">      clazz = <span class="keyword">new</span> <span class="built_in">Function</span>();</span><br><span class="line">    clazz.prototype = superClass.prototype;</span><br><span class="line">    proto = subClass.prototype = <span class="keyword">new</span> clazz();</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> selfProps) &#123;</span><br><span class="line">      proto[key] = selfProps[key];</span><br><span class="line">    &#125;</span><br><span class="line">    subClass.prototype.constructor = subClass;</span><br><span class="line">    subClass.superClass = superClass.prototype;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> className === <span class="string">'string'</span>) &#123;</span><br><span class="line">      proto._className = className;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@namespace </span>baidu.dom 操作dom的方法。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.dom = baidu.dom || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从文档中获取指定的DOM元素</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string|HTMLElement&#125;</span> </span>id 元素的id或DOM元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;HTMLElement&#125;</span> </span>DOM元素，如果不存在，返回null，如果参数不合法，直接返回参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu._g = baidu.dom._g = <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (baidu.lang.isString(id)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.getElementById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从文档中获取指定的DOM元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.dom.g</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.dom.g(id)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string|HTMLElement&#125;</span> </span>id 元素的id或DOM元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;HTMLElement|null&#125;</span> </span>获取的元素，查找不到时返回null,如果参数不合法，直接返回参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.g = baidu.dom.g = <span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> id === <span class="string">'string'</span> || id <span class="keyword">instanceof</span> <span class="built_in">String</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.getElementById(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id &amp;&amp; id.nodeName &amp;&amp; (id.nodeType == <span class="number">1</span> || id.nodeType == <span class="number">9</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在目标元素的指定位置插入HTML代码</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.dom.insertHTML</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.dom.insertHTML(element, position, html)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;HTMLElement|string&#125;</span> </span>element 目标元素或目标元素的id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>position 插入html的位置信息，取值为beforeBegin,afterBegin,beforeEnd,afterEnd</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>html 要插入的html</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark</span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 对于position参数，大小写不敏感&lt;br&gt;</span></span><br><span class="line"><span class="comment">   * 参数的意思：beforeBegin&lt;span&gt;afterBegin   this is span! beforeEnd&lt;/span&gt; afterEnd &lt;br /&gt;</span></span><br><span class="line"><span class="comment">   * 此外，如果使用本函数插入带有script标签的HTML字符串，script标签对应的脚本将不会被执行。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">insertHTML</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;HTMLElement&#125;</span> </span>目标元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.insertHTML = baidu.dom.insertHTML = <span class="function"><span class="keyword">function</span> (<span class="params">element, position, html</span>) </span>&#123;</span><br><span class="line">    element = baidu.dom.g(element);</span><br><span class="line">    <span class="keyword">let</span> range,</span><br><span class="line">      begin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.insertAdjacentHTML) &#123;</span><br><span class="line">      element.insertAdjacentHTML(position, html);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 这里不做"undefined" != typeof(HTMLElement) &amp;&amp; !window.opera判断，其它浏览器将出错？！</span></span><br><span class="line">      <span class="comment">// 但是其实做了判断，其它浏览器下等于这个函数就不能执行了</span></span><br><span class="line">      range = element.ownerDocument.createRange();</span><br><span class="line">      <span class="comment">// FF下range的位置设置错误可能导致创建出来的fragment在插入dom树之后html结构乱掉</span></span><br><span class="line">      <span class="comment">// 改用range.insertNode来插入html, by wenyuxiang @ 2010-12-14.</span></span><br><span class="line">      position = position.toUpperCase();</span><br><span class="line">      <span class="keyword">if</span> (position == <span class="string">'AFTERBEGIN'</span> || position == <span class="string">'BEFOREEND'</span>) &#123;</span><br><span class="line">        range.selectNodeContents(element);</span><br><span class="line">        range.collapse(position == <span class="string">'AFTERBEGIN'</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        begin = position == <span class="string">'BEFOREBEGIN'</span>;</span><br><span class="line">        range[begin ? <span class="string">'setStartBefore'</span> : <span class="string">'setEndAfter'</span>](element);</span><br><span class="line">        range.collapse(begin);</span><br><span class="line">      &#125;</span><br><span class="line">      range.insertNode(range.createContextualFragment(html));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为目标元素添加className</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.dom.addClass</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.dom.addClass(element, className)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;HTMLElement|string&#125;</span> </span>element 目标元素或目标元素的id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>className 要添加的className，允许同时添加多个class，中间使用空白符分隔</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark</span></span></span><br><span class="line"><span class="comment">   * 使用者应保证提供的className合法性，不应包含不合法字符，className合法字符参考：http://www.w3.org/TR/CSS2/syndata.html。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">addClass</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;HTMLElement&#125;</span> </span>目标元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.ac = baidu.dom.addClass = <span class="function"><span class="keyword">function</span> (<span class="params">element, className</span>) </span>&#123;</span><br><span class="line">    element = baidu.dom.g(element);</span><br><span class="line">    <span class="keyword">let</span> classArray = className.split(<span class="regexp">/\s+/</span>),</span><br><span class="line">      result = element.className,</span><br><span class="line">      classMatch = <span class="string">` <span class="subst">$&#123;result&#125;</span> `</span>,</span><br><span class="line">      i = <span class="number">0</span>,</span><br><span class="line">      l = classArray.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (classMatch.indexOf(<span class="string">` <span class="subst">$&#123;classArray[i]&#125;</span> `</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        result += (result ? <span class="string">' '</span> : <span class="string">''</span>) + classArray[i];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    element.className = result;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@namespace </span>baidu.event 屏蔽浏览器差异性的事件封装。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@property </span>target 	事件的触发元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@property </span>pageX 		鼠标事件的鼠标x坐标</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@property </span>pageY 		鼠标事件的鼠标y坐标</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@property </span>keyCode 	键盘事件的键值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.event = baidu.event || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 事件监听器的存储表</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.event._listeners = baidu.event._listeners || [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为目标元素添加事件监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.event.on</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.event.on(element, type, listener)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;HTMLElement|string|window&#125;</span> </span>element 目标元素或目标元素id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>type 事件类型</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>listener 需要添加的监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remark</span></span></span><br><span class="line"><span class="comment">   *  1. 不支持跨浏览器的鼠标滚轮事件监听器添加&lt;br&gt;</span></span><br><span class="line"><span class="comment">   *  2. 改方法不为监听器灌入事件对象，以防止跨iframe事件挂载的事件对象获取失败</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">on</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@see </span>baidu.event.un</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;HTMLElement|window&#125;</span> </span>目标元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.on = baidu.event.on = <span class="function"><span class="keyword">function</span> (<span class="params">element, type, listener</span>) </span>&#123;</span><br><span class="line">    type = type.replace(<span class="regexp">/^on/i</span>, <span class="string">''</span>);</span><br><span class="line">    element = baidu._g(element);</span><br><span class="line">    <span class="keyword">let</span> realListener = <span class="function"><span class="keyword">function</span> (<span class="params">ev</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 这里不支持EventArgument,  原因是跨frame的事件挂载</span></span><br><span class="line">        <span class="comment">// 2. element是为了修正this</span></span><br><span class="line">        listener.call(element, ev);</span><br><span class="line">      &#125;,</span><br><span class="line">      lis = baidu.event._listeners,</span><br><span class="line">      filter = baidu.event._eventFilter,</span><br><span class="line">      afterFilter,</span><br><span class="line">      realType = type;</span><br><span class="line">    type = type.toLowerCase();</span><br><span class="line">    <span class="comment">// filter过滤</span></span><br><span class="line">    <span class="keyword">if</span> (filter &amp;&amp; filter[type]) &#123;</span><br><span class="line">      afterFilter = filter[type](element, type, realListener);</span><br><span class="line">      realType = afterFilter.type;</span><br><span class="line">      realListener = afterFilter.listener;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 事件监听器挂载</span></span><br><span class="line">    <span class="keyword">if</span> (element.addEventListener) &#123;</span><br><span class="line">      element.addEventListener(realType, realListener, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.attachEvent) &#123;</span><br><span class="line">      element.attachEvent(<span class="string">`on<span class="subst">$&#123;realType&#125;</span>`</span>, realListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将监听器存储到数组中</span></span><br><span class="line">    lis[lis.length] = [element, type, listener, realListener, realType];</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为目标元素移除事件监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.event.un</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.event.un(element, type, listener)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;HTMLElement|string|window&#125;</span> </span>element 目标元素或目标元素id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>type 事件类型</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> </span>listener 需要移除的监听器</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@shortcut <span class="variable">un</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;HTMLElement|window&#125;</span> </span>目标元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.un = baidu.event.un = <span class="function"><span class="keyword">function</span> (<span class="params">element, type, listener</span>) </span>&#123;</span><br><span class="line">    element = baidu._g(element);</span><br><span class="line">    type = type.replace(<span class="regexp">/^on/i</span>, <span class="string">''</span>).toLowerCase();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> lis = baidu.event._listeners,</span><br><span class="line">      len = lis.length,</span><br><span class="line">      isRemoveAll = !listener,</span><br><span class="line">      item,</span><br><span class="line">      realType,</span><br><span class="line">      realListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果将listener的结构改成json</span></span><br><span class="line">    <span class="comment">// 可以节省掉这个循环，优化性能</span></span><br><span class="line">    <span class="comment">// 但是由于un的使用频率并不高，同时在listener不多的时候</span></span><br><span class="line">    <span class="comment">// 遍历数组的性能消耗不会对代码产生影响</span></span><br><span class="line">    <span class="comment">// 暂不考虑此优化</span></span><br><span class="line">    <span class="keyword">while</span> (len--) &#123;</span><br><span class="line">      item = lis[len];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// listener存在时，移除element的所有以listener监听的type类型事件</span></span><br><span class="line">      <span class="comment">// listener不存在时，移除element的所有type类型事件</span></span><br><span class="line">      <span class="keyword">if</span> (item[<span class="number">1</span>] === type</span><br><span class="line">        &amp;&amp; item[<span class="number">0</span>] === element</span><br><span class="line">        &amp;&amp; (isRemoveAll || item[<span class="number">2</span>] === listener)) &#123;</span><br><span class="line">        realType = item[<span class="number">4</span>];</span><br><span class="line">        realListener = item[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">if</span> (element.removeEventListener) &#123;</span><br><span class="line">          element.removeEventListener(realType, realListener, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.detachEvent) &#123;</span><br><span class="line">          element.detachEvent(<span class="string">`on<span class="subst">$&#123;realType&#125;</span>`</span>, realListener);</span><br><span class="line">        &#125;</span><br><span class="line">        lis.splice(len, <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 阻止事件的默认行为</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>baidu.event.preventDefault</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@function</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@grammar </span>baidu.event.preventDefault(event)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Event&#125;</span> </span>event 事件对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@meta <span class="variable">standard</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  baidu.preventDefault = baidu.event.preventDefault = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event.preventDefault) &#123;</span><br><span class="line">      event.preventDefault();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      event.returnValue = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@exports </span>DistanceTool as BMapLib.DistanceTool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> DistanceTool =</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DistanceTool类的构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@class </span>距离测算类，实现测距效果的&lt;b&gt;入口&lt;/b&gt;。</span></span><br><span class="line"><span class="comment">   * 实例化该类后，即可调用该类提供的open</span></span><br><span class="line"><span class="comment">   * 方法开启测距状态。</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Map&#125;</span> </span>map Baidu map的实例对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Json Object&#125;</span> </span>opts 可选的输入参数，非必填项。可输入选项包括：&lt;br /&gt;</span></span><br><span class="line"><span class="comment">   * &#123;"&lt;b&gt;followText&lt;/b&gt;" : &#123;String&#125; 测距过程中，提示框文字,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;unit&lt;/b&gt;" : &#123;String&#125; 测距结果所用的单位制，可接受的属性为"metric"表示米制和"us"表示美国传统单位,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;lineColor&lt;/b&gt;" : &#123;String&#125; 折线颜色,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;lineStroke&lt;/b&gt;" : &#123;Number&#125; 折线宽度,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;opacity&lt;/b&gt;" : &#123;Number&#125; 透明度,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;lineStyle&lt;/b&gt;" : &#123;String&#125; 折线的样式，只可设置solid和dashed,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;secIcon&lt;/b&gt;" : &#123;BMap.Icon&#125; 转折点的Icon,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;closeIcon&lt;/b&gt;" : &#123;BMap.Icon&#125; 关闭按钮的Icon,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;cursor&lt;/b&gt;" : &#123;String&#125; 跟随的鼠标样式&#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment">   * var map = new BMap.Map("container");&lt;br /&gt;map.centerAndZoom(new BMap.Point(116.404, 39.915), 15);&lt;br /&gt;var myDistanceToolObject = new BMapLib.DistanceTool(map, &#123;lineStroke : 2&#125;);</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  BMapLib.DistanceTool = <span class="function"><span class="keyword">function</span> (<span class="params">map, opts</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!map) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * map对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Map&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._map = map;</span><br><span class="line"></span><br><span class="line">    opts = opts || &#123;&#125;;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * _opts是默认参数赋值。</span></span><br><span class="line"><span class="comment">     * 下面通过用户输入的opts，对默认参数赋值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Json&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._opts = baidu.extend(</span><br><span class="line">      baidu.extend(<span class="keyword">this</span>._opts || &#123;&#125;, &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 测距提示</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tips: <span class="string">'测距'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 测距过程中，提示框文字</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        followText: <span class="string">'单击确定地点，双击结束'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 测距结果所用的单位制，可接受的属性为"metric"表示米制和"us"表示美国传统单位</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        unit: <span class="string">'metric'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折线颜色</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        lineColor: <span class="string">'#ff6319'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折线线宽</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;Number&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        lineStroke: <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折线透明度</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;Number&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        opacity: <span class="number">0.8</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 折线样式</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        lineStyle: <span class="string">'solid'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 跟随鼠标样式</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        cursor: <span class="string">'http://api.map.baidu.com/images/ruler.cur'</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 转折点的ICON样式</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;BMap.Icon&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        secIcon: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 转折点的ICON样式</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">         * <span class="doctag">@type <span class="type">&#123;BMap.Icon&#125;</span></span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        closeIcon: <span class="literal">null</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      , opts,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跟随的title覆盖物</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;BMap.Label&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._followTitle = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折线包含所有点的数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._points = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折线所包含的所有path数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._paths = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折线结点图片数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._dots = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折线测距包含所有线段的距离</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._segDistance = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 覆盖物的数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Array&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._overlays = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否在调用map.clearOverlays清除画线需要建立的相关overlay元素</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Boolean&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._enableMassClear = <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 单位制，存储语言包中定义的单位名称</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">       * <span class="doctag">@type <span class="type">&#123;Json&#125;</span></span></span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">this</span>._units = &#123;</span><br><span class="line">        <span class="comment">// metric 表示米制</span></span><br><span class="line">        metric: &#123;</span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 米制的名称</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          name: <span class="string">'metric'</span>,</span><br><span class="line"></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 和米制的换算关系</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@type <span class="type">&#123;Number&#125;</span></span></span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          conv: <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 米制单位下两个单位制之间的换算关系</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@type <span class="type">&#123;Number&#125;</span></span></span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          incon: <span class="number">1000</span>,</span><br><span class="line"></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 米制单位下较小单位</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          u1: <span class="string">'米'</span>,</span><br><span class="line"></span><br><span class="line">          <span class="comment">/**</span></span><br><span class="line"><span class="comment">           * 米制单位下较大单位</span></span><br><span class="line"><span class="comment">           * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          u2: <span class="string">'公里'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// us 表示美国传统单位，各参数意义同上metric</span></span><br><span class="line">        us: &#123;</span><br><span class="line">          name: <span class="string">'us'</span>,</span><br><span class="line">          conv: <span class="number">3.2808</span>,</span><br><span class="line">          incon: <span class="number">5279.856</span>,</span><br><span class="line">          u1: <span class="string">'英尺'</span>,</span><br><span class="line">          u2: <span class="string">'英里'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否已经开启了测距状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Boolean&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._isOpen = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未点击任何一点时，鼠标移动时的跟随提示文字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._startFollowText = <span class="string">'单击确定起点'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 地图移动的计时器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Object&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._movingTimerId = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测距需要添加的CSS样式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@type <span class="type">&#123;Json&#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>._styles = &#123;</span><br><span class="line">      BMapLib_diso: <span class="string">'height:17px;width:5px;position:absolute;background:url(http://api.map.baidu.com/images/dis_box_01.gif) no-repeat left top'</span>,</span><br><span class="line">      BMapLib_disi: <span class="string">'color:#7a7a7a;position:absolute;left:5px;padding:0 4px 1px 0;line-height:17px;background:url(http://api.map.baidu.com/images/dis_box_01.gif) no-repeat right top'</span>,</span><br><span class="line">      BMapLib_disBoxDis: <span class="string">'color:#ff6319;font-weight:bold'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._opts.lineStroke &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._opts.lineStroke = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._opts.opacity &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._opts.opacity = <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>._opts.opacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._opts.opacity = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._opts.lineStyle != <span class="string">'solid'</span> &amp;&amp;</span><br><span class="line">      <span class="keyword">this</span>._opts.lineStyle != <span class="string">'dashed'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._opts.lineStyle = <span class="string">'solid'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._units[<span class="keyword">this</span>._opts.unit]) &#123;</span><br><span class="line">      <span class="keyword">this</span>._opts.unit = <span class="string">'metric'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.text = <span class="string">'测距'</span>;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过baidu.lang下的inherits方法，让DistanceTool继承baidu.lang.Class</span></span><br><span class="line">baidu.lang.inherits(DistanceTool, baidu.lang.Class, <span class="string">'DistanceTool'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 地图区域的移动事件绑定</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._bind = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 设置鼠标样式</span></span><br><span class="line">  <span class="keyword">this</span>._setCursor(<span class="keyword">this</span>._opts.cursor);</span><br><span class="line">  <span class="keyword">const</span> me = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 在装载地图的页面元素上，绑定鼠标移动事件</span></span><br><span class="line">  baidu.on(<span class="keyword">this</span>._map.getContainer(), <span class="string">'mousemove'</span>, (e) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!me._isOpen) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!me._followTitle) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    e = <span class="built_in">window</span>.event || e;</span><br><span class="line">    <span class="keyword">const</span> t = e.target || e.srcElement;</span><br><span class="line">    <span class="comment">// 如果触发该事件的页面元素不是遮盖效果层，则返回，无操作</span></span><br><span class="line">    <span class="keyword">if</span> (t != OperationMask.getDom(me._map)) &#123;</span><br><span class="line">      me._followTitle.hide();</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!me._mapMoving) &#123;</span><br><span class="line">      me._followTitle.show();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置鼠标移动过程中，跟随的文字提示框的位置</span></span><br><span class="line">    <span class="keyword">const</span> pt = OperationMask.getDrawPoint(e, <span class="literal">true</span>);</span><br><span class="line">    me._followTitle.setPosition(pt);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 创建鼠标跟随的文字提示框</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._startFollowText) &#123;</span><br><span class="line">    <span class="keyword">const</span> t = <span class="keyword">this</span>._followTitle = <span class="keyword">new</span> BMap.Label(<span class="keyword">this</span>._startFollowText, &#123; <span class="attr">offset</span>: <span class="keyword">new</span> BMap.Size(<span class="number">14</span>, <span class="number">16</span>) &#125;);</span><br><span class="line">    <span class="keyword">this</span>._followTitle.setStyles(&#123; <span class="attr">color</span>: <span class="string">'#333'</span>, <span class="attr">borderColor</span>: <span class="string">'#ff0103'</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开启地图的测距状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Boolean&#125;</span></span>，开启测距状态成功，返回true；否则返回false。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment"> * myDistanceToolObject.open();</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype.open = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断测距状态是否已经开启</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._isOpen == <span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 已有其他地图上的鼠标操作工具开启</span></span><br><span class="line">  <span class="keyword">if</span> (BMapLib._toolInUse) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._isOpen = <span class="literal">true</span>;</span><br><span class="line">  BMapLib._toolInUse = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是否在移动过程中</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._mapMoving) &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>._mapMoving;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> me = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 增加鼠标在地图区域移动的事件</span></span><br><span class="line">  <span class="comment">// 通过binded参数，避免多次绑定</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>._binded) &#123;</span><br><span class="line">    <span class="keyword">this</span>._binded = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 绑定控件项事件</span></span><br><span class="line">    <span class="keyword">this</span>._bind();</span><br><span class="line">    <span class="comment">// 地图的移动过程中，需要隐藏相关的提示框</span></span><br><span class="line">    <span class="keyword">this</span>._map.addEventListener(<span class="string">'moving'</span>, () =&gt; &#123;</span><br><span class="line">      me._hideCurrent();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将文字提示框作为BMap.Label元素，提交给Map Api进行管理</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._followTitle) &#123;</span><br><span class="line">    <span class="keyword">this</span>._map.addOverlay(<span class="keyword">this</span>._followTitle);</span><br><span class="line">    <span class="keyword">this</span>._followTitle.hide();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距过程中，点击地图时，触发的操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e event对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> distClick = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> map = me._map;</span><br><span class="line">    <span class="keyword">if</span> (!me._isOpen) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过event对象，计算得出点击位置的物理坐标，poi为一个BMap.Point对象</span></span><br><span class="line">    e = <span class="built_in">window</span>.event || e;</span><br><span class="line">    <span class="keyword">const</span> poi = OperationMask.getDrawPoint(e, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// 验证计算得出的该点的位置合理性</span></span><br><span class="line">    <span class="keyword">if</span> (!me._isPointValid(poi)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记录当前点的屏幕位置</span></span><br><span class="line">    me._bind.initX = e.pageX || e.clientX || <span class="number">0</span>;</span><br><span class="line">    me._bind.initY = e.pageY || e.clientY || <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个if循环内的计算是，判断当前这个点，与存储内的最后一个点的距离，</span></span><br><span class="line">    <span class="comment">// 如果距离过小，比如小于5，可以认为是用户的误点，可以忽略掉</span></span><br><span class="line">    <span class="keyword">if</span> (me._points.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lstPx = map.pointToPixel(me._points[me._points.length - <span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">const</span> thisPx = map.pointToPixel(poi);</span><br><span class="line">      <span class="keyword">const</span> dis = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(lstPx.x - thisPx.x, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(lstPx.y - thisPx.y, <span class="number">2</span>));</span><br><span class="line">      <span class="keyword">if</span> (dis &lt; <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    me._bind.x = e.layerX || e.offsetX || <span class="number">0</span>;</span><br><span class="line">    me._bind.y = e.layerY || e.offsetY || <span class="number">0</span>;</span><br><span class="line">    me._points.push(poi);</span><br><span class="line">    <span class="comment">// 添加测距结点</span></span><br><span class="line">    me._addSecPoint(poi);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调整跟踪鼠标的标签</span></span><br><span class="line">    <span class="keyword">if</span> (me._paths.length == <span class="number">0</span>) &#123;</span><br><span class="line">      me._formatTitle(<span class="number">1</span>, me._opts.followText, me._getTotalDistance());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改确定线的颜色</span></span><br><span class="line">    <span class="keyword">if</span> (me._paths.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      me._paths[me._paths.length - <span class="number">1</span>].show();</span><br><span class="line">      me._paths[me._paths.length - <span class="number">1</span>].setStrokeOpacity(me._opts.opacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> path = <span class="keyword">new</span> BMap.Polyline([poi, poi], &#123; <span class="attr">enableMassClear</span>: me._enableMassClear &#125;);</span><br><span class="line">    me._map.addOverlay(path);</span><br><span class="line">    me._paths.push(path);</span><br><span class="line">    me._overlays.push(path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测距模式下线样式固定</span></span><br><span class="line">    path.setStrokeWeight(me._opts.lineStroke);</span><br><span class="line">    path.setStrokeColor(me._opts.lineColor);</span><br><span class="line">    path.setStrokeOpacity(me._opts.opacity / <span class="number">2</span>);</span><br><span class="line">    path.setStrokeStyle(me._opts.lineStyle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果地图正在移动则隐藏掉</span></span><br><span class="line">    <span class="keyword">if</span> (me._mapMoving) &#123;</span><br><span class="line">      path.hide();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (me._points.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> siblingPath = me._paths[me._points.length - <span class="number">2</span>];</span><br><span class="line">      siblingPath.setPositionAt(<span class="number">1</span>, poi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成节点旁边的距离显示框</span></span><br><span class="line">    <span class="keyword">let</span> disText = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (me._points.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 非起点的节点，显示当前的距离</span></span><br><span class="line">      <span class="keyword">const</span> segDis = me._setSegDistance(me._points[me._points.length - <span class="number">2</span>], me._points[me._points.length - <span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">const</span> meters = me._getTotalDistance();</span><br><span class="line">      disText = me._formatDisStr(meters);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      disText = <span class="string">'起点'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> disLabel = <span class="keyword">new</span> BMap.Label(disText, &#123; <span class="attr">offset</span>: <span class="keyword">new</span> BMap.Size(<span class="number">10</span>, <span class="number">-5</span>), <span class="attr">enableMassClear</span>: me._enableMassClear &#125;);</span><br><span class="line">    disLabel.setStyles(&#123; <span class="attr">color</span>: <span class="string">'#333'</span>, <span class="attr">borderColor</span>: <span class="string">'#ff0103'</span> &#125;);</span><br><span class="line">    me._map.addOverlay(disLabel);</span><br><span class="line">    me._formatSegLabel(disLabel, disText);</span><br><span class="line">    me._overlays.push(disLabel);</span><br><span class="line">    poi.disLabel = disLabel;</span><br><span class="line">    disLabel.setPosition(poi);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测距过程中，每次点击底图添加节点时，派发事件的接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@name </span>DistanceTool#onaddpoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@event</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;Event Object&#125;</span> </span>e 回调函数会返回event参数，包括以下返回值：</span></span><br><span class="line"><span class="comment">     * &lt;br /&gt;&#123;"&lt;b&gt;point&lt;/b&gt; : &#123;BMap.Point&#125; 最新添加上的节点BMap.Point对象,</span></span><br><span class="line"><span class="comment">     * &lt;br /&gt;"&lt;b&gt;pixel&lt;/b&gt;：&#123;BMap.pixel&#125; 最新添加上的节点BMap.Pixel对象,</span></span><br><span class="line"><span class="comment">     * &lt;br /&gt;"&lt;b&gt;index&lt;/b&gt;：&#123;Number&#125; 最新添加的节点的索引,</span></span><br><span class="line"><span class="comment">     * &lt;br /&gt;"&lt;b&gt;distance&lt;/b&gt;：&#123;Number&#125; 截止最新添加的节点的总距离&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment">     * myDistanceToolObject.addEventListener("addpoint", function(e) &#123;  alert(e.distance);  &#125;);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 生成名为onaddpoint的baidu.lang.Event对象</span></span><br><span class="line">      <span class="comment">// 并给该event对象添加上point、pixel、index和distance等属性字段</span></span><br><span class="line">      <span class="comment">// 然后在此刻，将绑定在onaddpoint上事件，全部赋予event参数，然后派发出去</span></span><br><span class="line">    <span class="keyword">const</span> event = <span class="keyword">new</span> baidu.lang.Event(<span class="string">'onaddpoint'</span>);</span><br><span class="line">    event.point = poi;</span><br><span class="line">    event.pixel = me._map.pointToPixel(poi);</span><br><span class="line">    event.index = me._points.length - <span class="number">1</span>;</span><br><span class="line">    event.distance = me._getTotalDistance().toFixed(<span class="number">0</span>);</span><br><span class="line">    me.dispatchEvent(event);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距过程中，鼠标在地图上移动时，触发的操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e event对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> distMove = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!me._isOpen) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过判断数组me._paths的长度，判断当前是否已经有测量节点</span></span><br><span class="line">    <span class="comment">// 也就是，如果没有节点，则还没有开始测量</span></span><br><span class="line">    <span class="keyword">if</span> (me._paths.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 通过event参数，计算当前点的位置</span></span><br><span class="line">      e = <span class="built_in">window</span>.event || e;</span><br><span class="line">      <span class="keyword">const</span> curX = e.pageX || e.clientX || <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">const</span> curY = e.pageY || e.clientY || <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> me._bind.initX === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        me._bind.x = e.layerX || e.offsetX || <span class="number">0</span>;</span><br><span class="line">        me._bind.y = e.layerY || e.offsetY || <span class="number">0</span>;</span><br><span class="line">        me._bind.initX = curX;</span><br><span class="line">        me._bind.initY = curY;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> x = me._bind.x + curX - me._bind.initX;</span><br><span class="line">      <span class="keyword">const</span> y = me._bind.y + curY - me._bind.initY;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 修改最后一条折线的终点位置，使之随着鼠标移动画线</span></span><br><span class="line">      <span class="keyword">const</span> path = me._paths[me._paths.length - <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">const</span> poi = me._map.pixelToPoint(<span class="keyword">new</span> BMap.Pixel(x, y));</span><br><span class="line">      path.setPositionAt(<span class="number">1</span>, poi);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!me._mapMoving) &#123;</span><br><span class="line">        path.show();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> dx = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">let</span> dy = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// 计算当前鼠标位置，是否靠近边界、或者已经出了边界</span></span><br><span class="line">      <span class="comment">// 如果在边界位置，则需要向对应的方向移动地图，来进行测量</span></span><br><span class="line">      <span class="comment">// 每次移动的距离，设定为8</span></span><br><span class="line">      <span class="keyword">if</span> (x &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        dx = <span class="number">8</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; me._map.getSize().width - <span class="number">10</span>) &#123;</span><br><span class="line">        dx = <span class="number">-8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (y &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        dy = <span class="number">8</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; me._map.getSize().height - <span class="number">10</span>) &#123;</span><br><span class="line">        dy = <span class="number">-8</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果dx和dy都等于0，表明不需要移动地图</span></span><br><span class="line">      <span class="keyword">if</span> (dx != <span class="number">0</span> || dy != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 此时需要向一个方向，平移地图</span></span><br><span class="line">        <span class="keyword">if</span> (!distMove._movingTimerId) &#123;</span><br><span class="line">          me._mapMoving = <span class="literal">true</span>;</span><br><span class="line">          me._map.panBy(dx, dy, &#123; <span class="attr">noAnimation</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">          me._movingTimerId = distMove._movingTimerId = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            me._map.panBy(dx, dy, &#123; <span class="attr">noAnimation</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">          &#125;, <span class="number">30</span>);</span><br><span class="line">          <span class="comment">// 地图移动过程中，隐藏线段和标签</span></span><br><span class="line">          path.hide();</span><br><span class="line">          me._followTitle &amp;&amp; me._followTitle.hide();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (distMove._movingTimerId) &#123;</span><br><span class="line">        <span class="comment">// 此时用户不在需要移动地图来测量，可以清除计时器</span></span><br><span class="line">        clearInterval(distMove._movingTimerId);</span><br><span class="line">        <span class="keyword">delete</span> distMove._movingTimerId;</span><br><span class="line">        <span class="keyword">delete</span> me._movingTimerId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示跟随提示框，并修改线路位置</span></span><br><span class="line">        <span class="keyword">const</span> lstP = me._paths[me._paths.length - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> poiN = me._map.pixelToPoint(<span class="keyword">new</span> BMap.Pixel(x, y));</span><br><span class="line">        <span class="keyword">if</span> (!lstP) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lstP.setPositionAt(<span class="number">1</span>, poiN);</span><br><span class="line">        lstP.show();</span><br><span class="line">        <span class="keyword">if</span> (me._followTitle) &#123;</span><br><span class="line">          me._followTitle.setPosition(poiN);</span><br><span class="line">          me._followTitle.show();</span><br><span class="line">        &#125;</span><br><span class="line">        me._bind.i = <span class="number">0</span>;</span><br><span class="line">        me._bind.j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">delete</span> me._mapMoving;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 实时更新文字提示框中的距离</span></span><br><span class="line">      <span class="keyword">if</span> (me._followTitle) &#123;</span><br><span class="line">        <span class="keyword">const</span> td = me._getTotalDistance();</span><br><span class="line">        <span class="keyword">const</span> dis = me._map.getDistance(me._points[me._points.length - <span class="number">1</span>], poi);</span><br><span class="line">        me._updateInstDis(me._followTitle, td + dis);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 此时用户还没有开始测量，只是鼠标随便在地图上移动</span></span><br><span class="line">      <span class="keyword">if</span> (me._followTitle) &#123;</span><br><span class="line">        me._followTitle.show();</span><br><span class="line">        e = <span class="built_in">window</span>.event || e;</span><br><span class="line">        <span class="keyword">const</span> t = e.target || e.srcElement;</span><br><span class="line">        <span class="keyword">if</span> (t != OperationMask.getDom()) &#123;</span><br><span class="line">          me._followTitle.hide();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距要结束时，双击地图，触发的操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e event对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> distDblclick = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!me._isOpen) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束时，删除绑定的事件</span></span><br><span class="line">    baidu.un(OperationMask.getDom(me._map), <span class="string">'click'</span>, distClick);</span><br><span class="line">    baidu.un(<span class="built_in">document</span>, <span class="string">'mousemove'</span>, distMove);</span><br><span class="line">    baidu.un(OperationMask.getDom(me._map), <span class="string">'dblclick'</span>, distDblclick);</span><br><span class="line">    baidu.un(<span class="built_in">document</span>, <span class="string">'keydown'</span>, distKeyDown);</span><br><span class="line">    baidu.un(OperationMask.getDom(me._map), <span class="string">'mouseup'</span>, distMouseUp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用close()关闭测距状态</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      me.close(callback);</span><br><span class="line">    &#125;, <span class="number">50</span>);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距时的键盘操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e event对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> distKeyDown = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e = <span class="built_in">window</span>.event || e;</span><br><span class="line">    <span class="keyword">if</span> (e.keyCode == <span class="number">27</span>) &#123;</span><br><span class="line">      <span class="comment">// [ESC]退出本次测距</span></span><br><span class="line">      me._clearCurData();</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        me.close();</span><br><span class="line">      &#125;, <span class="number">50</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距过程中，鼠标弹起时，触发的操作</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e event对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> distMouseUp = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    e = <span class="built_in">window</span>.event || e;</span><br><span class="line">    <span class="keyword">let</span> ieVersion = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/msie (\d+\.\d)/i</span>.test(navigator.userAgent)) &#123;</span><br><span class="line">      ieVersion = <span class="built_in">document</span>.documentMode || +<span class="built_in">RegExp</span>.$<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ieVersion &amp;&amp;</span><br><span class="line">      e.button != <span class="number">1</span> ||</span><br><span class="line">      e.button == <span class="number">2</span>) &#123;</span><br><span class="line">      me.close();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化存储数据</span></span><br><span class="line">  me._initData();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调整title的内容</span></span><br><span class="line">  <span class="keyword">this</span>._formatTitle();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建透明覆盖层，并设置鼠标样式</span></span><br><span class="line">  OperationMask.show(<span class="keyword">this</span>._map);</span><br><span class="line">  <span class="keyword">this</span>._setCursor(<span class="keyword">this</span>._opts.cursor);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绑定全部事件</span></span><br><span class="line">  baidu.on(OperationMask.getDom(<span class="keyword">this</span>._map), <span class="string">'click'</span>, distClick);</span><br><span class="line">  baidu.on(<span class="built_in">document</span>, <span class="string">'mousemove'</span>, distMove);</span><br><span class="line">  baidu.on(OperationMask.getDom(<span class="keyword">this</span>._map), <span class="string">'dblclick'</span>, distDblclick);</span><br><span class="line">  baidu.on(<span class="built_in">document</span>, <span class="string">'keydown'</span>, distKeyDown);</span><br><span class="line">  baidu.on(OperationMask.getDom(<span class="keyword">this</span>._map), <span class="string">'mouseup'</span>, distMouseUp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将绑定的事件、和对应的绑定对象，记录在数组中</span></span><br><span class="line">  <span class="keyword">this</span>.bindFunc = [</span><br><span class="line">    &#123; <span class="attr">elem</span>: OperationMask.getDom(<span class="keyword">this</span>._map), <span class="attr">type</span>: <span class="string">'click'</span>, <span class="attr">func</span>: distClick &#125;,</span><br><span class="line">    &#123; <span class="attr">elem</span>: OperationMask.getDom(<span class="keyword">this</span>._map), <span class="attr">type</span>: <span class="string">'dblclick'</span>, <span class="attr">func</span>: distDblclick &#125;,</span><br><span class="line">    &#123; <span class="attr">elem</span>: <span class="built_in">document</span>, <span class="attr">type</span>: <span class="string">'mousemove'</span>, <span class="attr">func</span>: distMove &#125;,</span><br><span class="line">    &#123; <span class="attr">elem</span>: <span class="built_in">document</span>, <span class="attr">type</span>: <span class="string">'keydown'</span>, <span class="attr">func</span>: distKeyDown &#125;,</span><br><span class="line">    &#123; <span class="attr">elem</span>: OperationMask.getDom(<span class="keyword">this</span>._map), <span class="attr">type</span>: <span class="string">'mouseup'</span>, <span class="attr">func</span>: distMouseUp &#125;];</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 画线结束时，派发drawend事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._dispatchLastEvent = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 测距时，每次双击底图结束当前测距折线时，派发事件的接口</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@name </span>DistanceTool#ondrawend</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@event</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Event Object&#125;</span> </span>e 回调函数会返回event参数，包括以下返回值：</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;&#123;"&lt;b&gt;points&lt;/b&gt; : &#123;BMap.Point&#125; 所有测量时，打下的节点BMap.Point对象,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;overlays&lt;/b&gt;：&#123;Array&#125; 所有测量时，生成的线段BMap.Overlay对象,</span></span><br><span class="line"><span class="comment">   * &lt;br /&gt;"&lt;b&gt;distance&lt;/b&gt;：&#123;Number&#125; 测量解释时的最终距离&#125;</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment">   * myDistanceToolObject.addEventListener("drawend", function(e) &#123;  alert(e.distance);  &#125;);</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成名为ondrawend的baidu.lang.Event对象</span></span><br><span class="line">    <span class="comment">// 并给该event对象添加上points、overlays和distance等属性字段</span></span><br><span class="line">    <span class="comment">// 然后在此刻，将绑定在ondrawend上事件，全部赋予event参数，然后派发出去</span></span><br><span class="line">  <span class="keyword">const</span> event = <span class="keyword">new</span> baidu.lang.Event(<span class="string">'ondrawend'</span>);</span><br><span class="line">  event.points =</span><br><span class="line">    <span class="keyword">this</span>._points ?</span><br><span class="line">      <span class="keyword">this</span>._points.slice(<span class="number">0</span>) :</span><br><span class="line">      [];</span><br><span class="line">  event.overlays =</span><br><span class="line">    <span class="keyword">this</span>._paths ?</span><br><span class="line">      <span class="keyword">this</span>._paths.slice(<span class="number">0</span>, <span class="keyword">this</span>._paths.length - <span class="number">1</span>) :</span><br><span class="line">      [];</span><br><span class="line">  event.distance = <span class="keyword">this</span>._getTotalDistance().toFixed(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">this</span>.dispatchEvent(event);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭测距状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment"> * myDistanceToolObject.close();</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype.close = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._isOpen == <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._isOpen = <span class="literal">false</span>;</span><br><span class="line">  BMapLib._toolInUse = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._mapMoving) &#123;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>._mapMoving;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> me = <span class="keyword">this</span>;</span><br><span class="line">  me._dispatchLastEvent();</span><br><span class="line">  <span class="keyword">if</span> (me._points.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 不是有效绘制，清除所有内容</span></span><br><span class="line">    me._clearCurData();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    me._paths[me._paths.length - <span class="number">1</span>].remove();</span><br><span class="line">    me._paths[me._paths.length - <span class="number">1</span>] = <span class="literal">null</span>;</span><br><span class="line">    me._paths.length = me._paths.length - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 移除最近一次标记</span></span><br><span class="line">    <span class="keyword">const</span> pt = me._points[me._points.length - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (pt.disLabel) &#123;</span><br><span class="line">      pt.disLabel.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    me._processLastOp(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  OperationMask.hide();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 删除绑定的事件</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>.bindFunc.length; i &lt; l; i++) &#123;</span><br><span class="line">    baidu.un(<span class="keyword">this</span>.bindFunc[i].elem, <span class="keyword">this</span>.bindFunc[i].type, <span class="keyword">this</span>.bindFunc[i].func);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 停止地图移动</span></span><br><span class="line">  <span class="keyword">if</span> (me._movingTimerId) &#123;</span><br><span class="line">    clearInterval(me._movingTimerId);</span><br><span class="line">    me._movingTimerId = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._followTitle) &#123;</span><br><span class="line">    <span class="keyword">this</span>._followTitle.hide();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清除本次测距的暂存数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._clearCurData = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>._points.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._points[i].disLabel) &#123;</span><br><span class="line">      <span class="keyword">this</span>._points[i].disLabel.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>._paths.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">this</span>._paths[i].remove();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>._dots.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">this</span>._dots[i].remove();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._initData();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 1275      * 初始化存储数组</span></span><br><span class="line"><span class="comment"> 1276      * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> 1277      */</span></span><br><span class="line">DistanceTool.prototype._initData = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化point数组</span></span><br><span class="line">  <span class="keyword">this</span>._points.length = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 初始化path数组</span></span><br><span class="line">  <span class="keyword">this</span>._paths.length = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 初始化分段距离数组</span></span><br><span class="line">  <span class="keyword">this</span>._segDistance.length = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 初始化结点图像数组</span></span><br><span class="line">  <span class="keyword">this</span>._dots.length = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算两点之间距离并存放在分段距离数组中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Point&#125;</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Point&#125;</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Number&#125;</span> </span>两个地理点之间的距离</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._setSegDistance = <span class="function"><span class="keyword">function</span> (<span class="params">pt0, pt1</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!pt0 || !pt1) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> dis = <span class="keyword">this</span>._map.getDistance(pt0, pt1);</span><br><span class="line">  <span class="keyword">this</span>._segDistance.push(dis);</span><br><span class="line">  <span class="keyword">return</span> dis;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获得总距离</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Number&#125;</span> </span>总距离</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._getTotalDistance = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> totalDis = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = <span class="keyword">this</span>._segDistance.length; i &lt; l; i++) &#123;</span><br><span class="line">    totalDis += <span class="keyword">this</span>._segDistance[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> totalDis;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将米制单位的数值换算成为目标单位下的数值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type <span class="type">&#123;Number&#125;</span> </span>需要转换的数值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type <span class="type">&#123;String&#125;</span> </span>字符串描述的目标单位，</span></span><br><span class="line"><span class="comment"> * "metric" 表示米制单位，</span></span><br><span class="line"><span class="comment"> * "us" 表示美国传统单位制</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Number&#125;</span> </span>转换后的数值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._convertUnit = <span class="function"><span class="keyword">function</span> (<span class="params">num, unit</span>) </span>&#123;</span><br><span class="line">  unit = unit || <span class="string">'metric'</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._units[unit]) &#123;</span><br><span class="line">    <span class="keyword">return</span> num * <span class="keyword">this</span>._units[unit].conv;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加测距结点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;BMap.Point&#125;</span> </span>节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._addSecPoint = <span class="function"><span class="keyword">function</span> (<span class="params">pt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ico =</span><br><span class="line">    <span class="keyword">this</span>._opts.secIcon ?</span><br><span class="line">      <span class="keyword">this</span>._opts.secIcon :</span><br><span class="line">      <span class="keyword">new</span> BMap.Icon(<span class="string">'http://api.map.baidu.com/images/mapctrls.png'</span>, <span class="keyword">new</span> BMap.Size(<span class="number">11</span>, <span class="number">11</span>), &#123; <span class="attr">imageOffset</span>: <span class="keyword">new</span> BMap.Size(<span class="number">-26</span>, <span class="number">-313</span>) &#125;);</span><br><span class="line">  <span class="keyword">const</span> secPt = <span class="keyword">new</span> BMap.Marker(pt, &#123;</span><br><span class="line">    icon: ico,</span><br><span class="line">    clickable: <span class="literal">false</span>,</span><br><span class="line">    baseZIndex: <span class="number">3500000</span>,</span><br><span class="line">    zIndexFixed: <span class="literal">true</span>,</span><br><span class="line">    enableMassClear: <span class="keyword">this</span>._enableMassClear,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>._map.addOverlay(secPt);</span><br><span class="line">  <span class="keyword">this</span>._dots.push(secPt);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化距离字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Number&#125;</span> </span>距离</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;String&#125;</span> </span>格式化的字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._formatDisStr = <span class="function"><span class="keyword">function</span> (<span class="params">distance</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> u = <span class="keyword">this</span>._opts.unit;</span><br><span class="line">  <span class="keyword">let</span> unit = <span class="keyword">this</span>._units[u].u1;</span><br><span class="line">  <span class="keyword">let</span> dis = <span class="keyword">this</span>._convertUnit(distance, u);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dis &gt; <span class="keyword">this</span>._units[u].incon) &#123;</span><br><span class="line">    dis /= <span class="keyword">this</span>._units[u].incon;</span><br><span class="line">    unit = <span class="keyword">this</span>._units[u].u2;</span><br><span class="line">    dis = dis.toFixed(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    dis = dis.toFixed(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> dis + unit;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置鼠标样式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>cursor 鼠标样式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>没有返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._setCursor = <span class="function"><span class="keyword">function</span> (<span class="params">cursor</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 由于webkit内核浏览器下，cursor设置后默认不会居中，所以需要对偏移值进行设置</span></span><br><span class="line">  <span class="keyword">const</span> csr =</span><br><span class="line">    /webkit/.test(navigator.userAgent.toLowerCase()) ?</span><br><span class="line">      <span class="string">`url(<span class="subst">$&#123;<span class="keyword">this</span>._opts.cursor&#125;</span>) 3 6, crosshair`</span> :</span><br><span class="line">      <span class="string">`url(<span class="subst">$&#123;<span class="keyword">this</span>._opts.cursor&#125;</span>), crosshair`</span>;</span><br><span class="line">  OperationMask._setCursor(csr);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取鼠标样式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;String&#125;</span> </span>跟随的鼠标样式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._getCursor = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._opts.cursor;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调整分段距离样式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;BMap.Label&#125;</span> </span>label 提示框的Label</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>需要填入的文字</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>没有返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._formatSegLabel = <span class="function"><span class="keyword">function</span> (<span class="params">label, text</span>) </span>&#123;</span><br><span class="line">  label.setStyle(&#123; <span class="attr">border</span>: <span class="string">'none'</span>, <span class="attr">padding</span>: <span class="string">'0'</span> &#125;);</span><br><span class="line">  label.setContent(<span class="string">`&lt;span style='<span class="subst">$&#123;<span class="keyword">this</span>._styles.BMapLib_diso&#125;</span>'&gt;&lt;span style='<span class="subst">$&#123;<span class="keyword">this</span>._styles.BMapLib_disi&#125;</span>'&gt;<span class="subst">$&#123;text&#125;</span>&lt;/span&gt;&lt;/span&gt;`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理最后一次操作，当用户双击或测距被强行退出时调用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>没有返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._processLastOp = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> me = <span class="keyword">this</span>;</span><br><span class="line">  <span class="comment">// 删除上次移动临时数据</span></span><br><span class="line">  <span class="keyword">delete</span> me._bind.x;</span><br><span class="line">  <span class="keyword">delete</span> me._bind.y;</span><br><span class="line">  <span class="keyword">delete</span> me._bind.initX;</span><br><span class="line">  <span class="keyword">delete</span> me._bind.initY;</span><br><span class="line">  <span class="comment">// 验证路径</span></span><br><span class="line">  <span class="keyword">if</span> (me._paths.length &gt; me._points.length - <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> l = me._paths.length - <span class="number">1</span>;</span><br><span class="line">    me._paths[l].remove();</span><br><span class="line">    me._paths[l] = <span class="literal">null</span>;</span><br><span class="line">    me._paths.length = l;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存本次测距对象</span></span><br><span class="line">  <span class="keyword">const</span> disObj = &#123;&#125;;</span><br><span class="line">  disObj.points = me._points.slice(<span class="number">0</span>);</span><br><span class="line">  disObj.paths = me._paths.slice(<span class="number">0</span>);</span><br><span class="line">  disObj.dots = me._dots.slice(<span class="number">0</span>);</span><br><span class="line">  disObj.segDis = me._segDistance.slice(<span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 判断总距离和按钮位置</span></span><br><span class="line">  <span class="keyword">const</span> lstPx = me._map.pointToPixel(disObj.points[disObj.points.length - <span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">const</span> prePx = me._map.pointToPixel(disObj.points[disObj.points.length - <span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">let</span> btnOffset = [<span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> disOffset = [<span class="number">0</span>, <span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> (lstPx.y - prePx.y &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 距离位于下端</span></span><br><span class="line">    disOffset = [<span class="number">-5</span>, <span class="number">11</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 距离位于上端</span></span><br><span class="line">    disOffset = [<span class="number">-5</span>, <span class="number">-35</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (lstPx.x - prePx.x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 按钮位于右侧</span></span><br><span class="line">    btnOffset = [<span class="number">14</span>, <span class="number">0</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 按钮位于左侧</span></span><br><span class="line">    btnOffset = [<span class="number">-14</span>, <span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 显示总距离</span></span><br><span class="line">  <span class="keyword">const</span> pt = disObj.points[disObj.points.length - <span class="number">1</span>];</span><br><span class="line">  pt.disLabel = <span class="keyword">new</span> BMap.Label(<span class="string">''</span>, &#123; <span class="attr">offset</span>: <span class="keyword">new</span> BMap.Size(<span class="number">-15</span>, <span class="number">-40</span>), <span class="attr">enableMassClear</span>: me._enableMassClear &#125;);</span><br><span class="line">  pt.disLabel.setStyles(&#123; <span class="attr">color</span>: <span class="string">'#333'</span>, <span class="attr">borderColor</span>: <span class="string">'#ff0103'</span> &#125;);</span><br><span class="line">  me._map.addOverlay(pt.disLabel);</span><br><span class="line">  pt.disLabel.setOffset(<span class="keyword">new</span> BMap.Size(disOffset[<span class="number">0</span>], disOffset[<span class="number">1</span>]));</span><br><span class="line">  pt.disLabel.setPosition(pt);</span><br><span class="line">  me._formatTitle(<span class="number">2</span>, <span class="string">''</span>, <span class="string">''</span>, pt.disLabel);</span><br><span class="line">  <span class="comment">// 添加关闭按钮</span></span><br><span class="line">  <span class="keyword">const</span> bico =</span><br><span class="line">    <span class="keyword">this</span>._opts.closeIcon ?</span><br><span class="line">      <span class="keyword">this</span>._opts.closeIcon :</span><br><span class="line">      <span class="keyword">new</span> BMap.Icon(<span class="string">'http://api.map.baidu.com/images/mapctrls.gif'</span>, <span class="keyword">new</span> BMap.Size(<span class="number">12</span>, <span class="number">12</span>), &#123; <span class="attr">imageOffset</span>: <span class="keyword">new</span> BMap.Size(<span class="number">0</span>, <span class="number">-14</span>) &#125;);</span><br><span class="line">  disObj.closeBtn = <span class="keyword">new</span> BMap.Marker(</span><br><span class="line">    disObj.points[disObj.points.length - <span class="number">1</span>],</span><br><span class="line">    &#123;</span><br><span class="line">      icon: bico,</span><br><span class="line">      offset: <span class="keyword">new</span> BMap.Size(btnOffset[<span class="number">0</span>], btnOffset[<span class="number">1</span>]),</span><br><span class="line">      baseZIndex: <span class="number">3600000</span>,</span><br><span class="line">      enableMassClear: me._enableMassClear,</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">  me._map.addOverlay(disObj.closeBtn);</span><br><span class="line">  disObj.closeBtn.setTitle(<span class="string">'清除本次测距'</span>);</span><br><span class="line">  <span class="comment">// 点击关闭按钮，绑定关闭按钮事件</span></span><br><span class="line">  disObj.closeBtn.addEventListener(<span class="string">'click'</span>, (e) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      callback();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 关闭本次测距，清除相关存储和变量</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = disObj.points.length; i &lt; l; i++) &#123;</span><br><span class="line">      disObj.points[i].disLabel.remove();</span><br><span class="line">      disObj.points[i].disLabel = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = disObj.paths.length; i &lt; l; i++) &#123;</span><br><span class="line">      disObj.paths[i].remove();</span><br><span class="line">      disObj.paths[i] = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = disObj.dots.length; i &lt; l; i++) &#123;</span><br><span class="line">      disObj.dots[i].remove();</span><br><span class="line">      disObj.dots[i] = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    disObj.closeBtn.remove();</span><br><span class="line">    disObj.closeBtn = <span class="literal">null</span>;</span><br><span class="line">    stopBubble(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@ignore</span></span></span><br><span class="line"><span class="comment">     * 测距结束后，点击线段上最后一个节点旁的关闭按钮时，派发事件的接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@name </span>DistanceTool#onremovepolyline</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@event</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;Event Object&#125;</span> </span>e 回调函数会返回event参数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@example </span>&lt;b&gt;参考示例：&lt;/b&gt;&lt;br /&gt;</span></span><br><span class="line"><span class="comment">     * myDistanceToolObject.addEventListener("removepolyline", function(e) &#123;  alert(e.type);  &#125;);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 生成名为onremovepolyline的baidu.lang.Event对象</span></span><br><span class="line">      <span class="comment">// 然后在此刻，将绑定在onremovepolyline上事件，全部赋予event参数，然后派发出去</span></span><br><span class="line">    <span class="keyword">const</span> event = <span class="keyword">new</span> baidu.lang.Event(<span class="string">'onremovepolyline'</span>);</span><br><span class="line">    me.dispatchEvent(event);</span><br><span class="line">  &#125;);</span><br><span class="line">  me._initData();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成测距过程中的文字提示框</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">type</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">text</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">distance</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Label&#125;</span> <span class="variable">label</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._formatTitle = <span class="function"><span class="keyword">function</span> (<span class="params">type, text, distance, label</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> title = label || <span class="keyword">this</span>._followTitle;</span><br><span class="line">  <span class="keyword">if</span> (!title) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  title.setStyle(&#123; <span class="attr">lineHeight</span>: <span class="string">'16px'</span>, <span class="attr">zIndex</span>: <span class="string">'85'</span>, <span class="attr">padding</span>: <span class="string">'3px 5px'</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> t = <span class="keyword">this</span>._startFollowText || <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">const</span> htmls = [];</span><br><span class="line">  <span class="keyword">if</span> (type == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 测距过程中的提示</span></span><br><span class="line">    title.setOffset(<span class="number">0</span>, <span class="number">25</span>);</span><br><span class="line">    <span class="keyword">var</span> u = <span class="keyword">this</span>._opts.unit;</span><br><span class="line">    <span class="keyword">var</span> unit = <span class="keyword">this</span>._units[u].u1;</span><br><span class="line">    <span class="keyword">var</span> dis = <span class="keyword">this</span>._convertUnit(distance, u);</span><br><span class="line">    <span class="keyword">if</span> (dis &gt; <span class="keyword">this</span>._units[u].incon) &#123;</span><br><span class="line">      dis /= <span class="keyword">this</span>._units[u].incon;</span><br><span class="line">      unit = <span class="keyword">this</span>._units[u].u2;</span><br><span class="line">      dis = dis.toFixed(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dis = dis.toFixed(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    htmls.push(<span class="string">`&lt;span&gt;总长：&lt;span style='<span class="subst">$&#123;<span class="keyword">this</span>._styles.BMapLib_disBoxDis&#125;</span>'&gt;<span class="subst">$&#123;dis&#125;</span>&lt;/span&gt;<span class="subst">$&#123;unit&#125;</span>&lt;/span&gt;&lt;br /&gt;`</span>);</span><br><span class="line">    htmls.push(<span class="string">`&lt;span style='color:#7a7a7a'&gt;<span class="subst">$&#123;text&#125;</span>&lt;/span&gt;`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 结束时的总距离展示</span></span><br><span class="line">    <span class="keyword">var</span> u = <span class="keyword">this</span>._opts.unit;</span><br><span class="line">    <span class="keyword">var</span> unit = <span class="keyword">this</span>._units[u].u1;</span><br><span class="line">    <span class="keyword">var</span> dis = <span class="keyword">this</span>._convertUnit(<span class="keyword">this</span>._getTotalDistance(), u);</span><br><span class="line">    <span class="keyword">if</span> (dis &gt; <span class="keyword">this</span>._units[u].incon) &#123;</span><br><span class="line">      dis /= <span class="keyword">this</span>._units[u].incon;</span><br><span class="line">      unit = <span class="keyword">this</span>._units[u].u2;</span><br><span class="line">      dis = dis.toFixed(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dis = dis.toFixed(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    htmls.push(<span class="string">`总长：&lt;span style='<span class="subst">$&#123;<span class="keyword">this</span>._styles.BMapLib_disBoxDis&#125;</span>'&gt;<span class="subst">$&#123;dis&#125;</span>&lt;/span&gt;<span class="subst">$&#123;unit&#125;</span>`</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    title.setOffset(<span class="number">0</span>, <span class="number">25</span>);</span><br><span class="line">    htmls.push(t);</span><br><span class="line">  &#125;</span><br><span class="line">  title.setContent(htmls.join(<span class="string">''</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新label的距离</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>HTMLElement label的DOM元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>Number 距离</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._updateInstDis = <span class="function"><span class="keyword">function</span> (<span class="params">label, dis</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 换算距离</span></span><br><span class="line">  <span class="keyword">const</span> u = <span class="keyword">this</span>._opts.unit;</span><br><span class="line">  <span class="keyword">let</span> unit = <span class="keyword">this</span>._units[u].u1;</span><br><span class="line">  <span class="keyword">if</span> (dis &gt; <span class="keyword">this</span>._units[u].incon) &#123;</span><br><span class="line">    dis /= <span class="keyword">this</span>._units[u].incon;</span><br><span class="line">    unit = <span class="keyword">this</span>._units[u].u2;</span><br><span class="line">    dis = dis.toFixed(<span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    dis = dis.toFixed(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 修改Label的内容</span></span><br><span class="line">  <span class="keyword">if</span> (label) &#123;</span><br><span class="line">    <span class="keyword">const</span> htmls = [];</span><br><span class="line">    htmls.push(<span class="string">`&lt;span&gt;总长：&lt;span style='<span class="subst">$&#123;<span class="keyword">this</span>._styles.BMapLib_disBoxDis&#125;</span>'&gt;<span class="subst">$&#123;dis&#125;</span>&lt;/span&gt;<span class="subst">$&#123;unit&#125;</span>&lt;/span&gt;&lt;br /&gt;`</span>);</span><br><span class="line">    htmls.push(<span class="string">`&lt;span style='color:#7a7a7a'&gt;<span class="subst">$&#123;<span class="keyword">this</span>._opts.followText&#125;</span>&lt;/span&gt;`</span>);</span><br><span class="line">    label.setContent(htmls.join(<span class="string">''</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 隐藏相关的线段和提示框文字</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._hideCurrent = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>._isOpen) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._paths.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> p = <span class="keyword">this</span>._paths[<span class="keyword">this</span>._paths.length - <span class="number">1</span>];</span><br><span class="line">    p.hide();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._followTitle &amp;&amp; <span class="keyword">this</span>._followTitle.hide();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证传入点的位置合理性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;BMap.Point&#125;</span> </span>pt 需要被验证的point点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">DistanceTool.prototype._isPointValid = <span class="function"><span class="keyword">function</span> (<span class="params">pt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!pt) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> mapBounds = <span class="keyword">this</span>._map.getBounds();</span><br><span class="line">  <span class="keyword">let</span> sw = mapBounds.getSouthWest(),</span><br><span class="line">    ne = mapBounds.getNorthEast();</span><br><span class="line">  <span class="keyword">if</span> (pt.lng &lt; sw.lng ||</span><br><span class="line">    pt.lng &gt; ne.lng ||</span><br><span class="line">    pt.lat &lt; sw.lat ||</span><br><span class="line">    pt.lat &gt; ne.lat) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OperationMask，透明覆盖层，在地图上进行鼠标绘制操作时使用，</span></span><br><span class="line"><span class="comment"> * 闭包，对外不暴露</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> OperationMask = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * map对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;Map&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _map: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * HTML字符串</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _html: <span class="string">"&lt;div style='background:transparent url(http://api.map.baidu.com/images/blank.gif);position:absolute;left:0;top:0;width:100%;height:100%;z-index:4000' unselectable='on'&gt;&lt;/div&gt;"</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * html元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;HTMLElement&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _maskElement: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 鼠标指针</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;String&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _cursor: <span class="string">'default'</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 操作层是否在使用中</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;Boolean&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _inUse: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 透明覆盖层的显示</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Map&#125;</span> </span>map map对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  show(map) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._map) &#123;</span><br><span class="line">      <span class="keyword">this</span>._map = map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>._inUse = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._maskElement) &#123;</span><br><span class="line">      <span class="keyword">this</span>._createMask(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>._maskElement.style.display = <span class="string">'block'</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建覆盖层</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Map&#125;</span> </span>map map对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _createMask(map) &#123;</span><br><span class="line">    <span class="keyword">this</span>._map = map;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._map) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    baidu.insertHTML(<span class="keyword">this</span>._map.getContainer(), <span class="string">'beforeEnd'</span>, <span class="keyword">this</span>._html);</span><br><span class="line">    <span class="keyword">const</span> elem = <span class="keyword">this</span>._maskElement = <span class="keyword">this</span>._map.getContainer().lastChild;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> stopAndPrevent = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      stopBubble(e);</span><br><span class="line">      <span class="keyword">return</span> baidu.preventDefault(e);</span><br><span class="line">    &#125;;</span><br><span class="line">    baidu.on(elem, <span class="string">'mouseup'</span>, (e) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (e.button == <span class="number">2</span>) &#123;</span><br><span class="line">        stopAndPrevent(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    baidu.on(elem, <span class="string">'contextmenu'</span>, stopAndPrevent);</span><br><span class="line">    elem.style.display = <span class="string">'none'</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取当前绘制点的地理坐标</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Event&#125;</span> </span>e e对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Boolean&#125;</span> </span>n 是否向上查到相对于地图container元素的坐标位置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>Point对象的位置信息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getDrawPoint(e, n) &#123;</span><br><span class="line">    e = <span class="built_in">window</span>.event || e;</span><br><span class="line">    <span class="keyword">let</span> x = e.layerX || e.offsetX || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> y = e.layerY || e.offsetY || <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> t = e.target || e.srcElement;</span><br><span class="line">    <span class="keyword">if</span> (t != OperationMask.getDom(<span class="keyword">this</span>._map) &amp;&amp; n == <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span> (t &amp;&amp; t != <span class="keyword">this</span>._map.getContainer()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(t.clientWidth == <span class="number">0</span> &amp;&amp;</span><br><span class="line">          t.clientHeight == <span class="number">0</span> &amp;&amp;</span><br><span class="line">          t.offsetParent &amp;&amp;</span><br><span class="line">          t.offsetParent.nodeName.toLowerCase() == <span class="string">'td'</span>)) &#123;</span><br><span class="line">          x += t.offsetLeft;</span><br><span class="line">          y += t.offsetTop;</span><br><span class="line">        &#125;</span><br><span class="line">        t = t.offsetParent;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (t != OperationMask.getDom(<span class="keyword">this</span>._map) &amp;&amp;</span><br><span class="line">      t != <span class="keyword">this</span>._map.getContainer()) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> x === <span class="string">'undefined'</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> y === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(x) || <span class="built_in">isNaN</span>(y)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._map.pixelToPoint(<span class="keyword">new</span> BMap.Pixel(x, y));</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 透明覆盖层的隐藏</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  hide() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._map) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>._inUse = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._maskElement) &#123;</span><br><span class="line">      <span class="keyword">this</span>._maskElement.style.display = <span class="string">'none'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取HTML容器</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Map&#125;</span> </span>map map对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>HTML容器元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getDom(map) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._maskElement) &#123;</span><br><span class="line">      <span class="keyword">this</span>._createMask(map);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._maskElement;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置鼠标样式</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@type <span class="type">&#123;String&#125;</span> </span>cursor 鼠标样式</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return </span>无返回值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _setCursor(cursor) &#123;</span><br><span class="line">    <span class="keyword">this</span>._cursor = cursor || <span class="string">'default'</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._maskElement) &#123;</span><br><span class="line">      <span class="keyword">this</span>._maskElement.style.cursor = <span class="keyword">this</span>._cursor;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">DistanceTool.prototype.setOperationMask = <span class="function">(<span class="params">option</span>) =&gt;</span> &#123;</span><br><span class="line">  OperationMask = &#123;</span><br><span class="line">    ...OperationMask,</span><br><span class="line">    ...option,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 停止事件冒泡传播，</span></span><br><span class="line"><span class="comment"> * 闭包，对外不暴露</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type <span class="type">&#123;Event&#125;</span> </span>e e对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stopBubble</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> e = <span class="built_in">window</span>.event || e;</span><br><span class="line">  e.stopPropagation ? e.stopPropagation() : e.cancelBubble = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> DistanceTool;</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>bind</title>
    <url>/want/2021/06/02/bind/</url>
    <content><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>BIND（Berkeley Internet Name Domain），是现今互联网上最常使用的DNS软件，使用BIND作为服务器软件的DNS服务器约占所有DNS服务器的九成。BIND现在由互联网系统协会（Internet Systems Consortium）负责开发与维护。</p>
<p><strong>主从的作用</strong>：</p>
<p>1、共同解析域名——如master与slave任何一端dns服务断掉，也可以通过从另外一端来解析域名。</p>
<p>2、自动更新——如果master修改完成信息后，slave也会自动更新。</p>
<h3 id="系统及部署环境"><a href="#系统及部署环境" class="headerlink" title="系统及部署环境"></a>系统及部署环境</h3><p>获取操作系统命令</p>
<ol>
<li>uname -sr</li>
<li>cat /etc/redhat-release</li>
</ol>
<p>获取bind版本命令</p>
<ul>
<li>named -v</li>
</ul>
<table>
<thead>
<tr>
<th>主机</th>
<th>主备</th>
<th>操作系统</th>
<th>bind版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>fnc05 10.154.5.163</td>
<td>主机master</td>
<td>CentOS Linux release 7.9.2009 (Core) / Linux 3.10.0-1160.11.1.el7.x86_64</td>
<td>BIND 9.16.17 (Stable Release)</td>
</tr>
<tr>
<td>fnc04 10.154.5.162</td>
<td>从机slave</td>
<td>CentOS Linux release 7.8.2003 (Core) / Linux 3.10.0-1127.18.2.el7.x86_64</td>
<td>BIND 9.16.16 (Stable Release)</td>
</tr>
<tr>
<td>fnc03 10.154.5.214</td>
<td>从机slave</td>
<td>BigCloud Enterprise Linux For LDK release 7.6.1906 (Core) / Linux 4.19.25-200.1.el7.bclinux.x86_64</td>
<td>BIND 9.16.17 (Stable Release)</td>
</tr>
</tbody>
</table>
<p>上述主备机仍需注意如下配置：</p>
<ol>
<li><p>确保防火墙的规则不会拦截Bind的监听端口，默认为53。</p>
<ol>
<li>systemctl status firewalld</li>
</ol>
<ul>
<li><p><a href="https://www.lisenet.com/2018/configure-bind-dns-servers-with-failover-and-dynamic-updates-on-centos-7/" target="_blank" rel="noopener">https://www.lisenet.com/2018/configure-bind-dns-servers-with-failover-and-dynamic-updates-on-centos-7/</a></p>
</li>
<li><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getenforce</span><br><span class="line"></span><br><span class="line">- cat /etc/selinux/config</span><br><span class="line">  - SELINUX=disabled</span><br><span class="line">  - SELINUX=enforcing</span><br><span class="line">- 需要重启机器</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">setenforce 0 </span><br><span class="line">0 ：转成 permissive 宽容模式；</span><br><span class="line">1 ：转成 Enforcing 强制模式</span><br><span class="line">不需要重启机器</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>确保主从服务器的时钟一致。</p>
<ul>
<li><p>date</p>
</li>
<li><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y ntpdate </span><br><span class="line">ntpdate time.nist.gov</span><br><span class="line">hwclock -w</span><br><span class="line">date</span><br><span class="line">hwclock</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>确保named用户拥有操作相关目录的权限（默认安装后就有了）</p>
</li>
<li><p>曾尝试9.11版本的主机，与9.16版本的从机，也能和谐运行。</p>
</li>
</ol>
<h4 id="bind部署架构"><a href="#bind部署架构" class="headerlink" title="bind部署架构"></a>bind部署架构</h4><p>主从架构：</p>
<ol>
<li>每个机器，无论主从，都部署独立的bind服务。</li>
<li>主机可读写，能够进行zone文件的维护管理（增删改）。</li>
<li>从机只读，从主机同步读取zone数据后，只可提供查询服务。</li>
<li>从机其实是从主机同步的是.zone文件，但具体是哪些.zone文件呢？这由named.conf中所配置的zone参数决定，每个需要同步的zone文件都会在named.conf中配置如下参数：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zone &quot;abc.com&quot; IN &#123;</span><br><span class="line">        type slave; #说明需要备份的.zone文件</span><br><span class="line">        file &quot;slaves/abc.com.zone&quot;; #备份目录</span><br><span class="line">        masters &#123; 10.154.5.163; &#125;; #主机</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因此主机每对zone进行增删时，都要维护slave备机的named.conf文件。详见Catalog zones章节，可采用手段自动维护。</p>
<img src="/want/2021/06/02/bind/master_slaves.png" title="master_slaves">
<h4 id="rndc主从分布"><a href="#rndc主从分布" class="headerlink" title="rndc主从分布"></a>rndc主从分布</h4><p>rndc（Remote Name Domain Controllerr）是一个远程管理bind的工具，通过这个工具可以在本地或者远程了解当前服务器的运行状况，也可以对服务器进行关闭、重载、刷新缓存、增加删除zone等操作。  </p>
<p>rndc面对bind服务的主从配置，只有一个原则，即rndc的独立与否与bind主从没有必然联系。是故，可以做任意选择：</p>
<ol>
<li>第一种：两类机器都有自己独立的rndc配置。相互之间没有什么关系。各自的rndc控制自己的dns bind服务。</li>
<li>第二种：主机拥有rndc，从机只作为主机的客户端，远程控制主机的rndc。适用于从机不需要rndc更新任何dns数据，只需要主机rndc的情况。</li>
</ol>
<p>但是，从机为了能够独立的管理从机（对自己重启之类的），建议采用第一种各自的rndc控制自己的dns bind服务。</p>
<img src="/want/2021/06/02/bind/rndc.png" title="rndc">
<p><strong>本文涉及到的常用命令：</strong></p>
<ol>
<li>rndc reload：重新装入配置文件 + 全部zone。如修改了named.conf</li>
<li>rndc reconfig：仅重新装入配置文件 + 新zone。如修改了named.conf，或在named.conf新增加了一个叫test.com 的zone，就用rndc reconfig来让更改生效。</li>
<li>rndc reload zone：重新装入指定某个zone。如仅修改了具体的某个zone文件，在test.com里面增加一个<a href="http://www.test.com/" target="_blank" rel="noopener">www.test.com</a>的a记录，所以用rndc reload test.com来更新。</li>
</ol>
<p>比如，修改了<code>named.conf</code>文件中的<code>also-notify { 10.154.5.162; 10.154.5.214; };</code>，因为仅修改了配置文件，没有涉及到zone。采用rndc reload和rndc reconfig均可。</p>
<ol start="4">
<li><p>rndc  status： 显示bind服务器的工作状态</p>
</li>
<li><p>rndc sync zone：zone文件修改后，一般改动的信息被储存在*.jnl文件（二进制文件不宜修改）中。一般情况下在15分钟内，Bind会将jnl文件转储到区域文件中。此时添加进入的DNS记录是能够正常提供服务的。但如果想要需要实时更新到区域文件中，需要使用rndc sync且需要注意区域文件的文件权限。</p>
</li>
</ol>
<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><ol>
<li><a href="https://manpages.debian.org/experimental/bind-utils/rndc.8.en.html" target="_blank" rel="noopener">rndc(8) — bind-utils — Debian experimental — Debian Manpages</a></li>
<li><a href="http://www.chiark.greenend.org.uk/doc/bind9-doc/arm/man.rndc.html" target="_blank" rel="noopener">rndc (greenend.org.uk)</a></li>
</ol>
<h3 id="自动同步zone配置"><a href="#自动同步zone配置" class="headerlink" title="自动同步zone配置"></a>自动同步zone配置</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>在主机master定义了一个zone，然后<strong>必须到所有备机slave都新增相应zone的配置</strong>，才能实现主从同步。因此，主备配置的核心在于，如何维护备机的zone配置列表（maintaining slave zone lists）。</p>
<p>如，主机的named.conf文件中增加了zone的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zone &quot;abc.com&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;abc.com.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>则，从机也需要在named.conf文件中增加zone的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zone &quot;abc.com&quot; IN &#123;</span><br><span class="line">        type slave; #说明需要备份的.zone文件</span><br><span class="line">        file &quot;slaves/abc.com.zone&quot;; #备份目录</span><br><span class="line">        masters &#123; 10.154.5.163; &#125;; #主机ip</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>目前，已知向从机named.conf文件中增加zone配置的方案，总共可以归结为3类：</p>
<ol>
<li>传统方式，手动配置。不适合rndc动态添加的zone。</li>
<li>用户编写脚本（linux监听变动脚本或者python脚本），实现自动维护从机的zone配置。</li>
<li>catalog zone目录区域，主从一次性配置，后续自动同步zone。</li>
</ol>
<p>本文详细介绍catalog zone目录区域的配置。</p>
<h4 id="方案-传统手动方式"><a href="#方案-传统手动方式" class="headerlink" title="方案-传统手动方式"></a>方案-传统手动方式</h4><p>主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">主机手动添加到named.rfc1912.zones（最终include到named.conf）：</span><br><span class="line">zone &quot;my_zone.com&quot; &#123;</span><br><span class="line">    type master;</span><br><span class="line">    file &quot;/etc/bind/db.my_zone.com&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>从机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">从机手动添加到named.rfc1912.zones（最终include到named.conf）：</span><br><span class="line">zone &quot;my_zone.com&quot; &#123;</span><br><span class="line">    type slave;</span><br><span class="line">    file &quot;db.my_zone.com&quot;;</span><br><span class="line">    masters &#123; master_ip_address; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="方案-用户编写脚本"><a href="#方案-用户编写脚本" class="headerlink" title="方案-用户编写脚本"></a>方案-用户编写脚本</h4><p>Left to the user to create a script or process for maintaining slave zone lists</p>
<p>用户编写脚本运行示意图：</p>
<img src="/want/2021/06/02/bind/user_script.png" title="user_script">
<p>bind官网9.11的升级文档指出，用户脚本较为麻烦：</p>
<img src="/want/2021/06/02/bind/user_script_bad.png" title="user_script_bad">
<h5 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h5><ol>
<li><a href="https://jpmens.net/2013/02/13/automatic-provisioning-of-slave-dns-servers/" target="_blank" rel="noopener">Jan-Piet Mens :: Automatic provisioning of slave DNS servers (jpmens.net)</a></li>
<li><a href="https://serverfault.com/questions/60360/automatically-sync-all-zones-between-bind-9" target="_blank" rel="noopener">Automatically sync all zones between BIND 9 - Server Fault</a></li>
</ol>
<h4 id="方案-Catalog-zone【重点】"><a href="#方案-Catalog-zone【重点】" class="headerlink" title="方案-Catalog zone【重点】"></a>方案-Catalog zone【重点】</h4><h5 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h5><p>Catalog zone本质上还是master上的一个zone文件，但具有一些特点：</p>
<ol>
<li>特殊的格式。in a special new format</li>
<li>内容是一系列的待同步zones列表，称为“成员区域”。（”member zones”.）。contains a list of zones (the CatZ)  </li>
</ol>
<p><strong>用途</strong>：Catalog zone（目录区域）是一项新的 BIND 功能（BIND 9.11 (2018) ），无论多少从机，都可以轻松地将zone配置到从机。</p>
<ol>
<li><p>当Catalog zone加载或传输到支持此功能的从机时，<strong>从机会自动创建member zones。</strong></p>
</li>
<li><p>更新Catalog zone时（例如，添加、删除member zones，或更改其配置参数），这些更改会立即生效。</p>
</li>
<li><p>因为Catalog zone是一个普通的 DNS 区域，所以可以使用标准的 AXFR/IXFR 区域传输机制来传播这些配置更改。</p>
</li>
</ol>
<p><strong>Catalog zone使用条件：</strong></p>
<ol>
<li>要求主、从服务器都采用 BIND。</li>
<li>要求BIND 9.11+版本。</li>
</ol>
<h5 id="实践配置简介"><a href="#实践配置简介" class="headerlink" title="实践配置简介"></a>实践配置简介</h5><p>Catalog zone配置过程如下：</p>
<ol>
<li>主机，创建一个Catalog zone（catZ）文件。这个文件用来维护需要同步的zones列表。</li>
<li>主机，named.conf中配置catZ。</li>
<li>从机，named.conf中配置catZ。</li>
<li>一旦catZ建立，从机自动获取主机的zone Catalog，自动获取zone Catalog中的zones列表变化，从而实现同步。</li>
<li>zone Catalog可以有多个！</li>
</ol>
<img src="/want/2021/06/02/bind/catz_conf.png" title="catz_conf">
<h5 id="主从配置"><a href="#主从配置" class="headerlink" title="主从配置"></a>主从配置</h5><p>作用：完成catalog目录的配置。</p>
<h6 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h6><ol>
<li>打开目录<code>/var/opt/isc/isc-bind/named/data</code>，新建catalog目录文件（后缀名可以为.db或者.zone）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">catalog.default.zone</span></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 3600</span></span><br><span class="line">@       IN SOA . . 1 86400 3600 86400 3600</span><br><span class="line">@       IN NS  nop.</span><br><span class="line">version IN TXT "1"</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">修改权限</span></span><br><span class="line">chown named.named catalog.default.zone</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>将catalog目录文件引入到named.conf中</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">...</span></span><br><span class="line">	allow-new-zones yes; # RNDC动态维护zones</span><br><span class="line">	notify yes; # 主动通知从机更新,而不需要等待轮询时间进行更新</span><br><span class="line"> 	also-notify &#123; 10.154.5.162; &#125;; # 被主动通知的从机地址，可多个地址</span><br><span class="line"> 	allow-transfer &#123; 10.154.5.162; 10.154.5.163; &#125;; # 只允许列表中的主机传递主域名服务器的数据,为了方便扩展可以设置为key</span><br><span class="line">    allow-update &#123; any; &#125;; #允许向主zone文件发送动态更新的匹配列表，如果设置为none，则无法使用update命令（更新记录zone等）</span><br><span class="line">    allow-query  &#123; any; &#125;; #添加允许访问DNS的地址段</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">          type master;</span><br><span class="line">          file "catalog.default.zone";</span><br><span class="line">          #also-notify &#123; 10.154.5.162; &#125;; </span><br><span class="line">          #allow-transfer &#123; 10.154.5.162; 10.154.5.163; &#125;;</span><br><span class="line">          #allow-update &#123; any; &#125;; </span><br><span class="line">          #allow-query &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="从机"><a href="#从机" class="headerlink" title="从机"></a>从机</h6><p>named.conf配置catalog目录，与主机建立关联。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">options &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">...</span></span><br><span class="line">	listen-on port 53 &#123; 127.0.0.1; 10.154.5.162; 10.154.5.163; &#125;; # 主机</span><br><span class="line">	allow-new-zones yes; # RNDC动态维护zones</span><br><span class="line">	masterfile-format text; #从机乱码问题</span><br><span class="line">	catalog-zones &#123;</span><br><span class="line">                zone "catalog.default"  default-masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">          type slave;</span><br><span class="line">          file "catalog.default.zone";</span><br><span class="line">          masters &#123; 10.154.5.163; &#125;; // 主机ip</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h6><p>至此完成catalog目录的配置。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">主机、从机都重启</span></span><br><span class="line">systemctl restart named 或</span><br><span class="line">systemctl restart isc-bind-named</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在主机上验证主从是否搭建catalog成功</span></span><br><span class="line">dig +short @10.154.5.163 soa catalog.default</span><br><span class="line">dig +short @10.154.5.162 soa catalog.default</span><br></pre></td></tr></table></figure>
<h5 id="主从机同步演示"><a href="#主从机同步演示" class="headerlink" title="主从机同步演示"></a>主从机同步演示</h5><p>后续只需要在主机上对zone进行操作（增删改等），从机会自动实现同步了。如下示例：</p>
<h6 id="新增zone"><a href="#新增zone" class="headerlink" title="新增zone"></a>新增zone</h6><ol>
<li>按传统方式，在主机通过rndc动态添加一个zone。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim luxia.com.zone</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@       IN SOA  luxia.com. root.luxia.com. (</span><br><span class="line">                                        1       ; serial</span><br><span class="line">                                        1D      ; refresh</span><br><span class="line">                                        1H      ; retry</span><br><span class="line">                                        1W      ; expire</span><br><span class="line">                                        3H )    ; minimum</span><br><span class="line">        NS      ns1.luxia.com.</span><br><span class="line">        NS      ns2.luxia.com.</span><br><span class="line">ns1     IN A    10.154.5.163</span><br><span class="line">ns2     IN A    10.154.5.214</span><br><span class="line">www     IN A    1.1.1.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">chgrp named luxia.com.zone</span><br><span class="line"></span><br><span class="line">rndc addzone luxia.com '&#123;type master; file "luxia.com.zone";&#125;;'</span><br></pre></td></tr></table></figure>
<p>验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dig +short soa luxia.com @10.154.5.163  // 主机可以dig</span><br><span class="line"></span><br><span class="line">dig +short soa luxia.com @10.154.5.162 // 从机还没有同步</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>而后，利用<code>nsupdate</code>命令将luxia.com加到catalog zone，从而实现把luxia.com自动同步到从机。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt; __EOF | nsupdate</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> server 10.154.5.163</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update add 49c71169601a59cbd7f56dc8a4a1cdb335bb40d2.zones.catalog.example 3600 IN PTR luxia.com</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> send</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> __EOF</span></span><br></pre></td></tr></table></figure>
<p>验证一下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dig +short soa luxia.com @10.154.5.162 // 发现从机可以dig</span><br></pre></td></tr></table></figure>
<p>且从机出现如下文件：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">__catz___default_catalog.example_luxia.com.db</span><br></pre></td></tr></table></figure>
<p>其中，产出SHA1 的方式有两种：</p>
<p>第一种是shell命令行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">printf '\7luxia\3com\0' | openssl sha1</span><br><span class="line">// 得到(stdin)= 49c71169601a59cbd7f56dc8a4a1cdb335bb40d2</span><br></pre></td></tr></table></figure>
<p>第二种是python脚本<code>catz-add.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#使用</span></span><br><span class="line">./nzf.py luxia.com</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#nzf.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dns.name   <span class="comment"># pip install dnspython</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">print(hashlib.sha1(dns.name.from_text(sys.argv[<span class="number">1</span>]).to_wire()).hexdigest())</span><br></pre></td></tr></table></figure>
<p>最后，上述主机操作过程，可以总结为如下python语句自动执行：</p>
<p>调用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python ./catz-add.py luxia.com</span><br></pre></td></tr></table></figure>
<p>书写catz-add.py文件，使用了<code>isc.rndc</code> 和 <code>dnspython</code> 两个核心模块：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># catz-add.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> isc</span><br><span class="line"><span class="keyword">import</span> dns.query</span><br><span class="line"><span class="keyword">import</span> dns.update</span><br><span class="line"><span class="keyword">import</span> dns.name</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">ZONEPATH=<span class="string">'/tmp/'</span></span><br><span class="line">MASTER=<span class="string">'10.53.0.1'</span></span><br><span class="line">DNSPORT=<span class="number">5300</span></span><br><span class="line">RNDCPORT=<span class="number">9953</span></span><br><span class="line">RNDCALGO=<span class="string">'sha256'</span></span><br><span class="line">RNDCKEY=<span class="string">'1234abcd8765'</span></span><br><span class="line">CATZONE=<span class="string">'catalog.example'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_zone</span><span class="params">(name)</span>:</span></span><br><span class="line">   <span class="comment"># Create a stub primary file</span></span><br><span class="line">   <span class="keyword">with</span> file(<span class="string">'%s%s.zone'</span> % (ZONEPATH, name), <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">'@ 3600 IN SOA . . 1 3600 3600 3600 3600\n'</span>)    </span><br><span class="line">        f.write(<span class="string">'@ IN A 1.1.1.1\n'</span>)</span><br><span class="line">        f.write(<span class="string">'@ IN NS ns.nice.org.\n'</span>)</span><br><span class="line">        </span><br><span class="line">       <span class="comment"># Add zone to primary using RNDC</span></span><br><span class="line">   r = isc.rndc((MASTER, RNDCPORT), RNDCALGO, RNDCKEY)  </span><br><span class="line">   response = r.call(<span class="string">'addzone %s &#123;type master; file "%s%s.zone";&#125;;'</span> % (name, ZONEPATH, name))</span><br><span class="line">   <span class="keyword">if</span> response[<span class="string">'result'</span>] != <span class="string">'0'</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">"Error adding zone to master: %s"</span> % response[<span class="string">'err'</span>])</span><br><span class="line">       </span><br><span class="line">       <span class="comment"># Update catalog zone</span></span><br><span class="line">   update = dns.update.Update(CATZONE)</span><br><span class="line">   hash = hashlib.sha1(dns.name.from_text(name).to_wire()).hexdigest()</span><br><span class="line">   update.add(<span class="string">'%s.zones'</span> % hash, <span class="number">3600</span>, <span class="string">'ptr'</span>, <span class="string">'%s.'</span> % name)  </span><br><span class="line">   response = dns.query.tcp(update, MASTER, port=DNSPORT)  </span><br><span class="line">   <span class="keyword">if</span> response.rcode() != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">"Error updating catalog zone: %d"</span> % response.rcode())</span><br><span class="line"></span><br><span class="line">add_zone(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>
<h6 id="删除zone"><a href="#删除zone" class="headerlink" title="删除zone"></a>删除zone</h6><p>与新增类似，仍然借助nsupdate，先把catalog目录列表中的域名删除。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt; __EOF | nsupdate</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> server 10.154.5.163</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update delete 49c71169601a59cbd7f56dc8a4a1cdb335bb40d2.zones.catalog.example</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> send</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> __EOF</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">备注，cat&lt;&lt;EOF，指定以EOF输入字符为标准输入结束（也可以任意输入OOO,ZZZ等）</span></span><br></pre></td></tr></table></figure>
<p>再rndc方式动态删除域名。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rndc delzone luxia.com</span><br></pre></td></tr></table></figure>
<p>验证发现，发现从机的<code>__catz___default_catalog.example_luxia.com.db</code>文件消失，且dig不通。</p>
<h6 id="更改serial，实现记录更新同步"><a href="#更改serial，实现记录更新同步" class="headerlink" title="更改serial，实现记录更新同步"></a>更改serial，实现记录更新同步</h6><p>上述新增zone和删除zone的过程演示了对zone配置的自动维护（主机zone配置同步到了从机zone配置）。当有zone有更新时，可以自动同步了！</p>
<p>现在我们仍然借助nsupdate进行更新zone记录演示。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &lt;&lt; __EOF | nsupdate</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> server 10.154.5.163</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> update add www.luxia.com 3600 IN A 1.1.1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> send</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> __EOF</span></span><br></pre></td></tr></table></figure>
<p>而后</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rndc sync luxia.com // 写入磁盘文件，可以cat luxia.com.zone看到修改</span><br><span class="line"></span><br><span class="line">rndc reload</span><br></pre></td></tr></table></figure>
<p>验证，发现已经修改。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat luxia.com.zone</span><br><span class="line">dig +short soa luxia.com @10.154.5.162</span><br><span class="line">dig +short soa luxia.com @10.154.5.163</span><br></pre></td></tr></table></figure>
<h5 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h5><ol>
<li><a href="https://kb.isc.org/docs/aa-01401" target="_blank" rel="noopener">Introduction to Catalog Zones (isc.org)</a></li>
<li><a href="https://jpmens.net/2016/05/24/catalog-zones-are-coming-to-bind-9-11/" target="_blank" rel="noopener">Jan-Piet Mens :: Catalog zones in BIND 9.11 (jpmens.net)</a></li>
</ol>
<h3 id="notify"><a href="#notify" class="headerlink" title="notify"></a>notify</h3><h4 id="主从同步消息机制"><a href="#主从同步消息机制" class="headerlink" title="主从同步消息机制"></a>主从同步消息机制</h4><ol>
<li>主机修改后重启服务，会主动传送notify。</li>
<li>如果从机没有收到notify，则Refresh。</li>
<li>如果从机Refresh 不成功，则Retry。</li>
<li>如果从机Retry 一直不成功, 则Expire。</li>
<li>如果Expire也不成功，则选择放弃zone transfer。</li>
</ol>
<p>一个zone文件示例：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL 1D <span class="comment">#缓存时间</span></span></span><br><span class="line">@   IN SOA  ns1.test.com.  root.localhost. (# SOA（Start of Authority）</span><br><span class="line">    2013070814  ; serial # 版本号</span><br><span class="line">    60  ; refresh # 刷新时间</span><br><span class="line">    1H  ; retry # 刷新失败，重试更新时间</span><br><span class="line">    1W  ; expire # 刷新失败多长时间后此DNS失效时间</span><br><span class="line">    3H )    ; minimum # 域名记录最小生存时间。当用户DNS查询到记录后，将存在缓存中，至少过了这个时间才将缓存刷新重新查询。</span><br><span class="line"></span><br><span class="line">		NS  ns1.test.com.</span><br><span class="line">		NS  ns2.test.com.</span><br><span class="line">ns1 	A   1.1.1.1</span><br><span class="line">ns2 	A   2.2.2.2</span><br><span class="line"></span><br><span class="line">server  A   2.1.1.1</span><br><span class="line">--------------</span><br><span class="line"><span class="meta">$</span><span class="bash">TTL 1D</span></span><br><span class="line">@   IN SOA  域名解析服务器NS  域名管理者的电子邮件地址,第一个'.'代表电子邮件中的'@' (# SOA（Start of Authority）</span><br></pre></td></tr></table></figure>
<h4 id="notify主动发送消息的全过程"><a href="#notify主动发送消息的全过程" class="headerlink" title="notify主动发送消息的全过程"></a>notify主动发送消息的全过程</h4><img src="/want/2021/06/02/bind/notify-transfer.png" title="notify-transfer">
<ol>
<li>主机主动发送变更通知。</li>
<li>从机接收到通知，去查询主机zone文件的SOA记录。</li>
<li>主机告知从机SOA记录。</li>
<li>从机将主机拿到的SOA记录与自己本来就同步过的SOA记录进行对比，比较SOA中的serial no是否递增更新。</li>
<li>如果递增更新，从机向主机发起zone transfer请求，要求zone文件传输。</li>
<li>主机传输zone数据给从机更新。</li>
</ol>
<p>从图中可看到，涉及到的配置如下：</p>
<ol>
<li><p><code>notify yes;</code> # 【开启主动通知】</p>
</li>
<li><p><code>also-notify { 10.154.5.162; };</code> # 【被通知的从机ip】</p>
</li>
<li><code>allow-notify { 10.154.5.163; }</code>  #从机是否接收来着该主机ip的通知，因为默认接收主机ip，所以省略了。</li>
<li><code>allow-transfer { 10.154.5.162; 10.154.5.163; };</code> #【允许zone传输的机器列表】设定允许哪台主机和本地服务器进行zone传输。</li>
</ol>
<p>下面一一介绍上述配置参数。</p>
<h4 id="notify与-also-notify"><a href="#notify与-also-notify" class="headerlink" title="notify与 also-notify"></a>notify与 also-notify</h4><p>作用于主机。notify 结合 also-notify通过三种配置方式实现不同范围的通知：</p>
<ul>
<li><code>notify yes;</code><ul>
<li>sends notify to <strong>all name servers</strong> in RR  (except itself and SOA master)</li>
<li>notifies are sent to all servers appearing in the NS RRset (except the server identified in the MNAME field of the SOA record)</li>
<li>will send notifications to all of the published NS records for the domain。</li>
<li>The messages are sent to the servers listed in the <strong>zone’s name server records</strong>。</li>
<li>besides those in your <strong>zone’s NS records</strong> docstore.mik.ua/orelly/networking_2ndEd/dns/ch10_03.htm</li>
<li>使用notify指令會自動通知所有這個域的所有在ns記錄上的機器，also-notify指令可以用來通知所有不在ns記錄上的dns伺服器。<br>還是好好看文件吧，裡面還有很多有趣的功能呢。</li>
<li>默认值。默认情况下，master 不必明确配置 slave ips，会自动向zone的每个 NS 记录发送NOTIFY。</li>
</ul>
</li>
<li><code>notify yes; also-notify { x.x.x.x; y.y.y.y; };</code><ul>
<li>sends notify to <strong>x.x.x.x</strong>, <strong>y.y.y.y</strong> and <strong>all name servers</strong> in RR (except itself and SOA master).</li>
</ul>
</li>
<li><code>notify explicit; also-notify { x.x.x.x; y.y.y.y; };</code><ul>
<li>sends notify to just <strong>x.x.x.x</strong>, <strong>y.y.y.y</strong> =&gt; 仅向also-notify列出的ips发送通知</li>
</ul>
</li>
</ul>
<h5 id="NS记录"><a href="#NS记录" class="headerlink" title="NS记录"></a>NS记录</h5><p>其中，NS记录是指zone文件中指定的ns解析记录（不包括SOA主机名部分，如下不包括ns1.test.com部分），如下示例中包括ns1和ns2部分。如果想要包括soa部分，可以设置为<code>notify-to-soa yes</code>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">TTL 1D <span class="comment">#缓存时间</span></span></span><br><span class="line">@   IN SOA  ns1.test.com.  root.localhost. (# SOA（Start of Authority）</span><br><span class="line">    2013070814  ; serial # 版本号</span><br><span class="line">    60  ; refresh # 更新时间</span><br><span class="line">    1H  ; retry # 更新失败，重试更新时间</span><br><span class="line">    1W  ; expire # 更新失败多长时间后此DNS失效时间</span><br><span class="line">    3H )    ; minimum # 解析不到请求不予回复时间</span><br><span class="line"></span><br><span class="line">		NS  ns1.test.com.</span><br><span class="line">		NS  ns2.test.com.</span><br><span class="line">ns1 	A   192.168.56.104</span><br><span class="line">ns2 	A   192.168.56.105</span><br></pre></td></tr></table></figure>
<p>但存在问题：</p>
<p>新建域名时候，域名无法同步到从机（因为这个zone的NS记录还没有定）。</p>
<p>此时对域名进行ns记录操作，主机会派发notify消息，但从机则报错如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">received notify for zone &apos;wei01.com&apos;: not authoritative</span><br></pre></td></tr></table></figure>
<p>分析原因，可能因为这个zone在从机没有（因为NS地址还不知道，域名没有同步到从机），虽然接收到了更新消息但是没法更新zone.</p>
<p>目前尚未找到解决办法，只能仍然采用also-notify固定从机ip地址的方式。</p>
<p>注意修改，also-notify { 10.154.5.162; 10.154.5.214; }; 增改ip列表之后，采用rndc reload 或者 rndc reconfig重启服务即可。</p>
<p><strong>尝试失败1：</strong></p>
<p>创建域名时生成既定 NS记录 ns1.example.com，</p>
<p>且主机配置ns1.example.com 的hosts。</p>
<p>发现主机根本不会发送任何notify，从机也不会接收任何notify。</p>
<p>也就是在zone的NS记录已经定下来，且ns记录可通过hosts解析的情况下，域名仍然没有同步到从机。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">qing.com.zone</span></span><br><span class="line">@ 604800 IN SOA ns1.example.com. admin.example.com. 147 604800 86400 2419200 604800</span><br><span class="line">@ 604800 IN NS ns1.example.com.</span><br><span class="line">www 604800 IN A 1.1.1.1</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">10.154.5.162 ns1.example.com</span><br><span class="line">10.154.5.214 ns3.example.com</span><br><span class="line">10.154.5.163 ns2.example.com</span><br><span class="line"></span><br><span class="line">service network restart</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep qing.com notify.log #啥也没有</span><br></pre></td></tr></table></figure>
<p><strong>尝试失败2：</strong></p>
<p>也就是在zone的NS记录已经定下来，且ns记录配置了A地址的情况下，域名仍然没有同步到从机。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">qing.com.zone</span></span><br><span class="line">@ 604800 IN SOA ns1.example.com. admin.example.com. 147 604800 86400 2419200 604800</span><br><span class="line">@ 604800 IN NS ns1.example.com.</span><br><span class="line">www 604800 IN A 1.1.1.1</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">example.com.zone</span></span><br><span class="line">@ 604800 IN SOA ns1 admin 147 604800 86400 2419200 604800</span><br><span class="line">@ 604800 IN NS ns1</span><br><span class="line">ns1 604800 IN A 10.154.5.162</span><br><span class="line">www 604800 IN A 1.1.1.1</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep qing.com notify.log #啥也没有</span><br></pre></td></tr></table></figure>
<h5 id="also-notify【目前采用】"><a href="#also-notify【目前采用】" class="headerlink" title="also-notify【目前采用】"></a>also-notify【目前采用】</h5><p><code>also-notify</code>，可设置扩展的名字服务器IP列表，无论何时只要有更新的内容加载，都会向这个表中的IP发出NOTIFY消息。有助于zone同步到隐藏的备机服务器。also-notify 在 bind 9.9.0+ 也可支持密钥形式。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">also-notify [port gp-num] [dscp gd-num] &#123; (masters-list|IP-address )[port p-num] [dscp d-num] </span><br><span class="line">            [key key-name] ; [... ;] &#125;; [ Opt, View, Zone ] BIND 9.9+</span><br><span class="line"> </span><br><span class="line">also-notify &#123; ip_addr [port ip_port] ; ... ] &#125;; [ Opt, View, Zone ] Pre BIND 9.9</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">key trusted-key &#123;</span><br><span class="line">	algorithm HMAC-MD5;</span><br><span class="line">	secret some-secret;</span><br><span class="line">&#125;;</span><br><span class="line">view trusted &#123;</span><br><span class="line">    zone "myzone.example" &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "trusted/db.myzone.example";</span><br><span class="line">        also-notify &#123; 192.168.7.28 key trusted-key; &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a href="https://kb.isc.org/docs/aa-00851" target="_blank" rel="noopener">Understanding views in BIND 9 (isc.org)</a></p>
<h4 id="allow-notify"><a href="#allow-notify" class="headerlink" title="allow-notify"></a>allow-notify</h4><p>作用于从机。</p>
<ul>
<li>默认接收来自主机的notify消息</li>
<li>也可以手动配置来确定从机接受哪些ip地址的notify</li>
</ul>
<h3 id="allow-transfer"><a href="#allow-transfer" class="headerlink" title="allow-transfer"></a>allow-transfer</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><img src="/want/2021/06/02/bind/transfer.png" title="transfer">
<p>allow-transfer 设定哪台主机允许和本地服务器进行域传输，可以设置在 zone 语句或catalog中。有两种使用方式：</p>
<ol>
<li><p>通过主机IP来限制访问—— allow-transfer : {address_list | none}。这种方式需要写死从机ip地址。不方便从机扩缩。</p>
</li>
<li><p>通过事务签名：只允许带有密钥认证的DNS服务器同步数据配置文件。这种方式不需要从机ip地址，<strong>方便从机扩缩</strong>。</p>
</li>
</ol>
<p>其中，对于事务签名：</p>
<ol>
<li>通过密钥对数据加密。如，TSIG利用密码编码来保护区域信息的传输（Zone Transfer）</li>
<li>可分为两类：<ul>
<li>TSIG:对称方式（常用）。</li>
<li>SIGO:非对称方式。</li>
</ul>
</li>
</ol>
<p>最终，如果要实现<strong>从机的热插拔，应采用TSIG事务签名的方式</strong>，设置允许带有密钥认证的DNS服务器同步数据配置文件。</p>
<p>操作过程以及主从机分别负责的工作：</p>
<table>
<thead>
<tr>
<th>主备</th>
<th>负责工作</th>
</tr>
</thead>
<tbody>
<tr>
<td>主机</td>
<td>生成DNS服务密钥（公钥+私钥），复制生成私钥文件中的key值，到一个新建文件如tansfer.key中</td>
</tr>
<tr>
<td>主机</td>
<td>named.conf中include引入tansfer.key文件，设置allow-transfer { key 私钥key名; };</td>
</tr>
<tr>
<td>主机</td>
<td>重启named服务。</td>
</tr>
<tr>
<td>–</td>
<td>至此发现从机不能同步数据</td>
</tr>
<tr>
<td>从机</td>
<td>复制主机的tansfer.key到从机</td>
</tr>
<tr>
<td>从机</td>
<td>named.conf中include引入tansfer.key文件，设置 server  主机ip地址 { keys {私钥key名; };</td>
</tr>
<tr>
<td>–</td>
<td>至此发现从机可以同步数据</td>
</tr>
</tbody>
</table>
<h4 id="主机生成密钥"><a href="#主机生成密钥" class="headerlink" title="主机生成密钥"></a>主机生成密钥</h4><p>dnssec-keygen命令用于生成安全的DNS服务密钥，其格式为“dnssec-keygen [参数]”</p>
<ol>
<li>-a : 加密算法，包括RSAMD5（RSA）、RSASHA1、DSA、NSEC3RSASHA1、NSEC3DSA等</li>
<li>-b : 密钥长度，HMAC-MD5的密钥长度在1~512位之间</li>
<li>-n : 密钥类型，可以选择ZONE或者HOST，HOST表示与主机相关</li>
<li>dnssec-transfer:密钥名称自定义</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">生成一个主机名称为dnssec-transfer的128位HMAC-MD5算法的密钥文件（公钥+私钥）</span></span><br><span class="line">dnssec-keygen -a HMAC-MD5 -b 128 -n HOST  dnssec-transfer</span><br><span class="line"><span class="meta">#</span><span class="bash">得到Kdnssec-transfer.+157+54187</span></span><br><span class="line"></span><br><span class="line">ls -al Kdnssec-transfer.+157+54187.*</span><br><span class="line"><span class="meta">#</span><span class="bash">-rw------- 1 root root  59 Jun 18 16:05 Kdnssec-transfer.+157+54187.key <span class="comment">#公钥</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">-rw------- 1 root root 165 Jun 18 16:05 Kdnssec-transfer.+157+54187.private <span class="comment">#私钥</span></span></span><br><span class="line"></span><br><span class="line">cat Kdnssec-transfer.+157+54187.private</span><br><span class="line"><span class="meta">#</span><span class="bash">复制key参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Key: /y7HAkwBH0KP9g9M+jADJg==</span></span><br></pre></td></tr></table></figure>
<p>将私钥key放到一个新的文件中，并将这个文件引入到named.conf中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /etc/opt/isc/isc-bind/ 或 cd /etc/  #密钥验证文件在/etc目录(与named.conf同一个目录下)</span><br><span class="line"></span><br><span class="line">vim transfer.key</span><br><span class="line">key "dnssec-transfer" &#123;                                     #密钥名称</span><br><span class="line">    algorithm hmac-md5;                                      #加密算法</span><br><span class="line">    secret "/y7HAkwBH0KP9g9M+jADJg==";                       #私钥加密字符串</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">chown root:named transfer.key                            #把文件所属组改为named，降低权限</span><br><span class="line">chmod 640 transfer.key </span><br><span class="line"></span><br><span class="line">vim /etc/named.conf</span><br><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line">allow-transfer &#123; key dnssec-transfer; &#125;;  #只允许拥有该密钥验证文件的人进行同步</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart named  </span><br><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<h4 id="从机引用密钥"><a href="#从机引用密钥" class="headerlink" title="从机引用密钥"></a>从机引用密钥</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scp /etc/transfer.key root@从机ip地址:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line"></span><br><span class="line">scp /etc/transfer.key root@10.154.5.214:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line">scp /etc/transfer.key root@10.154.5.162:/etc/opt/isc/isc-bind/transfer.key</span><br><span class="line"></span><br><span class="line">chown root:named transfer.key</span><br><span class="line">chmod 640 transfer.key</span><br></pre></td></tr></table></figure>
<p>named.conf文件：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">不属于全局options</span></span><br><span class="line">server 10.154.5.163 &#123; # 主机ip地址</span><br><span class="line"> 	keys &#123; dnssec-transfer; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>重启从服务器的Bind服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<p>发现已经同步过来了。</p>
<h4 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="https://bind9.readthedocs.io/en/v9_16_6/advanced.html" target="_blank" rel="noopener">5. Advanced DNS Features — BIND 9 documentation</a></li>
<li><a href="http://www.zytrax.com/books/dns/ch7/xfer.html#allow-transfer" target="_blank" rel="noopener">BIND9 named.conf Zone Transfer and Update statements (zytrax.com)</a></li>
</ol>
<h3 id="bind9-16安装配置"><a href="#bind9-16安装配置" class="headerlink" title="bind9.16安装配置"></a>bind9.16安装配置</h3><h4 id="9-16安装"><a href="#9-16安装" class="headerlink" title="9.16安装"></a>9.16安装</h4><p>不同版本centos系统的yum源包含了不同版本的bind，各版本略有差异。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装yum自带<span class="built_in">bind</span>版本，直接执行命令即可</span></span><br><span class="line">yum install bind bind-utils xxxxx</span><br></pre></td></tr></table></figure>
<p>但如果想要忽略centos版本，直接安装最新的bind，需要做如下操作：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line">vim bind.repo</span><br><span class="line">[copr:copr.fedorainfracloud.org:isc:bind]</span><br><span class="line">name=Copr repo for bind owned by isc</span><br><span class="line">baseurl=https://download.copr.fedorainfracloud.org/results/isc/bind/epel-7-$basearch/</span><br><span class="line">type=rpm-md</span><br><span class="line">skip_if_unavailable=True</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://download.copr.fedorainfracloud.org/results/isc/bind/pubkey.gpg</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line"></span><br><span class="line">enabled=1</span><br><span class="line">enabled_metadata=1</span><br><span class="line"></span><br><span class="line">yum list isc-bind*</span><br><span class="line"></span><br><span class="line">yum install isc-bind-bind isc-bind-bind-utils isc-bind-bind-libs -y</span><br><span class="line"></span><br><span class="line">守护进程文件位置：/etc/opt/isc/isc-bind/sysconfig/named</span><br><span class="line">配置文件位置：/etc/opt/isc/isc-bind/named.conf</span><br><span class="line">发现有如下内容：</span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/opt/isc/isc-bind/named/data";</span><br><span class="line">        listen-on &#123; 127.0.0.1; &#125;;</span><br><span class="line">        listen-on-v6 &#123; ::1; &#125;;</span><br><span class="line">        dnssec-validation auto;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "named.run";</span><br><span class="line">                print-time yes;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">尝试启动，发现成功</span><br><span class="line">systemctl start isc-bind-named</span><br><span class="line">systemctl enable isc-bind-named</span><br><span class="line">systemctl status isc-bind-named</span><br></pre></td></tr></table></figure>
<p>安装过程可能确实某些安装包，可以自行安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/scl-utils-20130529-19.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum install scl-utils-build-20130529-19.el7.x86_64.rpm -y</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> iso-codes</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/iso-codes-3.46-2.el7.noarch.rpm</span><br><span class="line">yum install iso-codes-3.46-2.el7.noarch.rpm -y</span><br></pre></td></tr></table></figure>
<p>安装包下载网站</p>
<ol>
<li><a href="https://pkgs.org/download/iso-codes" target="_blank" rel="noopener">Iso-codes Download (APK, DEB, EOPKG, RPM, TGZ, TXZ, XZ, ZST) (pkgs.org)</a></li>
<li><a href="https://centos.pkgs.org/7/centos-x86_64/scl-utils-20130529-19.el7.x86_64.rpm.html" target="_blank" rel="noopener">scl-utils-20130529-19.el7.x86_64.rpm CentOS 7 Download (pkgs.org)</a></li>
<li><a href="http://www.rpmfind.net/linux/rpm2html/search.php?query=telnet" target="_blank" rel="noopener">RPM resource telnet (rpmfind.net)</a></li>
</ol>
<h4 id="9-16配置"><a href="#9-16配置" class="headerlink" title="9.16配置"></a>9.16配置</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">在物理机/etc/profile.d/⽬录下创建isc-bind-named.sh⽂件。并输⼊以下内容，保存。</span><br><span class="line">然后重启物理机即可。</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">source scl_source enable isc-bind</span><br><span class="line"></span><br><span class="line">或临时方案</span><br><span class="line">scl enable isc-bind bash</span><br><span class="line">rndc</span><br><span class="line"></span><br><span class="line">---------------------</span><br><span class="line">rndc-confgen 配置rndc (当同时存在rndc.conf文件和rndc.key文件的时候，默认是优先读取rndc.conf)</span><br><span class="line">----------------------</span><br><span class="line">dnssec-keygen 配置transfer-key</span><br><span class="line">----------------------</span><br></pre></td></tr></table></figure>
<h5 id="主机-1"><a href="#主机-1" class="headerlink" title="主机"></a>主机</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">secret和algorithm等，配置到python程序中</span></span><br><span class="line">key rndc-key &#123;</span><br><span class="line">        algorithm hmac-md5;</span><br><span class="line">        secret "rf27GDGjr6J2rRK5Ljsq2Q==";</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include "/etc/opt/isc/isc-bind/transfer.key";</span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/opt/isc/isc-bind/named/data";</span><br><span class="line">        listen-on port 53 &#123; 127.0.0.1; 10.154.5.163; &#125;;</span><br><span class="line">        #listen-on-v6 &#123; ::1; &#125;;</span><br><span class="line">        dnssec-validation auto;</span><br><span class="line"></span><br><span class="line">        allow-query &#123; any; &#125;; #所有都可以查询</span><br><span class="line">        allow-update &#123; any; &#125;;</span><br><span class="line">        allow-transfer &#123;10.154.5.163; key dnssec-transfer; &#125;; #9.11版本不需要本机ip，但9.16必须本机ip</span><br><span class="line">        notify yes;</span><br><span class="line">        also-notify &#123; 10.154.5.162; 10.154.5.214; &#125;;</span><br><span class="line">        allow-new-zones yes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.163 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 要*，any，否则python程序无法rndc</span></span><br><span class="line">controls &#123;</span><br><span class="line">       inet * port 953</span><br><span class="line">       allow &#123; any; &#125; keys &#123; "rndc-key"; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "named.run";</span><br><span class="line">                print-time yes;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file "catalog.default.zone";</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">named-checkconf 验证配置</span><br><span class="line">named-checkzone catalog.default catalog.default.zone</span><br></pre></td></tr></table></figure>
<p>注意controls配置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 监听网卡（inet）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许IP（allow）</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 认证使用的keys**</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果要*，any，则监听机器上的所有网卡\并允许所有的来源IP进行访问(带key)</span></span><br><span class="line">controls &#123;</span><br><span class="line">       inet * port 953</span><br><span class="line">       allow &#123; any; &#125; keys &#123; "rndc-key"; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种限制了在局域网和本机上使用rndc，如果有多个inet需要指定监听则需要分开多条配置  </span></span><br><span class="line">controls &#123;</span><br><span class="line">        inet 127.0.0.1 allow &#123; localhost; &#125; keys &#123; rndckey; &#125;;</span><br><span class="line">        inet 192.168.1.1 port 1953 allow &#123; 192.168.1.1; 192.168.1.2; 192.168.1.0/24;&#125; keys &#123; rndckey; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="从机-1"><a href="#从机-1" class="headerlink" title="从机"></a>从机</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">key "rndc-key" &#123;</span><br><span class="line">        algorithm hmac-sha256;</span><br><span class="line">        secret "bshuXqh379VDuCYQqWJY68F1rkCEsf5LLfc274USvZQ=";</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">options &#123;</span><br><span class="line">        directory "/var/opt/isc/isc-bind/named/data/slaves"; # 配置文件中所有使用的相对路径，都在该配置目录下。大多数服务器的输出文件（如named.run）都缺省生成在这个目录下。</span><br><span class="line">        listen-on port 53 &#123; 127.0.0.1; 10.154.5.214; 10.154.5.163; &#125;; # 监听本机所有地址及主机地址的53端口。</span><br><span class="line">        #listen-on-v6 &#123; ::1; &#125;;</span><br><span class="line">        dnssec-validation auto;</span><br><span class="line"></span><br><span class="line">        allow-query &#123; any; &#125;;#设定哪个主机可以进行普通的查询。所有主机都可以进行查询。</span><br><span class="line">        allow-update &#123; any; &#125;; # 设定哪台主机允许为主域名服务器提交动态DNS更新。默认为拒绝任何主机进行更新。</span><br><span class="line">        allow-transfer &#123;any;&#125;;</span><br><span class="line">        allow-new-zones yes;</span><br><span class="line">        masterfile-format text;</span><br><span class="line">        #用于备机</span><br><span class="line">        catalog-zones &#123;</span><br><span class="line">                zone "catalog.default"  default-masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.214 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> controls &#123;</span><br><span class="line">       inet 127.0.0.1 port 953</span><br><span class="line">               allow &#123; 127.0.0.1; &#125; keys &#123; "rndc-key"; &#125;;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "named.run";</span><br><span class="line">                print-time yes;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#</span><span class="bash">用于备机</span></span><br><span class="line">zone "catalog.default" &#123;</span><br><span class="line">        type slave;</span><br><span class="line">        file "catalog.default.zone";</span><br><span class="line">        masters &#123; 10.154.5.163; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>从机配置同步数据所在目录slaves</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /var/opt/isc/isc-bind/named/data</span><br><span class="line">mkdir slaves</span><br><span class="line">chown named.named slaves</span><br><span class="line"></span><br><span class="line">systemctl restart isc-bind-named</span><br></pre></td></tr></table></figure>
<h4 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h4><ol>
<li><p><a href="https://www.fdzh.org/" target="_blank" rel="noopener">Fedora中文社区 - fdzh.org</a></p>
</li>
<li><p><a href="https://copr.fedorainfracloud.org/coprs/isc/bind/" target="_blank" rel="noopener">isc/bind Copr</a></p>
</li>
<li>ftp方式（源码安装）下载地址：<a href="https://www.linuxfromscratch.org/blfs/view/svn/server/bind.html" target="_blank" rel="noopener">BIND-9.16.16 (linuxfromscratch.org)</a></li>
</ol>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><h4 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h4><p>BIND默认把日志写到<code>/var/log/messages</code>。如果需要更详细的日志，需要自行配置named.conf的logging模块。</p>
<h4 id="参数及说明"><a href="#参数及说明" class="headerlink" title="参数及说明"></a>参数及说明</h4><p>在日志配置中主要有channel（通道）、category（类别）二种定义:</p>
<ol>
<li>channel，通道指定了应该向哪里发送日志数据——是发送给syslog，还是写在一个文件里，或是发送给named的标准错误输出，还是发送到位存储桶（bit bucket)。<ul>
<li>severity，系统会记录包括该级别以及比该级别更严重的级别的所有消息。比如定义级别为error，则会记录critical和error 两个级别的信息。一般情况下，我们记录到info级别就可以了</li>
<li>print-time是设定在日志中是否需要写入【时间】</li>
<li>print-severity是设定在日志中是否需要写入【消息级别】</li>
<li>print-category是设定在日志中是否需要写入【日志类别】。</li>
</ul>
</li>
<li>category，类别规定了哪些数据需要记录<ul>
<li>default ：【所有categories的默认目标】default类别匹配所有未明确指定通道的类别，但是不匹配不属于任何类别的消息。这些不属于任何类别的消息属于下面列出的这些类别。</li>
<li>general    包括所有未明确分类的BIND消息。</li>
<li>client    处理客户端请求。</li>
<li>config    配置文件分析和处理。</li>
<li>database  同BIND内部数据库相关的消息，用来存储区数据和缓存记录。</li>
<li>dnssec    处理DNSSEC签名的响应。</li>
<li>lame-servers  发现错误授权。</li>
<li>network    网络操作</li>
<li>notify    异步区变动通知。</li>
<li>queries    查询日志</li>
<li>resolver    名字解析，包括对来自解析器的递归查询的处理。</li>
<li>security    认可/非认可的请求。</li>
<li>update    动态更新事件。</li>
<li>xfer-in    从远程名字服务器到本地名字服务器的区传送。</li>
<li>xfer-out    从本地名字服务器到远程名字服务器的区传送。</li>
</ul>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">named.conf</span></span><br><span class="line">logging &#123;</span><br><span class="line">    [ channel channel_name &#123;</span><br><span class="line">        ( file path_name</span><br><span class="line">          [ versions ( number | unlimited ) ]</span><br><span class="line">          [ size size_spec ]</span><br><span class="line">        | syslog syslog_facility</span><br><span class="line">        | stderr</span><br><span class="line">        | null );</span><br><span class="line">        [ severity (critical | error | warning | notice | info | debug [ level ] | dynamic ); ]</span><br><span class="line">        [ print-category yes or no; ]</span><br><span class="line">        [ print-severity yes or no; ]</span><br><span class="line">        [ print-time yes or no; ]</span><br><span class="line">    &#125;; ]</span><br><span class="line">    [ category category_name &#123;</span><br><span class="line">        channel_name ; [ channel_name ; ... ]</span><br><span class="line">    &#125;; ]</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">named.conf</span></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file "named.run";</span><br><span class="line">                print-time yes;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">     channel access_log &#123;</span><br><span class="line">        file "/var/log/named/access.log" versions 100 size 100M;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-category yes;</span><br><span class="line">        print-severity yes;</span><br><span class="line">        print-time yes;</span><br><span class="line">        buffered yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    category default &#123;</span><br><span class="line">        access_log;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="一个常用参考"><a href="#一个常用参考" class="headerlink" title="一个常用参考"></a>一个常用参考</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">logging &#123;</span><br><span class="line"> channel default_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/default.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel general_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/general.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel database_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/database.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel security_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/security.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel config_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/config.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel resolver_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/resolver.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-in_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-in.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel xfer-out_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/xfer-out.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel notify_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/notify.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel client_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/client.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel unmatched_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/unmatched.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel queries_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/queries.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel network_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/network.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel update_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/update.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dispatch_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dispatch.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel dnssec_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/dnssec.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line">    channel lame-servers_file &#123;</span><br><span class="line">        file "/var/opt/isc/isc-bind/log/lame-servers.log" versions 3 size 5m;</span><br><span class="line">        severity dynamic;</span><br><span class="line">        print-time yes;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    category default &#123; default_file; &#125;;</span><br><span class="line">    category general &#123; general_file; &#125;;</span><br><span class="line">    category database &#123; database_file; &#125;;</span><br><span class="line">    category security &#123; security_file; &#125;;</span><br><span class="line">    category config &#123; config_file; &#125;;</span><br><span class="line">    category resolver &#123; resolver_file; &#125;;</span><br><span class="line">    category xfer-in &#123; xfer-in_file; &#125;;</span><br><span class="line">    category xfer-out &#123; xfer-out_file; &#125;;</span><br><span class="line">    category notify &#123; notify_file; &#125;;</span><br><span class="line">    category client &#123; client_file; &#125;;</span><br><span class="line">    category unmatched &#123; unmatched_file; &#125;;</span><br><span class="line">    category queries &#123; queries_file; &#125;;</span><br><span class="line">    category network &#123; network_file; &#125;;</span><br><span class="line">    category update &#123; update_file; &#125;;</span><br><span class="line">    category dispatch &#123; dispatch_file; &#125;;</span><br><span class="line">    category dnssec &#123; dnssec_file; &#125;;</span><br><span class="line">    category lame-servers &#123; lame-servers_file; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述参考中把日志按照category类别进行了详细的分类，分不到/var/opt/isc/isc-bind/log/目录下不同的日志文件中。可采用如下脚本进行生成：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim namelist.txt</span></span><br><span class="line">default.log</span><br><span class="line">general.log</span><br><span class="line">database.log</span><br><span class="line">security.log</span><br><span class="line">config.log</span><br><span class="line">resolver.log</span><br><span class="line">xfer-in.log</span><br><span class="line">xfer-out.log</span><br><span class="line">notify.log</span><br><span class="line">client.log</span><br><span class="line">unmatched.log</span><br><span class="line">queries.log</span><br><span class="line">network.log</span><br><span class="line">update.log</span><br><span class="line">dispatch.log</span><br><span class="line">dnssec.log</span><br><span class="line">lame-servers.log</span><br></pre></td></tr></table></figure>
<p>bash createlog.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">printf "*************************************\n"</span><br><span class="line">echo " cat file whiel read line"</span><br><span class="line">cat namelist.txt |while read line</span><br><span class="line">do</span><br><span class="line">echo $line;</span><br><span class="line"></span><br><span class="line">touch $line;</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">chown named.named -R ../log</span><br></pre></td></tr></table></figure>
<h4 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="https://kb.isc.org/docs/aa-01526" target="_blank" rel="noopener">BIND Logging - some basic recommendations (isc.org)</a></li>
<li><a href="http://www.zytrax.com/books/dns/ch7/logging.html" target="_blank" rel="noopener">DNS BIND9 logging Clause (zytrax.com)</a></li>
<li><a href="https://stackoverflow.com/questions/11153958/how-to-enable-named-bind-dns-full-logging" target="_blank" rel="noopener">How to enable named/bind/DNS full logging? - Stack Overflow</a></li>
</ol>
<h3 id="keepalived"><a href="#keepalived" class="headerlink" title="keepalived"></a>keepalived</h3><p>DNS BIND主从结构虽然能够实现DNS的主备，但是无法使用统一的IP对外服务。</p>
<p>因此，引入LVS进行负载均衡，多台DNS服务器都配置统一的VIP作为业务IP，统一对外服务。</p>
<p>使用VIP可以让用户不知道实际DNS的情况下进行解析，同时DNS服务器可以增加到2台以上做一个更大的群组，提高可靠性。</p>
<h4 id="问题1：vip转移抢占与非抢占"><a href="#问题1：vip转移抢占与非抢占" class="headerlink" title="问题1：vip转移抢占与非抢占"></a>问题1：vip转移抢占与非抢占</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">抢占：通常如果master服务死掉后backup会变成master，但是当master服务又好了的时候，master此时会抢占VIP（因为master优先级高，会抢回来）</span><br><span class="line"></span><br><span class="line">非抢占式：MASTER恢复后不抢占BACKUP升级为MASTER后的VIP</span><br><span class="line"></span><br><span class="line">抢占式会多一次多余的vip切换，对业务繁忙的网站来说是不好的。所以我们要在配置文件加入nopreempt非抢占，但是这个参数只能用于state为backup，</span><br><span class="line">故我们在用HA的时候最好将master和backup的state都设置成backup，优先级高的设置为nopreempt，来解决master异常恢复后再次抢占的问题。</span><br><span class="line"></span><br><span class="line">不抢占模式，优先级则失去作用。谁先启动谁就是MASTER，失败后必须杀死当前keepalived进程，再次重启不会立即抢占资源。实际场合中推荐使用该方式而不是使用优先级的抢占模式。抢占模式会出现一些数据同步的问题。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置非抢占后，我们要注意启动服务的顺序，【优先启动】的获取master权限，【与优先级】没有关系了。</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th></th>
<th><strong>state</strong></th>
<th><strong>nopreempt</strong></th>
<th><strong>priority</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>主机</td>
<td><strong>backup</strong></td>
<td>设置</td>
<td><strong>100</strong></td>
</tr>
<tr>
<td>从机</td>
<td><strong>backup</strong></td>
<td>不设置</td>
<td>95</td>
</tr>
</tbody>
</table>
<p>修改M，B服务器的  state BACKUP 都为【备】类型，同时设置 nopreempt  设置为不抢夺VIP，然后先启动M服务器，M服务器会成为【主】。然后启动B服务器，由于M的优先级高【priority 100】 所以B不会抢夺VIP，这时M宕机，B成为【主】，接着M恢复正常，由于设置了nopreempt 所以M不会抢夺VIP，B继续为【主】而M为【备】。</p>
<p>此时即使B又故障了，M也不会抢夺回来。</p>
<h4 id="问题1："><a href="#问题1：" class="headerlink" title="问题1："></a>问题1：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">protocol TCP</span><br><span class="line">protocol UDP</span><br><span class="line">这两个，同时使用？还是用哪个？</span><br><span class="line">目前调研</span><br><span class="line">	同时都用的：</span><br><span class="line">	http://archive.linuxvirtualserver.org/html/lvs-users/2004-06/msg00104.html</span><br><span class="line">	https://serverfault.com/questions/763195/lvs-dns-load-balancing-on-machine-with-only-1-nic</span><br></pre></td></tr></table></figure>
<p>结论：同时使用。</p>
<p>只用UDP的，大部分中文博客</p>
<p><a href="https://www.cnblogs.com/fatt/p/4428273.html" target="_blank" rel="noopener">Lvs+Keepalived+Bind+web构建高可用负载均衡系统 - Fatt - 博客园 (cnblogs.com)</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">如果UDP，则只能使用rr算法</span><br><span class="line">如果UDP，LVS对UPD没有自带的检测功能，需要自己用MISC_CHECK写检查脚本,用于检测失败后发送通知或重试等</span><br><span class="line">MISC_CHECK检测大有两类：</span><br><span class="line">一类是针对端口的检测，如检测real server的udp 53端口启用与否</span><br><span class="line">一类是针对bind服务器的检测，如检测real server上bind服务器是否真的启用，且能够dig成功</span><br><span class="line"></span><br><span class="line">       # MISC_CHECK &#123; #指定脚本监测</span><br><span class="line">        #   misc_path &quot;/etc/keepalived/dnscheck.sh -h 192.168.0.12&quot;</span><br><span class="line">        #   misc_timeout 6</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       # 已知一个内置的域名ldap.xiguacity.cn，直接dig尝试是否成功</span><br><span class="line">       real_server 10.1.2.104 53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">        misc_path &quot;/usr/bin/dig ldap.xiguacity.cn @10.1.2.104 +time=1 +tries=3 +fail &gt;/dev/null&quot;</span><br><span class="line">        misc_timeout 6</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>MISC_CHECK主要根据检查脚本返回值来判断。</p>
<p>1） 当脚本返回值为0，表示真实服务器正常。</p>
<p>2） 当脚本返回值为1，表示真实服务器故障。</p>
<p>3） 当脚本返回值为2-255，表示当故障时将真实服务器权重改为返回值减2。</p>
<p>注意当脚本返回值为2-255时需添加misc_dynamic属性才生效。</p>
<p>只用TCP的</p>
<p>增加了notify_down和notify_up对lvs进行手动检测</p>
<p><a href="http://bb.co/2006/load_balancing_/" target="_blank" rel="noopener">Load balancing DNS with keepalived | Bill Boebel (bb.co)</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">virtual_server 192.168.254.100 80 &#123;</span><br><span class="line">    delay_loop 6                #设置运行情况检查时间，单位是秒</span><br><span class="line">    lb_algo rr                   #设置负载调度算法，这里设置为rr，即轮询算法</span><br><span class="line">    lb_kind DR                  #设置LVS实现负载均衡的机制，有NAT、TUN、DR三个模式可选</span><br><span class="line">    persistence_timeout 0      #会话保持时间，单位是秒。保持客户端的请求在这个时间段内全部发到同一个真实服务器。这个选项对动态网页是非常有用的，为集群系统中的session共享提供了一个很好的解决方案。</span><br><span class="line">                                  #有了这个会话保持功能，用户的请求会被一直分发到某个服务节点，直到超过这个会话的保持时间。</span><br><span class="line">                                  #需要注意的是，这个会话保持时间是最大无响应超时时间，也就是说，用户在操作动态页面时，如果50秒内没有执行任何操作</span><br><span class="line">                                 #那么接下来的操作会被分发到另外的节点，但是如果用户一直在操作动态页面，则不受50秒的时间限制</span><br><span class="line">    protocol TCP     #指定转发协议类型，有TCP和UDP两种</span><br><span class="line"></span><br><span class="line">    real_server 192.168.254.15 80 &#123;</span><br><span class="line">        weight 1                  #配置服务节点的权值，权值大小用数字表示，数字越大，权值越高，设置权值大小可以为不同性能的服务器</span><br><span class="line">                                  #分配不同的负载，可以为性能高的服务器设置较高的权值，而为性能较低的服务器设置相对较低的权值，这样才能合理地利用和分配系统资源</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3       #表示3秒无响应超时</span><br><span class="line">            nb_get_retry 3          #表示重试次数</span><br><span class="line">            delay_before_retry 3   #表示重试间隔</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.254.16 80 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时都用的</p>
<p><a href="https://wiki2.xbits.net:4430/linux:keepalived:lvs-dns" target="_blank" rel="noopener">lvs-dns - keepalived - linux [Knowledge Base] (xbits.net)</a></p>
<p><a href="https://wenku.baidu.com/view/5e7a5f90c8d376eeaeaa31b9.html" target="_blank" rel="noopener">DNS服务器LVS方式负载均衡部署与测试 - 百度文库 (baidu.com)</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">virtual_server 192.168.130.111 53 &#123;</span><br><span class="line">  delay_loop 6</span><br><span class="line">  lb_algo wrr</span><br><span class="line">  lb_kind NAT</span><br><span class="line">  nat_mask 255.255.255.0</span><br><span class="line">  protocol TCP</span><br><span class="line">  real_server 10.1.110.201 53 &#123;</span><br><span class="line">    weight 100</span><br><span class="line">    TCP_CHECK &#123;</span><br><span class="line">      connect_timeout 3</span><br><span class="line">      connect_port 53</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  real_server 10.1.110.203 53 &#123;</span><br><span class="line">    weight 100</span><br><span class="line">    TCP_CHECK &#123;</span><br><span class="line">      connect_timeout 3</span><br><span class="line">      connect_port 53</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">! dns VIP for udp connections</span><br><span class="line">virtual_server 192.168.130.111 53 &#123;</span><br><span class="line">  delay_loop 6</span><br><span class="line">  lb_algo wrr</span><br><span class="line">  lb_kind NAT</span><br><span class="line">  nat_mask 255.255.255.0</span><br><span class="line">  protocol UDP</span><br><span class="line">  real_server 10.1.110.201 53 &#123;</span><br><span class="line">    weight 100</span><br><span class="line">  &#125;</span><br><span class="line">  real_server 10.1.110.203 53 &#123;</span><br><span class="line">    weight 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基础概念：</p>
<ol>
<li>负载均衡：多台服务器同时、分摊工作。nginx。</li>
<li>高可用：主机一力承担工作。当主机故障时，从机接替工作。keepalived。</li>
</ol>
<p>两个方案的选择：</p>
<ol>
<li>仅高可用：自建DNS常用在公司内部平台之间的调用，所以负载均衡的意义并不是太大，高可用有必要。<ul>
<li>keepalived （keepalived 的高可用是通过<code>VRRP(virtual route redundancy protocol)</code>实现的）</li>
</ul>
</li>
<li>负载均衡+高可用：<ul>
<li>keepalived + (LVS 、HAProxy 、Nginx等负载均衡方案)</li>
</ul>
</li>
</ol>
<p><strong>Protocol transport（维基百科<a href="https://en.wikipedia.org/wiki/Domain_Name_System#Protocol_transport" target="_blank" rel="noopener">Domain Name System - Wikipedia</a>）</strong>：</p>
<p>DNS primarily uses the User Datagram Protocol (UDP) on port number 53 to serve requests. </p>
<p>DNS queries consist of a single UDP request from the client followed by a single UDP reply from the server. </p>
<p>The Transmission Control Protocol (TCP) is used when the response data size exceeds 512 bytes, or for tasks such as zone transfers. Some resolver implementations use TCP for all queries.</p>
<p>DNS 通常在 UDP 端口 53 和 TCP 端口 53 上侦听查询。</p>
<p>DNS占用53号端口，同时使用TCP和UDP协议，关键区分在于数据包大小，如果数据包小到一定程度，UDP 协议绝对最佳的选择，但是当数据包逐渐增大直到突破 512 字节以及 MTU 1500 字节的限制时，我们也只能选择使用更可靠的 TCP 协议来传输 DNS 查询和相应。</p>
<ol>
<li>TCP：DNS在区域传输的时候使用TCP协议<ul>
<li>因为数据传输传送的数据量比一个请求应答的数据量要多得多</li>
<li>TCP是一种可靠连接，保证了数据的准确性——DNS 查询由于 DNSSEC 和 IPv6 的引入迅速膨胀，需要依靠更加可靠的 TCP 协议完成数据的传输</li>
<li>随着 DNS 查询中包含的数据不断增加，TCP 协议头以及三次握手带来的额外开销比例逐渐降低，不再是占据总传输数据大小的主要部分</li>
</ul>
</li>
<li>UDP：非区域传输时都使用UDP协议<ul>
<li>DNS 查询的数据包较小、机制简单——客户端向DNS服务器查询域名（域名解析），一般返回的内容都不超过512字节，用UDP传输即可。</li>
<li>UDP 协议的额外开销小、有着更好的性能表现——UDP不用经过三次握手，这样DNS服务器负载更低，响应更快。理论上说，客户端也可以指定向DNS服务器查询时用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。</li>
</ul>
</li>
</ol>
<p>LVS 可以简单地在一组 DNS 服务器之间对 UDP 端口 53 和 TCP 端口 53 进行负载均衡，而无需设置任何持久性选项。</p>
<p>Keepalived 本质上是 LVS的包装器， LVS 支持 TCP 和 UDP 流量的负载平衡。 （keepalived 还包括 VRRP 和 Healthchecks，但这是题外话）幸运的是，除了 UDP 之外，DNS 服务器碰巧还侦听 TCP 连接。他们这样做是为了处理大于 512 字节的旧 RFC 限制的查询。</p>
<p>配置 keepalived 以负载平衡 TCP 端口 53，就像您对任何其他 TCP 端口（例如 http 或 smtp）进行负载平衡一样。然后使用keepalived的notify_up/notify_down脚本调用功能手动配置LVS，对对应的UDP端口进行负载均衡。</p>
<p>keepalived 高可用示意图(Keepalived 作为 LVS 的有效补充可以构建一个高可用的 LB 前端)：</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210624200408291.png" alt="image-20210624200408291"></p>
<p><img src="https://assets.digitalocean.com/articles/high_availability/ha-diagram-animated.gif" alt="High Availability diagram"></p>
<p><img src="https://severalnines.com/sites/default/files/blog/node_5206/image3.jpg" alt="img"><img src="https://severalnines.com/sites/default/files/blog/node_5206/image1.jpg" alt="img"></p>
<p>2台服务器做LVS+keepalived。其中，</p>
<ul>
<li>master和一台real_server在一台服务器</li>
<li>backup和一台real_server在一台机器上</li>
</ul>
<p>按理来说，keepalive+lvs应该部署在独立的机器上。</p>
<table>
<thead>
<tr>
<th>节点类型</th>
<th>主机名</th>
<th>IP地址</th>
<th>网络类型</th>
<th>bind主从</th>
</tr>
</thead>
<tbody>
<tr>
<td>realserver</td>
<td>fnc03</td>
<td>10.154.5.214</td>
<td></td>
<td>从</td>
</tr>
<tr>
<td>realserver</td>
<td>fnc04</td>
<td>10.154.5.162</td>
<td></td>
<td>从</td>
</tr>
<tr>
<td>VIP</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>keepalive+lvs MASTER，VIP占用</td>
<td>fnc04</td>
<td>10.154.5.162</td>
<td></td>
<td></td>
</tr>
<tr>
<td>keepalive+lvs BACKUP</td>
<td>fnc03</td>
<td>10.154.5.214</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>fnc05</td>
<td>10.154.5.163</td>
<td></td>
<td>主机</td>
</tr>
</tbody>
</table>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210625171855513.png" alt="image-20210625171855513"></p>
<p><a href="http://bbs.chinaunix.net/thread-2306244-1-1.html" target="_blank" rel="noopener">LVS+keepalived访问网页特别慢，求解。 - 集群和高可用-Chinaunix</a></p>
<p>实现过程：</p>
<ol>
<li>当 Master 与 Slave 均运作正常时, Master负责服务，Slave负责Standby；</li>
<li>当 Master 挂掉，Slave 正常时, Slave接管服务；</li>
<li>当 Master 恢复正常，恢复Master身份</li>
<li>然后依次循环。需要注意的是修改数据只能在Master修改。</li>
</ol>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><h5 id="在线安装"><a href="#在线安装" class="headerlink" title="在线安装"></a>在线安装</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下载</span></span><br><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">版本</span></span><br><span class="line">keepalived --version</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当前状态</span></span><br><span class="line">systemctl status keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">设置开机自动启动</span></span><br><span class="line">systemctl enable keepalived.service</span><br></pre></td></tr></table></figure>
<p>如果下载失败，且是yum源的问题，如下可以更改yum源为aliyun。</p>
<p>如果只是临时使用aliyun，记得还原。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">安装base reop源</span><br><span class="line"><span class="meta"> #</span><span class="bash"> <span class="built_in">cd</span> /etc/yum.repos.d/</span></span><br><span class="line"> 接着备份旧的配置文件</span><br><span class="line"><span class="meta"> #</span><span class="bash"> mv CentOS-Base.repo CentOS-Base.repo_back</span></span><br><span class="line"> 下载阿里源的文件</span><br><span class="line"><span class="meta"> #</span><span class="bash"> wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line"> </span><br><span class="line">如果wget命令不生效，说明还没有安装wget工具，在备份旧的配置文件之前输入 yum -y install wget 进行安装。</span><br><span class="line">安装epel repo源：</span><br><span class="line"> epel(RHEL 7)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"> epel(RHEL 6)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-6.repo</span></span><br><span class="line"> epel(RHEL 5)</span><br><span class="line"><span class="meta"> #</span><span class="bash"> wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-5.repo</span></span><br><span class="line"> </span><br><span class="line">清理缓存</span><br><span class="line"><span class="meta"> #</span><span class="bash"> yum clean all</span></span><br><span class="line"> </span><br><span class="line">重新生成缓存</span><br><span class="line"><span class="meta"> #</span><span class="bash"> yum makecache</span></span><br><span class="line"> </span><br><span class="line">更新</span><br><span class="line"><span class="meta"> #</span><span class="bash"> yum -y update</span></span><br></pre></td></tr></table></figure>
<h5 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h5><p>前提依赖</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libcom_err-1.42.9-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libselinux-2.5-15.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/keyutils-libs-1.5.8-3.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/krb5-libs-1.15.1-50.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libkadm5-1.15.1-50.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libss-1.42.9-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/openssl-1.0.2k-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/keyutils-libs-devel-1.5.8-3.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/e2fsprogs-libs-1.42.9-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libcom_err-devel-1.42.9-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libsepol-devel-2.5-10.el7.x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/pcre-devel-8.32-17.el7.x86_64.rpm</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libverto-devel-0.2.5-4.el7.x86_64.rpm</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libselinux-devel-2.5-15.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/krb5-devel-1.15.1-50.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/zlib-devel-1.2.7-18.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/openssl-devel-1.0.2k-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/e2fsprogs-1.42.9-19.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/krb5-workstation-1.15.1-50.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/keyutils-1.5.8-3.el7.x86_64.rpm</span><br><span class="line"><span class="meta">#</span><span class="bash">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/openssl-libs-1.0.2k-19.el7.x86_64.rpm</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libselinux-python-2.5-15.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libselinux-utils-2.5-15.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/pkgconfig-0.27.1-4.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">*** 解决这个问题：WARNING - this build will not support IPVS with IPv6</span></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libnl-1.1.4-3.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libnl-devel-1.1.4-3.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libnfnetlink-devel-1.0.1-4.el7.x86_64.rpm</span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/libnfnetlink-1.0.1-4.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod 777 wget_pkg.sh</span><br><span class="line">rpm -Uvh --force *.rpm</span><br><span class="line"></span><br><span class="line">scp -r ./keepalived root@10.154.5.163:/data/keepalived</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">获取源码</span></span><br><span class="line">wget https://www.keepalived.org/software/keepalived-2.2.2.tar.gz</span><br><span class="line">(https://www.keepalived.org/download.html)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">解压</span></span><br><span class="line">tar -xf keepalived-2.2.2.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash">运行配置脚本</span></span><br><span class="line">cd keepalived-2.2.2</span><br><span class="line">./configure</span><br><span class="line"><span class="meta">#</span><span class="bash">构建安装keepalived</span></span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="meta">#</span><span class="bash">查看安装</span></span><br><span class="line">keepalived --version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">完成后会在以下路径生成：</span></span><br><span class="line">/usr/local/etc/keepalived/keepalived.conf</span><br><span class="line">/usr/local/etc/sysconfig/keepalived</span><br><span class="line">/usr/local/sbin/keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">--------注册到系统全局-----------------</span></span><br><span class="line">cd /data/keepalived-2.2.2/keepalived/etc</span><br><span class="line"></span><br><span class="line">mkdir /etc/keepalived/</span><br><span class="line">cp keepalived/keepalived.conf /etc/keepalived/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">keepalived启动脚本（源码目录下），放到/etc/init.d/目录下就可以使用service命令便捷调用</span></span><br><span class="line">cp init.d/keepalived /etc/init.d/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">keepalived启动脚本变量引用文件，默认文件路径是/etc/sysconfig/</span></span><br><span class="line">cp sysconfig/keepalived /etc/sysconfig/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将keepalived主程序加入到环境变量/usr/sbin/目录下</span></span><br><span class="line">cp /usr/local/sbin/keepalived  /usr/sbin/</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置keepalived.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure>
<p>参考</p>
<ol>
<li><a href="https://blog.csdn.net/afreon/article/details/77866695" target="_blank" rel="noopener">keeplived离线安装openssl-devel依赖包_afreon-CSDN博客</a></li>
<li><a href="http://mirrors.bclinux.org/bclinux/dcos/ldk/v7.6/os/x86_64/Packages/" target="_blank" rel="noopener">Welcome to the BCLinux Open Source Mirror. /bclinux/dcos/ldk/v7.6/os/x86_64/Packages/</a></li>
</ol>
<h5 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1. systemctl start keepalived.service #启动服务</span><br><span class="line">2. systemctl restart keepalived.service #重启服务</span><br><span class="line">3. systemctl stop keepalived.service #停止服</span><br><span class="line">4. systemctl status keepalived.service #查看服务状态</span><br><span class="line">5. systemctl enable keepalived.service #设置开机自动启动</span><br><span class="line">6. systemctl disable keepalived.service #取消开机自动启动</span><br></pre></td></tr></table></figure>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>cd /etc/keepalived/</p>
<h5 id="主机-2"><a href="#主机-2" class="headerlink" title="主机"></a>主机</h5><p>vrrp_script 一定要放在vrrp_instance之前</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_dns &#123;</span><br><span class="line">    script &quot;/etc/keepalived/chk_dns.sh&quot;</span><br><span class="line">    weight -10</span><br><span class="line">    interval 2</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.154.5.2</span><br><span class="line">    &#125;</span><br><span class="line">    nopreempt</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_dns</span><br><span class="line">   	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">! dns bind for tcp</span><br><span class="line">virtual_server 10.154.5.2 53 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.162  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">                connect_timeout 3</span><br><span class="line">                connect_port 53</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.214  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">                connect_timeout 3</span><br><span class="line">                connect_port 53</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">! dns bind for udp</span><br><span class="line">virtual_server 10.154.5.2 53 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol UDP</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.162  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">             misc_path &quot;/usr/bin/dig catalog.default soa @10.154.5.162 +time=1 +tries=3 +fail &gt;/dev/null&quot;</span><br><span class="line">             misc_timeout 8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.214  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">             misc_path &quot;/usr/bin/dig catalog.default soa @10.154.5.214 +time=1 +tries=3 +fail &gt;/dev/null&quot;</span><br><span class="line">             misc_timeout 8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">misc_path "/usr/bin/dig catalog.default soa @10.154.5.162 +time=1 +tries=3 +fail &gt;/dev/null"</span><br></pre></td></tr></table></figure>
<ol>
<li>+time=T :为查询设置超时时间为 T 秒。缺省是 5 秒。如果将 T 设置为小于 1 的数，则以 1 秒作为查询超时时间。</li>
<li>+tries=A :设置向服务器发送 UDP 查询请求的重试次数为 A，代替缺省的 3 次。如果把 A 小于或等于 0，则采用 1 为重试次数。 </li>
<li>+fail:如果您收到 SERVFAIL，请不要尝试下一个服务器。默认是不尝试下一个服务器。</li>
</ol>
<p>查看bind服务是否有问题，如果有则设置为vip漂移。</p>
<p>（此处无法用grep 端口号或者named，因为很多干扰字符串）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/chk_dns.sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ALIVE=$(/opt/isc/isc-bind/root/usr/sbin/rndc status | grep "server is up and running")</span><br><span class="line">if [ $? == 0 ];then</span><br><span class="line">        echo "rndc status: running"</span><br><span class="line">        exit 0</span><br><span class="line">else</span><br><span class="line">        LOGFILE="/var/log/keepalived.log"</span><br><span class="line">        echo "---------------------------------------" &gt;&gt;$LOGFILE</span><br><span class="line">        date "+%Y-%m-%d %H:%M:%S" &gt;&gt;$LOGFILE</span><br><span class="line">        echo "Using rndc status check failed" &gt;&gt;$LOGFILE</span><br><span class="line">        echo "---------------------------------------" &gt;&gt;$LOGFILE</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /etc/keepalived/chk_dns.sh</span><br></pre></td></tr></table></figure>
<p>测试vip漂移</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rndc stop</span><br><span class="line"><span class="meta">#</span><span class="bash">发现vip漂移到从机ip addr | grep eth0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">且打印日志Using rndc status check failed</span></span><br><span class="line"></span><br><span class="line">systemctl restart isc-bind-named</span><br><span class="line"><span class="meta">#</span><span class="bash">主机重启服务，vip不会二次漂移</span></span><br><span class="line"><span class="meta">#</span><span class="bash">注意，此处使用systemctl restart isc-bind-named 而非 rndc restart（尚未实现）</span></span><br></pre></td></tr></table></figure>
<p>另外，如果MISC_CHECK监测脚本(当检测UDP ip 53端口成功时，会返回一个”succeeded”字段)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#使用示例</span><br><span class="line">misc_path&quot;/etc/keepalived/udp_check53.sh 10.154.5.214 53&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">udp_check53.sh</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nc -uz -w 1 $1 $2 | grep succeeded &gt;/dev/null</span><br><span class="line">exit $?</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /etc/keepalived/udp_chekc53.sh</span><br></pre></td></tr></table></figure>
<p>53端口，tcp和udp的策略要开启。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT 4 -p tcp--dport 53 -j ACCEPT</span><br><span class="line"></span><br><span class="line">iptables -I INPUT 4 -p udp--dport 53 -j ACCEPT</span><br><span class="line"></span><br><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<p><strong>查看调度规则</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipvsadm</span><br><span class="line"></span><br><span class="line"> ipvsadm -L -n</span><br></pre></td></tr></table></figure>
<p><strong>停掉和启用一台DNS服务，观察调度器</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop isc-bind-named</span><br><span class="line"></span><br><span class="line">ipvsadm -L -n</span><br></pre></td></tr></table></figure>
<p><a href="https://blog.51cto.com/u_6638225/1867850" target="_blank" rel="noopener">DNS+keepalived+lvs实现高可用负载均衡集群_6638225的技术博客_51CTO博客</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">邮件部分，可以忽略</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">        abc@abc.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from abc@abc.com</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   </span><br><span class="line"><span class="meta">	#</span><span class="bash">机器节点名标识，主要用于通知，必有</span></span><br><span class="line">   router_id LVS_DR01</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash">可以忽略</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_dns &#123;</span><br><span class="line">    script "/etc/keepalived/scripts/dns_check.sh" # 定义检测的脚本和执行参数</span><br><span class="line">    interval 2 # 定义脚本的执行时间间隔为2秒</span><br><span class="line">  </span><br><span class="line">    #weight -20   # 执行失败的时候weight-20</span><br><span class="line">    </span><br><span class="line">    #fall 2 # 检测到脚本执行两次失败才算失败</span><br><span class="line">   </span><br><span class="line">    #rise 1  # 检测到脚本执行成功一次就算成功</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_BIND &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51 #主从相同</span><br><span class="line">    priority 100 #从服务器要低一些，否则master将失去master状态</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123; #单个vrrp_instance最多支持20个virtual_ipaddress。如果想要更多，则增加vrrp_instance吧！</span><br><span class="line">        10.20.120.150 #VIP</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_dns #通过dns_check.sh来检测服务可用性</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    notify /etc/keepalived/scripts/keepalivednotify.sh</span><br><span class="line">    </span><br><span class="line">    notify_master /etc/keepalived/scripts/dns_master.sh #当进入Master状态时会呼叫notify_master</span><br><span class="line">    notify_backup /etc/keepalived/scripts/dns_backup.sh #当进入Backup状态时会呼叫notify_backup</span><br><span class="line">    notify_fault  /etc/keepalived/scripts/dns_fault.sh #当发现异常情况时进入Fault状态呼叫notify_fault</span><br><span class="line">    notify_stop   /etc/keepalived/scripts/dns_stop.sh #当Keepalived程序终止时则呼叫notify_stop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############LVS################对外公开一个vip节点，内部有多个真实的服务器负责处理请求.  keepalived主要用作real_server的健康状态的检查，和负责均衡主备机之间的failover的实现。当真实的服务器节点宕机，keepalived的健康检查机制检查到了宕机的服务器不能再提供服务了，keepalived就将这个节点从虚拟ip（lvs服务器）上面剔除，保证对外提供的服务能够稳健的运行。</span></span></span><br><span class="line"></span><br><span class="line">virtual_server 10.20.120.150 53 &#123; #VIP</span><br><span class="line">    delay_loop 6           # 服务轮询的时间间隔</span><br><span class="line">    lb_algo rr             #设置 LVS 调度算法，轮询，按照请求顺序轮流分发到后端RS。rr|wrr|lc|wlc|lblc|sh|dh</span><br><span class="line">    lb_kind DR             #设置 LVS 集群模式， DR模式（Direct Routing）【这个模式比较常用】  NAT|DR|TUN</span><br><span class="line">    protocol UDP      		# 设置健康检查用的是 TCP 还是 UDP</span><br><span class="line"> </span><br><span class="line">    real_server 10.20.121.179 53 &#123; # 真实bind主机1</span><br><span class="line">        weight 1  #设置给每台的权重 0 表示失效 (不知给他转发请求知道他恢复正常) 默认是 1</span><br><span class="line">        #TCP_CHECK &#123;        # keepalived 健康检查方式有: HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK</span><br><span class="line">         #   connect_timeout 3</span><br><span class="line">          #  retry 3</span><br><span class="line">           # delay_before_retry 3</span><br><span class="line">       # &#125;</span><br><span class="line">        </span><br><span class="line">       # MISC_CHECK &#123; #指定脚本监测，</span><br><span class="line">        #   misc_path "/usr/bin/dig -b 10.1.53.1 a resolve.test.roka.net @10.20.121.179 +time=1 +tries=5 +fail &gt; /dev/null"</span><br><span class="line">        #   misc_timeout 6</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    real_server 10.20.121.184 53 &#123; # 真实bind备机1</span><br><span class="line">        weight 1</span><br><span class="line">        #TCP_CHECK &#123;</span><br><span class="line">        #	connect_port 53</span><br><span class="line">         #   connect_timeout 3</span><br><span class="line">          #  retry 3</span><br><span class="line">           # delay_before_retry 3</span><br><span class="line">        #&#125;</span><br><span class="line">        </span><br><span class="line">        # MISC_CHECK &#123; #指定脚本监测</span><br><span class="line">        #   misc_path "/usr/bin/dig -b 10.1.53.1 a resolve.test.roka.net @10.20.121.184 +time=1 +tries=5 +fail &gt; /dev/null"</span><br><span class="line">        #   misc_timeout 6</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">检测bind53端口是否可用，从而来证明服务可用性</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/scripts/dns_check.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">ALIVE=`netstat -ntpl |grep "53"`</span><br><span class="line">if [ $? == 0 ];then</span><br><span class="line">  exit 0</span><br><span class="line">else</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当进入Master状态时启动<span class="built_in">bind</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/scripts/dns_master.sh</span></span><br><span class="line">LOGFILE="/var/log/keepalived-dns-state.log"</span><br><span class="line">echo "[master]" &gt;&gt; $LOGFILE</span><br><span class="line">date &gt;&gt; $LOGFILE</span><br><span class="line">echo "Being master...." &gt;&gt; $LOGFILE 2&gt;&amp;1</span><br><span class="line">echo "Run reload cmd ..." &gt;&gt; $LOGFILE</span><br><span class="line">systemctl restart isc-bind-named &gt;&gt; $LOGFILE  2&gt;&amp;1</span><br><span class="line">echo "Running systemctl restart isc-bind-named done ! " &gt;&gt;$LOGFILE</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当进入Backup状态时启动<span class="built_in">bind</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/scripts/dns_backup.sh</span></span><br><span class="line">LOGFILE="/var/log/keepalived-dns-state.log"</span><br><span class="line">echo "[backup]" &gt;&gt; $LOGFILE</span><br><span class="line">date &gt;&gt; $LOGFILE</span><br><span class="line">systemctl restart isc-bind-named &gt;&gt; $LOGFILE  2&gt;&amp;1</span><br><span class="line">echo "Being slave...." &gt;&gt; $LOGFILE 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当发现异常情况时进入Fault状态，写入日志而已</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/scripts/dns_fault.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">LOGFILE=/var/log/keepalived-dns-state.log</span><br><span class="line">echo "[fault]" &gt;&gt; $LOGFILE</span><br><span class="line">date &gt;&gt; $LOGFILE</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">当Keepalived程序终止时，写入日志而已</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/keepalived/scripts/dns_stop.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">LOGFILE=/var/log/keepalived-dns-state.log</span><br><span class="line">echo "[stop]" &gt;&gt; $LOGFILE</span><br><span class="line">date &gt;&gt; $LOGFILE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">keepalivednotify.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">TYPE=$1</span><br><span class="line">NAME=$2</span><br><span class="line">STATE=$3</span><br><span class="line"></span><br><span class="line">case $STATE in</span><br><span class="line">        "MASTER") /etc/init.d/apache2 start</span><br><span class="line">                  exit 0</span><br><span class="line">                  ;;</span><br><span class="line">        "BACKUP") /etc/init.d/apache2 stop</span><br><span class="line">                  exit 0</span><br><span class="line">                  ;;</span><br><span class="line">        "FAULT")  /etc/init.d/apache2 stop</span><br><span class="line">                  exit 0</span><br><span class="line">                  ;;</span><br><span class="line">        *)        echo "unknown state"</span><br><span class="line">                  exit 1</span><br><span class="line">                  ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>
<p>给5个脚本都加上可执行权限：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">chmod +x /etc/keepalived/scripts/*.sh</span><br></pre></td></tr></table></figure>
<p>启动keepalived</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>
<p>验证</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">netstat -ntpl |grep 53</span><br></pre></td></tr></table></figure>
<p>模拟master挂掉（关闭master服务）,查看vip的漂移情况。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ip addr show eth0</span><br></pre></td></tr></table></figure>
<p>主从机器的named.conf都需要增加VIP，确保主从named.conf配置文件中的监听网卡和端口覆盖了本机IP和VIP。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">listen-on port 53 &#123; 127.0.0.1; 10.154.5.163; VIP; &#125;; #增加VIP</span><br></pre></td></tr></table></figure>
<h5 id="备机"><a href="#备机" class="headerlink" title="备机"></a>备机</h5><p>与主机基本一致，除了以下参数</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">state BACKUP</span><br><span class="line">priority 95 #从服务器要低一些</span><br><span class="line">nopreempt #没有</span><br></pre></td></tr></table></figure>
<p>#### </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_dns &#123;</span><br><span class="line">    script &quot;/etc/keepalived/chk_dns.sh&quot;</span><br><span class="line">    weight -10</span><br><span class="line">    interval 2</span><br><span class="line">    fall 3</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 95</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.154.5.2</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_dns</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">! dns bind for tcp</span><br><span class="line">virtual_server 10.154.5.2 53 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.162  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">                connect_timeout 3</span><br><span class="line">                connect_port 53</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.214  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">                connect_timeout 3</span><br><span class="line">                connect_port 53</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">! dns bind for udp</span><br><span class="line">virtual_server 10.154.5.2 53 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    protocol UDP</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.162  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">             misc_path &quot;/usr/bin/dig catalog.default soa @10.154.5.162 +time=1 +tries=3 +fail &gt;/dev/null&quot;</span><br><span class="line">             misc_timeout 8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    real_server 10.154.5.214  53 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        MISC_CHECK &#123;</span><br><span class="line">             misc_path &quot;/usr/bin/dig catalog.default soa @10.154.5.214 +time=1 +tries=3 +fail &gt;/dev/null&quot;</span><br><span class="line">             misc_timeout 8</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump udp port 53</span><br><span class="line"></span><br><span class="line">tcpdump -i eth0</span><br></pre></td></tr></table></figure>
<p><a href="https://zhuanlan.zhihu.com/p/96143656" target="_blank" rel="noopener">tcpdump抓包命令详解 - 知乎 (zhihu.com)</a></p>
<h4 id="ipvsadm"><a href="#ipvsadm" class="headerlink" title="ipvsadm"></a>ipvsadm</h4><p>CentOS 7已经包含LVS内核，只要安装LVS控制器ipvsadm.</p>
<p>ipvsadm可以查看lvs规则是否建立</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-L|-l（–list）：显示内核虚拟服务器表</span><br><span class="line"></span><br><span class="line">-n（–numeric）：输出IP 地址和端口的数字形式</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Forward 转发方式，当前是路由转发</span><br><span class="line">Weight 权重</span><br><span class="line">ActiveConn 当前活跃的连接数</span><br><span class="line">InActConn 当前不活跃的连接数</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/ipvsadm-1.27-8.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">yum install -y ipvsadm-1.27-8.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在线安装 yum install -y ipvsadm</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">查看调度情况</span><br><span class="line"><span class="meta">#</span><span class="bash">ipvsadm -lcn</span></span><br><span class="line"></span><br><span class="line">IPVS connection entries</span><br><span class="line">pro expire state       source             virtual            destination</span><br><span class="line">UDP 03:03  UDP         10.154.5.2:42601   10.154.5.2:53      10.154.5.162:53</span><br><span class="line">UDP 04:00  UDP         10.154.5.2:39982   10.154.5.2:53      10.154.5.214:53</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">ipvsadm –lcn | grep 192.168.1.115</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ipvsadm</span></span><br><span class="line"></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  fnc04:https rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> fnc04:sun-sr-https           Masq    1      0          0</span></span><br><span class="line">TCP  fnc04:domain rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:domain        Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:domain        Masq    1      0          0</span></span><br><span class="line">TCP  fnc04:9153 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:9153          Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:9153          Masq    1      0          0</span></span><br><span class="line">UDP  fnc04:domain rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:domain        Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:domain        Masq    1      0          0</span></span><br><span class="line">UDP  fnc04:domain rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> fnc04:domain                 Route   1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> fnc03:domain                 Route   1      0          1</span></span><br></pre></td></tr></table></figure>
<p>查看VIP是否已经成功映射到两台real服务器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">ipvsadm -L -n</span></span><br><span class="line"></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class="line">TCP  10.96.0.1:443 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 10.154.5.162:6443            Masq    1      0          0</span></span><br><span class="line">TCP  10.96.0.10:53 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:53            Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:53            Masq    1      0          0</span></span><br><span class="line">TCP  10.96.0.10:9153 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:9153          Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:9153          Masq    1      0          0</span></span><br><span class="line">UDP  10.96.0.10:53 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.194:53            Masq    1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 100.92.165.195:53            Masq    1      0          0</span></span><br><span class="line">UDP  10.154.5.2:53 rr</span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 10.154.5.162:53              Route   1      0          0</span></span><br><span class="line"><span class="meta">  -&gt;</span><span class="bash"> 10.154.5.214:53              Route   1      0          1</span></span><br></pre></td></tr></table></figure>
<p>ipvsadm默认超时时间</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ipvsadm -L --timeout</span></span><br><span class="line">Timeout (tcp tcpfin udp): 900 120 300</span><br><span class="line"><span class="meta">#</span><span class="bash">单位秒 15分钟 2分钟 5分钟</span></span><br></pre></td></tr></table></figure>
<p>900 120 300这三个数值分别是TCP TCPFIN UDP的时间.也就是说一条tcp的连接经过lvs后,lvs会把这台记录保存15分钟，就是因为这个时间过长，所以很多人都会发现做好LVS DR之后轮询现象并没有发生，实践中将此数值调整很小小，使用以下命令调整：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ipvsadm --set 1 2 1</span><br></pre></td></tr></table></figure>
<p> Clear the LVS settings first because it is controled by Keepalived.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipvsadm -C</span><br></pre></td></tr></table></figure>
<h4 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h4><p>查看是否安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -qa | grep xinetd</span><br><span class="line"></span><br><span class="line">rpm -qa | grep telnet</span><br><span class="line"></span><br><span class="line">rpm -qa | grep telnet-server</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/xinetd-2.3.15-14.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/telnet-server-0.17-65.el7_8.x86_64.rpm</span><br><span class="line"></span><br><span class="line">wget http://mirror.centos.org/centos/7/os/x86_64/Packages/telnet-0.17-65.el7_8.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>telnet-server服务启动依赖xinetd服务，需要首先安装，如果telnet-server服务在xinetd之前安装了，要先删除telnet-server，再安装xinetd。</p>
<p>安装顺序：xinetd–&gt;telnet–&gt;telnet-server。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -ivh xinetd-2.3.15-14.el7.x86_64.rpm</span><br><span class="line">rpm -ivh telnet-0.17-65.el7_8.x86_64.rpm</span><br><span class="line">rpm -ivh telnet-server-0.17-65.el7_8.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>再次查看发现已经安装了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装完成后，将xinetd服务加入开机自启动:</span></span><br><span class="line">systemctl enable xinetd.service</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">将telnet服务加入开机自启动：</span></span><br><span class="line">systemctl enable telnet.socket</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash">因telnet服务也是由xinetd守护的，所以安装完telnet-server，要启动telnet服务就必须重新启动xinetd 。</span></span><br><span class="line">systemctl start telnet.socket</span><br><span class="line">systemctl start xinetd（或service xinetd start）</span><br></pre></td></tr></table></figure>
<p>测试vip</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">telnet 10.154.5.2 53</span><br></pre></td></tr></table></figure>
<h4 id="用户程序"><a href="#用户程序" class="headerlink" title="用户程序"></a>用户程序</h4><p>用户访问时，访问的是VIP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="参考-6"><a href="#参考-6" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="https://www.codenong.com/js54b4fe942250/" target="_blank" rel="noopener">BIND + LVS + Keepalived 搭建内网DNS集群-分区域响应结果，可做智能解析 | 码农家园 (codenong.com)</a></li>
<li>keepalived 仅高可用 <a href="https://blog.51cto.com/iyull/1946451" target="_blank" rel="noopener">Centos下高可用主从同步DNS服务部署_亮公子的技术博客_51CTO博客</a></li>
<li>keepalived 仅高可用 <a href="https://tecadmin.net/setup-ip-failover-on-ubuntu-with-keepalived/" target="_blank" rel="noopener">How to Setup IP Failover with KeepAlived on Ubuntu &amp; Debian - TecAdmin</a></li>
<li>LVS + keepalived <a href="https://www.server-world.info/en/note?os=Ubuntu_16.04&amp;p=lvs&amp;f=2" target="_blank" rel="noopener">Ubuntu 16.04 LTS : LVS + Keepalived : Server World (server-world.info)</a></li>
<li>LVS+Keepalived <a href="http://www.atomicgain.com/dns-lb-with-lvs-keepalived-02/" target="_blank" rel="noopener">Build DNS HA LB Cluser (more higher HA) (atomicgain.com)</a></li>
<li>DNS + LVS <a href="http://kb.linuxvirtualserver.org/wiki/Building_Scalable_DNS_Cluster_using_LVS" target="_blank" rel="noopener">Building Scalable DNS Cluster using LVS - LVSKB (linuxvirtualserver.org)</a></li>
<li><a href="https://blog.csdn.net/xiazhipeng1000/article/details/80032388" target="_blank" rel="noopener">keepalived+lvs+负载均衡的windows实现_夏的博客-CSDN博客</a></li>
<li><a href="https://tinychen.com/20210520-dns-05-bind9-keepalived-ha-installation/" target="_blank" rel="noopener">DNS系列之bind篇01-Bind+Keepalived安装高可用DNS集群 - TinyChen’s Studio</a></li>
<li><a href="https://severalnines.com/database-blog/how-clustercontrol-configures-virtual-ip-and-what-expect-during-failover" target="_blank" rel="noopener">How ClusterControl Configures Virtual IP and What to Expect During Failover | Severalnines</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-haproxy-servers-with-keepalived-and-floating-ips-on-ubuntu-14-04" target="_blank" rel="noopener">How To Set Up Highly Available HAProxy Servers with Keepalived and Floating IPs on Ubuntu 14.04 | DigitalOcean</a></li>
<li><a href="https://www.claudiokuenzler.com/blog/695/unbound-behind-a-virtual-ip-vip-reply-from-unexpected-source" target="_blank" rel="noopener">ck :: Unbound DNS server behind a VIP - solving reply from unexpected source (claudiokuenzler.com)</a></li>
</ol>
<h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><img src="/want/2021/06/02/bind/exporter.png" title="exporter">
<h4 id="Bind基本配置"><a href="#Bind基本配置" class="headerlink" title="Bind基本配置"></a>Bind基本配置</h4><p>用于获取监控数据</p>
<p>vim /etc/opt/isc/isc-bind/named.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">statistics-channels &#123;</span><br><span class="line">      inet 127.0.0.1 port 8888 allow &#123; any; &#125;;</span><br><span class="line">      inet 10.154.5.162 port 8889 allow &#123; any; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问10.154.5.162:8889</p>
<p><strong>注意端口号8889</strong></p>
<h4 id="bind-exporter"><a href="#bind-exporter" class="headerlink" title="bind_exporter"></a>bind_exporter</h4><p>用于图形化展现。</p>
<p>bind_exporter基于statistics-channels记录的统计数据，并对数据统计分析并输出到Prometheus</p>
<h5 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h5><p>查看linux版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># cat /proc/version</span><br><span class="line">Linux version 3.10.0-1127.18.2.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-39) (GCC) ) #1 SMP Sun Jul 26 15:27:06 UTC 2020</span><br></pre></td></tr></table></figure>
<p>根据版本下载</p>
<p><a href="https://github.com/prometheus-community/bind_exporter/releases" target="_blank" rel="noopener">https://github.com/prometheus-community/bind_exporter/releases</a></p>
<p>如上图，linux是86_64，则下载版本</p>
<p>bind_exporter-0.4.0.linux-amd64.tar.gz</p>
<h5 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h5><p>解压到/usr/local/bin/</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"> tar -xvf bind_exporter-0.4.0.linux-amd64.tar.gz</span><br><span class="line"> </span><br><span class="line"> cd /usr/local/bin/</span><br><span class="line">-rwxr-xr-x 1 3434 3434 15762489 Jan 14 22:55 bind_exporter</span><br><span class="line">-rw-r--r-- 1 3434 3434    11357 Jan 14 23:57 LICENSE</span><br><span class="line">-rw-r--r-- 1 3434 3434      252 Jan 14 23:57 NOTICE</span><br></pre></td></tr></table></figure>
<p>创建⼀个systemd配置⽂件以运⾏bind_exporter</p>
<ol>
<li>–web.listen-address为对外暴露的metric地址和端⼝，Prometheus从此处抓取bind_exporter的metrics；即对外提供数据的端口。</li>
<li>– bind.stats-url为本地bind服务绑定的地址和IP。即获取bind数据的地址。</li>
</ol>
<p>注意此处的⽤⼾和组可以使⽤与named程序相同的⽤⼾和组“named”，也可 以使⽤root。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/bind_exporter.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=bind_exporter</span><br><span class="line">Documentation=https://github.com/prometheus-community/bind_exporter</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=root</span><br><span class="line">Group=root</span><br><span class="line">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class="line">ExecStart=/usr/local/bin/bind_exporter \</span><br><span class="line">--bind.pid-file=/var/opt/isc/isc-bind/run/named/named.pid \</span><br><span class="line">--bind.timeout=20s \</span><br><span class="line">--web.listen-address=0.0.0.0:9154 \</span><br><span class="line">--web.telemetry-path=/metrics \</span><br><span class="line">--bind.stats-url=http://10.154.5.162:8889/ \</span><br><span class="line">--bind.stats-groups=server,view,tasks</span><br><span class="line">Restart=always</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure>
<p><strong>注意端口号9154</strong></p>
<p>加载并启动bind_export</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart bind_exporter.service</span><br></pre></td></tr></table></figure>
<h4 id="Prometheus-Server"><a href="#Prometheus-Server" class="headerlink" title="Prometheus Server"></a>Prometheus Server</h4><p>Prometheus基于Go编写，编译后的软件包，不依赖于任何的第三⽅依赖。只需要下载对应平台的⼆进制包，解压并且添加基本 的配置即可正常启Prometheus Server。</p>
<p>Prometheus Server负责定时在目标上抓取Metrics数据，每个抓取目标都需要暴露一个HTTP服务接口用于Prometheus定时抓取。</p>
<p>这种调用被监控对象获取监控数据的方式被称为Pull。Pull方式体现了Prometheus独特的设计哲学与大多数采用了Push方式的监控系统不同。</p>
<p>但某些现有系统是通过push方式实现的，为了接入这个系统，Prometheus提供对PushGateway的支持，这些系统主动推送metrics到PushGateway，而Prometheus只是定时去Gateway上抓取数据。</p>
<p>AlertManager是独立于Prometheus的一个组件，在触发了预先设置在Prometheus中的高级规则后，Prometheus便会推送告警信息到AlertManager。</p>
<p>根据版本下载：</p>
<p><a href="https://prometheus.io/download/" target="_blank" rel="noopener">Download | Prometheus</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar -xf prometheus-2.27.1.linux-amd64.tar.gz</span><br><span class="line">mv prometheus-2.27.1.linux-amd64 /usr/local/</span><br><span class="line">ln -s /usr/local/prometheus-2.27.1.linux-amd64/ /usr/local/prometheus</span><br></pre></td></tr></table></figure>
<p>创建Prometheus的⽤⼾(此处用户prometheus)及数据存储⽬录（/data/prometheus）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># useradd -s /sbin/nologin -M prometheus</span><br><span class="line"># mkdir /data/prometheus -p</span><br><span class="line">#修改⽬录属主</span><br><span class="line"># chown -R prometheus:prometheus /usr/local/prometheus/</span><br><span class="line"># chown -R prometheus:prometheus /data/prometheus/</span><br></pre></td></tr></table></figure>
<p>配置/usr/local/prometheus/promethes.yml</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp prometheus.yml prometheus.yml-default #备份一下默认配置</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> my global config</span></span><br><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line"><span class="meta">  #</span><span class="bash"> scrape_timeout is <span class="built_in">set</span> to the global default (10s).</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets: ["localhost:9093"]</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Load rules once and periodically evaluate them according to the global <span class="string">'evaluation_interval'</span>.</span></span><br><span class="line">rule_files:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"first_rules.yml"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> - <span class="string">"second_rules.yml"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Here it<span class="string">'s Prometheus itself.</span></span></span><br><span class="line">scrape_configs:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  - job_name: 'prometheus'</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to '/metrics'</span><br><span class="line">    # scheme defaults to 'http'.</span><br><span class="line">	scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9090'] #浏览器访问9090打开管理界面</span><br><span class="line">   </span><br><span class="line">  - job_name: 'bind-fnc04'</span><br><span class="line">	scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['10.154.5.162:9154'] #监听bind_exporter</span><br></pre></td></tr></table></figure>
<p>默认启动后的端口为9090。</p>
<p>启动方式1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /usr/local/prometheus</span><br><span class="line">./prometheus --version</span><br><span class="line">./prometheus &amp;</span><br></pre></td></tr></table></figure>
<p>启动方式2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/prometheus.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Prometheus</span><br><span class="line">Documentation=https://prometheus.io/</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=prometheus</span><br><span class="line">ExecStart=/usr/local/prometheus/prometheus --config.file=/usr/local/prometheus/prometheus.yml --storage.tsdb.path=/data/prometheus</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<p>如此可以用命令启动服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable prometheus</span><br><span class="line">systemctl start prometheus</span><br></pre></td></tr></table></figure>
<p>浏览器访问<a href="http://10.154.5.162:9090/targets" target="_blank" rel="noopener">http://10.154.5.162:9090/targets</a></p>
<h4 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h4><p>一个数据分析统计可视化报表，⽤来展⽰ prometheus收集到的数据</p>
<p><a href="https://zhuanlan.zhihu.com/p/351995351" target="_blank" rel="noopener">Grafana+Prometheus的详解以及使用 - 知乎 (zhihu.com)</a></p>
<p>下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://dl.grafana.com/oss/release/grafana-7.5.7.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar -xzvf grafana-7.5.7.linux-amd64.tar.gz</span><br><span class="line">mv grafana-7.5.7 /usr/local/</span><br><span class="line">ln -s /usr/local/grafana-7.5.7/ /usr/local/grafana</span><br></pre></td></tr></table></figure>
<p>创建grafana⽤⼾及数据存放⽬录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">useradd -s /sbin/nologin -M grafana</span><br><span class="line">mkdir /data/grafana</span><br><span class="line">chown -R grafana:grafana /usr/local/grafana/</span><br><span class="line">chown -R grafana:grafana /data/grafana</span><br></pre></td></tr></table></figure>
<p>修改目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> cd /usr/local/grafana/conf/</span><br><span class="line"> cp defaults.ini defaults.ini-default 先备份</span><br><span class="line"> </span><br><span class="line"> vim defaults.ini</span><br><span class="line">data = /data/grafana/data</span><br><span class="line">logs = /data/grafana/log</span><br><span class="line">plugins = /data/grafana/plugins</span><br><span class="line">provisioning = /data/grafana/conf/provisioning</span><br></pre></td></tr></table></figure>
<p>新增 grafana-server.service ⽂件，使⽤systemd来管理grafana服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /etc/systemd/system/grafana-server.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Grafana</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">User=grafana</span><br><span class="line">Group=grafana</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/grafana/bin/grafana-server -homepath /usr/local/grafana</span><br><span class="line">Restart=on-failure</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start grafana-server</span><br><span class="line">systemctl status grafana-server</span><br><span class="line">systemctl enable grafana-server</span><br></pre></td></tr></table></figure>
<p>打开浏览器访问</p>
<p><a href="http://10.154.5.162:3000/login" target="_blank" rel="noopener">http://10.154.5.162:3000/login</a></p>
<p>默认的账号密码 admin/admin</p>
<p>把grafana和prometheus关联起来，也就是在 grafana中添加添加数据源——</p>
<p>在配置⻚⾯点击添加数据源，然后选择prometheus，输⼊prometheus服务的参数即可。</p>
<img src="/want/2021/06/02/bind/prometheus.png" title="prometheus">
<img src="/want/2021/06/02/bind/prometheus_setting.png" title="prometheus_setting">
<h5 id="Grafana三种方式导入Dashboard"><a href="#Grafana三种方式导入Dashboard" class="headerlink" title="Grafana三种方式导入Dashboard"></a>Grafana三种方式导入Dashboard</h5><img src="/want/2021/06/02/bind/Grafana_import.png" title="Grafana_import">
<img src="/want/2021/06/02/bind/Grafana_import_detail.png" title="Grafana_import_detail">
<img src="/want/2021/06/02/bind/grafana_dashboards.png" title="grafana_dashboards">
<p>参考：</p>
<ol>
<li><a href="https://blog.csdn.net/y368769/article/details/108514720" target="_blank" rel="noopener">Grafana三种方式导入Dashboard_y368769的博客-CSDN博客_grafana import</a></li>
<li><a href="https://grafana.com/grafana/dashboards" target="_blank" rel="noopener">https://grafana.com/grafana/dashboards</a></li>
</ol>
<h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h4><p><a href="https://prometheus.io/download/" target="_blank" rel="noopener">https://prometheus.io/download/</a></p>
<img src="/want/2021/06/02/bind/node_exporter.png" title="node_exporter">
<p>采集主机的运⾏指标如CPU，内存，磁盘等信息。可以使⽤Node Exporter</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.1.2/node_exporter-1.1.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -s  node_exporter-1.1.2.linux-amd64/  node_exporter</span><br><span class="line"></span><br><span class="line">启动，默认会启动9100端⼝</span><br><span class="line">nohup /usr/local/prometheus_exporter/node_exporter/node_exporter &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">或</span><br><span class="line">/usr/local/prometheus_exporter/node_exporter/node_exporter</span><br></pre></td></tr></table></figure>
<p>​        </p>
<p>开机启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nohup /usr/local/prometheus_exporter/node_exporter/node_exporter &gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<h5 id="加入prometheus"><a href="#加入prometheus" class="headerlink" title="加入prometheus"></a>加入prometheus</h5><p>编辑prometheus.yml⽂件，增加后⾯4⾏.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrape_configs:</span><br><span class="line">  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span><br><span class="line">  - job_name: &apos;prometheus&apos;</span><br><span class="line"></span><br><span class="line">    # metrics_path defaults to &apos;/metrics&apos;</span><br><span class="line">    # scheme defaults to &apos;http&apos;.</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9090&apos;]</span><br><span class="line"></span><br><span class="line">  - job_name: &apos;bind-fnc04&apos;</span><br><span class="line">    scrape_interval: 5s</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;10.154.5.162:9154&apos;] #监听bind_exporter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  - job_name: &apos;node&apos;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&apos;localhost:9100&apos;]</span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart prometheus.service</span><br></pre></td></tr></table></figure>
<h3 id="存疑"><a href="#存疑" class="headerlink" title="存疑"></a>存疑</h3><p>dns bind Catalog zone notify yes 无法主动同步新建域名的zone（主机没有主动发送新建zone的消息，导致zone更新解析记录等时虽然发消息但从机同步失败）</p>
<h3 id="其他概念"><a href="#其他概念" class="headerlink" title="其他概念"></a>其他概念</h3><h4 id="IXFR与AXFR"><a href="#IXFR与AXFR" class="headerlink" title="IXFR与AXFR"></a>IXFR与AXFR</h4><ol>
<li>增量区传送（Incremental Zone Transfer，IXFR）：<ul>
<li>zone很大的话，zone传送需要一定的时间，IXFR是为了解决这个问题，它允许辅名字服务器告诉主名字服务器当前使用的区的版本，并仅仅请求传送它使用的版本和当前版本之间改动过的部分。这样就大大减少了区传送的大小和所需的时间。</li>
<li>但是存在的问题比较多，如果最大限度的利用IXFR，最好动态更新修改区而不是手工编辑区数据文件。</li>
<li>通过IXFR区域传输时，区域的复制版本和源区域之间的差异必须首先确定。如果该区域复制源DNS服务器的序号与申请同步复制的DNS服务器该区域的序列号所指示的版本相同，则不进行任何传送；如果复制源DNS服务器的序列号比申请同步复制的DNS服务器对应区域的序列号大，则传送的内容仅由区域中每个递增版本的资源记录的改动组成。</li>
</ul>
</li>
<li>全量区传送（Full Zone Transfer，AXFR）：默认，完全区域传输查询来完全传送整个区域数据。</li>
</ol>
<h4 id="PowerDNS"><a href="#PowerDNS" class="headerlink" title="PowerDNS"></a>PowerDNS</h4><h4 id="notify-to-soa"><a href="#notify-to-soa" class="headerlink" title="notify-to-soa"></a>notify-to-soa</h4><p>Normally a NOTIFY message is not sent to the SOA MNAME (SOA ORIGIN) as it is supposed to contain the name of the ultimate master.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat /etc/named.conf</span><br><span class="line">options &#123;</span><br><span class="line">..........</span><br><span class="line">notify-to-soa yes;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="view"><a href="#view" class="headerlink" title="view"></a>view</h4><p>mastert利用view进行分界，针对不同查询来源IP，返回不同DNS答案。</p>
<ol>
<li><p><a href="http://blog.sina.com.cn/s/blog_6ab6c71e0101t9qv.html" target="_blank" rel="noopener">BIND 9 利用 TSIG KEY 实现主从服务器多 view 同步<em>说法语的猪</em>新浪博客 (sina.com.cn)</a></p>
</li>
<li><p><a href="https://blog.gnuers.org/?p=890" target="_blank" rel="noopener">多个view的时候使用nsupdate更新记录 | GNUer’s blog (gnuers.org)</a></p>
</li>
<li><a href="https://blog.gnuers.org/?p=1032" target="_blank" rel="noopener">bind主备同步的关键配置 | GNUer’s blog (gnuers.org)</a></li>
<li><a href="https://blog.gnuers.org/?p=896" target="_blank" rel="noopener">bind多个view的主备同步 | GNUer’s blog (gnuers.org)</a></li>
</ol>
<p>主从机介绍 <a href="http://www.zytrax.com/books/dns/ch4/#master" target="_blank" rel="noopener">Chapter 4 DNS Configuration Types (zytrax.com)</a></p>
<ol>
<li>假设您想将主服务器隐藏，那么至少一个从服务器将位于防火墙或类似配置的公共端，提供外围防御(defence)</li>
<li>为了提供弹性(resilience)，您需要两个或更多这样的公共slave（第二个slave可以从master获取数据，也可以从另一个slave（称为’boss’ slave）中）</li>
<li>这种类型的配置将略微增加更新第二个从站上的区域的延迟 - 但这可能会被增加的隐蔽性抵消。</li>
<li>在 DNSSEC 环境中，master 可能会拥有各种与保持密钥安全有关的配置。而 DNSSEC 从站只是简单地发送区域文件中的数据来响应查询，并且没有安全密钥维护的要求。在这种环境中，隐藏的主配置将越来越成为常态。</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>lvs</title>
    <url>/want/2021/07/07/lvs/</url>
    <content><![CDATA[<h3 id="负载均衡选择"><a href="#负载均衡选择" class="headerlink" title="负载均衡选择"></a>负载均衡选择</h3><p>四层实现负载均衡的软件</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>协议</th>
<th>特点</th>
<th></th>
<th></th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>lvs</td>
<td>tcp/udp （自带）</td>
<td>重量级</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>nginx</td>
<td>tcp/udp （支撑这两者需要额外带–with-stream编译）</td>
<td>轻量级，带缓存功能，正则表达式较灵活</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>haproxy</td>
<td>tcp</td>
<td>模拟四层转发，较灵活</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>nginx虽然通过额外的stream模块，可以实现tcp/udp负载均衡，但是针对主动自定义的健康检查（Healthchecks ），却需要收费？</p>
</blockquote>
<blockquote>
<p>haproxy不支持udp可参阅官方文档描述：</p>
<ol>
<li>HAProxy官网：The Reliable, High Performance TCP/HTTP Load Balancer（可靠、高性能的 TCP/HTTP 负载均衡器）。<ul>
<li>[官网地址] <a href="https://www.haproxy.org/" target="_blank" rel="noopener">HAProxy - The Reliable, High Performance TCP/HTTP Load Balancer</a></li>
</ul>
</li>
<li>关于HAProxy是否要支持UDP的讨论<ul>
<li><a href="https://github.com/haproxy/haproxy/issues/62" target="_blank" rel="noopener">UDP Loadbalancing · Issue #62 · haproxy/haproxy (github.com)</a></li>
</ul>
</li>
</ol>
</blockquote>
<blockquote>
<p>Keepalived+ LVS，可以执行健康检查、可以跟踪接口状态、可以配置为故障转移等。免费、性能高。</p>
</blockquote>
<blockquote>
<p>DNS 和 syslog等软件，是极少数基于udp传输的应用。</p>
</blockquote>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210709101836749.png" alt="image-20210709101836749"></p>
<h3 id="简介In-a-nutshell"><a href="#简介In-a-nutshell" class="headerlink" title="简介In a nutshell"></a>简介In a nutshell</h3><p>传输层：提供TCP(传输控制协议)，UDP（用户数据报协议）两个协议，主要功能是数据格式化、数据确认和丢失重传等。</p>
<p>LVS（Linux Virtual Server）</p>
<ol>
<li>基于<strong>IP层</strong>和基于内容请求分发的<strong>负载平衡</strong>调度解决方法</li>
<li>并在<strong>Linux内核</strong>中实现了这些方法</li>
<li>将一组服务器构成一个实现可伸缩的、高可用网络服务的虚拟服务器</li>
</ol>
<p>IPVS软件实现了三种IP负载均衡技术和10种连接调度算法。</p>
<p>可利用如下命令查看ipvs相关信息（发现ipvs已经在内核中了）：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep -i -C 10 ipvs /boot/config-3.10.0-1160.11.1.el7.x86_64</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IPVS transport protocol load balancing support</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">CONFIG_IP_VS_PROTO_TCP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_UDP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_ESP=y</span><br><span class="line">CONFIG_IP_VS_PROTO_AH=y</span><br><span class="line">CONFIG_IP_VS_PROTO_SCTP=y</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IPVS scheduler</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">CONFIG_IP_VS_RR=m</span><br><span class="line">CONFIG_IP_VS_WRR=m</span><br><span class="line">CONFIG_IP_VS_LC=m</span><br><span class="line">CONFIG_IP_VS_WLC=m</span><br><span class="line">CONFIG_IP_VS_LBLC=m</span><br><span class="line">CONFIG_IP_VS_LBLCR=m</span><br><span class="line">CONFIG_IP_VS_DH=m</span><br><span class="line">CONFIG_IP_VS_SH=m</span><br><span class="line">CONFIG_IP_VS_SED=m</span><br><span class="line">CONFIG_IP_VS_NQ=m</span><br></pre></td></tr></table></figure>
<p>能够支持绝大多数的TCP和UDP协议：</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>内 容</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>HTTP，FTP，PROXY，SMTP，POP3，IMAP4，DNS，LDAP，HTTPS，SSMTP等</td>
</tr>
<tr>
<td>UDP</td>
<td>DNS，NTP，ICP，视频、音频流播放协议等</td>
</tr>
</tbody>
</table>
<p>无需对客户机和服务器作任何修改，可适用大多数Internet服务。</p>
<p>LVS服务器集群系统具有良好的伸缩性，可支持几百万个并发连接。配置100M网卡，采用VS/TUN或VS/DR调度技术，集群系统的吞吐量可高达1Gbits/s；如配置千兆网卡，则系统的最大吞吐量可接近10Gbits/s。</p>
<p>LVS集群软件是按GPL（GNU Public License）许可证发行的自由软件，这意味着你可以得到软件的源代码，有权对其进行修改，但必须保证你的修改也是以GPL方式发行。</p>
<h4 id="三种IP负载均衡技术"><a href="#三种IP负载均衡技术" class="headerlink" title="三种IP负载均衡技术"></a>三种IP负载均衡技术</h4><h5 id="Virtual-Server-via-Direct-Routing（VS-DR）"><a href="#Virtual-Server-via-Direct-Routing（VS-DR）" class="headerlink" title="Virtual Server via Direct Routing（VS/DR）"></a>Virtual Server via Direct Routing（VS/DR）</h5><p>VS/DR通过改写请求报文的MAC地址，将请求发送到真实服务器，而真实服务器将响应直接返回给客户。</p>
<ol>
<li>同VS/TUN技术一样，VS/DR技术可极大地 提高集群系统的伸缩性。</li>
<li>这种方法没有IP隧道的开销，对集群中的真实服务器也没有必须支持IP隧道协议的要求，</li>
<li>但是要求调度器与真实服务器都有一块网卡连 在<strong>同一物理网段</strong>上。</li>
</ol>
<h5 id="Virtual-Server-via-IP-Tunneling（VS-TUN）"><a href="#Virtual-Server-via-IP-Tunneling（VS-TUN）" class="headerlink" title="Virtual Server via IP Tunneling（VS/TUN）"></a>Virtual Server via IP Tunneling（VS/TUN）</h5><p>采用NAT技术时，由于请求和响应报文都必须经过调度器地址重写，当客户请求越来越多时，调度器的处理能力将成为瓶颈。为了解决这个问题，</p>
<p>调度器把请求报 文通过<strong>IP隧道</strong>转发至真实服务器，而真实服务器将响应直接返回给客户，所以调度器只处理请求报文。</p>
<p>由于一般网络服务应答比请求报文大许多，采用 VS/TUN技术后，集群系统的最大吞吐量可以提高10倍。</p>
<h5 id="Virtual-Server-via-Network-Address-Translation（VS-NAT）"><a href="#Virtual-Server-via-Network-Address-Translation（VS-NAT）" class="headerlink" title="Virtual Server via Network Address Translation（VS/NAT）"></a><strong>Virtual </strong>Server<strong> via Network Address Translation（VS/NAT）</strong></h5><p>通过网络地址转换，调度器重写请求报文的目标地址，根据预设的调度算法，将请求分派给后端的真实服务器；真实服务器的响应报文通过调度器时，报文的源地址被重写，再返回给客户，完成整个负载调度过程。</p>
<h4 id="八种连接调度算法"><a href="#八种连接调度算法" class="headerlink" title="八种连接调度算法"></a>八种连接调度算法</h4><h3 id="DR"><a href="#DR" class="headerlink" title="DR"></a>DR</h3><p>LVS DR原理：</p>
<ol>
<li>用户请求LVS VIP到达Director（LB均衡器）。</li>
<li>Director（LVS）将所请求消息的目标MAC地址更改为后端RealServer MAC地址，目标IP为VIP（不变），源IP是用户IP地址（不变）。</li>
<li>Director（LVS）将消息发送到RealServer</li>
<li>RealServer检测到目的地是其自己的本地VIP（Real）。如果服务器处于同一网络段，则请求将直接返回给用户。如果用户和RealServer不在同一网络段中，则通过网关返回用户。</li>
</ol>
<p>在 DR 模式中，接收请求也是由Director分发者负责， rs 直接将响应数据返回给客户端，和 tun 模式不同，DR 模式中的分发者和后端 rs 必须在同一个内网,</p>
<p>这个模型还需要在<strong>Director中有一个VIP</strong>配置并且<strong>所有的rs都开启</strong>。</p>
<p>rs在响应客户端IP时需要<strong>设置源VIP地址</strong>，目标是IP为客户端IP，这样客户端访问到Director的VIP地址，响应的源地址还是同一个VIP地址，</p>
<p>Director不修改包报文，将包头的MAC地址改为rs的MAC地址，发送包到.rs..</p>
<p><strong>注意点：</strong></p>
<ol>
<li>LVS服务器和后端RealServer必须位于同一网络段（Intranet和公共网络）中</li>
<li>不要修改VIP消息的目标MAC目录。</li>
<li>LVS和RealServer需要配置VIP地址，VIP地址相同，并且RealServer VIP配置的网卡需要抑制ARP响应。</li>
<li>VIP保持不变。在Real Server客户端和Lo NIC上配置VIP（无冲突）。</li>
<li>RealServer客户端服务器的网关指向路由器，并给出一个fright （默认网关），以确保数据可以go out（访问互联网）<ol>
<li>The gateway of the Realserver client server points to the router and gives a fright (the default gateway) to ensure that the data can go out (access the Internet)</li>
</ol>
</li>
<li>所有RealServer客户端服务器都可以禁止VIP ARP广播，禁止VIP相应的解析。但确保real网卡不能禁止ARP广播</li>
</ol>
<ul>
<li>Real-Server和Direct-Server必须在同一网段</li>
<li>Real-Server的lo接口必须绑定VIP</li>
<li>抑制Real-Server原因:保证前端路由将目标地址为VIP的报文发给Direct-Server,而不是Real-Server</li>
</ul>
<p><img src="https://www.fatalerrors.org/images/blog/9ee7c79d3f5c29cea6a22761d80ec069.jpg" alt="img"></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ol>
<li><a href="http://www.linuxvirtualserver.org/zh/lvs1.html" target="_blank" rel="noopener">Linux服务器集群系统(一) – LVS项目介绍 (linuxvirtualserver.org)</a></li>
<li>LVS官网 <a href="http://www.linuxvirtualserver.org/" target="_blank" rel="noopener">The Linux Virtual Server Project - Linux Server Cluster for Load Balancing</a></li>
</ol>
<p><img src="https://img-blog.csdn.net/20161221162213297?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbmltYXNpa2U=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p>
<p><a href="http://fufeixiang.com/blogs/LVS-NAT-负载均衡的实现/" target="_blank" rel="noopener">LVS NAT 负载均衡的实现 | fufeixiang’s Blogs</a></p>
<p><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAeAB4AAD/4RDuRXhpZgAATU0AKgAAAAgABAE7AAIAAAAMAAAISodpAAQAAAABAAAIVpydAAEAAAAYAAAQzuocAAcAAAgMAAAAPgAAAAAc6gAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHNlbGZfZmx5aW5nAAAFkAMAAgAAABQAABCkkAQAAgAAABQAABC4kpEAAgAAAAMxMgAAkpIAAgAAAAMxMgAA6hwABwAACAwAAAiYAAAAABzqAAAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAxNzowODoyMCAxNTowMDowOQAyMDE3OjA4OjIwIDE1OjAwOjA5AAAAcwBlAGwAZgBfAGYAbAB5AGkAbgBnAAAA/+ELHmh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8APD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4NCjx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iPjxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+PHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9InV1aWQ6ZmFmNWJkZDUtYmEzZC0xMWRhLWFkMzEtZDMzZDc1MTgyZjFiIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iLz48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyI+PHhtcDpDcmVhdGVEYXRlPjIwMTctMDgtMjBUMTU6MDA6MDkuMTE5PC94bXA6Q3JlYXRlRGF0ZT48L3JkZjpEZXNjcmlwdGlvbj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyI+PGRjOmNyZWF0b3I+PHJkZjpTZXEgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOmxpPnNlbGZfZmx5aW5nPC9yZGY6bGk+PC9yZGY6U2VxPg0KCQkJPC9kYzpjcmVhdG9yPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPD94cGFja2V0IGVuZD0ndyc/Pv/bAEMABwUFBgUEBwYFBggHBwgKEQsKCQkKFQ8QDBEYFRoZGBUYFxseJyEbHSUdFxgiLiIlKCkrLCsaIC8zLyoyJyorKv/bAEMBBwgICgkKFAsLFCocGBwqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKv/AABEIAeoEEQMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APpGiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACikZlRSzkKqjJJOABWVF4q8PTzJDBr2mSSyMFREvIyzE8AAA8mmk3sJyS3Nais7VNf0zRrizg1O7WCS+l8q3Uqx3txxwOOo5OBzWjRZ2uF1ewUUUUhhRUc1zBbmMXE0cRlcRxh2C72PRRnqeDxUlABRRRQAUVQvtd0jS5li1PVLKzlZdypcXCRsR0zgkccVdR0ljWSNldGAZWU5BB6EGnZ2uK6vYdRRRSGFFFFABRRVPVNVtdHsWur19qj7qjlnPoB600m3ZAXKK8b1fxf4i1DUHmtbuSxg6JDEeFHue596o/8JB4o/6DN1/30P8ACutYSVt0Ze0R7lRXhv8AwkHij/oM3X/fQ/wo/wCEg8Uf9Bm6/wC+h/hR9Ul3Qe0R7lRXhv8AwkHij/oM3X/fQ/wo/wCEg8Uf9Bm6/wC+h/hR9Ul3Qe0R7lRXz5rHjvXdFtvMutbui7f6uMMNzn8unvXpvwm1y/8AEPgSPUNVnae4e4kXc3YA4AqKmHlTjzNjjUUnY7aiiiuY0CiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigCtqX/IKu/+uL/+gmvH/CngHw/rnwrfU72JoL7ZM32xZmGzYxxlSduMDnjp3HWvZbmH7Rayw7tvmIUzjOMjFeY23wbu0tUsLnxhfSaXuzJZRRFEbnPALlQc852mumjJRjJc3Le36nNXg5Si+XmSv+hl6Vr+ozeH/AhuDHI0mpNAZJ4EkYorqAVZgSpA4yuDx1rodH1bxPrXjXXbVdZS203SbxSV+yo7umT+6BwMAgHLHJHGO9bmpeBbW6Ph5LCcWVtoc4ljhEW/zACDjORgnHXnrVnQPC39ia5reom7+0DVphL5XlbfKxu4zk7vvegrSdWm02t9enmv0uYwo1I8sXtpfXyd/wBDzGX4r6lL9o1aHXLeDy7jEGhNZFvNiyBlpscNjnr27dK6TVfEvinxL4rfRvBFza2EdrbR3E1xcKCWLqCByrY4YdB1B5rTtPAOp6RPPD4f8VXGn6VPMZWsvsiSMufvBZCcr7EDj3PNL4m+HR1nX/7a0bW7rRL+RPLnktwT5gGAOjKQeBnnBwOKfPQurL+tN9NfxDkr2d3/AMHXprp+Bx3jKz8XnxX4VSfUbUXzqEtn2jbHOAokc/J0JwRwfoK2r7WfG2s+JpPDvhu9s7ObS7aM3t3KgImlZRnGUOBk8YUdDnsK2Ne+HZ1nR9GtodauLS90kYjvQhZnOBluGBByAc5496g1j4aTX17BqGl+I73S9S+zpBdXMIYm52qBuOHBBOBnk9B9aFUptJO2l+n3P0E6VVNuN9bdfvXr5nP3fxA8QD4ezzmVLfWdP1JbG4ljjRll4OTgggE45x6cYzivSdBtdWtrF/7d1KO/uJX8wGOARLCCB+7GPvAHPzHk1y83wutP+EKTQLTUJInN0t1PdyRb2lcDB4yMD0549+td0BhQPQVlVnTatDv28l+tzalCopJz7d/N/pY8R1/Q00Pxlq2o+NPDl3rel3c3mx31tM4+zpzwQpA7quGI+7xmtvxB45h0o6Homgayul6e1kkx1SW1Nw3l4IRQmOp285A/DFaGq/C6/wBSvrvb4v1CDTbqZpGsArFAGbcy/fC9Sf4fzrT1D4fRltKuPD2qTaRfaXALaK4ESzB48HhlOATyTnpyeOmNvaU3GKk72+7b+tjF0qqlNwVr+l9/63OQn+I+sy/D+5urK/jkvrLUktvtkcAUXMRBIbYwwpOPQYrc1fUvFPhW80K71bWkvLO8vvKvI47RESIOBtUHG4gfNzkE4Ga1NW8EX+u+FRpWreIHubr7Wtw141qoBwMBBGrAKMe/XJ71r+KfDsXifw3PpUs3kGTaUmCbjGykEHGR6Y696h1Kaaslvr6WXkvMtU6rTu3tp63fm/I42fxzqtpN4s1nzPO0rTJFs7K3MahWnyFJLAbiAeevRqoeFviFey+JtKs7rxBDrcepApPCliYDZyYyArbRvGeM+1djp/gSyt/A0vhq+ne6S4LvPcKoRndm3bwOcEYHr0o8PeGdc0i4tl1DxVLqNjaoUjtfsaRZ+XaNzglmAB6Hvg9qFOkk1/T09N769BOFZtPv+GvqtLepi/D3U/FHiWSW/wBQ1mP7DaXckJtxapun+XgFgBtC5BGOTzntXNfFHUL9PGbQQTS+VHAhVF5C5616R4P8L/8ACJ6Zc2f2z7X5909xv8rZt3ADGMn0615t8TcjxdfsrFSttCQQcd60oyjKt7u1jRRlGHvb3OP+36p/z0m/75/+tR9v1T/npN/3z/8AWqWCfSvIT7TLqXm4+fy2Xbn2zUnn6J/z11b/AL6Su+/kIqnUNTUEmWUAcklen6UwavfEZFy36UmrzWRsZBp8l7u2Nu89lxjHbFZ9t/x6Q/7i/wAqpJNE9bGj/a19/wA/L/pR/a19/wA/L/pVOiiyGcprtxNdazO9xI0jZwCx6DHSvpD4GDHwttfe4m/9Dr5r1b/kLT/739K+l/geMfCux95pv/Rhrkxn8P5hR+M9BoooryTsCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvDPiwx/4TW4jz8kltGHX1Fe514X8V/+R6k/64R/yrswf8T5GdT4TgvsNt/zyWj7Dbf88lqxRXrnLyrsVzYWxGDCuKnVQqhVGABgClopDslsFFFFAHIav/yFp/8AeH8hX0z8Ehj4Uab7yTf+jWr5n1j/AJC8/wBR/IV9N/BUY+E2le7T/wDo5648Z/DXqOj8bO8oooryTsCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvn34wS6kvxCnFtbQvF5EW1mkwTx/jX0FXhfxX/wCR6k/64R/yrswf8T5GVVXieb+frH/Pnb/9/aPP1j/nzt/+/tadFeucvK+5mefrH/Pnb/8Af2jz9Y/587f/AL+1p0UByvuZnn6x/wA+dv8A9/aPP1j/AJ87f/v7WnRQHK+5x2pmQ6jIZ1VZDt3KpyAdor6g+DAx8I9G9zP/AOj5K+Y9a/5DE/8AwH/0EV9P/BsY+Emi/Sb/ANHSVw43+GvUuj8bO3oooryjsCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvC/iv/AMj1J/1wj/lXuleF/Ff/AJHqT/rhH/KuzB/xPkZ1PhOKooor1jmCiiigAooooA5PXB/xN5fov8hX1B8IBj4T6J/uS/8Ao16+YddGNWf/AHV/lX1D8JBj4U6H/wBcn/8ARjVxY3+GvUqj8bOyoooryjrCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKK5L4oXN1a/DnVHsiyuyqjsvUIzgN+hI/GnFczS7ik7JvsSzfEnwjBqH2J9aiabeE/dxu6ZP+2qle/XNLJ490uKLXXaC8I0NwlziNTvJJHyfNz074rO8K+F/B8ngeyuFsNPuImtw813Kqlw2PnJc8qQc9CMY7Vyb3VxZR/Eq4s55LeeO4jKSxOVZfnboRyK6vZ07uKvp/ml+rOP2tS0ZO1n/k3/ket6dfR6npltfQJIkdzEsqLKu1gGGRketWa8f1rxNqc8/hvRhNrXkSaXFd3L6QN93OxXsxOcDGSffntVuPWPEEfwr8Q/b/AO1rWazkAsrq9Robhoiy4ye7DnJBPWlLDta+f62KhiE2l5fpc9VqnFq9hNrE2lw3KPewRiWWFeSik4GT0B9uvevJoLjxRo974O1i78RT3kGrNDC9oS2xVYKOckhmIOSxAOaf4d8O6gPjLqkR8Q3O+yaO4mb5s3SEqfLb5+gBA5yOOlP6uk3eXf8AAn6y2laPb8T2KiiiuQ7QooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvC/iv/wAj1J/1wj/lXuleF/Ff/kepP+uEf8q7MH/E+RnU+E4qiiivWOYKKKKACiiigDl9fGNUPugr6i+FAx8LND/64N/6G1fL3iEY1Me8Y/ma+o/haMfC7Qv+vb/2Y1w4z4F6lUfjZ1tFFFeWdYUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABUVzbQ3lrLbXUSywzIUkjcZDKeCDUtFAHn6/BfwumpLdo9+qLIHFuJx5Ywc7c7d2P+BZ962ZfAOlyxa7G094Brjq9zh1+Qgk/J8vHXvmunorV1qj3f8AX9IxVGnF3S/r+mcxqXgHStStdMj+0X1pcaZEsNve2s/lzBAMYLYxz9PpjJqY+DbN/Ct1oVzfahcxXbbprm4nEk7Hj+IjHAUDp0FdDRS9pNq1ylTgndI5268Fadd2eh20k10E0R43tirrlygAG/5eeg6YqG/+H+j6h4wg8SO9zFewuj7YnURuydCwKk9ABwR0rqKKFVmndP8Apg6UGrNf0gooorM0CiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK8E+Ll15fj6ZfImbEEfKpkHive68v8eeA9b8QeKHvtOSFoDEigvKFOQOeK6sLKMal5MzqJuOh479t/wCna4/790fbf+na4/79133/AAqjxP8A88rb/v8Aij/hVHif/nlbf9/xXp+2pfzI5+SRwP23/p2uP+/dH23/AKdrj/v3Xff8Ko8T/wDPK2/7/ioIPhn4huZrmKJLcvayiKUedjDFFfHv8rrT9tT7hyyOI+2/9O1x/wB+6Ptv/Ttcf9+677/hVHif/nlbf9/xR/wqjxP/AM8rb/v+KXtqX8yDkkeYSaXeeI/E9lp2mQO1zdAIiOMY5OSfQAZJPoK+sPDeip4d8NWGkRSmVbOFY/MYY3Hucduc1y/w98ADw1JNqeqRo2qSp5KlTuEcYOeD6knn6Cu7rzcTW53yrZG1OHLqwooorkNgooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiuU8VeMItLV7LT5Y2vSMMxIxD/ifaqjBzdkJtJakvifxzp3hmVIJEe7uW5aGIjKD1Ynp9K5//hcFn/0CLr/v4tcTLCs8zyzzrJI5LM7PksfUmmfY4f8AnpH/AN9CvRjhqaWupg5y6Hc/8Lgs/wDoEXX/AH8Wj/hcFn/0CLr/AL+LXDfY4f8AnpH/AN9Cj7HD/wA9I/8AvoVX1el2Dnkdz/wuCz/6BF1/38Wj/hcFn/0CLr/v4tcN9jh/56R/99Cj7HD/AM9I/wDvoUfV6XYOeR3P/C4LP/oEXX/fxaP+FwWf/QIuv+/i1w32OH/npH/30KX7HCejx/8AfQo+r0uwc8juP+FwWf8A0CLr/v4tbPhL4g2fi3VrqwtrSWCW1iEj72B6nAHHevDvFeqxaHALeDDXkq5UdkX+8f6Vv/s7Mz+JNbZyWZrZCSTyTvqKtCnGm5JBGo3JI9/ooorzToCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKyNG/5C3iD/ALCCf+ksFa9ZGjf8hbxB/wBhBP8A0lgq47P+uqIluv66M16KKKgsKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvnbxyC3jzVQoJJuCAB34FfRNeJSxJN8cdkqhl/tAHB9QMj9RXZhHaUn5GVTVIt6J8IL28to7jWL0WW8Z8hI97ge5yAD+dbH/CmNP8A+gtc/wDfta9KoqHiqrd7leziea/8KY0//oLXP/ftaP8AhTGn/wDQWuf+/a16VRS+sVe4ckex5r/wpjT/APoLXP8A37Wj/hTGn/8AQWuf+/a16VRR9Yq9w5I9jzRvgvYbTt1a4B7ExKa4Pxb4MvvCVzGLh1uLWYkRXCDAJHYjsa+h64v4rxq/gWVmGSk8bKfQ5x/ImtaOIqOaUne5MoK2h8y+I23ajGP7sQH6k/1r079nT/kYdZ/69U/9Dry/xD/yEx/1zH9a9Q/Z0/5GHWf+vVP/AEOu3EfwWc0P4iPoCiiivFO4KKKKACiiigAooooAKKKKACiiigAooooAKKKKAKt/fixWAC3luJJ5PLjji25J2s38RA6Ke9V/7Uu/+gFqH/fy3/8AjtGqf8hHRv8Ar9b/ANJ5q0q10iloZe9KT1tb07Gb/al3/wBALUP+/lv/APHaP7Uu/wDoBah/38t//jtaVFLmX8q/H/MfJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZv8Aal3/ANALUP8Av5b/APx2j+1Lv/oBah/38t//AI7WlRRzL+Vfj/mHJL+Z/h/kZjaldspU6FqGCMHEkA/9q1yHhHQtc0DXNSvNQg1e8hkbFrG93E3y8Dc4MuC21UX6L9K9Coqo1uVNKK19f8yJUeZqTk9PT/Izf7Uu/wDoBah/38t//jtH9qXf/QC1D/v5b/8Ax2tKip5l/Kvx/wAy+SX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47R/al3/ANALUP8Av5b/APx2tKijmX8q/H/MOSX8z/D/ACM3+1Lv/oBah/38t/8A47Udxrc1rbS3Fzot/HDEheRy0B2qBknAkz09K1qzfEf/ACK2q/8AXlN/6AaqDjKSXL+f+ZM1KMW1J/h/kaVFFFYmwUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRXgHiS18OXPxF8THxPf3VnsIa1+zpuMj7RwflPt3H1rrtD8T6l4O+Edrea3HJNeTTGGwiuXKnafu7ieigBj9MDgdOp4d8iknq7ficixK9o4taK/Xt3R6jRXCeGfHN9f6/LouqnSLy6a2NxbzaRcb4mx1jYknDd6p2nj/AFa28SabZaxN4evINQm8jbpNy0ktu5xjfkkYyccD1+hj2E72L+sQ5eY7+31Czu554LW7gnlt22zRxyBmiPowHQ8HrVivP/AH/I9eNv8Ar9T+b1jfF2K4bXNNk1oag3hhYz532DGVl5wTu+XPKgFu27HOaFSvUUL7pflcHWapynbZtfc7HrNFefeHdT8PeDvhzfanoeoTanpscpeNJTiRZCFXyzwMZbnOBwc89TF4e+ImoXOvabZa02iyx6op8n+zLgu9s2MhZRk8npx3odCV3y9Pl5gsRFJOXX5no1Feb6H4w8ZeIdMv76wsdJWGxeZCZFk3TMq5VUUN64ySR97jpUh+ImoXfhnw5PpUFpJqmsXPkPE6sUj2khyAGB4ODyeho9hO9vT8Q+sQtf1/Dc9EorzPWPiZfLq+px6KdFjtNKOyVdRuSk10y53CJQR6EDOe3rirN74/1e71jQrPw1Z2co1iyM6i63fun+bqwP3Vxzxk4460KhNpPv8A5X/IbxFNNrt/nb8z0OiqsK30mkol3JDFftDiSSBSY1kxyVDckA9M15v4V0ufRvjLdWd3qd1qcy6SC9zdOWZiWQnGc4HoMnFTCmpX12KnUcUnbc9SooorI1CiiigAooooAKKKKACiiigAooooAK8VP/JdP+3/APpXtVeKN/yXP/uID+VdeG+16Gc+h7XRRRXIaBRRRQAUUUUAFcZ8Vf8AkQ5/+u0f/oVdnXF/Fb/kQ5v+u8f861o/xI+pMvhZ8x+If+QmP+uY/rXqH7On/Iw6z/16p/6HXl/iH/kJj/rmP616h+zp/wAjDrP/AF6p/wCh16uI/gy/rqccP4iPoCiiivFO4KKKKACiiigAooooAKKKKACiiigAooooAKKKKAM3VP8AkI6N/wBfrf8ApPNWlWbqn/IR0b/r9b/0nmrSrSW0fT9WZw+KXr+iCiiiszQKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAiurmGys5rq5fZDBG0kjYJ2qBknA56CshvGGlLLHEyakJJQTGh0m6y4HXA8vnGRUvi2QReDNYY/wDPlKOvqhFcfc3f/FQaQf7a8SHbFN8zaPh04XhV+zfMPXg446VtTpqS1MatRwat/X4o7vTdVtNWileyaU+TJ5UiywPEyNgHBVwD0IPTvUj31tFqEVlJKFuJkZ40II3hcbsHoSMjjrXFWsgbwf4ycz3VxueYeZdweVK3+jIPmTYuPT7o7VZh8LlYI1bwT4WYhQCWm5PH/XtTdNJ6+X5fISqSa08/wflc7Sq6X1u+oS2Kyf6TFGsrRlSPlYkAg9CMg9OlcVPoMltoZS78OWzrFqElzHZwkSWqKY9oLKIy7DkkKsedwGcDmqr2fhw2f2aDT4DqkR85y3hOUowYnCmMRbgnBAO7Py9TyCKmn1B1Wuh317qFrp0aSXsohjdxGHYHaCemT0UdsnAyQO4qlL4ksYZXjeDUyyMVJTSrphx6ER4I9xxXKxQPp62Kx2TaYy2OpSpCjDCbmRwUwFKrzwCqsOhGRVXw3qfna7oSQ6jDM00bmdIfEE16z/uSfnicYTnnvg8U/ZLlb7f8H/Il1np5/wDA/wAz0Szu4b+yhu7R98E6CSNtpXKkZBweR+NTVkeE/wDkTtI/684v/QRWvWM0oyaRvFtxTYUUUVJQUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAVm+I/wDkVtV/68pv/QDWlWb4j/5FbVf+vKb/ANANaU/jXqZ1f4cvQ0qKKKzNAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAOCHw4iv8AxT4hvtditLi01NVFvtyZYTjBYEr8p+hNVpfh/repeCDoGsahayyWM4l027yzkqMgJKrLwMHHBbAPQ459GorZVppJdrfgYOhBtu29/wAdzgtP8FanLaahDqln4b05p7OS3hm0ezKyBnGCzMQDgDsOuT7Vj6f8M9chudCknGgQDS7lHkazidZZ0BB3PIVyzcHjAHPWvVaKpYiad0S8NTas/wCv6scv4Y8M3mi+JPEWoXUkDxapcLLCsbEsoG772QMH5h0zUHirSPGlzqyXPhHXLaygaEJLDcrkbgSdwyjDkHnp0HXt19FZ+0fNzP8Aroa+zXK4rrr+NzgNJ+GfkeBNS0TU75Xu9Sk86WeKP5InGCNo4yAR7Zz2p3hbwdq2mahZnVtP8LrBaLxcWVmRcyMFwpLFQB6kjnI9zXe0VTrzd79f+GI+rwVvL/hzl/Afhm88L6Pd2moSQSPNePOpgYkBWAwDkDnisbw18O7vRfG0mo3FzbyaZbvO+nwIzF4mkIzkEYHy5HBNeg0UvbTu330G6MGkuzuebXnw71Oz8Raje6JbeHdQtr+TzjHrNqztA5JJClQeDnPX8OMnXHg27j8Z6BqsLWaWumWTQSxxr5ZZyGyURV2gZbOMiuyop+2nZL+trC9hC7ff/O/5hXLweGbyL4nXPiNpIPsctiLZUDHzA2VOSMYxwe9dRRWcZOOxrKKktQoooqSgooooAKKKKACiiigAooooAKKKKACvE5SF+OQzx/xMVH8q9sr558aTyW3xC1KeByksV1vRh1Vhgg12YRXlJeRlU0SPoaivOdG+L+my2aLrcE1vcqMO0Kbkc+o5yPp+taX/AAtfwx/z1uf+/BrF0KqdrF88e52lFcX/AMLX8Mf89rn/AL8Gj/ha/hj/AJ7XP/fg0vY1P5WHNHudpRXF/wDC1vC//Pe4/wC/Bpf+FreF/wDnvcf9+DR7Gp/Kw5o9zs64r4sHHgWT3nj/AJ0p+K3hgDie4PsIDXn3jzx7/wAJV5VpYwvBYQvv/eY3SNjAJA6AAnj3rajRqe0TaJlJWPJPEP8AyEx/1zH9a9Q/ZzH/ABUGsn/p1T/0OvNNXtpbzXI4LdC8joAoH41618Ap0i1nV9OtHDwRQI8kgH+tk3YznrgdB9Se9d+I/hM5qf8AEPcaKKK8U7QooooAKKKKACiiigAooooAKKKKACiiigAooooAzdU/5COjf9frf+k81aVY+vXltYXGkXF9cRW0CXp3SzOEVcwSgZJ460v/AAlvhz/oYNL/APA2P/GtXGTjGy6fqzGMoqUrvr+iNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/QwaX/AOBsf+NQoyeyNHKK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/QwaX/4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf8AhLfDn/QwaX/4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of9DBpf8A4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of8AQwaX/wCBsf8AjQoyeyByitGzXoqtfajZaZCJtSvLe0iZtge4lWNS2M4yT14P5VR/4S3w5/0MGl/+Bsf+NCjJ7IHKK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/AIS3w5/0MGl/+Bsf+NCjJ7IHKK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/QwaX/AOBsf+NCjJ7IHKK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/AEMGl/8AgbH/AI0KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of9DBpf/gbH/jQoyeyByitGy5qemw6tZ/Zbov5JkR3VSBvCsG2n/ZOOR3FNvdMS8vILrz5oJ7eORI3i2/LvABOGBBIwMdvUGpL7UbLTIRNqV5b2kTNsD3EqxqWxnGSevB/KqP8Awlvhz/oYNL/8DY/8aaU7aCbgnqxsfhi2+xy291dXV2J7pbqd5SgMzLtwGCqBt+ReABnHPetmq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/AEMGl/8AgbH/AI0WnJCvCL3L19azXcIS3v7ixYNkyW6xliPT50YY/DNZKeGLhL+W9XxJqouJY1jd9lryqliox5OOrN+da19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/AEMGl/8AgbH/AI0489tF+AS5L+8/xJE0RDcW097d3F9LbxSxbpxH+8WQrkMFRQfugDAHfOanvLB7i1jgs72fTlTABtUj+7jG3DowA+gHSn32o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf8AhLfDn/QwaX/4Gx/40rSl0C8I6Nl/T7KLTdNtrG3LGK2iWJC5ySFGBn3qxVa+1Gy0yETaleW9pEzbA9xKsalsZxknrwfyqj/wlvhz/oYNL/8AA2P/ABotKWth80Y6XNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/AEMGl/8AgbH/AI0lGT2Q3KK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/AEMGl/8AgbH/AI0KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of9DBpf/gbH/jQoyeyByitGzXoqtfajZaZCJtSvLe0iZtge4lWNS2M4yT14P5VR/wCEt8Of9DBpf/gbH/jQoyeyByitGzXoqtfajZaZCJtSvLe0iZtge4lWNS2M4yT14P5VR/4S3w5/0MGl/wDgbH/jQoyeyByitGzXoqtfajZaZCJtSvLe0iZtge4lWNS2M4yT14P5VR/4S3w5/wBDBpf/AIGx/wCNCjJ7IHKK0bNeiq19qNlpkIm1K8t7SJm2B7iVY1LYzjJPXg/lVH/hLfDn/QwaX/4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf8AhLfDn/QwaX/4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of9DBpf8A4Gx/40KMnsgcorRs16KrX2o2WmQibUry3tImbYHuJVjUtjOMk9eD+VUf+Et8Of8AQwaX/wCBsf8AjQoyeyByitGzXrN8R/8AIrar/wBeU3/oBqzfajZaZCJtSvLe0iZtge4lWNS2M4yT14P5Vha94o0Cfw5qUUOuabJJJaSqiJdxksShAAGeTV0oyc00upnVlFQkm+h01FFFZGwUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABWL4l8SQeHtPMhAlunB8mHP3j6n0FbVfPGt+J9SuNbu2nkSRhMygsvQAkAV0Yej7SWvQicuVHSn4g+Kyf8AW2w/7YCk/wCFgeK/+e1v/wB+BXGf2/e/9Mv++KP7fvf+mX/fFel7GP8AKjDmfc7P/hYHiv8A57W//fgUf8LA8V/89rf/AL8CuM/t+9/6Zf8AfFH9v3v/AEy/74o9jH+VBzPudn/wsDxX/wA9rf8A78Cj/hYHiv8A57W//fgVxn9v3v8A0y/74rN8QeIL/wDseVEdY95ClkXBwevNHsY/yoHNrqem+B/iZqviH4gR6HczQTQCGRpGjjA+ZRwAa9br5f8AgYcfFK197eb/ANBr6grz8VFRqWRrSk5RuwooorlNQooooAKKKKACiiigAooooAK8O8e6dpZ8XXjRXshmd90wIAVG/uivca8B8bf8jtqn/Xc/yFdmE+NmdTYyP7Os/wDn7P5Uf2dZ/wDP2fyqGivT17mBN/Z1n/z9n8qP7Os/+fs/lUNFGvcCb+zrP/n7P5Uf2dZ/8/Z/KoaKNe4E39nWf/P2fyo/s6z/AOfs/lUNFGvcDB8SXVtprvbaexe5uECzTH+FP7o+veu5/Z0/5GHWf+vVP/Q68x8Tf8hlv9xa96+Bfg59E8Nya3eqy3WqhTGh/ghH3T9Wzn6Y96wxLUaTT6k003UPVKKKK8c7QooooAKKKKACiiigAooooAKKKKACiiigAooooAzdU/5COjf9frf+k81aVZuqf8hHRv8Ar9b/ANJ5q0q0ltH0/VmcPil6/ogooorM0Ciql1qUVvL5EaPc3JGRBCMsB6nso9yQKg+y319zfz/Zoj/y72rEE/70nB/75x9TVqGl3oQ562WpYutTs7JglzcIkjfdjzl2+ijk/gKg/tC8uP8Ajx02Tb2ku38lT+GC35qKtWtja2SkWlvHDu5YooBb3J71PTvBbK4rTe7t6f1+hneRq8w/e3ttbj+7DAWI/wCBM2D/AN80f2TK4/f6rfSH2ZE/9BUVo0Ue0fT8g9nHr+bM7+w7Uj5579vc38w/k9J/YNl2a8HuL6Yf+z1pUUe0n3Yeyp/yozf7EhH+qutQQ/8AX7I3/oTGl/s27T/UavdD/ZlSNx/6CD+taNFHtJdQ9nHojNxrUPRrK8HoVaA/n84/QUf2uYONRsri1/6aBfNj/wC+kzgf7wFaVFHMnuv6/L8A5Gvhf6/8H8SK3ure8iEtpPHPGf4o3DD8xUtUrjSbK5lMzQiOf/nvCSkn/fQwT9DxUW7UrH7w/tGAfxLhJl+o4Vvw2/Q0csX8LDmkviX3f1/maVFQWt7BeozW75KnDoQVZD6Mp5B9jU9Q007MtNNXQUUUUhhRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABWb4j/AORW1X/rym/9ANaVZviP/kVtV/68pv8A0A1pT+NepnV/hy9DSooorM0CiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK+a76Qx313hxHuvXBbGcDJr6Ur5f1lfN1S7QsyhbmQgocH71ehgt5GNXoaeyw/6D3/AJJtRssP+g9/5JtXN/ZB/wA9p/8Av4aSK2+0zmCzN7dzL1jtleVh9QoJFd7Vt3+Rhd9iWeZ5NYKtJvVYjg4xn5vSpKlTw5rEDGdtD1psrty1nK+B9AM1XEq+c0LZSZfvRSKVdfqp5FNSi9mCT6j6zNf/AOQW3++K06zNf/5Bbf74qhPY2fgecfFSx94Zv/QDX1HXy18Ejj4rad7xzf8Aopq+pa8nGfxPkb0PhCiiiuM3CiiigAooooAKKKKACiiigBGYKpZiAAMkk9K+f/GUscvjLU3jkV1aYkMpyDwK9I+JOuNBpv8AY9o2Jrpczkfwx+n4/wAs+teT/wBne1elhKdlzvqYVJdCpuHqPzo3D1H51b/s72o/s72ruujIqbh6j86Nw9R+dW/7O9qP7O9qLoCpuHqPzo3D1H51b/s72o/s72ougKm4eo/OjcPUfnVv+zvaj+zvai6AoeHvCkfir4jQxX7pFpsCLNdO7BQyj+AE92PH0ye1fTdvJBJAv2R42iX5V8ogqMduK+atQSLTbGS6n4VBwP7x7CvX/g5BexfDm2l1GJo5LqaSdA3dGPyn6YHHtiuDFxulK5pSaTsd3RRRXnHQFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAGbqn/IR0b/r9b/0nmrSrN1T/kI6N/1+t/6TzVpVpLaPp+rM4fFL1/RBVCSea+kaGwfy4kYpLcgZwR1VOxI6E9AeOSCAXcr3N0LC2cx/KHuJFOCiHooPZmweewBPXFXY40hiSKFFjjRQqoowFA6ADsKXwq73D4nZbEdraQ2cPl26bQTuYkksx9STyT7nmmTX8UN9BaMrmSYEqQBgY9as1jX/APyM+m/7r/yNefja86UYSju5RXyckmdNCnGTcfJ/gh1z4ls7W5kgkjnLRttJVRj+dWF1i1ea2RN7C5B8t8fLkdj3zWKG1D+1NTj06COUSPtk3kcdfUj39anvNMew8PwMCGntJBKSOnJ5A9un5V89SzHHtVKrV4Ru/htopWaTv73u3d7aNHfKhQXLHq7de6/DU2J9QigvobVldpJskbQMKPU8/wCcVRbxNYC58pRK/wAwXeqjaf1zUdg66jrF1fHmGOMRIfwyf6/nWeLg6Mn+iXdteWUj/wCoJG/n1H0GP6VpiMzxEUqqklTcpa2u7JpLS6dnq7q/TQVPD02+Rq8rLy1Z1lFAOQD60V9UeYFFFFABRRRQAUUUUAVbqwjuZFmRmhuUGEnjOGA9D/eHsePx5pLa7kM32W+VY7kDI2E7JR/eXP6r1Ge4wTbqG6tUu4NjFkYHckifejbsw9/59DwatSurSIcbO8SaiqlhdPOskNyFW6tyFlC8A8ZDD2I/I5HardS007MpNNXRleKLy4sPC9/dWUphnihLJIFB2n1wQR+YrmL/AH2/ja0t5/E2pgRWzo9z5NuRC8rJsjZhDtXdsP3vRcEZ56rxDp0ur+Hb3T7dlSS4iKKzsQB+I5FI+kW9potxZafYW86zBi8NzIwWct94yOQzEkdSQSa0hJRVzKcZSdjCm1HUIPB+uyTaiJZLKeaJZrm3V2dABhdsewbiTgH1PQ1z1xqv2zw9YW93reoQ2H2cJfyWulMIoVUABDujdllOV+bcBgBgOVz12neGmj0Ge0v44TLJcPcRxrM8qxNjCfOwBfGAckdfpmq8nhfUriazV72OOK1hiVHY+b5TqoBMUZUIrdSJH8wjPAFaxlBN38u3YylGbSt59+/+X9IqNeXlvptpv8Q6hDLJPh7Z0gmvPL2MVVUSEnecozBgcDPPBNPOjaxbo2spd6ybyYCOe3jkszL5Slipx5OxnGeme5AY4AN610S/03SLjTFs9O1a3kl3br2Vo2nU/eM37tw75A+bv6LjnJj8HSpq0923hHwu0MsMca25nO1CpYlh/o3U7gOn8IovG7tb8P8AgByysr3/AB/4Ij38l7BZpc3p1BYo76fe6GGRZIXXy921UZHVWwQAucnqDVLTEsdS1nTBf6Lo9x/aQeSYt4cltmDeWXyJZCVfn069a6ptFur64sZLuC1s4obS4tZILWYuFV9gXYSi9Ap7DHHWo/8AhGV0oWk2jQSXtzajZH/aOrXGxAVKkgYdc44wFHXtS54qLS317ef/AAAdOTs/v38v+CXPCQA8G6OAMAWUWB/wEVr1R0Sxk0zQbGxmZXkt7dInZOhIUA49qvVjUd5to6YaRQUUUVBQUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAVm+I/wDkVtV/68pv/QDWlWb4j/5FbVf+vKb/ANANaU/jXqZ1f4cvQ0qKKKzNAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACvmDViF1e9LEACeQknt8xr6fr5r03T18SePZbGaCQWsU0lxciRcB1D/Kn4sRn1ANd2ElyqTZjV6GSQCCCMg9RXtXge7srvw1b/wBn28NqI/kkhhQIquOvA9ev41k654LtNZVprXba3n94D5X/AN4f1/nXP+Fbq88HeKhZavG0EF0Qjlvu5z8rg9CM8fj7V0VHGtDTdGcdGewj/V1i67omm65amDVbSO4UfdZhhkPqrDlT7g1tH/V1SmNcC3NWeJeKPC1x4YulYO9zp0rbYp2A3Rt2R8cc9m79ODjPJa//AMgtv98V9BatY2+qafPZXieZBOhRx/UHsR1B7GvnrxCs1pDc6fdI5ntZvKkk24ViDw34jB/GvSoVHJWZzz0Nf4KHHxZ0r3Sf/wBEvX1RXyr8Fzj4t6P7if8A9ESV9VVx4z+IvQ2ofCFFFFcRuFFFFABRRRQAUUUUAFRXU/2azmn27vKjZ9ucZwM1LSEBlIYAgjBB70AfP974sj1C9lurqCR5ZW3Mcj8vpUH/AAkFr/z7SfmK9+/svT/+fG2/78r/AIUf2Xp//Pjbf9+V/wAK9D61BfZMfZvueA/8JBa/8+0n5ij/AISC1/59pPzFe/f2Xp//AD423/flf8K4nxmNXs/EOjx6BocEtr52ZPliX7S212MfPoiOfrjuBm4YiM3ZL8TOouSN2eb/APCQWv8Az7SfmKP+Egtf+faT8xXvq6Zp5UE6fbqSOhhXil/svT/+fG2/78r/AIVH1uP8v4mns33PAf8AhILX/n2k/MUf8JBa/wDPtJ+Yr37+y9P/AOfG2/78r/hWVq9nawapoUcNpbolxftHKBCvzr9mnbB4/vKp/Ck8ZFL4TSnh3N2T6N/cr/oeLf8ACQWv/PtJ+Yo/4SC1/wCfaT8xXv39l6f/AM+Nt/35X/Cj+y9P/wCfG2/78r/hT+tx/lM/ZvueI+HvCzeP/FNs1xE6aBp6iacMMefKScR/kOfY+4r3dVVFCooVVGAAMACmwwRW8ey3iSJM52ooUZ/Cn1y1arqO/QuMeUKKKKxLCiiigAooooAKKKKACiiigAooooAKKKKACiiigDN1T/kI6N/1+t/6TzVfnmS3t5J5TtjjQux9ABk1Q1T/AJCOjf8AX63/AKTzUa+c6NJEek8kcBHqHkVSPyJra3M4L+t2Y83Kpv8ArZEmkQuliJrgYuLljPL7Fui/8BGF+i1eoorKT5nc0iuVWCoZLSCW6juJEzLFkI2Txn2qaiolCM9JK/X5rYtNrYhhtIIJpZYk2vMcuck5NSSRpNE0cg3I4KsPUGnUVKpwjHkSVu3TXcbk27tkNrZwWcHk20YSMkkrknP51Vj0PTYphKlqu5TkZYkfkTivMtb8c+IbTX9Qt7fUNkMNzJGi+RGcKGIHJXPaqP8AwsDxN/0E/wDyXi/+Jrv/ALBjUjBuMPd2029NNPkeW86hCTXvefn+J7XRXin/AAsDxN/0E/8AyXi/+Jo/4WB4m/6Cf/kvF/8AE11f2VX7r8f8jH+16HZ/h/me10V4p/wsDxN/0E//ACXi/wDiaP8AhYHib/oJ/wDkvF/8TR/ZVfuvx/yD+16HZ/h/me10V4p/wsDxN/0E/wDyXi/+Jo/4WB4m/wCgn/5Lxf8AxNH9lV+6/H/IP7Xodn+H+Z7XRXin/CwPE3/QT/8AJeL/AOJo/wCFgeJv+gn/AOS8X/xNH9lV+6/H/IP7Xodn+H+Z7XRXin/CwPE3/QT/APJeL/4mup8AeKdY1vXp7bU7vz4ltmkUeUi4YMo/hA7E1nVy6rSg5tqy/rsa0szo1ZqEU7v0/wAzsdR/0S8tb9cBd4t5uOqOcL+TlfoC1aNUNdXd4ev8feFu7LnswUkH8wKuxv5kSuOjAGuF6xTO+Ok2h1FFFQaBRRRQAUUUUAFFFFABRRXFfETxDqehDTv7KufI8/zPMPlq2du3H3gfU1rRpSrTVOO7Ma9aNCm6ktkdrRXin/CwPE3/AEE//JeL/wCJo/4WB4m/6Cf/AJLxf/E16H9lV+6/H/I83+16HZ/h/me10V4p/wALA8Tf9BP/AMl4v/iaP+FgeJv+gn/5Lxf/ABNH9lV+6/H/ACD+16HZ/h/me10V4p/wsDxN/wBBP/yXi/8AiaP+FgeJv+gn/wCS8X/xNH9lV+6/H/IP7Xodn+H+Z7XRXin/AAsDxN/0E/8AyXi/+Jo/4WB4m/6Cf/kvF/8AE0f2VX7r8f8AIP7Xodn+H+Z7XRXin/CwPE3/AEE//JeL/wCJo/4WB4m/6Cf/AJLxf/E0f2VX7r8f8g/teh2f4f5ntdFeRaJ458Q3ev6fb3Gob4ZrmON18iMZUsAeQue9eu1x4jDTw7SnbXsd2GxUMSm4J6dwooormOoKKKKACiiigAooooAKzfEf/Irar/15Tf8AoBrSrN8R/wDIrar/ANeU3/oBrSn8a9TOr/Dl6GlRRRWZoFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQBma/4gsPDWlPf6nLsjXhEXlpG/uqO5ryD4ebb2+1zVQNpmuVhC5yVAXzOv/bX9K9Y8SQRX62OmyRJIbu5UNuUHbGnzv8AgQu3/gVeT+BZ4rXxJrumKAgab7REg7gHY2PptT/voV2UkvZPuctRyc/L9T0OEVzfxRvk0v4dX96bOO6kj2LH5g4iZmC7/XjP+RXSwipNQ0mz1zSLjTNThE1rcpskQnGR6g9iDgg+1RezuUtUfMWhfFjxdpOsQ3M2rXN9AGAktZ23I69wB/CcdxX1HK2Vz6jPNeWt8CNO0Fn1XTL65vbm1YT21tcIhUlTnDYHzdPbmur8PeNbTXkWC42219jmMn5X/wB0/wBOv1rSUeZc0RK60ZsTHrXhvxPQR+JNQ2/8tEt5W+uCv8kFe4zV4N4+u11DWdWuYzmNJkt0Pr5Yw3/j5cfhWuH+MiewfBs4+Lei/Wb/ANESV9W18ofB84+LOif78v8A6Jevq+ssb/EXoa0PhCiiiuI3CiiigAooooAKKKKACiiigAooooAKyNZ/5C3h/wD7CD/+ks9a9ZGs/wDIW8P/APYQf/0lnq4b/f8AkRPb7vzNeiiioLCsbXP+Qx4c/wCwk/8A6SXFbNY2uf8AIY8Of9hJ/wD0kuKie3zX5nThvjfpL/0lmzRRRVnMFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAZuqf8hHRv+v1v/Seal14Y0aWXBP2dkuCB6Rurn9FpNU/5COjf9frf+k81aLKroVcBlYYIPcVrfl5X/W7MeXm51/WyFBBGRyDRWfpLmGJ9PmYmWzwoLdXjOdje/AwT6qa0KiS5XY0jLmVwoooqSgooooA8C8R/wDI06r/ANfs3/oZrNrS8R/8jTqv/X7N/wChms2vtqfwL0PhKv8AEl6hWjbaBqV3dW9vb22+W5h8+Jd6jcnPPX2PHWs6u2hdop9OeNirroMpVgcEECTms61SUF7vn+RpQpxqStLy/NL9TkYLG5uXnSGIlreNpZQSFKqvU8+np1qzaaHfXttHPAsIjlcxx+Zcxxl2GMgBmBPUfnXU2Yj1ax1LXYNqzNp00V9EOMS7eHA9GAP4g1kBbA+E9LbUZrlFW5nIWCJWLj5MjJYbfrg1n7eTdvl37mv1eKV91rbp2/z18zFk0+6ht5J5YWSOObyH3cFXwTtI69jT49Ku5IreXbEkdzv8p5Z0jVtvDcsRjr361s315JrPhzUr0R4b+0kmkRTny1KMoz7ds+tVdW/d+GNDicFZNs8m0jB2s42n6HBq1Um7J73t+FyJUoJNrVWv/wCTW/IqX2iXumx77wW6cKwVbqJ2IPQhVYkg+uKz62/FX/IStf8Arxt//Ra1iVpSlKUE5GVWMYztEK7b4V/8jTc/9eTf+hpXE123wr/5Gm5/68m/9DSsMZ/u8/Q3wP8AvMPU9I18/wDEhuoh964T7OuP70h2D9WrRACqAOAOBWdL/p2sRxKcw2J8yX0MpHyr+AO4/Va0a+UlpFI+vjrJv5BRRRUGgUUUUAFFFFABRRRQAV5x8W/+YR/22/8AZK9Hrzj4t/8AMI/7bf8Asld2X/7zH5/kzz8y/wB1l8vzR5vVqy0661BnFrFuWMbpHZgiIPVmYgD8TVWtxFaXwMwthnyb3fcqvUKUARj7Z3D6n3r6epJxWh8pTipSszNvNNurARtcxrslBMckciyI+ODhlJBx354pJdPuodQWxkixcMVATcOSwBXnOO4rTjDQ+B5/tOQlxeI1qp/iKqwdh7cqM+v0q7f28svj6xaJGdZzbSRFRkOu1OR7cH8jWaqu7T8/wt/n+Bq6S5VJeX6/5L7zJt/D2o3U0sMKW5liZ1eNruJWBX73BYHAweelC+H790d1Np5cZCtJ9uh2AnJA3b8E8HitXSpEm8cajLEwZHW8ZWHcFHwaraelq/g67F9NNDH9uiw0MIkOdj9iy/zqHVqL8Oj6v1NFRpt213kt10V+xmNpN8l3cWr25Wa3jaSVSQMKBknOeRjnjr2qOCxuLm2nnhQGK32+axYDbuOB1PrXQ6fejVtauo7WNlU6ZJbW0bnc7hY8DOOrHBOBVLTQY/CWttICqyNBGhI4Zg+4ge+Bmq9rJLXfT8XYj2UHqnp734K5A3hzUEthcMbMQklRJ9vgwSOSAd/J5HFZVbdx/wAiLY/9f03/AKAlYlaU5SknzdzOpGMbcvVGl4c/5GnSv+v2H/0MV77XgXhz/kadK/6/Yf8A0MV77XiZt8cfQ97J/wCHL1CiiivGPbCiiigAooooAKKKKACs3xH/AMitqv8A15Tf+gGtKs3xH/yK2q/9eU3/AKAa0p/GvUzq/wAOXoaVFFFZmgUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFMllSCF5ZmCRxqWZj2A5JoAy7f/AEzxXdT9Y7CFbZPaR8O//joi/M18+XN9caV4qk1KyG6e2uZD5ZOBKhJDJ+I/IgHtX0N4ciddFjuJ1Kz3jNdSqeqmQ7gp/wB0EL/wGvnXVf8AkMXn/Xd//QjXo4ZJuUTml8Kfc9k0LVrPXNNivtOl8yGTj0ZG7qw7EdxW7COlfPWmalqOhX5vdEufJkbHmwuN0U+P76+v+0MGvQtG+L1gVVPEGm3dhKOskCm4iPuNo3D6FampQlF6ajjJdT0qXpXi/j3Qzo+vfa7ZStvdkyKV42P/ABD+o+vtXcT/ABT8I+XlNSlkOOFSynJP4bK4nxZ4+h8Q2n2HTtKkEO8Mbq7YIVwf4EGT045x16U8OpxlsE2mivH471SHQ57bCzXezbb3Dn7hPGW9cDn3x75rhdXhEGhmNSSFK8scknPJPua1az9c/wCQRL9V/mK71CMXdGT2J/hGcfFbRP8Aro//AKKevrKvkv4TnHxU0P8A67N/6A1fWlebjfjXoa0PhCiiiuI6AooooAKKKKACiiigAooooAKKKKACsjWf+Qt4f/7CD/8ApLPWvWRrP/IW8P8A/YQf/wBJZ6uG/wB/5ET2+78zXoooqCwrG1z/AJDHhz/sJP8A+klxWzWNrn/IY8Of9hJ//SS4qJ7fNfmdOG+N+kv/AElmzRRRVnMFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAZuqf8hHRv+v1v/SeatKs3VP8AkI6N/wBfrf8ApPNWlWkto+n6szh8UvX9EVLy1eR47i1IW5h+7u+6690b2Pr2ODzyDLa3Ud3CXj3Kyna8bjDRt3Uj1/mCCMgg1NVS6sjJKLi1k8m5UYDdVcf3WHcfqOx5OUmmrMbTTui3RVGDUl85be+T7JcscKjNlZD/ALDcbvpwfUCr1S4tbjjJS2CiiikUeBeI/wDkadV/6/Zv/QzWbXqOpfDAahqt1eDV/L+0TPLs+zbtu4k4zuGetVv+FSf9Rr/yU/8As6+ohj8MoJOX4P8AyPk6mXYpzbUfxX+Z5vU/226G3/SZvljMS/vDwh6qPbk8e9eg/wDCpP8AqNf+Sn/2dH/CpP8AqNf+Sn/2dU8fhXvL8H/kSsuxa2j+K/zPPIbqe3WRbeeSJZV2SBHKh19DjqPamtNK0KRNI5jQkqhY7VJ6kDtnAr0X/hUn/Ua/8lP/ALOuS8deHl8GWkTLc3F7NMflIsysSfV9xGeD8o545xxmKmZYOnFzlL8H/kdOFyXMMXVjQowu35r/ADMq1vLmym82yuJbeTGN8TlDj0yKbPcTXU7TXUsk0r/ekkYsx+pNdSnw91GONJrp2mtpFDpNYRCUhSM5ZGZW/Bd1W7HwDpupSmG08So06jLW72hjlX6xs4YfiKFmWDbvza+j/wAhTybMIRfuXS7NNfg9PnqcXLPLOwaeV5GVQoLsSQAMAc9gKjr0j/hUn/Ua/wDJT/7OkPwmCgk63gDkk2vT/wAfrT+0ML/N+D/yOb+zsX/L+K/zPOK6/wCG7zr4iuFtEBmezZVZvup86fM3qB6DqcDjqLcXw1+13CrYar58AP7y4NttQf7p3fOfpx15zxXU+FfA48M6pLef2h9qMkJi2eTsxlgc53H+7WOKxlB0pRT1fkzbCYKuq0ZNaJ73R01papZ24ijLNySzscs7Hqx9yamoor5ttt3Z9QkkrIKKKKQwooooAKKKKACiiigArzj4t/8AMI/7bf8Aslej1zni3wkPFItP9N+ym23/APLLfu3bfcY+7XXg6kaVeM5vTX8jjxtOdXDyhBXbt+Z4nU1tdXFnMJrOeWCUDAeJyrD8RXoX/CpP+o1/5Kf/AGdH/CpP+o1/5Kf/AGde+8fhXo5fg/8AI+cWXYtO6j+K/wAzz25u7i9m868uJbiUjG+VyzY+pqSPVL+KzNpFfXKWzAgwrMwQg9flzjmu+/4VJ/1Gv/JT/wCzo/4VJ/1Gv/JT/wCzpfXsJa3N+D/yK+oYy9+X8V/medwzy28m+CV4nwV3IxBwRgjj1FIJpRAYRI4iZgxTcdpI6HHrya9F/wCFSf8AUa/8lP8A7Oj/AIVJ/wBRr/yU/wDs6f1/C/zfg/8AIX9nYv8Al/Ff5nnKO0civGxR1IKspwQfUVPd6je35Q395cXJTO3zpWfbnrjJ4rv/APhUn/Ua/wDJT/7Oj/hUn/Ua/wDJT/7Oj6/hb35vwf8AkH9n4tK3L+K/zPOzPKYFgMrmJWLLGWO0E9Tj14FR16R/wqT/AKjX/kp/9nR/wqT/AKjX/kp/9nT/ALQwv834P/IX9nYv+X8V/mcT4c/5GnSv+v2H/wBDFe+1wOm/DAafqtreHV/M+zzJLs+zbd20g4zuOOld9Xj5hXp1pxdN3Pay3D1KEJKorXCiiivMPVCiiigAooooAKKKKACs3xH/AMitqv8A15Tf+gGtKs3xH/yK2q/9eU3/AKAa0p/GvUzq/wAOXoaVFFFZmgUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFZHiP9/YRacvXUZltiPWPlpP/ACGrj8RWvWQv+m+LXbrHp1vtH/XSU5P4hVX/AL7q4b37ET2t3NevmHVf+Qxef9d3/wDQjX09Xyvqmo2v9sXn73/lu/8ACf7x9q7cDvIzqtKwlFVv7Rtf+ev/AI6f8KP7Rtf+ev8A46f8K9Mw5kWaKrf2ja/89f8Ax0/4Uf2ja/8APX/x0/4UBzIs1Q1v/kDzf8B/9CFTf2ja/wDPX/x0/wCFU9Vu4JtKnSN9zYU4wf7wpCbVif4VnHxS0L/r4P8A6Ca+t6+UfhFpl7qHxK0uWzt3ljtJPOncD5Y0wRkn9Pevq6vKxvxr0N6HwhRRRXEdAUUUUAFFFFABRRRQAUUUUAFFFFABWRrP/IW8P/8AYQf/ANJZ616yNZ/5C3h//sIP/wCks9XDf7/yInt935mvRRRUFhWNrn/IY8Of9hJ//SS4rZrG1z/kMeHP+wk//pJcVE9vmvzOnDfG/SX/AKSzZoooqzmCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAM3VP+Qjo3/X63/pPNWlWbqn/IR0b/AK/W/wDSeatKtJbR9P1ZnD4pev6IKKKKzNCOeCG5haG5iSWNuGR1BB/A1R+w3dlzplxvjH/LtdMWX/gL8sv47h6AVpUVSk1oTKKepm/2wIONRtLiz/2ynmR/XcucD/exV6C4guoRLazRzRno8bBgfxFSVSn0ewuJjM1uEmbrNCxic/8AAlIP61V4Py/r+upNprbX+v66F2is7+zLmIf6Lq10o7LKElH5kbv1o8vWoxxc2M3+9A6H9GNHKujDnfWJo0Vnebraj/jysH9/tbr/AO0zSfaNZ/6Btnn3vWx/6Lo9m/L70HtF5/czSrDaNNY8TSiZFls9NiMRRhlXmkX5sj/ZjIH/AG1al1HU9W0/TZ7ye0sUSFCxC3LyMx7KB5YyScAD1NM0nStYtNPWKS9tYpJGaacrbl2aR2LMdxbGMnA44AA7VEoXdm1/XodNKp7ODqJO70XT138tPmbqIsaKiKFVRgADAArO1mPRpoVTXEtHXOY1uACc/wCznnP05o/sl5f+PzUr2Yf3VkEI/wDHAD+tWLXTbOyYta20cbt96TGXb6seT+NVywtZ6/1/XQwjUqqXNHR976/h/mc+ttqKMP8AhGJ79I8/d1PLwY/4H+++mDinONSjmL+JdNlv4gcqbF/MhUe8JwxP/fddRRU/D8Gn9f1tY39pzu9ZKX4flv8A9vXKGn6zpuosYrG6jaRB80B+SRPqhwy/iKv1Uv8ASrDVEVdQs4bjbyhkQEofUHqD7iqP9i3tnzo+rzxqOkF6PtMf5kiQf9949qzvJbq5py0J/DLl9dV96/yNmisb+1tTsuNV0iR0HWfT289fqUwH/AK31q5Yazp2qFlsbyKWRPvxA4kT/eQ/Mv4impp6Eyw9SK5rXXdar70XaKKKowCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKzfEf8AyK2q/wDXlN/6Aa0qzfEf/Irar/15Tf8AoBrSn8a9TOr/AA5ehpUUUVmaBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAjMFUsxAAGST2rK8NqZNKN+4Ik1GVrs5HO1v9WD7iMIPwo8SOzaQbKMkSahItopHUB/vke4TefwrVRVRFRAFVRgAdhV7R9SN5egtfP2o+CPEkuqXUkej3LI8zspAHILH3r6BorSlWdK9hyipHzt/wAIL4n/AOgNc/kP8aP+EF8T/wDQGufyH+NfRNFb/XZ9kR7JHzt/wgvif/oDXP5D/Gj/AIQXxP8A9Aa5/If419E0UfXZ9kHskfO3/CC+J/8AoDXP5D/Gg/DPxNq4+wnT5LQTMoaebhYxuBJP4A8d6+iaKTxk7bB7JGH4R8I6b4N0NNO0qP8A2pp2HzzP/eY/yHatyiiuNtt3ZokkrIKKKKQzitEs9a8RWt3qEni/V7L/AImV9bpb2sFl5caQ3UsSAb7dm+7GMksec1o/8Ivq/wD0PfiD/vxp/wD8i0eA/wDkXbr/ALDWq/8ApwuKZ4iuLnSfFegaktzKLCeVtPuoN58vMgzE+3pkOoXPXD0dUg6XH/8ACL6v/wBD34g/78af/wDItH/CL6v/AND34g/78af/APItUXu7u9vPFmpRXcyWljatY20aSEKJUQvJIBnG7cwXPUbDWEmp2Ul14YXxPr09jazeHxMzvq0loJZsx8llddzYLdSe9JO/9eTf6fiD0/r0X6/gdX/wi+r/APQ9+IP+/Gn/APyLWRrGm69p2q6Baw+N9cZNT1B7WYvb2GVUWs82VxbDndCo5yME8ZwRt+CZ7248MRPqEk8w82Vbaa5UrLLbhyImcHB3FMHJGT1PWo/FH/IxeDP+w1J/6b7yqegB/wAIvq//AEPfiD/vxp//AMi0f8Ivq/8A0PfiD/vxp/8A8i10lcxptu3ij7Vf6hdXscCXU1vbW1rdSW6osblCzGNgWZipPJIAwAByTDk07I3pUlOLnJ2ivnvskv8Agof/AMIvq/8A0PfiD/vxp/8A8i0f8Ivq/wD0PfiD/vxp/wD8i1W1C4urXxPc2q3lw0cWgPIN0mMuHxvwMDd7gVm+Hr2CW68PHQdXuNRuJos6rE1/JdoieVks25mEbeZtAAwTlhggHGSrJu39btfpqdkcvk6bqc3S+2mzer6baeZt/wDCL6v/AND34g/78af/APItZOl3F+fEH9n6jqU+pf2b4jNvDcXEcSyFG0vzcN5aIpw0rc7Rxiu6rhLD/keNS/7Gpf8A0yx11Q3+/wDI8me33fmd3RRRUFhWNrn/ACGPDn/YSf8A9JLitmsbXP8AkMeHP+wk/wD6SXFRPb5r8zpw3xv0l/6Syr4tuL8XXh/T9O1KfTf7S1Jrea4t44mkCLa3EuF8xHUZaJedp4zSf8Ivq/8A0PfiD/vxp/8A8i0eKP8AkYvBn/Yak/8ATfeV0lWcxzf/AAi+r/8AQ9+IP+/Gn/8AyLR/wi+r/wDQ9+IP+/Gn/wDyLVXS7d/F019f6leX0VrDeTWtpa2l3JbBFjbYzs0TKzszKTycAYwByTDqFxd2fjNrJL66eGPw7NIA0p5cSAByBgbsd8ZqW7K/z/Bsdru3y/Gxof8ACL6v/wBD34g/78af/wDItH/CL6v/AND34g/78af/APItcr4X1GCeTws3h/XLrU76eJTq8DajJeIkZhyzOGdhEwk2gY2k5IwRnHp1W1YlO5wmj6br2o6rr9rN431xU0zUEtYSlvYZZTawTZbNsed0zDjAwBxnJOv/AMIvq/8A0PfiD/vxp/8A8i0eF/8AkYvGf/Yaj/8ATfZ0/wAXT3Gmw6frEFxJHDYXaG7jVyFkgf5HLDodu4MM9NtRKXKrm9Ck61RU09Xt69F83oM/4RfV/wDoe/EH/fjT/wD5Fo/4RfV/+h78Qf8AfjT/AP5FqvrV1dXOr6sbW6mht9J0qTcI3Khp5FJBOD1VVBHpvzVLUL6EWHhE6zqstna3EJNzMb97bzG8gEbpFZSfm9+TWTrLXyt+La/Q7KeAlNRd9+iV38Ll87r8zV/4RfV/+h78Qf8AfjT/AP5FrO1uz1rw7a2moR+L9Xvf+JlY27291BZeXIk11FE4Oy3VvuyHBDDnFanhGeWa3v8AbcTXWnJdldPuJ2LtJFtUn525dQ5cKxzkAckYNM8ef8i7a/8AYa0r/wBOFvWsXzJM461J0ajg3t/X3910Z0lFFFUYhRRRQAUUUUAFFFFAGbqn/IR0b/r9b/0nmrSrN1T/AJCOjf8AX63/AKTzVpVpLaPp+rM4fFL1/RBRRRWZoFFFFAHHQQavr/iPxEqeKNT0yDTr+O1ggsobQrtNpBKSTLC7ElpW74xjirv/AAi+r/8AQ9+IP+/Gn/8AyLR4X/5GLxn/ANhqP/032dW/Fmq3GjeHJrmxCm6eSO3gLjKq8kioGI7gFs474oAqf8Ivq/8A0PfiD/vxp/8A8i0f8Ivq/wD0PfiD/vxp/wD8i1c0/wAOR2FxHcnU9UuLoZMsk97I6TE9cxE+Wozz8irjHGBXA2+rLJ4f8KP4g1u5tbS4vr1Lq4fUpLbeF83YGkDqcAhcDPYCgDsv+EX1f/oe/EH/AH40/wD+RayPFem69oPgzWtYtPG+uST6fp891EktvYFGaONmAYC2Bxkc4IPvWp4JuJZ4tTEV1Pe6THeFdNubh2kaSPapbEjcyIHLBWJOQOpGKf8AEf8A5JZ4r/7At5/6IegCC68F6heoiXPjjxBIscqSqvk2AG5WDKeLXnBAPPcCp/8AhF9X/wCh78Qf9+NP/wDkWukrmbO/fR/E+uWmpXUj2zQjU7dpXLeXHjbKoz0CsoOBwN9RKSi9f66nRSpSrRkk/hV7fNLT8/RDv+EX1f8A6HvxB/340/8A+RaP+EX1f/oe/EH/AH40/wD+RazNMm1KPUPCxvru4Mmotd3NxE0jbRuTekeM4wgIAHbFZ17qEAPiAw61dDxBDfOun2cd/IzMQFKKLfdtZScg5XGMnjGRk61tGv60/HU745ZKU+RSv6K/2nH7tL37dDpP+EX1f/oe/EH/AH40/wD+Raj0B9Ss/GWr6Nf6zd6tBBYWd1FJeRwK6NLJcqw/dRoCMQp1BOc8100e8xr5gAfA3AdM1ztj/wAlT13/ALAum/8Ao++roPIOkooooAKp3+kafqgX+0LOGcp9x3X5k91bqp9wauUUmk9GVGcoPmi7Mxv7H1Cy50jWJgo6QX6/aU/76JEn4lj9KP7Y1Cy41fR5tg63Gnt9pT8UwJM+wVvr67NFTy22Zv8AWOb+JFP8H963+dynYavp+qbv7PvIZ2T76K3zp7MvVT7ECrlUr/R9O1Tab+zimdPuSFcOn+6w5X8CKp/2RqVlzpOsSMg6Qagv2hfwfIk/Es30ovJbq4clGfwy5fX/ADX+SNmuTvV1XV/Hl/plt4gv9JtbLTbS4VLKK2YyPLLcqxYyxOekKYAx361p/wBtX1nxrGkToo6z2J+0x/8AfIAk/wDHCPesvQtRs9T+JmvTafcR3Ea6PpyMUOdrede5UjqDyODzzTUk9CJ0KkFzNad1qvvWhZ/4RfV/+h78Qf8AfjT/AP5Fo/4RfV/+h78Qf9+NP/8AkWrfizVbjRvDk1zYhTdPJHbwFxlVeSRUDEdwC2cd8Uun+HI7C4juTqeqXF0MmWSe9kdJieuYifLUZ5+RVxjjAqjEp/8ACL6v/wBD34g/78af/wDItH/CL6v/AND34g/78af/APItcp/aszfCzSrrUtVuYVk1dY7m7N48TCL7UykGUMCBt46jAroPCVysviDVI9F1GfUtBSKIxTy3L3KrcHdvSOZiS67QhIyQCccciha/15J/qD0/rzsU/Fem69oPgzWtYtPG+uST6fp891EktvYFGaONmAYC2Bxkc4IPvWv/AMIvq/8A0PfiD/vxp/8A8i0fEf8A5JZ4r/7At5/6IeukoA5v/hF9X/6HvxB/340//wCRaP8AhF9X/wCh78Qf9+NP/wDkWsPWNQso/F+uJrV7q8VvBbWxt/sdxcxxxMwcEkxkImTt5kIH4ZrSvZ9YtfD3hgapO0eoyX9rHeGJ8byQdynbwR6gcVgqyd/W342PUeXSShr8Vt13jzad7bPs7Fr/AIRfV/8Aoe/EH/fjT/8A5Fo/4RfV/wDoe/EH/fjT/wD5Frm73UIAfEBh1q6HiCG+ddPs47+RmYgKUUW+7ayk5ByuMZPGMj0aPeY18wAPgbgOmaunU51cwxOEeHjGTe/lbon81rv6nM6A+pWfjLV9Gv8AWbvVoILCzuopLyOBXRpZLlWH7qNARiFOoJznmuorm7H/AJKnrv8A2BdN/wDR99XSVocQUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAVm+I/wDkVtV/68pv/QDWlWb4j/5FbVf+vKb/ANANaU/jXqZ1f4cvQ0qKKKzNAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAyJP9N8WxJ1j063Mp/66SEqv4hVf/vsVr1keHf9Is59SPJ1Gdp1PrHwkf5oqn6k1r1c97diIaq/cKKKKgsKKKKACiiigAooooAKKKKACiiigDm/Af8AyLt1/wBhrVf/AE4XFafiDR017QbrTpJPKMy/u5tu4xSA5RwOMkMAeo6Vmv4E0Vp5pY5NXt/Pmed47XW72CPe7F3IRJQq5ZiTgDkmk/4QPSP+fzxB/wCFHqH/AMfoAt2Xh4WfhJ9G+0b5JoZFmufLx5kkmS8m3PdmJxn2zUGk+F/7LvtLuPtnm/2fpY07b5W3zOUO/OTj7nTnr1qP/hA9I/5/PEH/AIUeof8Ax+j/AIQPSP8An88Qf+FHqH/x+jrf+uv+bDpb+un+R0lc34o/5GLwZ/2GpP8A033lH/CB6R/z+eIP/Cj1D/4/Ucnw70GaSGSaXXJHgfzIWfxBfsY22ldykzfKdrMMjnDEdCaAOorBXQb/AE+8updA1KC2gu5TPLbXdoZ1WRvvMhWRCu48kEkZ5GMmof8AhA9I/wCfzxB/4Ueof/H6P+ED0j/n88Qf+FHqH/x+pcU3dmtOtOlfl690n+DLM3h1p9TkvJL5nZ9MawbfGMkls+YcYH4ACtLTbP8As/SrSy3+Z9nhSLfjG7aoGcdulYn/AAgekf8AP54g/wDCj1D/AOP0f8IHpH/P54g/8KPUP/j9EYqO39df1KnXqVIqMnojpK4Sw/5HjUv+xqX/ANMsda//AAgekf8AP54g/wDCj1D/AOP1H/YVhoF/o0WnLP8A6RqzzzSXF1LcSSP9jlTLPIzMflRR14CitYb/AH/kcs9vu/M6iiiioLCsbXP+Qx4c/wCwk/8A6SXFbNY2uf8AIY8Of9hJ/wD0kuKie3zX5nThvjfpL/0llTxR/wAjF4M/7DUn/pvvK6Ss7WdCsNfggi1FZ/8AR5vPhkt7qW3kjfayZV42Vh8rsOvIY1mf8IHpH/P54g/8KPUP/j9Wcwo8Oajpuo3k/hvVYLSC9lM81reWZuEWU/edCsiFd3UgkjPIxzl83hh59a/tGbUGkk/st9PbfEMsWYN5hIwO3QD8aj/4QPSP+fzxB/4Ueof/AB+j/hA9I/5/PEH/AIUeof8Ax+lZWt/W1vyHd3v/AF3NfRtP/snQ7HTvN877JbxweZt279qgZxk4zjpmrtc3/wAIHpH/AD+eIP8Awo9Q/wDj9H/CB6R/z+eIP/Cj1D/4/VNtu7JSSVkHhf8A5GLxn/2Go/8A032dbt9Zw6jp9xZ3SB4biNo5FPdSMGuej+HegwyTSQy65G87+ZMyeIL9TI20LuYib5jtVRk84UDoBUn/AAgekf8AP54g/wDCj1D/AOP1LSkrMqMnF3W5NpvhprLwxd6ZcXv2m6vEkE955W0uzLtB25PRQo69qmi0Dym0M/ac/wBkxmP/AFf+tzHsz1+X171T/wCED0j/AJ/PEH/hR6h/8fo/4QPSP+fzxB/4Ueof/H6nkj+X4bHTLF1pNtve/RdVZ/hp5dDpK5vx5/yLtr/2GtK/9OFvR/wgekf8/niD/wAKPUP/AI/Sp4E0VZ4ZZJNXuPImSdI7rW72ePejB0JR5SrYZQRkHkCrOU6OiiigAooooAKKKKACiiigDN1T/kI6N/1+t/6TzVpVm6p/yEdG/wCv1v8A0nmrSrSW0fT9WZw+KXr+iCiiiszQKKKKAOb8L/8AIxeM/wDsNR/+m+zrW1nSLXXdHuNNvw5gnXBMbbWUg5DKexBAIPqKzr3wXpF9qVzfu2p2890yvObLV7u2WRgioGKRSKudqKM4zhR6VF/wgekf8/niD/wo9Q/+P0AW9O0/X4Jol1LXbe7t4v8AnnYeVNL2G997KfU7UXJAxgZBoaX4M/syHQ0+3+b/AGTcXE2fJx5vm7+PvfLjf15zjtUn/CB6R/z+eIP/AAo9Q/8Aj9H/AAgekf8AP54g/wDCj1D/AOP0AdJXN/Ef/klniv8A7At5/wCiHo/4QPSP+fzxB/4Ueof/AB+sew8DaRrY1P7Zc65caZLI1rFby6/fOkqKCshYGb5gzFlwcgqo9TSbs7Fxg5Rcui/r+vRneVh+I/DKeIJLR/tH2cwsUm/d7vOgbHmRdRjdtXnnGOlV/wDhA9I/5/PEH/hR6h/8fo/4QPSP+fzxB/4Ueof/AB+lKKkrMqjWnRmqlN2aNK90j7Xrel6gJvLGn+b+72Z37029c8Y+hp+l6X/Zr3zed5v2y7e5+7jZuCjb15+71rK/4QPSP+fzxB/4Ueof/H6P+ED0j/n88Qf+FHqH/wAfoUUpc3X/AIb/ACG69Rw5G9LW+V2/zZ0lc3Y/8lT13/sC6b/6PvqP+ED0j/n88Qf+FHqH/wAfq/o/hrTdCuLiewF289yqJLNeX0907KhYqu6V2IALucDjLGqMTVooooAKKKKACiiigAooooAK5qwAHxU13A66Npuf+/17XS1i6p4T0rV9S/tC6N/DdGFYGkstTubQuilmUN5UihsF3IznG4+tAFzWdItdd0e402/DmCdcExttZSDkMp7EEAg+oqpp2n6/BNEupa7b3dvF/wA87Dyppew3vvZT6nai5IGMDINT/hA9I/5/PEH/AIUeof8Ax+j/AIQPSP8An88Qf+FHqH/x+gCO28GfZ/DOnaR9v3fYr9b3zfJxvxMZduN3HXGcn1x2rqK5v/hA9I/5/PEH/hR6h/8AH6yZ/hs0UzTWHiHXZlY5+z3uuXxUeytHMpX6ndSbstEaQgpvWSXrf9EzW+I//JLPFf8A2Bbz/wBEPXSV57ceGNLFtLa+JNO8SC2lQxzGLxBf3lvIpGCrAS7ipHXcgGDz3rUsfCvhvU4TLp2r61dIDgtD4nv22n0OJ+D7GkpJ6FToVILma07rVfetDXTQITq+r3dy6zw6pBFBJbtHwFQODk55yH9B0qpH4XmGj6XYT6kZhpt5HPFK0XzPGhO1G+bk4ON3fHSm/wDCB6R/z+eIP/Cj1D/4/R/wgekf8/niD/wo9Q/+P0vZx3t/V7/maLF119rt0XRWX4aefU1dL0v+zXvm87zftl29z93GzcFG3rz93rV+ub/4QPSP+fzxB/4Ueof/AB+j/hA9I/5/PEH/AIUeof8Ax+qSSVkYTnKcuaW4WP8AyVPXf+wLpv8A6Pvq6SsrR/DWm6FcXE9gLt57lUSWa8vp7p2VCxVd0rsQAXc4HGWNatMgKKKKACiiigAooooAKKKKACiiigAooooAKzfEf/Irar/15Tf+gGtKs3xH/wAitqv/AF5Tf+gGtKfxr1M6v8OXoaVFFFZmgUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAVmeIppItEmit2Kz3RW2hI6q0h27vwyW/CtOsi5/0zxVZ2/WOxia6k9nfMcf6eb+Qq4b3IntbuakEMdtbxwQrtjiQIijsAMAU+iioLCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKyNZ/5C3h//ALCD/wDpLPWvWRrP/IW8P/8AYQf/ANJZ6uG/3/kRPb7vzNeiiioLCsbXP+Qx4c/7CT/+klxWzWNrn/IY8Of9hJ//AEkuKie3zX5nThvjfpL/ANJZs0UUVZzBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAGbqn/ACEdG/6/W/8ASeatKs3VP+Qjo3/X63/pPNWlWkto+n6szh8UvX9EFFFFZmgUUUUAFFFFABRRRQBm6/eTWmkutmQLy5YW9tkZxI/AbHcLyx9lNW7Gzh07T4LO2BEMEaxoCcnAGOT3NZqf8TLxYz9bfSU2L6G4kAJP1WMgf9tWrZqI6ts6avuU40/m/nt+GvzYUUUVZzBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABWffaFpuozCe6tF+0AYW5jJjmUe0ikMPwNaFFJpPRlwqTpvmg7PyMb+ztYsedN1UXUY/5YajHu/ASJhh9WDmj+3prTjWtKurQDrNAPtMP5oNwHuyqK2aKnltszb26l/Ein5rR/hp96ZXstQs9Sg87T7qG6jzgtDIGAPpx3qxWde6Bpl/P589qq3OMC5hYxSj/gakN+tV/7P1qx/wCQfqi3kY/5Y6inP0EqAEfUqxovJboPZ0p/BK3k/wDNfqkbNFY3/CQSWnGtaZdWWOs0a/aIf++k5A92Va0rO+tNRtxPYXUNzEejwyBx+YpqSeiInQqQXM1p33X3rQnoooqjEKKKKACiiigAooooAKKKKACiiigArN8R/wDIrar/ANeU3/oBrSrN8R/8itqv/XlN/wCgGtKfxr1M6v8ADl6GlRRRWZoFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQB5PqWteONR8Z+ILHw/rdraWulgSFLiKMALtzgMYz79T+NdB4W8fLcfDn/hIPExWAwO0LvGn+uIxgqvqc444yD0HTlNR+Hc/ivx34nkuo7uzACvZXDRlYpXwBgkj5hx2PFSalpmteIPhlbaeuiXNjqOh3KtJbRQmFZ0UMN8TY2sec8Z5yQORn0OWnKnFafZv5d3/AFsedzVY1ZS1+1bz7K3T9TvND8b6drdxcWxtr7Trq3i89re/t/Ldov74AJyKxvDnjnT7rX5UvLLUbKTV5z9jnu7bZFKiKqqitnk9W6dWIz0rnbK1kga81mxg8XLqsNmbe3l11lwZJWCIiZGW+ZieoAxyOaydM0bWJL7ws5sfFD/ZbyIXI1FT5EGCv+rTqqgfxHA4xRGjTu/67/8AAFKvUsn11/T/AIJ3ngjULy78Z+L4Lq7nnit7tVhjkkLLEMvwoPQcDpVH4g+Lda0/xNp+g6Je2ek/aIjM9/e4CD73y5YEAfL6E5I6d73gjT7y08Z+L57q0ngiuLtWhkkjKrKMvypPUcjpVX4i3M73sVldeCZfEli0QeOWAurwvk7huRSRkBfTPv2yXL7WOl9F+Rs+b2U9bav8ze0C51jR/Dd1c+Ob+2le3dpPtcIGxotoIOAo75HTJ9+Ki0P4gaXrmpQ2SWuoWUlyhktWvbfy1uVHJMZyc8c9q4zRvB3iC7+EWq6XNBLbS3E4msbKeT5kQFW2nP3ckHg455OM07wlov23XNHe/tfGSXVgPM3amw+ywkLghCVyQSAMDHH0qnTg3Jt7dvT/ADIVWolFRW/f1Olt/ijpV5HcSWel6xcLa+YbhorZWWEIpOWbdgZwcc5OO3FXrrx7pVt4d0zWBDdzRapKsVvDEimQsc8EFgOCMday/hdpVxaeGdTt9UsZrczX8pMc8RQuhVRnBHIPPNc54S8MasnjGz0rU7K4XSvD89zPbTyxMI5izDZgngnPzce9L2dLma7Wfrpr+hTqVVFPvdemun/BOz1f4iaRpGqT2JttQvGtADdy2dv5kdqD/fbIx+Gfz4p2rfELR9JvbG2MV5eNf2/2i2NpEJPNB+6oGQSx6AY784rz688OXmk+JNch1O38WS2eoTNNE+gkNHMjk5Ei4xnnGD+WME79r4dudP8AH3hAW9jefY7PTXR5ZV3+SxVztZwAuQTjtTVKlZPy/Rv8xOrVvJf1ul+Wp6DDdSXekpdwW8sUssPmJBcLsdSRkKwzwexGa81m13x74a8S6OfEd3YXdrqtz5X2O3QZiyVzg7Q2Ru45Ycc+tel6lcyWWl3VzBA9zLDEzpDGCWkIGQoA7mvHvDOoa6viyLVfEHg7WNQ1KaVYxeTrIkVohOPkj8vCgAnqfyyczh43bdlb+tv8ysTLljFXd/L9bfke1UUUVyHYFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFZGs/wDIW8P/APYQf/0lnrXrI1n/AJC3h/8A7CD/APpLPVw3+/8AIie33fma9FFFQWFY2uf8hjw5/wBhJ/8A0kuK2axtc/5DHhz/ALCT/wDpJcVE9vmvzOnDfG/SX/pLNmiiirOYKKKyte15dCSyC2F3qNxf3P2a3trQxh3cRvIeZHRQAkTnlu1AGrRXN/8ACUav/wBCJ4g/7/6f/wDJVH/CUav/ANCJ4g/7/wCn/wDyVQB0lFc3/wAJRq//AEIniD/v/p//AMlUf8JRq/8A0IniD/v/AKf/APJVAHSUVzf/AAlGr/8AQieIP+/+n/8AyVVa28cXt5cXkFr4K8QSS2MwguF82xHlyGNJAvNzz8kiHIyOcdQQADraK5v/AISjV/8AoRPEH/f/AE//AOSqP+Eo1f8A6ETxB/3/ANP/APkqgDpKK5v/AISjV/8AoRPEH/f/AE//AOSqP+Eo1f8A6ETxB/3/ANP/APkqgDpKK5eTxldWj251TwlrdhbzXMNt9pmks2RHlkWNMiO4ZsF3UcKcZrqKACiiigAooooAzdU/5COjf9frf+k81aVZuqf8hHRv+v1v/SeatKtJbR9P1ZnD4pev6IKK4r4pkjwtb473i5/74evJa9DDZf7enz81vl/wTzcVmP1ep7Plv8/+AfR9FfOFFdP9kf3/AMP+Cc39s/3Px/4B9H0V84UUf2R/f/D/AIIf2z/c/H/gH0fVbUr6PTNMuL2YFkgjL7V6seyj3JwB7mvnmggHqM0nlDtpP8P+CVDOoqScqenr/wAA9/0Oxk0/SYo7khrqQtNcsOjSuSz49skgegAHatCvnCihZPZWU/w/4ITzx1Jucoavz/4B9H0V84UU/wCyP7/4f8En+2f7n4/8A+j6K+cKKP7I/v8A4f8ABD+2f7n4/wDAPo+ivA/DhI8U6Vjj/TIf/QxXvledi8L9Wkle9z0cHi/rUXK1rBRRRXGdwUV4H4jJPinVc8/6ZN/6GazK9uOVc0U+f8P+CeFLN+WTXJt5/wDAPo+ivnCiq/sj+/8Ah/wSf7Z/ufj/AMA+j6K+cKKP7I/v/h/wQ/tn+5+P/APo+ivnCij+yP7/AOH/AAQ/tn+5+P8AwD6Por5woo/sj+/+H/BD+2f7n4/8A+j6K+cK7b4Vk/8ACUXI7fY24/4GlY1st9lTc+e9vL/gmtDNPa1FT5LX8/8AgHrNFFFeQe0FFFfOJJJJPJPU13YTCfWeb3rWPPxmM+q8vu3vfqfR1FfOFFd/9kf3/wAP+CcH9s/3Px/4B9H1m3nh/TL24NxJbCK6P/LzbsYZf++0IJ+hOK8CopPJ095/h/wS4Z7Om7wjZ+T/AOAe7fYdcsf+PHUo7+MdIdQTa30EqDj8UY+9R3HiZtOtpZNZ0u7szGhbzFXzoWwM/fTO0e7ha8NpksSTxNHKMo3BGcZrOWTSSfJU181p+Z008/pzmvb0dL6tOzt5aJP5/ee+eGvEdh4p0WLUtMfKN8rxk/NE46qff+mDWtXzZBbQ2ylYI1jB64HWpKdPKJ8i556+S/4Jnic5oOtJ4em+S+l3rbztc+j6K+cKK0/sj+/+H/BOf+2f7n4/8A+j6K+cKKP7I/v/AIf8EP7Z/ufj/wAA+j6K+cK7b4Vk/wDCUXI7fY24/wCBpWNbLfZU3Pnvby/4JrQzT2tRU+S1/P8A4B6zRRRXkHtBWb4j/wCRW1X/AK8pv/QDWlWb4j/5FbVf+vKb/wBANaU/jXqZ1f4cvQ0qKKKzNAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigDIv/wDTPEenWY5S3D3kv1A2Rg/Usx/4BWvWRov+lXmpakeRNP5ER/6ZxZX/AND80/RhWvVy007EQ117hRRRUFhRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRXN+JPG2meHox9puYI2ZtgeZwqBvTPena4m0ldnSVn3WvaXZZ+0XsQI6qp3EfgM15/P4lOtgmLU47mM/wwSgr+QNZk1Uo9zCVbsd1c/EDSYMiOO5m91QAfqawdS+IUFxdWUyabIfsc5mUGYDcTG8eD8p7SE/hXKTdKozVaikYyqyZ20nxakQ8aOv/gT/APY1F/wuPYf3miceq3X/ANhXn83er/g/wV/wnE15t12S0is3CSJBZZzkdBKzFcjuAMjinyxSuxRqVZOyZ3UXxn0Uf8flhew+6bHA/UVheJ/iXJfeItF/4Ru7sTbrNvBvYnjNvIUeMlySAV2yk8d1/Ow/w5+HemRXkVxff2jqdvE5UX1/llcKSMKpUE57YNePzd6ynRVWNk2jtw2OngqqqSip6NWfmrf19x9bW08VzbJLBNHOjDiSIgq3uME1LXyJYa5qmiT+dpF/cWb5yfJkKhvqOh/GvTvCHx2ZZo7PxjCpQnAv4Ext93QfzX8qt02tjmhioydpaHttc34o/wCRi8Gf9hqT/wBN95XQW1zBeWsdzaSpNBKoeOSNgysD0II61z/ij/kYvBn/AGGpP/TfeVkdZ0lYD6/qF7qFzbeHNMhvEs5DFcXN3dm3i8zAJRCsbliM88ADpknIG/XG6Ndv4Tm1HTdV0++aGS9murW6srKW5SVJXL4bylYq6liCGABABBPODqHQ0pvE0lvrX9nTaeY5Bpb6g2ZgSpVgvl8Ajv8Aez+FU9M8X6hN/Ysur6RBaWmtKBazW1605R2TzFWRTGmMqG5BbkfjVfULe8vPGbXq2F1HFJ4dmj+ePO2QyAhCVyN2OwNS+EfC7Q6PoN3rF7qF1cWdnGYLW7EaJaOYwpwqIpLAZX59xHPcmiOqu/61l+iQpb6f1ov1bOvrm/C//IxeM/8AsNR/+m+zrpK5vwv/AMjF4z/7DUf/AKb7OgZoatrJ0m90yOS33299c/ZnnD48lipKcY5DMNvUYJHWodV8QnTtRe0itDcGKwmvZm8zaI1TAUdDyxz/AN8k81L4l0t9Z8O3dnC2y4ZQ8D/3JVIZD+DAViWMN5qfh7XtYurOeC71K2aOK1kiZZERIyqrtPPLl2H+8K5qkprmS9fw2+89XD0sPOkqk1to1fdtqz+5vy93XcujxHqF3c2FvpemW0sl3p63zfaLxoggJA2grG2T83XitPRNWXWtLW6WF4HDvFNC5yY5EYq65HBwwPPeuasdH1CfVNG2XN/pgi0JI5JYYk+/uT5G8xGAPfHB4rq9N0630nT47OzVhFHk5dizMSSWZieSSSSSe5rSHM229tfz/wAgxkMNTgowS5vK+13e99O1rfMxfHn/ACLtr/2GtK/9OFvXSVzfjz/kXbX/ALDWlf8Apwt66StTygooooAKKz7/AF/StMYrfahBC46oXyw/4COazh488NM20amufeJwPz21rGjVkrxi38jKVelF2lJL5l/VP+Qjo3/X63/pPNWlWFNqthqV/o50+8huMXjEiNwSP9Hm6jqK3aKiaUU+36sKclJya7/ojivip/yK1t/1+r/6A9eY6VY/2nq1tZGTyvPkCb9u7b74yM16d8VP+RWtv+v1f/QHrznw1NHb+JrCWd0jjSYFndsKB7mvfwDawja31PnMxSeLSfkPbR7ae0Nzp17JMkc6QzLNAI2Td91gAzAjg9wasXfh62jm1G2s7+Wa504M0qS2wjVlU4YqwdvUcECqx1fzXitobe3srb7Qssiw7vnIPBZnZjgDPGccmtvUNSg1bUNbsDcW0HmSvJbXMWyJZtrZ8t2GA4I5BY9QOea6ZSqxa10+Xl/wfkc8Y0ZX010XXz219N+vkYs2mWFpY2st3fXImuoPOWOK1VlHJABYyD+76UQ6TZDR7a/v76eEXErxqsVsJNu3GSSXX+96Vp3MlxcaLpsdjLpbotnsl897bzEbc2RmT5hwR0plprUeneHNKAS2uSl3K00EiIzhfkxgkbkJ5wRjp7Uc9RrR638vPyFyU01daW897LzKLeHZYdSvoLy4jhgsMGe4ALDBI27R3Y54HHuRUUulQS6dNe6XdvcJbkefHNCInQE4DABmBXPHXI9O9akwtCdV00akkovmjubW6lkB3kZO2Rv4WwxHzY5HOAaqQImi6VqH2me3kubuIQRQwTLLhdwZnZlJA+7gDOeelONSbW+unz2v+voEqcE9tNdb7dvwt6mdqFh9hWzPmeZ9ptln+7jbkkY9+nWtNfD1oviT+xri/mWV5I0jkS1DKS6g85cYxn3pbq2TWbLTJLS7tY2htxbzpcXCRGMqxO7DEbgQ2flz3qUana3XxGt75JVW1F1F+9c7RtXaNxz0HGeaHObVk9k/z0I5IJJ2/l/LX8fuKT6PaPaahNZ3s0n2FVLrLbBNxLhcDDt9adrnhyTRre1uEnFzBOi7nVdvluVDbCMnsQR61JaXEK6Z4hVpow0wTywWGX/eg8evHNX5tWtG1yayu5Vk0y+t4I5XQhvKcRqBIPdT19silz1VLvb/ACX+bNHCi12/TVmTc+H5Ytem02KdGEKCR55BsVF2Bix64Azjvn8arXVvpqRMbK/mmkU/dmtvLDjOPlIZvryBx78V0OoX9kPFurwtdx/Zry2Fut1Gd6KwVCDlc5GVwcetVEiWx8PahBqL6ZIdiratC0EspfeCTuTL42g9TjtRGpO0XLy+d9+n4ClShzSS7v5W26/iZvhz/kadK/6/Yf8A0MV7tbX1reNMtpcRTmB/Ll8tw2xsZwcd+a8C0q0jv9asbSYusc9xHGxRtrAFgDg9jXqvhz4e2mg2lzbNfX00ck5liMV5NblVIAwwjcKx464z/Iefmig5Jt62PSylzUZKK0udfRWR/wAIzYf899U/8G91/wDHKP8AhGbD/nvqn/g3uv8A45Xi2h3/AA/4J7l59vx/4B45rkfneMNRjzjffyrnHTMhp2p6TaWeoS6faXVzdXkc/khDaqis2ccHzCevtTdRjS28X3cYZvLiv3G6SQscCQ8lmJJ+pNaOqa+U8ZSXCi1mtoL/AM5Wht4gzqGz98DLZHqea+sTn7qj2/yPjmoe+5b3/wAymdGsEvv7Pk1bF7u8skQZgV+m0ybs9eM7cfhzTLPRA7akNSmktf7OXMqxxCRid4XAG5R1PrU0ukQSaq1wupWf9nPIZPPM67wmc/6rO/d2xt6+3NXYNbjluPEl8hhja5jBhjnVG3fvV42sCGOOenvUuc7e67/pqv8Ag+hap0+b3lbX71Z/8DtuU4fDaXV1Zra3jPDfQyPbu0O1mdAcoy7jjkYyCetVrTQ3u9BvdSEwX7MQFi25MgyNxz2xuX86vXmpIZ9K1y0mRXhZVks1cDyWQ5+ReyMOeBgEkVpXV1ptr4gs9PtbqGTTpEmEsqsNq+eT1P8AsjZ9NtS6lVf12vf79F+KKVOi3fpp+KS/B3f4MwF0CaT+y44JA1xqCs4jYbRGoYgMT6YBPTgDvT4NGsb64Nnp2ptNeEfu1e32RysOqq+4nJ5xlRn2q9Lq1pb+NFZpN9hBF9iEkXzYj8vy9w9eSTUGm2Eek6vDf3t9aNa2riVWguEd5iOVUIDuGTj7wGO+Krnna7dtLr8dPloR7OF7JX1s9fJa/N38ivDpNkukW99qF9PB9omeJUithJt24ySS6/3vSlj8PldeutNvLjyxaxvI8kSb8hV3cAkdR71oxa9HaaHpzmO1uG+2zSTW7ojMFOzoSMp3wRjp7U22jgg8T3uzUYriK6tJjDcTTqC29DgOxPDZODnHNLnqe835/wBf1uV7Ok3FLur+j/r5GVLpcMlhLeaXdPcx25HnpLD5ciAnAbAZgVzxnOQe3eug+GMscHiO7lnkWONLF2Z3bAUb05JPSsiFY9F0u/FxcQS3V5EII4YJVlCruBLsy5UfdwBnPPQUnhbwxb+LL+60+6nmgAtWkR4j0YMoGR3HPSlWfNRmpPTuFBcteDitex7hb3EN3bR3FrIssMqhkdDkMD0IqSue0zwha2Wk2trPdag8kEKxs0WpXMakgYyFEmFHHQcCrX/CM2H/AD31T/wb3X/xyvmGoX0f4f8ABPrE521X4/8AANevnSGPzriOPON7Bc46ZNe6f8IzYf8APfVP/Bvdf/HK8NsyEvICxwqyLkk9Bmvayq3v28v1PCzi/uX8/wBDZm8NxPc3lppd3LdXdm+14pLcR7xv2ZQh2zyRwccGo10S0lvG0631IyagCUVPIxDI4/gV92c9gSoBPtzV+58SpZeKbiaztrZYftvmSywMzNcIsm7qzEYOM/LgHiq1rYQWGuR6jJf2r2EEonV451MkgByFEedwY9OQAOecc13RnU5byfTTbf8ArpucM4UuZqCvZ+e39ddihbaZD/ZpvtRuJYIDMYUEMIkZmAycgsoAAI79+lSaTpdlqWpixe/ljd5CsTx2wdGHqcupHTpirOkXd27TsklhLbXEpNzaXkyIpz/F8xHPJwUORj6ZXS5NPtfHUb2kwSwS4by5JWwAmDjJOP1q5Sn7yvrb+v66mcYU7xdtL29f6/Ar2+l6bcQ3lyt/dC2tURmY2i72LNtwF8zGOnOfwpW8Psb5I4rlTaNbC7Ny6FdkXcsozzkYwM5OKdot8tjo+rkNB5rJEI0mRHD/ALwZ+VgQePbitCS7tLi4lf7XHHFq9kIwGkyLSRWU7COSqZXA4wAR6VMpVIyavp/wF5ev5DjGlKKuv6vbv/W5jy6bbS2E11pd3JcC3wZo5oBEyqSAGGGYEZODyCMjimXWl/Zrixi87d9rhjlztxs39uvOKtwRjRtOv2ubi3e4uofs8UUE6S8FlLMxQkAYGOTkk+1WZIotS/sm7ivLWOO3gSK4WaZUeMoeTtJywI5G0H061ftGnvp3+X9fkQ6acdrStt8/8v8AMr2uhWk3iCbSJ76aOZZ2hR0tgyttzycuCOnTmq0Gm2t7PcLZXczRwWrzlpoAhJUZ24Dn88/hV7TtQgm8fC/d1igkunk3SNtABzjJP1qpoM0UMl/50iR77CZF3MBuYrwB7+1K9RJtvovv1LcaXMklpzNddtB+o+HZLHQrHVI5xPHcqDIgXBhJztB55BweeOlNl0B01qWwS4TZDEJpbiRSqomwMSQMnvjjqcVpDVrWGbTre5kWWxuNOS3u1Q5KfMxB9mU4P/66ff3dofEmrWpu4TDeWyQJdK26MMqxkEkZ4JTGe2ahVKt7Pz/P9PxKdOk4pr+7f7v1/A5+7hsEj3WF5NMQ2GWa38skeowzAj646jrzjqvhX/yNNz/15N/6GlY90i23hh7e8+wNci4j8g27QyPsAbdlo8nqV+8fp0rY+Ff/ACNNz/15N/6GlTiJXw0ysNG2Jp6Wv/wT1miisvWvEem6BCH1Gfa7DKRIMu/0H9TgV8vGMpvlirs+slOMFzSdkalZviP/AJFbVf8Arym/9ANef6l8U76Viul2cVunZ5fnb69gP1rCuvHPiG9t5bee+BhmRo3QQoMqRgjpnpXp0str3UnZHlVs0w9nFXZ7fRXklh8T9Zt2H22OC8TPOV2N+BHH6V3Hh/xvpevMsKubW7P/ACwlP3j/ALJ6H+ftXPWwNekrtXXkdNHH0KzsnZ+Z0dcVolnrXiK1u9Qk8X6vZf8AEyvrdLe1gsvLjSG6liQDfbs33Yxkljzmu1rm/Af/ACLt1/2GtV/9OFxXEdwf8Ivq/wD0PfiD/vxp/wD8i0f8Ivq//Q9+IP8Avxp//wAi0viG6urnXtM0C0uZbNL2Oae5uISBJ5Ue0FEP8JYuPmHIAOMHBGf4wsW8O+AdZn0nUNSjfylKmW+lmZG3gZV3YsuQcYBx7daOlx9bF/8A4RfV/wDoe/EH/fjT/wD5Fo/4RfV/+h78Qf8AfjT/AP5FrK8TXunR+ObC38Qa1Jplg2mSyAf2pJZK8okQDlHXccE8Vs+CZ7248MRPqEk8w82Vbaa5UrLLbhyImcHB3FMHJGT1PWhaq/8AW9if6/C5iaxpuvadqugWsPjfXGTU9Qe1mL29hlVFrPNlcWw53QqOcjBPGcEa/wDwi+r/APQ9+IP+/Gn/APyLR4o/5GLwZ/2GpP8A033ldJQM5v8A4RfV/wDoe/EH/fjT/wD5Fo/4RfV/+h78Qf8AfjT/AP5Frk9HvpLmxsPsN9qreIJtQkx9puLj7PJEtwwkGJD5TgRZ4TLAjIGQcdNq15cx+LryGO4lSJdCklVFchQ4kwGx6+/WuZV0481v6tc9arlsqdT2fN33Vtna/o+j62ZN/wAIvq//AEPfiD/vxp//AMi0f8Ivq/8A0PfiD/vxp/8A8i1ieHr2CW68PHQdXuNRuJos6rE1/JdoieVks25mEbeZtAAwTlhggHHf1tGXMjkxeGeGmot/hZ7tbfLTyOc8JXF+brxBp+o6lPqX9m6ktvDcXEcSyFGtbeXDeWiKcNK3O0cYro65vwv/AMjF4z/7DUf/AKb7OukqzkCiiigAooooAKKKKACiiigAqlrN62naNc3MQ3SomIlP8Uh4RfxYgfjV2sjVP9L1rTNPHKq7Xkw/2Y8BR/32yH/gBqoq71Jm7R0Lum2S6bpdtZIdwgiWPcerEDkn3PWrVFFJu7uNKysgooopDCsvXtftNAsTPdHfI3+qhU/NIf6D3rUr541zxPqV1rd21xIsrLKyAsvQAnArooUfay9CJy5Udq3xR1ov8mmWgX0JYn8800/FDXP4dOsh9Q/+Neef29eekX/fFH9vXnpF/wB8V6P1eH8pjzvud+fif4h/hsdPH1R//iqYfib4lPS004f9sn/+Lrg/7evPSL/vij+3rz0i/wC+KPq8P5Q533O5PxK8TnpDYD6Qt/8AFUw/EbxSegsx9IT/AI1xP9vXnpF/3xWb4g1++/seVUdY95ClkXBwevNP2EP5UJzfc9O8D/E3VfEXxAj0S5kt5IPJkaRo48fMo4ANet18v/Aw4+KVr7283/oNfUFefioqNS0TWlJyjdhRRRXKahRRRQAUUUUAFFFFAGdrl21tYYjOHkO3I7DvXDQWljFqVxeapp1vqzSKI4kuQNsCcZCggjJIyTjJ4HQVp/E3xEnhuz0i5uB/o8175MxAyVUoxz+BANZvnR3EKTQSLJFINyupyGHqDWiWhzTl79uxDdeG/h1qTj7b4YjtHPJe1BiVT7eWwP6VXHw68LT/APIF8WatpxzhY3u8p/3zIuT+dPmrMvbeG5TZcRrIgIO1hkZHTinYjnXVF5/hs1hfIviPxrFLpjI4eN40tZTlSFw4bsSD07Vx6rPbXVzYXMq3RtX2x3sY/d3KdnHvjqPWtK48i0hkkby4Y1G524UD3NWvCfhXVPGkUmoxzDTNKwVtpZYC73TZ++FyMJ6HqarbVkP39Io5i9iM2xS7LHvBlVG2s6d1Dc7SfXBxXYan8QLTT/DEGkeD7H+yYVj2u3AMXqFPcnruPPPrXP6zpy6VqEtouow6gYzhpoYTGufTBZs/nV/wQ/h7+2ZIvFFhY3ETRlopryJXETKMkfMMcjP4getN2tcmLafLexwFxqNs020TiWVj91PnYn6DJqvKcjOCPYjkV7EvxY0zTLue30/w9GlhnbG0DCFivqVC/wBa5v7F8I9Ub/U6poEjfeaKRyM/m4/QU+Z9US6cHtI8zlqhN3r1wfCfw/q//ItePIJWP3YbpEdz9cMpH/fNcb43+H2peCPJOqX+nT/aCfLS3kbzCB/EVK8D3zVKSbsZTozir9DuP2fvFVyb+88M3Mhe38o3NsGP+rIYB1Hsd2cex9a9Y8Uabqd7Not5osVpPc6Xfm6MN3cNCkim3mhI3qjkEecD905xjivB/gKn/FyyxH/LlLj81r6XrCqrSO7Ctunqc39u8b/9C94f/wDB9P8A/IdH27xv/wBC94f/APB9P/8AIddJRWZ1HN/bvG//AEL3h/8A8H0//wAh0fbvG/8A0L3h/wD8H0//AMh10lFAHN/bvG//AEL3h/8A8H0//wAh1m6ZbeN9N1HWboaLoEv9qXi3ZT+25l8rFvDDtz9kO7/U7s8fexjjJ7aigDm/t3jf/oXvD/8A4Pp//kOj7d43/wChe8P/APg+n/8AkOukooA5v7d43/6F7w//AOD6f/5Do+3eN/8AoXvD/wD4Pp//AJDrpKKAOO1O08X69Da2d9pWiWVsl/aXUs0OrzTOFhuI5iAhtkBJ8vHLDrmuxoooAgvLy30+zlu72VYYIl3O7dv8T7d68m8SfEC/1aR4NNd7Ky6AKcSOP9ojp9B+tL8QfEj6rq7WFu/+h2j7cA8O44LfhyB/9euPr6LA4GMYqpUV2/wPmcfj5Tk6dN2S/H/gC5z1pKKK9c8YfFLJDKskLtG6nKspwQfrXe+FviNNDIln4gcywkhVusfMn+96j36/WvP6KxrUKdaPLNG9DEVKEuaDPWPii6yeE7R42Do12hVlOQR5b8ivJ67bwlLb+JrAeGNanmVI38+0eNgGyAQU5ByMEnp610n/AAqvRP8An61D/v4n/wARXnUq1PBR9jU3/Q9KtQqY6Xtqe36nktFetf8ACq9E/wCfrUP+/if/ABFH/Cq9E/5+tQ/7+J/8RWv9pYfz+4y/svE9l955LRXrX/Cq9E/5+tQ/7+J/8RR/wqvRP+frUP8Av4n/AMRR/aWH8/uD+y8T2X3nktFetf8ACq9E/wCfrUP+/if/ABFH/Cq9E/5+tQ/7+J/8RR/aWH8/uD+y8T2X3nktFetf8Kr0T/n61D/v4n/xFH/Cq9E/5+tQ/wC/if8AxFH9pYfz+4P7LxPZfeeS0V61/wAKr0T/AJ+tQ/7+J/8AEUf8Kr0T/n61D/v4n/xFH9pYfz+4P7LxPZfeeS0V61/wqvRP+frUP+/if/EUf8Kr0T/n61D/AL+J/wDEUf2lh/P7g/svE9l955v4c/5GnSv+v2H/ANDFe+1yNj8NtHsNQt7yK4vWkt5FlUPImCVORnC+1ddXk4/EQryTh0PYy/DVMPCSn1Ciiqeqaxpmh2Yu9a1G0062LBBNdzrEm49BuYgZ4PHtXnHpnh3iP/kadV/6/Zv/AEM1m13l8vwvv9QuLyXx1piyXEjSsE1i2wCxycZ+tQfYvhZ/0Pmn/wDg4ta+lhmNBRSd/uPl55ZiHNtW+84qiu1+xfCz/ofNP/8ABxa0fYvhZ/0Pmn/+Di1qv7Sw/n9xH9l4nsvvOKortfsXws/6HzT/APwcWtKbH4Wjr4708f8AcYtaP7Sw/n9wf2Xiey+84miu1+xfCz/ofNP/APBxa0fYvhZ/0Pmn/wDg4taP7Sw/n9wf2Xiey+84qiu1+xfCz/ofNP8A/Bxa0fYvhZ/0Pmn/APg4taP7Sw/n9wf2Xiey+84qu2+Ff/I03P8A15N/6GlWdN8PfDzWL5LLSPF0F/dOCVgtdTt5XYAZOFUEnArr/D/gvTvDl9Jd2M1zJI8ZiImdSACQeyj0FYYjH0alKUI7s6MNl9enWjOVrI6Giiivnz6MK+cK+j64o/CzRCT/AKTfj28xP/iK9TL8TToc3P1t+p5OY4WpiOX2fS/6HktFetf8Kr0T/n61D/v4n/xFH/Cq9E/5+tQ/7+J/8RXp/wBpYfz+48r+y8T2X3nktFetf8Kr0T/n61D/AL+J/wDEUf8ACq9E/wCfrUP+/if/ABFH9pYfz+4P7LxPZfeeS0V61/wqvRP+frUP+/if/EUf8Kr0T/n61D/v4n/xFH9pYfz+4P7LxPZfeeS0V61/wqvRP+frUP8Av4n/AMRR/wAKr0T/AJ+tQ/7+J/8AEUf2lh/P7g/svE9l955LRXrX/Cq9E/5+tQ/7+J/8RR/wqvRP+frUP+/if/EUf2lh/P7g/svE9l955LRXrX/Cq9E/5+tQ/wC/if8AxFH/AAqvRP8An61D/v4n/wARR/aWH8/uD+y8T2X3nktdt8K/+Rpuf+vJv/Q0rpP+FV6J/wA/Wof9/E/+IrT0Pwdpnhi7lvrWe5ZjCUYzupVVyCTwo/u1hiMfRqUpQje7OjDZfXpVozlay8w8X+KovDWnjy9sl7N/qYj0A7s3t/M/jjxm8vLjULuS6vZmmmkOWdzkn/63tVzxBrEuua3cX0pO12xGp/gQdB+X65rMrsweFjQhr8T3OLG4uWIqafCtv8wooortOAKUEqwKkgjoR2pKKAPU/AnjZtQK6VrEmbkDEE7f8tR/db/a9+/167HgP/kXbr/sNar/AOnC4rxeKV4JklhYpIjBlZTggjoa9R8MaHc6joa3umeLNa06K6nmuJLWCOzZI5ZJWeTaZLdmwXZiAWOARXzmY4VUn7SGz/M+nyzFurF057r8jo9d0H+1pbO8tLtrHUrB2a2uVQOBuGGR0ONyMMZGQeAQQRmqep+HNU13w5qGmavrEDNdoqI9tYmOOIBgc7WkZiT0+8BjHHUk/wCEX1f/AKHvxB/340//AORaP+EX1f8A6HvxB/340/8A+Ra8k9g0W0bd4ph1nz/9VZPaeTs67nVt27P+zjGO9adc3/wi+r/9D34g/wC/Gn//ACLR/wAIvq//AEPfiD/vxp//AMi0dLAHij/kYvBn/Yak/wDTfeV0lclc+B728uLOe68a+IJJbGYz27eVYjy5DG8Zbi25+SRxg5HOeoBFn/hF9X/6HvxB/wB+NP8A/kWgBB4PVfCkWki9K3FtcPdW14sWDDKZWkBC55xuKkZ5BPTNW7nQHutWlv5LpQ8umtYsqxcZLZLj5v0/Wqv/AAi+r/8AQ9+IP+/Gn/8AyLR/wi+r/wDQ9+IP+/Gn/wDyLWXsoWtb+rW/I63jK7bblu29l13NvTbP+z9KtLLf5n2eFIt+MbtqgZx26VZrm/8AhF9X/wCh78Qf9+NP/wDkWj/hF9X/AOh78Qf9+NP/APkWtTmlJyk5Pdh4X/5GLxn/ANhqP/032ddFLKkMTSTOqIgyzMcACsTTtOtfCVlqF1e6pdXkl5cfabm6vPLDyP5aRgARoi/diQYC9s1xeueJn128WGaSS104N91F3MfcjIyfbPHvWtOk5vyM5SSNfUfiMIrxk060WaFeBJIxBY+oHpVI/E28H/MPg/77NNg0zwbHbrPc6tNMC20qQQc4/uhd2PfpWdd6Z4ZmuZHh8QrbxsfliWxlbaPTJOTXXGFLblf3Mzbl3NA/FG9H/MOg/wC+zUZ+Kt6P+Ybb/wDfbVkvo/hzn/iqfw/s6T/GuamCiRhGWZMnaWGCR7jJx+daxpUpbL8yXKS6ncH4sXw/5htv/wB9tUZ+Ll8P+YZb/wDfbVz1h4v1zSbFLPT77yYEJKp5KNjJyeSpPWtO/wDFPjvTbeOe9mmhilUMkjWsW0g9OdvB9jzSdGKduVfe/wDIfM+5sWnxH8QX9pPc2Ph5LiG3IEjRljtz7dT07dO9Zx+MmoD/AJhVt/38aprv4tywWax2Np5sqIN91eELuIHJKLgD868Y8YeMLnxHqU0pMa+ZxI8UYTzPy/meTRToqT96FvmTKdloz6M+HvjlvG9rfzNbxwi0lWIGNiQ2RnvW1pX+l6xqmoHlfMFnCf8AZizuP/fxpB/wEV5R8B70ab4J8R3jLu8iUOF/vEJwv1JwPxr2HR7I6do9rau2+SOMeY/99zyzfixJ/GuStFQlJIuDcrXLtFFFcxsFFFFABXzXfOyX12I3VGa9cbmx0ya+lK+W9fhe51C6jjnkgK3Ujbo8ZPPSvQwW8jCtsjX/ALPuP+gxpv8A3/H+FH9n3H/QY03/AL/j/CuROl3PbVLn8hUf2CczeSmq3MkxGRFGm9z/AMBHNeha27MOZ9jSnlkfWCkjh9sRGV6H5qkqvb6NqNk7XF1a6vIpXbvn0+VVAz67cVLFNFMpMMiuAcHac4PpTUovZgr9R9Zmv/8AILb/AHxWnWZr/wDyC2/3xTB7Gz8Dzj4qWPvDN/6Aa+o6+WvgkcfFbTveOb/0U1fUteTjP4nyN6HwhRRRXGbhRRRQAUUUUAFFFFAHkf7Qp/4pTSh/0/Z/8htXlXhrxPqOiKI7eXzLcnJgk5X8PT8K9S/aGP8AxTejj/p8b/0A14rZ9q6qesDycQ2qzser2Xi2xv0HnBraQ9Q3K/mP61daRJV3ROrr6qc151Z9q37IkEY4pOIRm3udlY/DDw1dafpmr6trGoGzlRLmWwu7oGF3xnbggHAJ6Zq7408byiGLS/Cywm2ZNs8+8x7F6BEG3078e1c9bjzsCXL9uTWhFotncY3qwz6NUW11Oj2mloqxxs1UJq9L/wCEL0yVNxe4HsHH+FZ9z4P0yP8A57N9X/8ArVSkjFwZ5tNVCbmvRbjQNNh+7bAn1Zif61m3FvDACIYkT/dUCrTM3E4VrG4kGRGVHq3FQXFuwwZ5GlZRgbjkAeldPed6wLzvVIyZ1HwYuJbX4iPLBZzXjiykAhgKBj8y/wB9lH619Af25qH/AEK2rf8Af20/+P14P8DP+Smt/wBeUv8ANa+ka5aybluexgakY0bOCevW/wCjRjf25qH/AEK2rf8Af20/+P0f25qH/Qrat/39tP8A4/WzRWPK+7/D/I7vbQ/59r/yb/5Ixv7c1D/oVtW/7+2n/wAfo/tzUP8AoVtW/wC/tp/8frZoo5X3f4f5B7aH/Ptf+Tf/ACRjf25qH/Qrat/39tP/AI/R/bmof9Ctq3/f20/+P1s0Ucr7v8P8g9tD/n2v/Jv/AJIxv7c1D/oVtW/7+2n/AMfo/tzUP+hW1b/v7af/AB+tmijlfd/h/kHtof8APtf+Tf8AyRjf25qH/Qrat/39tP8A4/R/bmof9Ctq3/f20/8Aj9bNFHK+7/D/ACD20P8An2v/ACb/AOSMb+3NQ/6FbVv+/tp/8frkNJ+Ier3q6/HeaNJHFYNOsV8gARWBIVH+YgtnA+Qt+XNekVzvjpMeB9RWIAcKcAf9NFJ/rV0qTlWgubS+uwVMXRhhaq9iuZrR3lo113Z4mSSSTyT1pUQySKi43MQBk4/Wm0V9yfm5bXS7xtUbThD/AKUjMjRlhwVznnOOMHnNMNjcCC3mMf7u5ZliO4fMQQD9Oo610122ywm8QAgte2SW6t/02b5JD9dqMf8AgVUH/wCQH4e/6+Jv/Q0rmjVk2vu+dm2dU6MYxbXa69Lq36lG80LULGKWSeKMrC22Xyp45TEenzBWJXnjnvWdXT65eWVjqWuR2r3E1zeSvE/mRKiRL5m5sEMSxyoHQd65irozlON5E14Qpz5Yl3SL5tM1m0vVJHkyq5x3GeR+IzX0FXziPvD619FxKyQornLBQCfU4ryM2irwfqezk8nacfT9R9FFFeGe8FFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFc34o/5GLwZ/wBhqT/033ldJXN+KP8AkYvBn/Yak/8ATfeUAdJXP2/jjQbmZEjubhUknNuk8ljPHA0gYrt81kCZ3Aj73J4FdBXj9gLtPBNodXmifwzJrMwu1ghKTwYu3KMzlmDR+YAG2qrAEc8GhbpA/hv/AFsz1IazYG8vrUT/AL7T41kuV2N+7VgSDnGDwp6Zqlpni/RtXubeC0nuFkuozJb/AGmzmtxOoAJKGRFD8EH5c8c9Kw4/+Rv8cf8AXhbf+ipKi8L6Vq2saL4Tm1OKxtbHTIIrmHyJ3mlnbydi7soojADEkAtk4GRjJI6t/L9f8gen4/p/md5XN+A/+Rduv+w1qv8A6cLiukrm/Af/ACLt1/2GtV/9OFxQBt3+oWumWjXN/MsMQOATyWJ6KoHLMegUZJPAFV7fXbC4tbi4DTxJbIZJVuLWWF1UAndsdQxHB5A7Edqy9bljtvG2gTX7bLRkuIonfGxbltmzJPRivmAeuSO9aPiCaM+H9WhEimVbGRmTcNwBRgDj0OD+RrCVSSjKS6X/AC/r5HeqEOWndNufXovet28u/X72T+J9Lt2tlL3MzXUAuIlt7KaYmM4+YhEOByOuK0LK9ttRsoruxmWe3mXcki9CP89u1cVpsmoR6voZ0u2triQ+Hk3Lc3LQgDcnIKo+T7YH1rqfD+kto2ki2mlWWZ5ZJ5nRdql5HLttGTgZbA9qqEpOTvtr+Zpi8NRoU1yt83qnprfS2lrLfe+hneKP+Ri8Gf8AYak/9N95XSVzfij/AJGLwZ/2GpP/AE33ldJWp5gUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABWJ4yuTaeDtSkXgmLZ/30Qv9a26yfFNuLnwnqcZG7/R3YD3UZH8q1o29rG/dGVa7pSt2Z4NRRRX2h8KbMdpptvoVpe3sN3PJcSyJiG4WMKF2+qNn71SR6DCZpW86SS2awku7eQAKW2g8MOcYIIIB/GkU2V74dsrWTUoLWaCaVnWZJTkNtwRtQjsanj1myEskMbOlrDpktrA0i/NI7ZOSBnGWJ+gxzXI3Ozte+v/AAP6R2xVO65rW0+/S9/x3CDR9Md9JtJFvPtGpRBhMsqlI2ZmUfJtyRkDPzCuekTy5XTIO1iMjvW5d6/JFYadDp0satFaeXI4gXzEYs2QHK7hwex71g1pSU7ty/rVmVVwslHey/JfqFeo/Cm6L6Vf2p6RTK4/4EMf+y15dXoPw30OHUbO+uLmS8jXzFRfs15NADgEnPlsM9R1zXLmX+7S+X5nZlPL9bipOy12V+nqj06isb/hF7LteasP+4tcn+b0f8Ixbdr/AFYf9xOY/wA2r5S8+34n2nJh/wCd/wDgP/BNmisb/hGYe2p6sP8AuISH+Zo/4RtO2rasP+31j/Oi8uwezofz/h/wTZorG/4Rz01nVh/285/mKP8AhHpO2u6sP+2yH+aUc0uwezo/8/PwZs0Vjf8ACPz9vEGrD/gcR/nHR/YN128SasP+/B/nFRzS7B7Kl/z8X3P/ACNjeocIWG4gkLnkj1/UVS1bV7XR7UzXTcn7kY+859v8a4/xJ4B1jWNc0m5tPEl3Etn5he5l2eamdvCCNEznBzuJ/wAfO9X8XanNqlwLox3DxuYxJIpyQDjoCAPwAFb4aEq02mrJfiGKpUaNOEqdRScr3ST018+52VxqkfiDUi2uXklrAv8Aq0ij3qv9c++DV99P8HWqFX1FpZGTKs4d1U+4QD8sivLz4luz/wAsLf8A75b/AOKpp8RXJ/5YW/5N/wDFV6nsXsnY83mO5bSfD/fxN/5ISf41UvtN0SC0kktdfa6mUfJCtk67j9ScCuPOv3B/5YQfk3/xVIdcnP8Aywg/Jv8A4qqVOXf8v8hXRqpJ5U6SFFk2MG2OMq2D0PtXVH4oa0owLXT8Dp+7f/4uvPjrMp6wQfk3/wAVTTqsh/5YQ/8Aj3+NVKkpfEgUmtj0my+Kt8LrOp2tuYAp+W3jbcx7DLPgD3wfp3qnq3xWv54ZEtLK1tYdpDGb95gdzzgdPUGuAOpMf+XeH/x7/Gue8V3sslvbxriONy29UzhsYxnJ96j6vTvewOo0inr+vtqU0kdthYCxLFVC+YfoOi+g/wD1DEoqxp+n3eq6hDY6dbvcXM7BI4oxksf8966dEjm1bPYfgb/pWmzaaORLqKXEo/6ZxKG/9GGIfjXvdedfD/4aXfg3RwyasY9TnG64AiWSJc4+UA4PGBkgjNddu8RW/VNNvh6qz2x/Ihx+tePXcZzvFnZTvBe8jXorI/tq6h/4/dDv4x3eHZMv4BW3f+O0q+KNG3BZ71bRzwFvEa3J/CQCsOSXY0549Wa1FMimjnjEkEiSIejIwIP4in1BYV8warxrF7n/AJ7v/wChGvp+vmzTLBfEXjqaymgkW2jmknuQ64DIGwF/FiM+wau7CSUeZsxq9DJIBBB6HrzivbfBp0yTw/by6PaQ2kTj95FCgGHHXPqfc8muf1/wTb6qrXGnbbe76lcYST6+h96y/A2pXHh3xI+j6qjQJdMF2v8Awyfwn6Hpn6V0VGq0Lx3RnHRnrY/1dc34h8J6Nr4LahZp9oxhbqL5JV+jDk/Q5HtXSdI6pzGuCLad0avY8L8Q+HLzwzerFdN9otZTiC6C4DH+6w7N+h7dwOY1/wD5Bbf74r3/AFvTbfWNMnsLxSYplwSOqnqGHoQcEe4r581/zoLe4sbuNxcW03lSttwpZTjI9j1Hsa9OhUc1Z7nPPRGx8FDj4s6V7pP/AOiXr6or5V+C5x8W9H9xP/6Ikr6qrixn8RehtQ+EKKKK4jcKKKKACiiigAooooA8h/aGikbwzpEqrmNL0qx9CUOP5GvFLPtX1t4i8P2PijQrjStTQtBMPvL95GHRlPqDXzr4k+HWt+ELlzPC11Yg/JeQqSpH+0P4T9ePQmuinJWsebiqUufnWxSs+1b9l2rAs+1b9l2q2c8Tfs+1b9n2rAs+1b9n2rNnRE24v9SazL3vWnF/qTWZe96lGj2MC971gXvet+971gXvetEYSMC871gXnet+871Qs9C1PxBfCz0ezkupm6hBwvux6Ae5q0YNNuyN/wCB7LF8RZ55WWOGHT5Xkkc4VBuTkk9K+jre4hu7aO4tZFlhlUMjochgehFeZaH8FbC08KyWmo3cv9p3JDyXEDHYhA4QKeGUZzzyfauw0zwha2Wk2trPdag8kEKxs0WpXMakgYyFEmFHHQcCs5+zkr31PQoRq01ytfidDRWR/wAIzYf899U/8G91/wDHKP8AhGbD/nvqn/g3uv8A45WVod/w/wCCdN59vx/4Br0Vkf8ACM2H/PfVP/Bvdf8Axyj/AIRmw/576p/4N7r/AOOUWh3/AA/4IXn2/H/gGvRWR/wjNh/z31T/AMG91/8AHKP+EZsP+e+qf+De6/8AjlFod/w/4IXn2/H/AIBr0Vkf8IzYf899U/8ABvdf/HKP+EZsP+e+qf8Ag3uv/jlFod/w/wCCF59vx/4Br0Vkf8IzYf8APfVP/Bvdf/HKP+EZsP8Anvqn/g3uv/jlFod/w/4IXn2/H/gGvVXVLJdS0m6smIAniZMnsSOD+Bql/wAIzYf899U/8G91/wDHKP8AhGbD/nvqn/g3uv8A45TXKndP8P8AgifNJWaX3/8AAPCpoZLeeSGZCkkbFXU9VIOCKZXf+OvBP2JDqmkrNJF1uUkleV1P9/cxJI9eeP5cBX11CtGvBTifGYihKhUcJEhuJmt1t2mkMKsWWMsdoJ6kDpmj7RMY40Mr7IiTGu44QnqR6dBUdFbWRhdj5JHmlaSZ2kkclmdjksT3JplFKBk4HJphua3hbTDq/iaytdu5PMDyf7i8n9Bj8a94rkPAPhZtEsGvb1Nt7dKPlI5iTrt+p4J+grr6+XzCuq1W0dkfWZbh3Ro3luwooorzj0gooooAKKKKACiiigAooooAKKKKACiiigArl/GUjWl94Y1Bra7nt7HVmluPslrJcOiNZ3MYbZGrMRvkQcDjNdRRQBzf/CeaR/z5+IP/AAnNQ/8AjFVV8VeGlsJLFdG1gWkm4PbjwtfeW+4ktlfIwckkn1ya66igDkYfFXhq38zyNG1iLzY1ik2eFr4b0UYVTiDkAHAHYVPD420O2gjgt9P12KKNQiRp4av1VVHAAAg4FdPRQBzf/CeaR/z5+IP/AAnNQ/8AjFYnhPxXZaXos9vfaf4gilfU7+4Vf+EevmzHLeTSIciE9UdTjqM4ODkV39FAHLXPjPQby2e3u9N1yeCQYeKXwzfsrD0IMGDUFp4l8LWFnJa2Oh6rbW0uTJDD4VvkR8jByogwcjiuwopWV7lqpNR5U9DlY/GHh+GRHi0vWkeOPykZfDF+Cqf3R+44HA46VN/wnmkf8+fiD/wnNQ/+MV0lFMltvc4q81uDxF4o8Lppllq/+h6lJcTvdaPdWyRx/YrmPJeWNV+9IgxnPNdrRRQIKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigApGUOpVwCrDBB7ilooA8B17SpNF1y5sZAcRv8AIx/iU8g/lWdXs3jbwn/wkNiJ7MKNQgX5M8eYvXYT29vf65HjksUkEzxTI0ciEqyOMFSOoI7V9bhMSq9O/VbnxuNwssPUa6PYZRRRXYcQUUUUAFe5eDdIbRfC9tbzLtnfMsw9GbsfcDA/CvNvDWnafpqJ4g8UTJbWMZzbxyfeuHHovUgf54zXsqncoIzyM8jFeDmeI5rU47dT6LKsPy3qy36encWiiivEPdCiiigAooooAKKKKACvmHVf+Qxef9d3/wDQjX09XzDqv/IYvP8Aru//AKEa9DBbyMavQqUUUV6RgFFFFABRRRQAVh+Jv9XafV//AGWtyqV5ot/4h1PTtN0m3a4upncKq9h8uST2A7mk2lqxS2Oc0rSr3W9Tg0/S7d7m6nbbHGg6+/sB1JPSvqD4b/DWy8Daf502y51eZcT3OOEH9xPQe/U/kBP8PPh1YeBdM423OqTqPtN3j/xxPRR+vU9gOyrysRiHP3Y7G9Oly6vcKKKK4zcKRlDqVcBlPUEZzS0UAZcvhrRpZDJ/ZsEUp6ywL5Tn/gS4P60z+wXh/wCPHWNSt/RWmE4/8ihj+ta9FXzy7kckexwniKDxvHrmmf2FPHdrDueV2iEMZU4G2T5yH6dgCO3XjjfA0BbWfEN5IFDm8FuQDnG0bzg+n739K9trxHwTcqniTxDYscM9z9pQf3gco35bF/76FdNOblBq2xhKnyu99zv4RXMfFOe207wFd6nJZie5t9q28gODEzMAGz6DOcd+PrXUQinapo1l4g0W50vU4vNtblNjrnB9QQexBAI9xUp2dykro+bdH+M3jCw1qG6v9Te+tt4862kRdrr3AwBtPoR39a+m5W3KCOhGRXkUvwAttHkk1Ky1WW+e2Imt7SWAAOVIO1iD83TpgZrtvD3jW015VguNttfY5iJ+V/8AdP8ATr9auUeZc0RK60ZrzHrXhnxOjEPiTUQv/LVYJj9SCv8AJBXuU1eDfEC7XUNb1a4jOY45o7ZD67Bhv/Hiw/CtcP8AGRPYPg2cfFvRfrN/6Ikr6tr5Q+D5x8WdE/35f/RL19X1ljf4i9DWh8IUUUVxG4UUUUAFFFFABRRRQAUEAjBGQaKKAOY1T4eeHNUkaVrEWszcmS1Pl/p939K5+b4VNCxNhqYYdknjxj/gQ/wr0eiqUmjJ0oPoeap4I1m2biOGXHeOQc/nirlvoepQkCS0kGPTB/lXfUU+Zk+xicpHY3QiINvJn/dNULnSb+T7lpKf+A13VFLmH7JHmkvhLWbj7lptHq0ij+tMT4Y6lc/8fN5bwKf7oLkfhwP1r06inzsXsIdThrD4UaFAwfUXnv3HVWbYn5Lz+tdjZWFpptstvp9tFbQr0SJAo/SrFFS23uaRhGOyCsXxHrV5pLaXBpdjBe3mp3htYkuLkwRqRDLMWZ1Rz92EjAU8kdK2q5vxR/yMXgz/ALDUn/pvvKRYfbvG/wD0L3h//wAH0/8A8h0fbvG//QveH/8AwfT/APyHXSVh6N4mj1LSdQu72D7DJptxNBdRF9/l+XzuzgZBXaw46GlewFf7d43/AOhe8P8A/g+n/wDkOj7d43/6F7w//wCD6f8A+Q6g0/xpNdvbJcaUbZ7jR31TY0+SgDABD8o5IIOe3TB60mmeL9Qm/sWXV9IgtLTWlAtZra9aco7J5irIpjTGVDcgtyPxqra2/rqvzTFf+vx/UsfbvG//AEL3h/8A8H0//wAh1SsfEfjDUbzUraDw5oYk025FrMX12YBnMMcwK4tDkbZVHOOQeOhPY1zfhf8A5GLxn/2Go/8A032dIYfbvG//AEL3h/8A8H0//wAh0fbvG/8A0L3h/wD8H0//AMh1r6rqkWk2qyyxyzPJIsUMEIBeV26KuSB6nJIAAJJ4qn/aer2tjdXWq6VbRLBbvMv2a9MuSoztbdGuM9iN3fpxmJVIxvfobww9SceZdfNK/pfcqfbvG/8A0L3h/wD8H0//AMh0fbvG/wD0L3h//wAH0/8A8h0o8R6hd3Nhb6XpltLJd6et832i8aIICQNoKxtk/N14rT0TVl1rS1ulheBw7xTQucmORGKuuRwcMDz3pqabsiqmFrUoc81p6rz8/JmHeeIfFGkrbT6xoGkJZy3ltayPa6xLLIhmmSFWCNbIDhpASNw4BrrK5vx5/wAi7a/9hrSv/Thb10lUcwEBlIYZB4IPevP/ABL8NY7qSS70Bkgdvma1bhCf9k9vp0+gr0CitqNepRlzQZhXw9OvHlqI8A1DQ9T0piL+xmhAON5T5T9GHBqhg+lfR1MEUYcuI1DHqwXmvVjmzt70PxPIlk6v7s/wPBbDQNT1GWBLazlxO5SOR12oxALEbjx0Un8K9M8LeALbRZEvNRdLu9U5TA+SI+oz1PucfTvW9rLGKfTLgxyyRwXZaTyomkKgwyLnaoJ6sB070v8Abtp/zx1D/wAF1x/8RWNfGVq0bQVk+xvh8DQoTbm7td/8jSorN/t20/546h/4Lrj/AOIo/t20/wCeOof+C64/+IrzvZz7M9P2tP8AmRpUVm/27af88dQ/8F1x/wDEUf27af8APHUP/Bdcf/EUezn2Ye1p/wAyNKis3+3bT/njqH/guuP/AIij+3bT/njqH/guuP8A4ij2c+zD2tP+ZGlRWb/btp/zx1D/AMF1x/8AEUf27af88dQ/8F1x/wDEUezn2Ye1p/zI0qKzf7dtP+eOof8AguuP/iKP7dtP+eOof+C64/8AiKPZz7MPa0/5kaVFZv8Abtp/zx1D/wAF1x/8RR/btp/zx1D/AMF1x/8AEUezn2Ye1p/zI0qKzf7dtP8AnjqH/guuP/iKP7dtP+eOof8AguuP/iKPZz7MPa0/5kaVFZv9u2n/ADx1D/wXXH/xFH9u2n/PHUP/AAXXH/xFHs59mHtaf8yNKis3+3bT/njqH/guuP8A4ij+3bT/AJ46h/4Lrj/4ij2c+zD2tP8AmRpUVm/27af88dQ/8F1x/wDEUf27af8APHUP/Bdcf/EUezn2Ye1p/wAyNKis3+3bT/njqH/guuP/AIij+3bT/njqH/guuP8A4ij2c+zD2tP+ZGlRWb/btp/zx1D/AMF1x/8AEUf27af88dQ/8F1x/wDEUezn2Ye1p/zI0qKzf7dtP+eOof8AguuP/iKP7dtP+eOof+C64/8AiKPZz7MPa0/5kaVFZv8Abtp/zx1D/wAF1x/8RR/btp/zx1D/AMF1x/8AEUezn2Ye1p/zI0qKzf7dtP8AnjqH/guuP/iKP7dtP+eOof8AguuP/iKPZz7MPa0/5kaVFZv9u2n/ADx1D/wXXH/xFH9u2n/PHUP/AAXXH/xFHs59mHtaf8yNKis3+3bT/njqH/guuP8A4ij+3bT/AJ46h/4Lrj/4ij2c+zD2tP8AmRpUVm/27af88dQ/8F1x/wDEUf27af8APHUP/Bdcf/EUezn2Ye1p/wAyNKis3+3bT/njqH/guuP/AIij+3bT/njqH/guuP8A4ij2c+zD2tP+ZGlRWb/btp/zx1D/AMF1x/8AEUf27af88dQ/8F1x/wDEUezn2Ye1p/zI0qKzf7dtP+eOof8AguuP/iKP7dtP+eOof+C64/8AiKPZz7MPa0/5kaVFZv8Abtp/zx1D/wAF1x/8RR/btp/zx1D/AMF1x/8AEUezn2Ye1p/zI0qKzf7dtP8AnjqH/guuP/iKP7dtP+eOof8AguuP/iKPZz7MPa0/5kaVFZv9u2n/ADx1D/wXXH/xFH9u2n/PHUP/AAXXH/xFHs59mHtaf8yNKuf8R+DtO8RAySg292BgXEY5PpuHcfr71e/t20/546h/4Lrj/wCIo/t20/546h/4Lrj/AOIq4KtTlzQTTIqOjUjyzaaPLNT+Heu6ezGCFb2IdGgPP/fJ5/LNYc2i6pbKzXGnXcQUEkvCy4A6nkV7f/btp/zx1D/wXXH/AMRVLWdUhvNCv7W2t795praSONTp84yxUgDJTA5PevVp5hXulOB49XLsPZuE/wAmeVWXg7X759sWmTxju06+WP8Ax7H6V3Hh/wCGdvZyJca5It1IpyIE/wBWPqerfTgfWu8orlrZjWqKy09Dso5ZQpPmer8zA8S+DNH8UWyR38GyWJdsNxD8rxj09CPY/hip18I+HAoB0HS2IHU2UfP/AI7WxWBd+PPCFheS2l94q0S2uYWKSwzajCjow6gqWyD7GuD2k7Wud/s4XvYsf8Il4c/6F/S//AKP/Cj/AIRLw5/0L+l/+AUf+FUv+Fj+CP8AocvD/wD4NIP/AIqj/hY/gj/ocvD/AP4NIP8A4qjnn3H7OHYu/wDCJeHP+hf0v/wCj/wo/wCES8Of9C/pf/gFH/hVL/hY/gj/AKHLw/8A+DSD/wCKo/4WP4I/6HLw/wD+DSD/AOKo559w9nDsXf8AhEvDn/Qv6X/4BR/4Uf8ACJeHP+hf0v8A8Ao/8KpD4jeCDnHjHQOOv/E0h4/8eo/4WP4I/wChy8P/APg0g/8AiqOefcPZw7F3/hEvDn/Qv6X/AOAUf+FH/CJeHP8AoX9L/wDAKP8Awql/wsfwR/0OXh//AMGkH/xVH/Cx/BH/AEOXh/8A8GkH/wAVRzz7h7OHYu/8Il4c/wChf0v/AMAo/wDCoG8D+GXcs2jWxLHJ+U1D/wALH8Ef9Dl4f/8ABpB/8VR/wsfwR/0OXh//AMGkH/xVHtJ9xqEVsiT/AIQXwx/0Brb8j/jR/wAIL4Y/6A1t+R/xrU0vWNM1yzN3ouo2mo2wYoZrSdZU3DqNykjPI496uUe0n3Y+VHP/APCC+GP+gNbfkf8AGj/hBfDH/QGtvyP+NdBRR7Sfdhyo5/8A4QXwx/0Brb8j/jR/wgvhj/oDW35H/Gugoo9pPuw5Uc//AMIL4Y/6A1t+R/xq/pnh/SdGkd9LsIbZ5BhmReSPTNaNFJzk1ZsLIKKKKkYUUUUAFFFFABRRRQAV80vqM2j+LpNStl3vBcSB4x/y0jLfMv16Ee4FfS1fMOq/8hi8/wCu7/8AoRrvwaUuZMxq9D2nSb621OxivLGVZoJVyjr/AC9iOhHY1sQjpXgeia/qXhy6abTJFaKRt01rL/q5T6+qtj+IfiDivRtK+K2hSoBqyXOmS998TSxn6OgPH+8FpVKMovyJjJHey/drxfx7oZ0fXvtdspW3uyZFK8bH/iH9R9fau/uPiT4QWPcNcgf2jV3b8gCa4bxf4+stfszYaXps00ZcN9ruf3ITB6qpG4nGRyF608PzxnsOdmirD481ODRJ7cqtxd7NtvO5+6TxlvXHX3xjvmuD1aEQaGYwS20jLMeWOeSfcnmtWs/XP+QRL9V/mK9BQjF3Ri9if4RnHxW0T/ro/wD6KevrKvkv4TnHxU0P/rs3/oDV9aV5uN+NehrQ+EKKKK4joCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACub8Uf8jF4M/wCw1J/6b7yukrA8Uabqd7Not5osVpPc6Xfm6MN3cNCkim3mhI3qjkEecD905xjigDfrz/xJo1+fE91YWNvM9h4mSJLuaOMlLcxHEhYjhd8XyjPUitz7d43/AOhe8P8A/g+n/wDkOj7d43/6F7w//wCD6f8A+Q6OqYdClq1hct45lmgtZWt/+EemgV0jJXeZBhM9M47dad4R8LtDo+g3esXuoXVxZ2cZgtbsRolo5jCnCoiksBlfn3Ec9yat/bvG/wD0L3h//wAH0/8A8h0fbvG//QveH/8AwfT/APyHQtF/Xdv9Qer/AK7JfodJXN+F/wDkYvGf/Yaj/wDTfZ0fbvG//QveH/8AwfT/APyHWbplt4303UdZuhougS/2peLdlP7bmXysW8MO3P2Q7v8AU7s8fexjjJANjxRaXT/2ZqNjbG7k0y8Fw9upG+SMoyNszgbgHyASM4x3pL3VU1jQ9St7Gz1AsbOXmaylh+YqQFAkVSxP+yD05xkZi+3eN/8AoXvD/wD4Pp//AJDo+3eN/wDoXvD/AP4Pp/8A5DrKVPmUlfR/5WOuOISjFSjdx2+++vfy231uZ1jo+oT6po2y5v8ATBFoSRySwxJ9/cnyN5iMAe+ODxXV6bp1vpOnx2dmrCKPJy7FmYkkszE8kkkkk9zWL9u8b/8AQveH/wDwfT//ACHR9u8b/wDQveH/APwfT/8AyHVRio6/13DEYuddJPRf8Pv3307B48/5F21/7DWlf+nC3rpK47U7Txfr0NrZ32laJZWyX9pdSzQ6vNM4WG4jmICG2QEny8csOua7GrOQKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK5vwH/yLt1/2GtV/9OFxXSVzfgP/AJF26/7DWq/+nC4oA0tX1/T9Da2XUHmD3bmOCOC2lneRgpYgLGrHoCenaoV8WaM2jXWqG7ZLWzbZc+ZBIkkLZHDRlQ6nkcEdCD0rF8apdyeKPCK6dPDBcm9n2STwmVF/0d85UMpPGf4hXNao+7wL42/tHK695yDUUB/d4GwRNEO0bIARnJzuBJxQuv8AXYfVf13/AMj0LUvEum6TexWd0bp7iaMypFa2U1wxQEAsRGjYGSOvrVzTtRtNW0+G+06dbi2mXcki9/w6gg8EHkHg1yuqyalF8SrA6Ra2t1N/Y8wZbq5aBQPNj5BWN8npxgfWtzw1o0mh6QYLiVJrmaeW5uHjTanmSOXYKDkhQTgZ9KFqr/1u0T1+78rlLxR/yMXgz/sNSf8ApvvK6Sub8Uf8jF4M/wCw1J/6b7yuikDGJhGcPg7T70m7K4zMuPEul295JbNNLI8RxM0FtLLHCfR3RSqEDkhiMDk8VZl1aygvHtZZ8TJbG6ZdpOIgcFsgY69utY3ge7tU8D2u+RYpLSMrfiQhWinGTL5nod2SSeoOe9VNYOfGd6RyP+Edl/8ARlc8qkoxT0d/8m/0PV+qUvbyo2a5b697fLT8fU2tP8T6XqdxDBayzrJPGZIRcWksAmUAElDIqhuCDxnjmtauP0HTdT1Sx8OXGpR2dtaadCk8IgmaWSZjDsXdlFCABiSBuyccjHPYVvFtrU58ZSpUanJTfrqnbV9VZbWZzfhf/kYvGf8A2Go//TfZ10lc34X/AORi8Z/9hqP/ANN9nXSVRxBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAV8w6r/yGLz/ru/8A6Ea+nq+V9U1G1/ti8/e/8t3/AIT/AHj7V6GB3kYVWlYSiq39o2v/AD1/8dP+FH9o2v8Az1/8dP8AhXpmHMizRVb+0bX/AJ6/+On/AAo/tG1/56/+On/CgOZFmqGt/wDIHm/4D/6EKm/tG1/56/8Ajp/wqnqt3BNpU6RvubCnGD/eFITasT/Cs4+KWhf9fB/9BNfW9fKPwi0y91D4laXLZ27yx2knnTuB8saYIyT+nvX1dXlY3416G9D4QoooriOgKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACuF8O+Irbw/Y3un6pYa2lwurahL+50O8mRkkvJpEYPHEysCjqeCetd1RQBysvjHQJ5oZp9M1uSW3YtC7+Gb8tGSMEqTBwSCRx2NQ3PiXwteTSS3eh6tPJLEIZHl8K3zF0ByEJMHK55x0zXYUUAct/wmWgm6W5Om659oVDGsv/CM3+8KSCVz5GcZAOPapf8AhPNI/wCfPxB/4Tmof/GK6SigDgNe8V2V7rXhq4tdP8QPFYam9xcN/wAI9fDZGbO4jBwYefnkQYGTznoCRt/8J5pH/Pn4g/8ACc1D/wCMV0lFAHGXHiDwld36X114f1Oa7QgrcSeFL1pFI6YY2+RjtVl/GHh+SZppNL1t5WjMTO3hi/LFCclc+R09uldVRS5V2NHUm7Jt6HMR+ONFhiSKGw16ONFCoi+Gr8BQOgA8jgU//hPNI/58/EH/AITmof8Axiukopme5y/g2Rru+8T6gttdwW99qyy2/wBrtZLd3RbO2jLbJFVgN8bjkc4rqKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAr5+1HwR4kl1S6kj0e5ZHmdlIA5BY+9fQNFb0qzpXsTKKkfO3/AAgvif8A6A1z+Q/xo/4QXxP/ANAa5/If419E0Vv9dn2RHskfO3/CC+J/+gNc/kP8aP8AhBfE/wD0Brn8h/jX0TRR9dn2QeyR87f8IL4n/wCgNc/kP8aD8M/E2rj7CdPktBMyhp5uFjG4Ek/gDx3r6JopPGTtsHskYfhHwjpvg3Q007So/wDamnYfPM/95j/Idq3KKK4223dmiSSsgooopDCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAornG+IvglGKv4w0BWU4IOpwgg/8AfVJ/wsfwR/0OXh//AMGkH/xVAHSUVzf/AAsfwR/0OXh//wAGkH/xVH/Cx/BH/Q5eH/8AwaQf/FUAdJRXN/8ACx/BH/Q5eH//AAaQf/FUf8LH8Ef9Dl4f/wDBpB/8VQB0lFc3/wALH8Ef9Dl4f/8ABpB/8VR/wsfwR/0OXh//AMGkH/xVAHSUVzf/AAsfwR/0OXh//wAGkH/xVH/Cx/BH/Q5eH/8AwaQf/FUAdJRXNn4jeCB18Y6AP+4pD/8AFUf8LH8Ef9Dl4f8A/BpB/wDFUAdJRXN/8LH8Ef8AQ5eH/wDwaQf/ABVH/Cx/BH/Q5eH/APwaQf8AxVAHSUVzf/Cx/BH/AEOXh/8A8GkH/wAVR/wsfwR/0OXh/wD8GkH/AMVQB0lFc3/wsfwR/wBDl4f/APBpB/8AFUf8LH8Ef9Dl4f8A/BpB/wDFUAdJRXN/8LH8Ef8AQ5eH/wDwaQf/ABVH/Cx/BH/Q5eH/APwaQf8AxVAHSUVzf/Cx/BH/AEOXh/8A8GkH/wAVR/wsfwR/0OXh/wD8GkH/AMVQB0lFc3/wsfwR/wBDl4f/APBpB/8AFUf8LH8Ef9Dl4f8A/BpB/wDFUAdJRXN/8LH8Ef8AQ5eH/wDwaQf/ABVdDBPFc28c9tKk0Mqh45I2DK6kZBBHBBHegB9FFFABRRRQAUVm61qo0uCFlltBLJKFSG4nWIzeqoSQN/PA/DjORzWqeNdYsdTt7ZNFjIe5aInbeNvAVj8pFtj+HPy7+O2PmFxpylsZyqRhudvRWJHr90ujRX1zpMpaSTZ5UMgQrk7Vz9oEJ5PAGOcjGc1l3firXDrE+n6f4en89LVLiOGeSDcfnYNkibG0gAAjJBOSDwC1Tk3YHUilc6+iuXvPFd7HY6fcW2h3LfarpYXHnW7jB4IVllxknIB6cHOKqjX9bksnvPPghRrieKKCPRbi6dfLkKYZopcAnHXAHXHSj2btf+vwD2kb2/r8TsqK50+I76ys7D+09CvXublI1ZrcwrH5zLkoA8oYYORz+ZqvB4p1W1lhtdZ8OXv2m5mdLb7O9viVQC2SDMdpABzyRx15xR7OQvax/pHVUVz914guYtUe2hhtMpZi4liu7nyHt+pLOwDAp2JTdtI54bIo2fiPxFNH9ruNK0uC0uJxDaGW9mQtkcMT5J4Y/dJCdQMHIyKnJjdSKOuorA1HX79JLyy0fRri9v7eJSWDxCFXYZAJaRWI+gp58Rz28lst/oWo2yzzJAJna3Kh2OBkLKxxn2NLkY/aRRuUUUVBYUUUUAFFFFABRRUN3dw2NpJc3T7IoxlmClj+AHJPsKAJqKZNPFbwPPcSJFFGpZ5JG2qoHUknoKwpvHfhmC8t4DrVi4n3ASpdRsiEDOGIb5c84J44xnJGaUZS2RLlGO7OgorNTxDo8tjNeW+pWtzbwECWS3lEoQk4Gduajn8S6dBeT2pF7LLbsEl+z6fPMqkgNjciEZwQevejlle1g542vc1qKq6dqNtqtkt3YuzwszKC8bRkFWKkFWAIwQRyKVdRtW1N9PEmLpIxKY2UjKE4ypIwwzwcZxxnGaVnew+ZWuWaKq3eqWVjPFDe3McDzKzJ5h2htoyeTxnHOPQE9jWZ/wAJv4X+1G3/AOEg03eE35+0rtxnH3s7c+2c+1NRk9kJyit2btFQxXdvPZi7gnjlt2Xes0bhlK+oI4IotLqG+s4bq1YtDMgkjYqVypGQcHBFKzHdE1FFFIYUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAHM/Dt1j+FHhZ5GCouiWhZmOAB5Cc1oad4m0vVblYbKSdjIpaKSS0ljjmA7xyMoV+OflJyORxzWJ4Qt7S7+CGhW2pSCKzm8O28c8hcIEjNsoY7jwMDPNN0q91nwzqemeH9Tkt9WsrtGj0+9hHlzqI0LYlToRtAG9SOQMj5qV97gdnRXl/wBrnk+Gcni7+2L4a9guEW8k8pZ9+0W32fd5fX5NpUtznO7mlu9cvYfhp4suJ9RmgvbfVZ4o2NwQ8OZVKIpzkfKwwB2NPy/rp/mHY9PorjdTgm1L4nWeny6hfQ2I0h53t7a6eESOJVAJKEHjPYjPQ8ZBj0X/AInd1rGpatqV5Fc6fqElvHbRXrwR2yRt8m5FIV9w+bLhshgOgpX0v6/g7B/wPxVztqqX+p2mlrA19N5QuJ0t4jtLbpHOFXgHGT3PFec6C/ibWrDT9fjure3uJLtTPJNrk2zG/a1ubXyvLU4+UAHcDg7ick9N49/49dC/7Dln/wCh0+q82l+X+YPr5J/qXZ/Guh2t5Pbz3Fwn2aYQTzGyn8iJzjhptnlr94clsc1vV51b2Gsaz/wl+kWUVjHZXupSQzXc07mSNWijDbYgmGO3oS45PTjB9CghW3t44Y87I0CLn0AxQvhT9PyB7tepz3gP/kXbr/sNar/6cLir154l02yvpbOX7XJPCqtKtvYTzBA3IyUQgZwe9UfAf/Iu3X/Ya1X/ANOFxUmmMqeM/ELOQqrFakknAA2vWc21a39aHVh6cJKcppvlV9Hbql2fc27W6t721jubOeOeCQbkliYMrD1BHWpa8+bU7nT/AAr4i1XRiq2txqoa1m3bUWNjGksynDALu8xt2COrYI63Lew8QWcl2Le+tbGOawk8oT6tLfFZuNko82MFVGcHBIOV49Y9t5dL/hc7JZda750leyv6JtPrdXtonrfY7Ge4htYvMuZo4U3Ku6RgoyxAAye5JAHuai+2/wDE1+w/Zrj/AFPnfaPL/dfext3f3u+PSvOtUWKXQLjTNQj1S0v7K7sXmSXVJZkYPcqgkSTfkghScMF2nBAB5rqoDJa+PY9PinuDax6RuEck7yZbzcbiWJJbHGTzSVVt+X/Af+Q54CNODd7v3u1rJRaaabve/odJRXm+mPeW/hfwzrLapqE15cahDDKZbp2jkjkkZCpjztOAeGxuyAc0+91q4m1ax1XT2ngt5NaSwEk+pv8A6QN/luq2oBj2/ewSQ3y7j7irJ203/wCB/miv7Km5uMZXs2r7arpq+v3+Wh3kt/DHDdvETcPaAmWGDDyA7dwXaP4iCMDvkVLbTfabWKfy5IvNQP5cq7XTIzhh2I7iuHtbGKyvPG9zbT3izwMdhN7K2M2kbZwWIJz0J5AGBgDFWPtdxenwppt3eXENrf2JlmljnaOSeVUjKp5gIYZ3MxwQTt64yCRqt7+X43/yIlgY6cj7O7Wvwcz0/L+mdpRXnGoXF7D4gGjWGqXosI9UtIxKLhnkQukpkhMjElhwpwxJG4e2Oi8O+ZaeKde0pbm5mtLdbaaFbmd5mjMisGAdyWx8gOCeCT61UKvM9utvna5FbL3SpufN0UtujaX3+8tPXXa+zNqtlb3r2k022eO3N0ybGOIgcFs4x17daq6f4n0vU7iGC1lnWSeMyQi4tJYBMoAJKGRVDcEHjPHNYus/8jpff9i7L/6Mo0HTdT1Sx8OXGpR2dtaadCk8IgmaWSZjDsXdlFCABiSBuyccjHMxqSlK39btfkjT6nQjQ9pNvbut7Ppa71SWm3U7Cub+HH/JLPCn/YFs/wD0QldJXN/Dj/klnhT/ALAtn/6ISug8g6SiiigAooooAwfGcgj8NMzBji6tvlRSzN+/Q4Cjkn2HNcEfDsLSapf/AGXSbCxW+dB9te1h8s8fL89rJjr/AH8e1et0VrTqcit/XT/IxqUud/15/wCZxnhiy8v4d2dpZ6TbXQvVfzlZ1jhcEnLOwXJBUAAqpzx0HIy00KLxFrV4lvrUd7NbWEEaXNq58qMh5AYG2PuKsoG4M5Y5znoB6PRT9q+ZyXUXsVyqL6HEazBBcroen6hAljIL2ONdKjnQxSIudzqq4LJjjDAYHVRXNjT7Ey3s2naNZ6rdyXF1Ddq1mJjaYnfZN905IU/6sfMwC4GBXrdFONaytYJUU3v2/A5Wa70GXw1Do2n3L3u2FEgjsB5syFcbH44QhlHzPtUEckVFYX11Zan9u8ZxPbTLCIoJ0jzbRIdpcsylvLYnG4uQowApbknr6Kn2m/mV7PbXY43xPqlrcaiIFW2vEXTneOMwJMZ5JiBCiZByDsZiBxhcngVh3+n6RpmoGLUdN0iK3hmt47iX7HDEAGt5Cx37QVy6rgggg4xivTqKcanKrIUqXM7v+tLHnsttdeIvtbRabFNJLJp1xJZ3Uvybdu5ldiDkAdflJ9qJLSDStSitGh0jTrm61Gykj07T5wzbUc7n27EP447da9CqjrGsWWg6Y+oapKYbWNlV5AhbbuYKCcdskUOuo69N/wAv8gjhZVGoR1k9Nu9+nzL1FRWt3b31rHc2c8c8EgykkTBlYexFS1jubtNOzCiiigQUUUUAZXin/kT9Y/68Zv8A0A15lLDYWF/KGsdL+zxSyKi3tsrwQ73tFL7cgDAYnqK9durWG9s5rW6TfDPG0ci5I3KRgjI56Gsq08I6LYXiT2dlHCqBsQKoMe5mRt20jggxKRjHr15rejUUHqc9em6iSRw2mSW83h/xTJbW9jAs2nCMf2fCIopCJLiNWVQT94Be5refWbuzvrcX10Qtjq72s/RVaGSIvGWA4OMqMn0raHhiJ7qa4u7+8unmkhd/MMagiJmZEwqD5ctn1OBzUFz4Se7hu4ptf1LbeJsuNkVqpkXGMFhDnpx1q3UjJ3f9bf8ABIjTlFW/rr/wGYGsW8958NFuNRsV1G4uXN2Gu2BFqHk3KBkEjCsFAA9elU2jutP1HULJ73T9K0v7YFeeKKaBIpVtoiFzHOm1GG7AJPIHXIx2UvhyS5sfsd5reoXEBdSyMluu5VOdnyxDg8dMHjqKJ/Cen3d9dzXzz3MF3IJZLORx5O8Kq7toALcKOGJAPIAPNCqRTfbX9BunJ2b3/wCHKWlaBZ6x4MtrfWdOtZNySGItASyBySHHmF2VyCGOWJyetYJ0TRtRs08ODQbCHWuI7uWOyRfKiBG6dWx/GPu453N/stjshohFotqNV1EQK5O3zhuKY+55m3fgeu7d/tU1vC+jNbJCLFUMbl0mjZkmDnG5/NBD7jgZbOT3JqVUtJu43SbilYztQ0mw0q+0lNLSOxWW5KLaQ2qNBI2wtvZOMMuwEODnjHeubgub+DT5DHrKCe+CTyXv9mMJnJmESHIuMYBI+XG3bng5IPYS+GRcGE3GralI8CSJG5eMMqvtBGQgOcLgN97DNznBC3fhWwuo1jRprZY7dLeIQlf3ao4dSMg8gqOuR7URqJWu/wCv6sEqbeyt/X+VzmPEUlvLcTX2o2ulajcWejsx82MTwLKsu1sA8jByMZBHSsy+t9FlsNUitI/C9+YbEzpcaVYJG0LhwBkh39fau8s/DFhaEFt9z+4aGRbgKyyhpDIzMAoGSxPTA9qm1nRv7agFvLfXVvbsMSwwCPEwyOGLISOn8JHWqjVUWl/W5M6LkpPvb8kaVFZ+ra5p+hRwSarcC2iuJRCkjA7QxBIye3Q8mr0ciSxrJEyujgMrKchgehBrms7XOq6bsOooopDCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigDgPBnimy0bwHoGl6lp+vxXllptvb3EY8P3zhJEiVWG5YSDgg8gkHtVrTtc8H6PNJLpPh3UrGSQYd7XwnexFx6ErbjNdrRQBxX9ueD/7W/tT/AIR3Uv7Rzn7Z/wAIne+dnGM7/s+enHXpSXOs+Db29e8vPDeoXF1Iux55fCV6zsuMYLG3yRiu2ooA5X/hMdA+2C7/ALM1v7SI/KE3/CM3+8JnO3d5GcZ5xVafxB4SutTi1G68P6nNfQ48u6k8KXrSpjkYc2+RjPrXZ0UAcWmu+EI9WOqR+HtSXUGJJu18J3olJIwfn+z56cdatXHjLQLsRi60zW5hHIJEEnhm/bY46MMwcEdjXVUUActD4z0G3aVrfTdciMz+ZIU8M3672wBuOIOTgDn2qX/hPNI/58/EH/hOah/8YrpKKAOA8J+K7LS9Fnt77T/EEUr6nf3Cr/wj182Y5byaRDkQnqjqcdRnBwcirN7rXg7Urn7TqPhzUbufAHmz+Er12wOgybfNdtRSaT3LhUnTd4Np+RzL+OdGkjZJLHXnRgQyt4b1Agj0P7iqdn4h8J6fBNDYaBqlrFOMSxweFL1FkGMfMBb88E9a7Kiiye4Kc4pxT0ZxsHiHwna2EtjbaBqkNpNky28fhS9WOTIwcqLfB4A61Lb+K/DVoyG10fWIDHF5KGPwvfLtTOdgxBwuecdK62ijlXYbq1JXvJ6+ZyQ8V+G1tobddH1gQQOHiiHhe+2xsDkFR5GAQeciof8AhIPCQvHu/wCwNT+0yMHeb/hFL3ezAgglvs+SQQCD6iuzoo5V2BVai2k/vOQk8T+GJrxrubRdWkuXjMTTN4Wvi7IeqlvIzj26Utx4p8M3diLK70bV57RQALeXwtfNGAOnymDHHauuoo5V2D2k9NXpschD4m8L29tBb2+iatFBbv5kMSeFb5Vibn5lAgwDyeR6mpk8Z6DHcS3Eem64s0wUSSL4Zvwzhc4BPkZOMnHpmupooshOc5Xu9zlX8YeH5Jmmk0vW3laMxM7eGL8sUJyVz5HT26U+PxxosMSRQ2GvRxooVEXw1fgKB0AHkcCunoosiXJtWbOb/wCE80j/AJ8/EH/hOah/8YqXwHaXFh8OfDdnewvBc2+k2sUsUgwyOsKgqR2IIIrfopiCiiigArOvfDuialcm41HR7C7nIAMs9qjtgdBkjNaNFJpPcuFSdN3g2n5GN/whvhj/AKFzSf8AwBi/+Jo/4Q3wx/0Lmk/+AMX/AMTWzRU+zh2NvreI/wCfkvvZjf8ACG+GP+hc0n/wBi/+Jo/4Q3wx/wBC5pP/AIAxf/E1s0Uezh2D63iP+fkvvZjf8Ib4Y/6FzSf/AABi/wDiaP8AhDfDH/QuaT/4Axf/ABNbNFHs4dg+t4j/AJ+S+9mN/wAIb4Y/6FzSf/AGL/4mj/hDfDH/AELmk/8AgDF/8TWzRR7OHYPreI/5+S+9mN/whvhj/oXNJ/8AAGL/AOJo/wCEN8Mf9C5pP/gDF/8AE1s0Uezh2D63iP8An5L72Y3/AAhvhj/oXNJ/8AYv/iao6x8PPDWraY9mulWdj5jKTNZ2sccgAYEgNt4zjH4109FJ0oNWaLhjsVCSlGo7rzZR0fRdP0DTUsNItUtrdDnavc9ySeSfc1eooq0klZHNOcqknObu31YUUUUyAooooAyX8K+HpHZ5NB0xmY5Zms4ySfXpSf8ACJeHP+hf0v8A8Ao/8K16Kvnl3I9nDsZH/CJeHP8AoX9L/wDAKP8Awo/4RLw5/wBC/pf/AIBR/wCFa9FHPPuHs4djI/4RLw5/0L+l/wDgFH/hR/wiXhz/AKF/S/8AwCj/AMK16KOefcPZw7GR/wAIl4c/6F/S/wDwCj/wo/4RLw5/0L+l/wDgFH/hWvRRzz7h7OHYyP8AhEvDn/Qv6X/4BR/4Uf8ACJeHP+hf0v8A8Ao/8K16KOefcPZw7GR/wiXhz/oX9L/8Ao/8KP8AhEvDn/Qv6X/4BR/4Vr0Uc8+4ezh2OZ1b4e+HNWjgjOm29okUokf7JCkRlABG0sBnbz0HpW/ZWVtp1lFaWMKQW8S7UjQYCip6KHOUlZsI04xd0goooqCwooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD/9k=" alt="lvs-nat"></p>
<ol>
<li>ipvs: linux内核中，真正执行负载均衡调度工作。</li>
<li>ipvsadm和keepalived是并行的，都是ipvs的管理工具。</li>
</ol>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>cat /etc/redhat-release uname -rm</p>
<table>
<thead>
<tr>
<th>ip</th>
<th>负载均衡角色</th>
<th>高可用角色</th>
<th>备注</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.80.128</td>
<td>LB（keepalived+lvs）</td>
<td>MASTER</td>
<td>VIP为192.168.80.212</td>
<td>CentOS Linux release 7.9.2009 (Core)  / 3.10.0-1160.el7.x86_64 x86_64</td>
<td></td>
</tr>
<tr>
<td>192.168.80.131(暂时没有启动)</td>
<td>LB（keepalived+lvs）</td>
<td>BACKUP</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>192.168.80.129</td>
<td>RS1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>192.168.80.130</td>
<td>RS2</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>测试环境，上述ip都选择一个网段的。如果生产环境且是Web服务器，还需要接入一个内网网段？</p>
<p>安装keepalived</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">开机启动</span></span><br><span class="line">systemctl enable keepalived</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">日志处理</span></span><br></pre></td></tr></table></figure>
<p>安装ipvsadm</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">开机启动</span></span><br><span class="line">systemctl enable ipvsadm</span><br></pre></td></tr></table></figure>
<p><strong>查看内核中是否拥有ipvs</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>
<p>如果没有，启动下keepalived / 或者启动ipvsadm，再次查看</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line">lsmod | grep ip_vs</span><br></pre></td></tr></table></figure>
<p><strong>防火墙等</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">systemctl status firewalld</span><br><span class="line">systemctl stop firewalld  		#关闭防火墙</span><br><span class="line">systemctl disable firewalld  	#禁止firewall开机启动</span><br><span class="line"></span><br><span class="line">sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux        #关闭selinux，重启生效</span><br><span class="line"><span class="meta">#</span><span class="bash">setenforce 0        　　　　　　　<span class="comment">#关闭selinux，临时生效</span></span></span><br><span class="line">reboot							#重启机器！！！</span><br><span class="line"></span><br><span class="line">ntpdate 0.centos.pool.ntp.org    #时间同步</span><br></pre></td></tr></table></figure>
<p><strong>操作ipvsadm，清理已有的，重新进行观察</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ipvsadm -Ln</span><br><span class="line">ipvsadm -C #清空所有之前配置的内容</span><br><span class="line">ipvsadm -Ln</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 手动lvs，没有自动健康检查功能（keepalived有哦），可以自己写脚本实现（探测rs的服务状态，有就 -a 加入规则，没有就 -d 删除。注意检查次数。）。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以手动增加lvs规则</span></span><br><span class="line">ipvsadm -A -t vip:port -s rr #创建一个vs规则</span><br><span class="line">		   -p 300 会话保持300秒（这个时间内，只能用某个real server）</span><br><span class="line"></span><br><span class="line">ipvsadm -a -t vip:port -r rip1:port -g #给vs，增加一个real server,-g是lvs的dr模式 (-m NAT模式;-i TUN模式)</span><br><span class="line">ipvsadm -a -t vip:port -r rip2:port -g</span><br><span class="line"></span><br><span class="line">ipvsadm -Ln</span><br><span class="line">ipvsadm -Ln --stats</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">手动设置超时时间</span></span><br><span class="line">ipvsadm --set tcp tcpfin udp</span><br><span class="line">ipvsadm --set 30 5 60</span><br><span class="line"><span class="meta">#</span><span class="bash">手动删除规则</span></span><br><span class="line">ipvsadm -d -t vip:port -r rip2:port #删除一个rs</span><br></pre></td></tr></table></figure>
<p>DR模式的缺陷<br>1：Realserver和 lvs的vip提供服务的<strong>端口</strong>必须一致。<br>也就是说：vip的端口对外端口为 80，但后端服务的真实端口为8080，通过lvs的DR模式是实现不了的。<br>2：<strong>Realserver和LVS不能在同一台机器上</strong><br>3: <strong>Realserver 和LVS需要在同一个vlan或者局域网下。</strong></p>
<p>NAT模式的缺陷<br>1：NAT模式流量的入和出都需要通过LVS服务器。<br>2: 效率相比DR模式，性能和效率上会差一些。</p>
<h3 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h3><p>主机</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 设置ipv4转发</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">临时生效</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<p>real server</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">增加网关(会导致ssh等方式也不行)(指定必须经过VIP才能达到client)</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route add default gw VIP</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">单独增加一条路由(指定必须经过VIP才能达到client)</span></span><br><span class="line">route add cip via VIP</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">eg.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">ip route add 192.168.80.1/32 via 192.168.80.212 dev ens33</span></span><br><span class="line">ip route add 192.168.80.131/32 via 192.168.80.212 dev ens33</span><br><span class="line"></span><br><span class="line">route -n</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">192.168.80.1    192.168.80.212  255.255.255.255 UGH   0      0        0 ens33</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump -i any port 8989 -n</span><br></pre></td></tr></table></figure>
<p>客户端访问</p>
<p>在192.168.80.131服务器上访问：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl 192.168.80.212:8989</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>ip</th>
<th>负载均衡角色</th>
<th>高可用角色</th>
<th>备注</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.80.132</td>
<td>LB（keepalived+lvs）</td>
<td>MASTER</td>
<td>VIP为192.168.80.212</td>
<td>CentOS Linux release 7.9.2009 (Core)  / 3.10.0-1160.el7.x86_64 x86_64</td>
<td></td>
</tr>
<tr>
<td></td>
<td>LB（keepalived+lvs）</td>
<td>BACKUP</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>192.168.80.133</td>
<td>RS1</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>192.168.80.134</td>
<td>RS2</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>192.168.80.131</td>
<td>client</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="route相关操作"><a href="#route相关操作" class="headerlink" title="route相关操作"></a>route相关操作</h3><h6 id="【废弃】方式1-rc-local"><a href="#【废弃】方式1-rc-local" class="headerlink" title="【废弃】方式1 rc.local"></a>【废弃】方式1 rc.local</h6><ol>
<li>重启服务器生效</li>
<li>重启网络服务，则静态路由失效</li>
<li>rc.local是系统启动后最后运行的一个脚本，因此如果有如NFS需要网络才能挂载的服务需求，则该方式不适合</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/rc.local</span><br><span class="line">ip route add 10.253.103.43 via 10.253.103.200 dev eth1</span><br><span class="line"></span><br><span class="line">sudo chmod +x /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">reboot</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route -n</span></span><br></pre></td></tr></table></figure>
<h6 id="【废弃】方式2-static-routes"><a href="#【废弃】方式2-static-routes" class="headerlink" title="【废弃】方式2 static-routes"></a>【废弃】方式2 static-routes</h6><p>适合cent0s6,但RHEL7 官网文档没有提到/etc/sysconfig/static-routes，经测试此文件已经无效。</p>
<ol>
<li>重启服务器生效</li>
<li>重启网络服务生效【优点】</li>
<li>适合需要网络需求的服务</li>
</ol>
<p>如果需要添加静态路由，尽量将静态路由添加到/etc/sysconfig/static-routes文件中。避免因重启网络服务导致路由失效，从而避免故障的发生。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">route -n</span><br><span class="line">vi /etc/sysconfig/static-routes</span><br><span class="line">any net 192.168.100.0 netmask 255.255.255.0 gw 192.168.102.1gg</span><br><span class="line"></span><br><span class="line">service network restart</span><br><span class="line">route -n</span><br></pre></td></tr></table></figure>
<h6 id="【使用】方式3-network-scripts配置"><a href="#【使用】方式3-network-scripts配置" class="headerlink" title="【使用】方式3 network-scripts配置"></a>【使用】方式3 network-scripts配置</h6><p>永久静态路由需要写到 /etc/sysconfig/network-scripts/route-<em>interface</em> 文件中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/sysconfig/network-scripts/route-eth1</span><br><span class="line">10.253.103.43 via 10.253.103.200 dev eth1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启设备或计算机生效 </span></span><br><span class="line"><span class="meta">#</span><span class="bash">nmcli dev connect eth1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">或者nmcli dev disconnect eth1 &amp;&amp; nmcli dev connect eth1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">reboot</span></span><br><span class="line"><span class="meta">#</span><span class="bash">route -n</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">route show | column -t</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看经过的网卡名，是eth0还是其他</span></span><br><span class="line">ip addr</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果是eth0则新建并编辑</span></span><br><span class="line">vim /etc/sysconfig/network-scripts/route-eth1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在route-eth0文件中添加以下行</span></span><br><span class="line"><span class="meta">#</span><span class="bash">目标网段及掩码         网关           途径设备</span></span><br><span class="line">192.168.100.0/24 via 192.168.102.1 dev eth0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启网络服务</span></span><br><span class="line">service network restart</span><br><span class="line"></span><br><span class="line">ip route show | column -t</span><br></pre></td></tr></table></figure>
<h3 id="DR-同网段"><a href="#DR-同网段" class="headerlink" title="DR-同网段"></a>DR-同网段</h3><h4 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h4><p>keepalived 是为了解决lvs的问题而诞生的。</p>
<p>keepalived和lvs结合的特别紧密，不需要单独跟踪lvs的健康情况来漂移vip。（lvs启动在linux内核中，没有单独的进程）</p>
<p>keepalived + lvs 是最常用方案，可以自动管理vip，且自动real server健康检查。</p>
<p><strong>配置keepalived，让LVS拥有VIP：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ifconfig  #判断使用eth0还是ens33</span><br><span class="line"></span><br><span class="line">vim /etc/keepalived/keepalived.conf #配置</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line">ip addr  #查看vip是否已经在本机上</span><br><span class="line">ipvsadm -Ln #查看rs规则已经建立</span><br></pre></td></tr></table></figure>
<p>keepalived修改配置重载:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1. 修改conf并退出</span><br><span class="line">2. kill -HUP $(cat /var/run/keepalived.pid)</span><br><span class="line">3. 观察日志</span><br></pre></td></tr></table></figure>
<p>说明：man ./keepalived.8</p>
<h4 id="RS"><a href="#RS" class="headerlink" title="RS"></a>RS</h4><p>在每一台real server上绑定VIP</p>
<h5 id="临时生效！"><a href="#临时生效！" class="headerlink" title="临时生效！"></a>临时生效！</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> lo上绑定vip，32位来绑定</span></span><br><span class="line">ip addr add VIP/32 dev lo label lo:0</span><br><span class="line">或者</span><br><span class="line">ifconfig lo:0 VIP/32 dev up</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#【但是系统会自动补充这个路由所以可以不要了】此地址仅用作发送Web响应数据包的源地址，并不需要监听客户机的访问请求（改由调度器监听并分发）。因此使用需接口lo:0来承载VIP地址，并为本机添加一条路由记录，将访问VIP的数据限制在本地（本机的VIP只允许本机访问），以避免通信紊乱</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">route add -host VIP dev lo:0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看，在lo下面出现</span></span><br><span class="line">ip addr </span><br><span class="line">------------------------------</span><br><span class="line"><span class="meta">#</span><span class="bash"> arp抑制</span></span><br><span class="line">        echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore #只响应目的IP地址为接收网卡lo上的本地地址的arp请求。</span><br><span class="line">        echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce #只向该网卡lo回应与该网段匹配的ARP报文。</span><br><span class="line">        echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore #只响应目的IP地址为所有接收网卡上的本地地址的arp请求。</span><br><span class="line">        echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------------------------------</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">添加一个主机的路由</span></span><br><span class="line">route add -host vip dev lo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看</span></span><br><span class="line">route -n</span><br></pre></td></tr></table></figure>
<h5 id="永久生效！"><a href="#永久生效！" class="headerlink" title="永久生效！"></a>永久生效！</h5><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">lo</span></span><br><span class="line">cd /etc/sysconfig/network-scripts</span><br><span class="line">cp ifcfg-lo ifcfg-lo:0</span><br><span class="line">vim ifcfg-lo:0</span><br><span class="line"></span><br><span class="line">DEVICE=lo:0</span><br><span class="line">IPADDR=VIP #修改位vip</span><br><span class="line">NETMASK=255.255.255.255</span><br><span class="line">NETWORK=127.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> If you<span class="string">'re having problems with gated making 127.0.0.0/8 a martian,</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you can change this to something <span class="keyword">else</span> (255.255.255.255, <span class="keyword">for</span> example)</span></span><br><span class="line">BROADCAST=VIP #修改位vip</span><br><span class="line">ONBOOT=yes</span><br><span class="line">NAME=loopback</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">重启网卡</span></span><br><span class="line">systemctl restart network</span><br><span class="line">ifconfig查看</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">lo路由,不要了！</span></span><br><span class="line"><span class="meta">#</span><span class="bash">vim /etc/rc.local</span></span><br><span class="line"><span class="meta">#</span><span class="bash">/sbin/route add -host VIP dev lo:0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">chmod +x /etc/rc.d/rc.local</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> arp抑制</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>real server </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python -m SimpleHTTPServer 8989</span><br><span class="line"></span><br><span class="line">确保网络打开 curl RIP:8989</span><br></pre></td></tr></table></figure>
<p>客户端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">访问 vip:8989</span><br><span class="line">刷新按钮，发现会回显不同页面</span><br></pre></td></tr></table></figure>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210714172728213.png" alt="image-20210714172728213"></p>
<p>arp_ignore，定义了对<strong>目标地址为本机IP</strong>的ARP询问的不同应答模式。<br>arp_announce，对网络接口（网卡）上发出的ARP请求包中的<strong>源IP地址</strong>作出相应的限制；主机会根据这个参数值的不同选择使用IP数据包的源IP或当前网络接口卡的IP地址作为ARP请求包的源IP地址。</p>
<p>arp_ignore和arp_announce参数分别有all,default,lo,eth0等对应不同网卡。当all和具体网卡的参数值不一致时，【配置为较大值的生效】。一般只需修改all和某个具体网卡的参数即可。</p>
<p><strong>arp_ignore</strong> 使RS不响应针对VIP的ARP请求</p>
<ul>
<li>0：主机上任意一个网卡接口，只要有一个有arp广播请求报文中的IP地址，就进行回应。<ul>
<li>收到arp广播请求的网卡接口，还会查看其他所有网卡有没有配置这个IP地址，只要有一个配置了，就会响应。</li>
</ul>
</li>
<li>1：只响应目的IP地址为接收网卡上的本地地址的arp请求。<ul>
<li>收到arp广播请求的网卡接口，只查看自身有没有配置这个IP地址，如果没有配置，即使别的接口上配置了，也不会响应。</li>
</ul>
</li>
<li>2：只响应目的IP地址为【接收网卡上的本地地址】的arp请求，并且arp请求的【源IP必须和接收网卡同网段】。<ul>
<li>不仅要满足取值为1的要求，而且还会对arp请求包的源IP地址做校验，一个网段内的才会做相应。</li>
</ul>
</li>
<li>3：如果ARP请求数据包所请求的IP地址对应的本地地址其作用域（scope）为主机（host），则不回应ARP响应数据包，如果作用域为全局（global）或链路（link），则回应ARP响应数据包。</li>
<li>4~7：保留未使用</li>
<li>8：不回应所有的arp请求</li>
</ul>
<p>地址解析协议，即ARP（Address Resolution Protocol），是根据<a href="https://baike.baidu.com/item/IP地址" target="_blank" rel="noopener">IP地址</a>获取<a href="https://baike.baidu.com/item/物理地址/2129" target="_blank" rel="noopener">物理地址</a>的一个<a href="https://baike.baidu.com/item/TCP%2FIP协议" target="_blank" rel="noopener">TCP/IP协议</a>。<a href="https://baike.baidu.com/item/主机/455151" target="_blank" rel="noopener">主机</a>发送信息时将包含目标IP地址的ARP请求广播到局域网络上的所有主机，并接收返回消息，以此确定目标的物理地址。收到返回消息后将该IP地址和物理地址存入本机ARP缓存中并保留一定时间，下次请求时直接查询ARP缓存以节约资源。</p>
<p>因为RealServer解开IP包头查看到的目标IP是VIP，而只有RS自己的IP符合目标IP（VIP）才会接收进来，所以我们需要在RS的上面配置VIP（配置在lo上）。</p>
<p>在lvs-DR模式中，调度器Director和所有的Real Server都配置了VIP地址，其中，LVS的VIP配置在物理网卡接口上，Real Server配置在了本地接口lo上。</p>
<p>当客户端发送ARP广播时，因为arp请求一定来自别的主机，所以接收的网卡只能是物理接口 ens33或eth0。（）</p>
<p>对于Real Server来说，Real Server将VIP配置到了lo接口上，ens33或者eth0等物理接口上没有VIP。又设置了所有网卡的arp_ignore为1，因此当client发送arp广播时，ens33刚好不会回应。</p>
<p>对于Director来说，ens33或者eth0刚好因为keepalived漂移到这个服务器，因此拥有了VIP。因此当client发送arp广播时，ens33刚好可以回应。</p>
<p>从上述可知，</p>
<ol>
<li>要把Director的VIP配置到物理接口上（例如，keepalive中配置参数为：interface ens33）</li>
<li>要把Real Server的VIP配置到本地接口lo上，且Real Server要进行ARP抑制（如果不抑制，则会导致client访问物理接口ens33时，lo配置的vip也会响应！）</li>
<li>Real Server能否充当client——从rs自己发出的vip请求，不再经过Director进行负载均衡分发。直接访问自己的lo发现vip进行访问：<code>tcpdump -i lo port 8989</code> 。</li>
<li>Director能否充当client——不可以。</li>
</ol>
<p>数据包到达 RealServer 服务器后，发现请求报文的 MAC 地址是自己的网卡 MAC 地址，将会接受此报文，待处理完成之后，<strong>将响应报文通过 lo 接口传送给 eth0 网卡然后向外发出</strong>。此时的源 IP 地址为 VIP，目标 IP 也是 VIP，变成了RS中自己的VIP –》VIP发送。无法返回响应到Director了。 </p>
<pre class="mermaid">graph LR
director(1.vip:vip) --2.mac:vip:vip--> director --3.lvs--> rs(4.vip:vip-ens33)  --5.vip-ens33:vip--> rs</pre>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcpdump -i any port 8989 -n</span><br><span class="line">抓包，发现在director中发送curl vip时，是vip --&gt; vip的发送过程！</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><p>lvs和rs部署在同一台机器上——可以。</p>
<ul>
<li>client 访问目标IP—— VIP:53端口。（监听ens33的VIP:53端口）</li>
<li>LVS将VIP:53端口转发到RIP:53端口。（监听ens33的RIP:53端口）</li>
<li>发现MAC地址就是本机。本机回包（VIP:CIP）</li>
</ul>
</li>
</ol>
<p><strong>arp_announce</strong> rs回包时，数据包重新封装报文 (源IP地址为VIP，目标IP为CIP)，将响应报文通过 lo 接口传送给物理网卡ens33然后向外发出。系统不使用IP包的源地址来设置ARP请求的源地址(lo)，而选择发送接口的IP地址（ens33）。</p>
<ul>
<li>0：表示无论哪块网卡收到了arp的请求，只要发现本机有请求的mac，就会响应。</li>
<li>1：表示尽量避免响应ARP请求中MAC不是本网卡的。如一个主机有多块网卡，其中一块网卡接收到了ARP请求，发现所请求的MAC是本机另一块网卡的，这个时候接收到ARP请求的这块网卡就尽量避免响应。</li>
<li>2：表示总是使用最合适的网卡来响应。一个主机有多块网卡，其中一块网卡接收到了ARP请求，发现所请求的MAC是本机另一块网卡的，这个时候接收到ARP请求的这块网卡就一定不响应，只有发现请求的MAC是自己的才给与响应。</li>
</ul>
<p>sysctl.conf中包含all和eth/lo（具体网卡）的arp_ignore参数，取其中较大的值生效。</p>
<p><a href="https://www.jianshu.com/p/a682ecae9693" target="_blank" rel="noopener">Linux 内核参数 arp_ignore &amp; arp_announce 详解 - 简书 (jianshu.com)</a></p>
<p>当客户端用户发送请求给 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 网站时，首先经过 DNS 解析到 IP 后并向百度服务器发送请求，</p>
<p>数据包经过网络到百度 LVS 负载均衡服务器，这时到达 LVS 网卡时的数据包包括：源 IP 地址（客户端地址）、目的 IP 地址（百度对外服务器 IP 地址，也就是 VIP）、源 MAC 地址（CMAC / LVS 连接路由器的 MAC 地址）、目标 MAC 地址（VMAC / VIP 对应的 MAC 地址）。</p>
<p> 数据包到达网卡后，经过链路层到达 PREROUTING 链，进行查找路由，发现目的 IP 是 LVS 的 VIP，这时就会发送至 INPUT 链中并且数据包的 IP 地址、MAC 地址、Port 都未经过修改。</p>
<p> 数据包到达 INPUT 链中，LVS 会根据目的 IP 和 Port（端口）确认是否为 LVS 定义的服务，如是定义过的 VIP 服务，会根据配置的服务信息，从 RealServer 中选择一个后端服务器 RS1，然后 RS1 作为目标出方向的路由，确定下一跳信息及数据包通过具体的哪个网卡发出，最好将数据包通过 INET_HOOK 到 OUTPUT 链中。</p>
<p>数据包通过 POSTROUTING 链后，目的 MAC 地址将会修改为 RealServer 服务器 MAC 地址（RMAC）源 MAC 地址修改为 LVS 与 RS 同网段的 IP 地址的 MAC 地址（DMAC）此时，数据包将会发至 RealServer 服务器</p>
<p> 数据包到达 RealServer 服务器后，发现请求报文的 MAC 地址是自己的网卡 MAC 地址，将会接受此报文，待处理完成之后，<strong>将响应报文通过 lo 接口传送给 eth0 网卡然后向外发出</strong>。此时的源 IP 地址为 VIP，目标 IP 为 CIP，源 MAC 地址为 RS1 的 RMAC，目的 MAC 地址为下一跳路由器的 MAC 地址（CMAC），最终数据包通过 RS 相连的路由器转发给客户端。</p>
<h4 id="LVS脑裂问题"><a href="#LVS脑裂问题" class="headerlink" title="LVS脑裂问题"></a>LVS脑裂问题</h4><h4 id="尝试keepalived-httpd协议lvs"><a href="#尝试keepalived-httpd协议lvs" class="headerlink" title="尝试keepalived+httpd协议lvs"></a>尝试keepalived+httpd协议lvs</h4><p>使用DR作为负载平衡，真实服务器应该能够接收针对VIP 的传入请求并直接响应客户端。</p>
<p>这对主机的配置有一些影响，但使用这种方法允许像以前一样<strong>单独使用真实服务器</strong>，就好像负载平衡设置不存在一样。</p>
<p>请注意，Real Server A 和 B 不运行 Keepalived 的实例</p>
<h5 id="lvs-server"><a href="#lvs-server" class="headerlink" title="lvs server"></a>lvs server</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim keepalived.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查看是否安装</span></span><br><span class="line">rpm -q ipvsadm</span><br></pre></td></tr></table></figure>
<p>开启路由转发</p>
<p>临时有效</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">不可以使用vim</span></span><br><span class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<p>永久</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /etc/sysctl.conf</span></span><br><span class="line">net.ipv4.ip_forward = 1    　　　　#lvs主机都开启路由转发功能。设置为“1”开启路由转发功能，“0”为关闭路由转发；</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 修改内核参数后，重新加载配置.只是暂时开启，重启机器后会失</span></span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<p>可有可无</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 关闭ICMP的重定向</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects</span><br><span class="line">echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables</span><br></pre></td></tr></table></figure>
<h5 id="real-server"><a href="#real-server" class="headerlink" title="real server"></a>real server</h5><p>制作一个简单的http服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/bin/python2.7 -m SimpleHTTPServer 8989</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install httpd</span><br><span class="line"></span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl enable httpd</span><br><span class="line"></span><br><span class="line">echo Rs1Test Server on rip &gt; /var/www/html/index.html</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl rip</span><br></pre></td></tr></table></figure>
<p><strong>修改默认网关指向 NAT 的 VIP / DIP 地址</strong></p>
<p>默认网关改为eth0的虚拟ip（由于临时添加的方式，网关有可能会消失，消失就添加即可。）</p>
<p>Real Server这里需要配置路由，将默认的网关改为Load Balancer 服务器的内网ip地址，来实现路由转发的效果。</p>
<p>这个命令需要在<strong>每台Real Server</strong>之上执行，否则其他Real Server<strong>没有办法接受到转发的ip数据包</strong>，会被Load Balance屏蔽，从而没有办法实现我们期待的负载均衡的结果。</p>
<ul>
<li>RS 应该使用私有地址，RS 的网关必须指向 DIP</li>
<li>DIP 和 RIP 必须在同一个网段内</li>
<li>请求和响应报文都需要经过 Director Server，高负载场景中，Director Server 易成为性能瓶颈</li>
<li>支持端口映射</li>
<li>VS 必须是 Linux 系统，RS可以是任意系统；</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">修改默认网关</span></span><br><span class="line">route add default gw vip  dev eth0</span><br><span class="line"><span class="meta">#</span><span class="bash">还原</span></span><br><span class="line">route del default gw vip</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在Realserver上修改到该内网IP（CIP）的路由。</span></span><br><span class="line"><span class="meta">#</span><span class="bash">LVS NAT模式下，正常流程是，CIP向VIP发送一个数据包，Director修改DestIP为RIP，RIP处理后反馈给VIP（GW）。如果CIP和RIP位于同一个网段，则会导致RIP不通过网关，直接将数据包发送到CIP。</span></span><br><span class="line">route add -host CIP gw DIP</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">route add default gw 10.154.5.163  dev eth0</span><br><span class="line"></span><br><span class="line">route -n</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">内容如下</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.154.5.163    0.0.0.0         UG    0      0        0 eth0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#1. 绑定VIP到lo网卡</span><br><span class="line">net.ipv4.ip_nonlocal_bind=1</span><br><span class="line"></span><br><span class="line">#2. 抑制ARP，抑制目标地址和接线网卡不是同一个ip</span><br><span class="line">net.ipv4.conf.eth0.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.eth0.arp_announce = 2</span><br><span class="line">net.ipv4.conf.eth1.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.eth1.arp_announce = 2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sysctl –p</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl 10.154.5.3:8989</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim /etc/rc.local</span><br><span class="line">/sbin/route add -host 10.154.5.3 dev lo:0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ip a s eth0</span><br><span class="line"></span><br><span class="line">ipvsadm -ln</span><br><span class="line"></span><br><span class="line">关闭一个real server ,再次观察，发现规则少了一个（健康检查生效）再次启动观察（注意延时）</span><br><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure>
<p><strong>在集群中服务器与director之间的时间误差不能超过一秒</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">办法一：运行ntp服务，与网络上的ntp服务器进行时间同步即可</span><br><span class="line"></span><br><span class="line"> service ntpd start</span><br><span class="line"> </span><br><span class="line"> 办法二：把director当作时间服务器使realserver与director进行时间同步</span><br><span class="line"></span><br><span class="line">director运行: service ntpd start</span><br><span class="line"></span><br><span class="line">realserver运行ntpd directorIP，: ntpd</span><br></pre></td></tr></table></figure>
<p><a href="https://www.pentestpartners.com/security-blog/how-to-use-keepalived-for-high-availability-and-load-balancing/" target="_blank" rel="noopener">How to use Keepalived for high availability and load balancing | Pen Test Partners</a></p>
<h4 id="抛弃keepalived，直接采用lvs-httpd协议"><a href="#抛弃keepalived，直接采用lvs-httpd协议" class="headerlink" title="抛弃keepalived，直接采用lvs + httpd协议"></a>抛弃keepalived，直接采用lvs + httpd协议</h4><h4 id="尝试keepalived-bind协议"><a href="#尝试keepalived-bind协议" class="headerlink" title="尝试keepalived + bind协议"></a>尝试keepalived + bind协议</h4><h4 id="尝试直接采用lvs-bind协议"><a href="#尝试直接采用lvs-bind协议" class="headerlink" title="尝试直接采用lvs+ bind协议"></a>尝试直接采用lvs+ bind协议</h4><h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><ul>
<li>Nginx编译安装时使用–with-stream开启ngx_stream_core_module模块(Nginx1.9以上版本)<ul>
<li>nginx默认编译时，该模块并未编译进去，需要编译的时候添加–with-stream，使其支持stream代理即可</li>
<li>ngx_stream_core_module模块，使nginx支持四层负载均衡,实现TCP和UDP代理。<ul>
<li>TCP是stream上下文的默认协议</li>
<li>UDP需要专门指定，listen 53 udp;</li>
</ul>
</li>
</ul>
</li>
<li>Nginx采用轮询的方式调用后端SSH服务器</li>
</ul>
<ol>
<li>–with-http_ssl_module 开启SSL加密功能</li>
<li>–with-stream 开启4层反向代理功能</li>
</ol>
<h4 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y make zlib zlib-devel gcc-c++ libtool openssl openssl-devel pcre pcre-devel</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /data</span><br><span class="line"></span><br><span class="line">wget http://nginx.org/download/nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf nginx-1.20.1.tar.gz</span><br><span class="line"></span><br><span class="line">cd nginx-1.20.1/</span><br><span class="line"></span><br><span class="line">./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-http_ssl_module --with-stream --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ln -snf /usr/local/nginx/sbin/nginx /usr/local/sbin</span><br><span class="line">useradd -s /sbin/nologin -M nginx</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx/logs</span><br><span class="line">mkdir access</span><br><span class="line"></span><br><span class="line">cd /usr/local/nginx/conf</span><br><span class="line">mv nginx.conf nginx.conf_bak</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lsof -i:53</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim nginx.conf</span><br><span class="line"></span><br><span class="line">user root;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log logs/error.log error;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream dns_upstreams &#123;</span><br><span class="line">        server 10.154.5.162:53 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.154.5.214:53 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 53 udp;</span><br><span class="line">        proxy_pass dns_upstreams;</span><br><span class="line">        proxy_timeout 1s;</span><br><span class="line">        proxy_responses 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 53;</span><br><span class="line">        proxy_pass dns_upstreams;</span><br><span class="line">        proxy_timeout 1s;</span><br><span class="line">        proxy_responses 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_format proxy '$remote_addr - [$time_local] ' '$protocol $status $bytes_sent $bytes_received ' '$session_time "$upstream_addr" ' '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time" ' '$remote_addr $remote_port $server_addr $server_port';</span><br><span class="line"></span><br><span class="line">    map $bytes_received $loggable &#123; 0 0; default 1; &#125;</span><br><span class="line"></span><br><span class="line">    map $time_iso8601 $logdate &#123;</span><br><span class="line">        '~^(?&lt;ymd&gt;\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;)' $ymd;</span><br><span class="line">        default                       'date-not-found';</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    access_log logs/access/access-dns-$logdate.log proxy if=$loggable;</span><br><span class="line"></span><br><span class="line">    open_log_file_cache off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="负载均衡方法"><a href="#负载均衡方法" class="headerlink" title="负载均衡方法"></a>负载均衡方法</h6><ol>
<li>round-robin（轮询）——默认，Nginx使用轮询算法负载均衡通信。因为是默认方法，所以没有round-robin指令；只创建upstream配置块在顶级stream上下文并像之前步骤添加server指令。</li>
<li>last_conn（最少连接）——Nginx选择当前活跃连接数较少的服务器。</li>
<li>least_time——Nginx选择最低平均延迟和最少活跃连接的服务器。最低活跃连接基于least_time指令的以下参数计算：<ol>
<li>connect——连接upstream服务器的时间</li>
<li>first_byte——接收第一个数据字节的时间</li>
<li>last_byte——从服务器接收完整响应的时间</li>
</ol>
</li>
</ol>
<h6 id="被动健康检查"><a href="#被动健康检查" class="headerlink" title="被动健康检查"></a>被动健康检查</h6><p>fail_timeout默认为10秒，max_fails默认为1次。因此，如果连接10秒内尝试至少一次失败，Nginx标记服务器10秒内不可用。</p>
<h6 id="主动健康检查"><a href="#主动健康检查" class="headerlink" title="主动健康检查"></a>主动健康检查</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx</span><br><span class="line">nginx -s reload</span><br><span class="line">tail -f /var/log/nginx/error.log</span><br><span class="line">ps aux | grep nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dig www.wei01.com @10.154.5.162 +short A</span><br><span class="line">dig www.wei01.com @10.154.5.163 +short A</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tailf access-2021-07-08.log</span><br><span class="line"></span><br><span class="line">10.154.5.163 - [08/Jul/2021:15:23:12 +0800] UDP 200 58 42 0.002 "10.154.5.214:53" "42" "58" "0.000" 10.154.5.163 45808 10.154.5.163 53</span><br><span class="line"></span><br><span class="line">10.154.5.163 - [08/Jul/2021:15:23:13 +0800] UDP 200 58 42 0.001 "10.154.5.162:53" "42" "58" "0.000" 10.154.5.163 48863 10.154.5.163 53</span><br></pre></td></tr></table></figure>
<h4 id="平滑升级"><a href="#平滑升级" class="headerlink" title="平滑升级"></a>平滑升级</h4><p>若前期未带stream模块已经安装了nginx，此时可以选择平滑添加stream模块，并不会对线上业务造成多大影响</p>
<p>1）先在LB的slave从机上进行平滑添加，然后再将vip切换到从机上，随即在对master主机进行平滑添加该模块。<br>2）平滑添加即是重新configure编译的时候加上–with-stream，接着make。<br>3）千万注意，make之后，不要make install，否则会覆盖掉之前的配置！！！</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">whereis nginx</span><br><span class="line">find / -name nginx</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查阅编译情况是否带了stream（若有则带了 --with-stream）</span></span><br><span class="line">nginx -V</span><br><span class="line"></span><br><span class="line">nginx version: nginx/1.20.1</span><br><span class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)</span><br><span class="line">built with OpenSSL 1.0.2k-fips  26 Jan 2017</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --user=nginx --group=nginx --prefix=/usr/local/nginx --with-http_ssl_module --with-stream --with-stream_realip_module</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/servers/nginx-1.18.0/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">注意将旧的nginx -V得到的configure arguments附加在后面，再增加-with-stream等内容</span></span><br><span class="line">./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-http_ssl_module --with-stream --with-stream_realip_module</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">覆盖nginx执行程序</span></span><br><span class="line">cp -f /usr/servers/nginx-1.18.0/objs/nginx /usr/local/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line">pkill -9 nginx</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">查阅编译情况带了stream</span></span><br><span class="line">/usr/local/nginx/sbin/nginx -V</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">制作超链接方便全局访问</span></span><br><span class="line">ln -snf /usr/local/nginx/sbin/nginx /usr/local/sbin</span><br></pre></td></tr></table></figure>
<p><a href="https://my.oschina.net/u/4113630/blog/4377237" target="_blank" rel="noopener">CentOS7下使用nginx实现TCP和UDP代理 - yuanfan2012的个人空间 - OSCHINA - 中文开源技术交流社区</a></p>
<p><a href="https://www.codercto.com/a/60004.html" target="_blank" rel="noopener">nginx tcp stream 访问日志配置的优化 | 码农网 (codercto.com)</a></p>
<p><a href="https://blog.csdn.net/ffzhihua/article/details/80981900" target="_blank" rel="noopener">nginx 1.12 stream 日志设置_秋天的博客-CSDN博客_nginx stream 日志</a></p>
]]></content>
  </entry>
</search>
